<html><head></head><body>
<h2 class="h2" id="ch06"><span epub:type="pagebreak" id="page_105"/><strong><span class="big">6</span><br/>WRITING IN INVISIBLE INK</strong></h2>
<div class="image1"><img src="../images/common01.jpg" alt="image"/></div>
<p class="noindent">In the fall of 2012, the crime drama <em>Elementary</em> debuted on the CBS television network. A reimagining of the Sherlock Holmes mythos set in 21st-century New York, it starred Jonny Lee Miller as Holmes and Lucy Liu as his sidekick, Dr. Joan Watson. In a 2016 episode (“You’ve Got Me, Who’s Got You?”), Morland Holmes, Sherlock’s estranged father, hires Joan to find a mole in his organization. She quickly solves the case by discovering a Vigenère cipher in an email. But some fans of the show were dissatisfied: the Vigenère cipher is hardly subtle, so how could a man as intelligent as Morland Holmes miss finding it on his own?</p>
<p class="indent">In this project, you’ll reconcile this dilemma using steganography, but not with a null cipher as in <a href="ch05.xhtml#ch05">Chapter 5</a>. To hide this message, you’ll use a third-party module called <span class="literal">python-docx</span> that will allow you to conceal text by directly manipulating Microsoft Word documents using Python.</p>
<h3 class="h3a" id="lev130"><span epub:type="pagebreak" id="page_106"/><strong>Project #12: Hiding a Vigenère Cipher</strong></h3>
<p class="noindent">In the <em>Elementary</em> episode, Chinese investors hire Morland Holmes’s consulting company to negotiate with the Colombian government for petroleum licenses and drilling rights. A year has passed, and at the last moment a competitor swoops in and clinches the deal, leaving the Chinese investors high and dry. Morland suspects betrayal by a member of his staff and asks Joan Watson to investigate alone. Joan identifies the mole by finding a Vigenère cipher in one of his emails.</p>
<div class="note">
<p class="notet"><strong><span class="notes">SPOILER ALERT</span></strong></p>
<p class="notep"><em>The decrypted contents of the cipher are never mentioned, and the mole is murdered in a subsequent episode.</em></p>
</div>
<p class="indent">The <em>Vigenère cipher</em>, also known as the unbreakable cipher, is arguably the most famous cipher of all time. Invented in the 16th century by the French scholar Blaise de Vigenère, it is a polyalphabetic substitution cipher that, in the most commonly used version, employs a single keyword. This keyword, such as <em>BAGGINS</em>, is printed repeatedly over the plaintext, as in the message shown in <a href="ch06.xhtml#ch06fig1">Figure 6-1</a>.</p>
<div class="image"><a id="ch06fig1"/><img src="../images/f0106-01.jpg" alt="image"/></div>
<p class="figcap"><em>Figure 6-1: A plaintext message with the Vigenère cipher keyword</em> BAGGINS <em>printed above</em></p>
<p class="indent">A table, or <em>tableau</em>, of the alphabet is then used to encrypt the message. <a href="ch06.xhtml#ch06fig2">Figure 6-2</a> is an example of the first five rows of a Vigenère tableau. Notice how the alphabet shifts to the left by one letter with each row.</p>
<div class="image"><a id="ch06fig2"/><img src="../images/f0106-02.jpg" alt="image"/></div>
<p class="figcap"><em>Figure 6-2: Portion of a Vigenère tableau</em></p>
<p class="indent">The keyword letter above the plaintext letter determines which row to use for the encryption. For example, to encrypt the <em>s</em> in <em>speak</em>, note that the keyword letter above it is <em>B</em>. Go down to the B row and read across to where the plaintext <em>s</em> is at the top of the column. Use the <em>T</em> at the intersection for the ciphertext letter.</p>
<p class="indent"><a href="ch06.xhtml#ch06fig3">Figure 6-3</a> shows an example of the full message encrypted with the Vigenère cipher. This kind of text would surely draw attention and become an object of scrutiny if it were visible in a document!</p>
<div class="image"><span epub:type="pagebreak" id="page_107"/><a id="ch06fig3"/><img src="../images/f0107-01.jpg" alt="image"/></div>
<p class="figcap"><em>Figure 6-3: A message encrypted with the Vigenère cipher</em></p>
<p class="indent">The Vigenère cipher remained unbroken until the mid-19th century, when Charles Babbage, inventor of the precursor to the computer, realized that a short keyword used with a long message would result in repeating patterns that could reveal the length of the keyword and, ultimately, the key itself. The breaking of the cipher was a tremendous blow to professional cryptography, and no significant advancements were made in the field during the Victorian era of the original Holmes and Watson.</p>
<p class="indent">The presence of this cipher is what causes “suspension of disbelief” issues with the <em>Elementary</em> episode. Why would an outside consultant be needed to find such a clearly suspicious email? Let’s see if we can come up with a plausible explanation using Python.</p>
<div class="sidebar">
<p class="sidebart"><strong>THE OBJECTIVE</strong></p>
<p class="spara">Assume you are the corporate mole in the episode and use Python to hide a secret message summarizing bid details within an official-looking text document. Start with an unencrypted message and finish with an encrypted version.</p>
</div>
<h3 class="h3" id="lev131"><strong>The Platform</strong></h3>
<p class="noindent">Your program should work with ubiquitous word-processing software, as the output needs to be sharable between different corporations. This implies use of the Microsoft Office Suite for Windows or compatible versions for macOS or Linux. And restricting the output to a standard Word document makes hardware issues Microsoft’s responsibility!</p>
<p class="indent">Accordingly, this project was developed with Word 2016 for Windows, and the results checked with Word for Mac v16.16.2. If you don’t have a license for Word, you can use the free Microsoft Office Online app, available at <em><a href="https://products.office.com/en-us/office-online">https://products.office.com/en-us/office-online</a></em>.</p>
<p class="indent">If you currently use alternatives to Word, like LibreOffice Writer or OpenOffice Writer, you can open and view the Word (<em>.docx</em>) files used and produced in this project; however, the hidden message will most likely be compromised, as discussed in “<a href="ch06.xhtml#lev143">Detecting the Hidden Message</a>” on <a href="ch06.xhtml#page_119">page 119</a>.</p>
<h3 class="h3" id="lev132"><strong>The Strategy</strong></h3>
<p class="noindent">You’re an accountant with a beginner’s knowledge of Python, and you work for a very intelligent and suspicious man. The project you work on is highly proprietary, with controls—such as email filters—to maintain confidentiality. And if you manage to sneak out a message, a thorough investigation will <span epub:type="pagebreak" id="page_108"/>surely follow. So, you need to hide a clearly suspicious message in an email, either directly or as an attachment, yet evade initial detection and later internal audits.</p>
<p class="indent">Here are some constraints:</p>
<ul>
<li class="noindent">You can’t send the message directly to the competing corporation, only to an intermediary.</li>
<li class="noindent">You need to scramble the message to evade the email filters that will search for keywords.</li>
<li class="noindent">You need to hide the encrypted message from sight so as not to arouse suspicion.</li>
</ul>
<p class="indent">The intermediary would be easy to set up, and free encryption sites are easy to find on the internet—but the last item is more problematic.</p>
<p class="indent">Steganography is the answer, but as you saw in the previous chapter, hiding even a short message in a null cipher is no easy task. Alternative techniques involve shifting lines of text vertically or words horizontally by small amounts, changing the length of letters, or using the file’s metadata—but you’re an accountant with limited knowledge of Python and even less time. If only there were an easy way, like invisible ink in the old days.</p>
<h4 class="h4" id="lev133"><strong><em>Creating Invisible Ink</em></strong></h4>
<p class="noindent">Invisible ink, in this age of electronic ink, might be just crazy enough to work! An invisible font would easily foil a visual perusal of online documents and won’t even exist in paper printouts. Since the contents would be encrypted, digital filters looking for keywords like <em>bid</em> or the Spanish names of the producing oil basins would find nothing. And best of all, invisible ink is easy to use—just set the foreground text to the background color.</p>
<p class="indent">Formatting text and changing its color requires a word processor like Microsoft Word. To make invisible electronic ink in Word, you just need to select a character, word, or line and set the font color to white. The recipient of the message would then need to select the whole document and use the Highlighter tool (see <a href="ch06.xhtml#ch06fig4">Figure 6-4</a>) to paint the selected text black, thus concealing the standard black letters and bringing the hidden white letters into view.</p>
<div class="image"><a id="ch06fig4"/><img src="../images/f0108-01.jpg" alt="image"/></div>
<p class="figcap"><em>Figure 6-4: The Text Highlight Color tool in Word 2016</em></p>
<p class="indent"><span epub:type="pagebreak" id="page_109"/>Just selecting the document in Word won’t reveal the white text (<a href="ch06.xhtml#ch06fig5">Figure 6-5</a>), so someone would have to be very suspicious indeed to find these hidden messages.</p>
<div class="image"><a id="ch06fig5"/><img src="../images/f0109-01.jpg" alt="image"/></div>
<p class="figcap"><em>Figure 6-5: Top: a portion of a Word document with the fake message visible; middle: the document selected with <small>CTRL</small>-A; bottom: the real message revealed using the Highlighter tool with the highlight color set to black</em></p>
<p class="indent">Of course, you can accomplish all this in a word processor alone, but there are two cases where a Pythonic approach is preferable: 1) when you have to encrypt a long message and don’t want to manually insert and hide all the lines and 2) when you need to send more than a few messages. As you’ll see, a short Python program will greatly simplify the process!</p>
<h5 class="h5" id="lev134"><strong>Considering Font Types, Kerning, and Tracking</strong></h5>
<p class="noindent">Placing the invisible text is a key design decision. One option is to use the spaces between the visible words of the fake message, but this could trigger spacing-related issues that would make the final product look suspicious.</p>
<p class="indent"><em>Proportional fonts</em> use variable character widths to improve readability. Example fonts are Arial and Times New Roman. <em>Monospace fonts</em> use a constant character width to support the alignment of text and the recognition of individual characters, especially thin ones such as the ( or { characters. As a result, monospace fonts are popular in programming interfaces. Example fonts are Consolas and Courier New.</p>
<p class="indent"><em>Kerning</em> is a typographical process for adjusting the spacing and overlap between individual character glyphs in order to improve their visual appeal. A process called <em>tracking</em> is used to adjust the character spacing across entire lines or blocks of text for the same purpose. These adjustments aid legibility and readability, ensuring that letters aren’t so close together that they’re indistinguishable or so far apart that words aren’t recognizable. Note that we read words, not letters. If you doubt it, read this: peopl raed wrds nt lttrs. Of corase, contxt hlps.</p>
<p class="indent"><span epub:type="pagebreak" id="page_110"/>Kerning between pairs of letters is performed first, followed by tracking, during which the relative kerning of the letter pairs is preserved. As mentioned earlier, these variable widths and automatic corrections can cause problems when you’re trying to hide characters between words that use proportional fonts:</p>
<table class="topbot-d">
<tbody>
<tr>
<td style="vertical-align: top;" class="table-b"><p class="taba">To a great mind nothing is little.</p></td>
<td style="vertical-align: top;" class="table-b"><p class="taba"><em>Proportional font with no hidden letters</em></p></td>
</tr>
<tr>
<td style="vertical-align: top;" class="table-b"><p class="taba">To a great mind nothing is little.</p></td>
<td style="vertical-align: top;" class="table-b"><p class="taba"><em>Proportional font with hidden letters between words</em></p></td>
</tr>
<tr>
<td style="vertical-align: top;" class="table-b"><p class="taba">To<span class="H-L">$</span>a<span class="H-L">3</span>great<span class="H-L">.</span>mind<span class="H-L">2</span>nothing<span class="H-L">K</span>is little.</p></td>
<td style="vertical-align: top;" class="table-b"><p class="taba"><em>Hidden letters revealed ($3.2K)</em></p></td>
</tr>
<tr>
<td style="vertical-align: top;" class="table-b"><p class="taba"> </p></td>
<td style="vertical-align: top;" class="table-b"><p class="taba"> </p></td>
</tr>
<tr>
<td style="vertical-align: top;" class="table-b"><p class="taba"><span class="literal">To a great mind nothing is little.</span></p></td>
<td style="vertical-align: top;" class="table-b"><p class="taba"><em>Monospace font with no hidden letters</em></p></td>
</tr>
<tr>
<td style="vertical-align: top;" class="table-b"><p class="taba"><span class="literal">To a great mind nothing is little.</span></p></td>
<td style="vertical-align: top;" class="table-b"><p class="taba"><em>Monospace font with hidden letters between words.</em></p></td>
</tr>
<tr>
<td style="vertical-align: top;" class="table-b"><p class="taba"><span class="literal">To</span><span class="H-L"><span class="literal">$</span></span><span class="literal">a</span><span class="H-L"><span class="literal">3</span></span><span class="literal">great</span><span class="H-L"><span class="literal">.</span></span><span class="literal">mind</span><span class="H-L"><span class="literal">2</span></span><span class="literal">nothing</span><span class="H-L"><span class="literal">K</span></span><span class="literal">is little.</span></p></td>
<td style="vertical-align: top;" class="table-b"><p class="taba"><em>Hidden letters revealed ($3.2K)</em></p></td>
</tr>
</tbody>
</table>
<p class="indent">If you use a monospace font, the consistent spacing provides a convenient hiding place. But since professional correspondence is more likely to use proportional fonts, the invisible ink technique should focus on the more easily controlled spaces between lines.</p>
<p class="indent">Using empty lines between paragraphs is the easiest method to program and to read, and it shouldn’t require a long fake message because you can summarize the salient points of a bid succinctly. This is important since you don’t want empty pages appended to your visible fake message. Consequently, the footprint for your hidden message should be smaller than for your fake one.</p>
<h5 class="h5" id="lev135"><strong>Avoiding Issues</strong></h5>
<p class="noindent">When you’re developing software, a good question to ask repeatedly is “How can the user screw this up?” One thing that can go wrong here is that the encryption process will change the letters in your hidden message so that kerning and tracking adjustments may push a word past the line break, causing an automatic line wrap. This will result in uneven and suspicious-looking spaces between paragraphs in the fake message. One way to avoid this is to press <small>ENTER</small> a little early as you’re typing in each line of the real message. This will leave some space at the end of the line to accommodate changes due to encryption. Of course, you’ll still need to verify the results. Assuming code works is as risky as assuming James Bond is dead!</p>
<h4 class="h4" id="lev136"><strong><em>Manipulating Word Documents with python-docx</em></strong></h4>
<p class="noindent">A free third-party module called <span class="literal">python-docx</span> allows Python to manipulate Microsoft Word (.<em>docx</em>) files. To download and install the third-party modules mentioned in this book, you’ll use the Preferred Installer Program (pip), a package management system that makes it easy to install Python-based software. For Python 3 on Windows and macOS, versions 3.4 and later come with pip preinstalled; for Python 2, pip preinstallation starts with version 2.7.9. Linux users may have to install pip separately. If you find you need to install or upgrade pip, see the instructions at <em><a href="https://pip.pypa.io/en/stable/installing/">https://pip.pypa.io/en/stable/installing/</a></em> or do an online search on installing pip on your particular operating system.</p>
<p class="indent"><span epub:type="pagebreak" id="page_111"/>With the pip tool, you can install <span class="literal">python-docx</span> by simply running <span class="codestrong">pip install python-docx</span> in a command, PowerShell, or terminal window, depending on your operating system. Online instructions for <span class="literal">python-docx</span> are available at <em><a href="https://python-docx.readthedocs.io/en/latest/">https://python-docx.readthedocs.io/en/latest/</a></em>.</p>
<p class="indent">For this project, you need to understand the <span class="literal">paragraph</span> and <span class="literal">run</span> objects. The <span class="literal">python-docx</span> module organizes data types using three objects in the following hierarchy:</p>
<ul>
<li class="noindent"><span class="literal">document</span>: The whole document with a list of <span class="literal">paragraph</span> objects</li>
<li class="noindent"><span class="literal">paragraph</span>: A block of text separated by the use of the <small>ENTER</small> key in Word; contains a list of <span class="literal">run</span> object(s)</li>
<li class="noindent"><span class="literal">run</span>: A connected string of text with the same <em>style</em></li>
</ul>
<p class="indent">A <span class="literal">paragraph</span> is considered a <em>block-level</em> object, which <span class="literal">python-docx</span> defines as follows: “a block-level item flows the text it contains between its left and right edges, adding an additional line each time the text extends beyond its right boundary. For a <span class="literal">paragraph</span> object, the boundaries are generally the page margins, but they can also be column boundaries if the page is laid out in columns, or cell boundaries if the <span class="literal">paragraph</span> occurs inside a table cell. A table is also a block-level object.”</p>
<p class="indent">A <span class="literal">paragraph</span> object has a variety of attributes that specify its placement within a container—typically a page—and the way it divides its contents into separate lines. You can access the formatting attributes of a <span class="literal">paragraph</span> with the <span class="literal">ParagraphFormat</span> object available through the <span class="literal">ParagraphFormat</span> attribute of the <span class="literal">paragraph</span>, and you can set all the <span class="literal">paragraph</span> attributes using a <em>paragraph style grouping</em> or apply them directly to a <span class="literal">paragraph</span>.</p>
<p class="indent">A <span class="literal">run</span> is an <em>inline-level</em> object that occurs within paragraphs or other block-level objects. A <span class="literal">run</span> object has a read-only <span class="literal">font</span> attribute providing access to a <span class="literal">font</span> object. A <span class="literal">font</span> object provides attributes for getting and setting the character formatting for that <span class="literal">run</span>. You’ll need this feature for setting your hidden message’s text color to white.</p>
<p class="indent"><em>Style</em> refers to a collection of attributes in Word for paragraphs and characters (<span class="literal">run</span> objects) or a combination of both. Style includes familiar attributes such as font, color, indention, line spacing, and so on. You may have noticed groupings of these displayed in the Styles pane on Word’s Home ribbon (see <a href="ch06.xhtml#ch06fig6">Figure 6-6</a>). Any change in style—to even a single letter—requires the creation of a new <span class="literal">run</span> object. Currently, only styles that are in the opened <em>.docx</em> file are available. This may change in future versions of <span class="literal">python-docx</span>.</p>
<div class="image"><a id="ch06fig6"/><img src="../images/f0111-01.jpg" alt="image"/></div>
<p class="figcap"><em>Figure 6-6: The Styles pane in Microsoft Word 2016</em></p>
<p class="indent"><span epub:type="pagebreak" id="page_112"/>You can find full documentation on the use of styles in <span class="literal">python-docx</span> at <em><a href="http://python-docx.readthedocs.io/en/latest/user/styles-using.html">http://python-docx.readthedocs.io/en/latest/user/styles-using.html</a></em>.</p>
<p class="indent">Here’s an example of paragraphs and runs as <span class="literal">python-docx</span> sees them:</p>
<p class="noindentc"><em>I am a single paragraph of one run because all my text is the same style.</em></p>
<p class="noindentc"><em>I am a single paragraph with two runs. <strong>I am the second run because my style changed to bold.</strong></em></p>
<p class="noindentc"><em>I am a single paragraph with three runs. <strong>I am the second run because my style changed to bold. The third run is my last</strong> word.</em></p>
<p class="indent">If any of this seems unclear, don’t fret. You don’t need to know <span class="literal">python-docx</span> in any detail. As with any piece of code, you mainly need to know <em>what you want to do</em>. An online search should yield plenty of useful suggestions and complete samples of code.</p>
<div class="note">
<p class="notet"><strong><span class="notes">NOTE</span></strong></p>
<p class="notep"><em>For this to work smoothly, don’t change styles within the real (hidden) message and make sure you end every line in a hard return by manually pressing the <small>ENTER</small> key. Unfortunately, Word doesn’t have a special character for soft returns caused by automatic word wrapping. So, you can’t go into an existing Word document with automatic line breaks and use Find and Replace to change them all to hard returns. Such is the life of a mole.</em></p>
</div>
<h4 class="h4" id="lev137"><strong><em>Downloading the Assets</em></strong></h4>
<p class="noindent">The external files you’ll need are downloadable from <em><a href="https://www.nostarch.com/impracticalpython/">https://www.nostarch.com/impracticalpython/</a></em> and should be saved in the same folder as the code:</p>
<p class="hang"><strong><em>template.docx</em></strong> An empty Word doc formatted with official Holmes Corporation styles, fonts, and margins</p>
<p class="hang"><strong><em>fakeMessage.docx</em></strong> The fake message, without letterhead and date, in a Word document</p>
<p class="hang"><strong><em>realMessage.docx</em></strong> The real message in plaintext, without letterhead and date, in a Word document</p>
<p class="hang"><strong><em>realMessage_Vig.docx</em></strong> The real message encrypted with the Vigenère cipher</p>
<p class="hang"><strong><em>example_template_prep.docx</em></strong> An example of the fake message used to create the template document (the program doesn’t require this file to run)</p>
<div class="note">
<p class="notet"><strong><span class="notes">NOTE</span></strong></p>
<p class="notep"><em>If you’re using Word 2016, an easy way to make a blank template file is to write the fake message (including letterhead) and save the file. Then delete all the text and save the file again with a different name. When you assign this blank file to a variable with</em> <span class="codeitalic">python-docx</span><em>, all the existing styles will be retained. Of course, you could use a template file with the letterhead already included, but for the purpose of learning more about</em> <span class="codeitalic">python-docx</span><em>, we’ll build the letterhead here using Python.</em></p>
</div>
<p class="indent"><span epub:type="pagebreak" id="page_113"/>Take a moment to view these first four documents in Word. These files comprise the inputs to the <em>elementary_ink.py</em> program. The fake and real messages—the second and third items listed—are also shown in <a href="ch06.xhtml#ch06fig7">Figures 6-7</a> and <a href="ch06.xhtml#ch06fig8">6-8</a>.</p>
<div class="image"><a id="ch06fig7"/><img src="../images/f0113-01.jpg" alt="image"/></div>
<p class="figcap"><em>Figure 6-7: The “fake” text in the</em> fakeMessage.docx <em>file</em></p>
<div class="image"><a id="ch06fig8"/><img src="../images/f0113-02.jpg" alt="image"/></div>
<p class="figcap"><em>Figure 6-8: The real message in the</em> realMessage.docx <em>file</em></p>
<p class="indent">Note that the real message contains some numbers and special characters. These won’t be encrypted with the Vigenère tableau we’ll use, and I’ve included them to make that point. Ideally, they would be spelled out (for example, “three” for “3” and “percent” for “%”) for maximum secrecy when we add the Vigenère cipher later.</p>
<h3 class="h3" id="lev138"><strong>The Pseudocode</strong></h3>
<p class="noindent">The following pseudocode describes how to load the two messages and the template document, interleave and hide the real message in blank lines using a white font, and then save the hybrid message.</p>
<p class="programs">Build assets:<br/>In Word, create an empty doc with desired formatting/styles (template)<br/>In Word, create an innocuous fake message that will be visible &amp; have enough     blank lines to hold the real message<br/>In Word, create the real message that will be hidden<br/><span epub:type="pagebreak" id="page_114"/>Import docx to allow manipulation of Word docs with Python<br/>Use docx module to load the fake &amp; real messages as lists<br/>Use docx to assign the empty doc to a variable<br/>Use docx to add letterhead banner to empty doc<br/>Make counter variable for lines in real message<br/>Define function to format paragraph spacing with docx<br/>For line in fake message:<br/>    If line is blank and there are still lines in the real message:<br/>        Use docx &amp; counter to fill blank with line from real message<br/>        Use docx to set real message font color to white<br/>        Advance counter for real message<br/>    Otherwise:<br/>        Use docx to write fake line<br/>    Run paragraph spacing function<br/>Use docx to save final Word document</p>
<h3 class="h3" id="lev139"><strong>The Code</strong></h3>
<p class="noindent">The <em>elementary_ink.py</em> program in <a href="ch06.xhtml#ch06list1">Listing 6-1</a> loads the real message, the fake message, and the empty template document. It hides the real message in the blank lines of the fake message using a white font, and then saves the hybrid message as an innocuous and professional-looking piece of correspondence that can be attached to an email. You can download the code from <em><a href="https://www.nostarch.com/impracticalpython/">https://www.nostarch.com/impracticalpython/</a></em>.</p>
<h4 class="h4" id="lev140"><strong><em>Importing python-docx, Creating Lists, and Adding a Letterhead</em></strong></h4>
<p class="noindent"><a href="ch06.xhtml#ch06list1">Listing 6-1</a> imports <span class="literal">python-docx</span>, turns the lines of text in the fake and real messages into list items, loads the template document that sets the styles, and adds a letterhead.</p>
<p class="margin"><em>elementary_ink.py,</em> part 1</p>
<p class="programs">   import docx<br/><span class="ent">➊</span> from docx.shared import RGBColor, Pt<br/><br/><span class="ent">➋</span> # get text from fake message &amp; make each line a list item<br/>   fake_text = docx.Document('fakeMessage.docx')<br/>   fake_list = []<br/>   for paragraph in fake_text.paragraphs:<br/>       fake_list.append(paragraph.text)<br/><br/><span class="ent">➌</span> # get text from real message &amp; make each line a list item<br/>   real_text = docx.Document('realMessage.docx')<br/>   real_list = []<br/>   for paragraph in real_text.paragraphs:<br/>    <span class="ent">➍</span> if len(paragraph.text) != 0:  # remove blank lines<br/>           real_list.append(paragraph.text)<br/><br/><span class="ent">➎</span> # load template that sets style, font, margins, etc.<br/>   doc = docx.Document('template.docx')<br/><br/><span class="ent">➏</span> # add letterhead<br/><span epub:type="pagebreak" id="page_115"/>   doc.add_heading('Morland Holmes', 0)<br/>   subtitle = doc.add_heading('Global Consulting &amp; Negotiations', 1)<br/>   subtitle.alignment = 1<br/>   doc.add_heading('', 1)<br/><span class="ent">➐</span> doc.add_paragraph('December 17, 2015')<br/>   doc.add_paragraph('')</p>
<p class="listing" id="ch06list1"><em>Listing 6-1: Imports</em> <span class="codeitalic">python-docx</span><em>, loads important</em> .docx <em>files, and adds a letterhead</em></p>
<p class="indent">After importing the <span class="literal">docx</span> module—not as “python-docx”—use <span class="literal">docx.shared</span> to gain access to the color (<span class="literal">RGBColor</span>) and length (<span class="literal">Pt</span>) objects in the <span class="literal">docx</span> module <span class="ent">➊</span>. These will allow you to change the font color and set the spacing between lines. The next two code blocks load the fake <span class="ent">➋</span> and real <span class="ent">➌</span> message Word documents as lists. Where the <small>ENTER</small> key was pressed in each Word document determines what items will be in these lists. For the real message to be hidden, remove any blank lines so that your message will be as short as possible <span class="ent">➍</span>. Now you can use list indexes to merge the two messages and keep track of which is which.</p>
<p class="indent">Next, load the template document that contains the preestablished styles, fonts, and margins <span class="ent">➎</span>. The <span class="literal">docx</span> module will write to this variable and ultimately save it as the final document.</p>
<p class="indent">With the inputs loaded and prepped, format the letterhead of the final document to match that of the Holmes Corporation <span class="ent">➏</span>. The <span class="literal">add_heading()</span> function adds a heading style paragraph with text and integer arguments. Integer <span class="literal">0</span> designates the highest-level heading, or Title style, inherited from the template document. The subtitle is formatted with <span class="literal">1</span>, the next heading style available, and is center aligned, again with the integer <span class="literal">1</span> (<span class="literal">0</span> = left justified, <span class="literal">2</span> = right justified). Note that, when you add the date, you don’t need to supply an integer <span class="ent">➐</span>. When you don’t provide an argument, the default is to inherit from the existing style hierarchy, which in the template is left justified. The other statements in this block just add blank lines.</p>
<h4 class="h4" id="lev141"><strong><em>Formatting and Interleaving the Messages</em></strong></h4>
<p class="noindent"><a href="ch06.xhtml#ch06list2">Listing 6-2</a> does the real work, formatting the spacing between lines and interleaving the messages.</p>
<p class="margin"><em>elementary_ink.py,</em> part 2</p>
<p class="programs"><span class="ent">➊</span> def set_spacing(paragraph):<br/>       """Use docx to set line spacing between paragraphs."""<br/>       paragraph_format = paragraph.paragraph_format<br/>       paragraph_format.space_before = Pt(0)<br/>       paragraph_format.space_after = Pt(0)<br/><br/><span class="ent">➋</span> length_real = len(real_list)<br/>   count_real = 0  # index of current line in real (hidden) message<br/><br/>   # interleave real and fake message lines<br/>   for line in fake_list:<br/>    <span class="ent">➌</span> if count_real &lt; length_real and line == "":<br/>        <span class="ent">➍</span> paragraph = doc.add_paragraph(real_list[count_real])<br/>        <span class="ent">➎</span> paragraph_index = len(doc.paragraphs) - 1<br/><span epub:type="pagebreak" id="page_116"/>           # set real message color to white<br/>           run = doc.paragraphs[paragraph_index].runs[0]<br/>           font = run.font<br/>        <span class="ent">➏</span> font.color.rgb = RGBColor(255, 255, 255) # make it red to test<br/>        <span class="ent">➐</span> count_real += 1<br/>       else:<br/>        <span class="ent">➑</span> paragraph = doc.add_paragraph(line)<br/><br/>    <span class="ent">➒</span> set_spacing(paragraph)<br/><br/><span class="ent">➓</span> doc.save('ciphertext_message_letterhead.docx')<br/><br/>   print("Done")</p>
<p class="listing" id="ch06list2"><em>Listing 6-2: Formats paragraphs and interleaves lines of fake and real messages</em></p>
<p class="indent">Define a function that formats the spacing between paragraphs using <span class="literal">python-docx</span>’s <span class="literal">paragraph_format</span> attribute <span class="ent">➊</span>. Line spacing before and after the hidden line is set to <span class="literal">0</span> points to ensure that the output doesn’t have suspiciously large gaps between paragraphs, like the ones on the left-hand side of <a href="ch06.xhtml#ch06fig9">Figure 6-9</a>.</p>
<div class="image"><a id="ch06fig9"/><img src="../images/f0116-01.jpg" alt="image"/></div>
<p class="figcap"><em>Figure 6-9: Fake message line spacing without</em> <span class="codeitalic">python-docx</span> <em>paragraph formatting (left) vs. with formatting (right)</em></p>
<p class="indent">Next, define the working space by getting the length of the list that holds the real message <span class="ent">➋</span>. Remember that the hidden real message needs to be shorter than the visible fake message so that there are sufficient blank lines to hold it. Follow this by initiating a counter. The program will use it to keep track of which line (list item) it’s currently processing in the real message.</p>
<p class="indent">Since the list made from the fake message is the longest and sets the dimensional space for the real message, loop through the fake message <span epub:type="pagebreak" id="page_117"/>using two conditionals: 1) whether you’ve reached the end of the real message and 2) whether a line in the fake list is blank <span class="ent">➌</span>. If there are still real message lines and the fake message line is blank, use <span class="literal">count_real</span> as an index for <span class="literal">real_list</span> and use <span class="literal">python-docx</span> to add it to the document <span class="ent">➍</span>.</p>
<p class="indent">Get the index of the line you just added by taking the length of <span class="literal">doc.paragraphs</span> and subtracting 1 <span class="ent">➎</span>. Then use this index to set the real message line to a <span class="literal">run</span> object (it will be the first <span class="literal">run</span> item <span class="literal">[0]</span> in the list, as the real message uses a single style) and set its font color to white <span class="ent">➏</span>. Since the program has now added a line from the real list in this block, the <span class="literal">count_real</span> counter advances by 1 <span class="ent">➐</span>.</p>
<p class="indent">The subsequent <span class="literal">else</span> block addresses the case where the line chosen from the fake list in the <span class="literal">for</span> loop isn’t empty. In this case, the fake message line is added directly to the paragraph <span class="ent">➑</span>. Finish the <span class="literal">for</span> loop by calling the line spacing function, <span class="literal">set_spacing()</span> <span class="ent">➒</span>.</p>
<p class="indent">Once the length of the real message has been exceeded, the <span class="literal">for</span> loop will continue to add the remainder of the fake message—in this case, Mr. Kurtz’s signature info—and save the document as a Word <em>.docx</em> file in the final line <span class="ent">➓</span>. Of course, in real life, you’d want to use a less suspicious filename than <em>ciphertext_message_letterhead.docx</em>!</p>
<p class="indent">Note that, because you’re using a <span class="literal">for</span> loop based on the fake message, appending any more hidden lines after the <span class="literal">for</span> loop ends—that is, after you reach the end of the items in the fake list—is impossible. If you want more space, you must enter hard returns at the bottom of the fake message, but be careful not to add so many that you force a page break and create a mysterious empty page!</p>
<p class="indent">Run the program, open the saved Word document, use <small>CTRL</small>-A to select all the text, and then set the Highlight color (see <a href="ch06.xhtml#ch06fig4">Figure 6-4</a>) to dark gray to see both messages. The secret message should be revealed (<a href="ch06.xhtml#ch06fig10">Figure 6-10</a>).</p>
<div class="image"><a id="ch06fig10"/><img src="../images/f0117-01.jpg" alt="image"/></div>
<p class="figcap"><em>Figure 6-10: Word document highlighted in dark gray to show both the fake message and the unencrypted real message</em></p>
<h4 class="h4" id="lev142"><span epub:type="pagebreak" id="page_118"/><strong><em>Adding the Vigenère Cipher</em></strong></h4>
<p class="noindent">The code so far uses the plaintext version of the real message, so anyone who changes the document’s highlight color will be able to read and understand the sensitive information in it. Since you know Mr. Kurtz encrypted this using the Vigenère cipher, go back and alter the code to replace the plaintext with the encrypted text. To do this, find the following line:</p>
<p class="programs">real_text = docx.Document('realMessage.docx')</p>
<p class="indent">This line loads the real message as plaintext, so change the filename to the one shown here in bold:</p>
<p class="programs">real_text = docx.Document(<span class="codestrong1">'realMessage_Vig.docx'</span>)</p>
<p class="indent">Rerun the program and again reveal the hidden text by selecting the whole document and setting the Highlight color to dark gray (<a href="ch06.xhtml#ch06fig11">Figure 6-11</a>).</p>
<div class="image"><a id="ch06fig11"/><img src="../images/f0118-01.jpg" alt="image"/></div>
<p class="figcap"><em>Figure 6-11: Word document highlighted in dark gray to show both the fake message and the encrypted real message</em></p>
<p class="indent">The secret message should be visible but unreadable to anyone who cannot interpret the cipher. Compare the encrypted message in <a href="ch06.xhtml#ch06fig11">Figure 6-11</a> to the unencrypted version in <a href="ch06.xhtml#ch06fig10">Figure 6-10</a>. Note that numbers and the % sign occur in both versions. These were retained to demonstrate the potential pitfalls related to the encryption choice. You would want to augment the Vigenère cipher to include these characters—or just spell them out. That way, even if your message is discovered, you leave as few clues as possible as to the subject matter.</p>
<p class="indent">If you want to encode your own message with the Vigenère cipher, do an internet search for “online Vigenère encoder.” You’ll find multiple sites, such as <em><a href="http://www.cs.du.edu/~snarayan/crypt/vigenere.html">http://www.cs.du.edu/~snarayan/crypt/vigenere.html</a></em>, that let you type <span epub:type="pagebreak" id="page_119"/>or paste in plaintext. And if you want to write your own Python program for encrypting with the Vigenère cipher, see <em>Cracking Codes with Python</em> (No Starch Press, 2018) by Al Sweigart.</p>
<p class="indent">If you play around with your own real messages, encrypted or not, make sure you’re using the same font as in the fake message. A font is both a typeface, like Helvetica Italic, and a size, such as 12. Remember from “<a href="ch06.xhtml#lev134">Considering Font Types, Kerning, and Tracking</a>” on <a href="ch06.xhtml#page_109">page 109</a> that if you try to mix fonts, especially proportional and monospace fonts, the hidden message lines may wrap, resulting in uneven spacing between paragraphs of the real message.</p>
<h3 class="h3" id="lev143"><strong>Detecting the Hidden Message</strong></h3>
<p class="noindent">Could Joan Watson, or any other detective, have found your hidden message quickly? The truth is, probably not. In fact, as I write these words, I am watching an episode of <em>Elementary</em> where Joan is busy investigating a company by reading through a box of email printouts! The use of the Vigenère cipher may have been just a bit of lazy writing in an overall intelligently crafted series. Still, we can speculate on what might give you away.</p>
<p class="indent">Since the final bid was probably not sent until close to the bid date, the search could be limited to correspondence sent <em>after</em> the bid was finalized, thereby eliminating a lot of noise. Of course, a detective won’t know exactly what they’re looking for—or even if there <em>is</em> a mole—which leaves a large search space. And there’s always the possibility that the information was passed in a phone conversation or clandestine meeting.</p>
<p class="indent">Assuming there was a manageable volume of email and a hidden-message hypothesis was being pursued, an investigator might detect your invisible ink in several ways. For example, the Word spellchecker will not flag the white, nonsensical encrypted words as long as they haven’t been made visible. If, as a check, you swiped and reset the font color on some of the hidden words, they will be permanently compromised, even after their color has been restored to white. The spellchecker will underline them with an incriminating red squiggly line (see <a href="ch06.xhtml#ch06fig12">Figure 6-12</a>).</p>
<div class="image"><a id="ch06fig12"/><img src="../images/f0119-01.jpg" alt="image"/></div>
<p class="figcap"><em>Figure 6-12: Previously revealed invisible encrypted words underlined by the Word Spelling and Grammar tool</em></p>
<p class="indent">If the investigating detective uses an alternative to Word to open the document, the product’s spellchecker will most likely reveal the hidden words (see <a href="ch06.xhtml#ch06fig13">Figure 6-13</a>). This risk is mitigated somewhat by the dominance of Microsoft Word in the marketplace.</p>
<div class="image"><span epub:type="pagebreak" id="page_120"/><a id="ch06fig13"/><img src="../images/f0120-01.jpg" alt="image"/></div>
<p class="figcap"><em>Figure 6-13: The spellchecker in LibreOffice Writer will highlight the invisible words.</em></p>
<p class="indent">Second, using <small>CTRL</small>-A to highlight all the text within Word won’t reveal the hidden text, but it would indicate that some blank lines are longer than others (see <a href="ch06.xhtml#ch06fig14">Figure 6-14</a>), suggesting to the very observant that something is amiss.</p>
<div class="image"><a id="ch06fig14"/><img src="../images/f0120-02.jpg" alt="image"/></div>
<p class="figcap"><em>Figure 6-14: Selecting the whole Word document reveals differences in the length of blank lines.</em></p>
<p class="indent"><span epub:type="pagebreak" id="page_121"/>Third, opening the Word document using the preview functionality in some email software may reveal the hidden text when the contents are selected through swiping or using <small>CTRL</small>-A (<a href="ch06.xhtml#ch06fig15">Figure 6-15</a>).</p>
<div class="image"><a id="ch06fig15"/><img src="../images/f0121-01.jpg" alt="image"/></div>
<p class="figcap"><em>Figure 6-15: Selecting the whole document in the Yahoo! Mail Preview panel reveals the hidden text.</em></p>
<p class="indent">But while selecting hidden text in the Yahoo! Mail Preview panel reveals the text, the same is not true in the Microsoft Outlook Preview panel in <a href="ch06.xhtml#ch06fig16">Figure 6-16</a>.</p>
<div class="image"><a id="ch06fig16"/><img src="../images/f0121-02.jpg" alt="image"/></div>
<p class="figcap"><em>Figure 6-16: Selecting the whole document in the Microsoft Outlook Preview panel does not reveal the hidden text.</em></p>
<p class="indent">Finally, saving the Word document as a plain text (<em>*.txt</em>) file would remove all formatting and leave the hidden text exposed (<a href="ch06.xhtml#ch06fig17">Figure 6-17</a>).</p>
<div class="image"><span epub:type="pagebreak" id="page_122"/><a id="ch06fig17"/><img src="../images/f0122-01.jpg" alt="image"/></div>
<p class="figcap"><em>Figure 6-17: Saving the Word document as a plain text (</em>*.txt<em>) file reveals the hidden text.</em></p>
<p class="indent">To conceal a secret message with steganography, you have to conceal not only the <em>contents</em> of the message but also the fact that a message even <em>exists</em>. Our electronic invisible ink can’t always guarantee this, but from a mole’s point of view, the weaknesses just listed involve either them making a mistake, which could theoretically be controlled, or an investigator taking a dedicated and unlikely action, such as swiping text, saving files in a different format, or using a less-common word processor. Assuming the mole in <em>Elementary</em> considered these acceptable risks, electronic invisible ink provides a plausible explanation for why the internal company investigation failed.</p>
<h3 class="h3" id="lev144"><strong>Summary</strong></h3>
<p class="noindent">In this chapter, you used steganography to hide an encrypted message within a Microsoft Word document. You used a third-party module, called <span class="literal">python-docx</span>, to directly access and manipulate the document using Python. Similar third-party modules are available for working with other popular document types, like Excel spreadsheets.</p>
<h3 class="h3" id="lev145"><strong>Further Reading</strong></h3>
<p class="noindent">You can find online documentation for <span class="literal">python-docx</span> at <em><a href="https://python-docx.readthedocs.io/en/latest/">https://python-docx.readthedocs.io/en/latest/</a></em> and <em><a href="https://pypi.python.org/pypi/python-docx">https://pypi.python.org/pypi/python-docx</a></em>.</p>
<p class="indent"><em>Automate the Boring Stuff with Python</em> (No Starch Press, 2015) by Al Sweigart, covers modules that allow Python to manipulate PDFs, Word files, Excel spreadsheets, and more. <a href="ch13.xhtml#ch13">Chapter 13</a> contains a useful tutorial on <span class="literal">python-docx</span>, and the appendix covers installing third-party modules with pip.</p>
<p class="indent">You can find beginner-level Python programs for working with ciphers in <em>Cracking Codes with Python</em> (No Starch Press, 2018) by Al Sweigart.</p>
<p class="indent"><em>Mysterious Messages</em> (The Penguin Group, 2009) by Gary Blackwood is an interesting and well-illustrated history of steganography and cryptography.</p>
<h3 class="h3" id="lev146"><strong>Practice Project: Checking the Number of Blank Lines</strong></h3>
<p class="noindent">Improve the hidden message program by writing a function that compares the number of blank lines in the fake message to the number of lines in the real message. If there is insufficient space to hide the real message, have the function warn the user and tell them how many blank lines to add to the fake message. Insert and call the function in a copy of the <em>elementary_ink.py</em> <span epub:type="pagebreak" id="page_123"/>code, just before loading the template document. You can find a solution in the appendix and online at <em><a href="https://www.nostarch.com/impracticalpython/">https://www.nostarch.com/impracticalpython/</a></em> in <em>elementary_ink_practice.py</em>. For testing, download <em>realMessageChallenge.docx</em> from the same site and use it for the real message.</p>
<h3 class="h3" id="lev147"><strong>Challenge Project: Using Monospace Font</strong></h3>
<p class="noindent">Rewrite the <em>elementary_ink.py</em> code for monospace fonts and hide your own short message in the spaces between words. See “<a href="ch06.xhtml#lev134">Considering Font Types, Kerning, and Tracking</a>” on <a href="ch06.xhtml#page_109">page 109</a> for a description of monospace fonts. As always with challenge projects, no solution is provided.<span epub:type="pagebreak" id="page_124"/></p>
</body></html>