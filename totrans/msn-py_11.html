<html><head></head><body>
<h2 class="h2" id="ch11"><span epub:type="pagebreak" id="page_183"/><strong><span class="blue"><span class="big">11</span></span><br/>ACTIVATING SAFETY DOORS</strong></h2>
<div class="image1"><img src="../images/common01.jpg" alt="image"/></div>
<p class="noindent">On the space station, doors restrict access to certain zones and ensure that astronauts can only get into areas where they’re qualified to work. Many doors require personal access passes to open, and the engineering bay doors can only be opened with a button in Mission Control. The engineering bay doors also have a timer that closes them automatically to increase security.</p>
<p class="indent">The doors also enforce safety rules that require astronauts to have a working suit before they can enter the airlock and to have a buddy with them before the door to the planet surface can open. Footage from the security camera suggests that some astronauts have found a way to bypass the buddy requirement so they can enjoy the serenity of a solo walk on the planet’s surface.</p>
<p class="indent"><span epub:type="pagebreak" id="page_184"/>You installed the doors in the space station when you installed the props. In this chapter, you’ll add the code to open and close the doors, as well as add a few other tricks and puzzles to make the game more interesting.</p>
<h3 class="h3" id="lev138"><strong>PLANNING WHERE TO PUT SAFETY DOORS</strong></h3>
<p class="noindent">Doors are clearly a vital part of the space station design, but they’re also important for the game’s design. Most obviously, they present a challenging puzzle: players need to find a way to open locked doors.</p>
<p class="indent">The doors also help us to tell a story, in which there are obstacles that the hero must overcome using their survival training and logical thinking. The game’s puzzles will only be satisfying if the player has to think about them a little bit. So it’s important that we can control when players see the different puzzle elements. Imagine you enter a room and there’s rampant fire blocking the other exit. If you’re already carrying a fire extinguisher, you just whip it out and use it. There’s no real challenge. It’s more intriguing if you see the threat (or the puzzle), and then have to figure out the solution. By sealing off parts of the map, we can guide players to see a problem before they see its solution. We can’t be certain they’ll notice everything we put in their path, but we can give them an opportunity to experience the game at its best.</p>
<p class="indent">Doors also enable us to get more value from the map. Although it might not feel like it after typing it in, the game map isn’t huge. We can provide a richer experience and a longer game by requiring players to cross difficult rooms more than once. For example, if we put a key at the end of a corridor, we can direct the player to retrace their steps along the corridor and use the key in a door they passed on the way.</p>
<p class="indent"><a href="ch11.xhtml#ch11fig1">Figure 11-1</a> shows the location of doors in the game. Without giving too much away, players won’t be able to get into room 36 before they’ve gotten into the top-right section of the space station (via room 34). They won’t be able to visit room 27 until they’ve gotten into room 40, either. By strategically placing items in the locked rooms, including access cards, we can direct the player through the game and through the story.</p>
<div class="image"><a id="ch11fig1"/><img src="../images/fig11-1.jpg" alt="image"/></div>
<p class="figcap"><em>Figure 11-1: The game map with doors shown in red</em></p>
<p class="indent">When you’re designing your own games, think carefully about where you put your props. It’s one of the most important elements in ensuring the game presents players with an enjoyable challenge.</p>
<h3 class="h3" id="lev139"><span epub:type="pagebreak" id="page_185"/><strong>POSITIONING THE DOORS</strong></h3>
<p class="noindent">I’ve positioned all the doors in <em>Escape</em> at the top or bottom exit of a room because of the game’s top-down perspective. If a door was in a side exit, players would only see its top surface, and we need to make sure something as important as a door can be clearly seen.</p>
<p class="indent">Most of the doors are at the top of the room and remain open after the player opens them. The exception is the door between rooms 32 and 27, which has a timer mechanism that shuts it automatically. This timer provides an additional challenge: the player must rush to get to the room from the switch that opens the door, before the door closes.</p>
<p class="indent">The doors in <em>Escape</em> are objects 20 to 26. Their images and descriptions are set up in the <code>objects</code> dictionary (see “<a href="ch05.xhtml#lev79">Making the Space Station Objects Dictionary</a>” on <a href="ch05.xhtml#page_85">page 85</a>). The door positions are set up in the <code>props</code> dictionary (see “<a href="ch09.xhtml#lev117">Adding the Props Information</a>” on <a href="ch09.xhtml#page_151">page 151</a>). Each door has an <em>x</em> position that puts it in the room’s doorway. To work out the <em>x</em> position for a door, just divide the room width by 2, round it down, and then subtract 1.</p>
<p class="indent">Now let’s add some controls to enable players to open the doors.</p>
<h3 class="h3" id="lev140"><strong>ADDING ACCESS CONTROLS</strong></h3>
<p class="noindent">To enable the player to open the doors, we need to add some instructions to the <code>use_object()</code> function in the <code>USE OBJECTS</code> part of the program. One new code snippet will open the timed door to the engineering bay when the player presses a button in one of the rooms. You’ll add this code between the instructions for handling objects 16 and 68.</p>
<p class="indent">The other new code addition will enable the player to use access cards to open the doors: put this after the code for using recipes.</p>
<p class="indent"><a href="ch11.xhtml#ch11list1">Listing 11-1</a> shows the new code to add. Because these instructions are part of the <code>use_object()</code> function, the first one is indented by four spaces. Your new <code>elif</code> instruction should line up with the <code>elif</code> instruction above it.</p>
<p class="indent">Open <em>listing10-7.py</em> from the previous chapter and add these new lines to it. Save your program as <em>listing11-1.py</em>. You can run it using <span class="codestrong">pgzrun</span> <span class="codestrong">listing11</span><span class="codestrong">-1.py</span>, but we haven’t added all the code necessary to make the doors work properly yet. You shouldn’t see any error messages, though.</p>
<p class="margin"><em>listing11-1.py</em></p>
<pre>   <span class="gray">--<span class="codeitalic1">snip</span>--</span><br/>       <span class="gray">elif item_player_is_on == 16:</span><br/>           <span class="gray">energy += 1</span><br/>           <span class="gray">if energy &gt; 100:</span><br/>               <span class="gray">energy = 100</span><br/>           <span class="gray">use_message = "You munch the lettuce and get a little energy back"</span><br/><span epub:type="pagebreak" id="page_186"/>           <span class="gray">draw_energy_air()</span><br/><br/><span class="ent">➊</span>     <span class="orange">elif</span> item_player_is_on == 42:<br/><span class="ent">➋</span>         <span class="orange">if</span> current_room == 27:<br/><span class="ent">➌</span>             open_door(26)<br/><span class="ent">➍</span>         props[25][0] = 0 <span class="red"># Door from RM32 to engineering bay</span><br/>           props[26][0] = 0 <span class="red"># Door inside engineering bay</span><br/><span class="ent">➎</span>         clock.schedule_unique(shut_engineering_door, 60)<br/>           use_message = <span class="green">"You press the button"</span><br/>           show_text(<span class="green">"Door to engineering bay is open for 60 seconds"</span>, 1)<br/>           sounds.say_doors_open.play()<br/>           sounds.doors.play()<br/><br/>       <span class="gray">elif item_carrying == 68 or item_player_is_on == 68:</span><br/>           <span class="gray">energy = 100</span><br/>           <span class="gray">use_message = "You use the food to restore your energy"</span><br/>           <span class="gray">remove_object(68)</span><br/>           <span class="gray">draw_energy_air()</span><br/><br/>   <span class="gray">--<span class="codeitalic1">snip</span>--</span><br/><br/>      <span class="gray">for recipe in RECIPES:</span><br/>           <span class="gray">ingredient1 = recipe[0]</span><br/>           <span class="gray">ingredient2 = recipe[1]</span><br/>   <span class="gray">--<span class="codeitalic1">snip</span>--</span><br/>               <span class="gray">add_object(combination)</span><br/>               <span class="gray">sounds.combine.play()</span><br/><br/>       <span class="red"># {key object number: door object number}</span><br/><span class="ent">➏</span>     ACCESS_DICTIONARY = { 79:22, 80:23, 81:24 }<br/><span class="ent">➐</span>     <span class="orange">if</span> item_carrying <span class="orange">in</span> ACCESS_DICTIONARY:<br/>           door_number = ACCESS_DICTIONARY[item_carrying]<br/><span class="ent">➑</span>         <span class="orange">if</span> props[door_number][0] == current_room:<br/>               use_message = <span class="green">"You unlock the door!"</span><br/><span class="ent">➒</span>             sounds.say_doors_open.play()<br/>               sounds.doors.play()<br/>               open_door(door_number)<br/><br/>       <span class="gray">show_text(use_message, 0)</span><br/>       <span class="gray">time.sleep(0.5)</span><br/><br/>   <span class="gray">--<span class="codeitalic1">snip</span>--</span></pre>
<p class="listing" id="ch11list1"><em>Listing 11-1: Adding the ability to open doors</em></p>
<p class="indent">The button to open the door to the engineering bay is object 42. There is one of these buttons outside the engineering bay to provide access, and another inside the engineering bay, so the player doesn’t get trapped inside.</p>
<p class="indent">If the player is using the button <span class="ent">➊</span>, the code to open the door runs. If they’re using the button inside the room <span class="ent">➋</span>, the <code>open_door()</code> function is used to show the door opening <span class="ent">➌</span>. We’ll add that function shortly.</p>
<p class="indent">The <code>props</code> dictionary is updated to change the room number for the door to 0, removing the door from the room (and from the game) <span class="ent">➍</span>. This door works on a timer, so the program schedules the function to close <span epub:type="pagebreak" id="page_187"/>the door 60 seconds later <span class="ent">➎</span>. If you find it too difficult to get to the room in time, you can change the number 60 to a larger number. This number should give you just about enough time, whether you’re using a PC or Raspberry Pi 3; or a Raspberry Pi 2, where the game runs a little bit more slowly.</p>
<p class="indent">The second chunk of code enables players to use keys to open the doors. We create a new dictionary called <code>ACCESS_DICTIONARY</code> that uses the access card number as the dictionary key and the door number as the data <span class="ent">➏</span>. So object 79 (an access card) is used to open door 22, for example.</p>
<div class="sidebar1">
<p class="sidebart"><strong>TIP</strong></p>
<p class="spara">The objects used to open the doors in <em>Escape</em> are all access cards, but if you’re modifying the game, you could use any object. You could use a crowbar to pry doors open, or (if you make a game set in a fantasy world) you could use different magic spells. Just make sure players can reasonably work out what to use.</p>
</div>
<p class="indent">When the player presses U, the door opens if they have selected one of the items in the dictionary for unlocking doors <span class="ent">➐</span> and if they are standing in the same room as the door it unlocks <span class="ent">➑</span>. We also play a sound effect of a computer voice saying “doors open” <span class="ent">➒</span>. This is just a recording, like any other sound in the game.</p>
<h3 class="h3" id="lev141"><strong>MAKING THE DOORS OPEN AND CLOSE</strong></h3>
<p class="noindent">We’ll place the functions for opening, closing, and animating the doors into a new <code>DOORS</code> section of the program. You need to add this section after the <code>USE OBJECTS</code> section but before the <code>START</code> section at the end.</p>
<p class="indent"><a href="ch11.xhtml#ch11list2">Listing 11-2</a> shows the first two functions you need to add to start the <code>DOORS</code> section. Add the new lines, and save your program as <em>listing11-2.py</em>. The <code>DOORS</code> section is still incomplete: you can run the program (using <span class="codestrong">pgzrun listing11-2.py</span>) to check for errors, but the doors won’t work yet.</p>
<p class="margin"><em>listing11-2.py</em></p>
<pre>   <span class="gray">--<span class="codeitalic1">snip</span>--</span><br/>           <span class="gray">sounds.completion.play()</span><br/>           <span class="gray">sounds.say_mission_complete.play()</span><br/><br/>   <span class="red">###############</span><br/>   <span class="red">##   DOORS   ##</span><br/>   <span class="red">###############</span><br/><br/><span class="ent">➊</span> <span class="orange">def</span> <span class="blue">open_door</span>(opening_door_number):<br/>       <span class="orange">global</span> door_frames, door_shadow_frames<br/>       <span class="orange">global</span> door_frame_number, door_object_number<br/><span class="ent">➋</span>     door_frames = [images.door1, images.door2, images.door3,<br/>                      images.door4, images.floor]<br/>       <span class="red"># (Final frame restores shadow ready for when door reappears).</span><br/>       door_shadow_frames = [images.door1_shadow, images.door2_shadow,<br/>                             images.door3_shadow, images.door4_shadow,<br/>                             images.door_shadow]<br/><span epub:type="pagebreak" id="page_188"/>       door_frame_number = 0<br/>       door_object_number = opening_door_number<br/><span class="ent">➌</span>     do_door_animation()<br/><br/><span class="ent">➍</span> <span class="orange">def</span> <span class="blue">close_door</span>(closing_door_number):<br/>       <span class="orange">global</span> door_frames, door_shadow_frames<br/>       <span class="orange">global</span> door_frame_number, door_object_number, player_y<br/><span class="ent">➎</span>     door_frames = [images.door4, images.door3, images.door2,<br/>                      images.door1, images.door]<br/>       door_shadow_frames = [images.door4_shadow, images.door3_shadow,<br/>                             images.door2_shadow, images.door1_shadow,<br/>                             images.door_shadow]<br/>       door_frame_number = 0<br/>       door_object_number = closing_door_number<br/>       <span class="red"># If player is in same row as a door, they must be in open doorway</span><br/><span class="ent">➏</span>     <span class="orange">if</span> player_y == props[door_object_number][1]:<br/><span class="ent">➐</span>         <span class="orange">if</span> player_y == 0: <span class="red"># if in the top doorway</span><br/><span class="ent">➑</span>             player_y = 1 <span class="red"># move them down</span><br/>           <span class="orange">else</span>:<br/><span class="ent">➒</span>             player_y = room_height - 2 <span class="red"># move them up</span><br/><span class="ent">➓</span>     do_door_animation()<br/><br/><br/>   <span class="gray">###############</span><br/>   <span class="gray">##   START   ##</span><br/>   <span class="gray">###############</span><br/>   <span class="gray">--<span class="codeitalic1">snip</span>--</span></pre>
<p class="listing" id="ch11list2"><em>Listing 11-2: Setting up the door animations</em></p>
<p class="indent">The <code>open_door()</code> and <code>close_door()</code> functions set up the door animations for opening and closing. You’ve already seen <code>open_door()</code> <span class="ent">➊</span> mentioned in <a href="ch11.xhtml#ch11list1">Listing 11-1</a>. In <a href="ch11.xhtml#ch11list2">Listing 11-2</a>, we define that function so it can run if the player opens a door using a key, for example.</p>
<p class="indent">The door animation has five frames, numbered 0 to 4, as shown in <a href="ch11.xhtml#ch11tab1">Table 11-1</a>. We store images for the animation in a list called <code>door_frames</code> <span class="ent">➋</span><span class="ent">➎</span> and store the frame number in the variable <code>door_frame_number</code>. In the <code>open_door()</code> and <code>close_door()</code> functions, we set the frame number to 0, the first frame.</p>
<p class="indent">In the variable <code>door_object_number</code>, we store the object number of the door that will be opening or closing. After the variables and list have been set up, the function <code>do_door_animation()</code> is started to carry out the animation using them <span class="ent">➌</span><span class="ent">➓</span>. We’ll add that function shortly.</p>
<p class="indent">The function for closing the door <span class="ent">➍</span> is similar to the function for opening the door <span class="ent">➊</span> with two exceptions: the animation frames are different, and there is a check to stop the door from closing on top of the player.</p>
<p class="indent">If the player is in the same <em>y</em> position as the door <span class="ent">➏</span>, it means the player is standing in the doorway. In that case, if the player is in the top row <span class="ent">➐</span>, we set their <em>y</em> position to 1 <span class="ent">➑</span> to move them to the next row down. If the player is not in the top row, we set their <em>y</em> position to the second row from the bottom <span class="ent">➒</span>, just inside the door.</p>
<p class="indent"><span epub:type="pagebreak" id="page_189"/>This means the astronaut jumps out of the way of the doors of their own accord, but it’s more realistic than them ending up inside the door!</p>
<p class="tabcap" id="ch11tab1"><strong>Table 11-1:</strong> The Animation Frames for the Doors</p>
<table class="topbot-d">
<thead>
<tr>
<td style="vertical-align: top;" class="table-a"><p class="tab_th"><strong>Frame number</strong></p></td>
<td style="vertical-align: top;" class="table-a"><p class="tab_th"><strong>0</strong></p></td>
<td style="vertical-align: top;" class="table-a"><p class="tab_th"><strong>1</strong></p></td>
<td style="vertical-align: top;" class="table-a"><p class="tab_th"><strong>2</strong></p></td>
<td style="vertical-align: top;" class="table-a"><p class="tab_th"><strong>3</strong></p></td>
<td style="vertical-align: top;" class="table-a"><p class="tab_th"><strong>4</strong></p></td>
</tr>
</thead>
<tbody>
<tr>
<td style="vertical-align: top;" class="table-a"><p class="taba"><strong>Opening</strong></p></td>
<td style="vertical-align: top;" class="table-a"><p class="taba"><img src="../images/f0189-01.jpg" alt="image"/></p></td>
<td style="vertical-align: top;" class="table-a"><p class="taba"><img src="../images/f0189-02.jpg" alt="image"/></p></td>
<td style="vertical-align: top;" class="table-a"><p class="taba"><img src="../images/f0189-03.jpg" alt="image"/></p></td>
<td style="vertical-align: top;" class="table-a"><p class="taba"><img src="../images/f0189-04.jpg" alt="image"/></p></td>
<td style="vertical-align: top;" class="table-a"><p class="taba"><strong>Final frame is a floor tile (no door).</strong></p></td>
</tr>
<tr>
<td style="vertical-align: top;" class="table-a"><p class="taba"><strong>Closing</strong></p></td>
<td style="vertical-align: top;" class="table-a"><p class="taba"><img src="../images/f0189-05.jpg" alt="image"/></p></td>
<td style="vertical-align: top;" class="table-a"><p class="taba"><img src="../images/f0189-06.jpg" alt="image"/></p></td>
<td style="vertical-align: top;" class="table-a"><p class="taba"><img src="../images/f0189-07.jpg" alt="image"/></p></td>
<td style="vertical-align: top;" class="table-a"><p class="taba"><img src="../images/f0189-08.jpg" alt="image"/></p></td>
<td style="vertical-align: top;" class="table-a"><p class="taba"><img src="../images/f0189-09.jpg" alt="image"/></p></td>
</tr>
</tbody>
</table>
<h3 class="h3" id="lev142"><strong>ADDING THE DOOR ANIMATION</strong></h3>
<p class="noindent">The <code>do_door_animation()</code> function will manage the animation of the doors opening and closing.</p>
<p class="indent">Place the <code>do_door_animation()</code> function inside the <code>DOORS</code> section of the program, after the <code>close_door()</code> function you added in <a href="ch11.xhtml#ch11list2">Listing 11-2</a>. Add the new lines in <a href="ch11.xhtml#ch11list3">Listing 11-3</a>, and save your program as <em>listing11-3.py</em>. You can run this version of the game using <span class="codestrong">pgzrun listing11-3.py</span>. The doors that are opened with a key should now be working. I’ll tell you how to test them in Training Mission #1 shortly.</p>
<p class="margin"><em>listing11-3.py</em></p>
<pre>   <span class="gray">--<span class="codeitalic1">snip</span>--</span><br/>               <span class="gray">player_y = room_height - 2 # move them up</span><br/>       <span class="gray">do_door_animation()</span><br/><br/>   <span class="orange">def</span> <span class="blue">do_door_animation</span>():<br/>       <span class="orange">global</span> door_frames, door_frame_number, door_object_number, objects<br/><span class="ent">➊</span>     objects[door_object_number][0] = door_frames[door_frame_number]<br/>       objects[door_object_number][1] = door_shadow_frames[door_frame_number]<br/><span class="ent">➋</span>     door_frame_number += 1<br/><span class="ent">➌</span>     <span class="orange">if</span> door_frame_number == 5:<br/><span class="ent">➍</span>         <span class="orange">if</span> door_frames[-1] == images.floor:<br/><span class="ent">➎</span>             props[door_object_number][0] = 0 <span class="red"># remove door from props list</span><br/>           <span class="red"># Regenerate room map from the props</span><br/>           <span class="red"># to put the door in the room if required.</span><br/><span class="ent">➏</span>         generate_map()<br/><span class="ent">➐</span>     <span class="orange">else</span>:<br/><span class="ent">➑</span>         clock.schedule(do_door_animation, 0.15)<br/><br/><span epub:type="pagebreak" id="page_190"/>   <span class="gray">###############</span><br/>   <span class="gray">##   START   ##</span><br/>   <span class="gray">###############</span><br/>   <span class="gray">--<span class="codeitalic1">snip</span>--</span></pre>
<p class="listing" id="ch11list3"><em>Listing 11-3: Adding the door animation</em></p>
<p class="indent">The <code>objects</code> dictionary contains, among other things, the image to use for a particular object. This new function starts by changing the door’s image in that dictionary to the current animation frame <span class="ent">➊</span>. When the room is redrawn, it will now use that animation frame.</p>
<p class="indent">The function then increases the animation frame number by 1 <span class="ent">➋</span> so the next animation frame can be shown next time this function runs. If the frame is now 5, it means we’ve reached the end of the animation <span class="ent">➌</span>. In that case, we check whether the door has opened (rather than closed) by seeing whether the final frame was a floor tile, showing no door <span class="ent">➍</span>. (An index number of <code>-1</code> gives you the last item in a list.)</p>
<p class="indent">If the door has now fully opened, the props data is updated to remove this door from the game by changing its room number to 0 <span class="ent">➎</span>. If the current animation frame is the final frame, whether the door is opening or closing, a new room map is generated <span class="ent">➏</span>, which ensures the door is added or removed correctly in the current room.</p>
<p class="indent">If the current frame isn’t the final animation frame <span class="ent">➐</span>, the function sets itself to run again in 0.15 seconds <span class="ent">➑</span> to show the next frame in the sequence.</p>
<p class="indent">You may be wondering why I didn’t combine the two <code>if</code> instructions <span class="ent">➌</span><span class="ent">➍</span>. The reason is that the <code>generate_map()</code> function needs to run at the end of the animation, whether the door is opening or closing. If we combined the two <code>if</code> instructions, this function would only run when the door had opened.</p>
<div class="sidebar">
<p class="sidebart" id="ch11sb1"><strong>TRAINING MISSION #1</strong></p>
<p class="noindent">At this point in the program, the doors should be fully functional. Can you test that they work? Find the access card for the door in the community room and use it. Stand in the community room and use the access card for its door by selecting the access card in your inventory and pressing U. If you need a hint, look at the map in <a href="ch11.xhtml#ch11fig1">Figure 11-1</a>. The community room is number 39, and the key for it is in room 41. Remember that people sometimes tidy things away, and the key might not be lying in plain sight.</p>
</div>
<h3 class="h3" id="lev143"><strong>SHUTTING THE TIMED DOOR</strong></h3>
<p class="noindent">Next, we need to add a new function called <code>shut_engineering_door()</code> to shut the door to the engineering bay automatically. This function is set to run after a delay of 60 seconds when the door is opened (see <a href="ch11.xhtml#ch11list1">Listing 11-1</a>), giving the player a minute to run from the button to the door before it shuts!</p>
<p class="indent"><span epub:type="pagebreak" id="page_191"/>Put this function in the <code>DOORS</code> section of the program after the <code>do_door_animation()</code> function you just added. Add the new lines in <a href="ch11.xhtml#ch11list4">Listing 11-4</a>, and save the program as <em>listing11-4.py</em>. Then run this program using <span class="codestrong">pgzrun</span> <span class="codestrong">listing11</span><span class="codestrong">-4.py</span>. You should see no error messages. The timed door should be working now, but I’ll show you an easier way to test it shortly.</p>
<p class="margin"><em>listing11-4.py</em></p>
<pre>   <span class="gray">--<span class="codeitalic1">snip</span>--</span><br/>       <span class="gray">else:</span><br/>           <span class="gray">clock.schedule(do_door_animation, 0.15)</span><br/><br/>   <span class="orange">def</span> <span class="blue">shut_engineering_door</span>():<br/>       <span class="orange">global</span> current_room, door_room_number, props<br/><span class="ent">➊</span>     props[25][0] = 32 <span class="red"># Door from room 32 to the engineering bay.</span><br/><span class="ent">➋</span>     props[26][0] = 27 <span class="red"># Door inside engineering bay.</span><br/><span class="ent">➌</span>     generate_map() <span class="red"># Add door to room_map for if in affected room.</span><br/><span class="ent">➍</span>     <span class="orange">if</span> current_room == 27:<br/><span class="ent">➎</span>         close_door(26)<br/><span class="ent">➏</span>     <span class="orange">if</span> current_room == 32:<br/><span class="ent">➐</span>         close_door(25)<br/>       show_text(<span class="green">"The computer tells you the doors are closed."</span>, 1)<br/>       sounds.say_doors_closed.play()<br/><br/><br/>   <span class="gray">###############</span><br/>   <span class="gray">##   START   ##</span><br/>   <span class="gray">###############</span><br/>   <span class="gray">--<span class="codeitalic1">snip</span>--</span></pre>
<p class="listing" id="ch11list4"><em>Listing 11-4: Adding the code to shut the engineering door automatically</em></p>
<p class="indent">The <code>shut_engineering_door()</code> function has two door props to work with, objects 25 and 26, because the player can see this door from either side depending on which room they’re in. The first thing we do is update the <code>props</code> dictionary so these doors appear in the rooms <span class="ent">➊</span><span class="ent">➋</span>.</p>
<p class="indent">We then call the <code>generate_map()</code> function <span class="ent">➌</span>. If the player is in a room with one of these doors, this function updates the room map for the current room. In other cases, the <code>generate_map()</code> function still runs, but nothing changes.</p>
<p class="indent">If the player is in the engineering bay (room 27) <span class="ent">➍</span>, they need to see door 26 closing <span class="ent">➎</span>, so the program starts the animation. If the player is on the other side of the door, in room 32 <span class="ent">➏</span>, we need to show them door 25 closing <span class="ent">➐</span>.</p>
<div class="note">
<p class="notet"><strong><span class="notes">RED ALERT</span></strong></p>
<p class="notep"><em>Don’t mix up door numbers and room numbers. Door numbers are object numbers and aren’t related to the room they’re in.</em></p>
</div>
<p class="indent">To test that the engineering bay door is working correctly, we’d have to run the game, press the button, and race to the engineering bay. So to save time, let’s engineer a solution that enables us to get around the space station more quickly.</p>
<h3 class="h3" id="lev144"><span epub:type="pagebreak" id="page_192"/><strong>ADDING A TELEPORTER</strong></h3>
<p class="noindent">While you’re still building the space station, you might find it helpful to be able to jump to any room in an instant. Using the latest in molecular transfer technology, we can install a <em>teleporter</em> that allows you to type in a room number and go straight there. This is a huge benefit when you’re testing the game, but it’s a restricted technology and isn’t approved for use in a real mission on the space station. You’ll need to remove it before you finish building the game. I’m trusting you with highly classified technology here.</p>
<p class="indent">Place the teleporter code with the other player controls in the <code>game_loop()</code> function, in the <code>GAME LOOP</code> part of the program. I recommend that you add it after the instructions for starting the <code>use_object</code> function. Because these instructions are inside a function, you need to indent the <code>if</code> instruction by four spaces and then indent the instructions under it by four more spaces.</p>
<p class="indent">Add the new instructions in <a href="ch11.xhtml#ch11list5">Listing 11-5</a>, and then save your file as <em>listing11-5.py</em>. You can run this program using <span class="codestrong">pgzrun listing11-5.py</span>.</p>
<p class="margin"><em>listing11-5.py</em></p>
<pre>   <span class="gray">--<span class="codeitalic1">snip</span>--</span><br/><br/>       <span class="gray">if keyboard.u:</span><br/>           <span class="gray">use_object()</span><br/><br/>   <span class="red">## Teleporter for testing</span><br/>   <span class="red">## Remove this section for the real game</span><br/><span class="ent">➊</span>     <span class="orange">if</span> keyboard.x:<br/><span class="ent">➋</span>         current_room = <span class="purple">int</span>(<span class="purple">input</span>(<span class="green">"Enter room number:"</span>))<br/><span class="ent">➌</span>         player_x = 2<br/>           player_y = 2<br/><span class="ent">➍</span>         generate_map()<br/><span class="ent">➎</span>         start_room()<br/>           sounds.teleport.play()<br/>   <span class="red">## Teleport section ends</span><br/><br/>   <span class="gray">--<span class="codeitalic1">snip</span>--</span></pre>
<p class="listing" id="ch11list5"><em>Listing 11-5: Adding a teleporter</em></p>
<p class="indent">When you press the X key <span class="ent">➊</span>, the program will ask you to type in a room number <span class="ent">➋</span>. This request appears in the command line window where you type in your <code>pgzrun</code> instruction to run the program. You might need to click this window to bring it to the front and will need to click the game window to play again afterwards.</p>
<p class="indent">The <code>input()</code> function takes whatever you enter and puts it in a string. Because we need the input as a number, we use the <code>int()</code> function to convert it to an integer (or whole number) <span class="ent">➋</span>.</p>
<p class="indent">The number you enter goes into the <code>current_room</code> variable. There’s no error checking here, so the program might crash if you don’t enter a valid room number. If you enter text instead of a number, for example, the program freezes.</p>
<p class="indent">You’re teleported to position <em>y</em> = 2, <em>x</em> = 2 <span class="ent">➌</span> inside the room you choose. This is usually a fairly safe place to be, but if the teleporter puts you inside <span epub:type="pagebreak" id="page_193"/>some scenery, you can usually just walk out of it. The room map is regenerated <span class="ent">➍</span>, and the room is restarted <span class="ent">➎</span>, completing your teleportation to your new destination.</p>
<div class="sidebar">
<p class="sidebart" id="ch11sb2"><strong>TRAINING MISSION #2</strong></p>
<p class="spara">Use the teleporter to beam into room 27 so you can test the door in the engineering bay. Use the button at the top of the room to open the door (press U while walking into the button), and wait in the room until the door closes. Open the door again, but this time leave the room and check that the door still closes when seen from the other side. The door animation should work correctly.</p>
</div>
<h3 class="h3" id="lev145"><strong>ACTIVATING THE AIRLOCK SECURITY DOOR</strong></h3>
<p class="noindent">As a safety feature, the airlock door to the planet’s surface uses a weight sensor to open it. One astronaut must stand on the pressure pad to open the door, enabling another one to walk through it. This design ensures that astronauts cannot go out onto the planet’s surface without support in the space station.</p>
<p class="indent">To enable this safety feature, we’ll need to add a new function to the program’s <code>DOORS</code> section. <a href="ch11.xhtml#ch11list6">Listing 11-6</a> shows the code for the new function, which animates the door. Add this code after the <code>shut_engineering_door()</code> function you added in <a href="ch11.xhtml#ch11list4">Listing 11-4</a>. Save your updated program as <em>listing11-6.py</em>. You can run your program using <span class="codestrong">pgzrun listing11-6.py</span>, but the airlock door is not activated yet.</p>
<p class="margin"><em>listing11-6.py</em></p>
<pre>   <span class="gray">--<span class="codeitalic1">snip</span>--</span><br/>       <span class="gray">show_text("The computer tells you the doors are closed.", 1)</span><br/>       <span class="gray">sounds.say_doors_closed.play()</span><br/><br/>   <span class="orange">def</span> <span class="blue">door_in_room_26</span>():<br/>       <span class="orange">global</span> airlock_door_frame, room_map<br/><span class="ent">➊</span>     frames = [images.door, images.door1, images.door2,<br/>                 images.door3,images.door4, images.floor<br/>                 ]<br/><br/>       shadow_frames = [images.door_shadow, images.door1_shadow,<br/>                        images.door2_shadow, images.door3_shadow,<br/>                        images.door4_shadow, <span class="orange">None</span>]<br/><br/><span class="ent">➋</span>     <span class="orange">if</span> current_room != 26:<br/>           clock.unschedule(door_in_room_26)<br/>           <span class="orange">return</span><br/><br/>       <span class="red"># prop 21 is the door in Room 26.</span><br/><span class="ent">➌</span>     <span class="orange">if</span> ((player_y == 8 <span class="orange">and</span> player_x == 2) <span class="orange">or</span> props[63] == [26, 8, 2]) \<br/>               <span class="orange">and</span> props[21][0] == 26:<br/><span class="ent">➍</span>         airlock_door_frame += 1<br/><br/><span epub:type="pagebreak" id="page_194"/><span class="ent">➎</span>         <span class="orange">if</span> airlock_door_frame == 5:<br/>               props[21][0] = 0 # Remove door from map when fully open.<br/>               room_map[0][1] = 0<br/>               room_map[0][2] = 0<br/>               room_map[0][3] = 0<br/><br/><span class="ent">➏</span>     <span class="orange">if</span> ((player_y != 8 <span class="orange">or</span> player_x != 2) <span class="orange">and</span> props[63] != [26, 8, 2]) \<br/>               <span class="orange">and</span> airlock_door_frame &gt; 0:<br/>           <span class="orange">if</span> airlock_door_frame == 5:<br/>               <span class="red"># Add door to props and map so animation is shown.</span><br/>               props[21][0] = 26<br/>               room_map[0][1] = 21<br/>               room_map[0][2] = 255<br/>               room_map[0][3] = 255<br/>           airlock_door_frame -= 1<br/><br/><span class="ent">➐</span>     objects[21][0] = frames[airlock_door_frame]<br/>       objects[21][1] = shadow_frames[airlock_door_frame]<br/><br/><br/>   <span class="gray">###############</span><br/>   <span class="gray">##   START   ##</span><br/>   <span class="gray">###############</span><br/>   <span class="gray">--<span class="codeitalic1">snip</span>--</span></pre>
<p class="listing" id="ch11list6"><em>Listing 11-6: Adding the weight-activated door in the airlock</em></p>
<p class="indent">I’ve added the <code>door_in_room_26()</code> function to the game to enable a specific puzzle. To avoid telling you the solution and spoiling the puzzle, I won’t cover everything that’s in the code here, but I’m sure you can work it out if you want to!</p>
<p class="indent">We store the animation frames for the door in the list <code>frames</code>, including the first frame that shows the door shut and the final frame that shows an empty floor tile instead of the door <span class="ent">➊</span>.</p>
<p class="indent">We store the animation frame for the airlock door in the <code>airlock_door_frame</code> variable. If the player is standing on the pressure pad (at position <em>y</em> = 8 and <em>x</em> = 2) and the door is in the room <span class="ent">➌</span>, the animation frame number is increased to open the door a bit more <span class="ent">➍</span>. If the animation frame is now 5 <span class="ent">➎</span>, then the door is fully opened, and the <code>props</code> dictionary and room map are updated to remove the door from the room.</p>
<p class="indent">We add another section of code to close the door when the player is <em>not</em> standing on the pressure pad and the door is already at least partially open <span class="ent">➏</span>, so the door closes if the player moves off the pressure pad. The program only displays props that are in the room map for the current room, so the first instructions put the door (object 21) into the room map, even though the first animation frame will show the door fully open.</p>
<p class="indent">Finally, we change the image file for the door in the <code>objects</code> dictionary to the current animation frame <span class="ent">➐</span>. The door’s shadow image is also updated. As a result, when the room is drawn, the picture for the door shows its current animation frame.</p>
<p class="indent">This airlock routine creates a smooth effect where the door slides open when the player steps on the pressure pad, but slides shut again the moment <span epub:type="pagebreak" id="page_195"/>they walk off. If they step back onto the pad while the door is shutting, it starts to open again.</p>
<p class="indent">To make the airlock routine work, we also need to add the instruction to make the <code>door_in_room_26()</code> function run every 0.05 seconds when the player enters the room. When the <code>door_in_room_26()</code> function starts, it checks whether the player is still in room 26. If the player has left the room, the instructions at <span class="ent">➋</span> in <a href="ch11.xhtml#ch11list6">Listing 11-6</a> stop the function from running regularly and exit the function (using a <code>return</code> instruction) so that the door animation stops.</p>
<p class="indent">We’ll put the code that starts the <code>door_in_room_26()</code> function into the <code>start_room()</code> function at the top of the <code>GAME LOOP</code> section. The <code>start_room()</code> function runs when the player enters a room. <a href="ch11.xhtml#ch11list7">Listing 11-7</a> shows the new instructions to add.</p>
<p class="margin"><em>listing11-7.py</em></p>
<pre><span class="gray">--<span class="codeitalic1">snip</span>--</span><br/><span class="gray">###############</span><br/><span class="gray">## GAME LOOP ##</span><br/><span class="gray">###############</span><br/><br/><span class="gray">def start_room():</span><br/>    <span class="orange">global</span> airlock_door_frame<br/>    <span class="gray">show_text("You are here: " + room_name, 0)</span><br/>    <span class="orange">if</span> current_room == 26: <span class="red"># Room with self-shutting airlock door</span><br/>        airlock_door_frame = 0<br/>        clock.schedule_interval(door_in_room_26, 0.05)<br/><br/><span class="gray">--</span><span class="codeitalic1">snip</span><span class="gray">--</span></pre>
<p class="listing" id="ch11list7"><em>Listing 11-7: Scheduling the door animation for the airlock</em></p>
<p class="indent">Save your program as <em>listing11-7.py</em> and run it using <span class="codestrong">pgzrun listing11-7.py</span>. In the game, press X to use the teleporter and beam into room 26. Now you can test that the pressure pad works as expected (see <a href="ch11.xhtml#ch11fig2">Figure 11-2</a>). Try walking on it, off it, and across it to see how the door behaves.</p>
<p class="indent">Note that if you leave through the exit at the bottom of this room, a door appears that blocks your way back again. (Normally, you would only enter the airlock by opening that door and removing it from the game.) When you teleport into rooms, strange things like this might happen. It messes with the space-time continuum.</p>
<div class="image"><a id="ch11fig2"/><img src="../images/fig11-2.jpg" alt="image"/></div>
<p class="figcap"><em>Figure 11-2: Standing on the pressure pad opens the door.</em></p>
<h3 class="h3" id="lev146"><strong>REMOVING EXITS FOR YOUR OWN GAME DESIGNS</strong></h3>
<p class="noindent">If you’re closing off exits for your own map designs, you might need to move or remove doors in those <span epub:type="pagebreak" id="page_196"/>exits as well. To remove a door from the game, change the entry for that door in the <code>props</code> dictionary so its first number is a 0, or delete its entry from the dictionary.</p>
<p class="indent">If you’re customizing the game, you might also want to remove some of the custom code here that enables the special doors for the engineering bay and the airlock. To disable the pressure pad door, remove the new code in <a href="ch11.xhtml#ch11list6">Listings 11-6</a> and <a href="ch11.xhtml#ch11list7">11-7</a>. To remove the timed door to the engineering bay, remove the code shown in <a href="ch11.xhtml#ch11list4">Listing 11-4</a>, and additionally remove the first chunk of new code in <a href="ch11.xhtml#ch11list1">Listing 11-1</a> for pressing the button (using object 42).</p>
<h3 class="h3" id="lev147"><strong>MISSION ACCOMPLISHED?</strong></h3>
<p class="noindent">You’ve now finished building the space station, and it’s fully functional. It seems you can now settle into your new life, conducting experiments and exploring the red planet.</p>
<p class="indent">But, wait! What’s this? There could be trouble ahead.</p>
<h3 class="h3" id="lev148"><strong>ARE YOU FIT TO FLY?</strong></h3>
<p class="noindentb">Check the following boxes to confirm that you’ve learned the key lessons in this chapter.</p>
<p class="square"><img src="../images/box.jpg" alt="Images"/>  Doors can seal off parts of the game map, so players can discover puzzle elements in the right order.</p>
<p class="square"><img src="../images/box.jpg" alt="Images"/>  Doors need to go at the top or the bottom of a room.</p>
<p class="square"><img src="../images/box.jpg" alt="Images"/>  Doors that are opened with access cards stay open.</p>
<p class="square"><img src="../images/box.jpg" alt="Images"/>  You can use the functions provided to add doors that close automatically, such as the door in the engineering bay.</p>
<p class="square"><img src="../images/box.jpg" alt="Images"/>  Doors are positioned using the <code>props</code> dictionary. Their images and descriptions are stored in the <code>objects</code> dictionary.</p>
<p class="square"><img src="../images/box.jpg" alt="Images"/>  To animate the door, the program changes its image in the <code>objects</code> dictionary. When the room is redrawn, the new image is used for the door.</p>
<p class="square"><img src="../images/box.jpg" alt="Images"/>  If a door can be seen from both sides, it needs to be represented with two door props: one in each of the rooms where it can be seen.</p>
<p class="square"><img src="../images/box.jpg" alt="Images"/>  <code>ACCESS_DICTIONARY</code> is used to remember which access cards unlock which doors. You could use other objects to open doors by making changes in this dictionary.</p>
<p class="square"><img src="../images/box.jpg" alt="Images"/>  To adjust the difficulty of the game, you can change the delay before the engineering door slams shut.</p>
<p class="square"><img src="../images/box.jpg" alt="Images"/>  The teleporter enables you to beam into any room for testing purposes.</p>
<p class="square"><img src="../images/box.jpg" alt="Images"/>  The <code>input()</code> function in Python treats what you enter as a string. To enable players to type in a number, use the <code>int()</code> function to convert what they enter to an integer.</p>
</body></html>