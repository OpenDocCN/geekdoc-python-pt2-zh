<html><head></head><body>
<h2 class="h2" id="ch08"><span epub:type="pagebreak" id="page_127"/><strong><span class="blue"><span class="big">8</span></span><br/>REPAIRING THE SPACE STATION</strong></h2>
<div class="image1"><img src="../images/common01.jpg" alt="image"/></div>
<p class="noindent">While wandering around the space station, you must have noticed that some things don’t look quite right. To get the program up and running quickly, we used the <code>EXPLORER</code> section to display the rooms. However, it has a few drawbacks:</p>
<ul>
<li class="noindent">Sometimes a blank space is shown beneath the scenery because there’s no floor there.</li>
<li class="noindent">When you walk to the front of the room, the front wall hides the astronaut.</li>
<li class="noindent">The astronaut’s legs disappear when walking to the back of the screen.</li>
<li class="noindent">The rooms are all drawn in the top left of the game window. This makes it look uneven and inconsistent, because there’s much more space on the right of the rooms than on the left, and wider rooms leave less space on the right than narrow rooms do.</li>
<li class="noindent"><span epub:type="pagebreak" id="page_128"/>There are no shadows, making it harder to understand the position of objects in the room.</li>
</ul>
<p class="indent">In this chapter, we’ll fix these glitches and also add a function for displaying messages at the top of the window. These messages will give players information about the space station and their progress in the game.</p>
<p class="indent">As you read through the chapter, you’ll learn how to send information to a Python function and discover how to draw rectangles using Pygame Zero. By the end of the chapter, the space station will look great!</p>
<h3 class="h3" id="lev99"><strong>SENDING INFORMATION TO A FUNCTION</strong></h3>
<p class="noindent">For the first time, we’ll need to send information to a function. You’ve already seen how to send information to the <code>print()</code> function by putting it between the parentheses. For example, you can output a message like this:</p>
<pre><span class="purple">print</span>(<span class="green">"Learn your emergency evacuation drill"</span>)</pre>
<p class="indent">When that instruction runs, the <code>print()</code> function receives information you put in the brackets, and displays it in the command line window or the Python shell.</p>
<p class="indent">We can also send information to functions we’ve made.</p>
<h4 class="h4" id="lev100"><strong>CREATING A FUNCTION THAT RECEIVES INFORMATION</strong></h4>
<p class="noindent">To experiment with functions, we’ll build a function that adds two numbers that we send it. Click <strong>File</strong> <span class="ent">▸</span> <strong>New</strong> to open a new window, and enter the program in <a href="ch08.xhtml#ch08list1">Listing 8-1</a>.</p>
<p class="margin"><em>listing8-1.py</em></p>
<pre><span class="ent">➊</span> <span class="orange">def</span> <span class="blue">add</span>(first_number, second_number):<br/><span class="ent">➋</span>     total = first_number + second_number<br/><span class="ent">➌</span>     <span class="purple">print</span>(first_number, <span class="green">"+"</span>, second_number, <span class="green">"="</span>, total)<br/><br/><span class="ent">➍</span> add(5, 7)<br/>   add(2012, 137)<br/>   add(1234, 4321)</pre>
<p class="listing" id="ch08list1"><em>Listing 8-1: Sending information to a function</em></p>
<p class="indent">Save the program as <em>listing8-1.py</em>. Because it doesn’t use any Pygame Zero features, you can run it by clicking <strong>Run</strong> <span class="ent">▸</span> <strong>Run Module</strong> or by pressing F5. (If you do run it using Pygame Zero, the results will appear in the command line window, and the game window will be empty.)</p>
<p class="indent">When you run the program, you should see the following output:</p>
<pre><span class="blue">5 + 7 = 12</span><br/><span class="blue">2012 + 137 = 2149</span><br/><span class="blue">1234 + 4321 = 5555</span></pre>
<p class="indent"><span epub:type="pagebreak" id="page_129"/>We create a new function called <code>add()</code> <span class="ent">➊</span>. After we’ve defined <code>add()</code>, we can run it by using its name <span class="ent">➍</span> and send it numbers by putting them in the parentheses, using commas between them <span class="ent">➍</span>. The function will then add those two numbers.</p>
<h4 class="h4" id="lev101"><strong>HOW IT WORKS</strong></h4>
<p class="noindent">To enable the function to receive the numbers, we give it two variables to store the numbers in when we define it. I’ve called them <code>first_number</code> and <code>second_number</code> <span class="ent">➊</span> to make the program easier to understand, but the variable names could be anything. These are local variables: they only work inside this function.</p>
<p class="indent">When you use the function, it takes the first item it receives and puts it into the variable <code>first_number</code>. The second item goes into <code>second_number</code>.</p>
<p class="indent">Of course, it doesn’t matter which order you add two numbers in, so it doesn’t matter what order you send the numbers in. The instructions <code>add(5, 7)</code> and <code>add(7, 5)</code> give the same result. But some functions will need you to send the information in the same order the function expects to receive it. For example, if the function were subtracting numbers, you’d get a different result if you sent the numbers in the wrong order. The only way to know what information a function expects to receive is to take a look at its code.</p>
<p class="indent">The body of the function is quite simple. It creates a new variable called <code>total</code>, which stores the result of adding the two numbers <span class="ent">➋</span>. The program then prints a line that contains the first number, a plus sign, the second number, an equal sign, and the total <span class="ent">➌</span>.</p>
<p class="indent">In the last three instructions, we send the function three pairs of numbers to add <span class="ent">➍</span>.</p>
<p class="indent">This simple demonstration shows you how information (or <em>arguments</em>) can be sent to a function. You can make functions that take more arguments than just two, and even take lists, dictionaries, or images. Functions make it easy to reuse sets of instructions, and sending arguments means we can reuse those instructions with different information. For example, <a href="ch08.xhtml#ch08list1">Listing 8-1</a> uses the same <code>print()</code> instruction three times, to display the sum of three different number pairs. In this case, we’ve avoided repeating the <code>print()</code> instruction and the one that sets up the <code>total</code> variable. More sophisticated functions can avoid repeating a lot of code, and this can make the program much easier to write and understand.</p>
<div class="sidebar">
<p class="sidebart" id="ch08sb1"><strong>TRAINING MISSION #1</strong></p>
<p class="spara">Try modifying the program to subtract one number from another rather than adding. What happens when you change the order of the numbers you send to the new function? You might want to change more than just the calculation to make sure the function is easy to use.</p>
</div>
<p class="indent">Now we’re ready to add some new functions to <em>Escape</em> to draw objects on the space station.</p>
<h3 class="h3" id="lev102"><span epub:type="pagebreak" id="page_130"/><strong>ADDING VARIABLES FOR SHADOWS, WALL TRANSPARENCY, AND COLORS</strong></h3>
<p class="noindent">To fix our space station, we’ll create new display functions for the <em>Escape</em> game, using our newfound knowledge of functions. Before we make these new functions, we need to set up new variables for the functions to use.</p>
<p class="indent">Open <em>listing7-6.py</em>, the last listing you saved in <a href="ch07.xhtml#ch07">Chapter 7</a>. Find the <code>VARIABLES</code> section near the start of the program, and add the new lines shown in <a href="ch08.xhtml#ch08list2">Listing 8-2</a>. Save the program as <em>listing8-2.py</em>. As always, it’s a good idea to run the program (using <span class="codestrong">pgzrun listing8-2.py</span>) to check for any new errors.</p>
<p class="margin"><em>listing8-2.py</em></p>
<pre>   <span class="gray">--<span class="codeitalic1">snip</span>--</span><br/><br/>   <span class="gray">###############</span><br/>   <span class="gray">## VARIABLES ##</span><br/>   <span class="gray">###############</span><br/><br/>   <span class="gray">--<span class="codeitalic1">snip</span>--</span><br/><br/>   <span class="gray">player_image = PLAYER[player_direction][player_frame]</span><br/>   <span class="gray">player_offset_x, player_offset_y = 0, 0</span><br/><br/><span class="ent">➊</span> PLAYER_SHADOW = {<br/>       <span class="green">"left"</span>: [images.spacesuit_left_shadow, images.spacesuit_left_1_shadow,<br/>                images.spacesuit_left_2_shadow, images.spacesuit_left_3_shadow,<br/>                images.spacesuit_left_3_shadow<br/>                ],<br/>       <span class="green">"right"</span>: [images.spacesuit_right_shadow, images.spacesuit_right_1_shadow,<br/>                 images.spacesuit_right_2_shadow,<br/>                 images.spacesuit_right_3_shadow, images.spacesuit_right_3_shadow<br/>                 ],<br/>       <span class="green">"up"</span>: [images.spacesuit_back_shadow, images.spacesuit_back_1_shadow,<br/>              images.spacesuit_back_2_shadow, images.spacesuit_back_3_shadow,<br/>              images.spacesuit_back_3_shadow<br/>              ],<br/>       <span class="green">"down"</span>: [images.spacesuit_front_shadow, images.spacesuit_front_1_shadow,<br/>                images.spacesuit_front_2_shadow, images.spacesuit_front_3_shadow,<br/>                images.spacesuit_front_3_shadow<br/>                ]<br/>       }<br/><br/><span class="ent">➋</span> player_image_shadow = PLAYER_SHADOW[<span class="green">"down"</span>][0]<br/><br/><span class="ent">➌</span> PILLARS = [<br/>       images.pillar, images.pillar_95, images.pillar_80,<br/>       images.pillar_60, images.pillar_50<br/>       ]<br/><br/><span class="ent">➍</span> wall_transparency_frame = 0<br/><br/><span epub:type="pagebreak" id="page_131"/><span class="ent">➎</span> BLACK = (0, 0, 0)<br/>   BLUE = (0, 155, 255)<br/>   YELLOW = (255, 255, 0)<br/>   WHITE = (255, 255, 255)<br/>   GREEN = (0, 255, 0)<br/>   RED = (128, 0, 0)<br/><br/>   <span class="gray">###############</span><br/>   <span class="gray">##    MAP    ##</span><br/>   <span class="gray">###############</span><br/><br/>   <span class="gray">--<span class="codeitalic1">snip</span>--</span></pre>
<p class="listing" id="ch08list2"><em>Listing 8-2: Adding the variables needed for the new display functions</em></p>
<p class="indent">We add a <code>PLAYER_SHADOW</code> dictionary <span class="ent">➊</span> that’s similar to the <code>PLAYER</code> dictionary. It contains animation frames for the astronaut’s shadow on the floor. As the astronaut moves, the shadow also changes shape. The <code>player_image_shadow</code> <span class="ent">➋</span> stores the astronaut’s current shadow, like the <code>player_image</code> variable that stores the astronaut’s current animation frame (or the standing image).</p>
<p class="indent">Later in this chapter, we’ll add animation that fades out the front wall when you walk behind it so you can still see the astronaut. Here, we set up a list of the animation frames <span class="ent">➌</span> and a <code>wall_transparency_frame</code> variable to remember the one that’s being shown now <span class="ent">➍</span>. You’ll learn more about how these work later on.</p>
<p class="indent">We’ve also set up some names that we can use to refer to color numbers <span class="ent">➎</span>. Colors in Pygame Zero are stored as tuples. A tuple is like a list whose content you can’t change, and it uses parentheses instead of square brackets. You’ve seen tuples used for coordinates when drawing on the screen (see <a href="ch01.xhtml#ch01">Chapter 1</a>). Colors are stored as three numbers that specify the amount of red, green, and blue in the color, in that order. The scale for each color ranges from 0 to 255. This color is bright red:</p>
<pre>(255, 0, 0)</pre>
<p class="indent">The red is at its maximum (255), and there’s no green (0) or blue (0) in the color.</p>
<p class="indent">Because we’ve set up these color variables, we can now use the name <code>BLACK</code> instead of using the tuple <code>(0, 0, 0)</code> to represent black. Using color names will make the program easier to read.</p>
<p class="indent"><a href="ch08.xhtml#ch08tab1">Table 8-1</a> shows you some of the color combinations that you might want to use in your programs. You can also try different numbers to invent your own colors.</p>
<p class="tabcap" id="ch08tab1"><span epub:type="pagebreak" id="page_132"/><strong>Table 8-1:</strong> Some Example RGB Color Numbers</p>
<table class="topbot-d">
<thead>
<tr>
<td style="vertical-align: top;" class="table-h"><p class="tab_th"><strong>Red</strong></p></td>
<td style="vertical-align: top;" class="table-h"><p class="tab_th"><strong>Green</strong></p></td>
<td style="vertical-align: top;" class="table-h"><p class="tab_th"><strong>Blue</strong></p></td>
<td style="vertical-align: top;" class="table-h"><p class="tab_th"><strong>Description</strong></p></td>
</tr>
</thead>
<tbody>
<tr>
<td style="vertical-align: top;" class="table-b"><p class="taba">255</p></td>
<td style="vertical-align: top;" class="table-b"><p class="taba">0</p></td>
<td style="vertical-align: top;" class="table-b"><p class="taba">0</p></td>
<td style="vertical-align: top;" class="table-b"><p class="taba">Bright red</p></td>
</tr>
<tr>
<td style="vertical-align: top;" class="table-b"><p class="taba">0</p></td>
<td style="vertical-align: top;" class="table-b"><p class="taba">255</p></td>
<td style="vertical-align: top;" class="table-b"><p class="taba">0</p></td>
<td style="vertical-align: top;" class="table-b"><p class="taba">Bright green</p></td>
</tr>
<tr>
<td style="vertical-align: top;" class="table-b"><p class="taba">0</p></td>
<td style="vertical-align: top;" class="table-b"><p class="taba">0</p></td>
<td style="vertical-align: top;" class="table-b"><p class="taba">255</p></td>
<td style="vertical-align: top;" class="table-b"><p class="taba">Bright blue</p></td>
</tr>
<tr>
<td style="vertical-align: top;" class="table-b"><p class="taba">0</p></td>
<td style="vertical-align: top;" class="table-b"><p class="taba">0</p></td>
<td style="vertical-align: top;" class="table-b"><p class="taba">50</p></td>
<td style="vertical-align: top;" class="table-b"><p class="taba">Very dark blue (nearly black!)</p></td>
</tr>
<tr>
<td style="vertical-align: top;" class="table-b"><p class="taba">255</p></td>
<td style="vertical-align: top;" class="table-b"><p class="taba">255</p></td>
<td style="vertical-align: top;" class="table-b"><p class="taba">255</p></td>
<td style="vertical-align: top;" class="table-b"><p class="taba">White (all the colors at maximum strength)</p></td>
</tr>
<tr>
<td style="vertical-align: top;" class="table-b"><p class="taba">255</p></td>
<td style="vertical-align: top;" class="table-b"><p class="taba">255</p></td>
<td style="vertical-align: top;" class="table-b"><p class="taba">150</p></td>
<td style="vertical-align: top;" class="table-b"><p class="taba">Creamy yellow (slightly less blue than white)</p></td>
</tr>
<tr>
<td style="vertical-align: top;" class="table-b"><p class="taba">230</p></td>
<td style="vertical-align: top;" class="table-b"><p class="taba">230</p></td>
<td style="vertical-align: top;" class="table-b"><p class="taba">230</p></td>
<td style="vertical-align: top;" class="table-b"><p class="taba">Silver (a slightly toned-down white)</p></td>
</tr>
<tr>
<td style="vertical-align: top;" class="table-b"><p class="taba">200</p></td>
<td style="vertical-align: top;" class="table-b"><p class="taba">150</p></td>
<td style="vertical-align: top;" class="table-b"><p class="taba">200</p></td>
<td style="vertical-align: top;" class="table-b"><p class="taba">Lilac</p></td>
</tr>
<tr>
<td style="vertical-align: top;" class="table-b"><p class="taba">255</p></td>
<td style="vertical-align: top;" class="table-b"><p class="taba">100</p></td>
<td style="vertical-align: top;" class="table-b"><p class="taba">0</p></td>
<td style="vertical-align: top;" class="table-b"><p class="taba">Orange (maximum red with a dash of green)</p></td>
</tr>
<tr>
<td style="vertical-align: top;" class="table-ba"><p class="taba">255</p></td>
<td style="vertical-align: top;" class="table-ba"><p class="taba">105</p></td>
<td style="vertical-align: top;" class="table-ba"><p class="taba">180</p></td>
<td style="vertical-align: top;" class="table-ba"><p class="taba">Pink</p></td>
</tr>
</tbody>
</table>
<h3 class="h3" id="lev103"><strong>DELETING THE EXPLORER SECTION</strong></h3>
<p class="noindent">We need to add a new <code>DISPLAY</code> section with some new functions that will improve the game’s appearance onscreen. The <code>EXPLORER</code> section has enabled us to get up and running quickly, but we’re going to build a new and better <code>draw()</code> function in this chapter that replaces the one we’ve used so far. To avoid any problems caused by <code>EXPLORER</code> code still being in the program, we’re going to remove it. Your <code>EXPLORER</code> section might have more or fewer lines than mine does in <a href="ch08.xhtml#ch08fig1">Figure 8-1</a>, depending on whether you deleted some of it in earlier chapters.</p>
<p class="indent">To delete the entire <code>EXPLORER</code> section, follow these steps:</p>
<ol>
<li class="noindent">Find the <code>EXPLORER</code> part of the program near the end of the code.</li>
<li class="noindent">Click the start of the <code>EXPLORER</code> comment box, hold down the mouse button, and drag the mouse to the bottom of the section (see <a href="ch08.xhtml#ch08fig1">Figure 8-1</a>). The section ends just above where the <code>START</code> section begins.</li>
<li class="noindent">Press <small>DELETE</small> or <small>BACKSPACE</small> on the keyboard.</li>
</ol>
<p class="indent">There’s one instruction in the <code>EXPLORER</code> section that we still need: it runs the <code>generate_map()</code> function to set up the room map for the first room. You’ll need to add that instruction to the end of the program as a single line, as shown in <a href="ch08.xhtml#ch08list3">Listing 8-3</a>.</p>
<p class="margin"><em>listing8-3.py</em></p>
<pre><span class="gray">--<span class="codeitalic1">snip</span>--</span><br/><span class="gray">###############</span><br/><span class="gray">##   START   ##</span><br/><span class="gray">###############</span><br/><br/><span class="gray">clock.schedule_interval(game_loop, 0.03)</span><br/>generate_map()</pre>
<p class="listing" id="ch08list3"><em>Listing 8-3: Generating the map for the first room</em></p>
<p class="indent"><span epub:type="pagebreak" id="page_133"/>The <code>generate_map()</code> line will run after the variables have been set up and will make the map for the current room.</p>
<div class="image"><a id="ch08fig1"/><img src="../images/fig8-1.jpg" alt="image"/></div>
<p class="figcap"><em>Figure 8-1: Deleting the</em> <span class="codeitalic">EXPLORER</span> <em>section</em></p>
<p class="indent">Save your new listing as <em>listing8-3.py</em> and run it using <span class="codestrong">pgzrun listing8-3.py</span>. If all is going to plan, you should see no error messages in the command line window. The game window shows the inky blackness of space because we haven’t added the new code to draw anything yet.</p>
<h3 class="h3" id="lev104"><strong>ADDING THE DISPLAY SECTION</strong></h3>
<p class="noindent">Now we’ll add the new <code>DISPLAY</code> section to replace the deleted <code>EXPLORER</code> section. This section contains most of the code for updating the screen display. It includes code for drawing the room, showing messages, and changing the transparency of the front wall.</p>
<h4 class="h4" id="lev105"><span epub:type="pagebreak" id="page_134"/><strong>ADDING THE FUNCTIONS FOR DRAWING OBJECTS</strong></h4>
<p class="noindent">First, we’ll make some functions to draw an object, a shadow, or the player at a particular tile position. Between the <code>GAME LOOP</code> and <code>START</code> sections, add the new <code>DISPLAY</code> section shown in <a href="ch08.xhtml#ch08list4">Listing 8-4</a> to your program. Save this program as <em>listing8-4.py</em> and run it using <span class="codestrong">pgzrun listing8-4.py</span>. Again, you won’t see anything in the game window yet.</p>
<p class="indent">If there are any errors in the command line window, you can use them to help you fix the program. It’s better to test as you add code to the program than to add a lot of code and not know where the mistakes might be.</p>
<p class="margin"><em>listing8-4.py</em></p>
<pre>   <span class="gray">--<span class="codeitalic1">snip</span>--</span><br/><br/>       <span class="gray">if player_direction == "down" and player_frame &gt; 0:</span><br/>           <span class="gray">player_offset_y = -1 + (0.25 * player_frame)</span><br/><br/>   <span class="red">###############</span><br/>   <span class="red">##  DISPLAY  ##</span><br/>   <span class="red">###############</span><br/><br/><span class="ent">➊</span> <span class="orange">def</span> <span class="blue">draw_image</span>(image, y, x):<br/><span class="ent">➋</span>     screen.blit(<br/>           image,<br/>           (top_left_x + (x * TILE_SIZE),<br/>            top_left_y + (y * TILE_SIZE) - image.get_height())<br/>           )<br/><br/><span class="ent">➌</span> <span class="orange">def</span> <span class="blue">draw_shadow</span>(image, y, x):<br/>       screen.blit(<br/>           image,<br/>           (top_left_x + (x * TILE_SIZE),<br/>            top_left_y + (y * TILE_SIZE))<br/>           )<br/><br/>   <span class="orange">def</span> <span class="blue">draw_player</span>():<br/><span class="ent">➍</span>     player_image = PLAYER[player_direction][player_frame]<br/><span class="ent">➎</span>     draw_image(player_image, player_y + player_offset_y,<br/>                  player_x + player_offset_x)<br/><span class="ent">➏</span>     player_image_shadow = PLAYER_SHADOW[player_direction][player_frame]<br/><span class="ent">➐</span>     draw_shadow(player_image_shadow, player_y + player_offset_y,<br/>                   player_x + player_offset_x)<br/><br/>   <span class="gray">###############</span><br/>   <span class="gray">##   START   ##</span><br/>   <span class="gray">###############</span><br/><br/>   <span class="gray">clock.schedule_interval(game_loop, 0.03)</span><br/>   <span class="gray">generate_map()</span></pre>
<p class="listing" id="ch08list4"><em>Listing 8-4: Adding the first functions in the</em> <span class="codeitalic">DISPLAY</span> <em>section</em></p>
<p class="indent"><span epub:type="pagebreak" id="page_135"/>The first new function, <code>draw_image()</code> <span class="ent">➊</span>, draws a given image on the screen. When we use it, we give it the image we want to draw and the <em>y</em> and <em>x</em> tile positions of the object in the room. The function will work out where on the screen to draw the image (the pixel position), based on the tile position in the room. For example, we might use the function like this:</p>
<pre>draw_image(player_image, 5, 2)</pre>
<p class="indent">This line draws the player image at position <em>y</em> = 5 and <em>x</em> = 2 in the room.</p>
<p class="indent">When we define the <code>draw_image()</code> function, we set it up to give the image the name <code>image</code>, put the <em>y</em> position into the <code>y</code> variable, and put the <em>x</em> position into the <code>x</code> variable <span class="ent">➊</span>. Although the <code>draw_image()</code> function is several lines long, its only instruction is <code>screen.blit()</code>, which draws the image at the position we specify <span class="ent">➋</span>. This instruction is virtually the same as the one we used in the old <code>EXPLORER</code> section, so take a look at <a href="ch03.xhtml#ch03">Chapter 3</a> for a refresher on how it works.</p>
<div class="sidebar1">
<p class="sidebart"><strong>TIP</strong></p>
<p class="spara">Make sure all the parentheses are in the correct places. You need a pair around all the <code>screen.blit()</code> arguments and another pair around the <em>y</em> and <em>x</em> positions because they make up a single tuple. You also need a pair around the multiplication parts of the position calculations. If the program doesn’t work, start checking for errors by counting the opening and closing parentheses to make sure you have the same number of each of them.</p>
</div>
<p class="indent">We then add a new <code>draw_shadow()</code> function <span class="ent">➌</span>. This is similar to the function for drawing an image, except that the image’s height is not subtracted when calculating its onscreen position. This is what places the shadow <em>below</em> the main image. <a href="ch08.xhtml#ch08fig2">Figure 8-2</a> shows the astronaut and their shadow based on the same tile position. Remember that the <em>y</em> position given to <code>screen.blit()</code> is for the top edge of the image.</p>
<div class="image"><a id="ch08fig2"/><img src="../images/fig8-2.jpg" alt="image"/></div>
<p class="figcap"><em>Figure 8-2: Working out the position of the image and the shadow</em></p>
<p class="indent">The third new function, <code>draw_player()</code>, draws the astronaut. First, it puts the correct astronaut animation frame into <code>player_image</code> <span class="ent">➍</span>. It then uses the <span epub:type="pagebreak" id="page_136"/>new <code>draw_image()</code> function to draw it <span class="ent">➎</span>. The <code>draw_image()</code> function requires the following arguments:</p>
<ul>
<li class="noindent">The variable <code>player_image</code>, which contains the image to draw.</li>
<li class="noindent">The result after adding the global variables for <code>player_y</code> and <code>player_offset_y</code>. This is the <em>y</em> position in tiles, which might include a decimal part (such as 5.25).</li>
<li class="noindent">The result after adding <code>player_x</code> and <code>player_offset_x</code> for the <em>x</em> position in tiles. (See “<a href="ch07.xhtml#lev96">Understanding the Movement Code</a>” on <a href="ch07.xhtml#page_119">page 119</a> for more information on how the offset variables are used for animation.)</li>
</ul>
<p class="indent">We use similar code to draw the player’s shadow: the correct animation frame from the <code>PLAYER_SHADOW</code> dictionary is put into <code>player_image_shadow</code> <span class="ent">➏</span>. Then the <code>draw_shadow()</code> function is used to draw it <span class="ent">➐</span>. The <code>draw_shadow()</code> function uses the same tile positions as the <code>draw_image()</code> function.</p>
<h4 class="h4" id="lev106"><strong>DRAWING THE ROOM</strong></h4>
<p class="noindent">Now that we’ve created the functions for drawing objects and the player, we can add the code to draw the room. The new <code>draw()</code> function in <a href="ch08.xhtml#ch08list5">Listing 8-5</a> adds shadows for scenery and the player, and fixes the visual glitches we saw previously.</p>
<p class="indent">Add the new code at the end of the <code>DISPLAY</code> section, save your program as <em>listing8-5.py</em>, and run it using <span class="codestrong">pgzrun listing8-5.py</span>. As if you’ve flicked the lights on, the shadows appear in front of the objects. The game won’t look quite right yet because all the rooms will be drawn in the top left of the window, and sometimes a room won’t be cleared properly when you leave it. We’ll fix this in a moment. At this point, you shouldn’t see any error messages.</p>
<p class="margin"><em>listing8-5.py</em></p>
<pre>   <span class="gray">--<span class="codeitalic1">snip</span>--</span><br/><br/>   <span class="gray">def draw_player():</span><br/>       <span class="gray">player_image = PLAYER[player_direction][player_frame]</span><br/>       <span class="gray">draw_image(player_image, player_y + player_offset_y,</span><br/>                  <span class="gray">player_x + player_offset_x)</span><br/>       <span class="gray">player_image_shadow = PLAYER_SHADOW[player_direction][player_frame]</span><br/>       <span class="gray">draw_shadow(player_image_shadow, player_y + player_offset_y,</span><br/>                   <span class="gray">player_x + player_offset_x)</span><br/>   <span class="orange">def</span> <span class="blue">draw</span>():<br/>       <span class="orange">if</span> game_over:<br/>           <span class="orange">return</span><br/><br/><span class="ent">➊</span>     <span class="red"># Clear the game arena area.</span><br/>       box = Rect((0, 150), (800, 600))<br/>       screen.draw.filled_rect(box, RED)<br/>       box = Rect ((0, 0), (800, top_left_y + (room_height - 1)*30))<br/><br/><span epub:type="pagebreak" id="page_137"/><span class="ent">➋</span>     screen.surface.set_clip(box)<br/>       floor_type = get_floor_type()<br/><br/><span class="ent">➌</span>     <span class="orange">for</span> y <span class="orange">in</span> <span class="purple">range</span>(room_height): <span class="red"># Lay down floor tiles, then items on floor.</span><br/>           <span class="orange">for</span> x <span class="orange">in</span> <span class="purple">range</span>(room_width):<br/>               draw_image(objects[floor_type][0], y, x)<br/>               <span class="red"># Next line enables shadows to fall on top of objects on floor</span><br/>               <span class="orange">if</span> room_map[y][x] <span class="orange">in</span> items_player_may_stand_on:<br/>                   draw_image(objects[room_map[y][x]][0], y, x)<br/><br/><span class="ent">➍</span>     <span class="red"># Pressure pad in room 26 is added here, so props can go on top of it.</span><br/>       <span class="orange">if</span> current_room == 26:<br/>           draw_image(objects[39][0], 8, 2)<br/>           image_on_pad = room_map[8][2]<br/>           <span class="orange">if</span> image_on_pad &gt; 0:<br/>               draw_image(objects[image_on_pad][0], 8, 2)<br/><br/><span class="ent">➎</span>     <span class="orange">for</span> y <span class="orange">in</span> <span class="purple">range</span>(room_height):<br/>           <span class="orange">for</span> x <span class="orange">in</span> <span class="purple">range</span>(room_width):<br/>               item_here = room_map[y][x]<br/>               <span class="red"># Player cannot walk on 255: it marks spaces used by wide objects.</span><br/>               <span class="orange">if</span> item_here <span class="orange">not in</span> items_player_may_stand_on + [255]:<br/>                   image = objects[item_here][0]<br/><br/><span class="ent">➏</span>                 <span class="orange">if</span> (current_room <span class="orange">in</span> outdoor_rooms<br/>                       <span class="orange">and</span> y == room_height - 1<br/>                       <span class="orange">and</span> room_map[y][x] == 1) <span class="orange">or</span> \<br/>                       (current_room <span class="orange">not in</span> outdoor_rooms<br/>                       <span class="orange">and</span> y == room_height - 1<br/>                       <span class="orange">and</span> room_map[y][x] == 1<br/>                       <span class="orange">and</span> x &gt; 0<br/>                       <span class="orange">and</span> x &lt; room_width - 1):<br/>                       <span class="red"># Add transparent wall image in the front row.</span><br/>                       image = PILLARS[wall_transparency_frame]<br/><br/>                   draw_image(image, y, x)<br/><br/><span class="ent">➐</span>                 <span class="orange">if</span> objects[item_here][1] <span class="orange">is not None</span>: <span class="red"># If object has a shadow</span><br/>                       shadow_image = objects[item_here][1]<br/>                     <span class="red">  # if shadow might need horizontal tiling</span><br/><span class="ent">➑</span>                     <span class="orange">if</span> shadow_image <span class="orange">in</span> [images.half_shadow,<br/>                                           images.full_shadow]:<br/>                           shadow_width = <span class="purple">int</span>(image.get_width() / TILE_SIZE)<br/>                     <span class="red">      # Use shadow across width of object.</span><br/>                           <span class="orange">for</span> z in <span class="purple">range</span>(0, shadow_width):<br/>                               draw_shadow(shadow_image, y, x+z)<br/>                       <span class="orange">else</span>:<br/>                           draw_shadow(shadow_image, y, x)<br/><br/><span class="ent">➒</span>         <span class="orange">if</span> (player_y == y):<br/>                   draw_player()<br/><br/><span class="ent">➓</span>     screen.surface.set_clip(<span class="orange">None</span>)<br/><br/><span epub:type="pagebreak" id="page_138"/>   <span class="gray">###############</span><br/>   <span class="gray">##   START   ##</span><br/>   <span class="gray">###############</span><br/><br/>   <span class="gray">clock.schedule_interval(game_loop, 0.03)</span><br/>   <span class="gray">generate_map()</span></pre>
<p class="listing" id="ch08list5"><em>Listing 8-5: The new</em> <span class="codeitalic">draw()</span> <em>function</em></p>
<p class="indent">As with the movement code in <a href="ch07.xhtml#ch07">Chapter 7</a>, you don’t need to know how the <code>draw()</code> function works, even if you want to customize the program. I will explain the <code>draw()</code> function in the next section, so if you don’t want to know how it works just yet, skip to “<a href="ch08.xhtml#lev112">Positioning the Room on Your Screen</a>” on <a href="ch08.xhtml#page_141">page 141</a>.</p>
<h4 class="h4" id="lev107"><strong>UNDERSTANDING THE NEW DRAW() FUNCTION</strong></h4>
<p class="noindent">You can think of the new <code>draw()</code> function as a more elaborate version of the code used for the <code>EXPLORER</code> section previously. I’ll give you an overview of how each bit works.</p>
<h5 class="h5" id="lev108"><strong>Clearing the Game Arena</strong></h5>
<p class="noindent">The program starts by clearing the game arena <span class="ent">➊</span> where the space station will be drawn. It does this by drawing a big red rectangle, wiping out the previous screen display. The areas at the top and the bottom that give the player information are separate, so they’re not changed.</p>
<p class="indent">There are two steps for putting a rectangle on the screen. First, you create the shape using a Pygame object called a <em>Rect</em>, which works like this (don’t type this in):</p>
<pre>box = Rect((<span class="codeitalic1">left position</span>, <span class="codeitalic1">top position</span>), (<span class="codeitalic1">width</span>, <span class="codeitalic1">height</span>))</pre>
<p class="indent">The name can be almost anything you like, but I use the name <code>box</code> in my programs. The position and size are tuples, so they have parentheses around them.</p>
<p class="indent">Second, you draw the Rect you created on the screen by using an instruction like this (again, don’t type this in):</p>
<pre>screen.draw.filled_rect(box, <span class="codeitalic1">color</span>)</pre>
<p class="indent">The first item in parentheses is the <code>box</code> Rect you previously created. The second item is the color of the rectangle you want to draw. This can be a tuple of the red, green, and blue numbers that make up the number. In <a href="ch08.xhtml#ch08list5">Listing 8-5</a>, I’ve used the name <code>RED</code>, which we set up in the <code>VARIABLES</code> section earlier.</p>
<p class="indent">You can also use a Rect shape to create a <em>clipping area</em> <span class="ent">➋</span>. This is like an invisible window through which you view the screen. If the program draws <span epub:type="pagebreak" id="page_139"/>something outside the window, it can’t be seen. I’ve set up a clipping area that’s the height of the room to stop the player’s shadow from spilling out of the bottom of the game when they’re in the front doorway.</p>
<h5 class="h5" id="lev109"><strong>Drawing the Room</strong></h5>
<p class="noindent">The room is drawn in two stages. First, the program draws the floor tiles and anything that the player can walk on <span class="ent">➌</span>. Drawing them first enables scenery, the player, and shadows to be drawn on top of them. This solves the problem of black holes appearing under scenery, because there will be floor tiles in those spaces before the scenery is drawn on top.</p>
<p class="indent">Second, the program adds the scenery in the room, including its shadows <span class="ent">➎</span>, using new loops. Because this is drawn after the floor for the whole room has been drawn, the shadows will be drawn on top of floor tiles and items on the floor. The shadows are transparent, so you can still see the object underneath the shadow. The scenery drawing loops also add transparent walls <span class="ent">➏</span> and draw the player on top of the floor <span class="ent">➒</span>.</p>
<p class="indent">As always, the room is drawn from back to front to ensure that objects near the front of the room appear to be in front of objects near the back.</p>
<p class="indent">We’ve also added a small chunk of code for a special object that’s only used in one place in the game. Room 26 has a pressure pad on the floor that you might want to drop things on when you’re playing the game (maybe heavy things or things you can make heavy . . .). The special code here ensures that both the floor pad and the object on it are visible.</p>
<p class="indent">After the floor tiles have been drawn, the <code>draw()</code> function checks whether the current room is room 26: if it is, it draws the floor pad and then any object that is on top of it <span class="ent">➍</span>.</p>
<div class="note">
<p class="notet"><strong><span class="notes">RED ALERT</span></strong></p>
<p class="notep"><em>If you’re customizing the game with your own map, delete this piece of code to remove the floor pad from the game. Start with the comment line</em> <span class="ent">➍</span><em>, and remove the instructions down to (and including) the</em> <span class="codeitalic">draw_image(objects[image_on_pad][0], 8, 2)</span> <em>instruction.</em></p>
</div>
<h5 class="h5" id="lev110"><strong>Making the Front Wall Transparent</strong></h5>
<p class="noindent">When the program is drawing the front row of the room (when the <code>y</code> loop equals <code>room_height - 1)</code>, it checks whether it needs to draw a semitransparent wall instead of the solid wall object taken from the room map <span class="ent">➏</span>. The semitransparent wall is used if the player is standing behind it (see <a href="ch08.xhtml#ch08fig3">Figure 8-3</a>).</p>
<p class="indent">On the planet surface, the program makes the whole wall transparent. Inside the space station, a transparent wall panel is used only if it’s <em>not</em> in one of the bottom corner positions (see <a href="ch08.xhtml#ch08fig3">Figure 8-3</a>). The corners always use a solid wall panel. The reason is that it looks odd if you see the solid edge wall start in the second row from the bottom.</p>
<p class="indent">Later on, we’ll add the code to animate the transparency on the wall, by changing the number in <code>wall_transparency_frame</code>. You won’t see the semitransparent wall yet in the game.</p>
<div class="image"><span epub:type="pagebreak" id="page_140"/><a id="ch08fig3"/><img src="../images/fig8-3.jpg" alt="image"/></div>
<p class="figcap"><em>Figure 8-3: The transparent wall at the front of the room, as seen in the final game</em></p>
<h5 class="h5" id="lev111"><strong>Adding Shadows</strong></h5>
<p class="noindent">If an object has a shadow, the shadow is taken from the <code>objects</code> dictionary and put into <code>shadow_image</code> <span class="ent">➐</span>. Then the program checks whether it should use <code>half_shadow</code> or <code>full_shadow</code>, which fill half a tile or a whole tile respectively. These two standard shadows are used with blocky items (such as electrical units and walls) that don’t need a distinctive shadow outline. The program checks whether the <code>shadow_image</code> is in a list that contains those two standard images <span class="ent">➑</span>.</p>
<p class="indent">That’s a simple, and easy-to-read, way to check whether <code>shadow_image</code> is one of two things. If you’re checking for three or more things, this technique can make the program much easier to read than having lots of <code>if</code> comparisons using <code>==</code> and combining them with <code>or</code>.</p>
<p class="indent">If the shadow is one of the standard images, the program then works out how wide the shadow should be in tiles. That is calculated by taking the width of the object casting the shadow and dividing it by the width of a tile (30 pixels). For example, an image that is 90 pixels wide will be 3 tiles wide.</p>
<p class="indent">The program then creates a loop to draw the standard shadow images, using the variable <code>z</code>. It starts at 0 and runs until the width of the shadow minus 1. That’s because a <code>range</code> leaves out the last item: <code>range(0, 3)</code> would give us the numbers 0, 1, and 2. The <code>z</code> values are added to the <em>x</em> position from the main loop and are used to draw the shadow tiles. <a href="ch08.xhtml#ch08fig4">Figure 8-4</a> shows an object with a width of 3 tiles. The <code>z</code> loop takes the values 0, 1, and 2 to add the shadow in the correct place.</p>
<p class="indent">By drawing the player in position after the floor has been laid, we make sure the astronaut’s legs don’t disappear when walking up the screen <span class="ent">➒</span>.</p>
<div class="image"><a id="ch08fig4"/><img src="../images/fig8-4.jpg" alt="image"/></div>
<p class="figcap"><em>Figure 8-4: An object that is 3 tiles wide could have a standard shadow below it that is used three times.</em></p>
<p class="indent"><span epub:type="pagebreak" id="page_141"/>The <code>draw()</code> function ends by turning off the clipping area that stopped shadows from spilling out of the bottom of the game area <span class="ent">➓</span>.</p>
<h3 class="h3" id="lev112"><strong>POSITIONING THE ROOM ON YOUR SCREEN</strong></h3>
<p class="noindent">Now let’s fix the problem of the room appearing in the top left of your screen. The program uses two variables to position the room: <code>top_left_x</code> and <code>top_left_y</code>. At the moment, these are set to 100 and 150, which means the room is always drawn in the top left of the window. We’ll add some code that will change these variables depending on the size of the room so the room is drawn in the middle of the window (see <a href="ch08.xhtml#ch08fig5">Figure 8-5</a>). The screen layout will look better, and it will make the game easier to play too.</p>
<div class="image"><a id="ch08fig5"/><img src="../images/fig8-5.jpg" alt="image"/></div>
<p class="figcap"><em>Figure 8-5: A room centered in the window</em></p>
<p class="indent">Add the new lines shown in <a href="ch08.xhtml#ch08list6">Listing 8-6</a> to the end of the <code>generate_map()</code> function, which is in the <code>MAKE MAP</code> section of the program. Because they’re inside a function, you need to indent each line by four spaces.</p>
<p class="indent">Save the program as <em>listing8-6.py</em> and run it using <span class="codestrong">pgzrun listing8-6.py</span>. As <a href="ch08.xhtml#ch08fig5">Figure 8-5</a> shows, each room should be centered on the screen now.</p>
<p class="margin"><em>listing8-6.py</em></p>
<pre>   <span class="gray">--<span class="codeitalic1">snip</span>--</span><br/><br/>   <span class="gray">def generate_map():</span><br/><br/><span epub:type="pagebreak" id="page_142"/>   <span class="gray">--<span class="codeitalic1">snip</span>--</span><br/><br/>               <span class="gray">for tile_number in range(1, image_width_in_tiles):</span><br/>                  <span class="gray"> room_map[scenery_y][scenery_x + tile_number] = 255</span><br/><br/><span class="ent">➊</span>     center_y = <span class="purple">int</span>(HEIGHT / 2) <span class="red"># Center of game window</span><br/><span class="ent">➋</span>     center_x = <span class="purple">int</span>(WIDTH / 2)<br/><span class="ent">➌</span>     room_pixel_width = room_width * TILE_SIZE <span class="red"># Size of room in pixels</span><br/><span class="ent">➍</span>     room_pixel_height = room_height * TILE_SIZE<br/><span class="ent">➎</span>     top_left_x = center_x - 0.5 * room_pixel_width<br/><span class="ent">➏</span>     top_left_y = (center_y - 0.5 * room_pixel_height) + 110</pre>
<p class="listing" id="ch08list6"><em>Listing 8-6: Creating variables to put the room in the middle of the game window</em></p>
<p class="indent">These instructions are inside the <code>generate_map()</code> function, which sets up the <code>room_map</code> list for each room when the player enters it. The <code>generate_map()</code> function now also sets up the <code>top_left_x</code> and <code>top_left_y</code> variables that remember where the room should be drawn in the window.</p>
<p class="indent">The new code in <a href="ch08.xhtml#ch08list6">Listing 8-6</a> starts by working out where the middle of the window is. The <code>HEIGHT</code> and <code>WIDTH</code> variables store the window’s size in pixels. Dividing them by 2 gives us the coordinates of the center of the window. We store these in the <code>center_y</code> <span class="ent">➊</span> and <code>center_x</code> <span class="ent">➋</span> variables.</p>
<p class="indent">The program then works out how wide the image of the room is in pixels <span class="ent">➌</span>. That will be the width of the room in tiles multiplied by the size of a tile. The result is stored in <code>room_pixel_width</code>. A similar calculation is done for the room height <span class="ent">➍</span>.</p>
<p class="indent">To put the room image in the middle of the room, we want half the room to be to the left of the center line and half to the right. So we subtract half the room width in pixels from the center line <span class="ent">➎</span> and start drawing the room there.</p>
<p class="indent">A similar calculation is used for <code>top_left_y</code> except we add 110 to the result <span class="ent">➏</span>. We need to add 110 because our final screen layout will use an area at the top of the screen as an information panel. We nudge the room image down a bit to make room for the panel.</p>
<h3 class="h3" id="lev113"><strong>MAKING THE FRONT WALL FADE IN AND OUT</strong></h3>
<p class="noindent">At this point, there are some dead spots in the game where the player can’t be seen. In the middle of the room, we can avoid that by making sure objects are not so tall that they obstruct the player. We need a tall wall at the front of the room, though.</p>
<p class="indent">Blocking the player with a wall at the front of the room can cause all sorts of problems: if you drop something, you won’t be able to find it, or if something is hurting you, you won’t be able to see it! The solution is to make the wall fade away when the player approaches it.</p>
<p class="indent">The <code>draw()</code> function already draws the front wall pillars using animation frames. The wall animation has five frames (numbered from 0 to 4) in the <code>PILLARS</code> list. The first frame is the solid wall, and the last frame shows the wall at its most translucent (see <a href="ch08.xhtml#ch08tab2">Table 8-2</a>). As the animation frame number <span epub:type="pagebreak" id="page_143"/>increases, the wall becomes more transparent. The current frame is stored in the variable <code>wall_transparency_frame</code>.</p>
<p class="indent">Because of the way the transparency works in the images, when the transparent wall is drawn on top of the player, the player can be seen through it.</p>
<p class="tabcap" id="ch08tab2"><strong>Table 8-2:</strong> The Animation Frames for the Front Wall</p>
<table class="topbot-d">
<thead>
<tr>
<td style="vertical-align: top;" class="table-h"><p class="tab_th"><strong>Frame number</strong></p></td>
<td style="vertical-align: top;" class="table-h"><p class="tab_th"><strong>0</strong></p></td>
<td style="vertical-align: top;" class="table-h"><p class="tab_th"><strong>1</strong></p></td>
<td style="vertical-align: top;" class="table-h"><p class="tab_th"><strong>2</strong></p></td>
<td style="vertical-align: top;" class="table-h"><p class="tab_th"><strong>3</strong></p></td>
<td style="vertical-align: top;" class="table-h"><p class="tab_th"><strong>4</strong></p></td>
</tr>
</thead>
<tbody>
<tr>
<td style="vertical-align: top;" class="table-ba"><p class="taba">Image</p></td>
<td style="vertical-align: top;" class="table-ba"><p class="taba"><img src="../images/f0143-01.jpg" alt="image"/></p></td>
<td style="vertical-align: top;" class="table-ba"><p class="taba"><img src="../images/f0143-02.jpg" alt="image"/></p></td>
<td style="vertical-align: top;" class="table-ba"><p class="taba"><img src="../images/f0143-03.jpg" alt="image"/></p></td>
<td style="vertical-align: top;" class="table-ba"><p class="taba"><img src="../images/f0143-04.jpg" alt="image"/></p></td>
<td style="vertical-align: top;" class="table-ba"><p class="taba"><img src="../images/f0143-05.jpg" alt="image"/></p></td>
</tr>
</tbody>
</table>
<p class="indent"><a href="ch08.xhtml#ch08list7">Listing 8-7</a> shows the new function called <code>adjust_wall_transparency()</code>, which will fade the wall in and out. Add it at the end of the <code>DISPLAY</code> section, after the <code>draw()</code> function you just completed, and before the <code>START</code> section. You also need to add a line at the end of the program, outside the function, which will schedule it to run regularly. This line is also in <a href="ch08.xhtml#ch08list7">Listing 8-7</a>.</p>
<p class="indent">Save your updated program as <em>listing8-7.py</em> and run it using <span class="codestrong">pgzrun listing8-7.py</span>. If you walk behind the front wall, it now fades to transparent so you can be seen through it (see <a href="ch08.xhtml#ch08fig3">Figure 8-3</a> earlier in this chapter). When you walk away again, the wall changes back to being solid again.</p>
<p class="margin"><em>listing8-7.py</em></p>
<pre>   <span class="gray">--<span class="codeitalic1">snip</span>--</span><br/><br/>   <span class="gray">###############</span><br/>   <span class="gray">##  DISPLAY  ##</span><br/>   <span class="gray">###############</span><br/><br/>   <span class="gray">--<span class="codeitalic1">snip</span>--</span><br/><br/>       <span class="gray">screen.surface.set_clip(None)</span><br/><br/>   <span class="orange">def</span> <span class="blue">adjust_wall_transparency</span>():<br/>       <span class="orange">global</span> wall_transparency_frame<br/><br/><span class="ent">➊</span>     <span class="orange">if</span> (player_y == room_height - 2<br/><span class="ent">➋</span>         <span class="orange">and</span> room_map[room_height - 1][player_x] == 1<br/><span class="ent">➌</span>         <span class="orange">and</span> wall_transparency_frame &lt; 4):  <br/><span class="ent">➍</span>         wall_transparency_frame += 1 <span class="red"># Fade wall out.</span><br/><br/><span class="ent">➎</span>     <span class="orange">if</span> ((player_y &lt; room_height - 2<br/><span class="ent">➏</span>             <span class="orange">or</span> room_map[room_height - 1][player_x] != 1)<br/><span class="ent">➐</span>             <span class="orange">and</span> wall_transparency_frame &gt; 0):<br/><span class="ent">➑</span>         wall_transparency_frame -= 1 <span class="red"># Fade wall in.</span><br/><br/><span epub:type="pagebreak" id="page_144"/>   <span class="gray">###############</span><br/>   <span class="gray">##   START   ##</span><br/>   <span class="gray">###############</span><br/><br/>   <span class="gray">clock.schedule_interval(game_loop, 0.03)</span><br/>   <span class="gray">generate_map()</span><br/><span class="ent">➒</span> clock.schedule_interval(adjust_wall_transparency, 0.05)</pre>
<p class="listing" id="ch08list7"><em>Listing 8-7: Making the front wall see-through when you approach it</em></p>
<p class="indent">The final line we added in <a href="ch08.xhtml#ch08list7">Listing 8-7</a> makes the function <code>adjust_wall_</code><code>transparency()</code> run once every 0.05 seconds <span class="ent">➒</span>. This makes the wall fade in or out as necessary as the player walks around the room.</p>
<p class="indent">Let’s see how this new function works. If the player is standing behind the wall, the following two statements are true:</p>
<ul>
<li class="noindent">Their <em>y</em> position will be equal to <code>room_height - 2</code> <span class="ent">➊</span>. As <a href="ch08.xhtml#ch08fig6">Figure 8-6</a> shows, the bottom row of the map is <code>room_height - 1</code>. So we check whether the player is in the row above that.</li>
<li class="noindent">There is a piece of wall in the bottom row of the room that is in line with the player’s <em>x</em> position <span class="ent">➋</span>. In <a href="ch08.xhtml#ch08fig6">Figure 8-6</a>, the red square marks a position where we can’t see the player. The bottom row in front of them contains a 1 for the wall. The green square shows where we can see the player, because they’re in the doorway. Here, the bottom row of the room map contains a 0.</li>
</ul>
<div class="image"><a id="ch08fig6"/><img src="../images/fig8-6.jpg" alt="image"/></div>
<p class="figcap"><em>Figure 8-6: Working out whether the player is behind the wall</em></p>
<p class="indent"><span epub:type="pagebreak" id="page_145"/>If the player is behind the wall <span class="ent">➊</span> <span class="ent">➋</span> and the wall transparency is not set to maximum <span class="ent">➌</span>, the wall transparency is increased by 1 <span class="ent">➍</span>.</p>
<p class="indent">If either of the following is true, it means the player <em>isn’t</em> hidden by the wall:</p>
<ul>
<li class="noindent">Their <em>y</em> position is less than <code>room_height - 2</code> <span class="ent">➎</span>. The player can be seen, at least in part, if they’re farther back in the room.</li>
<li class="noindent">There is not a piece of wall in the bottom row of the room in line with their <em>x</em> position <span class="ent">➏</span>.</li>
</ul>
<p class="indent">In these cases, if the wall transparency is set to more than the minimum <span class="ent">➐</span>, it’s reduced by one <span class="ent">➑</span>.</p>
<p class="indent">The <code>draw()</code> function uses the value of <code>wall_transparency_frame</code> to work out which image from the animation frames in the <code>PILLARS</code> list to use in the front row.</p>
<p class="indent">The effect is that the wall gradually fades in and out, depending on whether the player is behind it or not. This fading happens fast enough that players won’t be delayed by it but not so fast that it vanishes instantly, which would be distracting.</p>
<h3 class="h3" id="lev114"><strong>DISPLAYING HINTS, TIPS, AND WARNINGS</strong></h3>
<p class="noindent">There are times when the <em>Escape</em> game uses text to tell you what’s going on. For example, it might use text to tell you what happens when you do something with an object, or provide a description of it.</p>
<p class="indent">The final function in the <code>DISPLAY</code> section of the program writes messages at the top of the game window. There are two lines of text:</p>
<ul>
<li class="noindent">The first line, positioned at 15 pixels from the top of the window, tells players about what they’re doing. For example, it displays object descriptions and tells them what happens when they use the objects.</li>
<li class="noindent">The second line, positioned at 50 pixels from the top of the window, is for important messages.</li>
</ul>
<p class="indent">The lines of text are separated like this so important messages don’t get covered up by less important messages. If the game needs to tell you about a life-threatening situation, you don’t want that message to be replaced with one that tells you about the new room you’ve entered!</p>
<p class="noindent">Add the new code in <a href="ch08.xhtml#ch08list8">Listing 8-8</a> to the end of the <code>DISPLAY</code> section, after where you added the wall transparency code in <a href="ch08.xhtml#ch08list7">Listing 8-7</a>. Save the listing as <em>listing8-8.py</em>. You can test it by running it with <span class="codestrong">pgzrun listing8-8.py</span>, but you won’t see any difference yet. In a moment, we’ll add some instructions to use this new <code>show_text()</code> function.</p>
<p class="margin"><span epub:type="pagebreak" id="page_146"/><em>listing8-8.py</em></p>
<pre>   <span class="gray">--<span class="codeitalic1">snip</span>--</span><br/><br/>       <span class="gray">if ((player_y &lt; room_height - 2</span><br/>               <span class="gray">or room_map[room_height - 1][player_x] != 1)</span><br/>               <span class="gray">and wall_transparency_frame &gt; 0):</span><br/>           <span class="gray">wall_transparency_frame -= 1 # Fade wall in.</span><br/><br/><span class="ent">➊</span> <span class="orange">def</span> <span class="blue">show_text</span>(text_to_show, line_number):<br/>       <span class="orange">if</span> game_over:<br/>          <span class="orange"> return</span><br/><span class="ent">➋</span>     text_lines = [15, 50]<br/><span class="ent">➌</span>     box = Rect((0, text_lines[line_number]), (800, 35))<br/><span class="ent">➍</span>     screen.draw.filled_rect(box, BLACK)<br/><span class="ent">➎</span>     screen.draw.text(text_to_show,<br/>                        (20, text_lines[line_number]), color=GREEN)<br/><br/>   <span class="gray">###############</span><br/>   <span class="gray">##   START   ##</span><br/>   <span class="gray">###############</span><br/><br/>   <span class="gray">--<span class="codeitalic1">snip</span>--</span></pre>
<p class="listing" id="ch08list8"><em>Listing 8-8: Adding the text display function</em></p>
<p class="indent">We’ll use the <code>show_text()</code> <span class="ent">➊</span> function like this (don’t type this in):</p>
<pre>show_text(<span class="green">"</span><span class="green">message</span><span class="green">"</span>, <span class="codeitalic1">line number</span>)</pre>
<p class="indent">The line number will be either 0 for the top row or 1 for the second row, which is reserved for important messages. At the start of the function, the message is put into the variable <code>text_to_show</code> and the row number goes into <code>line_number</code> <span class="ent">➊</span>.</p>
<p class="indent">We use a list called <code>text_lines</code> to remember the vertical positions (in pixels) of the two lines of text <span class="ent">➋</span>. We also define a box <span class="ent">➌</span> and fill it with black <span class="ent">➍</span>, to clear the row of text before the new message is drawn.</p>
<p class="indent">Finally, we use the <code>screen.draw.text()</code> function in Pygame Zero to put the text on the screen <span class="ent">➎</span>. This function takes the text, the text’s <em>x</em> and <em>y</em> position, and the text color. The position numbers go inside parentheses (they make up a tuple).</p>
<p class="indent">In <a href="ch08.xhtml#ch08list8">Listing 8-8</a> <span class="ent">➎</span>, the <em>x</em> position is 20 pixels from the left, and the vertical position is taken from the <code>text_lines</code> list, using the number in <code>line_number</code> as the list index.</p>
<h3 class="h3" id="lev115"><strong>SHOWING THE ROOM NAME WHEN YOU ENTER THE ROOM</strong></h3>
<p class="noindent">To test the <code>show_text()</code> function, let’s add the <code>start_room()</code> function, which displays the name of the room when you walk into it. <span epub:type="pagebreak" id="page_147"/>Put this function in the <code>GAME LOOP</code> section before the <code>game_loop()</code> function, as shown in <a href="ch08.xhtml#ch08list9">Listing 8-9</a>. Save your program as <em>listing8-9.py</em>. When you run it, you won’t see anything new yet.</p>
<p class="margin"><em>listing8-9.py</em></p>
<pre><span class="gray">--<span class="codeitalic1">snip</span>--</span><br/><br/><span class="gray">###############</span><br/><span class="gray">## GAME LOOP ##</span><br/><span class="gray">###############</span><br/><br/><span class="orange">def</span> <span class="blue">start_room</span>():<br/>    show_text(<span class="green">"You are here: "</span> + room_name, 0)<br/><br/><span class="gray">def game_loop():</span><br/><span class="gray">--<span class="codeitalic1">snip</span>--</span></pre>
<p class="listing" id="ch08list9"><em>Listing 8-9: Adding the</em> <span class="codeitalic">start_room()</span> <em>function</em></p>
<p class="indent">This function uses the <code>room_name</code> variable, which we set up in the <code>generate_map</code><code>()</code> function. It contains the name of the current room, taken from the <code>GAME_MAP</code> list. The room name is combined with the text <code>"You are here: "</code> and is sent to the <code>show_text()</code> function.</p>
<p class="indent">Now we need to set our new <code>start_room()</code> function to run whenever the player enters a new room. We included the code to do this in <a href="ch07.xhtml#ch07list6">Listing 7-6</a> in <a href="ch07.xhtml#ch07">Chapter 7</a>, but we commented it out. Now we’re ready for it! Anywhere we have the code <code>#start_room()</code> we want to replace it with <code>start_room()</code>. That <code>#</code> is working as an “off switch,” telling Python to ignore the instruction. To turn the instruction on, we remove the <code>#</code> sign.</p>
<p class="indent">Rather than manually finding all the lines that need to change, we’ll get IDLE to do it for us. Follow these steps, and refer to <a href="ch08.xhtml#ch08fig7">Figure 8-7</a>:</p>
<ol>
<li class="noindent">Click <strong>Edit</strong> <span class="ent">▸</span> <strong>Replace</strong> (or press <small>CTRL</small>-H) in IDLE to show the replace text dialog box.</li>
<li class="noindent">Enter <span class="codestrong">#start_room()</span> into the Find box.</li>
<li class="noindent">Enter <span class="codestrong">start_room()</span> into the Replace With box.</li>
<li class="noindent">Click <strong>Replace All</strong>.</li>
</ol>
<div class="image"><a id="ch08fig7"/><img src="../images/fig8-7.jpg" alt="image"/></div>
<p class="figcap"><em>Figure 8-7: Enabling the</em> <span class="codeitalic">start_room()</span> <em>function when the player enters a new room</em></p>
<p class="indent"><span epub:type="pagebreak" id="page_148"/>IDLE should replace the instruction in four places and will jump to the last one in the listing, as shown in <a href="ch08.xhtml#ch08list10">Listing 8-10</a> (there’s no need to type this listing in).</p>
<p class="indent">Save the listing as <em>listing8-10.py</em> and run the program using <span class="codestrong">pgzrun listing8-10.py</span>. A message should appear announcing each new room as you enter it. It’s triggered by walking through the door, so it doesn’t work in the first room.</p>
<p class="margin"><em>listing8-10.py</em></p>
<pre><span class="gray">--<span class="codeitalic1">snip</span>--</span><br/>    <span class="gray">if player_y == -1: # through door at TOP</span><br/>        <span class="gray">#clock.unschedule(hazard_move)</span><br/>        <span class="gray">current_room -= MAP_WIDTH</span><br/>        <span class="gray">generate_map()</span><br/>        <span class="gray">player_y = room_height - 1 # enter at bottom</span><br/>        <span class="gray">player_x = int(room_width / 2) # enter at door</span><br/>        <span class="gray">player_frame = 0</span><br/>        start_room()<br/>        <span class="gray">return</span><br/><span class="gray">--<span class="codeitalic1">snip</span>--</span></pre>
<p class="listing" id="ch08list10"><em>Listing 8-10: Enabling the</em> <span class="codeitalic">start_room()</span> <em>function when the player leaves the room</em></p>
<p class="indent">This completes the <code>DISPLAY</code> section of the <em>Escape</em> game! We’ll make a few small changes later to show enemies, but otherwise we’ve laid the foundation for the rest of the game.</p>
<p class="indent">In the next chapter, we’ll start unpacking your personal effects as we add props to the game.</p>
<h3 class="h3" id="lev116"><strong>ARE YOU FIT TO FLY?</strong></h3>
<p class="noindentb">Check the following boxes to confirm that you’ve learned the key lessons in this chapter.</p>
<p class="square"><img src="../images/box.jpg" alt="Images"/>  A piece of information sent to a function is called an <em>argument</em>.</p>
<p class="square"><img src="../images/box.jpg" alt="Images"/>  To send information to a function, you put it between the parentheses after the function name. You can send several arguments if you separate them with commas. For example: <code>add(5, 7)</code>.</p>
<p class="square"><img src="../images/box.jpg" alt="Images"/>  To enable a function to accept information, you set up local variables to receive the arguments when you define the function.</p>
<p class="square"><img src="../images/box.jpg" alt="Images"/>  The <code>DISPLAY</code> section of the program draws the room, animates the transparent wall, and displays text messages.</p>
<p class="square"><img src="../images/box.jpg" alt="Images"/>  The <code>show_text()</code> function takes two arguments: the string you want to display and the row number (0 or 1). Row 1 is reserved for important messages.</p>
<p class="square"><span epub:type="pagebreak" id="page_149"/><img src="../images/box.jpg" alt="Images"/>  You define a Rect by giving Python tuples for its position and size.</p>
<p class="square"><img src="../images/box.jpg" alt="Images"/>  The <code>screen.draw.filled_rect()</code> function draws a filled rectangle.</p>
<p class="square"><img src="../images/box.jpg" alt="Images"/>  The colors in Pygame Zero use the RGB (red, green, blue) format. For example <code>(255, 100, 0)</code> is orange: maximum red, a dash of green, and no blue.</p>
<p class="square"><img src="../images/box.jpg" alt="Images"/>  If you want to replace some code throughout the whole program, you can use the Replace All option in IDLE.</p>
<div class="image" id="ch08sb2"><img src="../images/f0149-01.jpg" alt="image"/><span epub:type="pagebreak" id="page_150"/></div>
</body></html>