<html><head></head><body><div id="sbo-rt-content"><section>
<header>
<h1 class="part">
<span class="PartNumber"><span epub:type="pagebreak" title="269" id="Page_269"/>Part IV</span><br/>
<span class="PartTitle">Going Further</span></h1>
</header>
</section>
</div>
<div id="sbo-rt-content"><section>
<header>
<h1 class="chapter">
<span class="ChapterNumber"><span epub:type="pagebreak" title="271" id="Page_271"/>14</span><br/>
<span class="ChapterTitle">Financial Applications </span></h1>
</header>
<figure class="opener">
<img src="Images/chapterart.png" alt="" width="200" height="200"/>
</figure>
<p class="ChapterIntro">The speech recognition and text-to-speech techniques can be applied to many aspects of life. In this chapter, we’ll focus on tracking the financial markets, but the techniques you learn here can be easily generalized and applied to your own area of interest, whatever that may be. </p>
<p>You’ll build three projects in this chapter: an app that reports the up-to-date stock price of any publicly traded company; a script that builds visualizations of stock prices; and an app that uses recent daily stock prices to calculate returns, run regressions, and perform detailed analyses.</p>
<p>As always, all scripts are available through the book’s resources page at <a href="https://www.nostarch.com/make-python-talk/" class="LinkURL">https://www.nostarch.com/make-python-talk/</a>. Start by creating the folder <em>/mpt/ch14/ </em>for this chapter.</p>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="box">
<h2><span epub:type="pagebreak" title="272" id="Page_272"/>New Skills </h2>
<ul>
<li>Retrieving real-time and daily stock price information</li>
<li>Learning about JSON data, including how to reformat it into a readable form and import it to Python</li>
<li>Automating the process of obtaining a stock ticker symbol based on the company name</li>
<li>Visualizing financial data with plots and charts</li>
<li>Performing regression analyses and interpreting results</li>
</ul>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<h2 id="h1-501560c14-0001">	Python, What’s the Facebook Stock Price?</h2>
<p class="BodyFirst">In this project, you’ll use the <em>yahoo_fin</em> package to obtain real-time price information based on the ticker symbol of a stock. A <em>ticker symbol</em> is a sequence of characters, or code, used to uniquely identify a stock. Most people will not know a company’s associated ticker symbol. </p>
<p>This provides the opportunity to work backward. You’ll learn to scrape the web to get a stock’s ticker symbol from the company name. When you enter the name of a firm into the script, Python will tell you the ticker symbol of the firm’s stock. Finally, you’ll add the text-to-speech and speech recognition features.</p>
<h3 id="h2-501560c14-0001">Obtain the Latest Stock Price</h3>
<p class="BodyFirst">The <em>yahoo_fin</em> package lets you obtain the latest stock price information from Yahoo! Finance. This package isn’t in the Python standard library, so you need to <code>pip</code> <code>install</code> it first. </p>
<p>Open your Anaconda prompt (in Windows) or a terminal (in Mac or Linux), activate the virtual environment <em>chatting</em>, and run the following command (note the underscore in the middle of the package name):</p>
<pre><code><b>pip install yahoo_fin</b></code></pre>
<p>Next, open your Spyder editor and save <a href="#listing14-1" id="listinganchor14-1">Listing 14-1</a> as <em>live_price.py</em> in your chapter folder. To use this script, you need to find the ticker symbol for the stock you’re interested in beforehand. </p>
<pre><code>from yahoo_fin import stock_info as si

# Start an infinite loop
<span class="CodeAnnotationHang" aria-label="annotation1">1</span> while True:
    # Obtain ticker symbol from you
<span epub:type="pagebreak" title="273" id="Page_273"/>    ticker = input("Which stock (ticker symbol) are you looking for?\n")
    # If you want to stop, type in "done"
  <span class="CodeAnnotationCode" aria-label="annotation2">2</span> if ticker == "done":
        break
    # Otherwise, type in a stock ticker symbol
    else:
        # Obtain stock price from Yahoo!
      <span class="CodeAnnotationCode" aria-label="annotation3">3</span> price = si.get_live_price(ticker)
        # Print out the stock price
        print(f"The stock price for {ticker} is {price}.")</code></pre>
<p class="CodeListingCaption"><a id="listing14-1">Listing 14-1</a>: Retrieving real-time stock prices</p>
<p>We import the <em>stock_info</em> module from the <em>yahoo_fin</em> package under the alias <code>si</code>. We then put the script in an infinite loop <span class="CodeAnnotation" aria-label="annotation1">1</span> to continuously take your written input requesting stock ticker symbols. Whenever you want to stop the script, you can enter <code>done</code> <span class="CodeAnnotation" aria-label="annotation2">2</span>. Otherwise, the script automatically continues to obtain the latest stock price information for your requested company from Yahoo! Finance <span class="CodeAnnotation" aria-label="annotation3">3</span>. Finally, the script prints out the stock price information.</p>
<p>Here’s the output from an exchange with the script, with user input in bold:</p>
<pre><code>Which stock (ticker symbol) are you looking for?
<b>MSFT</b>
The stock price for MSFT is 183.25.

Which stock (ticker symbol) are you looking for?
<b>AAPL</b>
The stock price for AAPL is 317.94000244140625.

Which stock (ticker symbol) are you looking for?
<b>done</b></code></pre>
<p>As you can see, I entered ticker symbols for Microsoft and Apple (<code>MSFT</code> and <code>AAPL</code>, respectively), and the script returned their latest prices. </p>
<p>Notice that the price of the Apple stock has many digits after the decimal. We’ll adjust the code a little later to show only two digits after the decimal for all stock prices.</p>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="box">
<h2>Try it Out</h2>
<p class="BoxBodyFirst">Run <em>live_price.py</em> and find the stock prices for Amazon (AMZN) and Tesla (TSLA). Then go to the website <a href="https://finance.yahoo.com/" class="LinkURL">https://finance.yahoo.com/</a> to check if the prices are close to your output. </p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<p><span epub:type="pagebreak" title="274" id="Page_274"/>For the script to work, you need the company’s stock ticker symbol, such as MSFT or AAPL. You may wonder, what if I don’t know the ticker symbols of the stocks that I’m interested in? Can Python find it if I know only the company name, such as Microsoft or Apple? The answer is yes, and this is when the web-scraping skills you learned in <span class="xref" itemid="xref_target_Chapter 6">Chapter 6</span> become handy. </p>
<h3 id="h2-501560c14-0002">Find Ticker Symbols </h3>
<p class="BodyFirst">Many times, you’ll know the name of the company you’re interested in but not its ticker symbol. This script will find the ticker symbol when you enter the name of the company. This is important because our end goal is to create voice-controlled applications in the financial market. It’s relatively difficult for the Python script to pick up the ticker symbol via voice commands, but picking up the company name is much easier. </p>
<p>We need to first find a website that can reliably provide a company’s ticker symbol. We’ll use Yahoo! Finance and query the site using the URL <a href="https://query1.finance.yahoo.com/v1/finance/search?q=">https://query1.finance.yahoo.com/v1/finance/search?q=</a> followed by the name of the company you want to query. For example, if you put <em>Bank of America</em> at the end, you’ll get a set of Python-friendly data results, as shown in <a href="#figure14-1" id="figureanchor14-1">Figure 14-1</a>. </p>
<figure>
<img src="Images/f14001-r.png" alt="f14001-r" width="697" height="347"/>
<figcaption><p><a id="figure14-1">Figure 14-1</a>: Results when you search for the ticker symbol for Bank of America</p></figcaption>
</figure>
<p>This data is formatted in <em>JSON</em>, short for <em>JavaScript Object Notation</em>. This file format is used for browser-server communication that uses human-readable text to store and transmit data objects. JSON was derived from JavaScript, but it’s now a language-independent data format that’s used by many programming languages, include Python.</p>
<p>To make the JSON data easier to read, we’ll use the online JSON data formatter at <a href="https://jsonformatter.curiousconcept.com/" class="LinkURL">https://jsonformatter.curiousconcept.com/</a>. Open the URL and you’ll see a screen similar to <a href="#figure14-2" id="figureanchor14-2">Figure 14-2</a>.</p>
<span epub:type="pagebreak" title="275" id="Page_275"/><figure>
<img src="Images/f14002.png" alt="f14002" width="697" height="347"/>
<figcaption><p><a id="figure14-2">Figure 14-2</a>: A website to format JSON data</p></figcaption>
</figure>
<p>Paste the data from <a href="#figure14-1">Figure 14-1</a> into the designated space and click <b>Process</b>. The formatter will convert the data into a much more readable format, shown in <a href="#listing14-2" id="listinganchor14-2">Listing 14-2</a>.</p>
<pre><code>{
    "explains":[

    ],
    "count":18,
    "quotes":[
    {
        "exchange":"NYQ",
        "shortname":"Bank of America Corporation",
        "quoteType":"EQUITY",
      <span class="CodeAnnotationCode" aria-label="annotation1">1</span> "symbol":"BAC",
        "index":"quotes",
        "score":208707.0,
        "typeDisp":"Equity",
        "longname":"Bank of America Corporation",
        "isYahooFinance":true
      },
       {
        "exchange":"NYQ",
        "shortname":"Bank of America Corporation Non",
        "quoteType":"EQUITY",
        "symbol":"BAC-PL",
        "index":"quotes",
        "score":20322.0,
        "typeDisp":"Equity",
        "longname":"Bank of America Corporation",
        "isYahooFinance":true
      },
      {
        "exchange":"NYQ",
        "shortname":"Bank of America Corporation Dep",
<span epub:type="pagebreak" title="276" id="Page_276"/>        "quoteType":"EQUITY",
        "symbol":"BAC-PC",
        "index":"quotes",
        "score":20183.0,
        "typeDisp":"Equity",
        "longname":"Bank of America Corporation",
        "isYahooFinance":true
      },


<var>--snip--</var>
}</code></pre>
<p class="CodeListingCaption"><a id="listing14-2">Listing 14-2</a>: The formatted JSON data for the ticker symbol search</p>
<p>The dataset is a large dictionary of several elements with the key values <code>explains</code>, <code>count</code>, <code>quotes</code>, and so on. The value for the <code>quotes</code> key is a list of several dictionaries. The first dictionary contains the keys <code>exchange</code>, <code>shortname</code>, <code>quoteType</code>—and importantly, <code>symbol</code>, which contains the value <code>BAC</code>, the ticker symbol we need <span class="CodeAnnotation" aria-label="annotation1">1</span>. </p>
<p>Next, we use a Python script to extract the ticker symbol based on the preceding pattern. The script <em>get_ticker_symbol.py</em>, shown in <a href="#listing14-3" id="listinganchor14-3">Listing 14-3</a>, accomplishes that.</p>
<pre><code>import requests

# Start an infinite loop
<span class="CodeAnnotationHang" aria-label="annotation1">1</span> while True:
    # Obtain company name from you
    firm = input("Which company's ticker symbol are you looking for?\n")
    # If you want to stop, type in "done"
    if firm == "done":
        break
    # Otherwise, type in a company name
  <span class="CodeAnnotationCode" aria-label="annotation2">2</span> else:
      <span class="CodeAnnotationCode" aria-label="annotation3">3</span> try:
            # Extract the source code from the website
            url = 'https://query1.finance.yahoo.com/v1/finance/search?q='+firm
            response = requests.get(url)
            # Read the JSON data
            response_json = response.json()
            # Obtain the value corresponding to "quotes"
          <span class="CodeAnnotationCode" aria-label="annotation4">4</span> quotes = response_json['quotes']
            # Get the ticker symbol
            ticker = quotes[0]['symbol']
            # Print out the ticker
            print(f"The ticker symbol for {firm} is {ticker}.")
        except:
            print("Sorry, not a valid entry!")
        continue</code></pre>
<p class="CodeListingCaption"><a id="listing14-3">Listing 14-3</a>: Finding a stock’s ticker symbol based on the company name</p>
<p><span epub:type="pagebreak" title="277" id="Page_277"/>We import the <em>requests</em> module, which allows Python to send HyperText Transfer Protocol (HTTP) requests. At <span class="CodeAnnotation" aria-label="annotation1">1</span>, we start an infinite loop that asks for your written input in each iteration. To exit the loop, enter <code>done</code>. Otherwise, you enter in the company name <span class="CodeAnnotation" aria-label="annotation2">2</span>. We use exception handling to prevent a crash <span class="CodeAnnotation" aria-label="annotation3">3</span>.</p>
<p>We go into the JSON data and extract the list corresponding to the key <code>quotes</code> <span class="CodeAnnotation" aria-label="annotation4">4</span>. We then go to the first element and look for the value corresponding to the key <code>symbol</code>. The script prints out the ticker symbol at the IPython console. If there are no results, the script will print <code>Sorry, not a valid entry!</code>. </p>
<p>Run the script a few times and search for several companies to check that it works. The following output is one interaction with the script:</p>
<pre><code>Which company's ticker symbol are you looking for?
<b>ford motor</b>
The ticker symbol for ford motor is F.

Which company's ticker symbol are you looking for?
<b>walt disney company</b>
The ticker symbol for walt disney company is DIS.

Which company's ticker symbol are you looking for?
<b>apple</b>
The ticker symbol for apple is AAPL.

Which company's ticker symbol are you looking for?
<b>done</b></code></pre>
<p>As you can see, the script works for companies with one-word names, like Apple, as well as longer names, such as Walt Disney Company. </p>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="box">
<h2>Try it Out</h2>
<p class="BoxBodyFirst">Use <em>get_ticker_symbol.py</em> to find the ticker symbols for General Motors and Procter &amp; Gamble.</p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<h3 id="h2-501560c14-0003">Retrieve Stock Prices via Voice</h3>
<p class="BodyFirst">Now we’ll mesh together the scripts <em>live_price.py</em> and <em>get_ticker_symbol.py</em> and add in the speech recognition and text-to-speech features. Enter <a href="#listing14-4" id="listinganchor14-4">Listing 14-4</a> in a Spyder editor and save it as <em>live_price_hs.py</em> in your chapter folder, or download the script from the book’s resources.</p>
<pre><code>import requests
from yahoo_fin import stock_info as si

from mptpkg import voice_to_text, print_say

<span epub:type="pagebreak" title="278" id="Page_278"/># Start an infinite loop
<span class="CodeAnnotationHang" aria-label="annotation1">1</span> while True:
    # Obtain company name from you
    print_say("Which company's stock price do you want to know?")
    firm = voice_to_text()
    print_say(f"You just said {firm}.")
    # If you want to stop, type in "stop listening"
    if firm == "stop listening":
        print_say("OK, goodbye then!")
        break
    # Otherwise, say a company name
  <span class="CodeAnnotationCode" aria-label="annotation2">2</span> else:
      try:
            # Extract the source code from the website
            url = 'https://query1.finance.yahoo.com/v1/finance/search?q='+firm
            response = requests.get(url)
            # Read the JSON data
            response_json = response.json()
            # Obtain the value corresponding to "quotes"
            quotes = response_json['quotes']
            # Get the ticker symbol
            ticker = quotes[0]['symbol']

            # Obtain live stock price from Yahoo!
          <span class="CodeAnnotationCode" aria-label="annotation3">3</span> price = round(float(si.get_live_price(ticker)),2)
            # Speak the stock price
            print_say(f"The stock price for {firm} is {price}.")        
        # In case the price cannot be found, the script will tell you
        except:
             print_say("Sorry, I cannot find what you are looking for!")        
        continue</code></pre>
<p class="CodeListingCaption"><a id="listing14-4">Listing 14-4</a>: Use voice to retrieve real-time stock price</p>
<p>We now import <code>print_say()</code> and <code>voice_to_text()</code> from the local <em>mptpkg</em> package to add the text-to-speech and speech recognition features. </p>
<p>At <span class="CodeAnnotation" aria-label="annotation1">1</span>, we start an infinite loop that asks for your voice input. To exit the loop, you say, “Stop listening.” Otherwise, you say a company name <span class="CodeAnnotation" aria-label="annotation2">2</span>, and the script searches for the ticker symbol. We use <code>try</code> and <code>except</code> here to prevent the script from crashing because of a lack of results from Yahoo! Finance. </p>
<p>We save the stock price from Yahoo! Finance in <code>price</code> <span class="CodeAnnotation" aria-label="annotation3">3</span>. Note that we use <code>round()</code> to round the stock price to two digits after the decimal. The script will speak the company’s stock price or, if there are no results, will say, “Sorry, I cannot find what you are looking for!” </p>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="note">
<h2><span class="NoteHead">Note</span></h2>
<p>	While the result from the ticker symbol search in this script is relatively accurate, mistakes do happen. Be sure to say the company name in a clear enough way that the script returns the correct ticker symbol. For example, use “Ford Motor” instead of “Ford.” </p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<p><span epub:type="pagebreak" title="279" id="Page_279"/>Here’s a sample interaction:</p>
<pre><code>Which company's stock price do you want to know?
You just said <b>JPMorgan Chase</b>.
The stock price for JPMorgan Chase is 97.31.

Which company's stock price do you want to know?
You just said <b>Goldman Sachs</b>.
The stock price for Goldman Sachs is 196.49.

Which company's stock price do you want to know?
You just said <b>stop listening</b>.
OK, goodbye then! </code></pre>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="box">
<h2>Try it Out</h2>
<p class="BoxBodyFirst">Use <em>live_price_hs.py</em> to find out the latest stock price for Johnson &amp; Johnson and McDonald’s.</p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<h2 id="h1-501560c14-0002">	Voice-Controlled Data Visualization</h2>
<p class="BodyFirst">One efficient way to analyze data—for example, to find patterns in stock movements—is through data visualization. <em>Data visualization</em> puts data into visual contexts such as plots and charts to make it easy for human brains to understand. </p>
<p>The price you obtained in the first project of this chapter is the latest price for the stock. That is, you have one data point for each stock you query. However, in order to learn more about a stock, it’s better to obtain a number of recent prices for the stock so that you can get a sense of velocity and direction. Is the stock staying at about the same value, rising, or falling? If the price is changing, how rapid is this change? </p>
<p>In this project, you’ll obtain recent daily stock price information from Yahoo! Finance. You’ll then plot a graph to see the price movements over time. You’ll also learn to create candlestick charts so that you can see intraday stock movement patterns. With that set up, we’ll add the speech recognition and text-to-speech features.</p>
<h3 id="h2-501560c14-0004">Create Stock Price Plots</h3>
<p class="BodyFirst">We’ll use the <em>pandas_datareader</em> module with <em>matplotlib</em> to create plots for stock prices over the last six months. First you’ll learn how to extract data, and then you’ll learn how to create plots. </p>
<p><span epub:type="pagebreak" title="280" id="Page_280"/>Before we begin, you need to install a few third-party modules. Go to your Anaconda prompt (in Windows) or a terminal (in Mac or Linux) and activate the virtual <em>chatting </em>environment. Then run the following lines of code one by one:</p>
<pre><code><b>conda install pandas </b>
<b>conda install matplotlib </b>
<b>pip install pandas_datareader </b></code></pre>
<p>Follow the instructions to finish the installations. The <em>pandas_datareader</em> module extracts online data from various sources into a <em>pandas</em> DataFrame. Then enter <a href="#listing14-5" id="listinganchor14-5">Listing 14-5</a> in your Spyder editor and save the script as <em>price_plot.py</em> in your chapter folder. </p>
<pre><code>import matplotlib.pyplot as plt
from pandas_datareader import data as pdr
import matplotlib.dates as mdates

# Set the start and end dates
<span class="CodeAnnotationHang" aria-label="annotation1">1</span> start_date = "2020-09-01"
end_date = "2021-02-28"

# Choose stock ticker symbol
<span class="CodeAnnotationHang" aria-label="annotation2">2</span> ticker = "TSLA"
# Get stock price
<span class="CodeAnnotationHang" aria-label="annotation3">3</span> stock = pdr.get_data_yahoo(ticker, start=start_date, end=end_date)
print(stock)
# Obtain dates
<span class="CodeAnnotationHang" aria-label="annotation4">4</span> stock['Date']=stock.index.map(mdates.date2num)
# Choose figure size
<span class="CodeAnnotationHang" aria-label="annotation5">5</span> fig = plt.figure(dpi=128, figsize=(10, 6))
# Format date to place on the x-axis
<span class="CodeAnnotationHang" aria-label="annotation6">6</span> formatter = mdates.DateFormatter('%m/%d/%Y')
plt.gca().xaxis.set_major_formatter(formatter)
# Plot data
<span class="CodeAnnotationHang" aria-label="annotation7">7</span> plt.plot(stock['Date'], stock['Adj Close'], c='blue')
# Format plot
<span class="CodeAnnotationHang" aria-label="annotation8">8</span> plt.title("The Stock Price of Tesla", fontsize=16)
plt.xlabel('Date', fontsize=10)
fig.autofmt_xdate()
plt.ylabel("Price", fontsize=10)
<span class="CodeAnnotationHang" aria-label="annotation9">9</span> plt.show()</code></pre>
<p class="CodeListingCaption"><a id="listing14-5">Listing 14-5</a>: The script to create a stock price plot</p>
<p>We import the modules, then specify the start and end dates of the data we want to extract <span class="CodeAnnotation" aria-label="annotation1">1</span>. These will be hardcoded for now; we’ll make the dates dynamic later. The dates should be in the format <em>YYYY</em>-<em>MM</em>-<em>DD</em>. In this case, we’ll use the six-month period from September 1, 2020, to February 28, 2021. We also provide the ticker symbol of the stock—in this case, Tesla with the ticker symbol TSLA <span class="CodeAnnotation" aria-label="annotation2">2</span>. </p>
<p><span epub:type="pagebreak" title="281" id="Page_281"/>We use <code>get_data_yahoo()</code> in the <em>pandas_datareader</em> module to extract daily stock price information and save the data as a <em>pandas</em> DataFrame named <code>stock</code> <span class="CodeAnnotation" aria-label="annotation3">3</span>. The dataset looks like this:</p>
<pre><code>                  High         Low  ...     Volume   Adj Close
Date                                ...                       
2020-09-01  502.489990  470.510010  ...   90119400  475.049988
2020-09-02  479.040009  405.119995  ...   96176100  447.369995
2020-09-03  431.799988  402.000000  ...   87596100  407.000000
2020-09-04  428.000000  372.019989  ...  110321900  418.320007
2020-09-08  368.739990  329.880005  ...  115465700  330.209991
               ...         ...  ...        ...         ...
2021-02-22  768.500000  710.200012  ...   37269700  714.500000
2021-02-23  713.609985  619.000000  ...   66606900  698.840027
2021-02-24  745.000000  694.169983  ...   36767000  742.020020
2021-02-25  737.210022  670.580017  ...   39023900  682.219971
2021-02-26  706.700012  659.510010  ...   41011300  675.500000

[123 rows x 6 columns]</code></pre>
<p>The dataset uses dates as indexes. The 123 rows represent the 123 trading days during the six-month period. The six columns represent the following information in each trading day: high price, low price, open price, closing price, trading volume, and adjusted closing price. </p>
<p>We then read the timestamp index of the dataset as a number and save it as an additional (seventh) column <span class="CodeAnnotation" aria-label="annotation4">4</span>. This step is necessary because the dataset doesn’t recognize the index as a separate variable, but we need the date information to use as our x-axis in the charts. We then use the <code>figure()</code> function in <em>matplotlib.pyplot</em> to specify the size and resolution of the plot and name the generated figure <code>fig</code> <span class="CodeAnnotation" aria-label="annotation5">5</span>. The <code>dpi=128</code> argument makes the output 128 pixels per inch. The <code>figsize=(10,6)</code> argument sets the plot 10 inches wide and 6 inches tall. </p>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="note">
<h2><span class="NoteHead">NOTE</span></h2>
<p>	<em>DPI</em> stands for (printer) <em>dots per inch</em> from predigital days. Nowadays, it actually stands for <em>pixels per inch</em>, so DPI is a bit of a misnomer. </p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<p>We use the <code>DateFormatter()</code> method from <em>matplotlib.dates</em> to specify the format of the dates we want to show <span class="CodeAnnotation" aria-label="annotation6">6</span>. We do the actual plotting by using <code>plot()</code> <span class="CodeAnnotation" aria-label="annotation7">7</span>. The first two arguments are the variables to use on the x- and y-axis, respectively. We also use a third argument to specify the color. In this case, we plot the adjusted closing price against the date and use blue as the color.</p>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="note">
<h2><span class="NoteHead">NOTE</span></h2>
<p>	The <em>a</em><em>djusted closing price</em> is the closing price adjusted for stock splits and cash dividends. In many cases, it’s identical to the unadjusted closing price. When it differs, it is a more accurate measure of total returns to investors since it takes into account both dividend yields and capital gains. </p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<p>Starting at <span class="CodeAnnotation" aria-label="annotation8">8</span>, we put a title on the graph and label the x- and y-axis. We also use <code>autofxt_xdate()</code> to show the dates on the x-axis diagonally to prevent overlapping text. </p>
<p><span epub:type="pagebreak" title="282" id="Page_282"/>Finally, <code>show()</code> is called to display the plot <span class="CodeAnnotation" aria-label="annotation9">9</span>. <a href="#figure14-3" id="figureanchor14-3">Figure 14-3</a> shows the output.</p>
<figure>
<img src="Images/f14003.png" alt="f14003" width="589" height="363"/>
<figcaption><p><a id="figure14-3">Figure 14-3</a>: Stock price plot for Tesla from September 2020 through February 2021</p></figcaption>
</figure>
<p>We can see the price movement patterns of Tesla over the six-month period. The stock was at less than $500 per share in early September 2020 but shot up to over $800 per share in late December, before dropping slightly in mid-February. This visualization is much more reader-friendly (and informative) than the <code>stock</code> DataFrame output earlier!</p>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="note">
<h2><span class="NoteHead">NOTE</span></h2>
<p>	In case you can’t locate the generated plot, the plots and charts appear in the Plots pane in the Spyder IDE. You may need to click the Plots tab to see them. </p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="box">
<h2>Try it Out</h2>
<p class="BoxBodyFirst">Run <em>price_plot.py</em> and generate a stock price plot for Facebook (ticker symbol FB) from September 1, 2020 to February 28, 2021. </p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<h3 id="h2-501560c14-0005">Create Candlestick Charts</h3>
<p class="BodyFirst">Price plots are great for summarizing patterns using one observation per day. Sometimes you’re interested in several intraday price movements, such as the range of the price fluctuation in a given day, whether the closing price is higher or lower than the opening price, and so on. With <em>candlestick charts</em>, you can visualize four pieces of information each day for a stock: daily high, daily low, opening price, and closing price. </p>
<p><span epub:type="pagebreak" title="283" id="Page_283"/>The following script generates the candlestick chart for Amazon stock in the month of February 2021. I don’t recommend plotting stock prices from more than one month because the chart may become too crowded, making it hard to detect patterns. </p>
<p>First, you need to install the third-party <em>mplfinance</em> module. Open your Anaconda prompt (in Windows) or a terminal (in Mac or Linux), activate the virtual environment <em>chatting</em>, and run the following command:</p>
<pre><code><b>pip install mplfinance</b></code></pre>
<p>Then open your Spyder editor and save <a href="#listing14-6" id="listinganchor14-6">Listing 14-6</a> as <em>candle_stick.py</em> in your chapter folder. </p>
<pre><code>import matplotlib.pyplot as plt
from pandas_datareader import data as pdr
import matplotlib.dates as mdates
from mplfinance.original_flavor import candlestick_ohlc

# Set the start and end date
start_date = "2021-02-01"
end_date = "2021-02-28"
# Choose stock ticker symbol
ticker = "AMZN"
# Get stock price
stock = pdr.get_data_yahoo(ticker, start=start_date, end=end_date)
# Obtain dates
stock['Date'] = stock.index.map(mdates.date2num)
# Choose the four daily prices: open, high, low, and close
<span class="CodeAnnotationHang" aria-label="annotation1">1</span> df_ohlc = stock[['Date','Open', 'High', 'Low', 'Close']]
# Choose figure size
figure, fig = plt.subplots(dpi=128, figsize = (8,4))
# Format dates
formatter = mdates.DateFormatter('%m/%d/%Y')
# Choose x-axis
fig.xaxis.set_major_formatter(formatter)
fig.xaxis_date()
<span class="CodeAnnotationHang" aria-label="annotation2">2</span> plt.setp(fig.get_xticklabels(), rotation = 10)
# Create the candlestick chart
<span class="CodeAnnotationHang" aria-label="annotation3">3</span> candlestick_ohlc(fig, 
                 df_ohlc.values, 
                 width=0.8, 
                 colorup='black', 
                 colordown='gray')
# Put text in the chart that black color means close &gt; open
<span class="CodeAnnotationHang" aria-label="annotation4">4</span> plt.figtext(0.3,0.2,'Black: Close &gt; Open')
# Put text in the chart that gray color means close &lt; open
plt.figtext(0.3,0.15,'Gray: Close &lt; Open')
# Put chart title and axis labels
<span class="CodeAnnotationHang" aria-label="annotation5">5</span> plt.title(f'Candlesticks Chart for {ticker}')
plt.ylabel('Price')
plt.xlabel('Date')
plt.show()</code></pre>
<p class="CodeListingCaption"><a id="listing14-6">Listing 14-6</a>: The script to create a candlestick chart</p>
<p><span epub:type="pagebreak" title="284" id="Page_284"/>We import all needed modules and functions, including the <code>candlestick_ohlc()</code> function from the <em>mplfinance</em> module that we’ll use to create the candlestick chart. </p>
<p>At <span class="CodeAnnotation" aria-label="annotation1">1</span>, we select the four daily prices that we want to extract and visualize in the chart: opening price, daily high, daily low, and closing price. </p>
<p>The <code>setp()</code> function from <em>matplotlib</em> sets object properties, and we invoke it to rotate the dates on the x-axis <span class="CodeAnnotation" aria-label="annotation2">2</span>. We pass two arguments (the first to obtain the x-axis label and the second to set the property) to rotate the x-axis label 10 degrees, so text doesn’t overlap. At <span class="CodeAnnotation" aria-label="annotation3">3</span>, we use <code>candlestick_ohlc()</code> to generate the candlestick chart. The first argument specifies where to place the chart, and the second specifies the data to use. The third argument is the width of the candle body relative to the distance between two observations (the distance on the x-axis between two trading days). </p>
<p>The candlestick chart uses colors to convey additional data. We use black to indicate that the closing price is higher than the opening price; otherwise, the value is gray. The information is also conveyed in the legend <span class="CodeAnnotation" aria-label="annotation4">4</span>. Finally, we give the chart a title and label the two axes <span class="CodeAnnotation" aria-label="annotation5">5</span>. </p>
<p>The candlestick chart for Amazon stock prices in February 2021 is shown in <a href="#figure14-4" id="figureanchor14-4">Figure 14-4</a>. The blank spaces in the chart are non-trading days (weekends and holidays).</p>
<p>The daily high and daily low are at the ends of the thin lines (which look like candle wicks), while the opening and closing prices are at the ends of the wide lines (which look like candle bodies). Hence the name! </p>
<p>From this, we can quickly see that, on February 1, the price jumped up: the body of the candle spans nearly $100 and is colored black. Compare this to the following day, where, although the thin line is relatively long, the candle body is short, showing that despite fluctuations, it closed at nearly the same price that it opened at.</p>
<figure>
<img src="Images/f14004.png" alt="f14004" width="658" height="362"/>
<figcaption><p><a id="figure14-4">Figure 14-4</a>: A candlestick chart for Amazon daily stock prices in February 2021</p></figcaption>
</figure>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="box">
<h2><span epub:type="pagebreak" title="285" id="Page_285"/>Try it Out</h2>
<p class="BoxBodyFirst">Run <em>candle_stick.py</em> to generate a candlestick chart for Wells Fargo (ticker symbol WFC) from February 1, 2021 to February 28, 2021. </p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<h3 id="h2-501560c14-0006">Add Voice Control</h3>
<p class="BodyFirst">Let’s add the speech functionality. When you say the company name, the script will search for the ticker symbol of the firm’s stock, retrieve daily price information, and display the plot or chart. We first need to create two local modules: one to display stock price plots and one to show candlestick charts. </p>
<h4 id="h3-501560c14-0001">The Price Plot Module</h4>
<p class="BodyFirst">We’ll create a stock price plot module based on <em>price_plot.py</em>. Enter <a href="#listing14-7" id="listinganchor14-7">Listing 14-7</a> in your Spyder editor and save it as <em>myplot.py</em>.</p>
<pre><code><var>--snip--</var>
from datetime import date, timedelta 

from mptpkg import print_say

<span class="CodeAnnotationHang" aria-label="annotation1">1</span> def price_plot(firm):
    try:
        # Extract the source code from the website
      <span class="CodeAnnotationCode" aria-label="annotation2">2</span> url = 'https://query1.finance.yahoo.com/v1/finance/search?q='+firm
        response = requests.get(url)
        # Read the JSON data
        response_json = response.json()
        # Obtain the value corresponding to "quotes"
        quotes = response_json['quotes']
        # Get the ticker symbol
        ticker = quotes[0]['symbol']
        # Set the start and end date
      <span class="CodeAnnotationCode" aria-label="annotation3">3</span> end_date = date.today().strftime("%Y-%m-%d")
        start_date = (date.today() - timedelta(days=180)).strftime("%Y-%m-%d")
        # Get stock price
        stock = pdr.get_data_yahoo(ticker, start=start_date, end=end_date)
        # Obtain dates
        stock['Date']=stock.index.map(mdates.date2num)
        # Choose figure size
      <span class="CodeAnnotationCode" aria-label="annotation4">4</span> fig = plt.figure(dpi=128, figsize=(10, 6))
        # Format date to place on the x-axis
        formatter = mdates.DateFormatter('%m/%d/%Y')
        plt.gca().xaxis.set_major_formatter(formatter)
        # Plot data
        plt.plot(stock['Date'], stock['Adj Close'], c='blue')
        # Format plot
        plt.title\
        (f"The Stock Price of {firm} in the Last Six Months", fontsize=16)

<span epub:type="pagebreak" title="286" id="Page_286"/>        plt.xlabel('Date', fontsize=10)
        fig.autofmt_xdate()
        plt.ylabel("Price", fontsize=10)
        plt.show()    
        # Let you know that the plot is ready via voice and print
      <span class="CodeAnnotationCode" aria-label="annotation5">5</span> print_say(f"OK, here is the stock price plot for {firm}.")
    except:
        print_say("Sorry, not a valid entry!")</code></pre>
<p class="CodeListingCaption"><a id="listing14-7">Listing 14-7</a>: The script for the stock plot module</p>
<p>We import the modules, including those we used to plot stock prices and to parse the HTML source file to find the firm’s ticker symbol. We also import the <code>print_say()</code> function from the local <em>mptpkg</em> package. </p>
<p>At <span class="CodeAnnotation" aria-label="annotation1">1</span>, we start <code>stock_plot()</code>, which takes the company name as the argument. We again use <code>try</code> and <code>except</code> to prevent crashes. We first find the ticker symbol of the firm <span class="CodeAnnotation" aria-label="annotation2">2</span>. </p>
<p>Here we make the price information dynamic <span class="CodeAnnotation" aria-label="annotation3">3</span>. The end date is today’s date, while the start date is six months ago. The script will generate a plot <span class="CodeAnnotation" aria-label="annotation4">4</span> and then tell you the plot is ready <span class="CodeAnnotation" aria-label="annotation5">5</span>. If the ticker symbol or the price information can’t be found, the script will print and say, “Sorry, not a valid entry!”</p>
<h4 id="h3-501560c14-0002">The Candlestick Chart Module</h4>
<p class="BodyFirst">Next we’ll create the candlestick chart module. Open <em>mychart.py</em> from the book’s resources, as shown in <a href="#listing14-8" id="listinganchor14-8">Listing 14-8</a>.</p>
<pre><code>from mplfinance.original_flavor import candlestick_ohlc
from mptpkg import print_say
from datetime import date, timedelta
<em>--snip--</em>
<span class="CodeAnnotationHang" aria-label="annotation1">1</span> def candle_stick(firm):
    
<var>--snip--</var>
        # Set the start and end date
        start_date = (date.today() - timedelta(days=14)).strftime("%Y-%m-%d")
        end_date = date.today().strftime("%Y-%m-%d")
<var>--snip--</var>
        # Choose the four daily prices: open, high, low, and close
      <span class="CodeAnnotationCode" aria-label="annotation2">2</span> df_ohlc = stock[['Date','Open', 'High', 'Low', 'Close']]
        # Choose figure size
        figure, fig = plt.subplots(dpi=128, figsize = (8,4))
<var>--snip--</var>
        plt.show()
      <span class="CodeAnnotationCode" aria-label="annotation3">3</span> print_say(f"Here is the candlestick chart for {firm}.")
<var>--snip--</var>
    except:
        print_say("Sorry, not a valid entry!")</code></pre>
<p class="CodeListingCaption"><a id="listing14-8">Listing 14-8</a>: The script to create the candlestick chart module</p>
<p>We import the modules, including the <code>candlestick_ohlc()</code> function from the <em>mplfinance</em> module. </p>
<p><span epub:type="pagebreak" title="287" id="Page_287"/>We define <code>candle_stick()</code> at <span class="CodeAnnotation" aria-label="annotation1">1</span>. Here we make the price information dynamic. The end date is today’s date, while the start date is two weeks ago. We then perform the same actions as in <em>myplot.py</em> to search for the ticker symbol. With the ticker symbol, we retrieve the daily stock price information in the past 14 days from Yahoo! Finance. I’ve snipped this part of the script to save space. </p>
<p>The data used for the candlestick chart will be the date plus the opening price, daily high and low prices, and closing price <span class="CodeAnnotation" aria-label="annotation2">2</span>. The script builds the candlestick chart and lets you know when it’s done <span class="CodeAnnotation" aria-label="annotation3">3</span>. </p>
<h4 id="h3-501560c14-0003">The Main Script</h4>
<p class="BodyFirst">Next, we’ll import the two modules to the main script so that we can voice-activate a stock price plot or a candlestick chart. Enter <a href="#listing14-9" id="listinganchor14-9">Listing 14-9</a> in your Spyder editor and save it as <em>plot_chart_hs.py</em> in your chapter folder.</p>
<pre><code>from myplot import price_plot
from mychart import candle_stick
from mptpkg import voice_to_text, print_say

# Start an infinite loop
<span class="CodeAnnotationHang" aria-label="annotation1">1</span> while True:
    # Obtain voice input from you
    print_say("How may I help you?")
    inp = voice_to_text()
    print_say(f"You said {inp}.")
    # If you want to stop, say "stop listening"
  <span class="CodeAnnotationCode" aria-label="annotation2">2</span> if "stop listening" in inp:
        print_say("Nice talking to you, goodbye!")
        break
    # If "price pattern for" in voice, activate plot functionality
  <span class="CodeAnnotationCode" aria-label="annotation3">3</span> elif "price pattern for" in inp:
        pos = inp.find('price pattern for ')
        firm = inp[pos+len('price pattern for '):]
        price_plot(firm)
        continue
    # If "candlestick chart for" in voice, activate chart functionality 
  <span class="CodeAnnotationCode" aria-label="annotation4">4</span> elif "chart for" in inp:
        pos = inp.find('chart for ')
        firm = inp[pos+len('chart for '):]
        candle_stick(firm)
        continue
    # Otherwise, go to the next iteration
    else:
        continue</code></pre>
<p class="CodeListingCaption"><a id="listing14-9">Listing 14-9</a>: The script to voice-control plot and chart creation</p>
<p>We import the modules and add the <code>print_say()</code> and <code>voice_to_text()</code> functions. We also import <code>price_plot()</code> from the local <em>myplot</em> module and <code>candle_stick()</code> from the local <em>mychart</em> module that we just created. </p>
<p><span epub:type="pagebreak" title="288" id="Page_288"/>At <span class="CodeAnnotation" aria-label="annotation1">1</span>, we start an infinite loop that asks for your voice input. To exit the script, you say, “Stop listening” <span class="CodeAnnotation" aria-label="annotation2">2</span>. To see the stock plot of a firm (say, Goldman Sachs), you say, “Stock pattern for Goldman Sachs.” The “stock pattern for” will trigger the stock plot functionality <span class="CodeAnnotation" aria-label="annotation3">3</span>. We use “stock pattern” instead of “stock plot” because it’s easier for the microphone to pick up. The script then extracts the company name, which is Goldman Sachs in this case, and uses it as the argument in the <code>price_plot()</code> function.</p>
<p>To see the candlestick chart of a firm (say, General Motors), you say, “Chart for General Motors.” The “chart for” part of the voice command will trigger the candlestick chart functionality <span class="CodeAnnotation" aria-label="annotation4">4</span>. The script then extracts the company name and uses it as the argument in the <code>candle_stick()</code> function.</p>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="note">
<h2><span class="NoteHead">NOTE</span></h2>
<p>	Depending on your operating system, you may want to change the trigger words in the script. For example, if the microphone can’t pick up “Stop listening,” you can change it to <code>stop</code> or <code>stop running</code>.</p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<p>Here’s my sample output:</p>
<pre><code>How may I help you?
You said <b>price pattern for Oracle.</b>
OK, here is the stock price plot for Oracle.

How may I help you?
You said <b>chart for Intel.</b>
Here is the candlestick chart for Intel.

How may I help you?
You said <b>stop listening.</b>
Nice talking to you, goodbye!</code></pre>
<p>The “price pattern for Oracle” phrase triggered the price plot functionality, and the script generated the price plot for Oracle, shown in <a href="#figure14-5" id="figureanchor14-5">Figure 14-5</a>.</p>
<figure>
<img src="Images/f14005.png" alt="f14005" width="569" height="355"/>
<figcaption><p><a id="figure14-5">Figure 14-5</a>: Voice-controlled stock price plot for Oracle</p></figcaption>
</figure>
<p><span epub:type="pagebreak" title="289" id="Page_289"/>The “chart for Intel” phrase prompted the script to create a candlestick chart for Intel, shown in <a href="#figure14-6" id="figureanchor14-6">Figure 14-6</a>.</p>
<figure>
<img src="Images/f14006.png" alt="f14006" width="548" height="296"/>
<figcaption><p><a id="figure14-6">Figure 14-6</a>: Voice-controlled candlestick chart for Intel</p></figcaption>
</figure>
<h2 id="h1-501560c14-0003">	Voice-Controlled Stock Report</h2>
<p class="BodyFirst">While the price plots and candlestick charts allow us to see recent price movements, they don’t give us information on how a stock has performed relative to the general market. Many times, investors are interested in how well a stock has performed in comparison to a benchmark index. They’re also interested in the risk of a stock, measured in how volatile a stock’s price has been relative to the market as a whole.</p>
<p>To that end, we’ll progress to a more detailed analysis of a stock’s price. You’ll obtain recent daily stock price information and perform regression analyses to figure out the recent performance and market risk of the stock. You’ll calculate the stock’s abnormal return (<em>alpha</em>, which is the relative performance of the stock compared to the market as a whole) and the market risk (<em>beta</em>, which measures how volatile the stock’s return has been compared to the market as a whole) by running a regression of the stock’s return on the market return. </p>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="note">
<h2><span class="NoteHead">NOTE</span></h2>
<p>	For detailed explanations of alpha and beta of stock, see, for example, the relevant articles on Wikipedia: <a href="https://en.wikipedia.org/wiki/Alpha_(finance)" class="LinkURL">https://en.wikipedia.org/wiki/Alpha_(finance)</a> and <a href="https://en.wikipedia.org/wiki/Beta_(finance)" class="LinkURL">https://en.wikipedia.org/wiki/Beta_(finance)</a>. </p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<h3 id="h2-501560c14-0007">Analyze Recent Stock Performance and Risk</h3>
<p class="BodyFirst">You’ll use the same methods we’ve used so far to extract recent daily stock price information from Yahoo! Finance using the <em>pandas_datareader</em> module. You’ll then use a new module <em>statsmodels</em> to perform statistical analyses. </p>
<p><span epub:type="pagebreak" title="290" id="Page_290"/>First, we’ll install the third-party module and extract data. Go to your Anaconda prompt (in Windows) or a terminal (in Mac or Linux) and activate the virtual <em>chatting </em>environment. Then run the following command:</p>
<pre><code><b>conda install statsmodels </b></code></pre>
<p>Enter <a href="#listing14-10" id="listinganchor14-10">Listing 14-10</a> in your Spyder editor and save the script as <em>alpha_beta.py</em> in your chapter folder. </p>
<pre><code>from datetime import date, timedelta

import statsmodels.api as sm
from pandas_datareader import data as pdr

# Set the start and end dates
end_date = date.today().strftime("%Y-%m-%d")
start_date = (date.today() - timedelta(days=180)).strftime("%Y-%m-%d")
market = "^GSPC" 
ticker = "MSFT"
# Retrieve prices
sp = pdr.get_data_yahoo(market, start=start_date, end=end_date)
stock = pdr.get_data_yahoo(ticker, start=start_date, end=end_date)
# Calculate returns for sp500 and the stock
sp['ret_sp'] = (sp['Adj Close']/sp['Adj Close'].shift(1))-1
stock['ret_stock'] = (stock['Adj Close']/stock['Adj Close'].shift(1))-1
# Merge the two datasets, keep only returns
df = sp[['ret_sp']].merge(stock[['ret_stock']],\
        left_index=True, right_index=True) 

# Add risk-free rate (assume constant for simplicity) 
<span class="CodeAnnotationHang" aria-label="annotation1">1</span> df['rf'] = 0.00001
# We need a constant to run regressions
df['const'] = 1 
df['exret_stock'] = df.ret_stock - df.rf
df['exret_sp'] = df.ret_sp - df.rf
# Remove missing values
df.dropna(inplace=True) 
# Calculate the stock's alpha and beta
<span class="CodeAnnotationHang" aria-label="annotation2">2</span> reg = sm.OLS(endog=df['exret_stock'],\
             exog=df[['const', 'exret_sp']], missing='drop')
results = reg.fit()
print(results.summary())
<span class="CodeAnnotationHang" aria-label="annotation3">3</span> alpha = round(results.params['const']*100,3)
beta = round(results.params['exret_sp'],2)
# Print the values of alpha and beta
print(f'The alpha of the stock of {ticker} is {alpha} percent.')
print(f'The beta of the stock of {ticker} is {beta}.')</code></pre>
<p class="CodeListingCaption"><a id="listing14-10">Listing 14-10</a>: The script to calculate stock alpha and beta</p>
<p>We import the modules and then specify the start and end dates of the data you want to extract. We again use the most recent six-month period. We also provide the ticker symbols of the market index, which is an index that represents the market as a whole. The S&amp;P 500 Index is often used, and that <span epub:type="pagebreak" title="291" id="Page_291"/>is what we will use. The company we’ll analyze is Microsoft Corporation. We use the <code>get_data_yahoo()</code> method in the <em>pandas_datareader</em> module to extract daily stock price information for the market index and Microsoft, and we save the data as two <em>pandas </em>DataFrames named <code>sp</code> and <code>stock</code>, respectively. </p>
<p>We then calculate the daily stock returns for both the S&amp;P 500 and Microsoft. The <code>shift()</code> method in <em>pandas</em> allows us to shift the index by a desired number of periods. We use <code>shift(1)</code> to obtain the price information of the previous trading day. This allows us to see how today compared to yesterday. Comparing the two days enables us to calculate returns. The <em>gross return</em> is the current value divided by the value at the close of the previous trading day, and the <em>net return</em> is the gross return minus one. </p>
<p>To calculate alpha and beta, we first merge the two datasets into one. For simplicity, we use a small constant value for the risk-free rate <span class="CodeAnnotation" aria-label="annotation1">1</span>. We then use the <code>OLS()</code> method in the <em>statsmodels </em>module to run a regression <span class="CodeAnnotation" aria-label="annotation2">2</span> and print out the regression results. The alpha and beta we want are the regression coefficients on the constant and the excess return on the market, respectively <span class="CodeAnnotation" aria-label="annotation3">3</span>. </p>
<p><a href="#figure14-7" id="figureanchor14-7">Figure 14-7</a> shows the regression results.</p>
<figure>
<img src="Images/f14007.png" alt="f14007" width="595" height="415"/>
<figcaption><p><a id="figure14-7">Figure 14-7</a>: Regression analysis results for Microsoft</p></figcaption>
</figure>
<p>Finally, we print out the values of the firm’s alpha and beta as follows:</p>
<pre><code>The alpha of the stock MSFT is 0.202 percent.
The beta of the stock MSFT is 1.1.</code></pre>
<p>The analysis shows that the alpha and beta are 0.202 percent and 1.1, respectively. This means Microsoft has outperformed similar stocks on the market by 0.202 percent per day, and the company has a market risk slightly greater than an average firm (which has a beta of 1), which means the stock’s return has been slightly more volatile than the market as a whole.</p>
<h3 id="h2-501560c14-0008"><span epub:type="pagebreak" title="292" id="Page_292"/>Add Voice Control </h3>
<p class="BodyFirst">Let’s add the voice control! You’ll ask about a company, and the script will search for the ticker symbol, retrieve daily stock information, and calculate the alpha and beta. Then the script will let you know that information by voice. The phrase “stock report for” will trigger the stock report functionality. </p>
<p>Enter <a href="#listing14-11" id="listinganchor14-11">Listing 14-11</a> in your Spyder editor and save the script as <em>alpha_beta_hs.py</em> in your chapter folder. </p>
<pre><code>from datetime import date, timedelta 
import statsmodels.api as sm
from pandas_datareader import data as pdr
import requests

from mptpkg import voice_to_text, print_say

<span class="CodeAnnotationHang" aria-label="annotation1">1</span> def alpha_beta(firm):
    try:
        # Extract the source code from the website
      <span class="CodeAnnotationCode" aria-label="annotation2">2</span> url = 'https://query1.finance.yahoo.com/v1/finance/search?q='+firm
        response = requests.get(url)
        # Read the JSON data
        response_json = response.json()
        # Obtain the value corresponding to "quotes"
        quotes = response_json['quotes']
        # Get the ticker symbol
        ticker = quotes[0]['symbol']
<var>--snip--</var>
    # Speak the values of alpha and beta
  <span class="CodeAnnotationCode" aria-label="annotation3">3</span> print_say(f'The alpha of the stock of {firm} is {alpha} percent.')
    print_say(f'The beta of the stock of {firm} is {beta}.')

# Start an infinite loop
<span class="CodeAnnotationHang" aria-label="annotation4">4</span> while True:
    # Obtain voice input from you
    print_say("How may I help you?")
    inp = voice_to_text()
    print_say(f"You said {inp}.")
    # If you want to stop, say "stop listening"
    if inp == "stop listening":
        print_say("Nice talking to you; goodbye!")
        break
    # If keywords in command, go to the stock report functionality
    elif "stock report for" in inp:
        # Locate the company name 
        pos = inp.find('stock report for ')
      <span class="CodeAnnotationCode" aria-label="annotation5">5</span> firm = inp[pos+len('stock report for '):]
        alpha_beta(firm)
        continue
    # Otherwise, go to the next iteration
    else:
        continue</code></pre>
<p class="CodeListingCaption"><a id="listing14-11">Listing 14-11</a>: Voice-control the calculation of stock alpha and beta</p>
<p><span epub:type="pagebreak" title="293" id="Page_293"/>We import the modules, including the <em>requests</em> module and the <code>print_say()</code> and <code>voice_to_text()</code> functions. </p>
<p>At <span class="CodeAnnotation" aria-label="annotation1">1</span>, we start the definition of <code>alpha_beta()</code>, using the firm name as its argument. As before, we use the plus sign to join words together to use as search terms for the ticker symbol on Yahoo! Finance <span class="CodeAnnotation" aria-label="annotation2">2</span>. We use <code>try</code> and <code>except</code> to prevent crashes and let the user know if the entry is invalid. The script then calculates the firm’s alpha and beta, as it does in <em>alpha_beta.py</em>, and both prints and speaks the alpha and beta <span class="CodeAnnotation" aria-label="annotation3">3</span>. </p>
<p>At <span class="CodeAnnotation" aria-label="annotation4">4</span>, we start an infinite loop that asks for your voice input. To exit the script, say, “Stop listening.” Otherwise, you say, “Stock report for” followed by the company name to activate the stock report functionality. The script extracts the company name from your voice command and prepares the report for you <span class="CodeAnnotation" aria-label="annotation5">5</span>. </p>
<p>Here’s my sample interaction:</p>
<pre><code>How may I help you?
You said <b>stock report for alibaba.</b>
The alpha of the stock alibaba is 0.059 percent.
The beta of the stock alibaba is 0.61.

How may I help you?
You said <b>stop listening.</b>
Nice talking to you; goodbye!</code></pre>
<p>I asked for the “stock report for Alibaba,” and the script obtained the report for me and replied, “The alpha of Alibaba is 0.059 percent; the beta of the stock Alibaba is 0.61.” </p>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="box">
<h2>Try it Out</h2>
<p class="BoxBodyFirst">Use <em>alpha_beta_hs.py</em> to obtain a stock report for British Petroleum.</p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<h2 id="h1-501560c14-0004">	Summary</h2>
<p class="BodyFirst">In this chapter, you applied the speech recognition and text-to-speech techniques to the financial market. These skills—scraping information, forming search terms that can be used in URLs, and retrieving real-time as well as recent daily stock price information—can be applied to a huge variety of web applications. You also learned a few data analysis and visualization skills, which are also handy for many applications.</p>
<p>In the next chapter, you’ll create talking graphical market watches for financial markets such as the US stock market or the foreign exchange market.</p>
<h2 id="h1-501560c14-0005"><span epub:type="pagebreak" title="294" id="Page_294"/>	End-of-Chapter Exercises</h2>
<ol class="decimal">
<li value="1">Modify <em>price_plot.py</em> so that the start and end dates are March 1, 2021 and June 1, 2021, respectively, and the plot color is red. </li>
<li value="2">Modify <em>candle_stick.py</em> so that the dates on the x-axis are in the format of 01-01-2021 (instead of 01/01/2021 or January 1, 2021) and rotated 15 degrees. </li>
</ol>
</section>
</div>
<div id="sbo-rt-content"><section>
<header>
<h1 class="chapter">
<span class="ChapterNumber"><span epub:type="pagebreak" title="295" id="Page_295"/>15</span><br/>
<span class="ChapterTitle">Stock Market Watch </span></h1>
</header>
<figure class="opener">
<img src="Images/chapterart.png" alt="" width="200" height="200"/>
</figure>
<p class="ChapterIntro">In this chapter, you’ll create a graphical, speaking app that monitors the US stock market in real time. When you run the script during trading hours, you’ll see a graphical display of the major stock indexes and a couple of stocks you select. The app also lets you know the values of the indexes and the stock prices in a human voice.</p>
<p>To build up the necessary skills, you’ll first create a graphical Bitcoin watch to display live price information, using the Python <em>tkinter</em> package. You can generalize these techniques to other financial markets such as the world stock market or the US Treasury bond market. </p>
<p>As always, all scripts are available through the book’s resources page at <a href="https://www.nostarch.com/make-python-talk/" class="LinkURL">https://www.nostarch.com/make-python-talk/</a>, and you should make the folder <em>/mpt/ch15/ </em>for this chapter.</p>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="box">
<h2><span epub:type="pagebreak" title="296" id="Page_296"/>New Skills </h2>
<ul>
<li>Retrieving live Bitcoin prices</li>
<li>Using and manipulating JSON data</li>
<li>Making widgets and animations using the <em>tkinter</em> package</li>
<li>Generalizing these techniques to other financial markets</li>
</ul>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<h2 id="h1-501560c15-0001">	Bitcoin Watch</h2>
<p class="BodyFirst">We’ll start with Bitcoin because the Bitcoin price is updated 24/7, unlike the stock market, which gives live price updates only when it’s open. In the process of creating a Bitcoin watch, you’ll learn the necessary skills to build a market watch for other financial markets. The script tells you whenever the Bitcoin price changes or if the price moves outside preset upper or lower bounds.</p>
<p>You’ll first learn how to read JSON data and some basics of the <em>tkinter</em> package.</p>
<h3 id="h2-501560c15-0001">How to Read JSON Data</h3>
<p class="BodyFirst">Bitcoin prices are available online for free and are updated every minute or so day and night. We’ll access Bitcoin prices through Python by using the API <a href="https://api.coindesk.com/v1/bpi/currentprice.json" class="LinkURL">https://api.coindesk.com/v1/bpi/currentprice.json</a>. Open the URL with a web browser, and you should see price information similar to <a href="#figure15-1" id="figureanchor15-1">Figure 15-1</a>.</p>
<figure>
<img src="Images/f15001.png" alt="f15001" width="697" height="347"/>
<figcaption><p><a id="figure15-1">Figure 15-1</a>: Live online information about Bitcoin price</p></figcaption>
</figure>
<p><span epub:type="pagebreak" title="297" id="Page_297"/>This data is formatted in JSON and hard to read. There are so many nested dictionaries, it’s hard to tell where one dictionary starts and ends. We discussed in <span class="xref" itemid="xref_target_Chapter 14">Chapter 14</span> how to make the data easier to understand by using an online JSON data formatter.</p>
<p>Similar to what you did in that chapter, go to the online JSON data formatter website, <a href="https://jsonformatter.curiousconcept.com/" class="LinkURL">https://jsonformatter.curiousconcept.com/</a>, paste the data from <a href="#figure15-1">Figure 15-1</a> into the designated space, and then click <b>Process</b>. The formatter will convert the data into a much more readable format, shown in <a href="#listing15-1" id="listinganchor15-1">Listing 15-1</a>.</p>
<pre><code>{
  <span class="CodeAnnotationCode" aria-label="annotation1">1</span> "time":{
      "updated":"Mar 3, 2021 09:58:00 UTC",
      "updatedISO":"2021-03-03T09:58:00+00:00",
      "updateduk":"Mar 3, 2021 at 09:58 GMT"
   },
  <span class="CodeAnnotationCode" aria-label="annotation2">2</span> "disclaimer":"This data was produced from the CoinDesk 
    Bitcoin Price Index (USD). Non-USD currency data converted 
    using hourly conversion rate from openexchangerates.org",
  <span class="CodeAnnotationCode" aria-label="annotation3">3</span> "chartName":"Bitcoin",
  <span class="CodeAnnotationCode" aria-label="annotation4">4</span> "bpi":{
      "USD":{
         "code":"USD",
         "symbol":"&amp;#36;",
         "rate":"51,462.6831",
         "description":"United States Dollar",
         "rate_float":51462.6831
      },
      "GBP":{
         "code":"GBP",
         "symbol":"&amp;pound;",
         "rate":"36,859.0146",
         "description":"British Pound Sterling",
         "rate_float":36859.0146
      },
      "EUR":{
         "code":"EUR",
         "symbol":"&amp;euro;",
         "rate":"42,617.8433",
         "description":"Euro",
         "rate_float":42617.8433
      }
   }
}</code></pre>
<p class="CodeListingCaption"><a id="listing15-1">Listing 15-1</a>: The formatted JSON data about the Bitcoin price</p>
<p>The dataset is a large dictionary of four elements with keys named <code>time</code> <span class="CodeAnnotation" aria-label="annotation1">1</span>, <code>disclaimer</code> <span class="CodeAnnotation" aria-label="annotation2">2</span>, <code>chartName</code> <span class="CodeAnnotation" aria-label="annotation3">3</span>, and <code>bpi</code> <span class="CodeAnnotation" aria-label="annotation4">4</span>. The value for the <code>bpi</code> key is, in turn, another dictionary with three keys: <code>USD</code>, <code>GBP</code>, and <code>EUR</code>. These represent the Bitcoin price in US dollars, British pounds, and Euros, respectively.</p>
<p><span epub:type="pagebreak" title="298" id="Page_298"/>We want the Bitcoin price in US dollars. The script <em>bitcoin_price.py</em>, shown in <a href="#listing15-2" id="listinganchor15-2">Listing 15-2</a>, retrieves the Bitcoin price and prints it out. </p>
<pre><code>import requests

# Specify the url to find the bitcoin price
url = 'https://api.coindesk.com/v1/bpi/currentprice.json'
# Retrieve the live information from bitcoin url
response = requests.get(url)
# Read the JSON data
response_json = response.json()
# Obtain the USD dictionary
usd = response_json['bpi']['USD']
# Get the price
price = usd['rate_float']
print(f"The Bitcoin price is {price} dollars.")</code></pre>
<p class="CodeListingCaption"><a id="listing15-2">Listing 15-2</a>: The script to retrieve the Bitcoin price</p>
<p>We import the <em>requests</em> module and specify the URL for the live Bitcoin price. We then use the <code>get()</code> method from the <em>requests</em> module to pull the data from the API. The <code>json()</code> method in the <em>requests</em> module reads the information into JSON format. We then extract the USD dictionary that contains all the Bitcoin price information in US dollars. The value we need from the dictionary is the price, and we use the <code>rate_float</code> key to retrieve it.</p>
<p>Finally, we print out the Bitcoin price. The output should be something like this: </p>
<pre><code>The Bitcoin price is 51462.6831 dollars.</code></pre>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="box">
<h2>Try it Out</h2>
<p class="BoxBodyFirst">Run <em>bitcoin_price.py</em> and compare the result to a Google search for the current Bitcoin price. </p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<h3 id="h2-501560c15-0002">A Quick Introduction to the tkinter Package</h3>
<p class="BodyFirst">Python’s default standard package for building a GUI is<em> tkinter</em>, short for <em>Tk interface</em>. The <em>tkinter</em> package has a variety of <em>widgets</em>, which are various tools like buttons, labels, entries, and message boxes. Widgets appear as different types of small windows inside the top-level root window, but they can also be stand-alone entities. We’ll focus on labels since we’ll use them in the market watch projects. </p>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="note">
<h2><span class="NoteHead">NOTE</span></h2>
<p>	For more information about Tk and <em>tkinter</em>, visit <a href="https://docs.python.org/3/library/tkinter.html" class="LinkURL">https://docs.python.org/3/library/tkinter.html</a>.</p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<p><span epub:type="pagebreak" title="299" id="Page_299"/>The <em>tkinter</em> package is in the Python standard library and needs no installation. If you are using Linux and encounter the <code>ModuleNotFoundError</code> when importing <em>tkinter</em>, execute this line of command in a terminal to install it:</p>
<pre><code><b>sudo apt-get install python3-tk</b></code></pre>
<p>I’ll introduce you to the basics of <em>tkinter</em>, including how to set up a screen and create a label widget. The script <em>tk_label.py</em>, shown in <a href="#listing15-3" id="listinganchor15-3">Listing 15-3</a>, sets up a screen and adds a label to it. </p>
<pre><code>import tkinter as tk

# Create the root window
root = tk.Tk()
# Specify the title and size of the root window
root.title("A Label Inside a Root Window")
root.geometry("800x200")
# Create a label inside the root window
label = tk.Label(text="this is a label", fg="Red", font=("Helvetica", 80))
label.pack()
# Run the game loop
root.mainloop()</code></pre>
<p class="CodeListingCaption"><a id="listing15-3">Listing 15-3</a>: Create a label in the <em>tkinter</em> package</p>
<p>We import the <em>tkinter</em> package. We set up a root window, which is used to hold all the widgets we’ll add to the script. We use the command <code>Tk()</code> and name the root window <code>root</code>.</p>
<p><em>Labels</em> are a simple form of widget used to display messages or images for informational purposes. We give the root window a title, <code>A Label Inside a Root Window</code>, which will appear in the title bar. We call the <code>geometry()</code> method to specify the width and height of the root window as 800 by 200 pixels.</p>
<p>We initiate a label by using <code>Label()</code>, which takes the text (or image) you want to display. You can optionally specify the color and font too. We use red and set the font to <code>("Helvetica", 80)</code>.</p>
<p>With the <code>pack()</code> method, we specify where we want to put the label. The default is to line up widgets starting from the top center of the root window. Finally, <code>mainloop()</code> starts the game loop so that the window shows up and stays on your computer screen.</p>
<p>Run the script and you should see <a href="#figure15-2" id="figureanchor15-2">Figure 15-2</a>.</p>
<figure>
<img src="Images/f15002.png" alt="f15002" width="694" height="205"/>
<figcaption><p><a id="figure15-2">Figure 15-2</a>: A label inside the root window in <em>tkinter</em></p></figcaption>
</figure>
<h3 id="h2-501560c15-0003"><span epub:type="pagebreak" title="300" id="Page_300"/>A Graphical Bitcoin Watch</h3>
<p class="BodyFirst">Now we’ll create a graphical Bitcoin watch by using the <em>tkinter</em> package. Open your Spyder editor and save the code in <a href="#listing15-4" id="listinganchor15-4">Listing 15-4</a> as <em>bitcoin_tk.py</em> in your chapter folder. </p>
<pre><code>import tkinter as tk
import requests

<span class="CodeAnnotationHang" aria-label="annotation1">1</span> import arrow

# Specify the url to find the Bitcoin price
url = 'https://api.coindesk.com/v1/bpi/currentprice.json'
# Create a root window to hold all widgets
<span class="CodeAnnotationHang" aria-label="annotation2">2</span> root = tk.Tk()
# Specify the title and size of the root window
root.title("Bitcoin Watch")
root.geometry("1000x400")
# Create a first label using the Label() function
<span class="CodeAnnotationHang" aria-label="annotation3">3</span> label = tk.Label(text="", fg="Blue", font=("Helvetica", 80))
label.pack()
# Create a second label
label2 = tk.Label(text="", fg="Red", font=("Helvetica", 60))
label2.pack()

# Define the bitcoin_watch() function
<span class="CodeAnnotationHang" aria-label="annotation4">4</span> def bitcoin_watch():
    # Get the live information from Bitcoin url
    response = requests.get(url)
    response_json = response.json()
    price = response_json['bpi']['USD']['rate_float']
    # Obtain current date and time information         
    tdate = arrow.now().format('MMMM DD, YYYY')
    tm = arrow.now().format('hh:mm:ss A')
    # Put the date and time information in the first label
  <span class="CodeAnnotationCode" aria-label="annotation5">5</span> label.configure(text=tdate + "\n" + tm)
    # Put price info in the second label        
    label2.configure(text=f'Bitcoin: {price}', justify=tk.LEFT)
    # Call the bitcoin_watch() function after 1000 milliseconds
  <span class="CodeAnnotationCode" aria-label="annotation6">6</span> root.after(1000, bitcoin_watch)

# Call the bitcoin_watch() function
bitcoin_watch()

# Run the game loop
root.mainloop()</code></pre>
<p class="CodeListingCaption"><a id="listing15-4">Listing 15-4</a>: Create a graphical Bitcoin price watch</p>
<p>We import the necessary functions and modules, including the <em>arrow</em> module to show the current time and date <span class="CodeAnnotation" aria-label="annotation1">1</span>. We then use the <code>Tk()</code> method to create a top-level root window and specify the title and the size <span class="CodeAnnotation" aria-label="annotation2">2</span>.</p>
<p><span epub:type="pagebreak" title="301" id="Page_301"/>We create two labels using <code>Label()</code> <span class="CodeAnnotation" aria-label="annotation3">3</span>. We first leave the messages in both labels as empty strings because this information will fill in from the Bitcoin watch. At <span class="CodeAnnotation" aria-label="annotation4">4</span>, we define <code>bitcoin_watch()</code>. The function first uses the <em>requests</em> module to obtain the Bitcoin price information from the URL we provide. We also obtain the current date and time and save them in the variables <code>tdate</code> and <code>tm</code>, respectively. </p>
<p>At <span class="CodeAnnotation" aria-label="annotation5">5</span>, we put the current date and time information in the first label, using the escape character <code>\n</code> to separate the lines. We put the live Bitcoin price in the second label.</p>
<p>Next we set animation effects <span class="CodeAnnotation" aria-label="annotation6">6</span>. We use <code>after()</code> to call another function after a specified amount of time. The command <code>after(1000, bitcoin_watch)</code> calls the function <code>bitcoin_watch()</code> after 1,000 milliseconds. Calling the command within the <code>bitcoin_watch()</code> function itself creates an infinite loop in which all the command lines inside <code>bitcoin_watch()</code> will be executed every 1,000 milliseconds. The result is that the time is constantly updated, and you can see the time value changes every second. If you keep the screen live long enough, you will also see the Bitcoin price change every minute or so.</p>
<p>When run, the script should look similar to <a href="#figure15-3" id="figureanchor15-3">Figure 15-3</a>. </p>
<figure>
<img src="Images/f15003.png" alt="f15003" width="694" height="303"/>
<figcaption><p><a id="figure15-3">Figure 15-3</a>: Using the <span class="LiteralInCaption"><code>after()</code></span> function to create an animated Bitcoin watch</p></figcaption>
</figure>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="box">
<h2>Try it Out</h2>
<p class="BoxBodyFirst">Run <em>bitcoin_tk.py</em> and watch it for about three minutes to see how often the price updates.</p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<h3 id="h2-501560c15-0004">A Talking Bitcoin Watch </h3>
<p class="BodyFirst">Next we’ll add the speech functionality. Whenever the price updates, the script will let you know in a human voice. We’ll also add an alert system: when the Bitcoin price moves outside the preset upper and lower bounds, the script will alert you out loud.</p>
<p><span epub:type="pagebreak" title="302" id="Page_302"/>Open <em>bitcoin_watch.py</em> from your chapter folder. Its differences from <em>bitcoin_tk.py</em> are highlighted in <a href="#listing15-5" id="listinganchor15-5">Listing 15-5</a>. </p>
<pre><code><var>--snip--</var>
from mptpkg import print_say

# Specify the url to find the Bitcoin price
url = 'https://api.coindesk.com/v1/bpi/currentprice.json'
<var>--snip-- </var>
# Create a second label
label2 = tk.Label(text="", fg="Red", font=("Helvetica", 60))
label2.pack()
# Set up the price bounds
response = requests.get(url)
response_json = response.json()
<span class="CodeAnnotationHang" aria-label="annotation1">1</span> oldprice = response_json['bpi']['USD']['rate_float']
maxprice = oldprice * 1.05
minprice = oldprice * 0.95
<span class="CodeAnnotationHang" aria-label="annotation2">2</span> print_say(f'The Bitcoin price is now {oldprice}!')


# Define the bitcoin_watch() function
def bitcoin_watch():
  <span class="CodeAnnotationCode" aria-label="annotation3">3</span> global oldprice
    # Get the live information from Bitcoin url
    response = requests.get(url)
    response_json = response.json()
    price = response_json['bpi']['USD']['rate_float']
    # If there is update in price, announce it    
  <span class="CodeAnnotationCode" aria-label="annotation4">4</span> if price != oldprice:
        oldprice = price
        print_say(f'The Bitcoin price is now {oldprice}!')
    # If price goes out of bounds, announce it    
  <span class="CodeAnnotationCode" aria-label="annotation5">5</span> if price &gt; maxprice:
        print_say('The Bitcoin price has gone above the upper bound!')
    if price &lt; price:
        print_say('The Bitcoin price has gone below the lower bound!')
        # Obtain current date and time information         
    tdate = arrow.now().format('MMMM DD, YYYY')
    tm = arrow.now().format('hh:mm:ss A')
<var>--snip--</var></code></pre>
<p class="CodeListingCaption"><a id="listing15-5">Listing 15-5</a>: Script to create a talking graphical Bitcoin price watch</p>
<p>We import the modules, including the <code>print_say()</code> function from the local <em>mptpkg</em> package.</p>
<p>We retrieve a Bitcoin price to use as the starting price and save it as <code>oldprice</code> <span class="CodeAnnotation" aria-label="annotation1">1</span>. We set the upper and lower bounds as values 5 percent above and below the value stored in <code>oldprice</code> and save them as <code>maxprice</code> and <code>minprice</code>, respectively. The script announces in a human voice the price of Bitcoin at that moment <span class="CodeAnnotation" aria-label="annotation2">2</span>. </p>
<p>We declare <code>oldprice</code> a global variable so that it can be recognized both inside and outside the function <code>bitcoin_watch()</code> <span class="CodeAnnotation" aria-label="annotation3">3</span>. Every time <code>bitcoin_watch()</code> <span epub:type="pagebreak" title="303" id="Page_303"/>is called, it obtains the latest Bitcoin price and compares it to the value stored in <code>oldprice</code>. If the values are different, the value of <code>oldprice</code> is updated to the new price, and the script announces the updated price <span class="CodeAnnotation" aria-label="annotation4">4</span>. </p>
<p>At <span class="CodeAnnotation" aria-label="annotation5">5</span>, the script checks whether the price has gone above the upper bound; if yes, it makes the announcement. Similarly, the script checks whether the price is below the lower bound and makes the announcement if it is. </p>
<p>This output is from running the script for a few minutes:</p>
<pre><code>The Bitcoin price is now 51418.8064!
The Bitcoin price is now 51377.4967!
The Bitcoin price is now 51419.3027!</code></pre>
<h2 id="h1-501560c15-0002">	A Talking Stock Market Watch</h2>
<p class="BodyFirst">Now we’ll use these skills to build the talking, graphical, live US stock market watch. We’ll make several significant changes to the Bitcoin version. </p>
<p>First, instead of showing just one asset, we’ll cover three major players in the market: Apple, Amazon, and Tesla. We’ll also show, as the main indexes we are interested in, the Dow Jones Industrial Average and the S&amp;P 500. </p>
<p>Second, instead of updating every thousand milliseconds, we’ll ask the script to update every two minutes. The script needs to retrieve five pieces of information instead of just one, and updating too frequently will cause information overload that could lead to the script freezing. More important, the values for the market indexes and prices for the preceding three stocks update every few seconds during the trading hours. Updating too often would make the announcements come nonstop and be distracting. You can choose to adjust the frequency that the script updates to your own liking. </p>
<p>Save the script in <a href="#listing15-6" id="listinganchor15-6">Listing 15-6</a> as <em>stock_watch.py</em> in your chapter folder or download it from the book’s resources page.</p>
<pre><code>import tkinter as tk

import arrow
from yahoo_fin import stock_info as si

from mptpkg import print_say

# Create a root window hold all widgets
<span class="CodeAnnotationHang" aria-label="annotation1">1</span> root = tk.Tk()
# Specify the title and size of the root window
root.title("U.S. Stock Market Watch")
root.geometry("1100x750")
# Create a first label using the Label() function
label = tk.Label(text="", fg="Blue", font=("Helvetica", 80))
label.pack()
# Create a second label
label2 = tk.Label(text="", fg="Red", font=("Helvetica", 60))
label2.pack()
# Set up tickers and names
tickers = ['^DJI', '^GSPC', 'AAPL', 'AMZN', 'TSLA']
<span epub:type="pagebreak" title="304" id="Page_304"/>names = ['DOW JONES', 'S&amp;P500', 'Apple', 'Amazon', 'Tesla']
# Set up the oldprice values and price bounds
<span class="CodeAnnotationHang" aria-label="annotation2">2</span> oldprice = []
maxprice = []
minprice = []
for i in range(5):
    p = round(float(si.get_live_price(tickers[i])), 2)
    oldprice.append(p)
    maxprice.append(p * 1.05)
    minprice.append(p * 0.95)
    if i &lt;= 1:
        print_say(f'The latest value for {names[i]} is {p}!')
    else:
        print_say(f'The latest stock price for {names[i]} is {p} dollars!')
    

# Define the stock_watch() function
<span class="CodeAnnotationHang" aria-label="annotation3">3</span> def stock_watch():
    # Declare global variables 
    global oldprice, maxprice, minprice
    # Obtain live information about the DOW JONES index from Yahoo
  <span class="CodeAnnotationCode" aria-label="annotation4">4</span> p1 = round(float(si.get_live_price("^DJI")), 2)
    m1 = f'DOW JONES: {p1}'
    # Obtain live information about the SP500 index from Yahoo 
    p2 = round(float(si.get_live_price("^GSPC")), 2)
    m2 = f'S&amp;P500: {p2}'
    # Obtain live price information for Apple stock from Yahoo
    p3 = round(float(si.get_live_price("AAPL")), 2)
    m3 = f'Apple: {p3}'
    # Obtain live price information for Amazon stock from Yahoo
    p4 = round(float(si.get_live_price("AMZN")), 2)
    m4 = f'Amazon: {p4}'
    # Obtain live price information for Tesla stock from Yahoo
    p5 = round(float(si.get_live_price("TSLA")), 2)
    m5 = f'Tesla: {p5}'
    # Put the five prices in a list p
  <span class="CodeAnnotationCode" aria-label="annotation5">5</span> p = [p1, p2, p3, p4, p5]
    # Obtain current date and time information
    tdate = arrow.now().format('MMMM DD, YYYY')
    tm = arrow.now().format('hh:mm:ss A')
    # Put the date and time information in the first label
    label.configure(text=tdate + "\n" + tm)
    # Put all the five messages on the stock market in the second label
    label2.configure(text=m1 +\
         "\n" + m2 + "\n" + m3 + "\n" + m4 + "\n" + m5, justify=tk.LEFT)
    # If there is update in the market, announce it
  <span class="CodeAnnotationCode" aria-label="annotation6">6</span> for i in range(5):
        if p[i] != oldprice[i]:
            oldprice[i] = p[i]
            if i &lt;= 1:
                print_say(f'The latest value for {names[i]} is {p[i]}!')
            else:
                print_say\
                (f'The latest stock price for {names[i]} is {p[i]} dollars!')
    # If price goes out of bounds, announce it
<span epub:type="pagebreak" title="305" id="Page_305"/>  <span class="CodeAnnotationCode" aria-label="annotation7">7</span> for i in range(5):
        if p[i] &gt; maxprice[i]:
            print_say(f'{names[i]} has moved above the upper bound!')
        if p[i] &lt; minprice[i]:
            print_say(f'{names[i]} has moved below the lower bound!')
    # Call the stock_watch() function
  <span class="CodeAnnotationCode" aria-label="annotation8">8</span> root.after(120000, stock_watch)


# Call the stock_watch() function
stock_watch()
# Run the game loop
root.mainloop()</code></pre>
<p class="CodeListingCaption"><a id="listing15-6">Listing 15-6</a>: Script to create a talking, graphical live US stock market watch</p>
<p>We import the modules, including <em>arrow</em> to show the time and date and <em>yahoo_fin</em> to obtain stock price information. We also import <code>print_say()</code> from the local <em>mptpkg</em> package to make announcements. </p>
<p>Starting at <span class="CodeAnnotation" aria-label="annotation1">1</span>, we create the <em>tkinter</em> root window and place two labels in it, as we did in <em>bitcoin_watch.py</em>. We then create three lists: <code>oldprice</code>, <code>maxprice</code>, and <code>minprice</code> <span class="CodeAnnotation" aria-label="annotation2">2</span>. We use <code>oldprice</code> to keep track of the values of the two indexes and the prices of the three stocks when we start running the script. The list <code>maxprice</code> holds the five upper bounds, 5 percent above the corresponding values in <code>oldprice</code>. Similarly, we define the five lower bounds in <code>minprice</code>. </p>
<p>The script then announces the values of the two indexes and the prices of the three stocks. Note that we put <code>dollars</code> after the three stock prices, but not after the two index values because index values are not measured in dollars. </p>
<p>We define <code>stock_watch()</code> at <span class="CodeAnnotation" aria-label="annotation3">3</span>, which declares <code>oldprice</code><em> </em>a global variable. Every time the function is called, it retrieves the values we’re interested in <span class="CodeAnnotation" aria-label="annotation4">4</span>. We keep two digits after the decimal for all values and save them in a list <code>p</code> <span class="CodeAnnotation" aria-label="annotation5">5</span>. </p>
<p>We obtain the time and date and put them in the first label. We put the values of the two indexes and three stocks in the second label. At <span class="CodeAnnotation" aria-label="annotation6">6</span>, we check each of the five values for updates, and we print and announce any updates. We also update the value stored in <code>oldprice</code> accordingly.</p>
<p>Starting at <span class="CodeAnnotation" aria-label="annotation7">7</span>, we check whether any of the five values has gone out of bounds. If yes, the script makes an announcement. Finally, we use <code>after()</code> to create the animation effect <span class="CodeAnnotation" aria-label="annotation8">8</span>. The <code>stock_watch()</code> function calls itself every 120,000 milliseconds, updating the screen every two minutes. </p>
<p>Here’s the output from one interaction with the script:</p>
<pre><code>The latest value for DOW JONES is 31477.02!
The latest value for S&amp;P500 is 3861.02!
The latest stock price for Apple is 124.65 dollars!
The latest stock price for Amazon is 3062.5 dollars!
The latest stock price for Tesla is 692.41 dollars!
The latest value for DOW JONES is 31460.43!
The latest value for S&amp;P500 is 3859.14!
The latest stock price for Apple is 124.49 dollars!
<span epub:type="pagebreak" title="306" id="Page_306"/>The latest stock price for Amazon is 3062.32 dollars!
The latest stock price for Tesla is 690.8 dollars!
The latest value for DOW JONES is 31434.83!
The latest value for S&amp;P500 is 3853.88!
The latest stock price for Apple is 124.26 dollars!
The latest stock price for Amazon is 3052.31 dollars!
The latest stock price for Tesla is 687.56 dollars!</code></pre>
<p>In just a few minutes, the script has updated all five values three times. <a href="#figure15-4" id="figureanchor15-4">Figure 15-4</a> shows the final screen.</p>
<figure>
<img src="Images/f15004.png" alt="f15004" width="582" height="414"/>
<figcaption><p><a id="figure15-4">Figure 15-4</a>: A graphical live US stock market watch</p></figcaption>
</figure>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="box">
<h2>Try it Out</h2>
<p class="BoxBodyFirst">Change the three stocks to Microsoft (ticker symbol MSFT), Goldman Sachs (ticker symbol GS), and Delta Airlines (ticker symbol DAL). Run the script after the change.</p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<h2 id="h1-501560c15-0003">	Apply the Method to Other Financial Markets</h2>
<p class="BodyFirst">We can apply these methods to other financial markets. If the price information is available from Yahoo! Finance, the modification is minimal: we just change the ticker symbols in the scripts. </p>
<p>If the price information is not available from Yahoo! Finance, search online for a website that provides JSON data for the market and then use the same method we used to retrieve the Bitcoin price. </p>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="box">
<h2><span epub:type="pagebreak" title="307" id="Page_307"/>Try it Out</h2>
<p class="BoxBodyFirst">Modify <em>stock_watch.py</em> to create a graphical watch for the Treasury bond rates. The graph should display the following four rates: 13-Week Treasury Bill rate (ticker symbol ^IRX), Five-Year Treasury Bond rate (ticker symbol ^FVX), Ten-Year Treasury Bond rate (ticker symbol ^TNX), and 30-Year Treasury Bond rate (ticker symbol ^TYX).</p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<h2 id="h1-501560c15-0004">	Summary</h2>
<p class="BodyFirst">In this chapter, you first learned how to retrieve information from JSON data and use it to create a graphical Bitcoin watch using the <em>tkinter</em> package. You obtained the live Bitcoin price online and created widgets with animations in <em>tkinter</em>.</p>
<p>With these skills, you made a graphical live market watch for the US stock market with spoken alerts. The script generates a graphical display of two major US stock indexes and three stocks that you’re interested in. When the prices change, the script lets you know in a human voice. The script also alerts you if an index value or a stock price goes outside the preset bounds.</p>
<p>You also learned how to apply this process to create a talking graphical market watch for other financial markets.</p>
<h2 id="h1-501560c15-0005">	End-of-Chapter Exercises</h2>
<ol class="decimal">
<li value="1">Modify <em>bitcoin_price.py</em> to retrieve the price in British pounds instead of US dollars and as a string variable instead of a floating-point number. </li>
<li value="2">Modify <em>tk_label.py</em> so that the size of the root window is 850 by 160 pixels and the message in the label displays <code>here is your label</code>.</li>
<li value="3">Modify <em>bitcoin_tk.py</em> so that the screen refreshes every 0.8 seconds.</li>
<li value="4">Modify <em>bitcoin_watch.py</em> so that the upper and lower bounds are set to 3 percent above and below the price when you start running the script.</li>
</ol>
</section>
</div>
<div id="sbo-rt-content"><section>
<header>
<h1 class="chapter">
<span class="ChapterNumber"><span epub:type="pagebreak" title="309" id="Page_309"/>16</span><br/>
<span class="ChapterTitle">Use World Languages</span></h1>
</header>
<figure class="opener">
<img src="Images/chapterart.png" alt="" width="200" height="200"/>
</figure>
<p class="ChapterIntro">So far, we’ve taught Python how to speak and listen in English. But Python can understand many other world languages. In this chapter, you’ll first teach Python to talk in several other languages with the modules we’ve been using. I’ll then introduce a useful module called <em>translate</em>, which can translate one language to another, and you’ll use this to silently translate languages. Then we’ll add the speech recognition and text-to-speech features so you can speak one language to the Python script and the script will say the translation in another language of your choice.</p>
<p><span epub:type="pagebreak" title="310" id="Page_310"/>As usual, all scripts in this chapter are available at the book’s resources page at <a href="https://www.nostarch.com/make-python-talk/" class="LinkURL">https://www.nostarch.com/make-python-talk/</a>. Start by creating the folder <em>/mpt/ch16/ </em>for this chapter.</p>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="box">
<h2>New Skills </h2>
<ul>
<li>Converting text to speech in major world languages</li>
<li>Recognizing speech in major world languages</li>
<li>Querying Wikipedia in major world languages</li>
<li>Translating in text and with voice</li>
</ul>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<h2 id="h1-501560c16-0001">	Text to Speech in Other Languages </h2>
<p class="BodyFirst">To work with non-English languages, we’ll use <em>gTTS</em> because it supports most major world languages. The downside to using <em>gTTS</em> is that it needs a separate module to play the audio file, but the alternative (<em>pyttsx3</em>) doesn’t support a wide range of non-English languages. Here we’ll try out the <em>gTTS</em> module with a few examples.</p>
<h3 id="h2-501560c16-0001">Install Modules</h3>
<p class="BodyFirst">To install the <em>gTTS</em> module in Windows, activate the virtual environment <em>chatting</em> and then execute the following command in the Anaconda prompt and follow the onscreen instructions: </p>
<pre><code><b>pip install gTTS</b></code></pre>
<p>If you’re using Mac or Linux, you should already have installed the <em>gTTS</em> module in <span class="xref" itemid="xref_target_Chapter 4">Chapter 4</span>. However, Google Translate has been known to make significant changes to the module, so you should upgrade to the latest version by running the following command in a terminal with the virtual environment <em>chatting</em> activated:</p>
<pre><code><b>pip install --upgrade gTTS</b></code></pre>
<p>You also need to install the <em>pydub</em> module to play audio files. You need to do this step no matter whether you’re using Windows, Mac, or Linux. Execute the following two lines of code in the Anaconda prompt (Windows) or a terminal (Mac or Linux), with the <em>chatting</em> virtual environment activated:</p>
<pre><code><b>conda install -c conda-forge pydub</b>
<b>conda install -c conda-forge ffmpeg</b></code></pre>
<p>Follow the instructions all the way through.</p>
<h3 id="h2-501560c16-0002"><span epub:type="pagebreak" title="311" id="Page_311"/>Convert Text to Speech in Spanish</h3>
<p class="BodyFirst">The script <em>speak_spanish.py </em>in <a href="#listing16-1" id="listinganchor16-1">Listing 16-1</a> shows how the <em>gTTS</em> module converts written Spanish into spoken Spanish. Enter these lines of code in your Spyder editor and save the script as <em>speak_spanish.py </em>in your chapter folder. </p>
<pre><code>from io import BytesIO

from gtts import gTTS
from pydub import AudioSegment
from pydub.playback import play

# Convert text to speech in Spanish
tts = gTTS(text='Buenos días',lang='es')
# Create a temporary file 
voice = BytesIO()
# Save the voice output as an audio file
tts.write_to_fp(voice)
# Play the audio file
voice.seek(0)
play(AudioSegment.from_mp3(voice))</code></pre>
<p class="CodeListingCaption"><a id="listing16-1">Listing 16-1</a>: Script to convert written Spanish to spoken Spanish</p>
<p>We first import the modules, including <em>gTTS</em> and <em>pydub</em>, that will play the audio file. </p>
<p>Next, we use the <code>gTTS()</code> function to convert the Spanish phrase <code>Buenos días</code> to spoken Spanish. The phrase can be literally translated to <em>Good day</em>. The first argument to <code>gTTS()</code> specifies which phrase to convert, and the second specifies what language to use. In this case, we use <code>es</code>, which stands for <em>Español</em>, or <em>Spanish </em>(see <a href="#table16-1" id="tableanchor16-1">Table 16-1</a> for a list of language codes). </p>
<p>The script generates a temporary file <em>voice </em>by using the <code>BytesIO()</code> function in the <em>io</em> module. If you instead used a fixed filename (such as <em>myfile.mp3</em>), the script may prevent you from overwriting the file when you rerun it and can crash. By using a temporary file each time you run the script, you avoid a crash.</p>
<p>Finally, we save the voice output as an audio file in the temporary file <em>voice</em> we just created. Then we play the audio file by using the <em>pydub</em> module. Run the script to hear Python say “Buenos días” in Spanish.</p>
<h3 id="h2-501560c16-0003">Support Text to Speech in Other Languages</h3>
<p class="BodyFirst">The <em>gTTS</em> module can convert text to speech in most major languages. <a href="#table16-1">Table 16-1</a> provides an incomplete list of the languages that the module supports, followed by the code used in the <code>gTTS()</code> function.</p>
<figure>
<figcaption class="TableTitle"><p><a id="table16-1">Table 16-1</a>: Major World Languages and the Corresponding Code in the <em>g</em><em>TTS</em> Module <span epub:type="pagebreak" title="312" id="Page_312"/></p></figcaption>
<table id="table-501560c16-0001" border="1">
<thead>
<tr>
<td><b>Language name</b></td>
<td><b>Language code</b></td>
</tr>
</thead>
<tbody>
<tr>
<td>Arabic</td>
<td><code>ar</code></td>
</tr>
<tr>
<td>Chinese</td>
<td><code>zh</code></td>
</tr>
<tr>
<td>Dutch</td>
<td><code>nl</code></td>
</tr>
<tr>
<td>English</td>
<td><code>en</code></td>
</tr>
<tr>
<td>French</td>
<td><code>fr</code></td>
</tr>
<tr>
<td>German</td>
<td><code>de</code></td>
</tr>
<tr>
<td>Italian</td>
<td><code>it</code></td>
</tr>
<tr>
<td>Japanese</td>
<td><code>ja</code></td>
</tr>
<tr>
<td>Korean</td>
<td><code>ko</code></td>
</tr>
<tr>
<td>Portuguese</td>
<td><code>pt</code></td>
</tr>
<tr>
<td>Russian</td>
<td><code>ru</code></td>
</tr>
<tr>
<td>Spanish</td>
<td><code>es</code></td>
</tr>
</tbody>
</table>
</figure>
<p>You can find a more comprehensive list at <a href="https://cloud.google.com/speech-to-text/docs/languages/" class="LinkURL">https://cloud.google.com/speech-to-text/docs/languages/</a>.</p>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="note">
<h2><span class="NoteHead">NOTE</span></h2>
<p>	Earlier versions of the <em>g</em><em>TTS</em> module provided different accents or dialects within a language. For example, while the code <code>es</code> means Spanish, <code>es-es</code> means Spanish from Spain and <code>es-mx</code> means Spanish from Mexico. Google Translate has since deprecated this feature. If you get an error message by using accents or dialects within a language, be sure to use only the two-letter language code.</p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<p>Next, you’ll create a script to choose the language you want. After that, you’ll ask the script to translate a phrase from text to spoken language.</p>
<h3 id="h2-501560c16-0004">Convert Text to Speech in World Languages</h3>
<p class="BodyFirst">The script <em>speak_world_languages.py</em> in <a href="#listing16-2" id="listinganchor16-2">Listing 16-2</a> shows you how to convert text to speech in several major world languages.</p>
<pre><code>from io import BytesIO

from gtts import gTTS
from pydub import AudioSegment
from pydub.playback import play

# Create a dictionary of languages and the corresponding codes
<span class="CodeAnnotationHang" aria-label="annotation1">1</span> lang_abbre = {"english":"en",
            "chinese":"zh",
<span epub:type="pagebreak" title="313" id="Page_313"/>            "spanish":"es",
            "french":"fr",
            "japanese":"ja",
            "portuguese":"pt",
            "russian":"ru",
            "korean":"ko",
            "german":"de",
            "italian":"it"}
<span class="CodeAnnotationHang" aria-label="annotation2">2</span> lang = input("What language do you want to use?\n")
phrase = input("What phrase do you want to convert to voice?\n")
# Convert text to speech
tts = gTTS(text=phrase,lang=lang_abbre[lang])
# Create a temporary file 
voice = BytesIO()
# Save the voice output as an audio file
tts.write_to_fp(voice)
# Play the audio file
voice.seek(0)
play(AudioSegment.from_mp3(voice))</code></pre>
<p class="CodeListingCaption"><a id="listing16-2">Listing 16-2</a>: Script to convert written language to spoken language</p>
<p>We create a dictionary <em>lang_abbre</em>, which maps different foreign languages to the corresponding codes in the <em>gTTS </em>module <span class="CodeAnnotation" aria-label="annotation1">1</span>. The script then asks what language you want to use. You can type in your choice in the IPython console <span class="CodeAnnotation" aria-label="annotation2">2</span>. Then type in the phrase you want to convert to voice at the prompt. </p>
<p>The script converts your phrase into an audio file and saves it in the temporary file <em>voice</em>.<em> </em>Then it plays the audio file by using the <em>pydub</em> module.</p>
<p>The following is an interaction with the script, with my text input in bold:</p>
<pre><code>What language do you want to use?
<b>chinese</b>

What phrase do you want to convert to voice?
<b>嗨,你好吗?</b></code></pre>
<p>I first chose the language Chinese and then typed in the text <code>嗨,你好吗?</code>, which is the Chinese phrase for <em>Hi, how are you?</em> After running the script, I heard Python speaking Chinese.</p>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="box">
<h2>Try it Out</h2>
<p class="BoxBodyFirst">Run <em>speak_world_languages.py </em>to speak and understand a language of your choice. Convert a phrase from text to speech. If the language of your choice is not in the dictionary <em>lang_abbre</em>, add it to the script (consult <a href="#table16-1">Table 16-1</a> for the language code).</p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<h2 id="h1-501560c16-0002"><span epub:type="pagebreak" title="314" id="Page_314"/>	Speech Recognition in Major World Languages</h2>
<p class="BodyFirst">The speech recognition module we’ve used throughout this book is able to recognize other major world languages as well. We just need to let the script know which language we want to use. </p>
<p>We’ll use Japanese as an example to illustrate how it works. The script <em>sr_japanese.py</em> in <a href="#listing16-3" id="listinganchor16-3">Listing 16-3</a> recognizes spoken Japanese and converts your voice into written text.</p>
<pre><code>import speech_recognition as sr

# Initiate speech recognition
speech = sr.Recognizer()
# Use it to capture spoken Japanese 
print('Python is listening in Japanese...')
with sr.Microphone() as source:
    speech.adjust_for_ambient_noise(source)
    try:
        audio = speech.listen(source)
      <span class="CodeAnnotationCode" aria-label="annotation1">1</span> my_input = speech.recognize_google(audio, language="ja")
        print(f"you said: {my_input}")    
    except sr.UnknownValueError:
        pass</code></pre>
<p class="CodeListingCaption"><a id="listing16-3">Listing 16-3</a>: Speech recognition in Japanese</p>
<p>We first import the speech recognition module. Then we initiate speech recognition by using the <code>Recognizer()</code> function. The script prints out the message <code>Python is listening in Japanese</code> to prompt you to speak Japanese into the microphone. We use the <code>adjust_for_ambient_noise()</code> function to reduce the influence of any ambient noise on your voice input.</p>
<p>At <span class="CodeAnnotation" aria-label="annotation1">1</span>, we specify Japanese by passing <code>language="ja"</code> in the <code>recognize_google()</code> function. Recall from <span class="xref" itemid="xref_target_Chapter 3">Chapter 3</span> that <code>recognize_google()</code> uses the Google Web Speech API; this is in contrast to other methods such as <code>recognize_bing()</code>, which uses the services of Microsoft Bing Speech, or<code> recognize_ibm()</code>, which uses the services of IBM Speech to Text. The script then prints out your voice input in Japanese.</p>
<p>Here’s my output from interacting with the computer:</p>
<pre><code>Python is listening in Japanese...
you said: ありがとうございます</code></pre>
<p>I said into the microphone “Thank you” in Japanese. The script correctly captures the phrase and prints it out.</p>
<p>You can easily modify <em>sr_japanese.py</em> by replacing <code>language="ja"</code> (and the appropriate language titles in the prompts) with the language of your choice so that you can interact with the computer in another language. The list of world languages and their corresponding codes can be found at <a href="https://www.science.co.il/language/Locale-codes.php." class="LinkURL">https://www.science.co.il/language/Locale-codes.php.</a></p>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="box">
<h2><span epub:type="pagebreak" title="315" id="Page_315"/>Try it Out</h2>
<p class="BoxBodyFirst">Modify <em>sr_japanese.py</em> to use a language of your choice. Then run the script and say “Good morning” into the microphone to check whether the output is correct.</p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<h2 id="h1-501560c16-0003">	A Talking Wikipedia </h2>
<p class="BodyFirst">Wikipedia supports most major world languages, detailed at <a href="https://en.wikipedia.org/wiki/List_of_Wikipedias" class="LinkURL">https://en.wikipedia.org/wiki/List_of_Wikipedias</a>. In <span class="xref" itemid="xref_target_Chapter 5">Chapter 5</span>, we created a talking Wikipedia in English. We’ll build a version you can adapt to work with any major language. <a href="#listing16-4" id="listinganchor16-4">Listing 16-4</a> uses Chinese. Enter the following code into your Spyder editor and save it as <em>wiki_world_languages.py</em>. </p>
<pre><code>from io import BytesIO</code></pre>
<pre><code>
import speech_recognition as sr
from gtts import gTTS
from pydub import AudioSegment
from pydub.playback import play
import Wikipedia

from mptpkg import print_say

# Create a dictionary of languages and the corresponding codes
lang_abbre = {"english":"en",
            "chinese":"zh",
            "spanish":"es",
            "french":"fr",
            "japanese":"ja",
            "portuguese":"pt",
            "russian":"ru",
            "korean":"ko",
            "german":"de",
            "italian":"it"}
Lang = input("What language do you want to use?\n")

# Initiate speech recognition
speech = sr.Recognizer()
# Request a query in a specified language
<span class="CodeAnnotationCode" aria-label="annotation1">1</span> print_say(f"Say what you want to know in {lang}...")
# Capture your voice query in the language of your choice
<span class="CodeAnnotationCode" aria-label="annotation2">2</span> with sr.Microphone() as source:
    speech.adjust_for_ambient_noise(source)
    while True:
        try:
            audio = speech.listen(source)
            my_input = speech.recognize_google(audio, language=lang_abbre[lang])
<span epub:type="pagebreak" title="316" id="Page_316"/>            break
        except sr.UnknownValueError:
            print_say("Sorry, I cannot understand what you said!")
# Print out what you said
<span class="CodeAnnotationCode" aria-label="annotation3">3</span> print(f"you said: {my_input}")
# Obtain answer from Wikipedia and print out
wikipedia.set_lang(lang_abbre[lang])
Ans = wikipedia.summary(my_input)[0:200]
print(ans)
# Convert text to speech in the language of your choice
<span class="CodeAnnotationCode" aria-label="annotation4">4</span> tts = gTTS(text=ans,lang=lang_abbre[lang])
# Create a temporary file 
Voice = BytesIO()
# Save the voice output as an audio file
tts.write_to_fp(voice)
# Play the audio file
voice.seek(0)
play(AudioSegment.from_mp3(voice))</code></pre>
<p class="CodeListingCaption"><a id="listing16-4">Listing 16-4</a>: A talking Wikipedia in major world languages </p>
<p>We import the modules, including the <em>wikipedia</em> module we used in <span class="xref" itemid="xref_target_Chapter 5">Chapter 5</span>. The dictionary <em>lang_abbre</em> maps different foreign languages to the corresponding codes in the <em>gTTS </em>module. We’ll also use the language codes in the <em>speech_recognition </em>module and the <em>wikipedia </em>module. </p>
<p>The script then asks what language you want to use <span class="CodeAnnotation" aria-label="annotation1">1</span>. You can type in your choice in the IPython console. Then speak your query into the microphone in the language you chose <span class="CodeAnnotation" aria-label="annotation2">2</span>. The script captures the voice input, converts it to written text, and stores it in <code>my_input</code>. </p>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="note">
<h2><span class="NoteHead">NOTE</span></h2>
<p>	While the three modules—<em>gTTS</em>, <em>speech_recognition</em>, and <em>wikipedia</em><em>—</em>share the same digit language code for most languages, there could be exceptions. Double-check that the language of your choice has correct codes in all three modules.</p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<p>The script then prints your query <span class="CodeAnnotation" aria-label="annotation3">3</span>. After it does so, we set the language of Wikipedia to the language of your choice. We then send the query to Wikipedia and print the result. Finally, we convert the answer to speech and let the script say it in a human voice <span class="CodeAnnotation" aria-label="annotation4">4</span>. </p>
<p>Here is the output from an interaction with the script, with my written and voice inputs in bold:</p>
<pre><code>What language do you want to use?
<b>chinese</b>
Say what you want to know in chinese...
美利堅合眾國（英語：United States of America, 縮寫為USA,一般稱為United States(U.S.或US),或America),中文通稱「美國」,是由其下轄50个州、華盛頓哥倫比亞特區、五个自治领土及外岛共同組成的聯邦共和国。美國本土48州和联邦特区位於北美洲中部，東臨大西洋，北面是加拿大，南部和墨西哥及墨西哥灣接壤，本土位於溫帶、副熱帶地區。阿拉斯加州位於北美大陸西</code></pre>
<p><span epub:type="pagebreak" title="317" id="Page_317"/>I first typed in <code>chinese</code> as my choice of language. Then I said “United States of America” in Chinese into the microphone, and the script stored a short description of the United States in Chinese and both printed and spoke it.</p>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="box">
<h2>Try it Out</h2>
<p class="BoxBodyFirst">Run <em>wiki_world_languages.py</em> to use your chosen language and try it out. If your language is not in the dictionary <em>lang_abbre</em>, modify the script to add it. </p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<h2 id="h1-501560c16-0004">	Create Your Own Voice Translator</h2>
<p class="BodyFirst">Now you’ll create your own voice translator. When you speak to the script in any major language, the script will translate it to another language of your choice and speak it out.</p>
<p>We’ll first make a text version with the <em>translate</em> module, then add speech recognition and text-to-speech features.</p>
<h3 id="h2-501560c16-0005">A Text-Based Translator</h3>
<p class="BodyFirst">We first need to install the <em>translate</em> module, powered by Google Translate. The module is not in the Python Standard Library, and we need to <code>pip install</code> it. Open the Anaconda prompt (in Windows) or a terminal (in Mac or Linux). With the virtual environment <em>chatting</em> activated, run the following command:</p>
<pre><code><b>pip install translate </b></code></pre>
<p>Follow the instructions to finish the installation. </p>
<p>The script in <a href="#listing16-5" id="listinganchor16-5">Listing 16-5</a> translates English to Chinese, and translates Chinese to English, by using text input. Open your Spyder editor and copy the following code; then save it as <em>english_chinese.py</em> in your chapter folder.</p>
<pre><code># Import the Translator function from the translate module
from translate import Translator

# Specify the input and output languages
translator = Translator(from_lang="en",to_lang="zh")
# Do the actual translation
translation = translator.translate("hello all")
print(translation)
# Specify the input and output languages
translator = Translator(from_lang="zh",to_lang="en")
# Do the actual translation
translation = translator.translate("请再说一遍")
print(translation)</code></pre>
<p class="CodeListingCaption"><a id="listing16-5">Listing 16-5</a>: Translation between English and Chinese </p>
<p><span epub:type="pagebreak" title="318" id="Page_318"/>We first import the <code>Translator()</code> function from the <em>translate</em> module. We need to specify the input language (here, English <code>from_lang="en"</code>) and the output language (here, Chinese with <code>to_lang="zh"</code>). We translate the phrase <code>hello all</code> from English to Chinese and print it.</p>
<p>Then we reverse the input and output languages to translate the phrase <code>请再说一遍</code> from Chinese to English and print it. The output is as follows:</p>
<pre><code>大家好！
please say it again</code></pre>
<p>We can modify the input and output languages in <em>english_chinese.py</em> to use any two major world languages. To see the languages supported by the <em>translate</em> module and their corresponding codes, check <a href="https://www.labnol.org/code/19899-google-translate-languages/" class="LinkURL">https://www.labnol.org/code/19899-google-translate-languages/</a>.</p>
<h3 id="h2-501560c16-0006">A Voice-Based Translator</h3>
<p class="BodyFirst">Next, we’ll add speech recognition and text-to-speech functionality. Again, we’ll hardcode the language to translate to and from, but you can easily adapt this script to any supported language. </p>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="note">
<h2><span class="NoteHead">NOTE</span></h2>
<p>	In <span class="xref" itemid="xref_target_Chapter 17">Chapter 17</span>, we’ll add a voice translator functionality to our ultimate VPA, in which the script extracts the language you want to use. There we’ll make the language choice dynamic. </p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<p>This version translates English to Spanish and Spanish to English. Open your Spyder editor and copy <a href="#listing16-6" id="listinganchor16-6">Listing 16-6</a>. Save the script as <em>voice_translator.py</em> in your chapter folder.</p>
<pre><code>from io import BytesIO

from translate import Translator
import speech_recognition as sr
from gtts import gTTS
from pydub import AudioSegment
from pydub.playback import play

# Initiate speech recognition
speech = sr.Recognizer()
# Prompt you to say something in English
print('say something in English')
# Capture spoken English 
with sr.Microphone() as source:
    speech.adjust_for_ambient_noise(source)
    try:
        audio = speech.listen(source)
        my_input = speech.recognize_google(audio, language="en")
        print(f"you said: {my_input}")    
    except sr.UnknownValueError:
        pass
<span epub:type="pagebreak" title="319" id="Page_319"/># Specify the input and output languages
<span class="CodeAnnotationHang" aria-label="annotation1">1</span> translator = Translator(from_lang="en",to_lang="es")
# Do the actual translation
translation = translator.translate(my_input)
<span class="CodeAnnotationHang" aria-label="annotation2">2</span> print(translation)
# Convert text to speech in Spanish
tts = gTTS(text=translation,lang='es')
# Create a temporary file 
voice = BytesIO()
# Save the voice output as an audio file
<span class="CodeAnnotationHang" aria-label="annotation3">3</span> tts.write_to_fp(voice)
# Play the audio file
voice.seek(0)
play(AudioSegment.from_mp3(voice))
# Prompt you to say something in Spanish
<span class="CodeAnnotationHang" aria-label="annotation4">4</span> print('say something in Spanish')
# Capture spoken Spanish 
with sr.Microphone() as source:
    speech.adjust_for_ambient_noise(source)
    try:
        audio = speech.listen(source)
        my_input = speech.recognize_google(audio, language="es")
        print(f"you said: {my_input}")    
    except sr.UnknownValueError:
        pass
# Specify the input and output languages
Translator = Translator(from_lang="es",to_lang="en")
# Do the actual translation
translation = translator.translate(my_input)
print(translation)
# Convert text to speech in Spanish
tts = gTTS(text=translation,lang='en')
# Create a temporary file 
voice = BytesIO()
# Save the voice output as an audio file
tts.write_to_fp(voice)
# Play the audio file
voice.seek(0)
play(AudioSegment.from_mp3(voice))</code></pre>
<p class="CodeListingCaption"><a id="listing16-6">Listing 16-6</a>: A voice translator between English and Spanish</p>
<p>We first import all modules. Then we initiate speech recognition by using the <code>Recognizer()</code> function. Next, the script prints <code>say something in English</code> to prompt you to speak the English phrase you want to translate. </p>
<p>The script captures your voice input, saves it in the variable <code>my_input</code>, and prints it. At <span class="CodeAnnotation" aria-label="annotation1">1</span>, we specify the input language as English and the output language as Spanish. We then translate the text stored in <code>my_input</code> to Spanish and print it <span class="CodeAnnotation" aria-label="annotation2">2</span>. After printing the translation, we convert the Spanish text to voice. Finally, we save the translation to an audio file and play it <span class="CodeAnnotation" aria-label="annotation3">3</span>.</p>
<p><span epub:type="pagebreak" title="320" id="Page_320"/>Starting at <span class="CodeAnnotation" aria-label="annotation4">4</span>, we reverse the input and output languages. You can then speak a Spanish phrase to translate, and the computer will give the English translation.</p>
<p>Here is the output from an interaction with the script, with my voice input in bold:</p>
<pre><code>say something in English
you said: <b>today is a great day</b>
Hoy es un gran día.

say something in Spanish
you said: <b>uno dos tres</b>
1 2 3</code></pre>
<p>I spoke the phrase “Today is a great day” in English. The script printed and spoke the Spanish translation <code>Hoy es un gran día</code>. I then said in Spanish, “uno, dos, tres.” The script correctly printed and spoke the English translation <code>1 2 3</code>.</p>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="note">
<h2><span class="NoteHead">NOTE</span></h2>
<p>	While most translations from the <em>translate</em> module are relatively accurate, it’s best to avoid phrases with multiple meanings that may lead to inaccurate translations. </p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="box">
<h2>Try it Out</h2>
<p class="BoxBodyFirst">Modify <em>voice</em><em>_</em><em>translator.py</em> to change the language to another language of your choice. Use it to translate a phrase to English and translate a phrase from English to that language.</p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<h2 id="h1-501560c16-0005">	Summary</h2>
<p class="BodyFirst">In this chapter, you adapted your speaking scripts to use any major world language. Along the way, you learned to convert text to speech in major world languages such as Spanish, Chinese, Japanese, French, and so on. You also learned how to perform speech recognition in major world languages. With these skills, you are able to interact with your computer in non-English languages. </p>
<p>You then learned how to install the <em>translate</em> module, which can translate text from one language to another. We combined the module with the speech recognition and text-to-speech features to create a voice translator. This is incredibly useful real-world functionality that can help make your deployed applications globally adaptable. </p>
</section>
</div>
<div id="sbo-rt-content"><section>
<header>
<h1 class="chapter">
<span class="ChapterNumber"><span epub:type="pagebreak" title="321" id="Page_321"/>17</span><br/>
<span class="ChapterTitle">Ultimate Virtual Personal Assistant</span></h1>
</header>
<figure class="opener">
<img src="Images/chapterart.png" alt="" width="200" height="200"/>
</figure>
<p class="ChapterIntro">In this chapter, you’ll load up a virtual personal assistant (VPA) with the interesting projects in this book, like voice-controlled games, voice translators, voice music activations, and so on. You’ll first add a chatting functionality to the script so you can carry out a daily conversation with the VPA. You’ll create a dictionary of questions and answers. Whenever your voice command matches one of the questions in the dictionary, the VPA speaks the answer from the dictionary. This enables the VPA to answer certain questions in a very particular way, instead of obtaining an answer from Wikipedia or WolframAlpha. </p>
<p><span epub:type="pagebreak" title="322" id="Page_322"/>After that, you’ll add the following functionalities:</p>
<ul>
<li>The voice-activated music player from <span class="xref" itemid="xref_target_Chapter 5">Chapter 5</span></li>
<li>The voice-activated NPR News Now from <span class="xref" itemid="xref_target_Chapter 6">Chapter 6</span></li>
<li>The voice-activated radio functionality from <span class="xref" itemid="xref_target_Chapter 6">Chapter 6</span></li>
<li>The voice-activated Connect Four game from <span class="xref" itemid="xref_target_Chapter 13">Chapter 13</span> (and the tic-tac-toe game from the exercises) </li>
<li>Stock price functionality that lets you find out the latest price of US stocks and their index values from <span class="xref" itemid="xref_target_Chapter 15">Chapter 15</span></li>
<li>Translator functionality that renders English phrases in any major world language in <span class="xref" itemid="xref_target_Chapter 16">Chapter 16</span></li>
</ul>
<p>The whole idea of a VPA is its convenience, so we’ll make adjustments in these projects so that all added functionalities are 100 percent hands-free. After a functionality is finished, the VPA will go back to the main menu and wait for your voice command.</p>
<p>As usual, all scripts in this chapter are available at the book’s resources page, <a href="https://www.nostarch.com/make-python-talk/" class="LinkURL">https://www.nostarch.com/make-python-talk/</a>. Start by creating the folder <em>/mpt/ch17/ </em>for this chapter.</p>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="box">
<h2>New Skills </h2>
<ul>
<li>Creating a chatting functionality</li>
<li>Reading JSON data saved in a JSON file</li>
<li>Modularizing six versions of tic-tac-toe or Connect Four</li>
<li>Understanding the difference between naming and calling a function</li>
<li>Adapting the functionality of existing projects so your VPA is 100 percent hands-free</li>
</ul>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<h2 id="h1-501560c17-0001">	An Overview of the Final VPA</h2>
<p class="BodyFirst">Let’s have a look at the complete script of our final VPA. I’ll then explain its individual functionalities one by one. </p>
<p>First you need to download several local module files. From the book’s resources page (<a href="https://www.nostarch.com/make-python-talk/" class="LinkURL">https://www.nostarch.com/make-python-talk/</a>), find the following files from the <em>/mpt/mptpkg/ </em>directory: <em>mymusic.py</em>, <em>mynews.py</em>, <em>myradio.py</em>, <em>myttt.py</em>, <em>myconn.py</em>, <em>mystock.py</em>, and <em>mytranslate.py</em>. Put them in the same directory as your self-made local package files (refer to <span class="xref" itemid="xref_target_Chapter 5">Chapter 5</span> for instructions). Make sure to place them in the package folder <em>/mpt/mptpkg/</em> instead of the chapter folder <em>/mpt/ch17/</em>. Later in this chapter, I’ll explain the purpose of these files.</p>
<p><span epub:type="pagebreak" title="323" id="Page_323"/>Next, open <em>__init__.py</em> from <em>/mpt/mptpkg/</em>. You began this file in <span class="xref" itemid="xref_target_Chapter 5 ">Chapter 5 </span>and modified it in Chapters <span class="xref" itemid="xref_target_7 ">7 </span>and <span class="xref" itemid="xref_target_8">8</span>, so it should currently look something like this:</p>
<pre><code>from .mysr import voice_to_text
from .mysay import print_say
<var>--snip--</var>
from .myknowall import know_all</code></pre>
<p>Add the seven lines of code in <a href="#listing17-1" id="listinganchor17-1">Listing 17-1</a> to the end of <em>__init__.py</em>.</p>
<pre><code>from .mymusic import music_play, music_stop
from .mynews import news_brief, news_stop
from .myradio import live_radio, radio_stop
from .myttt import ttt
from .myconn import conn
from .mystock import stock_market, stock_price
from .mytranslate import voice_translate</code></pre>
<p class="CodeListingCaption"><a id="listing17-1">Listing 17-1</a>: Importing functions from local modules to the local package</p>
<p>This code imports the 11 functions (<code>music_play()</code>, <code>music_stop()</code>, and so on) from the seven modules to the local package so you can later import them at the package level. </p>
<p>Open the script <em>vpa.py</em> from <span class="xref" itemid="xref_target_Chapter 8">Chapter 8</span> and add the highlighted parts in <a href="#listing17-2" id="listinganchor17-2">Listing 17-2</a>. Save the new script as <em>vpa_final.py</em>. You can also download the script from the book’s resources. </p>
<pre><code><b>import random</b>
<b>import json</b>

<span class="LiteralGray"># Ensure the following functions are imported in /mpt/mptpkg/__init__.py</span>
<span class="LiteralGray">from mptpkg import voice_to_text, print_say, wakeup, timer,\</span>
<span class="LiteralGray">alarm, joke, email, know_all, music_play, music_stop,\</span>
<span class="LiteralGray">news_brief, news_stop, live_radio, radio_stop, ttt,\</span>
<span class="LiteralGray">conn, stock_price, stock_market, voice_translate</span>

<b># Open chats.json and put it in a dictionary</b>
<b>with open('chats.json','r') as content:</b>
<b>    chats = json.load(content)</b>
<span class="LiteralGray"># Put the script in standby</span>
<span class="LiteralGray">while True:</span>
<var>--snip--</var>
<span class="LiteralGray">        # The script goes back to standby if you choose</span>
<span class="LiteralGray">        if "back" in inp and "stand" in inp:</span>
<span class="LiteralGray">            print_say('OK, back to standby, let me know if you need help!')</span>
<span class="LiteralGray">            break</span>
        # Activate chatting 
        elif inp in list(chats.keys()):
            print_say(random.choice(chats[inp]))
            continue  
        # Activate music 
<span epub:type="pagebreak" title="324" id="Page_324"/>        elif "music by" in inp:
            music_play(inp)
            # Say stop to stop the music anytime
            while True:
                background = voice_to_text().lower()
                if "stop" in background:
                    music_stop()
                    break
                else:
                    continue
        # Activate news 
        elif "npr news" in inp:
            news_brief()
            # Say stop to stop the news anytime
            while True:
                background = voice_to_text().lower()
                if "stop" in background:
                    news_stop()
                    break
                else:
                    continue
        # Activate the radio
        # Put chromedriver.exe in the same folder as this script  
        elif "live radio" in inp:
            live_radio()
            # Say stop to stop the radio anytime
            while True:
                background = voice_to_text().lower()
                if "stop" in background:
                    radio_stop()
                    break
                else:
                    continue
        # Activate the tic-tac-toe game
        elif "tic" in inp and "tac" in inp and "toe" in inp:
            ttt()
            continue
        # Activate the Connect Four game
        elif "connect" in inp and ('4' in inp or 'four' in inp):
            conn()
            continue
        # Activate the stock price functionality
        elif "stock price of" in inp:
            stock_price(inp)
            continue
        # Get market indexes
        elif "stock market" in inp:
            stock_market()
            continue
        # Activate the voice translator
          elif "how to say" in inp and " in " in inp:
            voice_translate(inp)
            continue
<span epub:type="pagebreak" title="325" id="Page_325"/><span class="LiteralGray">        # Activate the timer </span>
<span class="LiteralGray">        elif "timer for" in inp and ("hour" in inp or "minute" in inp):</span>
<span class="LiteralGray">            timer(inp)</span>
<span class="LiteralGray">            continue</span>
<var>--snip--</var></code></pre>
<p class="CodeListingCaption"><a id="listing17-2">Listing 17-2</a>: Your final VPA</p>
<p>We first import the functions <code>voice_to_text()</code>, <code>print_say()</code>, <code>wakeup()</code>, and so on from the local package <em>mptpkg</em>. We already imported these functions in <em>__init__.py</em> from the local modules to the local package <em>mptpkg</em>, so here we import the functions at the package level directly. Further, since the custom package <em>mptpkg</em> is installed on your computer (in editable mode), the system knows where to find the files, and there is no need to tell the script where to look. </p>
<p>We then add the functionalities to the script using a series of <code>elif</code> statements. We start with the chatting functionality. We’ve prepared eight pairs of questions and answers and put them in the dictionary <code>chats</code>. If your voice input matches one of the eight questions, the chatting functionality is activated, and your VPA will speak the corresponding answer from <code>chats</code>.</p>
<p>The music functionality is activated by the phrase <em>music by</em>. The script will retrieve the artist’s name you speak after saying “Music by . . .” and will play a random song by that artist.</p>
<p>The news functionality is activated by the phrase <em>NPR news</em>. The script will extract and play the audio file of the latest news brief from <em>NPR News Now</em>. You can say “Stop” to stop the news, and the script will go back to the main menu and ask, “How may I help you?”</p>
<p>The radio functionality is activated by the phrase <em>live radio</em>. The script will play streaming audio from an online radio station. You can say “Stop” anytime to return to the main menu.</p>
<p>The tic-tac-toe functionality is activated by the words <em>tic</em>, <em>tac</em>, and <em>toe</em> together. A game board will appear on the screen, and before the game starts, you can choose to play first or second as well as against a person, a simple computer, or a smart computer.</p>
<p>The Connect Four functionality is activated by the words <em>connect</em> and <em>four</em> together (or <code>4</code> in text). A game board will appear on the screen, and you can choose to play first or second as well as against a person, a simple computer, or a smart computer. </p>
<p>The stock price functionality is activated by the phrase <em>stock price of</em>. The script will extract the company name you speak after “Stock price of . . .” and tell you the latest price.</p>
<p>The stock market functionality is activated by the phrase <em>stock market</em>. The script will tell you the values of the major indexes of the US stock market.</p>
<p>The voice translator functionality is activated by the phrase <em>how to say</em> together with the word <em>in</em>. The script will extract the English phrase you want to translate and the foreign language into which to translate it, then give you the translation aloud. </p>
<p>Let’s look at the individual functionalities one by one in detail.</p>
<h2 id="h1-501560c17-0002"><span epub:type="pagebreak" title="326" id="Page_326"/>	The Chatting Functionality</h2>
<p class="BodyFirst">This chatting functionality is new. It will allow the VPA to provide a predefined answer that you specify in the code, instead of an answer from Wikipedia or WolframAlpha. We’re building a simple chat bot with only eight questions, but interested readers can use the principles here to create a more sophisticated chatting functionality with more questions and answers. It might also be interesting to extend this functionality with artificial intelligence.</p>
<p>We’ll create a dictionary of questions and answers. Enter the text in <a href="#listing17-3" id="listinganchor17-3">Listing 17-3</a> and save it as the file <em>chats.json</em> in <em>/mpt/ch17/.</em> These are our question-response pairs.</p>
<pre><code>{
"how are you":["i am good","i am fine"],
"who are you":["i am a Python script","i am a computer script"],
"what are your hobbies":["a script doesn't have hobbies"],
"what's your favorite color":["blue","white"],
"hi":["hi","hello"],
"hello":["hello","hi"],
"what can you do":["lots of things, try me"],
"how old are you":["a script doesn't have age",
"good question, I don't really know the answer to that"]}</code></pre>
<p class="CodeListingCaption"><a id="listing17-3">Listing 17-3</a>: The eight pairs of questions and answers in the chatting functionality</p>
<p>The file is in JSON format, meaning it can be shared among different script languages. </p>
<p>To make the chatting functionality more interesting, we’ve prepared multiple answers to some questions. Python will read the JSON file and load the data into a dictionary object. The values are all Python lists, and the script will randomly select an answer from the list. For example, if the question is <code>who are you</code>, the answer will be either <code>i am a Python script</code> or <code>i am a computer script</code>.</p>
<p>Let’s zoom in on the parts in <em>vpa_final.py</em> relevant to the chatting functionality:</p>
<pre><code>import import random
import json
<var>--snip--</var>
with open('chats.json', 'r') as content:
    chats = json.load(content)
<var>--snip--</var>
        # Activate chatting 
      <span class="CodeAnnotationCode" aria-label="annotation1">1</span> elif inp in list(chats.keys()):
            print_say(random.choice(chats[inp]))
            continue
<var>--snip--</var></code></pre>
<p>We import two modules. The <em>random</em> module is used to randomly select an answer. The <em>json</em> module reads the JSON data. Both modules are in the Python Standard Library, so installation is not needed.</p>
<p><span epub:type="pagebreak" title="327" id="Page_327"/>Then we open <em>chats.json</em> and read the content as a large string variable. We use the <code>load()</code> function in the <em>json</em> module to load it into the dictionary <code>chats</code>. When you run the VPA script, your voice is captured and converted to text and stored in the string variable <code>inp</code>. If your question matches one of the eight questions in <code>chats</code>, the chatting functionality is activated <span class="CodeAnnotation" aria-label="annotation1">1</span>. Note that <code>list(chats.keys())</code> produces the list of the eight keys in <code>chats</code>, and if you print the list, it looks like this:</p>
<pre><code>["how are you", "who are you", "what are your hobbies", "what's your favorite 
color", "hi", "hello", "what can you do", "how old are you"] </code></pre>
<p>The script uses <code>inp</code> as the key to locate the corresponding value, which is a list with one or two answers in it. The script randomly selects an answer from the list and speaks it out. </p>
<p>Here’s one example interaction, with my voice input in bold:</p>
<pre><code><var>--snip--</var>
how may I help you?
you just said <b>hello</b>
hello

how may I help you?
you just said <b>who are you</b>
i am a computer script

how may I help you?
you just said <b>what can you do</b>
lots of things, try me

how may I help you?
you just said <b>how old are you</b>
a script doesn't have age
<var>--snip--</var></code></pre>
<p>After the computer asked, “How may I help you?” I said, “Hello” to the microphone. Since <code>hello</code> is one of the eight questions, the chatting functionality was activated, and the computer selected one of the two answers (in this case, <code>hello</code>). </p>
<p>I then asked three more questions: Who are you? What can you do? How old are you? They all activated the chatting functionality. </p>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="box">
<h2>Try it Out </h2>
<p class="BoxBodyFirst">Run <em>vpa_final.py</em> and ask a question to activate the chatting functionality. Then add two of your own question-and-answer pairs to <em>chats.</em><em>json</em>. Run <em>vpa_final.py</em> again and activate the chatting functionality twice by asking the two questions.</p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<h2 id="h1-501560c17-0003"><span epub:type="pagebreak" title="328" id="Page_328"/>	The Music Functionality</h2>
<p class="BodyFirst">We’ll modify the script <em>play_selena_gomez.py</em> from <span class="xref" itemid="xref_target_Chapter 5">Chapter 5</span> and add music functionality to our final VPA. You’ll create a music module and import it to the main script.</p>
<h3 id="h2-501560c17-0001">Create a Music Module</h3>
<p class="BodyFirst">Open the file <em>mymusic.py</em> you just downloaded from the book’s resources and saved in your local package folder <em>/mpt/mptpkg</em>. The code is shown in <a href="#listing17-4" id="listinganchor17-4">Listing 17-4</a>.</p>
<pre><code>import os
import random
<span class="CodeAnnotationHang" aria-label="annotation1">1</span> from pygame import mixer

from mptpkg import print_say

# Define a function to play music
<span class="CodeAnnotationHang" aria-label="annotation2">2</span> def music_play(v_inp):
    # Extract artist name
    pos = v_inp.find("music by ")
    v_inp = v_inp[pos+len('music by '):]
    # Separate first and last names
    names = v_inp.split()
    # Extract the first name
    firstname = names[0]
    # Extract the last name
    if len(names)&gt;1:
        Lastname = names[1]
    # If no last name, use first name as placeholder
    else:
        lastname = firstname
    # Create a list to contain songs 
    mysongs = []
    # If either first name or last name in the filename, put in list
    with os.scandir("../ch05/chat") as files:
        for file in files:
            if (firstname in file.name.lower() or lastname\
                in file.name.lower()) and "mp3" in file.name:
                mysongs.append(file.name)
    # Let you know if no song by the artist
    if len(mysongs) == 0:
        print_say(f"I cannot find any song by {names}.")
    else:
        # Randomly select one from the list and play
        mysong = random.choice(mysongs)
        print_say(f"play the song {mysong} for you.")
        mixer.init()
        mixer.music.load(f'../ch05/chat/{mysong}')
        mixer.music.play()

# Define a function to stop music
<span class="CodeAnnotationHang" aria-label="annotation3">3</span> def music_stop(): 
<span epub:type="pagebreak" title="329" id="Page_329"/>    try:
        mixer.music.stop()
    except:
        print('no music to stop')</code></pre>
<p class="CodeListingCaption"><a id="listing17-4">Listing 17-4</a>: The script to add music functionality </p>
<p>In <span class="xref" itemid="xref_target_Chapter 5">Chapter 5</span>, you created the subfolder <em>/chat/</em> in your chapter folder <em>/mpt/ch05/</em> and saved some MP3 files in it. Each filename should contain the artist’s name—for example, <em>SelenaGomezWolves.mp3</em> or <em>katy_perry_roar.mp3</em>—so that the Python script can locate it. A typical song is about four minutes long, which is a long time if you’re given a song that you don’t like, so you also learned how to stop the song while it’s playing. The <em>playsound</em> and <em>pydub</em> modules don’t allow the script to execute the next line of code while the song is playing, but with <em>pygame</em>, the script does move to the next line of code while the song is playing, allowing you to stop a song. </p>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="note">
<h2><span class="NoteHead">NOTE</span></h2>
<p>	If you cannot install <em>p</em><em>ygame</em> on your computer, you can use the <em>vlc</em> module, which also allows you to stop the song while it is playing. See <span class="xref" itemid="xref_target_Appendix A">Appendix A</span> for instructions on how to install the four modules that play audio files: <em>pygame</em>, <em>vlc</em>, <em>playsound</em>, and <em>pydub</em>. </p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<p>At <span class="CodeAnnotation" aria-label="annotation1">1</span>, we import the <code>mixer</code> module from <em>pygame</em>, which can play audio files. At <span class="CodeAnnotation" aria-label="annotation2">2</span>, we start defining the <code>music_play()</code> function, which takes a voice command <code>v_inp</code> as its argument. We locate the phrase <em>music by</em> in the voice command and use that to extract the artist name. </p>
<p>We use the <code>split()</code> function to separate the first name and last name and associate them with the variables <code>firstname</code> and <code>lastname</code>. The script then goes into the appropriate folder and selects a song with the artist’s first name or last name to play. Note here that we use <code>../ch05/chat</code> to access the subfolder <em>/chat</em> in the parallel folder <em>/mpt/ch05</em>. </p>
<p>We also define a <code>music_stop()</code> function, which will stop the music playing <span class="CodeAnnotation" aria-label="annotation3">3</span>. We use <code>try</code> and <code>except</code> here in case the script misunderstands your voice input and tells you that no song by the artist can be found. If that happens, you can still say “Stop” to go back to the main menu without crashing the script. </p>
<h3 id="h2-501560c17-0002">Activate the Music Functionality</h3>
<p class="BodyFirst">Next, you’ll add the music module to the final VPA. Here’s the part of <em>vpa_final.py</em> that’s relevant for the music functionality:</p>
<pre><code><var>--snip--</var>
from mptpkg import music_play, music_stop
<var>--snip--</var>
        # Activate music 
      <span class="CodeAnnotationCode" aria-label="annotation1">1</span> elif "music by" in inp:
            music_play(inp)
            # Say stop to stop the music any time
<span epub:type="pagebreak" title="330" id="Page_330"/>          <span class="CodeAnnotationCode" aria-label="annotation2">2</span> while True:
                background = voice_to_text().lower()
                if "stop" in background:
                    music_stop()
                    break
                else:
                    continue
<var>--snip--</var></code></pre>
<p>We import <code>music_play()</code> and<code> music_stop()</code>, which you just created, and then check for the activation phrase <em>music by</em> <span class="CodeAnnotation" aria-label="annotation1">1</span>. Once activated, the <code>music_play()</code> function is called, with your voice input taken as the argument. </p>
<p>While the music is playing, the script continues to execute the next line of code, which starts an infinite loop listening for your voice input in the background <span class="CodeAnnotation" aria-label="annotation2">2</span>. Any detected voice input is converted to the variable <code>background</code>. If the word <em>stop</em> is detected, the <code>music_stop()</code> function is called. If the word <em>stop</em> isn’t detected, the script goes to the next iteration and continues listening for background voice input.</p>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="note">
<h2><span class="NoteHead">WARNING</span></h2>
<p>	Make sure to keep your speaker volume relatively low. If it’s too high, the music will drown out your voice input, and it will be hard for the script to pick up your command and stop the music. </p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<p>Here’s an example interaction with the music functionality, with my voice input in bold:</p>
<pre><code><var>--snip--</var>
how may I help you?
you just said <b>play music by katy perry</b>
play the song KatyPerry- Hey Hey Hey.mp3 for you</code></pre>
<p>After about one minute of that tune, I said, “Stop playing.” The music stopped playing, and the script went back to the main menu and asked, “How may I help you?” </p>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="note">
<h2><span class="NoteHead">NOTE</span></h2>
<p>	Even after the song finishes playing, you need to say “Stop” to go back to the main menu. If the script misunderstands your voice input and tells you that no song by the artist can be found, you also need to say “Stop” to go back to the main menu. </p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="box">
<h2>Try it Out</h2>
<p class="BoxBodyFirst">Save several songs by your favorite artist in the subfolder <em>/mpt/ch</em><em>05</em><em>/chat</em>. Run <em>vpa_final.py</em> and activate the music functionality. Stop the song after a minute or so.</p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<h2 id="h1-501560c17-0004"><span epub:type="pagebreak" title="331" id="Page_331"/>	The News Brief Module</h2>
<p class="BodyFirst">We’ll modify the script <em>npr_news.py</em> from <span class="xref" itemid="xref_target_Chapter 6">Chapter 6</span> and add a news functionality to our final VPA. You’ll create a news module and import it to the main script.</p>
<h3 id="h2-501560c17-0003">Create a News Module</h3>
<p class="BodyFirst">The script <em>mynews.py</em> in <a href="#listing17-5" id="listinganchor17-5">Listing 17-5</a> creates the news module. This file is available from the book’s resources and needs to be saved in the local package directory.</p>
<pre><code>from random import choice

import requests
import bs4
<span class="CodeAnnotationHang" aria-label="annotation1">1</span> from pygame import mixer

# Define news_brief() function
<span class="CodeAnnotationHang" aria-label="annotation2">2</span> def news_brief():
    # Locate the website for the NPR news brief
    url = 'https://www.npr.org/podcasts/500005/npr-news-now'
    # Convert the source code to a soup string
    response = requests.get(url)
    response.raise_for_status()
    soup = bs4.BeautifulSoup(response.text, 'html.parser')
    # Locate the tag that contains the mp3 files
    casts = soup.findAll('a', {'class': 'audio-module-listen'})
    # Obtain the weblink for the mp3 file related to the latest news brief
    cast = casts[0]['href']
    pos = cast.find("?")
    # Download the mp3 file
  <span class="CodeAnnotationCode" aria-label="annotation3">3</span> mymp3 = cast[0:pos]
    x = choice(range(1000000))
    mymp3_file = requests.get(mymp3)
    with open(f'f{x}.mp3','wb') as f:
        f.write(mymp3_file.content)
    # Play the mp3 file
    mixer.init()
    mixer.music.load(f'f{x}.mp3')
  <span class="CodeAnnotationCode" aria-label="annotation4">4</span> mixer.music.play()

# Define the news_stop() function
<span class="CodeAnnotationHang" aria-label="annotation5">5</span> def news_stop():
    try:
        mixer.music.stop()
    except:
        print('no news to stop')</code></pre>
<p class="CodeListingCaption"><a id="listing17-5">Listing 17-5</a>: The script to create a news functionality </p>
<p>At <span class="CodeAnnotation" aria-label="annotation1">1</span>, we import <code>mixer</code> from <em>pygame</em>. We’ll use the <em>pygame</em> module so that we can stop the news brief anytime. At <span class="CodeAnnotation" aria-label="annotation2">2</span>, we define <code>news_brief()</code>. When this <span epub:type="pagebreak" title="332" id="Page_332"/>function is called, the script goes to the NPR news website, extracts the MP3 file associated with the latest news brief, and saves it on your computer <span class="CodeAnnotation" aria-label="annotation3">3</span>. The script uses <code>music.play()</code> to play the audio file <span class="CodeAnnotation" aria-label="annotation4">4</span>. </p>
<p>We also define a <code>news_stop()</code> function that will stop playing the news file <span class="CodeAnnotation" aria-label="annotation5">5</span>. </p>
<h3 id="h2-501560c17-0004">Activate the News Functionality</h3>
<p class="BodyFirst">Let’s add the functionality you just created to the final VPA. Here are the parts of <em>vpa_final.py</em> relevant to the news functionality:</p>
<pre><code><var>--snip--</var>
from mptpkg import news_brief, news_stop
<var>--snip--</var>
        # Activate news 
        elif "npr news" in inp:
            news_brief()
            # Say stop to stop the news any time
            while True:
                background = voice_to_text().lower()
                if "stop" in background:
                    news_stop()
                    break
                else:
                    continue 
<var>--snip--</var></code></pre>
<p>We import <code>news_brief()</code> and <code>news_stop()</code> from <em>mynews</em>. We check for the activation phrase <em>NPR News</em> in your voice command. It’s a good idea to say “Play NPR News” or “Tell me the latest NPR news” instead of just “NPR news,” because the first word or two may be cut off due to timing. Putting something in front of “NPR News” provides a buffer.</p>
<p>Once activated, the <code>news_brief()</code> function is called, which extracts the news brief audio file from the <em>NRR News Now</em> website and plays it using <em>pygame</em>. </p>
<p>While the news is broadcasting, the script starts an infinite loop to listen for your voice input in the background, listening for the word <em>stop</em>. If the word is detected, the <code>news_stop()</code> function is called. Otherwise, the script goes to the next iteration and continues listening for background commands.</p>
<p>As with to the music-playing functionality, you need to keep your speaker volume low so you can stop the audio by using voice input. After the news brief is finished, you need to say “Stop” to go back to the main menu. </p>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="box">
<h2>Try it Out</h2>
<p class="BoxBodyFirst">Run <em>vpa_final.py</em> and activate the news functionality. Say “Stop” when the news is finished to go back to the main menu.</p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<h2 id="h1-501560c17-0005"><span epub:type="pagebreak" title="333" id="Page_333"/>	The Live Radio Module</h2>
<p class="BodyFirst">We’ll modify <em>play_live_radio.py</em> from <span class="xref" itemid="xref_target_Chapter 6">Chapter 6</span> and add a radio module to our final VPA. As usual, you’ll create the radio module and import it to the main script.</p>
<h3 id="h2-501560c17-0005">Create a Radio Module</h3>
<p class="BodyFirst">Frist we’ll create a radio module. The script <em>myradio.py</em> is shown in <a href="#listing17-6" id="listinganchor17-6">Listing 17-6</a>. </p>
<pre><code># Put chromedriver.exe in the same folder as vpa_final.py 
from selenium import webdriver
from selenium.webdriver.chrome.options import Options

<span class="CodeAnnotationHang" aria-label="annotation1">1</span> def live_radio():
    global button
    chrome_options = Options()  
    chrome_options.add_argument("--headless")
    browser = webdriver.Chrome(executable_path='./chromedriver',\
                               chrome_options=chrome_options)
    browser.get("https://onlineradiobox.com/us/")
    button = browser.find_element_by_xpath('//*[@id="b_top_play"]')
    button.click()

<span class="CodeAnnotationHang" aria-label="annotation2">2</span> def radio_stop():
    global button
    try:
        button.click()
    except:
        print('no radio to stop')</code></pre>
<p class="CodeListingCaption"><a id="listing17-6">Listing 17-6</a>: The script to create livestreaming radio functionality </p>
<p>First, you need to put the file <em>chromedrive.exe in</em> the same folder as the VPA script (that is, in <em>/mpt/ch17</em>). At <span class="CodeAnnotation" aria-label="annotation1">1</span>, we define the <code>live_radio()</code> function. We make <code>button</code> a global variable so we can use it again later in another function. We use the <code>headless</code> option, which provides the same functionalities as the regular Chrome browser but does not display the browser window on the desktop. Then we define <code>button</code> as the play button on the online radio station Online Radio Box. The button is clicked via voice control so that the radio starts streaming when <code>live_radio()</code> is called.</p>
<p>At <span class="CodeAnnotation" aria-label="annotation2">2</span>, we define a <code>radio_stop()</code> function that stops the radio playing. Note here that we need to make <code>button</code> a global variable as well so that it can be modified in <code>radio_stop()</code>. </p>
<h3 id="h2-501560c17-0006">Activate the Radio Functionality</h3>
<p class="BodyFirst">Next, add the radio functionality you just created to the final VPA. Here are the relevant parts of <em>vpa_final.py</em>:</p>
<pre><code><var>--snip--</var>
from mptpkg import live_radio, radio_stop
<span epub:type="pagebreak" title="334" id="Page_334"/><var>--snip--</var>
        # Activate the radio 
        # Put chromedriver.exe in the same folder as this script
        elif "live radio" in inp:
            live_radio()
            # Say stop to stop the radio anytime
            while True:
                background = voice_to_text().lower()
                if "stop" in background:
                    radio_stop()
                    break
                else:
                    continue 
<var>--snip--</var></code></pre>
<p>We first import the <code>live_radio()</code> and <code>radio_stop()</code> functions you just created from the local <em>mptpkg</em> package. We listen for the activation phrase <em>live radio</em>. Again, it’s a good idea to include a word or two in front of “live radio” to provide a buffer.</p>
<p>Once activated, <code>live_radio()</code> is called, which goes to Online Radio Box and clicks the play button to stream the audio. </p>
<p>While the radio is playing, the script starts an infinite loop to listen for background voice input, which if detected is stored in <code>background</code>. If the word <em>stop</em> is detected, <code>radio_stop()</code> is called to press the play button again so that the audio stops streaming. Otherwise, the script goes to the next iteration and listens for background voice commands.</p>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="box">
<h2>Try it Out</h2>
<p class="BoxBodyFirst">Run <em>vpa_final.py</em> and activate the radio functionality. Stop the radio after a minute or so.</p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<h2 id="h1-501560c17-0006">	The Tic-Tac-Toe Module</h2>
<p class="BodyFirst">We’ll add a tic-tac-toe module so you can voice-activate the game and play with the computer 100 percent hands-free. Here, we use one script to offer six versions of the tic-tac-toe game: you can choose to play against another person, a simple computer that makes random moves, or a smart computer that thinks three steps ahead (recall <span class="xref" itemid="xref_target_Chapter 13">Chapter 13</span>). You can also choose to go either first or second.</p>
<p>You’ll create a tic-tac-toe module and import it to the main script.</p>
<h3 id="h2-501560c17-0007">Create a Tic-Tac-Toe Module</h3>
<p class="BodyFirst">First we’ll create a local tic-tac-toe module. The script <em>myttt.py</em> is based on the scripts <em>ttt_hs.py</em> in <span class="xref" itemid="xref_target_Chapter 10">Chapter 10</span> and <em>ttt_think.py</em>, which is the answer to question #5 in the end-of-chapter exercises in <span class="xref" itemid="xref_target_Chapter 13">Chapter 13</span> and is available at the book’s resources website. I highlight the key parts of <em>myttt.py</em> in <a href="#listing17-7" id="listinganchor17-7">Listing 17-7</a>. </p>
<pre><code><span epub:type="pagebreak" title="335" id="Page_335"/><var>--snip--</var>
def ttt():
    t.setup(600,600,100,200)
<var>--snip--</var>
    # Define the smart_computer() function
  <span class="CodeAnnotationCode" aria-label="annotation1">1</span> def smart_computer():
        if turn == "blue":
            nonturn = "white"
        else:
            nonturn = "blue"
        # Choose center at the first move
        if "5" in validinputs:
            return "5"
<var>--snip--</var>
        for move in valids:
            tooccupy = deepcopy(occupied)
            tooccupy[turn].append(move)
            if win_game(tooccupy,turn) == True:
                winner.append(move)
<var>--snip--</var>
    # Obtain move from a human player
  <span class="CodeAnnotationCode" aria-label="annotation2">2</span> def person():
        print_say(f"Player {turn}, what's your move?")
        return voice_to_text().lower()
    # Obtain a move from a simple computer
  <span class="CodeAnnotationCode" aria-label="annotation3">3</span> def simple_computer():
        return choice(validinputs)
    # Ask you for your choice of opponent
  <span class="CodeAnnotationCode" aria-label="annotation4">4</span> while True:
        print_say('''Do you want your opponent to be a person,
        a simple computer, or a smart computer?''')
        which_player = voice_to_text().lower()
        print_say(f"You said {which_player}.")
        if 'person' in which_player:
            player = person
            break
        elif 'simple' in which_player:
            player = simple_computer
            break
        elif 'smart' in which_player:
            player = smart_computer
            break
    # Ask if you want to play first or second
  <span class="CodeAnnotationCode" aria-label="annotation5">5</span> while True:
        print_say("Do you want to play first or second?")
        preference = voice_to_text().lower()
        print_say(f"You said {preference}.")
        if 'first' in preference:
            preference = 1
            break
        elif 'second' in preference:
            preference = 2
            break

<span epub:type="pagebreak" title="336" id="Page_336"/>    # Add a dictionary of words to replace
    to_replace = {'number ':'', 'cell ':'', 'column ':'',
                  'one':'1', 'two':'2', 'three':'3',
                  'four':'4', 'for':'4', 'five':'5',
                  'six':'6', 'seven':'7', 'eight':'8','nine':'9'}
   # Start game loop 
    while True:
        # See whose turn to play
      <span class="CodeAnnotationCode" aria-label="annotation6">6</span> if (preference+rounds)%2 == 0:
            print_say(f"Player {turn}, what's your move?")
            inp = voice_to_text().lower()
        else:
          <span class="CodeAnnotationCode" aria-label="annotation7">7</span> inp = player()
            if inp == None:
                inp = choice(validinputs)
      <span class="CodeAnnotationCode" aria-label="annotation8">8</span> print_say(f"Player {turn} chooses {inp}.")
<var>--snip--</var>
        # If the move is a not valid one, remind
      <span class="CodeAnnotationCode" aria-label="annotation9">9</span> if inp not in validinputs:
            print_say("Sorry, that's an invalid move!") 
        # If the move is valid, go ahead  
        else:
            # Go to the cell and place a dot of the player's color
<var>--snip--</var>
  <span class="CodeAnnotationCode" aria-label="annotationa">a</span> try:
        bye()
    except Terminator:
        print('exit turtle')</code></pre>
<p class="CodeListingCaption"><a id="listing17-7">Listing 17-7</a>: The script to create the tic-tac-toe functionality </p>
<p>Unlike in previous tic-tac-toe versions, here we don’t use the <em>messagebox</em> module to remind us about wins, ties, and invalid moves because we cannot use voice commands to remove the message box from the screen. You need to physically click the box to make it disappear. Instead we’ll just print and announce wins, ties, and invalid moves. </p>
<p>We define the <code>ttt()</code> function, which we’ll call from the VPA script to draw the game board and ask whether you want to play against a person, a simple computer, or a smart computer. After that, the script asks whether you want to play first or second. Once the game is over, the board disappears from the screen, and the script goes back to the main menu of the VPA automatically.</p>
<p>In the <code>ttt()</code> function, we use the <code>smart_computer()</code> function <span class="CodeAnnotation" aria-label="annotation1">1</span>, which is based on the <code>best_move()</code> function in <em>ttt_think.py</em> but gives you the option to go first or second. We change <code>blue</code> and <code>white</code> to <code>turn</code> and <code>nonturn</code>, respectively, so the computer can be the white player if it plays second. We also allow the smart computer to occupy cell 5 if it’s empty even if it plays second because doing so increases its chance of winning the game.</p>
<p>We then define the <code>person()</code> function <span class="CodeAnnotation" aria-label="annotation2">2</span>, which allows a human player to make a move by using voice commands. Similarly, the <code>simple_computer()</code> function allows the computer to make a random move <span class="CodeAnnotation" aria-label="annotation3">3</span>.</p>
<p><span epub:type="pagebreak" title="337" id="Page_337"/>At <span class="CodeAnnotation" aria-label="annotation4">4</span>, we start an infinite loop. At each iteration, the script asks whether you want to choose a person, a simple computer, or a smart computer as your opponent. If your answer includes <em>person</em>, the variable <code>player</code> will be assigned a value of <code>person</code>. If your answer includes <em>simple</em> or <em>smart</em>, <code>player</code> will be assigned a value of <code>simple_computer</code> or <code>smart_computer</code>. Later, when we call the <code>player()</code> function, one of the three functions <code>person()</code>, <code>simple_computer()</code>, or <code>smart_computer()</code> will be called, depending on which function name is stored in <code>player</code>. </p>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="note">
<h2><span class="NoteHead">NOTE</span></h2>
<p>	Pay attention to the difference between a function name and the calling of a function. For example, <code>smart_computer</code> is just a function name, while <code>smart_computer()</code> calls the function and executes all command lines in it. What a difference the parentheses make!</p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<p>At <span class="CodeAnnotation" aria-label="annotation5">5</span>, we start an infinite loop to determine whether you want to play first or second. If your answer includes <em>first</em>, the variable <code>preference</code> will be assigned a value of <code>1</code>. If your answer includes <em>second</em>, <code>preference</code> is assigned a value of <code>2</code>. </p>
<p>We then start the game loop. At each iteration, we first determine whether you or your opponent has the turn, based on the values of <code>preference</code> and <code>rounds</code> <span class="CodeAnnotation" aria-label="annotation6">6</span>. For example, if you choose to play first, the value of <code>preference</code> is <code>1</code>, and when the game starts, the value of <code>rounds</code> is <code>1</code>. So the condition <code>(preference+rounds)%2==0</code> is met, and you’ll have the first turn at the beginning of the game. </p>
<p>When it’s your opponent’s turn <span class="CodeAnnotation" aria-label="annotation7">7</span>, the <code>player()</code> function is called. This means one of the three functions, <code>person()</code>, <code>simple_computer()</code>, or <code>smart_computer()</code>, is called, depending on the value stored in the <code>player</code> variable. The script announces the move <span class="CodeAnnotation" aria-label="annotation8">8</span>. If the move is not valid, the script asks you or your opponent to choose again <span class="CodeAnnotation" aria-label="annotation9">9</span>. Otherwise, a piece is placed on the game board. </p>
<p>Finally, when the game ends, we do not include the <code>done()</code> function in the script. As you may recall from the script <em>guess_letter.py</em> in <span class="xref" itemid="xref_target_Chapter 12">Chapter 12</span>, without <code>done()</code>, the script goes to the <code>bye()</code> function after the <code>while</code> loop is finished. This way, the game board will disappear from the screen <span class="CodeAnnotation" aria-label="annotationa">a</span>, and you can go back to the main menu of your VPA script.</p>
<h3 id="h2-501560c17-0008">Activate Tic-Tac-Toe </h3>
<p class="BodyFirst">Let’s now add the tic-tac-toe functionality to the final VPA. Here are the relevant parts of the script <em>vpa_final.py</em>:</p>
<pre><code><var>--snip--</var>
from mptpkg import ttt
<var>--snip--</var>
        # Activate the tic-tac-toe game
        elif "tic" in inp and "tac" in inp and "toe" in inp:
            ttt()
            continue 
<var>--snip--</var></code></pre>
<p><span epub:type="pagebreak" title="338" id="Page_338"/>We import the <code>ttt()</code> function you just created from the local <em>mptpkg</em> package. To activate the tic-tac-toe game, you need to include <em>tic</em>, <em>tac</em>, and <em>toe</em> in your voice command. Once the game is over, the game board disappears, and you’ll go back to the main menu. </p>
<p>Here’s an example of one interaction, with my voice input in bold:</p>
<pre><code><var>--snip--</var>
How may I help you?
You just said <b>play tic-tac-toe</b>.

Do you want your opponent to be a person, a simple computer, or a smart computer?
You said <b>simple computer</b>.

Do you want to play first or second?
You said <b>first</b>.

Player blue, what's your move?
Player blue chooses <b>5</b>.
Player white chooses 9.

Player blue, what's your move?
Player blue chooses <b>number 7</b>.
Player white chooses 6.

Player blue, what's your move?
Player blue chooses <b>number three</b>.
Congrats player blue, you won!

How may I help you?
<var>--snip--</var></code></pre>
<p>I activated the game by saying “Play tic-tac-toe.” I then chose to play first against a simple computer as my opponent. I won the game by occupying cells 5, 7, and 3.</p>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="box">
<h2>Try it Out</h2>
<p class="BoxBodyFirst">Run <em>vpa_final.py</em> and activate the tic-tac-toe functionality. Play a game with the smart computer and let the computer move first.</p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<h2 id="h1-501560c17-0007">	The Connect Four Module</h2>
<p class="BodyFirst">At this point, adding the Connect Four module should be straightforward. We can modify the tic-tac-toe module and change the game to Connect Four. Then you’ll import the local module to the main script.</p>
<h3 id="h2-501560c17-0009"><span epub:type="pagebreak" title="339" id="Page_339"/>Create a Connect Four Module</h3>
<p class="BodyFirst">First we’ll create a Connect Four module. The script <em>myconn.py</em> is based on <em>conn_think_hs.py</em> in <span class="xref" itemid="xref_target_Chapter 13">Chapter 13</span> and <em>myttt.py</em>, which you just created. Again, we won’t use <em>messagebox</em> to remind us about wins, ties, and invalid moves. We’ll define a <code>conn()</code> function so that when the function is called, the game appears onscreen and you can start playing. </p>
<p>As in the tic-tac-toe module, you can choose who goes first and who your opponent is. We change <code>red</code> and <code>yellow</code> to <code>turn</code> and <code>nonturn</code>, respectively, so that the computer can be the yellow player if it plays second. </p>
<p>To save space, I won’t explain <em>myconn.py</em> in detail here, but it’s available at the book’s resources, in the folder <em>/mpt/mptpkg</em>. Open it now and take a look; then go back to the main script for the VPA.</p>
<h3 id="h2-501560c17-0010">Activate Connect Four</h3>
<p class="BodyFirst">Add the Connect Four module you just created to the final VPA, shown here in <em>vpa_final.py</em>:</p>
<pre><code><var>--snip--</var>
from mptpkg import conn
<em>--snip</em><em>--</em>
        # Activate Connect Four 
        elif "connect" in inp and ('4' in inp or 'four' in inp):
            conn()
            continue 
<var>--snip--</var></code></pre>
<p>We import the <code>conn()</code> function you just created from the local <em>mptpkg</em> package. We listen for the activation phrase <em>Connect Four</em> in your voice command. Note that the script may convert your voice as either <code>connect four</code> or <code>connect 4</code>. As a result, we need to use <code>'4' in inp or 'four' in inp</code> to cover both cases. </p>
<p>Here is one sample output from a game:</p>
<pre><code><var>--snip--</var>
How may I help you?
You just said <b>play connect four</b>.

Do you want your opponent to be a person, a simple computer, or a smart computer?
You said <b>smart computer</b>.

Do you want to play first or second?
You said <b>second</b>.
Player red chooses 4.

Player yellow, what's your move?
Player yellow chooses <b>number three</b>.
Player red chooses 1.

Player yellow, what's your move?
<span epub:type="pagebreak" title="340" id="Page_340"/>Player yellow chooses <b>number three</b>.
Player red chooses 5.

Player yellow, what's your move?
Player yellow chooses <b>number three</b>.
Player red chooses 3.

Player yellow, what's your move?
Player yellow chooses <b>number two</b>.
Player red chooses 7.

Player yellow, what's your move?
Player yellow chooses <b>number two</b>.
Player red chooses 6.
Congrats player red, you won!

How may I help you?
<var>--snip--</var></code></pre>
<p>I chose to play second against the smart computer. By connecting four discs horizontally in columns 4, 5, 7, and 6, the smart computer wins the game.</p>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="box">
<h2>Try it Out</h2>
<p class="BoxBodyFirst">Run <em>vpa_final.py</em> and activate the Connect Four functionality. Play a game with the simple computer and let the computer play second.</p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<h2 id="h1-501560c17-0008">	The Stock Price Module</h2>
<p class="BodyFirst">Now let’s add stock price functionality to our final VPA, building the module and then importing it.</p>
<h3 id="h2-501560c17-0011">Create a Stock Market–Tracking Module</h3>
<p class="BodyFirst">First we’ll create stock-monitoring functionality. The script <em>mystock.py</em> has the code shown in <a href="#listing17-8" id="listinganchor17-8">Listing 17-8</a>. </p>
<pre><code>import requests
from yahoo_fin import stock_info as si

from mptpkg import print_say

# Define stock_price() function
<span class="CodeAnnotationHang" aria-label="annotation1">1</span> def stock_price(v_inp):
    # Extract company name
    pos = v_inp.find("stock price of")
    myfirm = v_inp[pos+len("stock price of "):]
    # Extract the source code from the website
<span epub:type="pagebreak" title="341" id="Page_341"/>    # Prevent crashing in case there is no result
    try:
        # Extract the source code from the website
      <span class="CodeAnnotationCode" aria-label="annotation2">2</span> url = 'https://query1.finance.yahoo.com/v1/finance/search?q='+myfirm
        response = requests.get(url)
        # Read the JSON data
        response_json = response.json()
        # Obtain the value corresponding to "quotes"
        quotes = response_json['quotes']
        # Get the ticker symbol
        ticker = quotes[0]['symbol']
        # Obtain real-time stock price from Yahoo
      <span class="CodeAnnotationCode" aria-label="annotation3">3</span> price = round(float(si.get_live_price(ticker)),2)
        # Speak the stock price
        print_say(f"the stock price for {myfirm} is {price} dollars")
        # If price is not found, the script will tell you
    except:
        print_say("sorry, I cannot find what you are looking for!")


# Define stock_market() function
<span class="CodeAnnotationHang" aria-label="annotation4">4</span> def stock_market():
    # Obtain real-time index values from Yahoo
    dow = round(float(si.get_live_price('^DJI')),2)
    sp500 = round(float(si.get_live_price('^GSPC')),2)
    # Announces the index values
    print_say(f"The Dow Jones Industry Average is {dow}.")
    print_say(f"The S&amp;P 500 is {sp500}.")</code></pre>
<p class="CodeListingCaption"><a id="listing17-8">Listing 17-8</a>: The script to create stock market–tracking functionality </p>
<p>At <span class="CodeAnnotation" aria-label="annotation1">1</span>, we define the <code>stock_price()</code> function, saving the voice command <code>v_inp</code> as the argument. We then locate the company name in your voice command and use that to extract the ticker symbol of the firm’s stock <span class="CodeAnnotation" aria-label="annotation2">2</span>. The script goes to Yahoo! Finance and obtains the stock price based on the ticker symbol <span class="CodeAnnotation" aria-label="annotation3">3</span>. Finally, the script prints and announces the stock price. </p>
<p>We also define <code>stock_market()</code> <span class="CodeAnnotation" aria-label="annotation4">4</span>. When this function is called, it will retrieve the latest values of the Dow Jones Industrial Average and the S&amp;P 500. The script then prints and announces the two values.</p>
<h3 id="h2-501560c17-0012">Activate the Stock Market–Tracking Functionalities</h3>
<p class="BodyFirst">Now add the stock-monitoring module you just created to the final VPA. Here are the relevant parts of <em>vpa_final.py</em>:</p>
<pre><code><var>--snip--</var>
from mptpkg import stock_market, stock_price
<var>--snip--</var>
        # Activate the stock price functionality
        elif "stock price of" in inp:
            stock_price(inp)
            continue
        # Get market indexes
<span epub:type="pagebreak" title="342" id="Page_342"/>        elif "stock market" in inp:
            stock_market()
            continue
<var>--snip--</var></code></pre>
<p>We first import the <code>stock_price()</code> and <code>stock_market()</code> functions and listen for the activation phrase <em>stock price of</em> in your voice command, such as, “Tell me the stock price of General Motors.” The <code>stock_price()</code> function uses your voice command as the argument and tells you the latest price for the company’s stock. </p>
<p>We then listen for the activation phrase <em>stock market</em> for the <code>stock_market()</code> function. The script retrieves the latest values of the market indexes and announces them to you. </p>
<p>The following is one interaction with the stock module, with my voice input in bold:</p>
<pre><code><var>--snip--</var>
how may I help you?
you just said <b>tell me the stock price of general motors</b>
the stock price for general motors is 24.39 dollars

how may I help you?
you just said <b>tell me about the stock market</b>
the Dow Jones Industry Average is 26075.3
the S&amp;P 500 is 3185.04

how may I help you?
<var>--snip--</var></code></pre>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="box">
<h2>Try it Out</h2>
<p class="BoxBodyFirst">Run <em>vpa_final.py</em> and find the latest stock price of Goldman Sachs. Then find the values of the Dow Jones Industrial Average and S&amp;P 500.</p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<h2 id="h1-501560c17-0009">	The Voice Translator Module</h2>
<p class="BodyFirst">We’ll finally add the translator functionality so that your VPA can translate an English phrase into a foreign language of your choice. </p>
<h3 id="h2-501560c17-0013">Create a Translator Module</h3>
<p class="BodyFirst">First we’ll create a translator module. The script <em>mytranslate.py</em> is shown in <a href="#listing17-9" id="listinganchor17-9">Listing 17-9</a>. </p>
<pre><code>from mptpkg import print_say

<span class="CodeAnnotationHang" aria-label="annotation1">1</span> lang_abbre = {"english":"en",
            "chinese":"zh",
<span epub:type="pagebreak" title="343" id="Page_343"/>            "spanish":"es",
            "french":"fr",
            "japanese":"ja",
            "portuguese":"pt",
            "russian":"ru",
            "korean":"ko",
            "german":"de",
            "italian":"it"}

# Import the platform module to identify your OS
import platform

# If you are using Windows, use gtts
if platform.system() == "Windows": 
    import random
    
    from translate import Translator
    from gtts import gTTS
    from pydub import AudioSegment
    from pydub.playback import play
    
  <span class="CodeAnnotationCode" aria-label="annotation2">2</span> def voice_translate(inp):
        # Extract the phrase and the language name
        ps1 = inp.find('how to say')
        ps2 = inp.rfind(' in ')
        try:
            eng_phrase = inp[ps1+10:ps2]
            tolang = inp[ps2+4:]
            translator = Translator(from_lang="english",to_lang=tolang)
            translation = translator.translate(eng_phrase)
            tts = gTTS(text=translation, lang=lang_abbre[tolang])
            print_say(f"The {tolang} for {eng_phrase} is")
            print(translation)
            x = random.choice(range(1000000))
            tts.save(f'file{x}.mp3')
            play(AudioSegment.from_mp3(f"file{x}.mp3"))
        except:
            print_say("Sorry, cannot find what you are looking for!")

# If you are not using Windows, use gtts-cli
if  platform.system() == "Darwin" or platform.system() == "Linux":
    import os
    from translate import Translator
    from gtts import gTTS

    def voice_translate(inp):
        # Extract the phrase and the language name
        ps1 = inp.find('how to say')
        ps2 = inp.rfind(' in ')
        try:
            eng_phrase = inp[ps1+10:ps2]
            tolang = inp[ps2+4:]
            translator = Translator(from_lang="english",to_lang=tolang)
            translation = translator.translate(eng_phrase)
            print_say(f"The {tolang} for {eng_phrase} is")
<span epub:type="pagebreak" title="344" id="Page_344"/>            print(translation)
            tr = translation.replace('"','')
            ab = lang_abbre[tolang]
          <span class="CodeAnnotationCode" aria-label="annotation3">3</span> os.system(f'gtts-cli --nocheck "{tr}" --lang {ab} | mpg123 -q -')
        except:
            print_say("sorry, cannot find what you are looking for!")</code></pre>
<p class="CodeListingCaption"><a id="listing17-9">Listing 17-9</a>: The script to create a voice translator functionality </p>
<p>We start by importing the needed modules. In particular, we import <em>platform</em> to identify your operating system. At <span class="CodeAnnotation" aria-label="annotation1">1</span>, we create a dictionary <code>lang_abbre</code>, which maps several world languages to their language codes in Google Translate. <a href="#listing17-9">Listing 17-9</a> includes 10 languages, and you can add more to the dictionary if you prefer.</p>
<p>If you’re using Windows, at <span class="CodeAnnotation" aria-label="annotation2">2</span>, we start the definition of the <code>voice_translate()</code> function, which takes your voice command as the argument. Your voice command should contain <em>how to say</em> and <em>in</em>. For example, you can ask, “Python, how to say <em>thank you</em> in Japanese?” The script locates the positions of <em>how to say</em> and <em>in</em> in your voice. It then extracts the English phrase you want to translate and the target language and stores them in variables <code>eng_phrase</code> and <code>tolang</code>, respectively. </p>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="note">
<h2><span class="NoteHead">NOTE</span></h2>
<p>	While the string method <code>find()</code> locates the position of the first occurrence of a substring, the <code>rfind()</code> method returns the position of the last occurrence. We use <code>rfind(' in ')</code> in this script in case you include the word <em>in</em> in the English phrase you want to translate, such as “How to say <em>the cat in the hat</em> in Spanish?”</p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<p>We then use the <code>Translator()</code> class from <em>translate</em> to translate the English phrase to the language you want in text. Next, the script converts the translation into voice. It saves the voice translation into an MP3 file and uses the <em>pydub</em> module to play it.</p>
<p>If you’re using Mac or Linux, the process is similar except that you don’t need to create and play the audio file. Instead, we use the command line method <code>gtts-cli</code> to play the audio file directly without saving and retrieving the audio file, similar to what we did in <span class="xref" itemid="xref_target_Chapter 4">Chapter 4</span> <span class="CodeAnnotation" aria-label="annotation3">3</span>. Since we convert a foreign language to speech, we need to add the <code>--lang</code> option, followed by the abbreviation for the language. </p>
<h3 id="h2-501560c17-0014">Activate the Voice Translator </h3>
<p class="BodyFirst">Next, you’ll add the voice translator module you just created to the final VPA, shown here:</p>
<pre><code><var>--snip--</var>
from mptpkg import voice_translate
<var>--snip--</var>
        # Activate the voice translator 
        elif "how to say" in inp and " in " in inp:
            voice_translate(inp)
            continue
<var>--snip--</var></code></pre>
<p><span epub:type="pagebreak" title="345" id="Page_345"/>We import the <code>voice_translate()</code> function you just created and listen for the activation phrase. Once the translator functionality is activated, <code>voice_translate()</code> is called, using your voice input as the argument. The function tells you the translation in a human voice.</p>
<p>The following is one interaction with the functionality, with my voice input in bold:</p>
<pre><code><var>--snip--</var>
how may I help you?
you just said <b>how to say good afternoon in japanese</b>
the japanese for good afternoon is 
こんにちは
<var>--snip--</var></code></pre>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="box">
<h2>Try it Out</h2>
<p class="BoxBodyFirst">Run <em>vpa_final.py</em> and ask it how to say “thank you” in a foreign language you understand; then check that the translation is correct. If the foreign language is not in the script <em>mytranslate.py</em>, add the language to it.</p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<h2 id="h1-501560c17-0010">	Summary</h2>
<p class="BodyFirst">In this chapter, you added several projects created earlier in the book to your VPA. Along the way, you learned how to modify existing projects, modularize them, and use their functionality in your VPA. You learned how to use voice control to activate a functionality so that everything is 100 percent hands-free, and how to return to the main menu after the functionality is finished. You also efficiently included six versions of the tic-tac-toe or Connect Four game in a single module by allowing the script to ask you a couple of questions before the game starts. With these skills, you’ll be able to create your own functionalities and add them to your VPA.</p>
</section>
</div></body></html>