<html><head></head><body><div id="sbo-rt-content"><section>
<header>
<h1 class="part">
<span class="PartNumber"><span epub:type="pagebreak" title="225" id="Page_225"/>Part II</span><br/>
<span class="PartTitle">Projects</span></h1>
</header>
<p class="PartIntro">Congratulations! You now know enough about Python to start building interactive and meaningful projects. Creating your own projects will teach you new skills and solidify your understanding of the concepts introduced in Part I.</p>
<p>Part II contains three kinds of projects, and you can choose to do any or all of these projects in whichever order you like. Here’s a brief description of each project to help you decide which to dig into first.</p>
<h2 id="h3-502703p02-0001">Alien Invasion: Making a Game with Python</h2>
<p class="BodyFirst">In the Alien Invasion project (<b>Chapters 12</b>, <b>13</b>, and <b>14</b>), you’ll use the Pygame package to develop a 2D game. The goal of the game is to shoot down a fleet of aliens as they drop down the screen, in levels that increase in speed and difficulty. At the end of the project, you’ll have learned skills that will enable you to develop your own 2D games in Pygame.</p>
<h2 id="h3-502703p02-0002">Data Visualization</h2>
<p class="BodyFirst">The Data Visualization projects start in <b>Chapter 15</b>, where you’ll learn to generate data and create a series of functional and beautiful visualizations of that data using Matplotlib and Plotly. <b>Chapter 16</b> teaches you to access data from online sources and feed it into a visualization package to create plots of weather data and a map of global earthquake activity. Finally, <b>Chapter 17</b> shows you how to write a program to automatically download <span epub:type="pagebreak" title="226" id="Page_226"/>and visualize data. Learning to make visualizations allows you to explore the field of data science, which is one of the highest-demand areas of programming today.</p>
<h2 id="h3-502703p02-0003">Web Applications</h2>
<p class="BodyFirst">In the Web Application project (<b>Chapters 18</b>, <b>19</b>, and <b>20</b>), you’ll use the Django package to create a simple web application that allows users to keep a journal about different topics they’ve been learning about. Users will create an account with a username and password, enter a topic, and then make entries about what they’re learning. You’ll also deploy your app to a remote server so anyone in the world can access it.</p>
<p>After completing this project, you’ll be able to start building your own simple web applications, and you’ll be ready to delve into more thorough resources on building applications with Django.</p>
</section>
</div>
<div id="sbo-rt-content"><section>
<header>
<h1 class="chapter">
<span class="ChapterNumber"><span epub:type="pagebreak" title="227" id="Page_227"/>12</span><br/>
<span class="ChapterTitle">A Ship That Fires Bullets</span></h1>
</header>
<figure class="opener">
<img src="Images/chapterart.png" alt="" width="406" height="406"/>
</figure>
<p class="ChapterIntro">Let’s build a game called <em>Alien Invasion</em>! We’ll use Pygame, a collection of fun, powerful Python modules that manage graphics, animation, and even sound, making it easier for you to build sophisticated games. With Pygame handling tasks like drawing images to the screen, you can focus on the higher-level logic of game dynamics.</p>
<p>In this chapter, you’ll set up Pygame and then create a rocket ship that moves right and left and fires bullets in response to player input. In the next two chapters, you’ll create a fleet of aliens to destroy, and then continue to refine the game by setting limits on the number of ships you can use and adding a scoreboard.</p>
<p>While building this game, you’ll also learn how to manage large projects that span multiple files. We’ll refactor a lot of code and manage file contents to organize the project and make the code efficient.</p>
<p><span epub:type="pagebreak" title="228" id="Page_228"/>Making games is an ideal way to have fun while learning a language. It’s deeply satisfying to play a game you wrote, and writing a simple game will teach you a lot about how professionals develop games. As you work through this chapter, enter and run the code to identify how each code block contributes to overall gameplay. Experiment with different values and settings to better understand how to refine interactions in your games.</p>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="note">
<h2><span class="NoteHead">Note</span></h2>
<p>	<em>Alien Invasion</em> spans a number of different files, so make a new <em>alien_invasion</em> folder on your system. Be sure to save all files for the project to this folder so your <code>import</code> statements will work correctly.</p>

<p class="Continued">Also, if you feel comfortable using version control, you might want to use it for this project. If you haven’t used version control before, see <span class="xref" itemid="xref_target_Appendix D">Appendix D</span> for an overview.</p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<h2 id="h1-502703c12-0001">Planning Your Project</h2>
<p class="BodyFirst">When you’re building a large project, it’s important to prepare a plan before you begin to write code. Your plan will keep you focused and make it more likely that you’ll complete the project.</p>
<p>Let’s write a description of the general gameplay. Although the following description doesn’t cover every detail of <em>Alien Invasion</em>, it provides a clear idea of how to start building the game:</p>
<blockquote class="blockquote">
<p class="Blockquote">In <em>Alien Invasion</em>, the player controls a rocket ship that appears at the bottom center of the screen. The player can move the ship right and left using the arrow keys and shoot bullets using the spacebar. When the game begins, a fleet of aliens fills the sky and moves across and down the screen. The player shoots and destroys the aliens. If the player destroys all the aliens, a new fleet appears that moves faster than the previous fleet. If any alien hits the player’s ship or reaches the bottom of the screen, the player loses a ship. If the player loses three ships, the game ends.</p>
</blockquote>
<p>For the first development phase, we’ll make a ship that can move right and left when the player presses the arrow keys and fire bullets when the player presses the spacebar. After setting up this behavior, we can create the aliens and refine the gameplay.</p>
<h2 id="h1-502703c12-0002">Installing Pygame</h2>
<p class="BodyFirst">Before you begin coding, install Pygame. We’ll do this the same way we installed pytest in <span class="xref" itemid="xref_target_Chapter 11">Chapter 11</span>: with pip. If you skipped <span class="xref" itemid="xref_target_Chapter 11">Chapter 11</span> or need a refresher on pip, see “<span class="xref" itemid="xref_target_Installing pytest with pip">Installing pytest with pip</span>” on <span class="xref" itemid="xref_target_page 210">page 210</span>.</p>
<p>To install Pygame, enter the following command at a terminal prompt:</p>
<pre><code>$ <b>python -m pip install --user pygame</b></code></pre>
<p>If you use a command other than <code class="bold">python</code> to run programs or start a terminal session, such as <code class="bold">python3</code>, make sure you use that command instead.</p>
<h2 id="h1-502703c12-0003"><span epub:type="pagebreak" title="229" id="Page_229"/>Starting the Game Project</h2>
<p class="BodyFirst">We’ll begin building the game by creating an empty Pygame window. Later, we’ll draw the game elements, such as the ship and the aliens, on this window. We’ll also make our game respond to user input, set the background color, and load a ship image.</p>
<h3 id="h2-502703c12-0001">Creating a Pygame Window and Responding to User Input</h3>
<p class="BodyFirst">We’ll make an empty Pygame window by creating a class to represent the game. In your text editor, create a new file and save it as <em>alien_invasion.py</em>; then enter the following:</p>
<p class="CodeLabel"><b>alien_invasion.py</b></p>
<pre><code>import sys

import pygame

class AlienInvasion:
    """Overall class to manage game assets and behavior."""

    def __init__(self):
        """Initialize the game, and create game resources."""
<span class="CodeAnnotationHang" aria-label="annotation1">❶</span>         pygame.init()

<span class="CodeAnnotationHang" aria-label="annotation2">❷</span>         self.screen = pygame.display.set_mode((1200, 800))
        pygame.display.set_caption("Alien Invasion")

    def run_game(self):
        """Start the main loop for the game."""
<span class="CodeAnnotationHang" aria-label="annotation3">❸</span>         while True:
            # Watch for keyboard and mouse events.
<span class="CodeAnnotationHang" aria-label="annotation4">❹</span>             for event in pygame.event.get():
<span class="CodeAnnotationHang" aria-label="annotation5">❺</span>                 if event.type == pygame.QUIT:
                    sys.exit()

            # Make the most recently drawn screen visible.
<span class="CodeAnnotationHang" aria-label="annotation6">❻</span>             pygame.display.flip()

if __name__ == '__main__':
    # Make a game instance, and run the game.
    ai = AlienInvasion()
    ai.run_game()</code></pre>
<p>First, we import the <code>sys</code> and <code>pygame</code> modules. The <code>pygame</code> module contains the functionality we need to make a game. We’ll use tools in the <code>sys</code> module to exit the game when the player quits.</p>
<p><em>Alien Invasion</em> starts as a class called <code>AlienInvasion</code>. In the <code>__init__()</code> method, the <code>pygame.init()</code> function initializes the background settings that Pygame needs to work properly <span class="CodeAnnotation" aria-label="annotation1">❶</span>. Then we call <code>pygame.display.set_mode()</code> to create a display window <span class="CodeAnnotation" aria-label="annotation2">❷</span>, on which we’ll draw all the game’s graphical elements. The argument <code>(1200, 800)</code> is a tuple that defines the dimensions of the game window, which will be 1,200 pixels wide by 800 pixels high. (You can adjust these values depending on your display size.) We assign this <span epub:type="pagebreak" title="230" id="Page_230"/>display window to the attribute <code>self.screen</code>, so it will be available in all methods in the class.</p>
<p>The object we assigned to <code>self.screen</code> is called a surface. A <em>surface</em> in Pygame is a part of the screen where a game element can be displayed. Each element in the game, like an alien or a ship, is its own surface. The surface returned by <code>display.set_mode()</code> represents the entire game window. When we activate the game’s animation loop, this surface will be redrawn on every pass through the loop, so it can be updated with any changes triggered by user input.</p>
<p>The game is controlled by the <code>run_game()</code> method. This method contains a <code>while</code> loop <span class="CodeAnnotation" aria-label="annotation3">❸</span> that runs continually. The <code>while</code> loop contains an event loop and code that manages screen updates. An <em>event</em> is an action that the user performs while playing the game, such as pressing a key or moving the mouse. To make our program respond to events, we write an <em>event loop</em> to <em>listen</em> for events and perform appropriate tasks depending on the kinds of events that occur. The <code>for</code> loop <span class="CodeAnnotation" aria-label="annotation4">❹</span> nested inside the <code>while</code> loop is an event loop.</p>
<p>To access the events that Pygame detects, we’ll use the <code>pygame.event.get()</code> function. This function returns a list of events that have taken place since the last time this function was called. Any keyboard or mouse event will cause this <code>for</code> loop to run. Inside the loop, we’ll write a series of <code>if</code> statements to detect and respond to specific events. For example, when the player clicks the game window’s close button, a <code>pygame.QUIT</code> event is detected and we call <code>sys.exit()</code> to exit the game <span class="CodeAnnotation" aria-label="annotation5">❺</span>.</p>
<p>The call to <code>pygame.display.flip()</code> <span class="CodeAnnotation" aria-label="annotation6">❻</span> tells Pygame to make the most recently drawn screen visible. In this case, it simply draws an empty screen on each pass through the <code>while</code> loop, erasing the old screen so only the new screen is visible. When we move the game elements around, <code>pygame.display.flip()</code> continually updates the display to show the new positions of game elements and hide the old ones, creating the illusion of smooth movement.</p>
<p>At the end of the file, we create an instance of the game and then call <code>run_game()</code>. We place <code>run_game()</code> in an <code>if</code> block that only runs if the file is called directly. When you run this <em>alien_invasion.py</em> file, you should see an empty Pygame window.</p>
<h3 id="h2-502703c12-0002">Controlling the Frame Rate</h3>
<p class="BodyFirst">Ideally, games should run at the same speed, or <em>frame rate</em>, on all systems. Controlling the frame rate of a game that can run on multiple systems is a complex issue, but Pygame offers a relatively simple way to accomplish this goal. We’ll make a clock, and ensure the clock ticks once on each pass through the main loop. Anytime the loop processes faster than the rate we define, Pygame will calculate the correct amount of time to pause so that the game runs at a consistent rate.</p>
<p>We’ll define the clock in the <code>__init__()</code> method:</p>
<p class="CodeLabel"><b>alien_invasion.py</b></p>
<pre><code><span class="LiteralGray">    def __init__(self):</span>
<span class="LiteralGray">        """Initialize the game, and create game resources."""</span>
<span class="LiteralGray">        pygame.init()</span>
<span epub:type="pagebreak" title="231" id="Page_231"/>        self.clock = pygame.time.Clock()
<span class="LiteralGray">        </span><em class="LiteralGrayItalic">--snip--</em></code></pre>
<p>After initializing <code>pygame</code>, we create an instance of the class <code>Clock</code>, from the <code>pygame.time</code> module. Then we’ll make the clock tick at the end of the <code>while</code> loop in <code>run_game()</code>:</p>
<pre><code><span class="LiteralGray">    def run_game(self):</span>
<span class="LiteralGray">        """Start the main loop for the game."""</span>
<span class="LiteralGray">        while True:</span>
<span class="LiteralGray">            </span><em class="LiteralGrayItalic">--snip--</em>
<span class="LiteralGray">            pygame.display.flip()</span>
            self.clock.tick(60)</code></pre>
<p>The <code>tick()</code> method takes one argument: the frame rate for the game. Here I’m using a value of 60, so Pygame will do its best to make the loop run exactly 60 times per second.</p>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="note">
<h2><span class="NoteHead">Note</span></h2>
<p>	Pygame’s clock should help the game run consistently on most systems. If it makes the game run less consistently on your system, you can try different values for the frame rate. If you can’t find a good frame rate on your system, you can leave the clock out entirely and adjust the game’s settings so it runs well on your system.</p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<h3 id="h2-502703c12-0003">Setting the Background Color</h3>
<p class="BodyFirst">Pygame creates a black screen by default, but that’s boring. Let’s set a different background color. We’ll do this at the end of the <code>__init__()</code> method.</p>
<p class="CodeLabel"><b>alien_invasion.py</b></p>
<pre><code><span class="LiteralGray">    def __init__(self):</span>
<span class="LiteralGray">        </span><em class="LiteralGrayItalic">--snip--</em>
<span class="LiteralGray">        pygame.display.set_caption("Alien Invasion")</span>

        # Set the background color.
<span class="CodeAnnotationHang" aria-label="annotation1">❶</span>         self.bg_color = (230, 230, 230)

<span class="LiteralGray">    def run_game(self):</span>
<span class="LiteralGray">        </span><em class="LiteralGrayItalic">--snip--</em>
<span class="LiteralGray">            for event in pygame.event.get():</span>
<span class="LiteralGray">                if event.type == pygame.QUIT:</span>
<span class="LiteralGray">                    sys.exit()</span>

            # Redraw the screen during each pass through the loop.
<span class="CodeAnnotationHang" aria-label="annotation2">❷</span>             self.screen.fill(self.bg_color)

<span class="LiteralGray">            # Make the most recently drawn screen visible.</span>
<span class="LiteralGray">            pygame.display.flip()</span>
<span class="LiteralGray">            self.clock.tick(60)</span></code></pre>
<p>Colors in Pygame are specified as RGB colors: a mix of red, green, and blue. Each color value can range from 0 to 255. The color value <code>(255, 0, 0)</code> is red, <code>(0, 255, 0)</code> is green, and <code>(0, 0, 255)</code> is blue. You can mix different RGB values to create up to 16 million colors. The color value <code>(230, 230, 230)</code> <span epub:type="pagebreak" title="232" id="Page_232"/>mixes equal amounts of red, blue, and green, which produces a light gray background color. We assign this color to <code>self.bg_color</code> <span class="CodeAnnotation" aria-label="annotation1">❶</span>.</p>
<p>We fill the screen with the background color using the <code>fill()</code> method <span class="CodeAnnotation" aria-label="annotation2">❷</span>, which acts on a surface and takes only one argument: a color.</p>
<h3 id="h2-502703c12-0004">Creating a Settings Class</h3>
<p class="BodyFirst">Each time we introduce new functionality into the game, we’ll typically create some new settings as well. Instead of adding settings throughout the code, let’s write a module called <code>settings</code> that contains a class called <code>Settings</code> to store all these values in one place. This approach allows us to work with just one <code>settings</code> object anytime we need to access an individual setting. This also makes it easier to modify the game’s appearance and behavior as our project grows. To modify the game, we’ll change the relevant values in <em>settings.py</em>, which we’ll create next, instead of searching for different settings throughout the project.</p>
<p>Create a new file named <em>settings.py</em> inside your <em>alien_invasion </em>folder, and add this initial <code>Settings</code> class:</p>
<p class="CodeLabel"><b>settings.py</b></p>
<pre><code>class Settings:
    """A class to store all settings for Alien Invasion."""

    def __init__(self):
        """Initialize the game's settings."""
        # Screen settings
        self.screen_width = 1200
        self.screen_height = 800
        self.bg_color = (230, 230, 230)</code></pre>
<p>To make an instance of <code>Settings</code> in the project and use it to access our settings, we need to modify <em>alien_invasion.py</em> as follows:</p>
<p class="CodeLabel"><b>alien_invasion.py</b></p>
<pre><code><em class="LiteralGrayItalic">--snip--</em>
<span class="LiteralGray">import pygame</span>

from settings import Settings

<span class="LiteralGray">class AlienInvasion:</span>
<span class="LiteralGray">    """Overall class to manage game assets and behavior."""</span>

<span class="LiteralGray">    def __init__(self):</span>
<span class="LiteralGray">        """Initialize the game, and create game resources."""</span>
<span class="LiteralGray">        pygame.init()</span>
<span class="LiteralGray">        self.clock = pygame.time.Clock()</span>
<span class="CodeAnnotationHang" aria-label="annotation1">❶</span><span class="LiteralGray">         </span>self.settings = Settings()

<span class="CodeAnnotationHang" aria-label="annotation2">❷</span>         self.screen = pygame.display.set_mode(
            (self.settings.screen_width, self.settings.screen_height))
<span class="LiteralGray">        pygame.display.set_caption("Alien Invasion")</span>

<span epub:type="pagebreak" title="233" id="Page_233"/><span class="LiteralGray">    def run_game(self):</span>
<span class="LiteralGray">            </span><em class="LiteralGrayItalic">--snip--</em>
<span class="LiteralGray">            # Redraw the screen during each pass through the loop.</span>
<span class="CodeAnnotationHang" aria-label="annotation3">❸</span>             self.screen.fill(self.settings.bg_color)

<span class="LiteralGray">            # Make the most recently drawn screen visible.</span>
<span class="LiteralGray">            pygame.display.flip()</span>
<span class="LiteralGray">            self.clock.tick(60)</span>
<em class="LiteralGrayItalic">--snip--</em></code></pre>
<p>We import <code>Settings</code> into the main program file. Then we create an instance of <code>Settings</code> and assign it to <code>self.settings</code> <span class="CodeAnnotation" aria-label="annotation1">❶</span>, after making the call to <code>pygame.init()</code>. When we create a screen <span class="CodeAnnotation" aria-label="annotation2">❷</span>, we use the <code>screen_width</code> and <code>screen_height</code> attributes of <code>self.settings</code>, and then we use <code>self.settings</code> to access the background color when filling the screen <span class="CodeAnnotation" aria-label="annotation3">❸</span> as well.</p>
<p>When you run <em>alien_invasion.py</em> now you won’t yet see any changes, because all we’ve done is move the settings we were already using elsewhere. Now we’re ready to start adding new elements to the screen.</p>
<h2 id="h1-502703c12-0004">Adding the Ship Image</h2>
<p class="BodyFirst">Let’s add the ship to our game. To draw the player’s ship on the screen, we’ll load an image and then use the Pygame <code>blit()</code> method to draw the image.</p>
<p>When you’re choosing artwork for your games, be sure to pay attention to licensing. The safest and cheapest way to start is to use freely licensed graphics that you can use and modify, from a website like <a href="https://opengameart.org" class="LinkURL">https://opengameart.org</a>.</p>
<p>You can use almost any type of image file in your game, but it’s easiest when you use a bitmap (<em>.bmp</em>) file because Pygame loads bitmaps by default. Although you can configure Pygame to use other file types, some file types depend on certain image libraries that must be installed on your computer. Most images you’ll find are in <em>.jpg</em> or <em>.png</em> formats, but you can convert them to bitmaps using tools like Photoshop, GIMP, and Paint.</p>
<p>Pay particular attention to the background color in your chosen image. Try to find a file with a transparent or solid background that you can replace with any background color, using an image editor. Your games will look best if the image’s background color matches your game’s background color. Alternatively, you can match your game’s background to the image’s background.</p>
<p>For<em> Alien Invasion</em>, you can use the file <em>ship.bmp</em> (<a href="#figure12-1" id="figureanchor12-1">Figure 12-1</a>), which is available in this book’s resources at <a href="https://ehmatthes.github.io/pcc_3e" class="LinkURL">https://ehmatthes.github.io/pcc_3e</a>. The file’s background color matches the settings we’re using in this project. Make a folder called <em>images</em> inside your main <em>alien_invasion</em> project folder. Save the file <em>ship.bmp</em> in the <em>images</em> folder.</p>
<span epub:type="pagebreak" title="234" id="Page_234"/><figure>
<img src="Images/f12001.png" class="" alt="" width="375" height="303"/>
<figcaption><p><a id="figure12-1">Figure 12-1</a>: The ship for <em>Alien Invasion</em></p></figcaption>
</figure>
<h3 id="h2-502703c12-0005">Creating the Ship Class</h3>
<p class="BodyFirst">After choosing an image for the ship, we need to display it on the screen. To use our ship, we’ll create a new <code>ship</code> module that will contain the class <code>Ship</code>. This class will manage most of the behavior of the player’s ship:</p>
<p class="CodeLabel"><b>ship.py</b></p>
<pre><code>import pygame

class Ship:
    """A class to manage the ship."""

    def __init__(self, ai_game):
        """Initialize the ship and set its starting position."""
<span class="CodeAnnotationHang" aria-label="annotation1">❶</span>         self.screen = ai_game.screen
<span class="CodeAnnotationHang" aria-label="annotation2">❷</span>         self.screen_rect = ai_game.screen.get_rect()

        # Load the ship image and get its rect.
<span class="CodeAnnotationHang" aria-label="annotation3">❸</span>         self.image = pygame.image.load('images/ship.bmp')
        self.rect = self.image.get_rect()

        # Start each new ship at the bottom center of the screen.
<span class="CodeAnnotationHang" aria-label="annotation4">❹</span>         self.rect.midbottom = self.screen_rect.midbottom

<span class="CodeAnnotationHang" aria-label="annotation5">❺</span>     def blitme(self):
        """Draw the ship at its current location."""
        self.screen.blit(self.image, self.rect)</code></pre>
<p>Pygame is efficient because it lets you treat all game elements like rectangles (<em>rects</em>), even if they’re not exactly shaped like rectangles. Treating an element as a rectangle is efficient because rectangles are simple geometric shapes. When Pygame needs to figure out whether two game elements have collided, for example, it can do this more quickly if it treats each object as a rectangle. This approach usually works well enough that no one playing the <span epub:type="pagebreak" title="235" id="Page_235"/>game will notice that we’re not working with the exact shape of each game element. We’ll treat the ship and the screen as rectangles in this class.</p>
<p>We import the <code>pygame</code> module before defining the class. The <code>__init__()</code> method of <code>Ship</code> takes two parameters: the <code>self</code> reference and a reference to the current instance of the <code>AlienInvasion</code> class. This will give <code>Ship</code> access to all the game resources defined in <code>AlienInvasion</code>. We then assign the screen to an attribute of <code>Ship</code> <span class="CodeAnnotation" aria-label="annotation1">❶</span>, so we can access it easily in all the methods in this class. We access the screen’s <code>rect</code> attribute using the <code>get_rect()</code> method and assign it to <code>self.screen_rect</code> <span class="CodeAnnotation" aria-label="annotation2">❷</span>. Doing so allows us to place the ship in the correct location on the screen.</p>
<p>To load the image, we call <code>pygame.image.load()</code> <span class="CodeAnnotation" aria-label="annotation3">❸</span> and give it the location of our ship image. This function returns a surface representing the ship, which we assign to <code>self.image</code>. When the image is loaded, we call <code>get_rect()</code> to access the ship surface’s <code>rect</code> attribute so we can later use it to place the ship.</p>
<p>When you’re working with a <code>rect</code> object, you can use the <em>x</em>- and <em>y</em>-coordinates of the top, bottom, left, and right edges of the rectangle, as well as the center, to place the object. You can set any of these values to establish the current position of the <code>rect</code>. When you’re centering a game element, work with the <code>center</code>, <code>centerx</code>, or <code>centery</code> attributes of a <code>rect</code>. When you’re working at an edge of the screen, work with the <code>top</code>, <code>bottom</code>, <code>left</code>, or <code>right</code> attributes. There are also attributes that combine these properties, such as <code>midbottom</code>, <code>midtop</code>, <code>midleft</code>, and <code>midright</code>. When you’re adjusting the horizontal or vertical placement of the <code>rect</code>, you can just use the <code>x</code> and <code>y</code> attributes, which are the <em>x</em>- and <em>y</em>-coordinates of its top-left corner. These attributes spare you from having to do calculations that game developers formerly had to do manually, and you’ll use them often.</p>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="note">
<h2><span class="NoteHead">Note</span></h2>
<p>	In Pygame, the origin (0, 0) is at the top-left corner of the screen, and coordinates increase as you go down and to the right. On a 1200×800 screen, the origin is at the top-left corner, and the bottom-right corner has the coordinates (1200, 800). These coordinates refer to the game window, not the physical screen.</p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<p>We’ll position the ship at the bottom center of the screen. To do so, make the value of <code>self.rect.midbottom</code> match the <code>midbottom</code> attribute of the screen’s <code>rect</code> <span class="CodeAnnotation" aria-label="annotation4">❹</span>. Pygame uses these <code>rect</code> attributes to position the ship image so it’s centered horizontally and aligned with the bottom of the screen.</p>
<p>Finally, we define the <code>blitme()</code> method <span class="CodeAnnotation" aria-label="annotation5">❺</span>, which draws the image to the screen at the position specified by <code>self.rect</code>.</p>
<h3 id="h2-502703c12-0006">Drawing the Ship to the Screen</h3>
<p class="BodyFirst">Now let’s update <em>alien_invasion.py</em> so it creates a ship and calls the ship’s <code>blitme()</code> method:</p>
<p class="CodeLabel"><b>alien_invasion.py</b></p>
<pre><code><em class="LiteralGrayItalic">--snip--</em>
<span class="LiteralGray">from settings import Settings</span>
from ship import Ship

<span epub:type="pagebreak" title="236" id="Page_236"/><span class="LiteralGray">class AlienInvasion:</span>
<span class="LiteralGray">    """Overall class to manage game assets and behavior."""</span>

<span class="LiteralGray">    def __init__(self):</span>
<span class="LiteralGray">        </span><em class="LiteralGrayItalic">--snip--</em>
<span class="LiteralGray">        pygame.display.set_caption("Alien Invasion")</span>

<span class="CodeAnnotationHang" aria-label="annotation1">❶</span>         self.ship = Ship(self)

<span class="LiteralGray">    def run_game(self):</span>
<span class="LiteralGray">            </span><em class="LiteralGrayItalic">--snip--</em>
<span class="LiteralGray">            # Redraw the screen during each pass through the loop.</span>
<span class="LiteralGray">            self.screen.fill(self.settings.bg_color)</span>
<span class="CodeAnnotationHang" aria-label="annotation2">❷</span>             self.ship.blitme()

<span class="LiteralGray">            # Make the most recently drawn screen visible.</span>
<span class="LiteralGray">            pygame.display.flip()</span>
<span class="LiteralGray">            self.clock.tick(60)</span>
<em class="LiteralGrayItalic">--snip--</em></code></pre>
<p>We import <code>Ship</code> and then make an instance of <code>Ship</code> after the screen has been created <span class="CodeAnnotation" aria-label="annotation1">❶</span>. The call to <code>Ship()</code> requires one argument: an instance of <code>AlienInvasion</code>. The <code>self</code> argument here refers to the current instance of <code>AlienInvasion</code>. This is the parameter that gives <code>Ship</code> access to the game’s resources, such as the <code>screen</code> object. We assign this <code>Ship</code> instance to <code>self.ship</code>.</p>
<p>After filling the background, we draw the ship on the screen by calling <code>ship.blitme()</code>, so the ship appears on top of the background <span class="CodeAnnotation" aria-label="annotation2">❷</span>.</p>
<p>When you run <em>alien_invasion.py</em> now, you should see an empty game screen with the rocket ship sitting at the bottom center, as shown in <a href="#figure12-2" id="figureanchor12-2">Figure 12-2</a>.</p>
<figure>
<img src="Images/f12002.png" class="keyline" alt="" width="571" height="394"/>
<figcaption><p><a id="figure12-2">Figure 12-2</a>: <em>Alien Invasion</em> with the ship at the bottom center of the screen</p></figcaption>
</figure>
<h2 id="h1-502703c12-0005"><span epub:type="pagebreak" title="237" id="Page_237"/>Refactoring: The _check_events() and _update_screen() Methods</h2>
<p class="BodyFirst">In large projects, you’ll often refactor code you’ve written before adding more code. Refactoring simplifies the structure of the code you’ve already written, making it easier to build on. In this section, we’ll break the <code>run_game()</code> method, which is getting lengthy, into two helper methods. A <em>helper method</em> does work inside a class but isn’t meant to be used by code outside the class. In Python, a single leading underscore indicates a helper method.</p>
<h3 id="h2-502703c12-0007">The _check_events() Method</h3>
<p class="BodyFirst">We’ll move the code that manages events to a separate method called <code>_check_events()</code>. This will simplify <code>run_game()</code> and isolate the event management loop. Isolating the event loop allows you to manage events separately from other aspects of the game, such as updating the screen.</p>
<p>Here’s the <code>AlienInvasion</code> class with the new <code>_check_events()</code> method, which only affects the code in <code>run_game()</code>:</p>
<p class="CodeLabel"><b>alien_invasion.py</b></p>
<pre><code><span class="LiteralGray">    def run_game(self):</span>
<span class="LiteralGray">        """Start the main loop for the game."""</span>
<span class="LiteralGray">        while True:</span>
<span class="CodeAnnotationHang" aria-label="annotation1">❶</span><span class="LiteralGray">             </span>self._check_events()

<span class="LiteralGray">            # Redraw the screen during each pass through the loop.</span>
<span class="LiteralGray">            </span><em class="LiteralGrayItalic">--snip--</em>

<span class="CodeAnnotationHang" aria-label="annotation2">❷</span><span class="LiteralGray">     </span>def _check_events(self):
        """Respond to keypresses and mouse events."""
      <span class="LiteralGray">  for event in pygame.event.get():</span>
<span class="LiteralGray">            if event.type == pygame.QUIT:</span>
<span class="LiteralGray">                sys.exit()</span></code></pre>
<p>We make a new <code>_check_events()</code> method <span class="CodeAnnotation" aria-label="annotation2">❷</span> and move the lines that check whether the player has clicked to close the window into this new method.</p>
<p>To call a method from within a class, use dot notation with the variable <code>self</code> and the name of the method <span class="CodeAnnotation" aria-label="annotation1">❶</span>. We call the method from inside the <code>while</code> loop in <code>run_game()</code>.</p>
<h3 id="h2-502703c12-0008">The _update_screen() Method</h3>
<p class="BodyFirst">To further simplify <code>run_game()</code>, we’ll move the code for updating the screen to a separate method called <code>_update_screen()</code>:</p>
<p class="CodeLabel"><b>alien_invasion.py</b></p>
<pre><code><span class="LiteralGray">    def run_game(self):</span>
<span class="LiteralGray">        """Start the main loop for the game."""</span>
<span class="LiteralGray">        while True:</span>
<span class="LiteralGray">            self._check_events()</span>
<span class="LiteralGray">            </span>self._update_screen()
<span class="LiteralGray">            self.clock.tick(60)</span>

<span class="LiteralGray">    def _check_events(self):</span>
<span class="LiteralGray">        </span><em class="LiteralGrayItalic">--snip--</em>

<span epub:type="pagebreak" title="238" id="Page_238"/>    def _update_screen(self):
        """Update images on the screen, and flip to the new screen."""
       <span class="LiteralGray"> self.screen.fill(self.settings.bg_color)</span>
<span class="LiteralGray">        self.ship.blitme()</span>

<span class="LiteralGray">        pygame.display.flip()</span></code></pre>
<p>We moved the code that draws the background and the ship and flips the screen to <code>_update_screen()</code>. Now the body of the main loop in <code>run_game()</code> is much simpler. It’s easy to see that we’re looking for new events, updating the screen, and ticking the clock on each pass through the loop.</p>
<p>If you’ve already built a number of games, you’ll probably start out by breaking your code into methods like these. But if you’ve never tackled a project like this, you probably won’t know exactly how to structure your code at first. This approach gives you an idea of a realistic development process: you start out writing your code as simply as possible, and then refactor it as your project becomes more complex.</p>
<p>Now that we’ve restructured the code to make it easier to add to, we can work on the dynamic aspects of the game!</p>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="box">
<h2>Try It Yourself</h2>
<p class="BoxBodyCustom"><span id="h2-502703c12-09" class="BoxNumber">12-1.	Blue Sky:</span> Make a Pygame window with a blue background.</p>
<p class="BoxBodyCustom"><span id="h2-502703c12-10" class="BoxNumber">12-2.	Game Character:</span> Find a bitmap image of a game character you like or convert an image to a bitmap. Make a class that draws the character at the center of the screen, then match the background color of the image to the background color of the screen or vice versa.</p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<h2 id="h1-502703c12-0006">Piloting the Ship</h2>
<p class="BodyFirst">Next, we’ll give the player the ability to move the ship right and left. We’ll write code that responds when the player presses the right or left arrow key. We’ll focus first on movement to the right, and then we’ll apply the same principles to control movement to the left. As we add this code, you’ll learn how to control the movement of images on the screen and respond to user input.</p>
<h3 id="h2-502703c12-0009">Responding to a Keypress</h3>
<p class="BodyFirst">Whenever the player presses a key, that keypress is registered in Pygame as an event. Each event is picked up by the <code>pygame.event.get()</code> method. We need to specify in our <code>_check_events()</code> method what kinds of events we want the game to check for. Each keypress is registered as a <code>KEYDOWN</code> event.</p>
<p><span epub:type="pagebreak" title="239" id="Page_239"/>When Pygame detects a <code>KEYDOWN</code> event, we need to check whether the key that was pressed is one that triggers a certain action. For example, if the player presses the right arrow key, we want to increase the ship’s <code>rect.x</code> value to move the ship to the right:</p>
<p class="CodeLabel"><b>alien_invasion.py</b></p>
<pre><code><span class="LiteralGray">    def _check_events(self):</span>
<span class="LiteralGray">        """Respond to keypresses and mouse events."""</span>
<span class="LiteralGray">        for event in pygame.event.get():</span>
<span class="LiteralGray">            if event.type == pygame.QUIT:</span>
<span class="LiteralGray">                sys.exit()</span>
<span class="CodeAnnotationHang" aria-label="annotation1">❶</span>             elif event.type == pygame.KEYDOWN:
<span class="CodeAnnotationHang" aria-label="annotation2">❷</span>                 if event.key == pygame.K_RIGHT:
                    # Move the ship to the right.
<span class="CodeAnnotationHang" aria-label="annotation3">❸</span>                     self.ship.rect.x += 1</code></pre>
<p>Inside <code>_check_events()</code> we add an <code>elif</code> block to the event loop, to respond when Pygame detects a <code>KEYDOWN</code> event <span class="CodeAnnotation" aria-label="annotation1">❶</span>. We check whether the key pressed, <code>event.key</code>, is the right arrow key <span class="CodeAnnotation" aria-label="annotation2">❷</span>. The right arrow key is represented by <code>pygame.K_RIGHT</code>. If the right arrow key was pressed, we move the ship to the right by increasing the value of <code>self.ship.rect.x</code> by 1 <span class="CodeAnnotation" aria-label="annotation3">❸</span>.</p>
<p>When you run <em>alien_invasion.py</em> now, the ship should move to the right one pixel every time you press the right arrow key. That’s a start, but it’s not an efficient way to control the ship. Let’s improve this control by allowing continuous movement.</p>
<h3 id="h2-502703c12-0010">Allowing Continuous Movement</h3>
<p class="BodyFirst">When the player holds down the right arrow key, we want the ship to continue moving right until the player releases the key. We’ll have the game detect a <code>pygame.KEYUP</code> event so we’ll know when the right arrow key is released; then we’ll use the <code>KEYDOWN</code> and <code>KEYUP</code> events together with a flag called <code>moving_right</code> to implement continuous motion.</p>
<p>When the <code>moving_right</code> flag is <code>False</code>, the ship will be motionless. When the player presses the right arrow key, we’ll set the flag to <code>True</code>, and when the player releases the key, we’ll set the flag to <code>False</code> again.</p>
<p>The <code>Ship</code> class controls all attributes of the ship, so we’ll give it an attribute called <code>moving_right</code> and an <code>update()</code> method to check the status of the <code>moving_right</code> flag. The <code>update()</code> method will change the position of the ship if the flag is set to <code>True</code>. We’ll call this method once on each pass through the <code>while</code> loop to update the position of the ship.</p>
<p>Here are the changes to <code>Ship</code>:</p>
<p class="CodeLabel"><b>ship.py</b></p>
<pre><code><span class="LiteralGray">class Ship:</span>
<span class="LiteralGray">    """A class to manage the ship."""</span>

<span class="LiteralGray">    def __init__(self, ai_game):</span>
<span class="LiteralGray">        </span><em class="LiteralGrayItalic">--snip--</em>
<span class="LiteralGray">        # Start each new ship at the bottom center of the screen.</span>
<span class="LiteralGray">        self.rect.midbottom = self.screen_rect.midbottom</span>

<span epub:type="pagebreak" title="240" id="Page_240"/>        # Movement flag; start with a ship that's not moving.
<span class="CodeAnnotationHang" aria-label="annotation1">❶</span>         self.moving_right = False

<span class="CodeAnnotationHang" aria-label="annotation2">❷</span>     def update(self):
        """Update the ship's position based on the movement flag."""
        if self.moving_right:
            self.rect.x += 1

<span class="LiteralGray">    def blitme(self):</span>
<span class="LiteralGray">        </span><em class="LiteralGrayItalic">--snip--</em></code></pre>
<p>We add a <code>self.moving_right</code> attribute in the <code>__init__()</code> method and set it to <code>False</code> initially <span class="CodeAnnotation" aria-label="annotation1">❶</span>. Then we add <code>update()</code>, which moves the ship right if the flag is <code>True</code> <span class="CodeAnnotation" aria-label="annotation2">❷</span>. The <code>update()</code> method will be called from outside the class, so it’s not considered a helper method.</p>
<p>Now we need to modify <code>_check_events()</code> so that <code>moving_right</code> is set to <code>True</code> when the right arrow key is pressed and <code>False</code> when the key is released:</p>
<p class="CodeLabel"><b>alien_invasion.py</b></p>
<pre><code><span class="LiteralGray">    def _check_events(self):</span>
<span class="LiteralGray">        """Respond to keypresses and mouse events."""</span>
<span class="LiteralGray">        for event in pygame.event.get():</span>
<span class="LiteralGray">            </span><em class="LiteralGrayItalic">--snip--</em>
<span class="LiteralGray">            elif event.type == pygame.KEYDOWN:</span>
<span class="LiteralGray">                if event.key == pygame.K_RIGHT:</span>
<span class="CodeAnnotationHang" aria-label="annotation1">❶</span>                     self.ship.moving_right = True
<span class="CodeAnnotationHang" aria-label="annotation2">❷</span>             elif event.type == pygame.KEYUP:
                if event.key == pygame.K_RIGHT:
                    self.ship.moving_right = False</code></pre>
<p>Here, we modify how the game responds when the player presses the right arrow key: instead of changing the ship’s position directly, we merely set <code>moving_right</code> to <code>True</code> <span class="CodeAnnotation" aria-label="annotation1">❶</span>. Then we add a new <code>elif</code> block, which responds to <code>KEYUP</code> events <span class="CodeAnnotation" aria-label="annotation2">❷</span>. When the player releases the right arrow key (<code>K_RIGHT</code>), we set <code>moving_right</code> to <code>False</code>.</p>
<p>Next, we modify the <code>while</code> loop in <code>run_game()</code> so it calls the ship’s <code>update()</code> method on each pass through the loop:</p>
<p class="CodeLabel"><b>alien_invasion.py</b></p>
<pre><code><span class="LiteralGray">     def run_game(self):</span>
<span class="LiteralGray">        """Start the main loop for the game."""</span>
<span class="LiteralGray">        while True:</span>
<span class="LiteralGray">            self._check_events()</span>
<span class="LiteralGray">            </span>self.ship.update()
<span class="LiteralGray">            self._update_screen()</span>
<span class="LiteralGray">            self.clock.tick(60)</span></code></pre>
<p>The ship’s position will be updated after we’ve checked for keyboard events and before we update the screen. This allows the ship’s position to be updated in response to player input and ensures the updated position will be used when drawing the ship to the screen.</p>
<p>When you run <em>alien_invasion.py</em> and hold down the right arrow key, the ship should move continuously to the right until you release the key.</p>
<h3 id="h2-502703c12-0011"><span epub:type="pagebreak" title="241" id="Page_241"/>Moving Both Left and Right</h3>
<p class="BodyFirst">Now that the ship can move continuously to the right, adding movement to the left is straightforward. Again, we’ll modify the <code>Ship</code> class and the <code>_check_events()</code> method. Here are the relevant changes to <code>__init__()</code> and <code>update()</code> in <code>Ship</code>:</p>
<p class="CodeLabel"><b>ship.py</b></p>
<pre><code><span class="LiteralGray">    def __init__(self, ai_game):</span>
<span class="LiteralGray">        </span><em class="LiteralGrayItalic">--snip--</em>
    <span class="LiteralGray">    </span># Movement flags; start with a ship that's not moving.
<span class="LiteralGray">        self.moving_right = False</span>
    <span class="LiteralGray">    </span>self.moving_left = False

<span class="LiteralGray">    def update(self):</span>
    <span class="LiteralGray">    </span>"""Update the ship's position based on movement flags."""
<span class="LiteralGray">        if self.moving_right:</span>
<span class="LiteralGray">            self.rect.x += 1</span>
    <span class="LiteralGray">    </span>if self.moving_left:
       <span class="LiteralGray">    </span> self.rect.x -= 1</code></pre>
<p>In <code>__init__()</code>, we add a <code>self.moving_left</code> flag. In <code>update()</code>, we use two separate <code>if</code> blocks, rather than an <code>elif</code>, to allow the ship’s <code>rect.x</code> value to be increased and then decreased when both arrow keys are held down. This results in the ship standing still. If we used <code>elif</code> for motion to the left, the right arrow key would always have priority. Using two <code>if</code> blocks makes the movements more accurate when the player might momentarily hold down both keys when changing directions.</p>
<p>We have to make two additions to <code>_check_events()</code>:</p>
<p class="CodeLabel"><b>alien_invasion.py</b></p>
<pre><code><span class="LiteralGray">    def _check_events(self):</span>
<span class="LiteralGray">        """Respond to keypresses and mouse events."""</span>
<span class="LiteralGray">        for event in pygame.event.get():</span>
<span class="LiteralGray">            </span><em class="LiteralGrayItalic">--snip--</em>
<span class="LiteralGray">            elif event.type == pygame.KEYDOWN:</span>
<span class="LiteralGray">                if event.key == pygame.K_RIGHT:</span>
<span class="LiteralGray">                    self.ship.moving_right = True</span>
                elif event.key == pygame.K_LEFT:
                    self.ship.moving_left = True

<span class="LiteralGray">            elif event.type == pygame.KEYUP:</span>
<span class="LiteralGray">                if event.key == pygame.K_RIGHT:</span>
<span class="LiteralGray">                    self.ship.moving_right = False</span>
                elif event.key == pygame.K_LEFT:
                    self.ship.moving_left = False</code></pre>
<p>If a <code>KEYDOWN</code> event occurs for the <code>K_LEFT</code> key, we set <code>moving_left</code> to <code>True</code>. If a <code>KEYUP</code> event occurs for the <code>K_LEFT</code> key, we set <code>moving_left</code> to <code>False</code>. We can use <code>elif</code> blocks here because each event is connected to only one key. If the player presses both keys at once, two separate events will be detected.</p>
<p>When you run <em>alien_invasion.py</em> now, you should be able to move the ship continuously to the right and left. If you hold down both keys, the ship should stop moving.</p>
<p><span epub:type="pagebreak" title="242" id="Page_242"/>Next, we’ll further refine the ship’s movement. Let’s adjust the ship’s speed and limit how far the ship can move so it can’t disappear off the sides of the screen.</p>
<h3 id="h2-502703c12-0012">Adjusting the Ship’s Speed</h3>
<p class="BodyFirst">Currently, the ship moves one pixel per cycle through the <code>while</code> loop, but we can take finer control of the ship’s speed by adding a <code>ship_speed</code> attribute to the <code>Settings</code> class. We’ll use this attribute to determine how far to move the ship on each pass through the loop. Here’s the new attribute in <em>settings.py</em>:</p>
<p class="CodeLabel"><b>settings.py</b></p>
<pre><code><span class="LiteralGray">class Settings:</span>
<span class="LiteralGray">    """A class to store all settings for Alien Invasion."""</span>

<span class="LiteralGray">    def __init__(self):</span>
<span class="LiteralGray">        </span><em class="LiteralGrayItalic">--snip--</em>

        # Ship settings
        self.ship_speed = 1.5</code></pre>
<p>We set the initial value of <code>ship_speed</code> to <code>1.5</code>. When the ship moves now, its position is adjusted by 1.5 pixels (rather than 1 pixel) on each pass through the loop.</p>
<p>We’re using a float for the speed setting to give us finer control of the ship’s speed when we increase the tempo of the game later on. However, <code>rect</code> attributes such as <code>x</code> store only integer values, so we need to make some modifications to <code>Ship</code>:</p>
<p class="CodeLabel"><b>ship.py</b></p>
<pre><code><span class="LiteralGray">class Ship:</span>
<span class="LiteralGray">    """A class to manage the ship."""</span>

    <span class="LiteralGray">def __init__(self, ai_game):</span>
<span class="LiteralGray">        """Initialize the ship and set its starting position."""</span>
<span class="LiteralGray">        self.screen = ai_game.screen</span>
<span class="CodeAnnotationHang" aria-label="annotation1">❶</span>         self.settings = ai_game.settings
<span class="LiteralGray">        </span><em class="LiteralGrayItalic">--snip--</em>

<span class="LiteralGray">        # Start each new ship at the bottom center of the screen.</span>
<span class="LiteralGray">        </span><span class="LiteralGray">self.rect.midbottom = self.screen_rect.midbottom</span>

        # Store a float for the ship's exact horizontal position.
<span class="CodeAnnotationHang" aria-label="annotation2">❷</span>         self.x = float(self.rect.x)

<span class="LiteralGray">        # Movement flags; start with a ship that's not moving.</span>
<span class="LiteralGray">        self.moving_right = False</span>
<span class="LiteralGray">        self.moving_left = False</span>

<span class="LiteralGray">    def update(self):</span>
<span class="LiteralGray">        """Update the ship's position based on movement flags."""</span>
<span class="LiteralGray"> </span>       # Update the ship's x value, not the rect.
<span class="LiteralGray">        if self.moving_right:</span>
<span class="CodeAnnotationHang" aria-label="annotation3">❸</span>             self.x += self.settings.ship_speed
<span epub:type="pagebreak" title="243" id="Page_243"/><span class="LiteralGray">        if self.moving_left:</span>
            self.x -= self.settings.ship_speed

        # Update rect object from self.x.
<span class="CodeAnnotationHang" aria-label="annotation4">❹</span>         self.rect.x = self.x

<span class="LiteralGray">    def blitme(self):</span>
<span class="LiteralGray">        </span><em class="LiteralGrayItalic">--snip--</em></code></pre>
<p>We create a <code>settings</code> attribute for <code>Ship</code>, so we can use it in <code>update()</code> <span class="CodeAnnotation" aria-label="annotation1">❶</span>. Because we’re adjusting the position of the ship by fractions of a pixel, we need to assign the position to a variable that can have a float assigned to it. You can use a float to set an attribute of a <code>rect</code>, but the <code>rect</code> will only keep the integer portion of that value. To keep track of the ship’s position accurately, we define a new <code>self.x</code> <span class="CodeAnnotation" aria-label="annotation2">❷</span>. We use the <code>float()</code> function to convert the value of <code>self.rect.x</code> to a float and assign this value to <code>self.x</code>.</p>
<p>Now when we change the ship’s position in <code>update()</code>, the value of <code>self.x</code> is adjusted by the amount stored in <code>settings.ship_speed</code> <span class="CodeAnnotation" aria-label="annotation3">❸</span>. After <code>self.x</code> has been updated, we use the new value to update <code>self.rect.x</code>, which controls the position of the ship <span class="CodeAnnotation" aria-label="annotation4">❹</span>. Only the integer portion of <code>self.x</code> will be assigned to <code>self.rect.x</code>, but that’s fine for displaying the ship.</p>
<p>Now we can change the value of <code>ship_speed</code>, and any value greater than 1 will make the ship move faster. This will help make the ship respond quickly enough to shoot down aliens, and it will let us change the tempo of the game as the player progresses in gameplay.</p>
<h3 id="h2-502703c12-0013">Limiting the Ship’s Range</h3>
<p class="BodyFirst">At this point, the ship will disappear off either edge of the screen if you hold down an arrow key long enough. Let’s correct this so the ship stops moving when it reaches the screen’s edge. We do this by modifying the <code>update()</code> method in <code>Ship</code>:</p>
<p class="CodeLabel"><b>ship.py</b></p>
<pre><code><span class="LiteralGray">    def update(self):</span>
<span class="LiteralGray">        """Update the ship's position based on movement flags."""</span>
<span class="LiteralGray">        # Update the ship's x value, not the rect.</span>
<span class="CodeAnnotationHang" aria-label="annotation1">❶</span>     <span class="LiteralGray">    </span>if self.moving_right and self.rect.right &lt; self.screen_rect.right:
<span class="LiteralGray">            self.x += self.settings.ship_speed</span>
<span class="CodeAnnotationHang" aria-label="annotation2">❷</span>     <span class="LiteralGray">    </span>if self.moving_left and self.rect.left &gt; 0:
<span class="LiteralGray">            self.x -= self.settings.ship_speed</span>

<span class="LiteralGray">        # Update rect object from self.x.</span>
<span class="LiteralGray">        self.rect.x = self.x</span></code></pre>
<p>This code checks the position of the ship before changing the value of <code>self.x</code>. The code <code>self.rect.right</code> returns the <em>x</em>-coordinate of the right edge of the ship’s <code>rect</code>. If this value is less than the value returned by <code>self.screen_rect.right</code>, the ship hasn’t reached the right edge of the screen <span class="CodeAnnotation" aria-label="annotation1">❶</span>. The same goes for the left edge: if the value of the left side of the <code>rect</code> is greater than 0, the ship hasn’t reached the left edge of the screen <span class="CodeAnnotation" aria-label="annotation2">❷</span>. This ensures the ship is within these bounds before adjusting the value of <code>self.x</code>.</p>
<p><span epub:type="pagebreak" title="244" id="Page_244"/>When you run <em>alien_invasion.py</em> now, the ship should stop moving at either edge of the screen. This is pretty cool; all we’ve done is add a conditional test in an <code>if</code> statement, but it feels like the ship hits a wall or force field at either edge of the screen!</p>
<h3 id="h2-502703c12-0014">Refactoring _check_events()</h3>
<p class="BodyFirst">The <code>_check_events()</code> method will increase in length as we continue to develop the game, so let’s break <code>_check_events()</code> into two separate methods: one that handles <code>KEYDOWN</code> events and another that handles <code>KEYUP</code> events:</p>
<p class="CodeLabel"><b>alien_invasion.py</b></p>
<pre><code><span class="LiteralGray">    def _check_events(self):</span>
<span class="LiteralGray">        """Respond to keypresses and mouse events."""</span>
<span class="LiteralGray">        for event in pygame.event.get():</span>
<span class="LiteralGray">            if event.type == pygame.QUIT:</span>
<span class="LiteralGray">                sys.exit()</span>
<span class="LiteralGray">            elif event.type == pygame.KEYDOWN:</span>
<span class="LiteralGray">                </span>self._check_keydown_events(event)
<span class="LiteralGray">            elif event.type == pygame.KEYUP:</span>
<span class="LiteralGray">                </span>self._check_keyup_events(event)

    def _check_keydown_events(self, event):
        """Respond to keypresses."""
<span class="LiteralGray">        if event.key == pygame.K_RIGHT:</span>
<span class="LiteralGray">            self.ship.moving_right = True</span>
<span class="LiteralGray">        elif event.key == pygame.K_LEFT:</span>
<span class="LiteralGray">            self.ship.moving_left = True</span>

    def _check_keyup_events(self, event):
        """Respond to key releases."""
<span class="LiteralGray">        if event.key == pygame.K_RIGHT:</span>
<span class="LiteralGray">            self.ship.moving_right = False</span>
<span class="LiteralGray">        elif event.key == pygame.K_LEFT:</span>
<span class="LiteralGray">            self.ship.moving_left = False</span></code></pre>
<p>We make two new helper methods: <code>_check_keydown_events()</code> and <code>_check_keyup_events()</code>. Each needs a <code>self</code> parameter and an <code>event</code> parameter. The bodies of these two methods are copied from <code>_check_events()</code>, and we’ve replaced the old code with calls to the new methods. The <code>_check_events()</code> method is simpler now with this cleaner code structure, which will make it easier to develop further responses to player input.</p>
<h3 id="h2-502703c12-0015">Pressing Q to Quit</h3>
<p class="BodyFirst">Now that we’re responding to keypresses efficiently, we can add another way to quit the game. It gets tedious to click the X at the top of the game window to end the game every time you test a new feature, so we’ll add a keyboard shortcut to end the game when the player presses Q:</p>
<p class="CodeLabel"><b>alien_invasion.py</b></p>
<pre><code><span class="LiteralGray">    def _check_keydown_events(self, event):</span>
<span class="LiteralGray">        </span><em class="LiteralGrayItalic">--snip--</em>
<span class="LiteralGray">        elif event.key == pygame.K_LEFT:</span>
<span epub:type="pagebreak" title="245" id="Page_245"/><span class="LiteralGray">            self.ship.moving_left = True</span>
        elif event.key == pygame.K_q:
            sys.exit()</code></pre>
<p>In <code>_check_keydown_events()</code>, we add a new block that ends the game when the player presses Q. Now, when testing, you can press Q to close the game instead of using your cursor to close the window.</p>
<h3 id="h2-502703c12-0016">Running the Game in Fullscreen Mode</h3>
<p class="BodyFirst">Pygame has a fullscreen mode that you might like better than running the game in a regular window. Some games look better in fullscreen mode, and on some systems, the game may perform better overall in fullscreen mode.</p>
<p>To run the game in fullscreen mode, make the following changes in <code>__init__()</code>:</p>
<p class="CodeLabel"><b>alien_invasion.py</b></p>
<pre><code><span class="LiteralGray">    def __init__(self):</span>
<span class="LiteralGray">        """Initialize the game, and create game resources."""</span>
<span class="LiteralGray">        pygame.init()</span>
<span class="LiteralGray">        self.settings = Settings()</span>

<span class="CodeAnnotationHang" aria-label="annotation1">❶</span>         self.screen = pygame.display.set_mode((0, 0), pygame.FULLSCREEN)
<span class="CodeAnnotationHang" aria-label="annotation2">❷</span>         self.settings.screen_width = self.screen.get_rect().width
        self.settings.screen_height = self.screen.get_rect().height
 <span class="LiteralGray">       pygame.display.set_caption("Alien Invasion")</span></code></pre>
<p>When creating the screen surface, we pass a size of <code>(0, 0)</code> and the parameter <code>pygame.FULLSCREEN</code> <span class="CodeAnnotation" aria-label="annotation1">❶</span>. This tells Pygame to figure out a window size that will fill the screen. Because we don’t know the width and height of the screen ahead of time, we update these settings after the screen is created <span class="CodeAnnotation" aria-label="annotation2">❷</span>. We use the <code>width</code> and <code>height</code> attributes of the screen’s <code>rect </code>to update the <code>settings</code> object.</p>
<p>If you like how the game looks or behaves in fullscreen mode, keep these settings. If you liked the game better in its own window, you can revert back to the original approach where we set a specific screen size for the game.</p>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="note">
<h2><span class="NoteHead">Note</span></h2>
<p>	Make sure you can quit by pressing Q before running the game in fullscreen mode; Pygame offers no default way to quit a game while in fullscreen mode.</p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<h2 id="h1-502703c12-0007">A Quick Recap</h2>
<p class="BodyFirst">In the next section, we’ll add the ability to shoot bullets, which involves adding a new file called <em>bullet.py</em> and making some modifications to some of the files we’re already using. Right now, we have three files containing a number of classes and methods. To be clear about how the project is organized, let’s review each of these files before adding more functionality.</p>
<h3 id="h2-502703c12-0017"><span epub:type="pagebreak" title="246" id="Page_246"/>alien_invasion.py</h3>
<p class="BodyFirst">The main file, <em>alien_invasion.py</em>, contains the <code>AlienInvasion</code> class. This class creates a number of important attributes used throughout the game: the settings are assigned to <code>settings</code>, the main display surface is assigned to <code>screen</code>, and a <code>ship</code> instance is created in this file as well. The main loop of the game, a <code>while</code> loop, is also stored in this module. The <code>while</code> loop calls <code>_check_events()</code>, <code>ship.update()</code>, and <code>_update_screen()</code>. It also ticks the clock on each pass through the loop.</p>
<p>The <code>_check_events()</code> method detects relevant events, such as keypresses and releases, and processes each of these types of events through the methods <code>_check_keydown_events()</code> and <code>_check_keyup_events()</code>. For now, these methods manage the ship’s movement. The <code>AlienInvasion</code> class also contains <code>_update_screen()</code>, which redraws the screen on each pass through the main loop.</p>
<p>The <em>alien_invasion.py </em>file is the only file you need to run when you want to play<em> Alien Invasion</em>. The other files, <em>settings.py</em> and <em>ship.py</em>, contain code that is imported into this file.</p>
<h3 id="h2-502703c12-0018">settings.py</h3>
<p class="BodyFirst">The <em>settings.py</em> file contains the <code>Settings</code> class. This class only has an <code>__init__()</code> method, which initializes attributes controlling the game’s appearance and the ship’s speed.</p>
<h3 id="h2-502703c12-0019">ship.py</h3>
<p class="BodyFirst">The <em>ship.py</em> file contains the <code>Ship</code> class. The <code>Ship</code> class has an <code>__init__()</code> method, an <code>update()</code> method to manage the ship’s position, and a <code>blitme()</code> method to draw the ship to the screen. The image of the ship is stored in <em>ship.bmp</em>, which is in the <em>images</em> folder.</p>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="box">
<h2>Try It Yourself</h2>
<p class="BoxBodyCustom"><span id="h2-502703c12-22" class="BoxNumber">12-3.	Pygame Documentation:</span> We’re far enough into the game now that you might want to look at some of the Pygame documentation. The Pygame home page is at <a href="https://pygame.org" class="LinkURL">https://pygame.org</a>, and the home page for the documentation is at <a href="https://pygame.org/docs" class="LinkURL">https://pygame.org/docs</a>. Just skim the documentation for now. You won’t need it to complete this project, but it will help if you want to modify <em>Alien Invasion</em> or make your own game afterward.</p>
<p class="BoxBodyCustom"><span id="h2-502703c12-23" class="BoxNumber">12-4.	Rocket:</span> Make a game that begins with a rocket in the center of the screen. Allow the player to move the rocket up, down, left, or right using the four arrow keys. Make sure the rocket never moves beyond any edge of the screen.</p>
<p class="BoxBodyCustom"><span id="h2-502703c12-24" class="BoxNumber">12-5.	Keys:</span> Make a Pygame file that creates an empty screen. In the event loop, print the <code>event.key</code> attribute whenever a <code>pygame.KEYDOWN</code> event is detected. Run the program and press various keys to see how Pygame responds.</p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<h2 id="h1-502703c12-0008"><span epub:type="pagebreak" title="247" id="Page_247"/>Shooting Bullets</h2>
<p class="BodyFirst">Now let’s add the ability to shoot bullets. We’ll write code that fires a bullet, which is represented by a small rectangle, when the player presses the spacebar. Bullets will then travel straight up the screen until they disappear off the top of the screen.</p>
<h3 id="h2-502703c12-0020">Adding the Bullet Settings</h3>
<p class="BodyFirst">At the end of the <code>__init__()</code> method, we’ll update <em>settings.py</em> to include the values we’ll need for a new <code>Bullet</code> class:</p>
<p class="CodeLabel"><b>settings.py</b></p>
<pre><code><span class="LiteralGray">    def __init__(self):</span>
<span class="LiteralGray">        </span><em class="LiteralGrayItalic">--snip--</em>
   <span class="LiteralGray">    </span> # Bullet settings
  <span class="LiteralGray">    </span>  self.bullet_speed = 2.0
<span class="LiteralGray">    </span>    self.bullet_width = 3
<span class="LiteralGray">    </span>    self.bullet_height = 15
<span class="LiteralGray">    </span>    self.bullet_color = (60, 60, 60)</code></pre>
<p>These settings create dark gray bullets with a width of <code>3</code> pixels and a height of <code>15</code> pixels. The bullets will travel slightly faster than the ship.</p>
<h3 id="h2-502703c12-0021">Creating the Bullet Class</h3>
<p class="BodyFirst">Now create a <em>bullet.py </em>file to store our <code>Bullet</code> class. Here’s the first part of <em>bullet.py</em>:</p>
<p class="CodeLabel"><b>bullet.py</b></p>
<pre><code>import pygame
from pygame.sprite import Sprite

class Bullet(Sprite):
    """A class to manage bullets fired from the ship."""

    def __init__(self, ai_game):
        """Create a bullet object at the ship's current position."""
        super().__init__()
        self.screen = ai_game.screen
        self.settings = ai_game.settings
        self.color = self.settings.bullet_color

        # Create a bullet rect at (0, 0) and then set correct position.
<span class="CodeAnnotationHang" aria-label="annotation1">❶</span>         self.rect = pygame.Rect(0, 0, self.settings.bullet_width,
            self.settings.bullet_height)
<span class="CodeAnnotationHang" aria-label="annotation2">❷</span>         self.rect.midtop = ai_game.ship.rect.midtop

        # Store the bullet's position as a float.
<span class="CodeAnnotationHang" aria-label="annotation3">❸</span>         self.y = float(self.rect.y)</code></pre>
<p>The <code>Bullet</code> class inherits from <code>Sprite</code>, which we import from the <code>pygame.sprite</code> module. When you use sprites, you can group related elements in your game and act on all the grouped elements at once. To create a bullet instance, <code>__init__()</code> needs the current instance of <code>AlienInvasion</code>, and we call <code/><span epub:type="pagebreak" title="248" id="Page_248"/>super() to inherit properly from <code>Sprite</code>. We also set attributes for the screen and settings objects, and for the bullet’s color.</p>
<p>Next we create the bullet’s <code>rect</code> attribute <span class="CodeAnnotation" aria-label="annotation1">❶</span>. The bullet isn’t based on an image, so we have to build a <code>rect</code> from scratch using the <code>pygame.Rect()</code> class. This class requires the <em>x</em>- and <em>y</em>-coordinates of the top-left corner of the <code>rect</code>, and the width and height of the <code>rect</code>. We initialize the <code>rect</code> at (0, 0), but we’ll move it to the correct location in the next line, because the bullet’s position depends on the ship’s position. We get the width and height of the bullet from the values stored in <code>self.settings</code>.</p>
<p>We set the bullet’s <code>midtop</code> attribute to match the ship’s <code>midtop</code> attribute <span class="CodeAnnotation" aria-label="annotation2">❷</span>. This will make the bullet emerge from the top of the ship, making it look like the bullet is fired from the ship. We use a float for the bullet’s <em>y</em>-coordinate so we can make fine adjustments to the bullet’s speed <span class="CodeAnnotation" aria-label="annotation3">❸</span>.</p>
<p>Here’s the second part of <em>bullet.py</em>, <code>update()</code> and <code>draw_bullet()</code>:</p>
<p class="CodeLabel"><b>bullet.py</b></p>
<pre><code><code>    </code>def update(self):
    <code>    </code>"""Move the bullet up the screen."""
    <code>    </code># Update the exact position of the bullet.
<span class="CodeAnnotationHang" aria-label="annotation1">❶</span>     <code>    </code>self.y -= self.settings.bullet_speed
    <code>    </code># Update the rect position.
<span class="CodeAnnotationHang" aria-label="annotation2">❷</span>     <code>    </code>self.rect.y = self.y

<code>    </code>def draw_bullet(self):
    <code>    </code>"""Draw the bullet to the screen."""
<span class="CodeAnnotationHang" aria-label="annotation3">❸</span>     <code>    </code>pygame.draw.rect(self.screen, self.color, self.rect)</code></pre>
<p>The <code>update()</code> method manages the bullet’s position. When a bullet is fired, it moves up the screen, which corresponds to a decreasing <em>y</em>-coordinate value. To update the position, we subtract the amount stored in <code>settings.bullet_speed</code> from <code>self.y</code> <span class="CodeAnnotation" aria-label="annotation1">❶</span>. We then use the value of <code>self.y</code> to set the value of <code>self.rect.y</code> <span class="CodeAnnotation" aria-label="annotation2">❷</span>.</p>
<p>The <code>bullet_speed</code> setting allows us to increase the speed of the bullets as the game progresses or as needed to refine the game’s behavior. Once a bullet is fired, we never change the value of its <em>x</em>-coordinate, so it will travel vertically in a straight line even if the ship moves.</p>
<p>When we want to draw a bullet, we call <code>draw_bullet()</code>. The <code>draw.rect()</code> function fills the part of the screen defined by the bullet’s <code>rect</code> with the color stored in <code>self.color</code> <span class="CodeAnnotation" aria-label="annotation3">❸</span>.</p>
<h3 id="h2-502703c12-0022">Storing Bullets in a Group</h3>
<p class="BodyFirst">Now that we have a <code>Bullet</code> class and the necessary settings defined, we can write code to fire a bullet each time the player presses the spacebar. We’ll create a group in <code>AlienInvasion</code> to store all the active bullets so we can manage the bullets that have already been fired. This group will be an instance of the <code>pygame.sprite.Group</code> class, which behaves like a list with some extra functionality that’s helpful when building games. We’ll use this group to draw bullets to the screen on each pass through the main loop and to update each bullet’s position.</p>
<p><span epub:type="pagebreak" title="249" id="Page_249"/>First, we’ll import the new <code>Bullet</code> class:</p>
<p class="CodeLabel"><b>alien_invasion.py</b></p>
<pre><code><em class="LiteralGrayItalic">--snip--</em>
<span class="LiteralGray">from ship import Ship</span>
from bullet import Bullet</code></pre>
<p>Next we’ll create the group that holds the bullets in <code>__init__()</code>:</p>
<p class="CodeLabel"><b>alien_invasion.py</b></p>
<pre><code><span class="LiteralGray">    def __init__(self):</span>
<span class="LiteralGray">        </span><em class="LiteralGrayItalic">--snip--</em>
<span class="LiteralGray">        self.ship = Ship(self)</span>
<span class="LiteralGray">        </span>self.bullets = pygame.sprite.Group()</code></pre>
<p>Then we need to update the position of the bullets on each pass through the <code>while</code> loop:</p>
<p class="CodeLabel"><b>alien_invasion.py</b></p>
<pre><code><span class="LiteralGray">    def run_game(self):</span>
<span class="LiteralGray">        """Start the main loop for the game."""</span>
<span class="LiteralGray">        while True:</span>
<span class="LiteralGray">            self._check_events()</span>
<span class="LiteralGray">            self.ship.update()</span>
<span class="LiteralGray">            </span>self.bullets.update()
<span class="LiteralGray">            self._update_screen()</span>
<span class="LiteralGray">            self.clock.tick(60)</span></code></pre>
<p>When you call <code>update()</code> on a group, the group automatically calls <code>update()</code> for each sprite in the group. The line <code>self.bullets.update()</code> calls <code>bullet.update()</code> for each bullet we place in the group <code>bullets</code>.</p>
<h3 id="h2-502703c12-0023">Firing Bullets</h3>
<p class="BodyFirst">In <code>AlienInvasion</code>, we need to modify <code>_check_keydown_events()</code> to fire a bullet when the player presses the spacebar. We don’t need to change <code>_check_keyup_events()</code> because nothing happens when the spacebar is released. We also need to modify <code>_update_screen()</code> to make sure each bullet is drawn to the screen before we call <code>flip()</code>.</p>
<p>There will be a bit of work to do when we fire a bullet, so let’s write a new method, <code>_fire_bullet()</code>, to handle this work:</p>
<p class="CodeLabel"><b>alien_invasion.py</b></p>
<pre><code><span class="LiteralGray">    def _check_keydown_events(self, event):</span>
<span class="LiteralGray">        </span><em class="LiteralGrayItalic">--snip--</em>
<span class="LiteralGray">        elif event.key == pygame.K_q:</span>
<span class="LiteralGray">            sys.exit()</span>
<span class="CodeAnnotationHang" aria-label="annotation1">❶</span>         elif event.key == pygame.K_SPACE:
            self._fire_bullet()

<span class="LiteralGray">    def _check_keyup_events(self, event):</span>
<span class="LiteralGray">        </span><em class="LiteralGrayItalic">--snip--</em>

    def _fire_bullet(self):
        """Create a new bullet and add it to the bullets group."""
<span class="CodeAnnotationHang" aria-label="annotation2">❷</span>         new_bullet = Bullet(self)
<span class="CodeAnnotationHang" aria-label="annotation3">❸</span>         self.bullets.add(new_bullet)

<span epub:type="pagebreak" title="250" id="Page_250"/><span class="LiteralGray">    def _update_screen(self):</span>
<span class="LiteralGray">        """Update images on the screen, and flip to the new screen."""</span>
<span class="LiteralGray">        self.screen.fill(self.settings.bg_color)</span>
<span class="CodeAnnotationHang" aria-label="annotation4">❹</span><span class="LiteralGray">   </span>      for bullet in self.bullets.sprites():
            bullet.draw_bullet()
<span class="LiteralGray">        self.ship.blitme()</span>

<span class="LiteralGray">        pygame.display.flip()</span>
<em class="LiteralGrayItalic">--snip--</em></code></pre>
<p>We call <code>_fire_bullet()</code> when the spacebar is pressed <span class="CodeAnnotation" aria-label="annotation1">❶</span>. In <code>_fire_bullet()</code>, we make an instance of <code>Bullet</code> and call it <code>new_bullet</code> <span class="CodeAnnotation" aria-label="annotation2">❷</span>. We then add it to the group <code>bullets</code> using the <code>add()</code> method <span class="CodeAnnotation" aria-label="annotation3">❸</span>. The <code>add()</code> method is similar to <code>append()</code>, but it’s written specifically for Pygame groups.</p>
<p>The <code>bullets.sprites()</code> method returns a list of all sprites in the group <code>bullets</code>. To draw all fired bullets to the screen, we loop through the sprites in <code>bullets</code> and call <code>draw_bullet()</code> on each one <span class="CodeAnnotation" aria-label="annotation4">❹</span>. We place this loop before the line that draws the ship, so the bullets don’t start out on top of the ship.</p>
<p>When you run <em>alien_invasion.py</em> now, you should be able to move the ship right and left and fire as many bullets as you want. The bullets travel up the screen and disappear when they reach the top, as shown in <a href="#figure12-3" id="figureanchor12-3">Figure 12-3</a>. You can alter the size, color, and speed of the bullets in <em>settings.py</em>.</p>
<figure>
<img src="Images/f12003.png" class="keyline" alt="" width="590" height="407"/>
<figcaption><p><a id="figure12-3">Figure 12-3</a>: The ship after firing a series of bullets</p></figcaption>
</figure>
<h3 id="h2-502703c12-0024">Deleting Old Bullets</h3>
<p class="BodyFirst">At the moment, the bullets disappear when they reach the top, but only because Pygame can’t draw them above the top of the screen. The bullets actually continue to exist; their <em>y</em>-coordinate values just grow increasingly negative. This is a problem because they continue to consume memory and processing power.</p>
<p><span epub:type="pagebreak" title="251" id="Page_251"/>We need to get rid of these old bullets, or the game will slow down from doing so much unnecessary work. To do this, we need to detect when the <code>bottom</code> value of a bullet’s <code>rect</code> has a value of 0, which indicates the bullet has passed off the top of the screen:</p>
<p class="CodeLabel"><b>alien_invasion.py</b></p>
<pre><code><span class="LiteralGray">    def run_game(self):</span>
<span class="LiteralGray">        """Start the main loop for the game."""</span>
<span class="LiteralGray">        while True:</span>
<span class="LiteralGray">            self._check_events()</span>
<span class="LiteralGray">            self.ship.update()</span>
<span class="LiteralGray">            self.bullets.update()</span>

<span class="LiteralGray"> </span>           # Get rid of bullets that have disappeared.
<span class="CodeAnnotationHang" aria-label="annotation1">❶</span>             for bullet in self.bullets.copy():
<span class="CodeAnnotationHang" aria-label="annotation2">❷</span>                 if bullet.rect.bottom &lt;= 0:
<span class="CodeAnnotationHang" aria-label="annotation3">❸</span>                     self.bullets.remove(bullet)
<span class="CodeAnnotationHang" aria-label="annotation4">❹</span>             print(len(self.bullets))

<span class="LiteralGray">            self._update_screen()</span>
<span class="LiteralGray">            self.clock.tick(60)</span></code></pre>
<p>When you use a <code>for</code> loop with a list (or a group in Pygame), Python expects that the list will stay the same length as long as the loop is running. That means you can’t remove items from a list or group within a <code>for</code> loop, so we have to loop over a copy of the group. We use the <code>copy()</code> method to set up the <code>for</code> loop <span class="CodeAnnotation" aria-label="annotation1">❶</span>, which leaves us free to modify the original <code>bullets</code> group inside the loop. We check each bullet to see whether it has disappeared off the top of the screen <span class="CodeAnnotation" aria-label="annotation2">❷</span>. If it has, we remove it from <code>bullets</code> <span class="CodeAnnotation" aria-label="annotation3">❸</span>. We insert a <code>print()</code> call to show how many bullets currently exist in the game and verify they’re being deleted when they reach the top of the screen <span class="CodeAnnotation" aria-label="annotation4">❹</span>.</p>
<p>If this code works correctly, we can watch the terminal output while firing bullets and see that the number of bullets decreases to zero after each series of bullets has cleared the top of the screen. After you run the game and verify that bullets are being deleted properly, remove the <code>print()</code> call. If you leave it in, the game will slow down significantly because it takes more time to write output to the terminal than it does to draw graphics to the game window.</p>
<h3 id="h2-502703c12-0025">Limiting the Number of Bullets</h3>
<p class="BodyFirst">Many shooting games limit the number of bullets a player can have on the screen at one time; doing so encourages players to shoot accurately. We’ll do the same in <em>Alien Invasion</em>.</p>
<p>First, store the number of bullets allowed in <em>settings.py</em>:</p>
<p class="CodeLabel"><b>settings.py</b></p>
<pre><code><span class="LiteralGray">        # Bullet settings</span>
<span class="LiteralGray">        </span><em class="LiteralGrayItalic">--snip--</em>
<span class="LiteralGray">        self.bullet_color = (60, 60, 60)</span>
<span class="LiteralGray">        </span>self.bullets_allowed = 3</code></pre>
<p><span epub:type="pagebreak" title="252" id="Page_252"/>This limits the player to three bullets at a time. We’ll use this setting in <code>AlienInvasion</code> to check how many bullets exist before creating a new bullet in <code>_fire_bullet()</code>:</p>
<p class="CodeLabel"><b>alien_invasion.py</b></p>
<pre><code><span class="LiteralGray">    def _fire_bullet(self):</span>
<span class="LiteralGray">        """Create a new bullet and add it to the bullets group."""</span>
<span class="LiteralGray">        </span>if len(self.bullets) &lt; self.settings.bullets_allowed:
<span class="LiteralGray">            new_bullet = Bullet(self)</span>
<span class="LiteralGray">            self.bullets.add(new_bullet)</span></code></pre>
<p>When the player presses the spacebar, we check the length of <code>bullets</code>. If <code>len(self.bullets)</code> is less than three, we create a new bullet. But if three bullets are already active, nothing happens when the spacebar is pressed. When you run the game now, you should only be able to fire bullets in groups of three.</p>
<h3 id="h2-502703c12-0026">Creating the _update_bullets() Method</h3>
<p class="BodyFirst">We want to keep the <code>AlienInvasion</code> class reasonably well organized, so now that we’ve written and checked the bullet management code, we can move it to a separate method. We’ll create a new method called <code>_update_bullets()</code> and add it just before <code>_update_screen()</code>:</p>
<p class="CodeLabel"><b>alien_invasion.py</b></p>
<pre><code>    def _update_bullets(self):
        """Update position of bullets and get rid of old bullets."""
        # Update bullet positions.
<span class="LiteralGray">        self.bullets.update()</span>

<span class="LiteralGray">        # Get rid of bullets that have disappeared.</span>
<span class="LiteralGray">        for bullet in self.bullets.copy():</span>
<span class="LiteralGray">            if bullet.rect.bottom &lt;= 0:</span>
<span class="LiteralGray">                 self.bullets.remove(bullet)</span></code></pre>
<p>The code for <code>_update_bullets()</code> is cut and pasted from <code>run_game()</code>; all we’ve done here is clarify the comments.</p>
<p>The <code>while</code> loop in <code>run_game()</code> looks simple again:</p>
<p class="CodeLabel"><b>alien_invasion.py</b></p>
<pre><code><span class="LiteralGray">         while True:</span>
<span class="LiteralGray">            self._check_events()</span>
<span class="LiteralGray">            self.ship.update()</span>
<span class="LiteralGray">            </span>self._update_bullets()
<span class="LiteralGray">            self._update_screen()</span>
<span class="LiteralGray">            self.clock.tick(60)</span></code></pre>
<p>Now our main loop contains only minimal code, so we can quickly read the method names and understand what’s happening in the game. The main loop checks for player input, and then updates the position of the ship and any bullets that have been fired. We then use the updated positions to draw a new screen and tick the clock at the end of each pass through the loop.</p>
<p><span epub:type="pagebreak" title="253" id="Page_253"/>Run <em>alien_invasion.py</em> one more time, and make sure you can still fire bullets without errors.</p>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="box">
<h2>Try It Yourself</h2>
<p class="BoxBodyCustom"><span id="h2-502703c12-32" class="BoxNumber">12-6.	Sideways Shooter:</span> Write a game that places a ship on the left side of the screen and allows the player to move the ship up and down. Make the ship fire a bullet that travels right across the screen when the player presses the spacebar. Make sure bullets are deleted once they disappear off the screen.</p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<h2 id="h1-502703c12-0009">Summary</h2>
<p class="BodyFirst">In this chapter, you learned to make a plan for a game and learned the basic structure of a game written in Pygame. You learned to set a background color and store settings in a separate class where you can adjust them more easily. You saw how to draw an image to the screen and give the player control over the movement of game elements. You created elements that move on their own, like bullets flying up a screen, and you deleted objects that are no longer needed. You also learned to refactor code in a project on a regular basis to facilitate ongoing development.</p>
<p>In <span class="xref" itemid="xref_target_Chapter 13">Chapter 13</span>, we’ll add aliens to<em> Alien Invasion</em>. By the end of the chapter, you’ll be able to shoot down aliens, hopefully before they reach your ship!</p>
</section>
</div>
<div id="sbo-rt-content"><section>
<header>
<h1 class="chapter">
<span class="ChapterNumber"><span epub:type="pagebreak" title="255" id="Page_255"/>13</span><br/>
<span class="ChapterTitle">Aliens!</span></h1>
</header>
<figure class="opener">
<img src="Images/chapterart.png" alt="" width="406" height="406"/>
</figure>
<p class="ChapterIntro">In this chapter, we’ll add aliens to <em>Alien Invasion</em>. We’ll add one alien near the top of the screen and then generate a whole fleet of aliens. We’ll make the fleet advance sideways and down, and we’ll get rid of any aliens hit by a bullet. Finally, we’ll limit the number of ships a player has and end the game when the player runs out of ships.</p>
<p>As you work through this chapter, you’ll learn more about Pygame and about managing a large project. You’ll also learn to detect collisions between game objects, like bullets and aliens. Detecting collisions helps you define interactions between elements in your games. For example, you can confine a character inside the walls of a maze or pass a ball between two characters. We’ll continue to work from a plan that we revisit occasionally to maintain the focus of our code-writing sessions.</p>
<p>Before we start writing new code to add a fleet of aliens to the screen, let’s look at the project and update our plan.</p>
<h2 id="h1-502703c13-0001"><span epub:type="pagebreak" title="256" id="Page_256"/>Reviewing the Project</h2>
<p class="BodyFirst">When you’re beginning a new phase of development on a large project, it’s always a good idea to revisit your plan and clarify what you want to accomplish with the code you’re about to write. In this chapter, we’ll do the following:</p>
<ul>
<li>Add a single alien to the top-left corner of the screen, with appropriate spacing around it.</li>
<li>Fill the upper portion of the screen with as many aliens as we can fit horizontally. We’ll then create additional rows of aliens until we have a full fleet.</li>
<li>Make the fleet move sideways and down until the entire fleet is shot down, an alien hits the ship, or an alien reaches the ground. If the entire fleet is shot down, we’ll create a new fleet. If an alien hits the ship or the ground, we’ll destroy the ship and create a new fleet.</li>
<li>Limit the number of ships the player can use, and end the game when the player has used up the allotted number of ships.</li>
</ul>
<p>We’ll refine this plan as we implement features, but this is specific enough to start writing code.</p>
<p>You should also review your existing code when you begin working on a new series of features in a project. Because each new phase typically makes a project more complex, it’s best to clean up any cluttered or inefficient code. We’ve been refactoring as we go, so there isn’t any code that we need to refactor at this point.</p>
<h2 id="h1-502703c13-0002">Creating the First Alien</h2>
<p class="BodyFirst">Placing one alien on the screen is like placing a ship on the screen. Each alien’s behavior is controlled by a class called <code>Alien</code>, which we’ll structure like the <code>Ship</code> class. We’ll continue using bitmap images for simplicity. You can find your own image for an alien or use the one shown in <a href="#figure13-1" id="figureanchor13-1">Figure 13-1</a>, which is available in the book’s resources at <a href="https://ehmatthes.github.io/pcc_3e" class="LinkURL">https://ehmatthes.github.io/pcc_3e</a>. This image has a gray background, which matches the screen’s background color. Make sure you save the image file you choose in the <em>images</em> folder.</p>
<figure>
<img src="Images/f13001.png" class="keyline" alt="" width="236" height="227"/>
<figcaption><p><a id="figure13-1">Figure 13-1</a>: The alien we’ll use to build the fleet</p></figcaption>
</figure>
<h3 id="h2-502703c13-0001"><span epub:type="pagebreak" title="257" id="Page_257"/>Creating the Alien Class</h3>
<p class="BodyFirst">Now we’ll write the <code>Alien</code> class and save it as <em>alien.py</em>:</p>
<p class="CodeLabel"><b>alien.py</b></p>
<pre><code>import pygame
from pygame.sprite import Sprite

class Alien(Sprite):
    """A class to represent a single alien in the fleet."""

    def __init__(self, ai_game):
        """Initialize the alien and set its starting position."""
        super().__init__()
        self.screen = ai_game.screen

        # Load the alien image and set its rect attribute.
        self.image = pygame.image.load('images/alien.bmp')
        self.rect = self.image.get_rect()

        # Start each new alien near the top left of the screen.
<span class="CodeAnnotationHang" aria-label="annotation1">❶</span>         self.rect.x = self.rect.width
        self.rect.y = self.rect.height

        # Store the alien's exact horizontal position.
<span class="CodeAnnotationHang" aria-label="annotation2">❷</span>         self.x = float(self.rect.x)</code></pre>
<p>Most of this class is like the <code>Ship</code> class, except for the alien’s placement on the screen. We initially place each alien near the top-left corner of the screen; we add a space to the left of it that’s equal to the alien’s width and a space above it equal to its height <span class="CodeAnnotation" aria-label="annotation1">❶</span>, so it’s easy to see. We’re mainly concerned with the aliens’ horizontal speed, so we’ll track the horizontal position of each alien precisely <span class="CodeAnnotation" aria-label="annotation2">❷</span>.</p>
<p>This <code>Alien</code> class doesn’t need a method for drawing it to the screen; instead, we’ll use a Pygame group method that automatically draws all the elements of a group to the screen.</p>
<h3 id="h2-502703c13-0002">Creating an Instance of the Alien</h3>
<p class="BodyFirst">We want to create an instance of <code>Alien</code> so we can see the first alien on the screen. Because it’s part of our setup work, we’ll add the code for this instance at the end of the <code>__init__()</code> method in <code>AlienInvasion</code>. Eventually, we’ll create an entire fleet of aliens, which will be quite a bit of work, so we’ll make a new helper method called <code>_create_fleet()</code>.</p>
<p>The order of methods in a class doesn’t matter, as long as there’s some consistency to how they’re placed. I’ll place <code>_create_fleet()</code> just before the <code>_update_screen()</code> method, but anywhere in <code>AlienInvasion</code> will work. First, we’ll import the <code>Alien</code> class.</p>
<p>Here are the updated <code>import</code> statements for <em>alien_invasion.py</em>:</p>
<p class="CodeLabel"><b>alien_invasion.py</b></p>
<pre><code><em class="LiteralGrayItalic">--snip--</em>
<span class="LiteralGray">from bullet import Bullet</span>
from alien import Alien</code></pre>
<p><span epub:type="pagebreak" title="258" id="Page_258"/>And here’s the updated <code>__init__()</code> method:</p>
<p class="CodeLabel"><b>alien_invasion.py</b></p>
<pre><code><span class="LiteralGray">    def __init__(self):</span>
<span class="LiteralGray">        </span><em class="LiteralGrayItalic">--snip--</em>
<span class="LiteralGray">        self.ship = Ship(self)</span>
<span class="LiteralGray">        self.bullets = pygame.sprite.Group()</span>
        self.aliens = pygame.sprite.Group()

        self._create_fleet()</code></pre>
<p>We create a group to hold the fleet of aliens, and we call <code>_create_fleet()</code>, which we’re about to write.</p>
<p>Here’s the new <code>_create_fleet()</code> method:</p>
<p class="CodeLabel"><b>alien_invasion.py</b></p>
<pre><code>    def _create_fleet(self):
        """Create the fleet of aliens."""
        # Make an alien.
        alien = Alien(self)
        self.aliens.add(alien)</code></pre>
<p>In this method, we’re creating one instance of <code>Alien</code> and then adding it to the group that will hold the fleet. The alien will be placed in the default upper-left area of the screen.</p>
<p>To make the alien appear, we need to call the group’s <code>draw()</code> method in <code>_update_screen()</code>:</p>
<p class="CodeLabel"><b>alien_invasion.py</b></p>
<pre><code><span class="LiteralGray">    def _update_screen(self):</span>
<span class="LiteralGray">        </span><em class="LiteralGrayItalic">--snip--</em>
<span class="LiteralGray">        self.ship.blitme()</span>
<span class="LiteralGray">        </span>self.aliens.draw(self.screen)

<span class="LiteralGray">        pygame.display.flip()</span></code></pre>
<p>When you call <code>draw()</code> on a group, Pygame draws each element in the group at the position defined by its <code>rect</code> attribute. The <code>draw()</code> method requires one argument: a surface on which to draw the elements from the group. <a href="#figure13-2" id="figureanchor13-2">Figure 13-2</a> shows the first alien on the screen.</p>
<figure>
<img src="Images/f13002.png" class="keyline" alt="" width="430" height="297"/>
<figcaption><p><a id="figure13-2">Figure 13-2</a>: The first alien appears.</p></figcaption>
</figure>
<p><span epub:type="pagebreak" title="259" id="Page_259"/>Now that the first alien appears correctly, we’ll write the code to draw an entire fleet.</p>
<h2 id="h1-502703c13-0003">Building the Alien Fleet</h2>
<p class="BodyFirst">To draw a fleet, we need to figure out how to fill the upper portion of the screen with aliens, without overcrowding the game window. There are a number of ways to accomplish this goal. We’ll approach it by adding aliens across the top of the screen, until there’s no space left for a new alien. Then we’ll repeat this process, as long as we have enough vertical space to add a new row.</p>
<h3 id="h2-502703c13-0003">Creating a Row of Aliens</h3>
<p class="BodyFirst">Now we’re ready to generate a full row of aliens. To make a full row, we’ll first make a single alien so we have access to the alien’s width. We’ll place an alien on the left side of the screen and then keep adding aliens until we run out of space:</p>
<p class="CodeLabel"><b>alien_invasion.py</b></p>
<pre><code><span class="LiteralGray">    def _create_fleet(self):</span>
<span class="LiteralGray">        """Create the fleet of aliens."""</span>
        # Create an alien and keep adding aliens until there's no room left.
        # Spacing between aliens is one alien width.
<span class="LiteralGray">        alien = Alien(self)</span>
        alien_width = alien.rect.width

<span class="CodeAnnotationHang" aria-label="annotation1">❶</span>         current_x = alien_width
<span class="CodeAnnotationHang" aria-label="annotation2">❷</span>         while current_x &lt; (self.settings.screen_width - 2 * alien_width):
<span class="CodeAnnotationHang" aria-label="annotation3">❸</span>             new_alien = Alien(self)
<span class="CodeAnnotationHang" aria-label="annotation4">❹</span>             new_alien.x = current_x
            new_alien.rect.x = current_x
            self.aliens.add(new_alien)
<span class="CodeAnnotationHang" aria-label="annotation5">❺</span>             current_x += 2 * alien_width</code></pre>
<p>We get the alien’s width from the first alien we created, and then define a variable called <code>current_x</code> <span class="CodeAnnotation" aria-label="annotation1">❶</span>. This refers to the horizontal position of the next alien we intend to place on the screen. We initially set this to one alien width, to offset the first alien in the fleet from the left edge of the screen.</p>
<p>Next, we begin the <code>while</code> loop <span class="CodeAnnotation" aria-label="annotation2">❷</span>; we’re going to keep adding aliens <em>while</em> there’s enough room to place one. To determine whether there’s room to place another alien, we’ll compare <code>current_x</code> to some maximum value. A first attempt at defining this loop might look like this:</p>
<pre><code>while current_x &lt; self.settings.screen_width:</code></pre>
<p>This seems like it might work, but it would place the final alien in the row at the far-right edge of the screen. So we add a little margin on the right side of the screen. As long as there’s at least two alien widths’ worth of space at the right edge of the screen, we enter the loop and add another alien to the fleet.</p>
<p><span epub:type="pagebreak" title="260" id="Page_260"/>Whenever there’s enough horizontal space to continue the loop, we want to do two things: create an alien at the correct position, and define the horizontal position of the next alien in the row. We create an alien and assign it to <code>new_alien</code> <span class="CodeAnnotation" aria-label="annotation3">❸</span>. Then we set the precise horizontal position to the current value of <code>current_x</code> <span class="CodeAnnotation" aria-label="annotation4">❹</span>. We also position the alien’s <code>rect</code> at this same <em>x</em>-value, and add the new alien to the group <code>self.aliens</code>.</p>
<p>Finally, we increment the value of <code>current_x</code> <span class="CodeAnnotation" aria-label="annotation5">❺</span>. We add two alien widths to the horizontal position, to move past the alien we just added and to leave some space between the aliens as well. Python will re-evaluate the condition at the start of the <code>while</code> loop and decide if there’s room for another alien. When there’s no room left, the loop will end, and we should have a full row of aliens.</p>
<p>When you run <em>Alien Invasion</em> now, you should see the first row of aliens appear, as in <a href="#figure13-3" id="figureanchor13-3">Figure 13-3</a>.</p>
<figure>
<img src="Images/f13003.png" class="keyline" alt="" width="500" height="345"/>
<figcaption><p><a id="figure13-3">Figure 13-3</a>: The first row of aliens</p></figcaption>
</figure>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="note">
<h2><span class="NoteHead">Note</span></h2>
<p>	It’s not always obvious exactly how to construct a loop like the one shown in this section. One nice thing about programming is that your initial ideas for how to approach a problem like this don’t have to be correct. It’s perfectly reasonable to start a loop like this with the aliens positioned too far to the right, and then modify the loop until you have an appropriate amount of space on the screen.</p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<h3 id="h2-502703c13-0004">Refactoring _create_fleet()</h3>
<p class="BodyFirst">If the code we’ve written so far was all we needed to create a fleet, we’d probably leave <code>_create_fleet()</code> as is. But we have more work to do, so let’s clean up the method a bit. We’ll add a new helper method, <code>_create_alien()</code>, and call it from <code>_create_fleet()</code>:</p>
<p class="CodeLabel"><b>alien_invasion.py</b></p>
<pre><code><span class="LiteralGray">    def _create_fleet(self):</span>
<span class="LiteralGray">        </span><em class="LiteralGrayItalic">--snip--</em>
<span class="LiteralGray">        while current_x &lt; (self.settings.screen_width - 2 * alien_width):</span>
            self._create_alien(current_x)
            current_x += 2 * alien_width

<span epub:type="pagebreak" title="261" id="Page_261"/><span class="CodeAnnotationHang" aria-label="annotation1">❶</span>     def _create_alien(self, x_position):
        """Create an alien and place it in the row."""
<span class="LiteralGray">        new_alien = Alien(self)</span>
        new_alien.x = x_position
        new_alien.rect.x = x_position
<span class="LiteralGray">        self.aliens.add(new_alien)</span></code></pre>
<p>The method <code>_create_alien()</code> requires one parameter in addition to <code>self</code>: the <em>x</em>-value that specifies where the alien should be placed <span class="CodeAnnotation" aria-label="annotation1">❶</span>. The code in the body of <code>_create_alien()</code> is the same code that was in <code>_create_fleet()</code>, except we use the parameter name <code>x_position</code> in place of <code>current_x</code>. This refactoring will make it easier to add new rows and create an entire fleet.</p>
<h3 id="h2-502703c13-0005">Adding Rows</h3>
<p class="BodyFirst">To finish the fleet, we’ll keep adding more rows until we run out of room. We’ll use a nested loop—we’ll wrap another <code>while</code> loop around the current one. The inner loop will place aliens horizontally in a row by focusing on the aliens’ <em>x</em>-values. The outer loop will place aliens vertically by focusing on the <em>y</em>-values. We’ll stop adding rows when we get near the bottom of the screen, leaving enough space for the ship and some room to start firing at the aliens.</p>
<p>Here’s how to nest the two <code>while</code> loops in <code>_create_fleet()</code>:</p>
<pre><code><span class="LiteralGray">    def _create_fleet(self):</span>
<span class="LiteralGray">        """Create the fleet of aliens."""</span>
<span class="LiteralGray">        # Create an alien and keep adding aliens until there's no room left.</span>
        # Spacing between aliens is one alien width and one alien height.
<span class="LiteralGray">        alien = Alien(self)</span>
<span class="CodeAnnotationHang" aria-label="annotation1">❶</span>         alien_width, alien_height = alien.rect.size

<span class="CodeAnnotationHang" aria-label="annotation2">❷</span>         current_x, current_y = alien_width, alien_height
<span class="CodeAnnotationHang" aria-label="annotation3">❸</span>         while current_y &lt; (self.settings.screen_height - 3 * alien_height):
            <span class="LiteralGray">while current_x &lt; (self.settings.screen_width - 2 * alien_width):</span>
<span class="CodeAnnotationHang" aria-label="annotation4">❹</span>                 self._create_alien(current_x, current_y)
                <span class="LiteralGray">current_x += 2 * alien_width</span>

<span class="CodeAnnotationHang" aria-label="annotation5">❺</span>             # Finished a row; reset x value, and increment y value.
            current_x = alien_width
            current_y += 2 * alien_height</code></pre>
<p>We’ll need to know the alien’s height in order to place rows, so we grab the alien’s width and height using the <code>size</code> attribute of an alien <code>rect</code> <span class="CodeAnnotation" aria-label="annotation1">❶</span>. A <code>rect</code>’s <code>size</code> attribute is a tuple containing its width and height.</p>
<p>Next, we set the initial <em>x</em>- and <em>y</em>-values for the placement of the first alien in the fleet <span class="CodeAnnotation" aria-label="annotation2">❷</span>. We place it one alien width in from the left and one alien height down from the top. Then we define the <code>while</code> loop that controls how many rows are placed onto the screen <span class="CodeAnnotation" aria-label="annotation3">❸</span>. As long as the <em>y</em>-value for the next row is less than the screen height, minus three alien heights, we’ll keep adding rows. (If this doesn’t leave the right amount of space, we can adjust it later.)</p>
<p><span epub:type="pagebreak" title="262" id="Page_262"/>We call <code>_create_alien()</code>, and pass it the <em>y</em>-value as well as its <em>x</em>-position <span class="CodeAnnotation" aria-label="annotation4">❹</span>. We’ll modify <code>_create_alien()</code> in a moment.</p>
<p>Notice the indentation of the last two lines of code <span class="CodeAnnotation" aria-label="annotation5">❺</span>. They’re inside the outer <code>while</code> loop, but outside the inner <code>while</code> loop. This block runs after the inner loop is finished; it runs once after each row is created. After each row has been added, we reset the value of <code>current_x</code> so the first alien in the next row will be placed at the same position as the first alien in the previous rows. Then we add two alien heights to the current value of <code>current_y</code>, so the next row will be placed further down the screen. Indentation is really important here; if you don’t see the correct fleet when you run <em>alien_invasion.py</em> at the end of this section, check the indentation of all the lines in these nested loops.</p>
<p>We need to modify <code>_create_alien()</code> to set the vertical position of the alien correctly:</p>
<pre><code>    def _create_alien(self, x_position, y_position):
        """Create an alien and place it in the fleet."""
<span class="LiteralGray">        new_alien = Alien(self)</span>
<span class="LiteralGray">        new_alien.x = x_position</span>
<span class="LiteralGray">        new_alien.rect.x = x_position</span>
        new_alien.rect.y = y_position
<span class="LiteralGray">        self.aliens.add(new_alien)</span></code></pre>
<p>We modify the definition of the method to accept the <em>y</em>-value for the new alien, and we set the vertical position of the <code>rect</code> in the body of the method.</p>
<p>When you run the game now, you should see a full fleet of aliens, as shown in <a href="#figure13-4" id="figureanchor13-4">Figure 13-4</a>.</p>
<figure>
<img src="Images/f13004.png" class="keyline" alt="" width="550" height="380"/>
<figcaption><p><a id="figure13-4">Figure 13-4</a>: The full fleet appears.</p></figcaption>
</figure>
<p>In the next section, we’ll make the fleet move!</p>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="box">
<h2><span epub:type="pagebreak" title="263" id="Page_263"/>Try It Yourself</h2>
<p class="BoxBodyCustom"><span id="h2-502703c13-06" class="BoxNumber">13-1.	Stars:</span> Find an image of a star. Make a grid of stars appear on the screen.</p>
<p class="BoxBodyCustom"><span id="h2-502703c13-07" class="BoxNumber">13-2.	Better Stars:</span> You can make a more realistic star pattern by introducing randomness when you place each star. Recall from <span class="xref" itemid="xref_target_Chapter 9">Chapter 9</span> that you can get a random number like this:</p>
<pre><code>from random import randint
random_number = randint(-10, 10)</code></pre>
<p class="BoxBody">This code returns a random integer between −10 and 10. Using your code in Exercise 13-1, adjust each star’s position by a random amount.</p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<h2 id="h1-502703c13-0004">Making the Fleet Move</h2>
<p class="BodyFirst">Now let’s make the fleet of aliens move to the right across the screen until it hits the edge, and then make it drop a set amount and move in the other direction. We’ll continue this movement until all aliens have been shot down, one collides with the ship, or one reaches the bottom of the screen. Let’s begin by making the fleet move to the right.</p>
<h3 id="h2-502703c13-0006">Moving the Aliens Right</h3>
<p class="BodyFirst">To move the aliens, we’ll use an <code>update()</code> method in <em>alien.py</em>, which we’ll call for each alien in the group of aliens. First, add a setting to control the speed of each alien:</p>
<p class="CodeLabel"><b>settings.py</b></p>
<pre><code><span class="LiteralGray">    def __init__(self):</span>
<span class="LiteralGray">        </span><em class="LiteralGrayItalic">--snip--</em>
        # Alien settings
        self.alien_speed = 1.0</code></pre>
<p>Then use this setting to implement <code>update()</code> in <em>alien.py</em>:</p>
<p class="CodeLabel"><b>alien.py</b></p>
<pre><code><span class="LiteralGray">    def __init__(self, ai_game):</span>
<span class="LiteralGray">        """Initialize the alien and set its starting position."""</span>
<span class="LiteralGray">        super().__init__()</span>
<span class="LiteralGray">        self.screen = ai_game.screen</span>
        self.settings = ai_game.settings
        <em class="LiteralGrayItalic">--snip--</em>

<code>    </code>def update(self):
   <code>    </code> """Move the alien to the right."""
<span class="CodeAnnotationHang" aria-label="annotation1">❶</span>    <code>    </code> self.x += self.settings.alien_speed
<span class="CodeAnnotationHang" aria-label="annotation2">❷</span>    <code>    </code> self.rect.x = self.x</code></pre>
<p>We create a <code>settings</code> parameter in <code>__init__()</code> so we can access the alien’s speed in <code>update()</code>. Each time we update an alien’s position, we move it to the <span epub:type="pagebreak" title="264" id="Page_264"/>right by the amount stored in <code>alien_speed</code>. We track the alien’s exact position with the <code>self.x</code> attribute, which can hold float values <span class="CodeAnnotation" aria-label="annotation1">❶</span>. We then use the value of <code>self.x</code> to update the position of the alien’s <code>rect</code> <span class="CodeAnnotation" aria-label="annotation2">❷</span>.</p>
<p>In the main <code>while</code> loop, we already have calls to update the ship and bullet positions. Now we’ll add a call to update the position of each alien as well:</p>
<p class="CodeLabel"><b>alien_invasion.py</b></p>
<pre><code><span class="LiteralGray">        while True:</span>
<span class="LiteralGray">            self._check_events()</span>
<span class="LiteralGray">            self.ship.update()</span>
<span class="LiteralGray">            self._update_bullets()</span>
            self._update_aliens()
<span class="LiteralGray">            self._update_screen()</span>
<span class="LiteralGray">            self.clock.tick(60)</span></code></pre>
<p>We’re about to write some code to manage the movement of the fleet, so we create a new method called <code>_update_aliens()</code>. We update the aliens’ positions after the bullets have been updated, because we’ll soon be checking to see whether any bullets hit any aliens.</p>
<p>Where you place this method in the module is not critical. But to keep the code organized, I’ll place it just after <code>_update_bullets()</code> to match the order of method calls in the <code>while</code> loop. Here’s the first version of <code>_update_aliens()</code>:</p>
<p class="CodeLabel"><b>alien_invasion.py</b></p>
<pre><code>    def _update_aliens(self):
        """Update the positions of all aliens in the fleet."""
        self.aliens.update()</code></pre>
<p>We use the <code>update()</code> method on the <code>aliens</code> group, which calls each alien’s <code>update()</code> method. When you run <em>Alien Invasion</em> now, you should see the fleet move right and disappear off the side of the screen.</p>
<h3 id="h2-502703c13-0007">Creating Settings for Fleet Direction</h3>
<p class="BodyFirst">Now we’ll create the settings that will make the fleet move down the screen and to the left when it hits the right edge of the screen. Here’s how to implement this behavior:</p>
<p class="CodeLabel"><b>settings.py</b></p>
<pre><code><code>        </code><span class="LiteralGray"># Alien settings</span>
<code>        </code><span class="LiteralGray">self.alien_speed = 1.0</span>
<code>        </code>self.fleet_drop_speed = 10
<code>        </code># fleet_direction of 1 represents right; -1 represents left.
<code>        </code>self.fleet_direction = 1</code></pre>
<p>The setting <code>fleet_drop_speed</code> controls how quickly the fleet drops down the screen each time an alien reaches either edge. It’s helpful to separate this speed from the aliens’ horizontal speed so you can adjust the two speeds independently.</p>
<p>To implement the setting <code>fleet_direction</code>, we could use a text value such as <code>'left'</code> or <code>'right'</code>, but we’d end up with <code>if</code>-<code>elif</code> statements testing for the fleet direction. Instead, because we only have two directions to deal with, let’s use the values 1 and −1 and switch between them each time the fleet <span epub:type="pagebreak" title="265" id="Page_265"/>changes direction. (Using numbers also makes sense because moving right involves adding to each alien’s <em>x</em>-coordinate value, and moving left involves subtracting from each alien’s <em>x</em>-coordinate value.)</p>
<h3 id="h2-502703c13-0008">Checking Whether an Alien Has Hit the Edge</h3>
<p class="BodyFirst">We need a method to check whether an alien is at either edge, and we need to modify <code>update()</code> to allow each alien to move in the appropriate direction. This code is part of the <code>Alien</code> class:</p>
<p class="CodeLabel"><b>alien.py</b></p>
<pre><code><code>    </code>def check_edges(self):
    <code>    </code>"""Return True if alien is at edge of screen."""
    <code>    </code>screen_rect = self.screen.get_rect()
<span class="CodeAnnotationHang" aria-label="annotation1">❶</span>     <code>    </code>return (self.rect.right &gt;= screen_rect.right) or (self.rect.left &lt;= 0)

<code>    </code><span class="LiteralGray">def update(self):</span>
    <code>    </code>"""Move the alien right or left."""
<span class="CodeAnnotationHang" aria-label="annotation2">❷</span>     <code>    </code>self.x += self.settings.alien_speed * self.settings.fleet_direction
<code>    </code><span class="LiteralGray">    self.rect.x = self.x</span></code></pre>
<p>We can call the new method <code>check_edges()</code> on any alien to see whether it’s at the left or right edge. The alien is at the right edge if the <code>right</code> attribute of its <code>rect</code> is greater than or equal to the <code>right</code> attribute of the screen’s <code>rect</code>. It’s at the left edge if its <code>left</code> value is less than or equal to 0 <span class="CodeAnnotation" aria-label="annotation1">❶</span>. Rather than put this conditional test in an <code>if</code> block, we put the test directly in the <code>return</code> statement. This method will return <code>True</code> if the alien is at the right or left edge, and <code>False</code> if it is not at either edge.</p>
<p>We modify the method <code>update()</code> to allow motion to the left or right by multiplying the alien’s speed by the value of <code>fleet_direction</code> <span class="CodeAnnotation" aria-label="annotation2">❷</span>. If <code>fleet_direction</code> is 1, the value of <code>alien_speed</code> will be added to the alien’s current position, moving the alien to the right; if <code>fleet_direction</code> is −1, the value will be subtracted from the alien’s position, moving the alien to the left.</p>
<h3 id="h2-502703c13-0009">Dropping the Fleet and Changing Direction</h3>
<p class="BodyFirst">When an alien reaches the edge, the entire fleet needs to drop down and change direction. Therefore, we need to add some code to <code>AlienInvasion</code> because that’s where we’ll check whether any aliens are at the left or right edge. We’ll make this happen by writing the methods <code>_check_fleet_edges()</code> and <code>_change_fleet_direction()</code>, and then modifying <code>_update_aliens()</code>. I’ll put these new methods after <code>_create_alien()</code>, but again, the placement of these methods in the class isn’t critical.</p>
<p class="CodeLabel"><b>alien_invasion.py</b></p>
<pre><code>    def _check_fleet_edges(self):
        """Respond appropriately if any aliens have reached an edge."""
<span class="CodeAnnotationHang" aria-label="annotation1">❶</span>         for alien in self.aliens.sprites():
            if alien.check_edges():
<span class="CodeAnnotationHang" aria-label="annotation2">❷</span>                 self._change_fleet_direction()
                break

    def _change_fleet_direction(self):
<span epub:type="pagebreak" title="266" id="Page_266"/>        """Drop the entire fleet and change the fleet's direction."""
        for alien in self.aliens.sprites():
<span class="CodeAnnotationHang" aria-label="annotation3">❸</span>             alien.rect.y += self.settings.fleet_drop_speed
        self.settings.fleet_direction *= -1</code></pre>
<p>In <code>_check_fleet_edges()</code>, we loop through the fleet and call <code>check_edges()</code> on each alien <span class="CodeAnnotation" aria-label="annotation1">❶</span>. If <code>check_edges()</code> returns <code>True</code>, we know an alien is at an edge and the whole fleet needs to change direction; so we call <code>_change_fleet_direction()</code> and break out of the loop <span class="CodeAnnotation" aria-label="annotation2">❷</span>. In <code>_change_fleet_direction()</code>, we loop through all the aliens and drop each one using the setting <code>fleet_drop_speed</code> <span class="CodeAnnotation" aria-label="annotation3">❸</span>; then we change the value of <code>fleet_direction</code> by multiplying its current value by −1. The line that changes the fleet’s direction isn’t part of the <code>for</code> loop. We want to change each alien’s vertical position, but we only want to change the direction of the fleet once.</p>
<p>Here are the changes to <code>_update_aliens()</code>:</p>
<p class="CodeLabel"><b>alien_invasion.py</b></p>
<pre><code><span class="LiteralGray">    def _update_aliens(self):</span>
        """Check if the fleet is at an edge, then update positions."""
        self._check_fleet_edges()
   <span class="LiteralGray">     self.aliens.update()</span></code></pre>
<p>We’ve modified the method by calling <code>_check_fleet_edges()</code> before updating each alien’s position.</p>
<p>When you run the game now, the fleet should move back and forth between the edges of the screen and drop down every time it hits an edge. Now we can start shooting down aliens and watch for any aliens that hit the ship or reach the bottom of the screen.</p>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="box">
<h2>Try It Yourself</h2>
<p class="BoxBodyCustom"><span id="h2-502703c13-12" class="BoxNumber">13-3.	Raindrops:</span> Find an image of a raindrop and create a grid of raindrops. Make the raindrops fall toward the bottom of the screen until they disappear.</p>
<p class="BoxBodyCustom"><span id="h2-502703c13-13" class="BoxNumber">13-4.	Steady Rain:</span> Modify your code in Exercise 13-3 so when a row of raindrops disappears off the bottom of the screen, a new row appears at the top of the screen and begins to fall.</p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<h2 id="h1-502703c13-0005">Shooting Aliens</h2>
<p class="BodyFirst">We’ve built our ship and a fleet of aliens, but when the bullets reach the aliens, they simply pass through because we aren’t checking for collisions. In game programming, <em>collisions</em> happen when game elements overlap. To make the bullets shoot down aliens, we’ll use the function <code>sprite.groupcollide()</code> to look for collisions between members of two groups.</p>
<h3 id="h2-502703c13-0010"><span epub:type="pagebreak" title="267" id="Page_267"/>Detecting Bullet Collisions</h3>
<p class="BodyFirst">We want to know right away when a bullet hits an alien so we can make an alien disappear as soon as it’s hit. To do this, we’ll look for collisions immediately after updating the position of all the bullets.</p>
<p>The <code>sprite.groupcollide()</code> function compares the <code>rect</code>s of each element in one group with the <code>rect</code>s of each element in another group. In this case, it compares each bullet’s <code>rect</code> with each alien’s <code>rect</code> and returns a dictionary containing the bullets and aliens that have collided. Each key in the dictionary will be a bullet, and the corresponding value will be the alien that was hit. (We’ll also use this dictionary when we implement a scoring system in <span class="xref" itemid="xref_target_Chapter 14">Chapter 14</span>.)</p>
<p>Add the following code to the end of <code>_update_bullets()</code> to check for collisions between bullets and aliens:</p>
<p class="CodeLabel"><b>alien_invasion.py</b></p>
<pre><code><span class="LiteralGray">    def _update_bullets(self):</span>
<span class="LiteralGray">        """Update position of bullets and get rid of old bullets."""</span>
<span class="LiteralGray">        </span><em class="LiteralGrayItalic">--snip--</em>

        # Check for any bullets that have hit aliens.
        #   If so, get rid of the bullet and the alien.
        collisions = pygame.sprite.groupcollide(
                self.bullets, self.aliens, True, True)</code></pre>
<p>The new code we added compares the positions of all the bullets in <code>self.bullets</code> and all the aliens in <code>self.aliens</code>, and identifies any that overlap. Whenever the <code>rect</code>s of a bullet and alien overlap, <code>groupcollide()</code> adds a key-value pair to the dictionary it returns. The two <code>True</code> arguments tell Pygame to delete the bullets and aliens that have collided. (To make a high-powered bullet that can travel to the top of the screen, destroying every alien in its path, you could set the first Boolean argument to <code>False</code> and keep the second Boolean argument set to <code>True</code>. The aliens hit would disappear, but all bullets would stay active until they disappeared off the top of the screen.)</p>
<p>When you run <em>Alien Invasion</em> now, aliens you hit should disappear. <a href="#figure13-5" id="figureanchor13-5">Figure 13-5</a> shows a fleet that has been partially shot down.</p>
<figure>
<img src="Images/f13005.png" class="keyline" alt="" width="500" height="345"/>
<figcaption><p><a id="figure13-5">Figure 13-5</a>: We can shoot aliens!</p></figcaption>
</figure>
<h3 id="h2-502703c13-0011"><span epub:type="pagebreak" title="268" id="Page_268"/>Making Larger Bullets for Testing</h3>
<p class="BodyFirst">You can test many features of <em>Alien Invasion</em> simply by running the game, but some features are tedious to test in the normal version of the game. For example, it’s a lot of work to shoot down every alien on the screen multiple times to test whether your code responds to an empty fleet correctly.</p>
<p>To test particular features, you can change certain game settings to focus on a particular area. For example, you might shrink the screen so there are fewer aliens to shoot down or increase the bullet speed and give yourself lots of bullets at once.</p>
<p>My favorite change for testing <em>Alien Invasion</em> is to use really wide bullets that remain active even after they’ve hit an alien (see <a href="#figure13-6" id="figureanchor13-6">Figure 13-6</a>). Try setting <code>bullet_width</code> to 300, or even 3,000, to see how quickly you can shoot down the fleet!</p>
<figure>
<img src="Images/f13006.png" class="keyline" alt="" width="550" height="380"/>
<figcaption><p><a id="figure13-6">Figure 13-6</a>: Extra-powerful bullets make some aspects of the game easier to test.</p></figcaption>
</figure>
<p>Changes like these will help you test the game more efficiently and possibly spark ideas for giving players bonus powers. Just remember to restore the settings to normal when you’re finished testing a feature.</p>
<h3 id="h2-502703c13-0012">Repopulating the Fleet</h3>
<p class="BodyFirst">One key feature of <em>Alien Invasion</em> is that the aliens are relentless: every time the fleet is destroyed, a new fleet should appear.</p>
<p>To make a new fleet of aliens appear after a fleet has been destroyed, we first check whether the <code>aliens</code> group is empty. If it is, we make a call to <code>_create_fleet()</code>. We’ll perform this check at the end of <code>_update_bullets()</code>, because that’s where individual aliens are destroyed.</p>
<p class="CodeLabel"><b>alien_invasion.py</b></p>
<pre><code><span class="LiteralGray">    def _update_bullets(self):</span>
<span class="LiteralGray">        </span><em class="LiteralGrayItalic">--snip--</em>
<span class="CodeAnnotationHang" aria-label="annotation1">❶</span>         if not self.aliens:
<span epub:type="pagebreak" title="269" id="Page_269"/>            # Destroy existing bullets and create new fleet.
<span class="CodeAnnotationHang" aria-label="annotation2">❷</span>             self.bullets.empty()
            self._create_fleet()</code></pre>
<p>We check whether the <code>aliens</code> group is empty <span class="CodeAnnotation" aria-label="annotation1">❶</span>. An empty group evaluates to <code>False</code>, so this is a simple way to check whether the group is empty. If it is, we get rid of any existing bullets by using the <code>empty()</code> method, which removes all the remaining sprites from a group <span class="CodeAnnotation" aria-label="annotation2">❷</span>. We also call <code>_create_fleet()</code>, which fills the screen with aliens again.</p>
<p>Now a new fleet appears as soon as you destroy the current fleet.</p>
<h3 id="h2-502703c13-0013">Speeding Up the Bullets</h3>
<p class="BodyFirst">If you’ve tried firing at the aliens in the game’s current state, you might find that the bullets aren’t traveling at the best speed for gameplay. They might be a little too slow or a little too fast. At this point, you can modify the settings to make the gameplay more interesting. Keep in mind that the game is going to get progressively faster, so don’t make the game too fast at the beginning.</p>
<p>We modify the speed of the bullets by adjusting the value of <code>bullet_speed</code> in <em>settings.py</em>. On my system, I’ll adjust the value of <code>bullet_speed</code> to 2.5, so the bullets travel a little faster:</p>
<p class="CodeLabel"><b>settings.py</b></p>
<pre><code><span class="LiteralGray">        # Bullet settings</span>
        self.bullet_speed = 2.5
    <span class="LiteralGray">    self.bullet_width = 3</span>
<span class="LiteralGray">        </span><em class="LiteralGrayItalic">--snip--</em></code></pre>
<p>The best value for this setting depends on your experience of the game, so find a value that works for you. You can adjust other settings as well.</p>
<h3 id="h2-502703c13-0014">Refactoring _update_bullets()</h3>
<p class="BodyFirst">Let’s refactor <code>_update_bullets()</code> so it’s not doing so many different tasks. We’ll move the code for dealing with bullet-alien collisions to a separate method:</p>
<p class="CodeLabel"><b>alien_invasion.py</b></p>
<pre><code><span class="LiteralGray">   def _update_bullets(self):</span>
<span class="LiteralGray">        </span><em class="LiteralGrayItalic">--snip--</em>
<span class="LiteralGray">        # Get rid of bullets that have disappeared.</span>
<span class="LiteralGray">        for bullet in self.bullets.copy():</span>
<span class="LiteralGray">            if bullet.rect.bottom &lt;= 0:</span>
<span class="LiteralGray">                 self.bullets.remove(bullet)</span>

<span class="LiteralGray">        </span>self._check_bullet_alien_collisions()

<span class="LiteralGray">    </span>def _check_bullet_alien_collisions(self):
        """Respond to bullet-alien collisions."""
        # Remove any bullets and aliens that have collided.
<span class="LiteralGray">        collisions = pygame.sprite.groupcollide(</span>
<span class="LiteralGray">                self.bullets, self.aliens, True, True)</span>

<span epub:type="pagebreak" title="270" id="Page_270"/><span class="LiteralGray">        if not self.aliens:</span>
<span class="LiteralGray">            # Destroy existing bullets and create new fleet.</span>
<span class="LiteralGray">            self.bullets.empty()</span>
<span class="LiteralGray">            self._create_fleet()</span></code></pre>
<p>We’ve created a new method, <code>_check_bullet_alien_collisions()</code>, to look for collisions between bullets and aliens and to respond appropriately if the entire fleet has been destroyed. Doing so keeps <code>_update_bullets()</code> from growing too long and simplifies further development.</p>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="box">
<h2>Try It Yourself</h2>
<p class="BoxBodyCustom"><span id="h2-502703c13-19" class="BoxNumber">13-5.	Sideways Shooter Part 2:</span> We’ve come a long way since Exercise 12-6, <em>Sideways Shooter</em>. For this exercise, try to develop <em>Sideways Shooter</em> to the same point we’ve brought <em>Alien Invasion</em> to. Add a fleet of aliens, and make them move sideways toward the ship. Or, write code that places aliens at random positions along the right side of the screen and then sends them toward the ship. Also, write code that makes the aliens disappear when they’re hit.</p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<h2 id="h1-502703c13-0006">Ending the Game</h2>
<p class="BodyFirst">What’s the fun and challenge in playing a game you can’t lose? If the player doesn’t shoot down the fleet quickly enough, we’ll have the aliens destroy the ship when they make contact. At the same time, we’ll limit the number of ships a player can use, and we’ll destroy the ship when an alien reaches the bottom of the screen. The game will end when the player has used up all their ships.</p>
<h3 id="h2-502703c13-0015">Detecting Alien-Ship Collisions</h3>
<p class="BodyFirst">We’ll start by checking for collisions between aliens and the ship so we can respond appropriately when an alien hits it. We’ll check for alien-ship collisions immediately after updating the position of each alien in <code>AlienInvasion</code>:</p>
<p class="CodeLabel"><b>alien_invasion.py</b></p>
<pre><code><span class="LiteralGray">    def _update_aliens(self):</span>
<span class="LiteralGray">        </span><em class="LiteralGrayItalic">--snip--</em>
<span class="LiteralGray">        self.aliens.update()</span>

        # Look for alien-ship collisions.
<span class="CodeAnnotationHang" aria-label="annotation1">❶</span>         if pygame.sprite.spritecollideany(self.ship, self.aliens):
<span class="CodeAnnotationHang" aria-label="annotation2">❷</span>             print("Ship hit!!!")</code></pre>
<p>The <code>spritecollideany()</code> function takes two arguments: a sprite and a group. The function looks for any member of the group that has collided with the sprite and stops looping through the group as soon as it finds one member that has collided with the sprite. Here, it loops through the group <code>aliens</code> and returns the first alien it finds that has collided with <code>ship</code>.</p>
<p><span epub:type="pagebreak" title="271" id="Page_271"/>If no collisions occur, <code>spritecollideany()</code> returns <code>None</code> and the <code>if</code> block won’t execute <span class="CodeAnnotation" aria-label="annotation1">❶</span>. If it finds an alien that has collided with the ship, it returns that alien and the <code>if</code> block executes: it prints <code>Ship hit!!!</code> <span class="CodeAnnotation" aria-label="annotation2">❷</span>. When an alien hits the ship, we’ll need to do a number of tasks: delete all remaining aliens and bullets, recenter the ship, and create a new fleet. Before we write code to do all this, we want to know that our approach to detecting alien-ship collisions works correctly. Writing a <code>print()</code> call is a simple way to ensure we’re detecting these collisions properly.</p>
<p>Now when you run <em>Alien Invasion,</em> the message <em>Ship hit!!!</em> should appear in the terminal whenever an alien runs into the ship. When you’re testing this feature, set <code>fleet_drop_speed</code> to a higher value, such as 50 or 100, so the aliens reach your ship faster.</p>
<h3 id="h2-502703c13-0016">Responding to Alien-Ship Collisions</h3>
<p class="BodyFirst">Now we need to figure out exactly what will happen when an alien collides with the ship. Instead of destroying the <code>ship</code> instance and creating a new one, we’ll count how many times the ship has been hit by tracking statistics for the game. Tracking statistics will also be useful for scoring.</p>
<p>Let’s write a new class, <code>GameStats</code>, to track game statistics, and let’s save it as <em>game_stats.py</em>:</p>
<p class="CodeLabel"><b>game_stats.py</b></p>
<pre><code>class GameStats:
    """Track statistics for Alien Invasion."""

    def __init__(self, ai_game):
        """Initialize statistics."""
        self.settings = ai_game.settings
<span class="CodeAnnotationHang" aria-label="annotation1">❶</span>         self.reset_stats()

    def reset_stats(self):
        """Initialize statistics that can change during the game."""
        self.ships_left = self.settings.ship_limit</code></pre>
<p>We’ll make one <code>GameStats</code> instance for the entire time <em>Alien Invasion</em> is running, but we’ll need to reset some statistics each time the player starts a new game. To do this, we’ll initialize most of the statistics in the <code>reset_stats()</code> method, instead of directly in <code>__init__()</code>. We’ll call this method from <code>__init__()</code> so the statistics are set properly when the <code>GameStats</code> instance is first created <span class="CodeAnnotation" aria-label="annotation1">❶</span>. But we’ll also be able to call <code>reset_stats()</code> anytime the player starts a new game. Right now we have only one statistic, <code>ships_left</code>, the value of which will change throughout the game.</p>
<p>The number of ships the player starts with should be stored in <em>settings.py</em> as <code>ship_limit</code>:</p>
<p class="CodeLabel"><b>settings.py</b></p>
<pre><code><code>        </code><span class="LiteralGray"># Ship settings</span>
        <span class="LiteralGray">self.ship_speed = 1.5</span>
        self.ship_limit = 3</code></pre>
<p><span epub:type="pagebreak" title="272" id="Page_272"/>We also need to make a few changes in <em>alien_invasion.py</em> to create an instance of <code>GameStats</code>. First, we’ll update the <code>import</code> statements at the top of the file:</p>
<p class="CodeLabel"><b>alien_invasion.py</b></p>
<pre><code><span class="LiteralGray">import sys</span>
from time import sleep

<span class="LiteralGray">import pygame</span>

<span class="LiteralGray">from settings import Settings</span>
from game_stats import GameStats
<span class="LiteralGray">from ship import Ship</span>
<em class="LiteralGrayItalic">--snip--</em></code></pre>
<p>We import the <code>sleep()</code> function from the <code>time</code> module in the Python standard library, so we can pause the game for a moment when the ship is hit. We also import <code>GameStats</code>.</p>
<p>We’ll create an instance of <code>GameStats</code> in <code>__init__()</code>:</p>
<p class="CodeLabel"><b>alien_invasion.py</b></p>
<pre><code><span class="LiteralGray">    def __init__(self):</span>
<span class="LiteralGray">        </span><em class="LiteralGrayItalic">--snip--</em>
<span class="LiteralGray">        self.screen = pygame.display.set_mode(</span>
<span class="LiteralGray">            (self.settings.screen_width, self.settings.screen_height))</span>
<span class="LiteralGray">        pygame.display.set_caption("Alien Invasion")</span>

        # Create an instance to store game statistics.
        self.stats = GameStats(self)

<span class="LiteralGray">        self.ship = Ship(self)</span>
<span class="LiteralGray">        </span><em class="LiteralGrayItalic">--snip--</em></code></pre>
<p>We make the instance after creating the game window but before defining other game elements, such as the ship.</p>
<p>When an alien hits the ship, we’ll subtract 1 from the number of ships left, destroy all existing aliens and bullets, create a new fleet, and reposition the ship in the middle of the screen. We’ll also pause the game for a moment so the player can notice the collision and regroup before a new fleet appears.</p>
<p>Let’s put most of this code in a new method called <code>_ship_hit()</code>. We’ll call this method from <code>_update_aliens()</code> when an alien hits the ship:</p>
<p class="CodeLabel"><b>alien_invasion.py</b></p>
<pre><code>    def _ship_hit(self):
        """Respond to the ship being hit by an alien."""
        # Decrement ships_left.
<span class="CodeAnnotationHang" aria-label="annotation1">❶</span>         self.stats.ships_left -= 1

        # Get rid of any remaining bullets and aliens.
<span class="CodeAnnotationHang" aria-label="annotation2">❷</span>         self.bullets.empty()
        self.aliens.empty()

        # Create a new fleet and center the ship.
<span class="CodeAnnotationHang" aria-label="annotation3">❸</span>         self._create_fleet()
        self.ship.center_ship()

<span epub:type="pagebreak" title="273" id="Page_273"/>        # Pause.
<span class="CodeAnnotationHang" aria-label="annotation4">❹</span>         sleep(0.5)</code></pre>
<p>The new method <code>_ship_hit()</code> coordinates the response when an alien hits a ship. Inside <code>_ship_hit()</code>, the number of ships left is reduced by 1 <span class="CodeAnnotation" aria-label="annotation1">❶</span>, after which we empty the groups <code>bullets</code> and <code>aliens</code> <span class="CodeAnnotation" aria-label="annotation2">❷</span>.</p>
<p>Next, we create a new fleet and center the ship <span class="CodeAnnotation" aria-label="annotation3">❸</span>. (We’ll add the method <code>center_ship()</code> to <code>Ship</code> in a moment.) Then we add a pause after the updates have been made to all the game elements but before any changes have been drawn to the screen, so the player can see that their ship has been hit <span class="CodeAnnotation" aria-label="annotation4">❹</span>. The <code>sleep()</code> call pauses program execution for half a second, long enough for the player to see that the alien has hit the ship. When the <code>sleep()</code> function ends, code execution moves on to the <code>_update_screen()</code> method, which draws the new fleet to the screen.</p>
<p>In <code>_update_aliens()</code>, we replace the <code>print()</code> call with a call to <code>_ship_hit()</code> when an alien hits the ship:</p>
<p class="CodeLabel"><b>alien_invasion.py</b></p>
<pre><code>    <span class="LiteralGray">def _update_aliens(self):</span>
<span class="LiteralGray">        </span><em class="LiteralGrayItalic">--snip--</em>
<span class="LiteralGray">        if pygame.sprite.spritecollideany(self.ship, self.aliens):</span>
            self._ship_hit()</code></pre>
<p>Here’s the new method <code>center_ship()</code>, which belongs in <em>ship.py</em>:</p>
<p class="CodeLabel"><b>ship.py</b></p>
<pre><code><code>    </code>def center_ship(self):
        """Center the ship on the screen."""
        self.rect.midbottom = self.screen_rect.midbottom
        self.x = float(self.rect.x)</code></pre>
<p>We center the ship the same way we did in <code>__init__()</code>. After centering it, we reset the <code>self.x</code> attribute, which allows us to track the ship’s exact position.</p>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="note">
<h2><span class="NoteHead">Note</span></h2>
<p>	Notice that we never make more than one ship; we make only one ship instance for the whole game and recenter it whenever the ship has been hit. The statistic <code>ships_left</code> will tell us when the player has run out of ships.</p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<p>Run the game, shoot a few aliens, and let an alien hit the ship. The game should pause, and a new fleet should appear with the ship centered at the bottom of the screen again.</p>
<h3 id="h2-502703c13-0017">Aliens That Reach the Bottom of the Screen</h3>
<p class="BodyFirst">If an alien reaches the bottom of the screen, we’ll have the game respond the same way it does when an alien hits the ship. To check when this happens, add a new method in <em>alien_invasion.py</em>:</p>
<p class="CodeLabel"><b>alien_invasion.py</b></p>
<pre><code>    def _check_aliens_bottom(self):
        """Check if any aliens have reached the bottom of the screen."""
        for alien in self.aliens.sprites():
<span epub:type="pagebreak" title="274" id="Page_274"/><span class="CodeAnnotationHang" aria-label="annotation1">❶</span>             if alien.rect.bottom &gt;= self.settings.screen_height:
                # Treat this the same as if the ship got hit.
                self._ship_hit()
                break</code></pre>
<p>The method <code>_check_aliens_bottom()</code> checks whether any aliens have reached the bottom of the screen. An alien reaches the bottom when its <code>rect.bottom</code> value is greater than or equal to the screen’s height <span class="CodeAnnotation" aria-label="annotation1">❶</span>. If an alien reaches the bottom, we call <code>_ship_hit()</code>. If one alien hits the bottom, there’s no need to check the rest, so we break out of the loop after calling <code>_ship_hit()</code>.</p>
<p>We’ll call this method from <code>_update_aliens()</code>:</p>
<p class="CodeLabel"><b>alien_invasion.py</b></p>
<pre><code><span class="LiteralGray">    def _update_aliens(self):</span>
<span class="LiteralGray">        </span><em class="LiteralGrayItalic">--snip--</em>
<span class="LiteralGray">        # Look for alien-ship collisions.</span>
<span class="LiteralGray">        if pygame.sprite.spritecollideany(self.ship, self.aliens):</span>
<span class="LiteralGray">            self._ship_hit()</span>

        # Look for aliens hitting the bottom of the screen.
        self._check_aliens_bottom()</code></pre>
<p>We call <code>_check_aliens_bottom()</code> after updating the positions of all the aliens and after looking for alien-ship collisions. Now a new fleet will appear every time the ship is hit by an alien or an alien reaches the bottom of the screen.</p>
<h3 id="h2-502703c13-0018">Game Over!</h3>
<p class="BodyFirst"><em>Alien Invasion</em> feels more complete now, but the game never ends. The value of <code>ships_left</code> just grows increasingly negative. Let’s add a <code>game_active</code> flag, so we can end the game when the player runs out of ships. We’ll set this flag at the end of the <code>__init__()</code> method in <code>AlienInvasion</code>:</p>
<p class="CodeLabel"><b>alien_invasion.py</b></p>
<pre><code><span class="LiteralGray">    def __init__(self):</span>
<span class="LiteralGray">        </span><em class="LiteralGrayItalic">--snip--</em>
   <span class="LiteralGray">    </span> # Start Alien Invasion in an active state.
   <span class="LiteralGray">    </span> self.game_active = True</code></pre>
<p>Now we add code to <code>_ship_hit()</code> that sets <code>game_active</code> to <code>False</code> when the player has used up all their ships:</p>
<p class="CodeLabel"><b>alien_invasion.py</b></p>
<pre><code><span class="LiteralGray">    def _ship_hit(self):</span>
<span class="LiteralGray">        """Respond to ship being hit by alien."""</span>
        if self.stats.ships_left &gt; 0:
           <span class="LiteralGray"> # Decrement ships_left.</span>
<span class="LiteralGray">            self.stats.ships_left -= 1</span>
<span class="LiteralGray">            </span><em class="LiteralGrayItalic">--snip--</em>
<span class="LiteralGray">            # Pause.</span>
<span class="LiteralGray">            sleep(0.5)</span>
        else:
           <span class="LiteralGray"> </span>self.game_active = False</code></pre>
<p><span epub:type="pagebreak" title="275" id="Page_275"/>Most of <code>_ship_hit()</code> is unchanged. We’ve moved all the existing code into an <code>if</code> block, which tests to make sure the player has at least one ship remaining. If so, we create a new fleet, pause, and move on. If the player has no ships left, we set <code>game_active</code> to <code>False</code>.</p>
<h3 id="h2-502703c13-0019">Identifying When Parts of the Game Should Run</h3>
<p class="BodyFirst">We need to identify the parts of the game that should always run and the parts that should run only when the game is active:</p>
<p class="CodeLabel"><b>alien_invasion.py</b></p>
<pre><code><span class="LiteralGray">    def run_game(self):</span>
<span class="LiteralGray">        """Start the main loop for the game."""</span>
<span class="LiteralGray">        while True:</span>
<span class="LiteralGray">            self._check_events()</span>

<span class="LiteralGray">      </span>      if self.game_active:
<span class="LiteralGray">                self.ship.update()</span>
<span class="LiteralGray">                self._update_bullets()</span>
<span class="LiteralGray">                self._update_aliens()</span>

<span class="LiteralGray">            self._update_screen()</span>
<span class="LiteralGray">            self.clock.tick(60)</span></code></pre>
<p>In the main loop, we always need to call <code>_check_events()</code>, even if the game is inactive. For example, we still need to know if the user presses Q to quit the game or clicks the button to close the window. We also continue updating the screen so we can make changes to the screen while waiting to see whether the player chooses to start a new game. The rest of the function calls need to happen only when the game is active, because when the game is inactive, we don’t need to update the positions of game elements.</p>
<p>Now when you play <em>Alien Invasion</em>, the game should freeze when you’ve used up all your ships.</p>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="box">
<h2>Try It Yourself</h2>
<p class="BoxBodyCustom"><span id="h2-502703c13-25" class="BoxNumber">13-6.	Game Over:</span> In <em>Sideways Shooter</em>, keep track of the number of times the ship is hit and the number of times an alien is hit by the ship. Decide on an appropriate condition for ending the game, and stop the game when this situation occurs.</p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<h2 id="h1-502703c13-0007">Summary</h2>
<p class="BodyFirst">In this chapter, you learned how to add a large number of identical elements to a game by creating a fleet of aliens. You used nested loops to create a grid of elements, and you made a large set of game elements move by calling each element’s <code>update()</code> method. You learned to control the direction of <span epub:type="pagebreak" title="276" id="Page_276"/>objects on the screen and to respond to specific situations, such as when the fleet reaches the edge of the screen. You detected and responded to collisions when bullets hit aliens and aliens hit the ship. You also learned how to track statistics in a game and use a <code>game_active</code> flag to determine when the game is over.</p>
<p>In the next and final chapter of this project, we’ll add a Play button so the player can choose when to start their first game and whether to play again when the game ends. We’ll speed up the game each time the player shoots down the entire fleet, and we’ll add a scoring system. The final result will be a fully playable game!</p>
</section>
</div>
<div id="sbo-rt-content"><section>
<header>
<h1 class="chapter">
<span class="ChapterNumber"><span epub:type="pagebreak" title="277" id="Page_277"/>14</span><br/>
<span class="ChapterTitle">Scoring</span></h1>
</header>
<figure class="opener">
<img src="Images/chapterart.png" alt="" width="406" height="406"/>
</figure>
<p class="ChapterIntro">In this chapter, we’ll finish building <em>Alien Invasion</em>. We’ll add a Play button to start the game on demand and to restart the game once it ends. We’ll also change the game so it speeds up when the player moves up a level, and we’ll implement a scoring system. By the end of the chapter, you’ll know enough to start writing games that increase in difficulty as a player progresses and that feature complete scoring systems.</p>
<h2 id="h1-502703c14-0001"><span epub:type="pagebreak" title="278" id="Page_278"/>Adding the Play Button</h2>
<p class="BodyFirst">In this section, we’ll add a Play button that appears before a game begins and reappears when the game ends so the player can play again.</p>
<p>Right now, the game begins as soon as you run <em>alien_invasion.py</em>. Let’s start the game in an inactive state and then prompt the player to click a Play button to begin. To do this, modify the <code>__init__()</code> method of <code>AlienInvasion</code>:</p>
<p class="CodeLabel"><b>alien_invasion.py</b></p>
<pre><code><span class="LiteralGray">    def __init__(self):</span>
<span class="LiteralGray">        """Initialize the game, and create game resources."""</span>
<span class="LiteralGray">        pygame.init()</span>
<em class="LiteralGrayItalic">        --snip--</em>

        # Start Alien Invasion in an inactive state.
        self.game_active = False</code></pre>
<p>Now the game should start in an inactive state, with no way for the player to start it until we make a Play button.</p>
<h3 id="h2-502703c14-0001">Creating a Button Class</h3>
<p class="BodyFirst">Because Pygame doesn’t have a built-in method for making buttons, we’ll write a <code>Button</code> class to create a filled rectangle with a label. You can use this code to make any button in a game. Here’s the first part of the <code>Button</code> class; save it as <em>button.py</em>:</p>
<p class="CodeLabel"><b>button.py</b></p>
<pre><code>import pygame.font

class Button:
    """A class to build buttons for the game."""

<span class="CodeAnnotationHang" aria-label="annotation1">❶</span>     def __init__(self, ai_game, msg):
        """Initialize button attributes."""
        self.screen = ai_game.screen
        self.screen_rect = self.screen.get_rect()

        # Set the dimensions and properties of the button.
<span class="CodeAnnotationHang" aria-label="annotation2">❷</span>         self.width, self.height = 200, 50
        self.button_color = (0, 135, 0)
        self.text_color = (255, 255, 255)
<span class="CodeAnnotationHang" aria-label="annotation3">❸</span>         self.font = pygame.font.SysFont(None, 48)

        # Build the button's rect object and center it.
<span class="CodeAnnotationHang" aria-label="annotation4">❹</span>         self.rect = pygame.Rect(0, 0, self.width, self.height)
        self.rect.center = self.screen_rect.center

        # The button message needs to be prepped only once.
<span class="CodeAnnotationHang" aria-label="annotation5">❺</span>         self._prep_msg(msg)</code></pre>
<p>First, we import the <code>pygame.font</code> module, which lets Pygame render text to the screen. The <code>__init__()</code> method takes the parameters <code>self</code>, the <code>ai_game</code> object, and <code>msg</code>, which contains the button’s text <span class="CodeAnnotation" aria-label="annotation1">❶</span>. We set the button dimensions <span class="CodeAnnotation" aria-label="annotation2">❷</span>, set <code>button_color</code> to color the button’s <code>rect</code> object dark green, and set <code>text_color</code> to render the text in white.</p>
<p><span epub:type="pagebreak" title="279" id="Page_279"/>Next, we prepare a <code>font</code> attribute for rendering text <span class="CodeAnnotation" aria-label="annotation3">❸</span>. The <code>None</code> argument tells Pygame to use the default font, and <code>48</code> specifies the size of the text. To center the button on the screen, we create a <code>rect</code> for the button <span class="CodeAnnotation" aria-label="annotation4">❹</span> and set its <code>center</code> attribute to match that of the screen.</p>
<p>Pygame works with text by rendering the string you want to display as an image. Finally, we call <code>_prep_msg()</code> to handle this rendering <span class="CodeAnnotation" aria-label="annotation5">❺</span>.</p>
<p>Here’s the code for <code>_prep_msg()</code>:</p>
<p class="CodeLabel"><b>button.py</b></p>
<pre><code><code>    </code>def _prep_msg(self, msg):
        """Turn msg into a rendered image and center text on the button."""
<span class="CodeAnnotationHang" aria-label="annotation1">❶</span>         self.msg_image = self.font.render(msg, True, self.text_color,
                self.button_color)
<span class="CodeAnnotationHang" aria-label="annotation2">❷</span>         self.msg_image_rect = self.msg_image.get_rect()
        self.msg_image_rect.center = self.rect.center</code></pre>
<p>The <code>_prep_msg()</code> method needs a <code>self</code> parameter and the text to be rendered as an image (<code>msg</code>). The call to <code>font.render()</code> turns the text stored in <code>msg</code> into an image, which we then store in <code>self.msg_image</code> <span class="CodeAnnotation" aria-label="annotation1">❶</span>. The <code>font.render()</code> method also takes a Boolean value to turn antialiasing on or off (<em>antialiasing</em> makes the edges of the text smoother). The remaining arguments are the specified font color and background color. We set antialiasing to <code>True</code> and set the text background to the same color as the button. (If you don’t include a background color, Pygame will try to render the font with a transparent background.)</p>
<p>We center the text image on the button by creating a <code>rect</code> from the image and setting its <code>center</code> attribute to match that of the button <span class="CodeAnnotation" aria-label="annotation2">❷</span>.</p>
<p>Finally, we create a <code>draw_button()</code> method that we can call to display the button onscreen:</p>
<p class="CodeLabel"><b>button.py</b></p>
<pre><code><code>    </code>def draw_button(self):
        """Draw blank button and then draw message."""
        self.screen.fill(self.button_color, self.rect)
        self.screen.blit(self.msg_image, self.msg_image_rect)</code></pre>
<p>We call <code>screen.fill()</code> to draw the rectangular portion of the button. Then we call <code>screen.blit()</code> to draw the text image to the screen, passing it an image and the <code>rect</code> object associated with the image. This completes the <code>Button</code> class.</p>
<h3 id="h2-502703c14-0002">Drawing the Button to the Screen</h3>
<p class="BodyFirst">We’ll use the <code>Button</code> class to create a Play button in <code>AlienInvasion</code>. First, we’ll update the <code>import</code> statements:</p>
<p class="CodeLabel"><b>alien_invasion.py</b></p>
<pre><code><em class="LiteralGrayItalic">--snip--</em>
<span class="LiteralGray">from game_stats import GameStats</span>
from button import Button</code></pre>
<p><span epub:type="pagebreak" title="280" id="Page_280"/>Because we need only one Play button, we’ll create the button in the <code>__init__()</code> method of <code>AlienInvasion</code>. We can place this code at the very end of <code>__init__()</code>:</p>
<p class="CodeLabel"><b>alien_invasion.py</b></p>
<pre><code><span class="LiteralGray">    def __init__(self):</span>
<span class="LiteralGray">        </span><em class="LiteralGrayItalic">--snip--</em>
<span class="LiteralGray">        self.game_active = False</span>

        # Make the Play button.
        self.play_button = Button(self, "Play")</code></pre>
<p>This code creates an instance of <code>Button</code> with the label <code>Play</code>, but it doesn’t draw the button to the screen. To do this, we’ll call the button’s <code>draw_button()</code> method in <code>_update_screen()</code>:</p>
<p class="CodeLabel"><b>alien_invasion.py</b></p>
<pre><code><span class="LiteralGray">    def _update_screen(self):</span>
<span class="LiteralGray">        </span><em class="LiteralGrayItalic">--snip--</em>
<span class="LiteralGray">        self.aliens.draw(self.screen)</span>

        # Draw the play button if the game is inactive.
        if not self.game_active:
            self.play_button.draw_button()

<span class="LiteralGray">        pygame.display.flip()</span></code></pre>
<p>To make the Play button visible above all other elements on the screen, we draw it after all the other elements have been drawn but before flipping to a new screen. We include it in an <code>if</code> block, so the button only appears when the game is inactive.</p>
<p>Now when you run <em>Alien Invasion</em>, you should see a Play button in the center of the screen, as shown in <a href="#figure14-1" id="figureanchor14-1">Figure 14-1</a>.</p>
<figure>
<img src="Images/f14001.png" class="keyline" alt="" width="641" height="442"/>
<figcaption><p><a id="figure14-1">Figure 14-1</a>: A Play button appears when the game is inactive.</p></figcaption>
</figure>
<h3 id="h2-502703c14-0003"><span epub:type="pagebreak" title="281" id="Page_281"/>Starting the Game</h3>
<p class="BodyFirst">To start a new game when the player clicks Play, add the following <code>elif</code> block to the end of <code>_check_events()</code> to monitor mouse events over the button:</p>
<p class="CodeLabel"><b>alien_invasion.py</b></p>
<pre><code><span class="LiteralGray">    def _check_events(self):</span>
<span class="LiteralGray">        """Respond to keypresses and mouse events."""</span>
<span class="LiteralGray">        for event in pygame.event.get():</span>
<span class="LiteralGray">            if event.type == pygame.QUIT:</span>
<span class="LiteralGray">                </span><em class="LiteralGrayItalic">--snip--</em>
<span class="CodeAnnotationHang" aria-label="annotation1">❶</span>             elif event.type == pygame.MOUSEBUTTONDOWN:
<span class="CodeAnnotationHang" aria-label="annotation2">❷</span>                 mouse_pos = pygame.mouse.get_pos()
<span class="CodeAnnotationHang" aria-label="annotation3">❸</span>                 self._check_play_button(mouse_pos)</code></pre>
<p>Pygame detects a <code>MOUSEBUTTONDOWN</code> event when the player clicks anywhere on the screen <span class="CodeAnnotation" aria-label="annotation1">❶</span>, but we want to restrict our game to respond to mouse clicks only on the Play button. To accomplish this, we use <code>pygame.mouse.get_pos()</code>, which returns a tuple containing the mouse cursor’s <em>x</em>- and <em>y</em>-coordinates when the mouse button is clicked <span class="CodeAnnotation" aria-label="annotation2">❷</span>. We send these values to the new method <code>_check_play_button()</code> <span class="CodeAnnotation" aria-label="annotation3">❸</span>.</p>
<p>Here’s <code>_check_play_button()</code>, which I chose to place after <code>_check_events()</code>:</p>
<p class="CodeLabel"><b>alien_invasion.py</b></p>
<pre><code>    def _check_play_button(self, mouse_pos):
        """Start a new game when the player clicks Play."""
<span class="CodeAnnotationHang" aria-label="annotation1">❶</span>         if self.play_button.rect.collidepoint(mouse_pos):
            self.game_active = True</code></pre>
<p>We use the <code>rect</code> method <code>collidepoint()</code> to check whether the point of the mouse click overlaps the region defined by the Play button’s <code>rect</code> <span class="CodeAnnotation" aria-label="annotation1">❶</span>. If so, we set <code>game_active</code> to <code>True</code>, and the game begins!</p>
<p>At this point, you should be able to start and play a full game. When the game ends, the value of <code>game_active</code> should become <code>False</code> and the Play button should reappear.</p>
<h3 id="h2-502703c14-0004">Resetting the Game</h3>
<p class="BodyFirst">The Play button code we just wrote works the first time the player clicks Play. But it doesn’t work after the first game ends, because the conditions that caused the game to end haven’t been reset.</p>
<p>To reset the game each time the player clicks Play, we need to reset the game statistics, clear out the old aliens and bullets, build a new fleet, and center the ship, as shown here:</p>
<p class="CodeLabel"><b>alien_invasion.py</b></p>
<pre><code><span class="LiteralGray">    def _check_play_button(self, mouse_pos):</span>
<span class="LiteralGray">        """Start a new game when the player clicks Play."""</span>
<span class="LiteralGray">        if self.play_button.rect.collidepoint(mouse_pos):</span>
            # Reset the game statistics.
<span class="CodeAnnotationHang" aria-label="annotation1">❶</span>             self.stats.reset_stats()
<span class="LiteralGray">            self.game_active = True</span>

<span epub:type="pagebreak" title="282" id="Page_282"/>            # Get rid of any remaining bullets and aliens.
<span class="CodeAnnotationHang" aria-label="annotation2">❷</span>             self.bullets.empty()
            self.aliens.empty()

            # Create a new fleet and center the ship.
<span class="CodeAnnotationHang" aria-label="annotation3">❸</span>             self._create_fleet()
            self.ship.center_ship()</code></pre>
<p>We reset the game statistics <span class="CodeAnnotation" aria-label="annotation1">❶</span>, which gives the player three new ships. Then we set <code>game_active</code> to <code>True</code> so the game will begin as soon as the code in this function finishes running. We empty the <code>aliens</code> and <code>bullets</code> groups <span class="CodeAnnotation" aria-label="annotation2">❷</span>, and then we create a new fleet and center the ship <span class="CodeAnnotation" aria-label="annotation3">❸</span>.</p>
<p>Now the game will reset properly each time you click Play, allowing you to play it as many times as you want!</p>
<h3 id="h2-502703c14-0005">Deactivating the Play Button</h3>
<p class="BodyFirst">One issue with our Play button is that the button region on the screen will continue to respond to clicks even when the Play button isn’t visible. If you click the Play button area by accident after a game begins, the game will restart!</p>
<p>To fix this, set the game to start only when <code>game_active</code> is <code>False</code>:</p>
<p class="CodeLabel"><b>alien_invasion.py</b></p>
<pre><code><span class="LiteralGray">    def _check_play_button(self, mouse_pos):</span>
<span class="LiteralGray">        """Start a new game when the player clicks Play."""</span>
<span class="CodeAnnotationHang" aria-label="annotation1">❶</span>         button_clicked = self.play_button.rect.collidepoint(mouse_pos)
<span class="CodeAnnotationHang" aria-label="annotation2">❷</span>         if button_clicked and not self.game_active:
<span class="LiteralGray">            # Reset the game statistics.</span>
<span class="LiteralGray">            self.stats.reset_stats()</span>
<span class="LiteralGray">            </span><em class="LiteralGrayItalic">--snip--</em></code></pre>
<p>The flag <code>button_clicked</code> stores a <code>True</code> or <code>False</code> value <span class="CodeAnnotation" aria-label="annotation1">❶</span>, and the game will restart only if Play is clicked <em>and</em> the game is not currently active <span class="CodeAnnotation" aria-label="annotation2">❷</span>. To test this behavior, start a new game and repeatedly click where the Play button should be. If everything works as expected, clicking the Play button area should have no effect on the gameplay.</p>
<h3 id="h2-502703c14-0006">Hiding the Mouse Cursor</h3>
<p class="BodyFirst">We want the mouse cursor to be visible when the game is inactive, but once play begins, it just gets in the way. To fix this, we’ll make it invisible when the game becomes active. We can do this at the end of the <code>if</code> block in <code>_check_play_button()</code>:</p>
<p class="CodeLabel"><b>alien_invasion.py</b></p>
<pre><code><span class="LiteralGray">    def _check_play_button(self, mouse_pos):</span>
<span class="LiteralGray">        """Start a new game when the player clicks Play."""</span>
<span class="LiteralGray">        button_clicked = self.play_button.rect.collidepoint(mouse_pos)</span>
<span class="LiteralGray">        if button_clicked and not self.game_active:</span>
<span class="LiteralGray">            </span><em class="LiteralGrayItalic">--snip--</em>
            # Hide the mouse cursor.
            pygame.mouse.set_visible(False)</code></pre>
<p><span epub:type="pagebreak" title="283" id="Page_283"/>Passing <code>False</code> to <code>set_visible()</code> tells Pygame to hide the cursor when the mouse is over the game window.</p>
<p>We’ll make the cursor reappear once the game ends so the player can click Play again to begin a new game. Here’s the code to do that:</p>
<p class="CodeLabel"><b>alien_invasion.py</b></p>
<pre><code><span class="LiteralGray">    def _ship_hit(self):</span>
<span class="LiteralGray">        """Respond to ship being hit by alien."""</span>
<span class="LiteralGray">        if self.stats.ships_left &gt; 0:</span>
<span class="LiteralGray">            </span><em class="LiteralGrayItalic">--snip--</em>
<span class="LiteralGray">        else:</span>
<span class="LiteralGray">            self.game_active = False</span>
<span class="LiteralGray">            </span>pygame.mouse.set_visible(True)</code></pre>
<p>We make the cursor visible again as soon as the game becomes inactive, which happens in <code>_ship_hit()</code>. Attention to details like this makes your game more professional looking and allows the player to focus on playing, rather than figuring out the user interface.</p>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="box">
<h2>Try It Yourself</h2>
<p class="BoxBodyCustom"><span id="h2-502703c14-07" class="BoxNumber">14-1.	Press P to Play:</span> Because <em>Alien Invasion</em> uses keyboard input to control the ship, it would be useful to start the game with a keypress. Add code that lets the player press P to start. It might help to move some code from <code>_check_play_button()</code> to a <code>_start_game()</code> method that can be called from <code>_check_play_button()</code> <em>and</em> <code>_check_keydown_events()</code>.</p>
<p class="BoxBodyCustom"><span id="h2-502703c14-08" class="BoxNumber">14-2.	Target Practice:</span> Create a rectangle at the right edge of the screen that moves up and down at a steady rate. Then on the left side of the screen, create a ship that the player can move up and down while firing bullets at the rectangular target. Add a Play button that starts the game, and when the player misses the target three times, end the game and make the Play button reappear. Let the player restart the game with this Play button.</p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<h2 id="h1-502703c14-0002">Leveling Up</h2>
<p class="BodyFirst">In our current game, once a player shoots down the entire alien fleet, the player reaches a new level, but the game difficulty doesn’t change. Let’s liven things up a bit and make the game more challenging by increasing the game’s speed each time a player clears the screen.</p>
<h3 id="h2-502703c14-0007">Modifying the Speed Settings</h3>
<p class="BodyFirst">We’ll first reorganize the <code>Settings</code> class to group the game settings into static and dynamic ones. We’ll also make sure any settings that change <span epub:type="pagebreak" title="284" id="Page_284"/>during the game reset when we start a new game. Here’s the <code>__init__()</code> method for <em>settings.py</em>:</p>
<p class="CodeLabel"><b>settings.py</b></p>
<pre><code><code>    </code><span class="LiteralGray">def __init__(self):</span>
    <code>    </code>"""Initialize the game's static settings."""
<code>    </code><span class="LiteralGray">    # Screen settings</span>
<span class="LiteralGray">        self.screen_width = 1200</span>
<span class="LiteralGray">        self.screen_height = 800</span>
<span class="LiteralGray">        self.bg_color = (230, 230, 230)</span>

<span class="LiteralGray">        # Ship settings</span>
<span class="LiteralGray">        self.ship_limit = 3</span>

<span class="LiteralGray">        # Bullet settings</span>
<span class="LiteralGray">        self.bullet_width = 3</span>
<span class="LiteralGray">        self.bullet_height = 15</span>
<span class="LiteralGray">        self.bullet_color = 60, 60, 60</span>
<span class="LiteralGray">        self.bullets_allowed = 3</span>

<span class="LiteralGray">        # Alien settings</span>
<span class="LiteralGray">        self.fleet_drop_speed = 10</span>

    <code>    </code># How quickly the game speeds up
<span class="CodeAnnotationHang" aria-label="annotation1">❶</span>     <code>    </code>self.speedup_scale = 1.1

<span class="CodeAnnotationHang" aria-label="annotation2">❷</span>     <code>    </code>self.initialize_dynamic_settings()</code></pre>
<p>We continue to initialize settings that stay constant in the <code>__init__()</code> method. We add a <code>speedup_scale</code> setting <span class="CodeAnnotation" aria-label="annotation1">❶</span> to control how quickly the game speeds up: a value of 2 will double the game speed every time the player reaches a new level; a value of 1 will keep the speed constant. A value like <code>1.1</code> should increase the speed enough to make the game challenging but not impossible. Finally, we call the <code>initialize_dynamic_settings()</code> method to initialize the values for attributes that need to change throughout the game <span class="CodeAnnotation" aria-label="annotation2">❷</span>.</p>
<p>Here’s the code for <code>initialize_dynamic_settings()</code>:</p>
<p class="CodeLabel"><b>settings.py</b></p>
<pre><code><span class="LiteralGray">    </span>def initialize_dynamic_settings(self):
    <span class="LiteralGray">    </span>"""Initialize settings that change throughout the game."""
<span class="LiteralGray">    </span>    self.ship_speed = 1.5
    <span class="LiteralGray">    </span>self.bullet_speed = 2.5
    <span class="LiteralGray">    </span>self.alien_speed = 1.0

<span class="LiteralGray">    </span>    # fleet_direction of 1 represents right; -1 represents left.
    <span class="LiteralGray">    </span>self.fleet_direction = 1</code></pre>
<p>This method sets the initial values for the ship, bullet, and alien speeds. We’ll increase these speeds as the player progresses in the game and reset them each time the player starts a new game. We include <code>fleet_direction</code> in this method so the aliens always move right at the beginning of a new game. We don’t need to increase the value of <code>fleet_drop_speed</code>, <span epub:type="pagebreak" title="285" id="Page_285"/>because when the aliens move faster across the screen, they’ll also come down the screen faster.</p>
<p>To increase the speeds of the ship, bullets, and aliens each time the player reaches a new level, we’ll write a new method called <code>increase_speed()</code>:</p>
<p class="CodeLabel"><b>settings.py</b></p>
<pre><code><span class="LiteralGray">    </span>def increase_speed(self):
    <span class="LiteralGray">    </span>"""Increase speed settings."""
<span class="LiteralGray">    </span>    self.ship_speed *= self.speedup_scale
    <span class="LiteralGray">    </span>self.bullet_speed *= self.speedup_scale
<span class="LiteralGray">    </span>    self.alien_speed *= self.speedup_scale</code></pre>
<p>To increase the speed of these game elements, we multiply each speed setting by the value of <code>speedup_scale</code>.</p>
<p>We increase the game’s tempo by calling <code>increase_speed()</code> in <code>_check_bullet_alien_collisions()</code> when the last alien in a fleet has been shot down:</p>
<p class="CodeLabel"><b>alien_invasion.py</b></p>
<pre><code><span class="LiteralGray">    def _check_bullet_alien_collisions(self):</span>
<span class="LiteralGray">        </span><em class="LiteralGrayItalic">--snip--</em>
<span class="LiteralGray">        if not self.aliens:</span>
<span class="LiteralGray">            # Destroy existing bullets and create new fleet.</span>
<span class="LiteralGray">            self.bullets.empty()</span>
<span class="LiteralGray">            self._create_fleet()</span>
<span class="LiteralGray">            </span>self.settings.increase_speed()</code></pre>
<p>Changing the values of the speed settings <code>ship_speed</code>, <code>alien_speed</code>, and <code>bullet_speed</code> is enough to speed up the entire game!</p>
<h3 id="h2-502703c14-0008">Resetting the Speed</h3>
<p class="BodyFirst">Now we need to return any changed settings to their initial values each time the player starts a new game; otherwise, each new game would start with the increased speed settings of the previous game:</p>
<p class="CodeLabel"><b>alien_invasion.py</b></p>
<pre><code><span class="LiteralGray">    def _check_play_button(self, mouse_pos):</span>
<span class="LiteralGray">        """Start a new game when the player clicks Play."""</span>
<span class="LiteralGray">        button_clicked = self.play_button.rect.collidepoint(mouse_pos)</span>
<span class="LiteralGray">        if button_clicked and not self.game_active:</span>
<span class="LiteralGray">            </span># Reset the game settings.
            self.settings.initialize_dynamic_settings()
<span class="LiteralGray">            </span><em class="LiteralGrayItalic">--snip--</em></code></pre>
<p>Playing <em>Alien Invasion</em> should be more fun and challenging now. Each time you clear the screen, the game should speed up and become slightly more difficult. If the game becomes too difficult too quickly, decrease the value of <code>settings.speedup_scale</code>. Or if the game isn’t challenging enough, increase the value slightly. Find a sweet spot by ramping up the difficulty in a reasonable amount of time. The first couple of screens should be easy, the next few should be challenging but doable, and subsequent screens should be almost impossibly difficult.</p>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="box">
<h2><span epub:type="pagebreak" title="286" id="Page_286"/>Try It Yourself</h2>
<p class="BoxBodyCustom"><span id="h2-502703c14-11" class="BoxNumber">14-3.	Challenging Target Practice:</span> Start with your work from Exercise 14-2 (<span class="xref" itemid="xref_target_page 283">page 283</span>). Make the target move faster as the game progresses, and restart the target at the original speed when the player clicks Play.</p>
<p class="BoxBodyCustom"><span id="h2-502703c14-12" class="BoxNumber">14-4.	Difficulty Levels:</span> Make a set of buttons for <em>Alien Invasion</em> that allows the player to select an appropriate starting difficulty level for the game. Each button should assign the appropriate values for the attributes in <code>Settings</code> needed to create different difficulty levels.</p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<h2 id="h1-502703c14-0003">Scoring</h2>
<p class="BodyFirst">Let’s implement a scoring system to track the game’s score in real time and display the high score, level, and number of ships remaining.</p>
<p>The score is a game statistic, so we’ll add a <code>score</code> attribute to <code>GameStats</code>:</p>
<p class="CodeLabel"><b>game_stats.py</b></p>
<pre><code><span class="LiteralGray">class GameStats:</span>
<span class="LiteralGray">    </span><em class="LiteralGrayItalic">--snip--</em>
<span class="LiteralGray">    def reset_stats(self):</span>
<span class="LiteralGray">        """Initialize statistics that can change during the game."""</span>
<span class="LiteralGray">        self.ships_left = self.ai_settings.ship_limit</span>
        self.score = 0</code></pre>
<p>To reset the score each time a new game starts, we initialize <code>score</code> in <code>reset_stats()</code> rather than <code>__init__()</code>.</p>
<h3 id="h2-502703c14-0009">Displaying the Score</h3>
<p class="BodyFirst">To display the score on the screen, we first create a new class, <code>Scoreboard</code>. For now, this class will just display the current score. Eventually, we’ll use it to report the high score, level, and number of ships remaining as well. Here’s the first part of the class; save it as <em>scoreboard.py</em>:</p>
<p class="CodeLabel"><b>scoreboard.py</b></p>
<pre><code>import pygame.font

class Scoreboard:
    """A class to report scoring information."""

<span class="CodeAnnotationHang" aria-label="annotation1">❶</span>     def __init__(self, ai_game):
        """Initialize scorekeeping attributes."""
        self.screen = ai_game.screen
        self.screen_rect = self.screen.get_rect()
        self.settings = ai_game.settings
        self.stats = ai_game.stats

        # Font settings for scoring information.
<span class="CodeAnnotationHang" aria-label="annotation2">❷</span>         self.text_color = (30, 30, 30)
<span class="CodeAnnotationHang" aria-label="annotation3">❸</span>         self.font = pygame.font.SysFont(None, 48)

<span epub:type="pagebreak" title="287" id="Page_287"/>        # Prepare the initial score image.
<span class="CodeAnnotationHang" aria-label="annotation4">❹</span>         self.prep_score()</code></pre>
<p>Because <code>Scoreboard</code> writes text to the screen, we begin by importing the <code>pygame.font</code> module. Next, we give <code>__init__()</code> the <code>ai_game</code> parameter so it can access the <code>settings</code>, <code>screen</code>, and <code>stats</code> objects, which it will need to report the values we’re tracking <span class="CodeAnnotation" aria-label="annotation1">❶</span>. Then we set a text color <span class="CodeAnnotation" aria-label="annotation2">❷</span> and instantiate a font object <span class="CodeAnnotation" aria-label="annotation3">❸</span>.</p>
<p>To turn the text to be displayed into an image, we call <code>prep_score()</code> <span class="CodeAnnotation" aria-label="annotation4">❹</span>, which we define here:</p>
<p class="CodeLabel"><b>scoreboard.py</b></p>
<pre><code><code>    </code>def prep_score(self):
    <code>    </code>"""Turn the score into a rendered image."""
<span class="CodeAnnotationHang" aria-label="annotation1">❶</span>     <code>    </code>score_str = str(self.stats.score)
<span class="CodeAnnotationHang" aria-label="annotation2">❷</span>         self.score_image = self.font.render(score_str, True,
                self.text_color, self.settings.bg_color)

   <code>    </code> # Display the score at the top right of the screen.
<span class="CodeAnnotationHang" aria-label="annotation3">❸</span>     <code>    </code>self.score_rect = self.score_image.get_rect()
<span class="CodeAnnotationHang" aria-label="annotation4">❹</span>     <code>    </code>self.score_rect.right = self.screen_rect.right - 20
<span class="CodeAnnotationHang" aria-label="annotation5">❺</span>     <code>    </code>self.score_rect.top = 20</code></pre>
<p>In <code>prep_score()</code>, we turn the numerical value <code>stats.score</code> into a string <span class="CodeAnnotation" aria-label="annotation1">❶</span> and then pass this string to <code>render()</code>, which creates the image <span class="CodeAnnotation" aria-label="annotation2">❷</span>. To display the score clearly onscreen, we pass the screen’s background color and the text color to <code>render()</code>.</p>
<p>We’ll position the score in the upper-right corner of the screen and have it expand to the left as the score increases and the width of the number grows. To make sure the score always lines up with the right side of the screen, we create a <code>rect</code> called <code>score_rect</code> <span class="CodeAnnotation" aria-label="annotation3">❸</span> and set its right edge 20 pixels from the right edge of the screen <span class="CodeAnnotation" aria-label="annotation4">❹</span>. We then place the top edge 20 pixels down from the top of the screen <span class="CodeAnnotation" aria-label="annotation5">❺</span>.</p>
<p>Then we create a <code>show_score()</code> method to display the rendered score image:</p>
<p class="CodeLabel"><b>scoreboard.py</b></p>
<pre><code><code>    </code>def show_score(self):
        """Draw score to the screen."""
        self.screen.blit(self.score_image, self.score_rect)</code></pre>
<p>This method draws the score image onscreen at the location <code>score_rect</code> specifies.</p>
<h3 id="h2-502703c14-0010">Making a Scoreboard</h3>
<p class="BodyFirst">To display the score, we’ll create a <code>Scoreboard</code> instance in <code>AlienInvasion</code>. First, let’s update the <code>import</code> statements:</p>
<p class="CodeLabel"><b>alien_invasion.py</b></p>
<pre><code><em class="LiteralGrayItalic">--snip--</em>
<span class="LiteralGray">from game_stats import GameStats</span>
from scoreboard import Scoreboard
<em class="LiteralGrayItalic">--snip--</em></code></pre>
<p><span epub:type="pagebreak" title="288" id="Page_288"/>Next, we make an instance of <code>Scoreboard</code> in <code>__init__()</code>:</p>
<p class="CodeLabel"><b>alien_invasion.py</b></p>
<pre><code><span class="LiteralGray">    def __init__(self):</span>
<span class="LiteralGray">        </span><em class="LiteralGrayItalic">--snip--</em>
<span class="LiteralGray">        pygame.display.set_caption("Alien Invasion")</span>

        # Create an instance to store game statistics,
        #   and create a scoreboard.
      <span class="LiteralGray">  self.stats = GameStats(self)</span>
        self.sb = Scoreboard(self)
<span class="LiteralGray">        </span><em class="LiteralGrayItalic">--snip--</em></code></pre>
<p>Then we draw the scoreboard onscreen in <code>_update_screen()</code>:</p>
<p class="CodeLabel"><b>alien_invasion.py</b></p>
<pre><code><span class="LiteralGray">    def _update_screen(self):</span>
<span class="LiteralGray">        </span><em class="LiteralGrayItalic">--snip--</em>
<span class="LiteralGray">        self.aliens.draw(self.screen)</span>

        # Draw the score information.
        self.sb.show_score()

<span class="LiteralGray">        # Draw the play button if the game is inactive.</span>
<span class="LiteralGray">        </span><em class="LiteralGrayItalic">--snip--</em></code></pre>
<p>We call <code>show_score()</code> just before we draw the Play button.</p>
<p>When you run <em>Alien Invasion</em> now, a 0 should appear at the top right of the screen. (At this point, we just want to make sure the score appears in the right place before developing the scoring system further.) <a href="#figure14-2" id="figureanchor14-2">Figure 14-2</a> shows the score as it appears before the game starts.</p>
<p>Next, we’ll assign point values to each alien!</p>
<figure>
<img src="Images/f14002.png" class="keyline" alt="" width="641" height="442"/>
<figcaption><p><a id="figure14-2">Figure 14-2</a>: The score appears at the top-right corner of the screen.</p></figcaption>
</figure>
<h3 id="h2-502703c14-0011"><span epub:type="pagebreak" title="289" id="Page_289"/>Updating the Score as Aliens Are Shot Down</h3>
<p class="BodyFirst">To write a live score onscreen, we update the value of <code>stats.score</code> whenever an alien is hit, and then call <code>prep_score()</code> to update the score image. But first, let’s determine how many points a player gets each time they shoot down an alien:</p>
<p class="CodeLabel"><b>settings.py</b></p>
<pre><code><span class="LiteralGray">    def initialize_dynamic_settings(self):</span>
<span class="LiteralGray">        </span><em class="LiteralGrayItalic">--snip--</em>

   <span class="LiteralGray">    </span> # Scoring settings
<span class="LiteralGray">    </span>    self.alien_points = 50</code></pre>
<p>We’ll increase each alien’s point value as the game progresses. To make sure this point value is reset each time a new game starts, we set the value in <code>initialize_dynamic_settings()</code>.</p>
<p>Let’s update the score in <code>_check_bullet_alien_collisions()</code> each time an alien is shot down:</p>
<p class="CodeLabel"><b>alien_invasion.py</b></p>
<pre><code><span class="LiteralGray">    def _check_bullet_alien_collisions(self):</span>
<span class="LiteralGray">        """Respond to bullet-alien collisions."""</span>
<span class="LiteralGray">        # Remove any bullets and aliens that have collided.</span>
<span class="LiteralGray">        collisions = pygame.sprite.groupcollide(</span>
<span class="LiteralGray">                self.bullets, self.aliens, True, True)</span>

        if collisions:
            self.stats.score += self.settings.alien_points
            self.sb.prep_score()
<span class="LiteralGray">        </span><em class="LiteralGrayItalic">--snip--</em></code></pre>
<p>When a bullet hits an alien, Pygame returns a <code>collisions</code> dictionary. We check whether the dictionary exists, and if it does, the alien’s value is added to the score. We then call <code>prep_score()</code> to create a new image for the updated score.</p>
<p>Now when you play <em>Alien Invasion</em>, you should be able to rack up points!</p>
<h3 id="h2-502703c14-0012">Resetting the Score</h3>
<p class="BodyFirst">Right now, we’re only prepping a new score <em>after</em> an alien has been hit, which works for most of the game. But when we start a new game, we’ll still see our score from the old game until the first alien is hit.</p>
<p>We can fix this by prepping the score when starting a new game:</p>
<p class="CodeLabel"><b>alien_invasion.py</b></p>
<pre><code><span class="LiteralGray">    def _check_play_button(self, mouse_pos):</span>
<span class="LiteralGray">        </span><em class="LiteralGrayItalic">--snip--</em>
<span class="LiteralGray">        if button_clicked and not self.game_active:</span>
<span class="LiteralGray">            </span><em class="LiteralGrayItalic">--snip--</em>
<span class="LiteralGray">            # Reset the game statistics.</span>
<span class="LiteralGray">            self.stats.reset_stats()</span>
            self.sb.prep_score()
<span class="LiteralGray">            </span><em class="LiteralGrayItalic">--snip--</em></code></pre>
<p><span epub:type="pagebreak" title="290" id="Page_290"/>We call <code>prep_score()</code> after resetting the game stats when starting a new game. This preps the scoreboard with a score of 0.</p>
<h3 id="h2-502703c14-0013">Making Sure to Score All Hits</h3>
<p class="BodyFirst">As currently written, our code could miss scoring for some aliens. For example, if two bullets collide with aliens during the same pass through the loop or if we make an extra-wide bullet to hit multiple aliens, the player will only receive points for hitting one of the aliens. To fix this, let’s refine the way that bullet-alien collisions are detected.</p>
<p>In <code>_check_bullet_alien_collisions()</code>, any bullet that collides with an alien becomes a key in the <code>collisions</code> dictionary. The value associated with each bullet is a list of aliens it has collided with. We loop through the values in the <code>collisions</code> dictionary to make sure we award points for each alien hit:</p>
<p class="CodeLabel"><b>alien_invasion.py</b></p>
<pre><code><span class="LiteralGray">    def _check_bullet_alien_collisions(self):</span>
<span class="LiteralGray">        </span><em class="LiteralGrayItalic">--snip--</em>
<span class="LiteralGray">        if collisions:</span>
            for aliens in collisions.values():
                self.stats.score += self.settings.alien_points * len(aliens)
<span class="LiteralGray">            self.sb.prep_score()</span>
<span class="LiteralGray">    </span><em class="LiteralGrayItalic">--snip--</em></code></pre>
<p>If the <code>collisions</code> dictionary has been defined, we loop through all values in the dictionary. Remember that each value is a list of aliens hit by a single bullet. We multiply the value of each alien by the number of aliens in each list and add this amount to the current score. To test this, change the width of a bullet to 300 pixels and verify that you receive points for each alien you hit with your extra-wide bullets; then return the bullet width to its normal value.</p>
<h3 id="h2-502703c14-0014">Increasing Point Values</h3>
<p class="BodyFirst">Because the game gets more difficult each time a player reaches a new level, aliens in later levels should be worth more points. To implement this functionality, we’ll add code to increase the point value when the game’s speed increases:</p>
<p class="CodeLabel"><b>settings.py</b></p>
<pre><code><span class="LiteralGray">class Settings:</span>
<span class="LiteralGray">    """A class to store all settings for Alien Invasion."""</span>

<span class="LiteralGray">    def __init__(self):</span>
<span class="LiteralGray">        </span><em class="LiteralGrayItalic">--snip--</em>
        <span class="LiteralGray"># How quickly the game speeds up</span>
<span class="LiteralGray">        self.speedup_scale = 1.1</span>
<span class="LiteralGray">        </span># How quickly the alien point values increase
<span class="CodeAnnotationHang" aria-label="annotation1">❶</span>         self.score_scale = 1.5

<span class="LiteralGray">        self.initialize_dynamic_settings()</span>

<span class="LiteralGray">    def initialize_dynamic_settings(self):</span>
<span class="LiteralGray">        </span><em class="LiteralGrayItalic">--snip--</em>

<span epub:type="pagebreak" title="291" id="Page_291"/><span class="LiteralGray">    def increase_speed(self):</span>
        """Increase speed settings and alien point values."""
<span class="LiteralGray">        self.ship_speed *= self.speedup_scale</span>
<span class="LiteralGray">        self.bullet_speed *= self.speedup_scale</span>
<span class="LiteralGray">        self.alien_speed *= self.speedup_scale</span>

<span class="CodeAnnotationHang" aria-label="annotation2">❷</span>         self.alien_points = int(self.alien_points * self.score_scale)</code></pre>
<p>We define a rate at which points increase, which we call <code>score_scale</code> <span class="CodeAnnotation" aria-label="annotation1">❶</span>. A small increase in speed (<code>1.1</code>) makes the game more challenging quickly. But to see a more notable difference in scoring, we need to change the alien point value by a larger amount (<code>1.5</code>). Now when we increase the game’s speed, we also increase the point value of each hit <span class="CodeAnnotation" aria-label="annotation2">❷</span>. We use the <code>int()</code> function to increase the point value by whole integers.</p>
<p>To see the value of each alien, add a <code>print()</code> call to the <code>increase_speed()</code> method in <code>Settings</code>:</p>
<p class="CodeLabel"><b>settings.py</b></p>
<pre><code><span class="LiteralGray">    def increase_speed(self):</span>
<span class="LiteralGray">        </span><em class="LiteralGrayItalic">--snip--</em>
<span class="LiteralGray">        self.alien_points = int(self.alien_points * self.score_scale)</span>
<span class="LiteralGray">        </span>print(self.alien_points)</code></pre>
<p>The new point value should appear in the terminal every time you reach a new level.</p>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="note">
<h2><span class="NoteHead">Note</span></h2>
<p>	Be sure to remove the <code>print()</code> call after verifying that the point value is increasing, or it might affect your game’s performance and distract the player.</p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<h3 id="h2-502703c14-0015">Rounding the Score</h3>
<p class="BodyFirst">Most arcade-style shooting games report scores as multiples of 10, so let’s follow that lead with our scores. Also, let’s format the score to include comma separators in large numbers. We’ll make this change in <code>Scoreboard</code>:</p>
<p class="CodeLabel"><b>scoreboard.py</b></p>
<pre><code><span class="LiteralGray">    def prep_score(self):</span>
<span class="LiteralGray">        """Turn the score into a rendered image."""</span>
        rounded_score = round(self.stats.score, -1)
   <span class="LiteralGray">    </span> score_str = f"{rounded_score:,}"
<span class="LiteralGray">        self.score_image = self.font.render(score_str, True,</span>
<span class="LiteralGray">                self.text_color, self.settings.bg_color)</span>
<span class="LiteralGray">        </span><em class="LiteralGrayItalic">--snip--</em></code></pre>
<p>The <code>round()</code> function normally rounds a float to a set number of decimal places given as the second argument. However, when you pass a negative number as the second argument, <code>round()</code> will round the value to the nearest 10, 100, 1,000, and so on. This code tells Python to round the value of <code>stats.score</code> to the nearest 10 and assign it to <code>rounded_score</code>.</p>
<p>We then use a format specifier in the f-string for the score. A <em>format specifier</em> is a special sequence of characters that modifies the way a variable’s value is presented. In this case the sequence <code>:,</code> tells Python to insert <span epub:type="pagebreak" title="292" id="Page_292"/>commas at appropriate places in the numerical value that’s provided. This results in strings like <code>1,000,000</code> instead of <code>1000000</code>.</p>
<p>Now when you run the game, you should see a neatly formatted, rounded score even when you rack up lots of points, as shown in <a href="#figure14-3" id="figureanchor14-3">Figure 14-3</a>.</p>
<figure>
<img src="Images/f14003.png" class="keyline" alt="" width="641" height="442"/>
<figcaption><p><a id="figure14-3">Figure 14-3</a>: A rounded score with comma separators</p></figcaption>
</figure>
<h3 id="h2-502703c14-0016">High Scores</h3>
<p class="BodyFirst">Every player wants to beat a game’s high score, so let’s track and report high scores to give players something to work toward. We’ll store high scores in <code>GameStats</code>:</p>
<p class="CodeLabel"><b>game_stats.py</b></p>
<pre><code><span class="LiteralGray">    def __init__(self, ai_game):</span>
<span class="LiteralGray">        </span><em class="LiteralGrayItalic">--snip--</em>
<span class="LiteralGray">    </span>    # High score should never be reset.
    <span class="LiteralGray">    </span>self.high_score = 0</code></pre>
<p>Because the high score should never be reset, we initialize <code>high_score</code> in <code>__init__()</code> rather than in <code>reset_stats()</code>.</p>
<p>Next, we’ll modify <code>Scoreboard</code> to display the high score. Let’s start with the <code>__init__()</code> method:</p>
<p class="CodeLabel"><b>scoreboard.py</b></p>
<pre><code><span class="LiteralGray">    def __init__(self, ai_game):</span>
<span class="LiteralGray">        </span><em class="LiteralGrayItalic">--snip--</em>
<span class="LiteralGray">    </span>    # Prepare the initial score images.
<span class="LiteralGray">        self.prep_score()</span>
<span class="CodeAnnotationHang" aria-label="annotation1">❶</span>     <span class="LiteralGray">    </span>self.prep_high_score()</code></pre>
<p>The high score will be displayed separately from the score, so we need a new method, <code>prep_high_score()</code>, to prepare the high-score image <span class="CodeAnnotation" aria-label="annotation1">❶</span>.</p>
<p><span epub:type="pagebreak" title="293" id="Page_293"/>Here’s the <code>prep_high_score()</code> method:</p>
<p class="CodeLabel"><b>scoreboard.py</b></p>
<pre><code><span class="LiteralGray">    </span>def prep_high_score(self):
    <span class="LiteralGray">    </span>"""Turn the high score into a rendered image."""
<span class="CodeAnnotationHang" aria-label="annotation1">❶</span>     <span class="LiteralGray">    </span>high_score = round(self.stats.high_score, -1)
    <span class="LiteralGray">    </span>high_score_str = f"{high_score:,}"
<span class="CodeAnnotationHang" aria-label="annotation2">❷</span>     <span class="LiteralGray">    </span>self.high_score_image = self.font.render(high_score_str, True,
        <span class="LiteralGray">        </span>self.text_color, self.settings.bg_color)

<span class="LiteralGray">    </span>    # Center the high score at the top of the screen.
    <span class="LiteralGray">    </span>self.high_score_rect = self.high_score_image.get_rect()
<span class="CodeAnnotationHang" aria-label="annotation3">❸</span> <span class="LiteralGray">    </span>    self.high_score_rect.centerx = self.screen_rect.centerx
<span class="CodeAnnotationHang" aria-label="annotation4">❹</span>     <span class="LiteralGray">    </span>self.high_score_rect.top = self.score_rect.top</code></pre>
<p>We round the high score to the nearest 10 and format it with commas <span class="CodeAnnotation" aria-label="annotation1">❶</span>. We then generate an image from the high score <span class="CodeAnnotation" aria-label="annotation2">❷</span>, center the high score <code>rect</code> horizontally <span class="CodeAnnotation" aria-label="annotation3">❸</span>, and set its <code>top</code> attribute to match the top of the score image <span class="CodeAnnotation" aria-label="annotation4">❹</span>.</p>
<p>The <code>show_score()</code> method now draws the current score at the top right and the high score at the top center of the screen:</p>
<p class="CodeLabel"><b>scoreboard.py</b></p>
<pre><code><span class="LiteralGray">    def show_score(self):</span>
<span class="LiteralGray">        """Draw score to the screen."""</span>
<span class="LiteralGray">        self.screen.blit(self.score_image, self.score_rect)</span>
    <span class="LiteralGray">    </span>self.screen.blit(self.high_score_image, self.high_score_rect)</code></pre>
<p>To check for high scores, we’ll write a new method, <code>check_high_score()</code>, in <code>Scoreboard</code>:</p>
<p class="CodeLabel"><b>scoreboard.py</b></p>
<pre><code>    def check_high_score(self):
<code>        </code>"""Check to see if there's a new high score."""
        if self.stats.score &gt; self.stats.high_score:
            self.stats.high_score = self.stats.score
            self.prep_high_score()</code></pre>
<p>The method <code>check_high_score()</code> checks the current score against the high score. If the current score is greater, we update the value of <code>high_score</code> and call <code>prep_high_score()</code> to update the high score’s image.</p>
<p>We need to call <code>check_high_score()</code> each time an alien is hit after updating the score in <code>_check_bullet_alien_collisions()</code>:</p>
<p class="CodeLabel"><b>alien_invasion.py</b></p>
<pre><code><span class="LiteralGray">    def _check_bullet_alien_collisions(self):</span>
<span class="LiteralGray">        </span><em class="LiteralGrayItalic">--snip--</em>
<span class="LiteralGray">        if collisions:</span>
<span class="LiteralGray">            for aliens in collisions.values():</span>
<span class="LiteralGray">                self.stats.score += self.settings.alien_points * len(aliens)</span>
<span class="LiteralGray">            self.sb.prep_score()</span>
<span class="LiteralGray">        </span>    self.sb.check_high_score()
        <em class="LiteralGrayItalic">--snip--</em></code></pre>
<p>We call <code>check_high_score()</code> when the <code>collisions</code> dictionary is present, and we do so after updating the score for all the aliens that have been hit.</p>
<p><span epub:type="pagebreak" title="294" id="Page_294"/>The first time you play <em>Alien Invasion</em>, your score will be the high score, so it will be displayed as the current score and the high score. But when you start a second game, your high score should appear in the middle and your current score should appear at the right, as shown in <a href="#figure14-4" id="figureanchor14-4">Figure 14-4</a>.</p>
<figure>
<img src="Images/f14004.png" class="keyline" alt="" width="641" height="442"/>
<figcaption><p><a id="figure14-4">Figure 14-4</a>: The high score is shown at the top center of the screen.</p></figcaption>
</figure>
<h3 id="h2-502703c14-0017">Displaying the Level</h3>
<p class="BodyFirst">To display the player’s level in the game, we first need an attribute in <code>GameStats</code> representing the current level. To reset the level at the start of each new game, initialize it in <code>reset_stats()</code>:</p>
<p class="CodeLabel"><b>game_stats.py</b></p>
<pre><code><span class="LiteralGray">    def reset_stats(self):</span>
<span class="LiteralGray">        """Initialize statistics that can change during the game."""</span>
<span class="LiteralGray">        self.ships_left = self.settings.ship_limit</span>
<span class="LiteralGray">        self.score = 0</span>
<span class="LiteralGray">    </span>    self.level = 1</code></pre>
<p>To have <code>Scoreboard</code> display the current level, we call a new method, <code>prep_level()</code>, from <code>__init__()</code>:</p>
<p class="CodeLabel"><b>scoreboard.py</b></p>
<pre><code><span class="LiteralGray">    def __init__(self, ai_game):</span>
<span class="LiteralGray">        </span><em class="LiteralGrayItalic">--snip--</em>
<span class="LiteralGray">        self.prep_high_score()</span>
    <span class="LiteralGray">    </span>self.prep_level()</code></pre>
<p>Here’s <code>prep_level()</code>:</p>
<p class="CodeLabel"><b>scoreboard.py</b></p>
<pre><code><code>    </code>def prep_level(self):
        """Turn the level into a rendered image."""
        level_str = str(self.stats.level)
<span epub:type="pagebreak" title="295" id="Page_295"/><span class="CodeAnnotationHang" aria-label="annotation1">❶</span>         self.level_image = self.font.render(level_str, True,
                self.text_color, self.settings.bg_color)

        # Position the level below the score.
        self.level_rect = self.level_image.get_rect()
<span class="CodeAnnotationHang" aria-label="annotation2">❷</span>         self.level_rect.right = self.score_rect.right
<span class="CodeAnnotationHang" aria-label="annotation3">❸</span>         self.level_rect.top = self.score_rect.bottom + 10</code></pre>
<p>The <code>prep_level()</code> method creates an image from the value stored in <code>stats.level</code> <span class="CodeAnnotation" aria-label="annotation1">❶</span> and sets the image’s <code>right</code> attribute to match the score’s <code>right</code> attribute <span class="CodeAnnotation" aria-label="annotation2">❷</span>. It then sets the <code>top</code> attribute 10 pixels beneath the bottom of the score image to leave space between the score and the level <span class="CodeAnnotation" aria-label="annotation3">❸</span>.</p>
<p>We also need to update <code>show_score()</code>:</p>
<p class="CodeLabel"><b>scoreboard.py</b></p>
<pre><code><span class="LiteralGray">    def show_score(self):</span>
        """Draw scores and level to the screen."""
<span class="LiteralGray">        self.screen.blit(self.score_image, self.score_rect)</span>
<span class="LiteralGray">        self.screen.blit(self.high_score_image, self.high_score_rect)</span>
<span class="LiteralGray">    </span>    self.screen.blit(self.level_image, self.level_rect)</code></pre>
<p>This new line draws the level image to the screen.</p>
<p>We’ll increment <code>stats.level</code> and update the level image in <code>_check_bullet_alien_collisions()</code>:</p>
<p class="CodeLabel"><b>alien_invasion.py</b></p>
<pre><code><span class="LiteralGray">    def _check_bullet_alien_collisions(self):</span>
<span class="LiteralGray">        </span><em class="LiteralGrayItalic">--snip--</em>
<span class="LiteralGray">        if not self.aliens:</span>
<span class="LiteralGray">          </span>  <span class="LiteralGray"># Destroy existing bullets and create new fleet.</span>
<span class="LiteralGray">            self.bullets.empty()</span>
<span class="LiteralGray">            self._create_fleet()</span>
<span class="LiteralGray">            self.settings.increase_speed()</span>

            # Increase level.
            self.stats.level += 1
            self.sb.prep_level()</code></pre>
<p>If a fleet is destroyed, we increment the value of <code>stats.level</code> and call <code>prep_level()</code> to make sure the new level displays correctly.</p>
<p>To ensure the level image updates properly at the start of a new game, we also call <code>prep_level()</code> when the player clicks the Play button:</p>
<p class="CodeLabel"><b>alien_invasion.py</b></p>
<pre><code><span class="LiteralGray">    def _check_play_button(self, mouse_pos):</span>
<span class="LiteralGray">        </span><em class="LiteralGrayItalic">--snip--</em>
<span class="LiteralGray">        if button_clicked and not self.game_active:</span>
<span class="LiteralGray">            </span><em class="LiteralGrayItalic">--snip--</em>
            <span class="LiteralGray">self.sb.prep_score()</span>
            self.sb.prep_level()
            <em class="LiteralGrayItalic">--snip--</em></code></pre>
<p>We call <code>prep_level()</code> right after calling <code>prep_score()</code>.</p>
<p>Now you’ll see how many levels you’ve completed, as shown in <a href="#figure14-5" id="figureanchor14-5">Figure 14-5</a>.</p>
<span epub:type="pagebreak" title="296" id="Page_296"/><figure>
<img src="Images/f14005.png" class="keyline" alt="" width="641" height="442"/>
<figcaption><p><a id="figure14-5">Figure 14-5</a>: The current level appears just below the current score.</p></figcaption>
</figure>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="note">
<h2><span class="NoteHead">Note</span></h2>
<p>	In some classic games, the scores have labels, such as Score, High Score, and Level. We’ve omitted these labels because the meaning of each number becomes clear once you’ve played the game. To include these labels, add them to the score strings just before the calls to <code>font.render()</code> in <code>Scoreboard</code>.</p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<h3 id="h2-502703c14-0018">Displaying the Number of Ships</h3>
<p class="BodyFirst">Finally, let’s display the number of ships the player has left, but this time, let’s use a graphic. To do so, we’ll draw ships in the upper-left corner of the screen to represent how many ships are left, just as many classic arcade games do.</p>
<p>First, we need to make <code>Ship</code> inherit from <code>Sprite</code> so we can create a group of ships:</p>
<p class="CodeLabel"><b>ship.py</b></p>
<pre><code><span class="LiteralGray">import pygame</span>
from pygame.sprite import Sprite

<span class="CodeAnnotationHang" aria-label="annotation1">❶</span> class Ship(Sprite):
<span class="LiteralGray">    """A class to manage the ship."""</span>

<span class="LiteralGray">    def __init__(self, ai_game):</span>
<span class="LiteralGray">        """Initialize the ship and set its starting position."""</span>
<span class="CodeAnnotationHang" aria-label="annotation2">❷</span>         super().__init__()
<span class="LiteralGray">        </span><em class="LiteralGrayItalic">--snip--</em></code></pre>
<p>Here we import <code>Sprite</code>, make sure <code>Ship</code> inherits from <code>Sprite</code> <span class="CodeAnnotation" aria-label="annotation1">❶</span>, and call <code>super()</code> at the beginning of <code>__init__()</code> <span class="CodeAnnotation" aria-label="annotation2">❷</span>.</p>
<p><span epub:type="pagebreak" title="297" id="Page_297"/>Next, we need to modify <code>Scoreboard</code> to create a group of ships we can display. Here are the <code>import</code> statements for <code>Scoreboard</code>:</p>
<p class="CodeLabel"><b>scoreboard.py</b></p>
<pre><code><span class="LiteralGray">import pygame.font</span>
from pygame.sprite import Group

from ship import Ship</code></pre>
<p>Because we’re making a group of ships, we import the <code>Group</code> and <code>Ship</code> classes.</p>
<p>Here’s <code>__init__()</code>:</p>
<p class="CodeLabel"><b>scoreboard.py</b></p>
<pre><code><span class="LiteralGray">    def __init__(self, ai_game):</span>
<span class="LiteralGray">        """Initialize scorekeeping attributes."""</span>
<span class="LiteralGray">        </span>self.ai_game = ai_game
<span class="LiteralGray">        self.screen = ai_game.screen</span>
<span class="LiteralGray">        </span><em class="LiteralGrayItalic">--snip--</em>
<span class="LiteralGray">        self.prep_level()</span>
        self.prep_ships()</code></pre>
<p>We assign the game instance to an attribute, because we’ll need it to create some ships. We call <code>prep_ships()</code> after the call to <code>prep_level()</code>.</p>
<p>Here’s <code>prep_ships()</code>:</p>
<p class="CodeLabel"><b>scoreboard.py</b></p>
<pre><code><code>    </code>def prep_ships(self):
        """Show how many ships are left."""
<span class="CodeAnnotationHang" aria-label="annotation1">❶</span>         self.ships = Group()
<span class="CodeAnnotationHang" aria-label="annotation2">❷</span>         for ship_number in range(self.stats.ships_left):
            ship = Ship(self.ai_game)
<span class="CodeAnnotationHang" aria-label="annotation3">❸</span>             ship.rect.x = 10 + ship_number * ship.rect.width
<span class="CodeAnnotationHang" aria-label="annotation4">❹</span>             ship.rect.y = 10
<span class="CodeAnnotationHang" aria-label="annotation5">❺</span>             self.ships.add(ship)</code></pre>
<p>The <code>prep_ships()</code> method creates an empty group, <code>self.ships</code>, to hold the ship instances <span class="CodeAnnotation" aria-label="annotation1">❶</span>. To fill this group, a loop runs once for every ship the player has left <span class="CodeAnnotation" aria-label="annotation2">❷</span>. Inside the loop, we create a new ship and set each ship’s <em>x</em>-coordinate value so the ships appear next to each other with a 10-pixel margin on the left side of the group of ships <span class="CodeAnnotation" aria-label="annotation3">❸</span>. We set the <em>y</em>-coordinate value 10 pixels down from the top of the screen so the ships appear in the upper-left corner of the screen <span class="CodeAnnotation" aria-label="annotation4">❹</span>. Then we add each new ship to the group <code>ships</code> <span class="CodeAnnotation" aria-label="annotation5">❺</span>.</p>
<p>Now we need to draw the ships to the screen:</p>
<p class="CodeLabel"><b>scoreboard.py</b></p>
<pre><code><span class="LiteralGray">    def show_score(self):</span>
        """Draw scores, level, and ships to the screen."""
<span class="LiteralGray">        self.screen.blit(self.score_image, self.score_rect)</span>
<span class="LiteralGray">        self.screen.blit(self.high_score_image, self.high_score_rect)</span>
<span class="LiteralGray">        self.screen.blit(self.level_image, self.level_rect)</span>
    <span class="LiteralGray">    </span>self.ships.draw(self.screen)</code></pre>
<p><span epub:type="pagebreak" title="298" id="Page_298"/>To display the ships on the screen, we call <code>draw()</code> on the group, and Pygame draws each ship.</p>
<p>To show the player how many ships they have to start with, we call <code>prep_ships()</code> when a new game starts. We do this in <code>_check_play_button()</code> in <code>AlienInvasion</code>:</p>
<p class="CodeLabel"><b>alien_invasion.py</b></p>
<pre><code><span class="LiteralGray">    def _check_play_button(self, mouse_pos):</span>
<span class="LiteralGray">        </span><em class="LiteralGrayItalic">--snip--</em>
<span class="LiteralGray">        if button_clicked and not self.game_active:</span>
<span class="LiteralGray">            </span><em class="LiteralGrayItalic">--snip--</em>
            <span class="LiteralGray">self.sb.prep_level()</span>
            self.sb.prep_ships()
            <em class="LiteralGrayItalic">--snip--</em></code></pre>
<p>We also call <code>prep_ships()</code> when a ship is hit, to update the display of ship images when the player loses a ship:</p>
<p class="CodeLabel"><b>alien_invasion.py</b></p>
<pre><code><span class="LiteralGray">    def _ship_hit(self):</span>
<span class="LiteralGray">        """Respond to ship being hit by alien."""</span>
<span class="LiteralGray">        if self.stats.ships_left &gt; 0:</span>
            # Decrement ships_left, and update scoreboard.
<span class="LiteralGray">            self.stats.ships_left -= 1</span>
            self.sb.prep_ships()
            <var>--snip--</var></code></pre>
<p>We call <code>prep_ships()</code> after decreasing the value of <code>ships_left</code>, so the correct number of remaining ships displays each time a ship is destroyed.</p>
<p><a href="#figure14-6" id="figureanchor14-6">Figure 14-6</a> shows the complete scoring system, with the remaining ships displayed at the top left of the screen.</p>
<figure>
<img src="Images/f14006.png" class="keyline" alt="" width="641" height="442"/>
<figcaption><p><a id="figure14-6">Figure 14-6</a>: The complete scoring system for <em>Alien Invasion</em></p></figcaption>
</figure>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="box">
<h2><span epub:type="pagebreak" title="299" id="Page_299"/>Try It Yourself</h2>
<p class="BoxBodyCustom"><span id="h2-502703c14-23" class="BoxNumber">14-5.	All-Time High Score:</span> The high score is reset every time a player closes and restarts <em>Alien Invasion</em>. Fix this by writing the high score to a file before calling <code>sys.exit()</code> and reading in the high score when initializing its value in <code>GameStats</code>.</p>
<p class="BoxBodyCustom"><span id="h2-502703c14-24" class="BoxNumber">14-6.	Refactoring:</span> Look for methods that are doing more than one task, and refactor them to organize your code and make it efficient. For example, move some of the code in <code>_check_bullet_alien_collisions()</code>, which starts a new level when the fleet of aliens has been destroyed, to a function called <code>start_new_level()</code>. Also, move the four separate method calls in the <code>__init__()</code> method in <code>Scoreboard</code> to a method called <code>prep_images()</code> to shorten <code>__init__()</code>. The <code>prep_images()</code> method could also help simplify <code>_check_play_button()</code> or <code>start_game()</code> if you’ve already refactored <code>_check_play_button()</code>.</p>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="note">
<h2 style="text-align: left;margin-bottom:0;"><span class="NoteHead">note</span></h2>
<p>Before attempting to refactor the project, see <span class="xref" itemid="xref_target_Appendix D">Appendix D</span> to learn how to restore the project to a working state if you introduce bugs while refactoring.</p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<p class="BoxBodyCustom"><span id="h2-502703c14-25" class="BoxNumber">14-7. Expanding the Game:</span> Think of a way to expand <em>Alien Invasion</em>. For example, you could program the aliens to shoot bullets down at your ship. You can also add shields for your ship to hide behind, which can be destroyed by bullets from either side. Or you can use something like the <code>pygame.mixer</code> module to add sound effects, such as explosions and shooting sounds.</p>
<p class="BoxBodyCustom"><span id="h2-502703c14-26" class="BoxNumber">14-8. Sideways Shooter, Final Version:</span> Continue developing <em>Sideways Shooter</em>, using everything we’ve done in this project. Add a Play button, make the game speed up at appropriate points, and develop a scoring system. Be sure to refactor your code as you work, and look for opportunities to customize the game beyond what has been shown in this chapter.</p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<h2 id="h1-502703c14-0004">Summary</h2>
<p class="BodyFirst">In this chapter, you learned how to implement a Play button to start a new game. You also learned how to detect mouse events and hide the cursor in active games. You can use what you’ve learned to create other buttons, like a Help button to display instructions on how to play your games. You also learned how to modify the speed of a game as it progresses, implement a progressive scoring system, and display information in textual and nontextual ways.</p>
</section>
</div>
<div id="sbo-rt-content"><section>
<header>
<h1 class="chapter">
<span class="ChapterNumber"><span epub:type="pagebreak" title="301" id="Page_301"/>15</span><br/>
<span class="ChapterTitle">Generating Data</span></h1>
</header>
<figure class="opener">
<img src="Images/chapterart.png" alt="" width="406" height="406"/>
</figure>
<p class="ChapterIntro"><em>Data visualization</em> is the use of visual representations to explore and present patterns in datasets. It’s closely associated with <em>data analysis</em>, which uses code to explore the patterns and connections in a dataset. A dataset can be a small list of numbers that fits in a single line of code, or it can be terabytes of data that include many different kinds of information.</p>
<p>Creating effective data visualizations is about more than just making information look nice. When a representation of a dataset is simple and visually appealing, its meaning becomes clear to viewers. People will see patterns and significance in your datasets that they never knew existed.</p>
<p>Fortunately, you don’t need a supercomputer to visualize complex data. Python is so efficient that with just a laptop, you can quickly explore datasets containing millions of individual data points. These data points don’t <span epub:type="pagebreak" title="302" id="Page_302"/>have to be numbers; with the basics you learned in the first part of this book, you can analyze non-numerical data as well.</p>
<p>People use Python for data-intensive work in genetics, climate research, political and economic analysis, and much more. Data scientists have written an impressive array of visualization and analysis tools in Python, many of which are available to you as well. One of the most popular tools is Matplotlib, a mathematical plotting library. In this chapter, we’ll use Matplotlib to make simple plots, such as line graphs and scatter plots. Then we’ll create a more interesting dataset based on the concept of a random walk—a visualization generated from a series of random decisions.</p>
<p>We’ll also use a package called Plotly, which creates visualizations that work well on digital devices, to analyze the results of rolling dice. Plotly generates visualizations that automatically resize to fit a variety of display devices. These visualizations can also include a number of interactive features, such as emphasizing particular aspects of the dataset when users hover over different parts of the visualization. Learning to use Matplotlib and Plotly will help you get started visualizing the kinds of data you’re most interested in.</p>
<h2 id="h1-502703c15-0001">Installing Matplotlib</h2>
<p class="BodyFirst">To use Matplotlib for your initial set of visualizations, you’ll need to install it using pip, just like we did with pytest in <span class="xref" itemid="xref_target_Chapter 11 ">Chapter 11 </span>(see “<span class="xref" itemid="xref_target_Installing pytest with pip">Installing pytest with pip</span>” on page <span class="xref" itemid="xref_target_210">210</span>).</p>
<p>To install Matplotlib, enter the following command at a terminal prompt:</p>
<pre><code>$ <b>python -m pip install --user matplotlib</b></code></pre>
<p>If you use a command other than <code class="bold">python</code> to run programs or start a terminal session, such as <code class="bold">python3</code>, your command will look like this:</p>
<pre><code>$ <b>python3 -m pip install --user matplotlib</b></code></pre>
<p>To see the kinds of visualizations you can make with Matplotlib, visit the Matplotlib home page at <a href="https://matplotlib.org" class="LinkURL">https://matplotlib.org</a> and click <b>Plot types</b>. When you click a visualization in the gallery, you’ll see the code used to generate the plot.</p>
<h2 id="h1-502703c15-0002">Plotting a Simple Line Graph</h2>
<p class="BodyFirst">Let’s plot a simple line graph using Matplotlib and then customize it to create a more informative data visualization. We’ll use the square number sequence 1, 4, 9, 16, and 25 as the data for the graph.</p>
<p>To make a simple line graph, specify the numbers you want to work with and let Matplotlib do the rest:</p>
<p class="CodeLabel"><b>mpl_squares.py</b></p>
<pre><code>import matplotlib.pyplot as plt

squares = [1, 4, 9, 16, 25]

<span epub:type="pagebreak" title="303" id="Page_303"/><span class="CodeAnnotationHang" aria-label="annotation1">❶</span> fig, ax = plt.subplots()
ax.plot(squares)

plt.show()</code></pre>
<p>We first import the <code>pyplot</code> module using the alias <code>plt</code> so we don’t have to type <code>pyplot</code> repeatedly. (You’ll see this convention often in online examples, so we’ll use it here.) The <code>pyplot</code> module contains a number of functions that help generate charts and plots.</p>
<p>We create a list called <code>squares</code> to hold the data that we’ll plot. Then we follow another common Matplotlib convention by calling the <code>subplots()</code> function <span class="CodeAnnotation" aria-label="annotation1">❶</span>. This function can generate one or more plots in the same figure. The variable <code>fig</code> represents the entire <em>figure</em>, which is the collection of plots that are generated. The variable <code>ax</code> represents a single plot in the figure; this is the variable we’ll use most of the time when defining and customizing a single plot.</p>
<p>We then use the <code>plot()</code> method, which tries to plot the data it’s given in a meaningful way. The function <code>plt.show()</code> opens Matplotlib’s viewer and displays the plot, as shown in <a href="#figure15-1" id="figureanchor15-1">Figure 15-1</a>. The viewer allows you to zoom and navigate the plot, and you can save any plot images you like by clicking the disk icon.</p>
<figure>
<img src="Images/f15001.png" class="keyline" alt="" width="694" height="413"/>
<figcaption><p><a id="figure15-1">Figure 15-1</a>: One of the simplest plots you can make in Matplotlib</p></figcaption>
</figure>
<h3 id="h2-502703c15-0001">Changing the Label Type and Line Thickness</h3>
<p class="BodyFirst">Although the plot in <a href="#figure15-1">Figure 15-1</a> shows that the numbers are increasing, the label type is too small and the line is a little thin to read easily. Fortunately, Matplotlib allows you to adjust every feature of a visualization.</p>
<p><span epub:type="pagebreak" title="304" id="Page_304"/>We’ll use a few of the available customizations to improve this plot’s readability. Let’s start by adding a title and labeling the axes:</p>
<p class="CodeLabel"><b>mpl_squares.py</b></p>
<pre><code><span class="LiteralGray">import matplotlib.pyplot as plt</span>

<span class="LiteralGray">squares = [1, 4, 9, 16, 25]</span>

<span class="LiteralGray">fig, ax = plt.subplots()</span>
<span class="CodeAnnotationHang" aria-label="annotation1">❶</span> ax.plot(squares, linewidth=3)

# Set chart title and label axes.
<span class="CodeAnnotationHang" aria-label="annotation2">❷</span> ax.set_title("Square Numbers", fontsize=24)
<span class="CodeAnnotationHang" aria-label="annotation3">❸</span> ax.set_xlabel("Value", fontsize=14)
ax.set_ylabel("Square of Value", fontsize=14)

# Set size of tick labels.
<span class="CodeAnnotationHang" aria-label="annotation4">❹</span> ax.tick_params(labelsize=14)

<span class="LiteralGray">plt.show()</span></code></pre>
<p>The <code>linewidth</code> parameter controls the thickness of the line that <code>plot()</code> generates <span class="CodeAnnotation" aria-label="annotation1">❶</span>. Once a plot has been generated, there are many methods available to modify the plot before it’s presented. The <code>set_title()</code> method sets an overall title for the chart <span class="CodeAnnotation" aria-label="annotation2">❷</span>. The <code>fontsize</code> parameters, which appear repeatedly throughout the code, control the size of the text in various elements on the chart.</p>
<p>The <code>set_xlabel()</code> and <code>set_ylabel()</code> methods allow you to set a title for each of the axes <span class="CodeAnnotation" aria-label="annotation3">❸</span>, and the method <code>tick_params()</code> styles the tick marks <span class="CodeAnnotation" aria-label="annotation4">❹</span>. Here <code>tick_params()</code> sets the font size of the tick mark labels to 14 on both axes.</p>
<p>As you can see in <a href="#figure15-2" id="figureanchor15-2">Figure 15-2</a>, the resulting chart is much easier to read. The label type is bigger, and the line graph is thicker. It’s often worth experimenting with these values to see what works best in the resulting graph.</p>
<figure>
<img src="Images/f15002.png" class="keyline" alt="" width="675" height="402"/>
<figcaption><p><a id="figure15-2">Figure 15-2</a>: The chart is much easier to read now.</p></figcaption>
</figure>
<h3 id="h2-502703c15-0002"><span epub:type="pagebreak" title="305" id="Page_305"/>Correcting the Plot</h3>
<p class="BodyFirst">Now that we can read the chart better, we can see that the data is not plotted correctly. Notice at the end of the graph that the square of 4.0 is shown as 25! Let’s fix that.</p>
<p>When you give <code>plot()</code> a single sequence of numbers, it assumes the first data point corresponds to an <em>x</em>-value of 0, but our first point corresponds to an <em>x</em>-value of 1. We can override the default behavior by giving <code>plot()</code> both the input and output values used to calculate the squares:</p>
<p class="CodeLabel"><b>mpl_squares.py</b></p>
<pre><code><span class="LiteralGray">import matplotlib.pyplot as plt</span>

input_values = [1, 2, 3, 4, 5]
<span class="LiteralGray">squares = [1, 4, 9, 16, 25]</span>

<span class="LiteralGray">fig, ax = plt.subplots()</span>
ax.plot(input_values, squares, linewidth=3)

<span class="LiteralGray"># Set chart title and label axes.</span>
<em class="LiteralGrayItalic">--snip--</em></code></pre>
<p>Now <code>plot()</code> doesn’t have to make any assumptions about how the output numbers were generated. The resulting plot, shown in <a href="#figure15-3" id="figureanchor15-3">Figure 15-3</a>, is correct.</p>
<figure>
<img src="Images/f15003.png" class="keyline" alt="" width="694" height="413"/>
<figcaption><p><a id="figure15-3">Figure 15-3</a>: The data is now plotted correctly.</p></figcaption>
</figure>
<p>You can specify a number of arguments when calling <code>plot()</code> and use a number of methods to customize your plots after generating them. We’ll continue to explore these approaches to customization as we work with more interesting datasets throughout this chapter.</p>
<h3 id="h2-502703c15-0003"><span epub:type="pagebreak" title="306" id="Page_306"/>Using Built-in Styles</h3>
<p class="BodyFirst">Matplotlib has a number of predefined styles available. These styles contain a variety of default settings for background colors, gridlines, line widths, fonts, font sizes, and more. They can make your visualizations appealing without requiring much customization. To see the full list of available styles, run the following lines in a terminal session:</p>
<pre><code>&gt;&gt;&gt; <b>import matplotlib.pyplot as plt</b>
&gt;&gt;&gt; <b>plt.style.available</b>
['Solarize_Light2', '_classic_test_patch', '_mpl-gallery',
<var>--snip--</var></code></pre>
<p>To use any of these styles, add one line of code before calling <code>subplots()</code>:</p>
<p class="CodeLabel"><b>mpl_squares.py</b></p>
<pre><code><span class="LiteralGray">import matplotlib.pyplot as plt</span>

<span class="LiteralGray">input_values = [1, 2, 3, 4, 5]</span>
<span class="LiteralGray">squares = [1, 4, 9, 16, 25]</span>

plt.style.use('seaborn')
<span class="LiteralGray">fig, ax = plt.subplots()</span>
<em class="LiteralGrayItalic">--snip--</em></code></pre>
<p>This code generates the plot shown in <a href="#figure15-4" id="figureanchor15-4">Figure 15-4</a>. A wide variety of styles is available; play around with these styles to find some that you like.</p>
<figure>
<img src="Images/f15004.png" class="keyline" alt="" width="625" height="372"/>
<figcaption><p><a id="figure15-4">Figure 15-4</a>: The built-in seaborn style</p></figcaption>
</figure>
<h3 id="h2-502703c15-0004">Plotting and Styling Individual Points with scatter()</h3>
<p class="BodyFirst">Sometimes, it’s useful to plot and style individual points based on certain characteristics. For example, you might plot small values in one color and larger values in a different color. You could also plot a large dataset with one set of styling options and then emphasize individual points by replotting them with different options.</p>
<p><span epub:type="pagebreak" title="307" id="Page_307"/>To plot a single point, pass the single <em>x</em>- and <em>y</em>-values of the point to <code>scatter()</code>:</p>
<p class="CodeLabel"><b>scatter_squares.py</b></p>
<pre><code>import matplotlib.pyplot as plt

plt.style.use('seaborn')
fig, ax = plt.subplots()
ax.scatter(2, 4)

plt.show()</code></pre>
<p>Let’s style the output to make it more interesting. We’ll add a title, label the axes, and make sure all the text is large enough to read:</p>
<pre><code><span class="LiteralGray">import matplotlib.pyplot as plt</span>

<span class="LiteralGray">plt.style.use('seaborn')</span>
<span class="LiteralGray">fig, ax = plt.subplots()</span>
<span class="CodeAnnotationHang" aria-label="annotation1">❶</span> ax.scatter(2, 4, s=200)

# Set chart title and label axes.
ax.set_title("Square Numbers", fontsize=24)
ax.set_xlabel("Value", fontsize=14)
ax.set_ylabel("Square of Value", fontsize=14)

# Set size of tick labels.
ax.tick_params(labelsize=14)

<span class="LiteralGray">plt.show()</span></code></pre>
<p>We call <code>scatter()</code> and use the <code>s</code> argument to set the size of the dots used to draw the graph <span class="CodeAnnotation" aria-label="annotation1">❶</span>. When you run <em>scatter_squares.py </em>now, you should see a single point in the middle of the chart, as shown in <a href="#figure15-5" id="figureanchor15-5">Figure 15-5</a>.</p>
<figure>
<img src="Images/f15005.png" class="keyline" alt="" width="644" height="383"/>
<figcaption><p><a id="figure15-5">Figure 15-5</a>: Plotting a single point</p></figcaption>
</figure>
<h3 id="h2-502703c15-0005"><span epub:type="pagebreak" title="308" id="Page_308"/>Plotting a Series of Points with scatter()</h3>
<p class="BodyFirst">To plot a series of points, we can pass <code>scatter()</code> separate lists of <em>x</em>- and <em>y</em>-values, like this:</p>
<p class="CodeLabel"><b>scatter_squares.py</b></p>
<pre><code><span class="LiteralGray">import matplotlib.pyplot as plt</span>

x_values = [1, 2, 3, 4, 5]
y_values = [1, 4, 9, 16, 25]

<span class="LiteralGray">plt.style.use('seaborn')</span>
<span class="LiteralGray">fig, ax = plt.subplots()</span>
ax.scatter(x_values, y_values, s=100)

<span class="LiteralGray"># Set chart title and label axes.</span>
<em class="LiteralGrayItalic">--snip--</em></code></pre>
<p>The <code>x_values</code> list contains the numbers to be squared, and <code>y_values</code> contains the square of each number. When these lists are passed to <code>scatter()</code>, Matplotlib reads one value from each list as it plots each point. The points to be plotted are (1, 1), (2, 4), (3, 9), (4, 16), and (5, 25); <a href="#figure15-6" id="figureanchor15-6">Figure 15-6</a> shows the result.</p>
<figure>
<img src="Images/f15006.png" class="keyline" alt="" width="675" height="402"/>
<figcaption><p><a id="figure15-6">Figure 15-6</a>: A scatter plot with multiple points</p></figcaption>
</figure>
<h3 id="h2-502703c15-0006">Calculating Data Automatically</h3>
<p class="BodyFirst">Writing lists by hand can be inefficient, especially when we have many points. Rather than writing out each value, let’s use a loop to do the calculations for us.</p>
<p>Here’s how this would look with 1,000 points:</p>
<p class="CodeLabel"><b>scatter_squares.py</b></p>
<pre><code><span class="LiteralGray">import matplotlib.pyplot as plt</span>

<span class="CodeAnnotationHang" aria-label="annotation1">❶</span> x_values = range(1, 1001)
y_values = [x**2 for x in x_values]

<span epub:type="pagebreak" title="309" id="Page_309"/><span class="LiteralGray">plt.style.use('seaborn')</span>
<span class="LiteralGray">fig, ax = plt.subplots()</span>
<span class="CodeAnnotationHang" aria-label="annotation2">❷</span> ax.scatter(x_values, y_values, s=10)

<span class="LiteralGray"># Set chart title and label axes.</span>
<em class="LiteralGrayItalic">--snip--</em>

# Set the range for each axis.
<span class="CodeAnnotationHang" aria-label="annotation3">❸</span> ax.axis([0, 1100, 0, 1_100_000])

<span class="LiteralGray">plt.show()</span></code></pre>
<p>We start with a range of <em>x</em>-values containing the numbers 1 through 1,000 <span class="CodeAnnotation" aria-label="annotation1">❶</span>. Next, a list comprehension generates the <em>y</em>-values by looping through the <em>x</em>-values (<code>for x in x_values</code>), squaring each number (<code>x**2</code>), and assigning the results to <code>y_values</code>. We then pass the input and output lists to <code>scatter()</code> <span class="CodeAnnotation" aria-label="annotation2">❷</span>. Because this is a large dataset, we use a smaller point size.</p>
<p>Before showing the plot, we use the <code>axis()</code> method to specify the range of each axis <span class="CodeAnnotation" aria-label="annotation3">❸</span>. The <code>axis()</code> method requires four values: the minimum and maximum values for the <em>x</em>-axis and the <em>y</em>-axis. Here, we run the <em>x</em>-axis from 0 to 1,100 and the <em>y</em>-axis from 0 to 1,100,000. <a href="#figure15-7" id="figureanchor15-7">Figure 15-7</a> shows the result.</p>
<figure>
<img src="Images/f15007.png" class="keyline" alt="" width="694" height="413"/>
<figcaption><p><a id="figure15-7">Figure 15-7</a>: Python can plot 1,000 points as easily as it plots 5 points.</p></figcaption>
</figure>
<h3 id="h2-502703c15-0007">Customizing Tick Labels</h3>
<p class="BodyFirst">When the numbers on an axis get large enough, Matplotlib defaults to scientific notation for tick labels. This is usually a good thing, because larger numbers in plain notation take up a lot of unnecessary space on a visualization.</p>
<p><span epub:type="pagebreak" title="310" id="Page_310"/>Almost every element of a chart is customizable, so you can tell Matplotlib to keep using plain notation if you prefer:</p>
<pre><code><em class="LiteralGrayItalic">--snip--</em>
<span class="LiteralGray"># Set the range for each axis.</span>
<span class="LiteralGray">ax.axis([0, 1100, 0, 1_100_000])</span>
ax.ticklabel_format(style='plain')

<span class="LiteralGray">plt.show()</span></code></pre>
<p>The <code>ticklabel_format()</code> method allows you to override the default tick label style for any plot.</p>
<h3 id="h2-502703c15-0008">Defining Custom Colors</h3>
<p class="BodyFirst">To change the color of the points, pass the argument <code>color</code> to <code>scatter()</code> with the name of a color to use in quotation marks, as shown here:</p>
<pre><code>ax.scatter(x_values, y_values, color='red', s=10)</code></pre>
<p>You can also define custom colors using the RGB color model. To define a color, pass the <code>color</code> argument a tuple with three float values (one each for red, green, and blue, in that order), using values between 0 and 1. For example, the following line creates a plot with light-green dots:</p>
<pre><code>ax.scatter(x_values, y_values, color=(0, 0.8, 0), s=10)</code></pre>
<p>Values closer to 0 produce darker colors, and values closer to 1 produce lighter colors.</p>
<h3 id="h2-502703c15-0009">Using a Colormap</h3>
<p class="BodyFirst">A <em>colormap</em> is a sequence of colors in a gradient that moves from a starting to an ending color. In visualizations, colormaps are used to emphasize patterns in data. For example, you might make low values a light color and high values a darker color. Using a colormap ensures that all points in the visualization vary smoothly and accurately along a well-designed color scale.</p>
<p>The <code>pyplot</code> module includes a set of built-in colormaps. To use one of these colormaps, you need to specify how <code>pyplot</code> should assign a color to each point in the dataset. Here’s how to assign a color to each point, based on its <em>y</em>-value:</p>
<p class="CodeLabel"><b>scatter_squares.py</b></p>
<pre><code><em class="LiteralGrayItalic">--snip--</em>
<span class="LiteralGray">plt.style.use('seaborn')</span>
<span class="LiteralGray">fig, ax = plt.subplots()</span>
ax.scatter(x_values, y_values, c=y_values, cmap=plt.cm.Blues, s=10)

<span class="LiteralGray"># Set chart title and label axes.</span>
<em class="LiteralGrayItalic">--snip--</em></code></pre>
<p>The <code>c</code> argument is similar to <code>color</code>, but it’s used to associate a sequence of values with a color mapping. We pass the list of <em>y</em>-values to <code>c</code>, and then <span epub:type="pagebreak" title="311" id="Page_311"/>tell <code>pyplot</code> which colormap to use with the <code>cmap</code> argument. This code colors the points with lower <em>y</em>-values light blue and the points with higher <em>y</em>-values dark blue. <a href="#figure15-8" id="figureanchor15-8">Figure 15-8</a> shows the resulting plot.</p>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="note">
<h2><span class="NoteHead">Note</span></h2>
<p>	You can see all the colormaps available in <code>pyplot</code> at <a href="https://matplotlib.org" class="LinkURL">https://matplotlib.org</a>. Go to Tutorials, scroll down to Colors, and click <b>Choosing Colormaps in Matplotlib</b>.</p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<figure>
<img src="Images/f15008.png" class="keyline" alt="" width="694" height="413"/>
<figcaption><p><a id="figure15-8">Figure 15-8</a>: A plot using the <span class="LiteralInCaption"><code>Blues</code></span> colormap</p></figcaption>
</figure>
<h3 id="h2-502703c15-0010">Saving Your Plots Automatically</h3>
<p class="BodyFirst">If you want to save the plot to a file instead of showing it in the Matplotlib viewer, you can use <code>plt.savefig()</code> instead of <code>plt.show()</code>:</p>
<pre><code>plt.savefig('squares_plot.png', bbox_inches='tight')</code></pre>
<p>The first argument is a filename for the plot image, which will be saved in the same directory as <em>scatter_squares.py</em>. The second argument trims extra whitespace from the plot. If you want the extra whitespace around the plot, you can omit this argument. You can also call <code>savefig()</code> with a <code>Path</code> object, and write the output file anywhere you want on your system.</p>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="box">
<h2>Try It Yourself</h2>
<p class="BoxBodyCustom"><span id="h2-502703c15-11" class="BoxNumber">15-1.	Cubes:</span> A number raised to the third power is a <em>cube</em>. Plot the first five cubic numbers, and then plot the first 5,000 cubic numbers.</p>
<p class="BoxBodyCustom"><span id="h2-502703c15-12" class="BoxNumber">15-2.	Colored Cubes:</span> Apply a colormap to your cubes plot.</p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<h2 id="h1-502703c15-0003"><span epub:type="pagebreak" title="312" id="Page_312"/>Random Walks</h2>
<p class="BodyFirst">In this section, we’ll use Python to generate data for a random walk and then use Matplotlib to create a visually appealing representation of that data. A <em>random walk</em> is a path that’s determined by a series of simple decisions, each of which is left entirely to chance. You might imagine a random walk as the path a confused ant would take if it took every step in a random direction.</p>
<p>Random walks have practical applications in nature, physics, biology, chemistry, and economics. For example, a pollen grain floating on a drop of water moves across the surface of the water because it’s constantly pushed around by water molecules. Molecular motion in a water drop is random, so the path a pollen grain traces on the surface is a random walk. The code we’ll write next models many real-world situations.</p>
<h3 id="h2-502703c15-0011">Creating the RandomWalk Class</h3>
<p class="BodyFirst">To create a random walk, we’ll create a <code>RandomWalk</code> class, which will make random decisions about which direction the walk should take. The class needs three attributes: one variable to track the number of points in the walk, and two lists to store the <em>x</em>- and <em>y</em>-coordinates of each point in the walk.</p>
<p>We’ll only need two methods for the <code>RandomWalk</code> class: the <code>__init__()</code> method and <code>fill_walk()</code>, which will calculate the points in the walk. Let’s start with the <code>__init__()</code> method:</p>
<p class="CodeLabel"><b>random_walk.py</b></p>
<pre><code><span class="CodeAnnotationHang" aria-label="annotation1">❶</span> from random import choice

class RandomWalk:
    """A class to generate random walks."""

<span class="CodeAnnotationHang" aria-label="annotation2">❷</span>     def __init__(self, num_points=5000):
        """Initialize attributes of a walk."""
        self.num_points = num_points

        # All walks start at (0, 0).
<span class="CodeAnnotationHang" aria-label="annotation3">❸</span>         self.x_values = [0]
        self.y_values = [0]</code></pre>
<p>To make random decisions, we’ll store possible moves in a list and use the <code>choice()</code> function (from the <code>random</code> module) to decide which move to make each time a step is taken <span class="CodeAnnotation" aria-label="annotation1">❶</span>. We set the default number of points in a walk to <code>5000</code>, which is large enough to generate some interesting patterns but small enough to generate walks quickly <span class="CodeAnnotation" aria-label="annotation2">❷</span>. Then we make two lists to hold the <em>x</em>- and <em>y</em>-values, and we start each walk at the point (0, 0) <span class="CodeAnnotation" aria-label="annotation3">❸</span>.</p>
<h3 id="h2-502703c15-0012">Choosing Directions</h3>
<p class="BodyFirst">We’ll use the <code>fill_walk()</code> method to determine the full sequence of points in the walk. Add this method to <em>random_walk.py</em>:</p>
<p class="CodeLabel"><b>random_walk.py</b></p>
<pre><code><code>    </code>def fill_walk(self):
<code>        </code>"""Calculate all the points in the walk."""

<span epub:type="pagebreak" title="313" id="Page_313"/>   <code>    </code> # Keep taking steps until the walk reaches the desired length.
<span class="CodeAnnotationHang" aria-label="annotation1">❶</span> <code>    </code>    while len(self.x_values) &lt; self.num_points:

    <code>    </code>    # Decide which direction to go, and how far to go.
<span class="CodeAnnotationHang" aria-label="annotation2">❷</span>   <code>    </code>      x_direction = choice([1, -1])
    <code>    </code>    x_distance = choice([0, 1, 2, 3, 4])
<span class="CodeAnnotationHang" aria-label="annotation3">❸</span>     <code>    </code>    x_step = x_direction * x_distance

     <code>    </code>   y_direction = choice([1, -1])
    <code>    </code>    y_distance = choice([0, 1, 2, 3, 4])
<span class="CodeAnnotationHang" aria-label="annotation4">❹</span>      <code>    </code>   y_step = y_direction * y_distance

     <code>    </code>   # Reject moves that go nowhere.
<span class="CodeAnnotationHang" aria-label="annotation5">❺</span>      <code>    </code>   if x_step == 0 and y_step == 0:
     <code>    </code>       continue

     <code>    </code>   # Calculate the new position.
<span class="CodeAnnotationHang" aria-label="annotation6">❻</span>      <code>    </code>   x = self.x_values[-1] + x_step
    <code>    </code>    y = self.y_values[-1] + y_step

     <code>    </code>   self.x_values.append(x)
    <code>    </code>    self.y_values.append(y)</code></pre>
<p>We first set up a loop that runs until the walk is filled with the correct number of points <span class="CodeAnnotation" aria-label="annotation1">❶</span>. The main part of <code>fill_walk()</code> tells Python how to simulate four random decisions: Will the walk go right or left? How far will it go in that direction? Will it go up or down? How far will it go in that direction?</p>
<p>We use <code>choice([1, -1])</code> to choose a value for <code>x_direction</code>, which returns either 1 for movement to the right or −1 for movement to the left <span class="CodeAnnotation" aria-label="annotation2">❷</span>. Next, <code>choice([0, 1, 2, 3, 4])</code> randomly selects a distance to move in that direction. We assign this value to <code>x_distance</code>. The inclusion of a 0 allows for the possibility of steps that have movement along only one axis.</p>
<p>We determine the length of each step in the <em>x-</em> and <em>y-</em>directions by multiplying the direction of movement by the distance chosen <span class="CodeAnnotation" aria-label="annotation3">❸</span> <span class="CodeAnnotation" aria-label="annotation4">❹</span>. A positive result for <code>x_step</code> means move to the right, a negative result means move to the left, and 0 means move vertically. A positive result for <code>y_step</code> means move up, negative means move down, and 0 means move horizontally. If the values of both <code>x_step</code> and <code>y_step</code> are 0, the walk doesn’t go anywhere; when this happens, we continue the loop <span class="CodeAnnotation" aria-label="annotation5">❺</span>.</p>
<p>To get the next <em>x</em>-value for the walk, we add the value in <code>x_step</code> to the last value stored in <code>x_values</code> <span class="CodeAnnotation" aria-label="annotation6">❻</span> and do the same for the <em>y</em>-values. When we have the new point’s coordinates, we append them to <code>x_values</code> and <code>y_values</code>.</p>
<h3 id="h2-502703c15-0013">Plotting the Random Walk</h3>
<p class="BodyFirst">Here’s the code to plot all the points in the walk:</p>
<p class="CodeLabel"><b>rw_visual.py</b></p>
<pre><code>import matplotlib.pyplot as plt

from random_walk import RandomWalk

# Make a random walk.
<span epub:type="pagebreak" title="314" id="Page_314"/><span class="CodeAnnotationHang" aria-label="annotation1">❶</span> rw = RandomWalk()
rw.fill_walk()

# Plot the points in the walk.
plt.style.use('classic')
fig, ax = plt.subplots()
<span class="CodeAnnotationHang" aria-label="annotation2">❷</span> ax.scatter(rw.x_values, rw.y_values, s=15)
<span class="CodeAnnotationHang" aria-label="annotation3">❸</span> ax.set_aspect('equal')
plt.show()</code></pre>
<p>We begin by importing <code>pyplot</code> and <code>RandomWalk</code>. We then create a random walk and assign it to <code>rw</code> <span class="CodeAnnotation" aria-label="annotation1">❶</span>, making sure to call <code>fill_walk()</code>. To visualize the walk, we feed the walk’s <em>x</em>- and <em>y</em>-values to <code>scatter()</code> and choose an appropriate dot size <span class="CodeAnnotation" aria-label="annotation2">❷</span>. By default, Matplotlib scales each axis independently. But that approach would stretch most walks out horizontally or vertically. Here we use the <code>set_aspect()</code> method to specify that both axes should have equal spacing between tick marks <span class="CodeAnnotation" aria-label="annotation3">❸</span>.</p>
<p><a href="#figure15-9" id="figureanchor15-9">Figure 15-9</a> shows the resulting plot with 5,000 points. The images in this section omit Matplotlib’s viewer, but you’ll continue to see it when you run <em>rw_visual.py</em>.</p>
<figure>
<img src="Images/f15009.png" class="" alt="" width="639" height="340"/>
<figcaption><p><a id="figure15-9">Figure 15-9</a>: A random walk with 5,000 points</p></figcaption>
</figure>
<h3 id="h2-502703c15-0014">Generating Multiple Random Walks</h3>
<p class="BodyFirst">Every random walk is different, and it’s fun to explore the various patterns that can be generated. One way to use the preceding code to make multiple walks without having to run the program several times is to wrap it in a <code>while</code> loop, like this:</p>
<p class="CodeLabel"><b>rw_visual.py</b></p>
<pre><code><span class="LiteralGray">import matplotlib.pyplot as plt</span>

<span class="LiteralGray">from random_walk import RandomWalk</span>

# Keep making new walks, as long as the program is active.
<span epub:type="pagebreak" title="315" id="Page_315"/>while True:
<span class="LiteralGray">    # Make a random walk.</span>
    <em class="LiteralGrayItalic">--snip--</em>
<span class="LiteralGray">    plt.show()</span>

    keep_running = input("Make another walk? (y/n): ")
    if keep_running == 'n':
        break</code></pre>
<p>This code generates a random walk, displays it in Matplotlib’s viewer, and pauses with the viewer open. When you close the viewer, you’ll be asked whether you want to generate another walk. If you generate a few walks, you should see some that stay near the starting point, some that wander off mostly in one direction, some that have thin sections connecting larger groups of points, and many other kinds of walks. When you want to end the program, press N.</p>
<h3 id="h2-502703c15-0015">Styling the Walk</h3>
<p class="BodyFirst">In this section, we’ll customize our plots to emphasize the important characteristics of each walk and deemphasize distracting elements. To do so, we identify the characteristics we want to emphasize, such as where the walk began, where it ended, and the path taken. Next, we identify the characteristics to deemphasize, such as tick marks and labels. The result should be a simple visual representation that clearly communicates the path taken in each random walk.</p>
<h4 id="h3-502703c15-0001">Coloring the Points</h4>
<p class="BodyFirst">We’ll use a colormap to show the order of the points in the walk, and remove the black outline from each dot so the color of the dots will be clearer. To color the points according to their position in the walk, we pass the <code>c</code> argument a list containing the position of each point. Because the points are plotted in order, this list just contains the numbers from 0 to 4,999:</p>
<p class="CodeLabel"><b>rw_visual.py</b></p>
<pre><code><em class="LiteralGrayItalic">--snip--</em>
<span class="LiteralGray">while True:</span>
<span class="LiteralGray">    # Make a random walk.</span>
<span class="LiteralGray">    rw = RandomWalk()</span>
<span class="LiteralGray">    rw.fill_walk()</span>

    <span class="LiteralGray"># Plot the points in the walk.</span>
<span class="LiteralGray">    plt.style.use('classic')</span>
<span class="LiteralGray">    fig, ax = plt.subplots()</span>
<span class="CodeAnnotationHang" aria-label="annotation1">❶</span>     point_numbers = range(rw.num_points)
    ax.scatter(rw.x_values, rw.y_values, c=point_numbers, cmap=plt.cm.Blues,
        edgecolors='none', s=15)
    <span class="LiteralGray">ax.set_aspect('equal')</span>
<span class="LiteralGray">    plt.show()</span>
<span class="LiteralGray">    </span><em class="LiteralGrayItalic">--snip--</em></code></pre>
<p><span epub:type="pagebreak" title="316" id="Page_316"/>We use <code>range()</code> to generate a list of numbers equal to the number of points in the walk <span class="CodeAnnotation" aria-label="annotation1">❶</span>. We assign this list to <code>point_numbers</code>, which we’ll use to set the color of each point in the walk. We pass <code>point_numbers</code> to the <code>c</code> argument, use the <code>Blues</code> colormap, and then pass <code>edgecolors='none'</code> to get rid of the black outline around each point. The result is a plot that varies from light to dark blue, showing exactly how the walk moves from its starting point to its ending point. This is shown in <a href="#figure15-10" id="figureanchor15-10">Figure 15-10</a>.</p>
<figure>
<img src="Images/f15010.png" class="" alt="" width="629" height="338"/>
<figcaption><p><a id="figure15-10">Figure 15-10</a>: A random walk colored with the <span class="LiteralInCaption"><code>Blues</code></span> colormap</p></figcaption>
</figure>
<h4 id="h3-502703c15-0002">Plotting the Starting and Ending Points</h4>
<p class="BodyFirst">In addition to coloring points to show their position along the walk, it would be useful to see exactly where each walk begins and ends. To do so, we can plot the first and last points individually after the main series has been plotted. We’ll make the end points larger and color them differently to make them stand out:</p>
<p class="CodeLabel"><b>rw_visual.py</b></p>
<pre><code><em class="LiteralGrayItalic">--snip--</em>
<span class="LiteralGray">while True:</span>
<span class="LiteralGray">    </span><em class="LiteralGrayItalic">--snip--</em>
<span class="LiteralGray">    ax.scatter(rw.x_values, rw.y_values, c=point_numbers, cmap=plt.cm.Blues,</span>
<span class="LiteralGray">        edgecolors='none', s=15)</span>
<span class="LiteralGray">    ax.set_aspect('equal')</span>

    # Emphasize the first and last points.
    ax.scatter(0, 0, c='green', edgecolors='none', s=100)
    ax.scatter(rw.x_values[-1], rw.y_values[-1], c='red', edgecolors='none',
        s=100)

<span class="LiteralGray">    plt.show()</span>
<span class="LiteralGray">    </span><em class="LiteralGrayItalic">--snip--</em></code></pre>
<p>To show the starting point, we plot the point (0, 0) in green and in a larger size (<code>s=100</code>) than the rest of the points. To mark the end point, we <span epub:type="pagebreak" title="317" id="Page_317"/>plot the last <em>x</em>- and <em>y</em>-values in red with a size of 100 as well. Make sure you insert this code just before the call to <code>plt.show()</code> so the starting and ending points are drawn on top of all the other points.</p>
<p>When you run this code, you should be able to spot exactly where each walk begins and ends. If these end points don’t stand out clearly enough, adjust their color and size until they do.</p>
<h4 id="h3-502703c15-0003">Cleaning Up the Axes</h4>
<p class="BodyFirst">Let’s remove the axes in this plot so they don’t distract from the path of each walk. Here’s how to hide the axes:</p>
<p class="CodeLabel"><b>rw_visual.py</b></p>
<pre><code><em class="LiteralGrayItalic">--snip--</em>
<span class="LiteralGray">while True:</span>
<span class="LiteralGray">    </span><em class="LiteralGrayItalic">--snip--</em>
<span class="LiteralGray">    ax.scatter(rw.x_values[-1], rw.y_values[-1], c='red', edgecolors='none',</span>
<span class="LiteralGray">        s=100)</span>

    # Remove the axes.
    ax.get_xaxis().set_visible(False)
    ax.get_yaxis().set_visible(False)

<span class="LiteralGray">    plt.show()</span>
<span class="LiteralGray">    </span><em class="LiteralGrayItalic">--snip--</em></code></pre>
<p>To modify the axes, we use the <code>ax.get_xaxis()</code> and <code>ax.get_yaxis()</code> methods to get each axis, and then chain the <code>set_visible()</code> method to make each axis invisible. As you continue to work with visualizations, you’ll frequently see this chaining of methods to customize different aspects of a visualization.</p>
<p>Run <em>rw_visual.py</em> now; you should see a series of plots with no axes.</p>
<h4 id="h3-502703c15-0004">Adding Plot Points</h4>
<p class="BodyFirst">Let’s increase the number of points, to give us more data to work with. To do so, we increase the value of <code>num_points</code> when we make a <code>RandomWalk</code> instance and adjust the size of each dot when drawing the plot:</p>
<p class="CodeLabel"><b>rw_visual.py</b></p>
<pre><code><em class="LiteralGrayItalic">--snip--</em>
<span class="LiteralGray">while True:</span>
<span class="LiteralGray">    # Make a random walk.</span>
    rw = RandomWalk(50_000)
<span class="LiteralGray">    rw.fill_walk()</span>

<span class="LiteralGray">    # Plot the points in the walk.</span>
<span class="LiteralGray">    plt.style.use('classic')</span>
<span class="LiteralGray">    fig, ax = plt.subplots()</span>
<span class="LiteralGray">    point_numbers = range(rw.num_points)</span>
<span class="LiteralGray">    </span>ax.scatter(rw.x_values, rw.y_values, c=point_numbers, cmap=plt.cm.Blues,
        edgecolors='none', s=1)
<span class="LiteralGray">    </span><em class="LiteralGrayItalic">--snip--</em></code></pre>
<p><span epub:type="pagebreak" title="318" id="Page_318"/>This example creates a random walk with 50,000 points and plots each point at size <code>s=1</code>. The resulting walk is wispy and cloudlike, as shown in <a href="#figure15-11" id="figureanchor15-11">Figure 15-11</a>. We’ve created a piece of art from a simple scatter plot!</p>
<p>Experiment with this code to see how much you can increase the number of points in a walk before your system starts to slow down significantly or the plot loses its visual appeal.</p>
<figure>
<img src="Images/f15011.png" class="" alt="" width="694" height="447"/>
<figcaption><p><a id="figure15-11">Figure 15-11</a>: A walk with 50,000 points</p></figcaption>
</figure>
<h4 id="h3-502703c15-0005">Altering the Size to Fill the Screen</h4>
<p class="BodyFirst">A visualization is much more effective at communicating patterns in data if it fits nicely on the screen. To make the plotting window better fit your screen, you can adjust the size of Matplotlib’s output. This is done in the <code>subplots()</code> call:</p>
<pre><code>fig, ax = plt.subplots(figsize=(15, 9))</code></pre>
<p>When creating a plot, you can pass <code>subplots()</code> a <code>figsize</code> argument, which sets the size of the figure. The <code>figsize</code> parameter takes a tuple that tells Matplotlib the dimensions of the plotting window in inches.</p>
<p>Matplotlib assumes your screen resolution is 100 pixels per inch; if this code doesn’t give you an accurate plot size, adjust the numbers as necessary. Or, if you know your system’s resolution, you can pass <code>subplots()</code> the resolution using the <code>dpi</code> parameter:</p>
<pre><code>fig, ax = plt.subplots(figsize=(10, 6), dpi=128)</code></pre>
<p>This should help make the most efficient use of the space available on your screen.</p>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="box">
<h2><span epub:type="pagebreak" title="319" id="Page_319"/>Try It Yourself</h2>
<p class="BoxBodyCustom"><span id="h2-502703c15-18" class="BoxNumber">15-3.	Molecular Motion:</span> Modify <em>rw_visual.py</em> by replacing <code>ax.scatter()</code> with <code>ax.plot()</code>. To simulate the path of a pollen grain on the surface of a drop of water, pass in the <code>rw.x_values</code> and <code>rw.y_values</code>, and include a <code>linewidth</code> argument. Use 5,000 instead of 50,000 points to keep the plot from being too busy.</p>
<p class="BoxBodyCustom"><span id="h2-502703c15-19" class="BoxNumber">15-4.	Modified Random Walks:</span> In the <code>RandomWalk</code> class, <code>x_step</code> and <code>y_step</code> are generated from the same set of conditions. The direction is chosen randomly from the list <code>[1, -1]</code> and the distance from the list <code>[0, 1, 2, 3, 4]</code>. Modify the values in these lists to see what happens to the overall shape of your walks. Try a longer list of choices for the distance, such as 0 through 8, or remove the −1 from the <em>x-</em> or <em>y</em>-direction list.</p>
<p class="BoxBodyCustom"><span id="h2-502703c15-20" class="BoxNumber">15-5.	Refactoring:</span> The <code>fill_walk()</code> method is lengthy. Create a new method called <code>get_step()</code> to determine the direction and distance for each step, and then calculate the step. You should end up with two calls to <code>get_step()</code> in <code>fill_walk()</code>:</p>
<pre><code>x_step = self.get_step()
y_step = self.get_step()</code></pre>
<p class="BoxBody">This refactoring should reduce the size of <code>fill_walk()</code> and make the method easier to read and understand.</p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<h2 id="h1-502703c15-0004">Rolling Dice with Plotly</h2>
<p class="BodyFirst">In this section, we’ll use Plotly to produce interactive visualizations. Plotly is particularly useful when you’re creating visualizations that will be displayed in a browser, because the visualizations will scale automatically to fit the viewer’s screen. These visualizations are also interactive; when the user hovers over certain elements on the screen, information about those elements is highlighted. We’ll build our initial visualization in just a couple lines of code using <em>Plotly Express</em>, a subset of Plotly that focuses on generating plots with as little code as possible. Once we know our plot is correct, we’ll customize the output just as we did with Matplotlib.</p>
<p>In this project, we’ll analyze the results of rolling dice. When you roll one regular, six-sided die, you have an equal chance of rolling any of the numbers from 1 through 6. However, when you use two dice, you’re more likely to roll certain numbers than others. We’ll try to determine which numbers are most likely to occur by generating a dataset that represents rolling dice. Then we’ll plot the results of a large number of rolls to determine which results are more likely than others.</p>
<p>This work helps model games involving dice, but the core ideas also apply to games that involve chance of any kind, such as card games. It also relates to many real-world situations where randomness plays a significant factor.</p>
<h3 id="h2-502703c15-0016"><span epub:type="pagebreak" title="320" id="Page_320"/>Installing Plotly</h3>
<p class="BodyFirst">Install Plotly using pip, just as you did for Matplotlib:</p>
<pre><code>$ <b>python -m pip install --user plotly</b>
$ <b>python -m pip install --user pandas</b></code></pre>
<p>Plotly Express depends on <em>pandas</em>, which is a library for working efficiently with data, so we need to install that as well. If you used <code class="bold">python3</code> or something else when installing Matplotlib, make sure you use the same command here.</p>
<p>To see what kind of visualizations are possible with Plotly, visit the gallery of chart types at <a href="https://plotly.com/python" class="LinkURL">https://plotly.com/python</a>. Each example includes source code, so you can see how Plotly generates the visualizations.</p>
<h3 id="h2-502703c15-0017">Creating the Die Class</h3>
<p class="BodyFirst">We’ll create the following <code>Die</code> class to simulate the roll of one die:</p>
<p class="CodeLabel"><b>die.py</b></p>
<pre><code>from random import randint

class Die:
    """A class representing a single die."""

<span class="CodeAnnotationHang" aria-label="annotation1">❶</span>     def __init__(self, num_sides=6):
        """Assume a six-sided die."""
        self.num_sides = num_sides

    def roll(self):
        """"Return a random value between 1 and number of sides."""
<span class="CodeAnnotationHang" aria-label="annotation2">❷</span>         return randint(1, self.num_sides)</code></pre>
<p>The <code>__init__()</code> method takes one optional argument <span class="CodeAnnotation" aria-label="annotation1">❶</span>. With the <code>Die</code> class, when an instance of our die is created, the number of sides will be six if no argument is included. If an argument <em>is</em> included, that value will set the number of sides on the die. (Dice are named for their number of sides: a six-sided die is a D6, an eight-sided die is a D8, and so on.)</p>
<p>The <code>roll()</code> method uses the <code>randint()</code> function to return a random number between 1 and the number of sides <span class="CodeAnnotation" aria-label="annotation2">❷</span>. This function can return the starting value (1), the ending value (<code>num_sides</code>), or any integer between the two.</p>
<h3 id="h2-502703c15-0018">Rolling the Die</h3>
<p class="BodyFirst">Before creating a visualization based on the <code>Die</code> class, let’s roll a D6, print the results, and check that the results look reasonable:</p>
<p class="CodeLabel"><b>die_visual.py</b></p>
<pre><code>from die import Die

# Create a D6.
<span class="CodeAnnotationHang" aria-label="annotation1">❶</span> die = Die()

<span epub:type="pagebreak" title="321" id="Page_321"/># Make some rolls, and store results in a list.
results = []
<span class="CodeAnnotationHang" aria-label="annotation2">❷</span> for roll_num in range(100):
    result = die.roll()
    results.append(result)

print(results)</code></pre>
<p>We create an instance of <code>Die</code> with the default six sides <span class="CodeAnnotation" aria-label="annotation1">❶</span>. Then we roll the die <code>100</code> times <span class="CodeAnnotation" aria-label="annotation2">❷</span> and store the result of each roll in the list <code>results</code>. Here’s a sample set of results:</p>
<pre><code>[4, 6, 5, 6, 1, 5, 6, 3, 5, 3, 5, 3, 2, 2, 1, 3, 1, 5, 3, 6, 3, 6, 5, 4,  1, 1, 4, 2, 3, 6, 4, 2, 6, 4, 1, 3, 2, 5, 6, 3, 6, 2, 1, 1, 3, 4, 1, 4, 3, 5, 1, 4, 5, 5, 2, 3, 3, 1, 2, 3, 5, 6, 2, 5, 6, 1, 3, 2, 1, 1, 1, 6, 5, 5, 2, 2, 6, 4, 1, 4, 5, 1, 1, 1, 4, 5, 3, 3, 1, 3, 5, 4, 5, 6, 5, 4, 1, 5, 1, 2]</code></pre>
<p>A quick scan of these results shows that the <code>Die</code> class seems to be working. We see the values 1 and 6, so we know the smallest and largest possible values are being returned, and because we don’t see 0 or 7, we know all the results are in the appropriate range. We also see each number from 1 through 6, which indicates that all possible outcomes are represented. Let’s determine exactly how many times each number appears.</p>
<h3 id="h2-502703c15-0019">Analyzing the Results</h3>
<p class="BodyFirst">We’ll analyze the results of rolling one D6 by counting how many times we roll each number:</p>
<p class="CodeLabel"><b>die_visual.py</b></p>
<pre><code><em class="LiteralGrayItalic">--snip--</em>
<span class="LiteralGray"># Make some rolls, and store results in a list.</span>
<span class="LiteralGray">results = []</span>
<span class="CodeAnnotationHang" aria-label="annotation1">❶</span> for roll_num in range(1000):
<span class="LiteralGray">    result = die.roll()</span>
<span class="LiteralGray">    results.append(result)</span>

# Analyze the results.
frequencies = []
<span class="CodeAnnotationHang" aria-label="annotation2">❷</span> poss_results = range(1, die.num_sides+1)
for value in poss_results:
<span class="CodeAnnotationHang" aria-label="annotation3">❸</span>     frequency = results.count(value)
<span class="CodeAnnotationHang" aria-label="annotation4">❹</span>     frequencies.append(frequency)

print(frequencies)</code></pre>
<p>Because we’re no longer printing the results, we can increase the number of simulated rolls to <code>1000</code> <span class="CodeAnnotation" aria-label="annotation1">❶</span>. To analyze the rolls, we create the empty list <code>frequencies</code> to store the number of times each value is rolled. We then generate all the possible results we could get; in this example, that’s all the numbers from <code>1</code> to however many sides <code>die</code> has <span class="CodeAnnotation" aria-label="annotation2">❷</span>. We loop through the possible values, count how many times each number appears in <code>results</code> <span class="CodeAnnotation" aria-label="annotation3">❸</span>, and <span epub:type="pagebreak" title="322" id="Page_322"/>then append this value to <code>frequencies</code> <span class="CodeAnnotation" aria-label="annotation4">❹</span>. We print this list before making a visualization:</p>
<pre><code>[155, 167, 168, 170, 159, 181]</code></pre>
<p>These results look reasonable: we see six frequencies, one for each possible number when you roll a D6. We also see that no frequency is significantly higher than any other. Now let’s visualize these results.</p>
<h3 id="h2-502703c15-0020">Making a Histogram</h3>
<p class="BodyFirst">Now that we have the data we want, we can generate a visualization in just a couple lines of code using Plotly Express:</p>
<p class="CodeLabel"><b>die_visual.py</b></p>
<pre><code>import plotly.express as px

<span class="LiteralGray">from die import Die</span>
<em class="LiteralGrayItalic">--snip--</em>

<span class="LiteralGray">for value in poss_results:</span>
<span class="LiteralGray">    frequency = results.count(value)</span>
<span class="LiteralGray">    frequencies.append(frequency)</span>

# Visualize the results.
fig = px.bar(x=poss_results, y=frequencies)
fig.show()</code></pre>
<p>We first import the <code>plotly.express</code> module, using the conventional alias <code>px</code>. We then use the <code>px.bar()</code> function to create a bar graph. In the simplest use of this function, we only need to pass a set of <em>x-</em>values and a set of <em>y-</em>values. Here the <em>x</em>-values are the possible results from rolling a single die, and the <em>y</em>-values are the frequencies for each possible result.</p>
<p>The final line calls <code>fig.show()</code>, which tells Plotly to render the resulting chart as an HTML file and open that file in a new browser tab. The result is shown in <a href="#figure15-12" id="figureanchor15-12">Figure 15-12</a>.</p>
<p>This is a really simple chart, and it’s certainly not complete. But this is exactly how Plotly Express is meant to be used; you write a couple lines of code, look at the plot, and make sure it represents the data the way you want it to. If you like what you see, you can move on to customizing elements of the chart such as labels and styles. But if you want to explore other possible chart types, you can do so now, without having spent extra time on customization work. Feel free to try this now by changing <code>px.bar()</code> to something like <code>px.scatter()</code> or <code>px.line()</code>. You can find a full list of available chart types at <a href="https://plotly.com/python/plotly-express" class="LinkURL">https://plotly.com/python/plotly-express</a>.</p>
<p>This chart is dynamic and interactive. If you change the size of your browser window, the chart will resize to match the available space. If you hover over any of the bars, you’ll see a pop-up highlighting the specific data related to that bar.</p>
<span epub:type="pagebreak" title="323" id="Page_323"/><figure>
<img src="Images/f15012.png" class="keyline" alt="" width="694" height="430"/>
<figcaption><p><a id="figure15-12">Figure 15-12</a>: The initial plot produced by Plotly Express</p></figcaption>
</figure>
<h3 id="h2-502703c15-0021">Customizing the Plot</h3>
<p class="BodyFirst">Now that we know we have the correct kind of plot and our data is being represented accurately, we can focus on adding the appropriate labels and styles for the chart.</p>
<p>The first way to customize a plot with Plotly is to use some optional parameters in the initial call that generates the plot, in this case, <code>px.bar()</code>. Here’s how to add an overall title and a label for each axis:</p>
<p class="CodeLabel"><b>die_visual.py</b></p>
<pre><code><em class="LiteralGrayItalic">--snip--</em>
<span class="LiteralGray"># Visualize the results.</span>
<span class="CodeAnnotationHang" aria-label="annotation1">❶</span> title = "Results of Rolling One D6 1,000 Times"
<span class="CodeAnnotationHang" aria-label="annotation2">❷</span> labels = {'x': 'Result', 'y': 'Frequency of Result'}
fig = px.bar(x=poss_results, y=frequencies, title=title, labels=labels)
<span class="LiteralGray">fig.show()</span></code></pre>
<p>We first define the title that we want, here assigned to <code>title</code> <span class="CodeAnnotation" aria-label="annotation1">❶</span>. To define axis labels, we write a dictionary <span class="CodeAnnotation" aria-label="annotation2">❷</span>. The keys in the dictionary refer to the labels we want to customize, and the values are the custom labels we want to use. Here we give the <em>x</em>-axis the label <code>Result</code> and the <em>y</em>-axis the label <code>Frequency of Result</code>. The call to <code>px.bar()</code> now includes the optional arguments <code>title</code> and <code>labels</code>.</p>
<p>Now when the plot is generated it includes an appropriate title and a label for each axis, as shown in <a href="#figure15-13" id="figureanchor15-13">Figure 15-13</a>.</p>
<span epub:type="pagebreak" title="324" id="Page_324"/><figure>
<img src="Images/f15013.png" class="keyline" alt="" width="694" height="430"/>
<figcaption><p><a id="figure15-13">Figure 15-13</a>: A simple bar chart created with Plotly</p></figcaption>
</figure>
<h3 id="h2-502703c15-0022">Rolling Two Dice</h3>
<p class="BodyFirst">Rolling two dice results in larger numbers and a different distribution of results. Let’s modify our code to create two D6 dice to simulate the way we roll a pair of dice. Each time we roll the pair, we’ll add the two numbers (one from each die) and store the sum in <code>results</code>. Save a copy of <em>die_visual.py</em> as <em>dice_visual.py</em> and make the following changes:</p>
<p class="CodeLabel"><b>dice_visual.py</b></p>
<pre><code><span class="LiteralGray">import plotly.express as px</span>

<span class="LiteralGray">from die import Die</span>

# Create two D6 dice.
die_1 = Die()
die_2 = Die()

<span class="LiteralGray"># Make some rolls, and store results in a list.</span>
<span class="LiteralGray">results = []</span>
<span class="LiteralGray">for roll_num in range(1000):</span>
<span class="CodeAnnotationHang" aria-label="annotation1">❶</span>     result = die_1.roll() + die_2.roll()
<span class="LiteralGray">    results.append(result)</span>

<span class="LiteralGray"># Analyze the results.</span>
<span class="LiteralGray">frequencies = []</span>
<span class="CodeAnnotationHang" aria-label="annotation2">❷</span> max_result = die_1.num_sides + die_2.num_sides
<span class="CodeAnnotationHang" aria-label="annotation3">❸</span> poss_results = range(2, max_result+1)
<span class="LiteralGray">for value in poss_results:</span>
<span class="LiteralGray">    frequency = results.count(value)</span>
<span class="LiteralGray">    frequencies.append(frequency)</span>

<span epub:type="pagebreak" title="325" id="Page_325"/><span class="LiteralGray"># Visualize the results.</span>
title = "Results of Rolling Two D6 Dice 1,000 Times"
<span class="LiteralGray">labels = {'x': 'Result', 'y': 'Frequency of Result'}</span>
<span class="LiteralGray">fig = px.bar(x=poss_results, y=frequencies, title=title, labels=labels)</span>
<span class="LiteralGray">fig.show()</span></code></pre>
<p>After creating two instances of <code>Die</code>, we roll the dice and calculate the sum of the two dice for each roll <span class="CodeAnnotation" aria-label="annotation1">❶</span>. The smallest possible result (2) is the sum of the smallest number on each die. The largest possible result (12) is the sum of the largest number on each die, which we assign to <code>max_result</code> <span class="CodeAnnotation" aria-label="annotation2">❷</span>. The variable <code>max_result</code> makes the code for generating <code>poss_results</code> much easier to read <span class="CodeAnnotation" aria-label="annotation3">❸</span>. We could have written <code>range(2, 13)</code>, but this would work only for two D6 dice. When modeling real-world situations, it’s best to write code that can easily model a variety of situations. This code allows us to simulate rolling a pair of dice with any number of sides.</p>
<p>After running this code, you should see a chart that looks like <a href="#figure15-14" id="figureanchor15-14">Figure 15-14</a>.</p>
<figure>
<img src="Images/f15014.png" class="keyline" alt="" width="694" height="430"/>
<figcaption><p><a id="figure15-14">Figure 15-14</a>: Simulated results of rolling two six-sided dice 1,000 times</p></figcaption>
</figure>
<p>This graph shows the approximate distribution of results you’re likely to get when you roll a pair of D6 dice. As you can see, you’re least likely to roll a 2 or a 12 and most likely to roll a 7. This happens because there are six ways to roll a 7: 1 and 6, 2 and 5, 3 and 4, 4 and 3, 5 and 2, and 6 and 1.</p>
<h3 id="h2-502703c15-0023">Further Customizations</h3>
<p class="BodyFirst">There’s one issue that we should address with the plot we just generated. Now that there are 11 bars, the default layout settings for the <em>x</em>-axis leave some of the bars unlabeled. While the default settings work well for most visualizations, this chart would look better with all of the bars labeled.</p>
<p><span epub:type="pagebreak" title="326" id="Page_326"/>Plotly has an <code>update_layout()</code> method that can be used to make a wide variety of updates to a figure after it’s been created. Here’s how to tell Plotly to give each bar its own label:</p>
<p class="CodeLabel"><b>dice_visual.py</b></p>
<pre><code><em class="LiteralGrayItalic">--snip--</em>
<span class="LiteralGray">fig = px.bar(x=poss_results, y=frequencies, title=title, labels=labels)</span>

# Further customize chart.
fig.update_layout(xaxis_dtick=1)

<span class="LiteralGray">fig.show()</span></code></pre>
<p>The <code>update_layout()</code> method acts on the <code>fig</code> object, which represents the overall chart. Here we use the <code>xaxis_dtick</code> argument, which specifies the distance between tick marks on the <em>x</em>-axis. We set that spacing to <code>1</code>, so that every bar is labeled. When you run <em>dice_visual.py</em> again, you should see a label on each bar.</p>
<h3 id="h2-502703c15-0024">Rolling Dice of Different Sizes</h3>
<p class="BodyFirst">Let’s create a six-sided die and a ten-sided die, and see what happens when we roll them 50,000 times:</p>
<p class="CodeLabel"><b>dice_visual_d6d10.py</b></p>
<pre><code><span class="LiteralGray">import plotly.express as px</span>

<span class="LiteralGray">from die import Die</span>

# Create a D6 and a D10.
<span class="LiteralGray">die_1 = Die()</span>
<span class="CodeAnnotationHang" aria-label="annotation1">❶</span> die_2 = Die(10)

<span class="LiteralGray"># Make some rolls, and store results in a list.</span>
<span class="LiteralGray">results = []</span>
for roll_num in range(50_000):
<span class="LiteralGray">    result = die_1.roll() + die_2.roll()</span>
<span class="LiteralGray">    results.append(result)</span>

<span class="LiteralGray"># Analyze the results.</span>
<em class="LiteralGrayItalic">--snip--</em>

<span class="LiteralGray"># Visualize the results.</span>
<span class="CodeAnnotationHang" aria-label="annotation2">❷</span> title = "Results of Rolling a D6 and a D10 50,000 Times"
<span class="LiteralGray">labels = {'x': 'Result', 'y': 'Frequency of Result'}</span>
<em class="LiteralGrayItalic">--snip--</em></code></pre>
<p>To make a D10, we pass the argument <code>10</code> when creating the second <code>Die</code> instance <span class="CodeAnnotation" aria-label="annotation1">❶</span> and change the first loop to simulate 50,000 rolls instead of 1,000. We change the title of the graph as well <span class="CodeAnnotation" aria-label="annotation2">❷</span>.</p>
<p><span epub:type="pagebreak" title="327" id="Page_327"/><a href="#figure15-15" id="figureanchor15-15">Figure 15-15</a> shows the resulting chart. Instead of one most likely result, there are five such results. This happens because there’s still only one way to roll the smallest value (1 and 1) and the largest value (6 and 10), but the smaller die limits the number of ways you can generate the middle numbers. There are six ways to roll a 7, 8, 9, 10, or 11, these are the most common results, and you’re equally likely to roll any one of them.</p>
<figure>
<img src="Images/f15015.png" class="keyline" alt="" width="694" height="430"/>
<figcaption><p><a id="figure15-15">Figure 15-15</a>: The results of rolling a six-sided die and a ten-sided die 50,000 times</p></figcaption>
</figure>
<p>Our ability to use Plotly to model the rolling of dice gives us considerable freedom in exploring this phenomenon. In just minutes, you can simulate a tremendous number of rolls using a large variety of dice.</p>
<h3 id="h2-502703c15-0025">Saving Figures</h3>
<p class="BodyFirst">When you have a figure you like, you can always save the chart as an HTML file through your browser. But you can also do so programmatically. To save your chart as an HTML file, replace the call to <code>fig.show()</code> with a call to <code>fig.write_html()</code>:</p>
<pre><code>fig.write_html('dice_visual_d6d10.html')</code></pre>
<p>The <code>write_html()</code> method requires one argument: the name of the file to write to. If you only provide a filename, the file will be saved in the same directory as the <em>.py</em> file. You can also call <code>write_html()</code> with a <code>Path</code> object, and write the output file anywhere you want on your system.</p>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="box">
<h2><span epub:type="pagebreak" title="328" id="Page_328"/>Try It Yourself</h2>
<p class="BoxBodyCustom"><span id="h2-502703c15-31" class="BoxNumber">15-6.	Two D8s:</span> Create a simulation showing what happens when you roll two eight-sided dice 1,000 times. Try to picture what you think the visualization will look like before you run the simulation, then see if your intuition was correct. Gradually increase the number of rolls until you start to see the limits of your system’s capabilities.</p>
<p class="BoxBodyCustom"><span id="h2-502703c15-32" class="BoxNumber">15-7.	Three Dice:</span> When you roll three D6 dice, the smallest number you can roll is 3 and the largest number is 18. Create a visualization that shows what happens when you roll three D6 dice.</p>
<p class="BoxBodyCustom"><span id="h2-502703c15-33" class="BoxNumber">15-8.	Multiplication:</span> When you roll two dice, you usually add the two numbers together to get the result. Create a visualization that shows what happens if you multiply these numbers by each other instead.</p>
<p class="BoxBodyCustom"><span id="h2-502703c15-34" class="BoxNumber">15-9.	Die Comprehensions:</span> For clarity, the listings in this section use the long form of <code>for</code> loops. If you’re comfortable using list comprehensions, try writing a comprehension for one or both of the loops in each of these programs.</p>
<p class="BoxBodyCustom"><span id="h2-502703c15-35" class="BoxNumber">15-10. Practicing with Both Libraries:</span> Try using Matplotlib to make a die-rolling visualization, and use Plotly to make the visualization for a random walk. (You’ll need to consult the documentation for each library to complete this exercise.)</p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<h2 id="h1-502703c15-0005">Summary</h2>
<p class="BodyFirst">In this chapter, you learned to generate datasets and create visualizations of that data. You created simple plots with Matplotlib and used a scatter plot to explore random walks. You also created a histogram with Plotly, and used it to explore the results of rolling dice of different sizes.</p>
<p>Generating your own datasets with code is an interesting and powerful way to model and explore a wide variety of real-world situations. As you continue to work through the data visualization projects that follow, keep an eye out for situations you might be able to model with code. Look at the visualizations you see in news media, and see if you can identify those that were generated using methods similar to the ones you’re learning in these projects.</p>
<p>In <span class="xref" itemid="xref_target_Chapter 16">Chapter 16</span>, you’ll download data from online sources and continue to use Matplotlib and Plotly to explore that data.</p>
</section>
</div>
<div id="sbo-rt-content"><section>
<header>
<h1 class="chapter">
<span class="ChapterNumber"><span epub:type="pagebreak" title="329" id="Page_329"/>16</span><br/>
<span class="ChapterTitle">Downloading Data</span></h1>
</header>
<figure class="opener">
<img src="Images/chapterart.png" alt="" width="406" height="406"/>
</figure>
<p class="ChapterIntro">In this chapter, you’ll download datasets from online sources and create working visualizations of that data. You can find an incredible variety of data online, much of which hasn’t been examined thoroughly. The ability to analyze this data allows you to discover patterns and connections that no one else has found.</p>
<p>We’ll access and visualize data stored in two common data formats: CSV and JSON. We’ll use Python’s <code>csv</code> module to process weather data stored in the CSV format and analyze high and low temperatures over time in two different locations. We’ll then use Matplotlib to generate a chart based on our downloaded data to display variations in temperature in two dissimilar environments: Sitka, Alaska, and Death Valley, California. Later in the chapter, we’ll use the <code>json</code> module to access earthquake data stored in the GeoJSON format and use Plotly to draw a world map showing the locations and magnitudes of recent earthquakes.</p>
<p><span epub:type="pagebreak" title="330" id="Page_330"/>By the end of this chapter, you’ll be prepared to work with various types of datasets in different formats, and you’ll have a deeper understanding of how to build complex visualizations. Being able to access and visualize online data is essential to working with a wide variety of real-world datasets.</p>
<h2 id="h1-502703c16-0001">The CSV File Format</h2>
<p class="BodyFirst">One simple way to store data in a text file is to write the data as a series of values separated by commas, called <em>comma-separated values</em>. The resulting files are <em>CSV</em> files. For example, here’s a chunk of weather data in CSV format:</p>
<pre><code>"USW00025333","SITKA AIRPORT, AK US","2021-01-01",,"44","40"</code></pre>
<p>This is an excerpt of weather data from January 1, 2021, in Sitka, Alaska. It includes the day’s high and low temperatures, as well as a number of other measurements from that day. CSV files can be tedious for humans to read, but programs can process and extract information from them quickly and accurately.</p>
<p>We’ll begin with a small set of CSV-formatted weather data recorded in Sitka; it is available in this book’s resources at <a href="https://ehmatthes.github.io/pcc_3e" class="LinkURL">https://ehmatthes.github.io/pcc_3e</a>. Make a folder called <em>weather_data</em> inside the folder where you’re saving this chapter’s programs. Copy the file <em>sitka_weather_07-2021_simple.csv</em> into this new folder. (After you download this book’s resources, you’ll have all the files you need for this project.)</p>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="note">
<h2><span class="NoteHead">Note</span></h2>
<p>	The weather data in this project was originally downloaded from <a href="https://ncdc.noaa.gov/cdo-web" class="LinkURL">https://ncdc.noaa.gov/cdo-web</a>.</p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<h3 id="h2-502703c16-0001">Parsing the CSV File Headers</h3>
<p class="BodyFirst">Python’s <code>csv</code> module in the standard library parses the lines in a CSV file and allows us to quickly extract the values we’re interested in. Let’s start by examining the first line of the file, which contains a series of headers for the data. These headers tell us what kind of information the data holds:</p>
<p class="CodeLabel"><b>sitka_highs.py</b></p>
<pre><code>from pathlib import Path
import csv

<span class="CodeAnnotationHang" aria-label="annotation1">❶</span> path = Path('weather_data/sitka_weather_07-2021_simple.csv')
lines = path.read_text().splitlines()

<span class="CodeAnnotationHang" aria-label="annotation2">❷</span> reader = csv.reader(lines)
<span class="CodeAnnotationHang" aria-label="annotation3">❸</span> header_row = next(reader)
print(header_row)</code></pre>
<p>We first import <code>Path</code> and the <code>csv</code> module. We then build a <code>Path</code> object that looks in the <em>weather_data</em> folder, and points to the specific weather data file we want to work with <span class="CodeAnnotation" aria-label="annotation1">❶</span>. We read the file and chain the <code>splitlines()</code> method to get a list of all lines in the file, which we assign to <code>lines</code>.</p>
<p><span epub:type="pagebreak" title="331" id="Page_331"/>Next, we build a <code>reader</code> object <span class="CodeAnnotation" aria-label="annotation2">❷</span>. This is an object that can be used to parse each line in the file. To make a reader object, call the function <code>csv.reader()</code> and pass it the list of lines from the CSV file.</p>
<p>When given a <code>reader</code> object, the <code>next()</code> function returns the next line in the file, starting from the beginning of the file. Here we call <code>next()</code> only once, so we get the first line of the file, which contains the file headers <span class="CodeAnnotation" aria-label="annotation3">❸</span>. We assign the data that’s returned to <code>header_row</code>. As you can see, <code>header_row</code> contains meaningful, weather-related headers that tell us what information each line of data holds:</p>
<pre><code>['STATION', 'NAME', 'DATE', 'TAVG', 'TMAX', 'TMIN']</code></pre>
<p>The <code>reader</code> object processes the first line of comma-separated values in the file and stores each value as an item in a list. The header <code>STATION</code> represents the code for the weather station that recorded this data. The position of this header tells us that the first value in each line will be the weather station code. The <code>NAME</code> header indicates that the second value in each line is the name of the weather station that made the recording. The rest of the headers specify what kinds of information were recorded in each reading. The data we’re most interested in for now are the date (<code>DATE</code>), the high temperature (<code>TMAX</code>), and the low temperature (<code>TMIN</code>). This is a simple dataset that contains only temperature-related data. When you download your own weather data, you can choose to include a number of other measurements relating to wind speed, wind direction, and precipitation data.</p>
<h3 id="h2-502703c16-0002">Printing the Headers and Their Positions</h3>
<p class="BodyFirst">To make it easier to understand the file header data, let’s print each header and its position in the list:</p>
<p class="CodeLabel"><b>sitka_highs.py</b></p>
<pre><code><em class="LiteralGrayItalic">--snip--</em>
<span class="LiteralGray">reader = csv.reader(lines)</span>
<span class="LiteralGray">header_row = next(reader)</span>

for index, column_header in enumerate(header_row):
    print(index, column_header)</code></pre>
<p>The <code>enumerate()</code> function returns both the index of each item and the value of each item as you loop through a list. (Note that we’ve removed the line <code>print(header_row)</code> in favor of this more detailed version.)</p>
<p>Here’s the output showing the index of each header:</p>
<pre><code>0 STATION
1 NAME
2 DATE
3 TAVG
4 TMAX
5 TMIN</code></pre>
<p><span epub:type="pagebreak" title="332" id="Page_332"/>We can see that the dates and their high temperatures are stored in columns 2 and 4. To explore this data, we’ll process each row of data in <em>sitka_weather_07-2021_simple.csv</em> and extract the values with the indexes 2 and 4.</p>
<h3 id="h2-502703c16-0003">Extracting and Reading Data</h3>
<p class="BodyFirst">Now that we know which columns of data we need, let’s read in some of that data. First, we’ll read in the high temperature for each day:</p>
<p class="CodeLabel"><b>sitka_highs.py</b></p>
<pre><code><em class="LiteralGrayItalic">--snip--</em>
<span class="LiteralGray">reader = csv.reader(lines)</span>
<span class="LiteralGray">header_row = next(reader)</span>

# Extract high temperatures.
<span class="CodeAnnotationHang" aria-label="annotation1">❶</span> highs = []
<span class="CodeAnnotationHang" aria-label="annotation2">❷</span> for row in reader:
<span class="CodeAnnotationHang" aria-label="annotation3">❸</span>     high = int(row[4])
    highs.append(high)

print(highs)</code></pre>
<p>We make an empty list called <code>highs</code> <span class="CodeAnnotation" aria-label="annotation1">❶</span> and then loop through the remaining rows in the file <span class="CodeAnnotation" aria-label="annotation2">❷</span>. The <code>reader</code> object continues from where it left off in the CSV file and automatically returns each line following its current position. Because we’ve already read the header row, the loop will begin at the second line where the actual data begins. On each pass through the loop we pull the data from index 4, corresponding to the header <code>TMAX</code>, and assign it to the variable <code>high</code> <span class="CodeAnnotation" aria-label="annotation3">❸</span>. We use the <code>int()</code> function to convert the data, which is stored as a string, to a numerical format so we can use it. We then append this value to <code>highs</code>.</p>
<p>The following listing shows the data now stored in <code>highs</code>:</p>
<pre><code>[61, 60, 66, 60, 65, 59, 58, 58, 57, 60, 60, 60, 57, 58, 60, 61, 63, 63, 70, 64, 59, 63, 61, 58, 59, 64, 62, 70, 70, 73, 66]</code></pre>
<p>We’ve extracted the high temperature for each date and stored each value in a list. Now let’s create a visualization of this data.</p>
<h3 id="h2-502703c16-0004">Plotting Data in a Temperature Chart</h3>
<p class="BodyFirst">To visualize the temperature data we have, we’ll first create a simple plot of the daily highs using Matplotlib, as shown here:</p>
<p class="CodeLabel"><b>sitka_highs.py</b></p>
<pre><code><span class="LiteralGray">from pathlib import Path</span>
<span class="LiteralGray">import csv</span>

import matplotlib.pyplot as plt

<span class="LiteralGray">path = Path('weather_data/sitka_weather_07-2021_simple.csv')</span>
<span class="LiteralGray">lines = path.read_text().splitlines()</span>
<span class="LiteralGray">    </span><em class="LiteralGrayItalic">--snip--</em>

<span epub:type="pagebreak" title="333" id="Page_333"/># Plot the high temperatures.
plt.style.use('seaborn')
fig, ax = plt.subplots()
<span class="CodeAnnotationHang" aria-label="annotation1">❶</span> ax.plot(highs, color='red')

# Format plot.
<span class="CodeAnnotationHang" aria-label="annotation2">❷</span> ax.set_title("Daily High Temperatures, July 2021", fontsize=24)
<span class="CodeAnnotationHang" aria-label="annotation3">❸</span> ax.set_xlabel('', fontsize=16)
ax.set_ylabel("Temperature (F)", fontsize=16)
ax.tick_params(labelsize=16)

plt.show()</code></pre>
<p>We pass the list of highs to <code>plot()</code> and pass <code>color='red'</code> to plot the points in red <span class="CodeAnnotation" aria-label="annotation1">❶</span>. (We’ll plot the highs in red and the lows in blue.) We then specify a few other formatting details, such as the title, font size, and labels <span class="CodeAnnotation" aria-label="annotation2">❷</span>, just as we did in <span class="xref" itemid="xref_target_Chapter 15">Chapter 15</span>. Because we have yet to add the dates, we won’t label the <em>x</em>-axis, but <code>ax.set_xlabel()</code> does modify the font size to make the default labels more readable <span class="CodeAnnotation" aria-label="annotation3">❸</span>. <a href="#figure16-1" id="figureanchor16-1">Figure 16-1</a> shows the resulting plot: a simple line graph of the high temperatures for July 2021 in Sitka, Alaska.</p>
<figure>
<img src="Images/f16001.png" class="" alt="" width="649" height="362"/>
<figcaption><p><a id="figure16-1">Figure 16-1</a>: A line graph showing daily high temperatures for July 2021 in Sitka, Alaska</p></figcaption>
</figure>
<h3 id="h2-502703c16-0005">The datetime Module</h3>
<p class="BodyFirst">Let’s add dates to our graph to make it more useful. The first date from the weather data file is in the second row of the file:</p>
<pre><code>"USW00025333","SITKA AIRPORT, AK US","2021-07-01",,"61","53"</code></pre>
<p>The data will be read in as a string, so we need a way to convert the string <code>"2021-07-01"</code> to an object representing this date. We can construct <span epub:type="pagebreak" title="334" id="Page_334"/>an object representing July 1, 2021, using the <code>strptime()</code> method from the <code>datetime</code> module. Let’s see how <code>strptime()</code> works in a terminal session:</p>
<pre><code>&gt;&gt;&gt; <b>from datetime import datetime</b>
&gt;&gt;&gt; <b>first_date = datetime.strptime('2021-07-01', '%Y-%m-%d')</b>
&gt;&gt;&gt; <b>print(first_date)</b>
2021-07-01 00:00:00</code></pre>
<p>We first import the <code>datetime</code> class from the <code>datetime</code> module. Then we call the method <code>strptime()</code> with the string containing the date we want to process as its first argument. The second argument tells Python how the date is formatted. In this example, <code>'%Y-'</code> tells Python to look for a four-digit year before the first dash; <code>'%m-'</code> indicates a two-digit month before the second dash; and <code>'%d'</code> means the last part of the string is the day of the month, from 1 to 31.</p>
<p>The <code>strptime()</code> method can take a variety of arguments to determine how to interpret the date. <a href="#table16-1" id="tableanchor16-1">Table 16-1</a> shows some of these arguments.</p>
<figure>
<figcaption class="TableTitle"><p><a id="table16-1">Table 16-1</a>: Date and Time Formatting Arguments from the <code>datetime</code> Module</p></figcaption>
<table id="table-502703c16-0001" border="1">
<thead>
<tr>
<td><b>Argument</b></td>
<td><b>Meaning</b></td>
</tr>
</thead>
<tbody>
<tr>
<td><code>%A</code></td>
<td>Weekday name, such as Monday</td>
</tr>
<tr>
<td><code>%B</code></td>
<td>Month name, such as January</td>
</tr>
<tr>
<td><code>%m</code></td>
<td>Month, as a number (01 to 12)</td>
</tr>
<tr>
<td><code>%d</code></td>
<td>Day of the month, as a number (01 to 31)</td>
</tr>
<tr>
<td><code>%Y</code></td>
<td>Four-digit year, such as 2019</td>
</tr>
<tr>
<td><code>%y</code></td>
<td>Two-digit year, such as 19</td>
</tr>
<tr>
<td><code>%H</code></td>
<td>Hour, in 24-hour format (00 to 23)</td>
</tr>
<tr>
<td><code>%I</code></td>
<td>Hour, in 12-hour format (01 to 12)</td>
</tr>
<tr>
<td><code>%p</code></td>
<td>AM or PM</td>
</tr>
<tr>
<td><code>%M</code></td>
<td>Minutes (00 to 59)</td>
</tr>
<tr>
<td><code>%S</code></td>
<td>Seconds (00 to 61)</td>
</tr>
</tbody>
</table>
</figure>
<h3 id="h2-502703c16-0006">Plotting Dates</h3>
<p class="BodyFirst">We can improve our plot by extracting dates for the daily high temperature readings, and using these dates on the <em>x</em>-axis:</p>
<p class="CodeLabel"><b>sitka_highs.py</b></p>
<pre><code><span class="LiteralGray">from pathlib import Path</span>
<span class="LiteralGray">import csv</span>
from datetime import datetime

<span class="LiteralGray">import matplotlib.pyplot as plt</span>

<span class="LiteralGray">path = Path('weather_data/sitka_weather_07-2021_simple.csv')</span>
<span class="LiteralGray">lines = path.read_text().splitlines()</span>

<span epub:type="pagebreak" title="335" id="Page_335"/><span class="LiteralGray">reader = csv.reader(lines)</span>
<span class="LiteralGray">header_row = next(reader)</span>

# Extract dates and high temperatures.
<span class="CodeAnnotationHang" aria-label="annotation1">❶</span> dates, highs = [], []
<span class="LiteralGray">for row in reader:</span>
<span class="CodeAnnotationHang" aria-label="annotation2">❷</span>     current_date = datetime.strptime(row[2], '%Y-%m-%d')
<span class="LiteralGray">    high = int(row[4])</span>
    dates.append(current_date)
<span class="LiteralGray">    highs.append(high)</span>

<span class="LiteralGray"># Plot the high temperatures.</span>
<span class="LiteralGray">plt.style.use('seaborn')</span>
<span class="LiteralGray">fig, ax = plt.subplots()</span>
<span class="CodeAnnotationHang" aria-label="annotation3">❸</span> ax.plot(dates, highs, color='red')

<span class="LiteralGray"># Format plot.</span>
<span class="LiteralGray">ax.set_title("Daily High Temperatures, July 2021", fontsize=24)</span>
<span class="LiteralGray">ax.set_xlabel('', fontsize=16)</span>
<span class="CodeAnnotationHang" aria-label="annotation4">❹</span> fig.autofmt_xdate()
<span class="LiteralGray">ax.set_ylabel("Temperature (F)", fontsize=16)</span>
<span class="LiteralGray">ax.tick_params(labelsize=16)</span>

<span class="LiteralGray">plt.show()</span></code></pre>
<p>We create two empty lists to store the dates and high temperatures from the file <span class="CodeAnnotation" aria-label="annotation1">❶</span>. We then convert the data containing the date information (<code>row[2]</code>) to a <code>datetime</code> object <span class="CodeAnnotation" aria-label="annotation2">❷</span> and append it to <code>dates</code>. We pass the dates and the high temperature values to <code>plot()</code> <span class="CodeAnnotation" aria-label="annotation3">❸</span>. The call to <code>fig.autofmt_xdate()</code> <span class="CodeAnnotation" aria-label="annotation4">❹</span> draws the date labels diagonally to prevent them from overlapping. <a href="#figure16-2" id="figureanchor16-2">Figure 16-2</a> shows the improved graph.</p>
<figure>
<img src="Images/f16002.png" class="" alt="" width="646" height="357"/>
<figcaption><p><a id="figure16-2">Figure 16-2</a>: The graph is more meaningful, now that it has dates on the <em>x</em>-axis.</p></figcaption>
</figure>
<h3 id="h2-502703c16-0007"><span epub:type="pagebreak" title="336" id="Page_336"/>Plotting a Longer Timeframe</h3>
<p class="BodyFirst">With our graph set up, let’s include additional data to get a more complete picture of the weather in Sitka. Copy the file <em>sitka_weather_2021_simple.csv</em>, which contains a full year’s worth of weather data for Sitka, to the folder where you’re storing the data for this chapter’s programs.</p>
<p>Now we can generate a graph for the entire year’s weather:</p>
<p class="CodeLabel"><b>sitka_highs.py</b></p>
<pre><code><em class="LiteralGrayItalic">--snip--</em>
path = Path('weather_data/sitka_weather_2021_simple.csv')
<span class="LiteralGray">lines = path.read_text().splitlines()</span>
<em class="LiteralGrayItalic">--snip--</em>
<span class="LiteralGray"># Format plot.</span>
ax.set_title("Daily High Temperatures, 2021", fontsize=24)
<span class="LiteralGray">ax.set_xlabel('', fontsize=16)</span>
<em class="LiteralGrayItalic">--snip--</em></code></pre>
<p>We modify the filename to use the new data file <em>sitka_weather_2021_simple.csv</em>, and we update the title of our plot to reflect the change in its content. <a href="#figure16-3" id="figureanchor16-3">Figure 16-3</a> shows the resulting plot.</p>
<figure>
<img src="Images/f16003.png" class="" alt="" width="646" height="348"/>
<figcaption><p><a id="figure16-3">Figure 16-3</a>: A year’s worth of data</p></figcaption>
</figure>
<h3 id="h2-502703c16-0008">Plotting a Second Data Series</h3>
<p class="BodyFirst">We can make our graph even more useful by including the low temperatures. We need to extract the low temperatures from the data file and then add them to our graph, as shown here:</p>
<p class="CodeLabel"><b>sitka_highs_lows.py</b></p>
<pre><code><em class="LiteralGrayItalic">--snip--</em>
<span class="LiteralGray">reader = csv.reader(lines)</span>
<span class="LiteralGray">header_row = next(reader)</span>

# Extract dates, and high and low temperatures.
<span class="CodeAnnotationHang" aria-label="annotation1">❶</span> dates, highs, lows = [], [], []
<span class="LiteralGray">for row in reader:</span>
<span epub:type="pagebreak" title="337" id="Page_337"/><span class="LiteralGray">    current_date = datetime.strptime(row[2], '%Y-%m-%d')</span>
<span class="LiteralGray">    high = int(row[4])</span>
<span class="CodeAnnotationHang" aria-label="annotation2">❷</span>     low = int(row[5])
<span class="LiteralGray">    dates.append(current_date)</span>
<span class="LiteralGray">    highs.append(high)</span>
    lows.append(low)

# Plot the high and low temperatures.
<span class="LiteralGray">plt.style.use('seaborn')</span>
<span class="LiteralGray">fig, ax = plt.subplots()</span>
<span class="LiteralGray">ax.plot(dates, highs, color='red')</span>
<span class="CodeAnnotationHang" aria-label="annotation3">❸</span> ax.plot(dates, lows, color='blue')

<span class="LiteralGray"># Format plot.</span>
<span class="CodeAnnotationHang" aria-label="annotation4">❹</span> ax.set_title("Daily High and Low Temperatures, 2021", fontsize=24)
<em class="LiteralGrayItalic">--snip--</em></code></pre>
<p>We add the empty list <code>lows</code> to hold low temperatures <span class="CodeAnnotation" aria-label="annotation1">❶</span>, and then we extract and store the low temperature for each date from the sixth position in each row (<code>row[5]</code>) <span class="CodeAnnotation" aria-label="annotation2">❷</span>. We add a call to <code>plot()</code> for the low temperatures and color these values blue <span class="CodeAnnotation" aria-label="annotation3">❸</span>. Finally, we update the title <span class="CodeAnnotation" aria-label="annotation4">❹</span>. <a href="#figure16-4" id="figureanchor16-4">Figure 16-4</a> shows the resulting chart.</p>
<figure>
<img src="Images/f16004.png" class="" alt="" width="648" height="348"/>
<figcaption><p><a id="figure16-4">Figure 16-4</a>: Two data series on the same plot</p></figcaption>
</figure>
<h3 id="h2-502703c16-0009">Shading an Area in the Chart</h3>
<p class="BodyFirst">Having added two data series, we can now examine the range of temperatures for each day. Let’s add a finishing touch to the graph by using shading to show the range between each day’s high and low temperatures. To do so, we’ll use the <code>fill_between()</code> method, which takes a series of <em>x</em>-values and two series of <em>y</em>-values and fills the space between the two series of <em>y</em>-values:</p>
<p class="CodeLabel"><b>sitka_highs_lows.py</b></p>
<pre><code><em class="LiteralGrayItalic">--snip--</em>
<span class="LiteralGray"># Plot the high and low temperatures.</span>
<span class="LiteralGray">plt.style.use('seaborn')</span>
<span epub:type="pagebreak" title="338" id="Page_338"/><span class="LiteralGray">fig, ax = plt.subplots()</span>
<span class="CodeAnnotationHang" aria-label="annotation1">❶</span> ax.plot(dates, highs, color='red', alpha=0.5)
ax.plot(dates, lows, color='blue', alpha=0.5)
<span class="CodeAnnotationHang" aria-label="annotation2">❷</span> ax.fill_between(dates, highs, lows, facecolor='blue', alpha=0.1)
<em class="LiteralGrayItalic">--snip--</em></code></pre>
<p>The <code>alpha</code> argument controls a color’s transparency <span class="CodeAnnotation" aria-label="annotation1">❶</span>. An <code>alpha</code> value of 0 is completely transparent, and a value of 1 (the default) is completely opaque. By setting <code>alpha</code> to 0.5, we make the red and blue plot lines appear lighter.</p>
<p>We pass <code>fill_between()</code> the list <code>dates</code> for the <em>x</em>-values and then the two <em>y</em>-value series <code>highs</code> and <code>lows</code> <span class="CodeAnnotation" aria-label="annotation2">❷</span>. The <code>facecolor</code> argument determines the color of the shaded region; we give it a low <code>alpha</code> value of 0.1 so the filled region connects the two data series without distracting from the information they represent. <a href="#figure16-5" id="figureanchor16-5">Figure 16-5</a> shows the plot with the shaded region between the highs and lows.</p>
<figure>
<img src="Images/f16005.png" class="" alt="" width="646" height="346"/>
<figcaption><p><a id="figure16-5">Figure 16-5</a>: The region between the two datasets is shaded.</p></figcaption>
</figure>
<p>The shading helps make the range between the two datasets immediately apparent.</p>
<h3 id="h2-502703c16-0010">Error Checking</h3>
<p class="BodyFirst">We should be able to run the <em>sitka_highs_lows.py</em> code using data for any location. But some weather stations collect different data than others, and some occasionally malfunction and fail to collect some of the data they’re supposed to. Missing data can result in exceptions that crash our programs, unless we handle them properly.</p>
<p>For example, let’s see what happens when we attempt to generate a temperature plot for Death Valley, California. Copy the file <em>death_valley_2021_simple.csv</em> to the folder where you’re storing the data for this chapter’s programs.</p>
<p><span epub:type="pagebreak" title="339" id="Page_339"/>First, let’s run the code to see the headers that are included in this data file:</p>
<p class="CodeLabel"><b>death_valley_highs_lows.py</b></p>
<pre><code>from pathlib import Path
import csv

path = Path('weather_data/death_valley_2021_simple.csv')
lines = path.read_text().splitlines()

reader = csv.reader(lines)
header_row = next(reader)

for index, column_header in enumerate(header_row):
    print(index, column_header)</code></pre>
<p>Here’s the output:</p>
<pre><code>0 STATION
1 NAME
2 DATE
3 TMAX
4 TMIN
5 TOBS</code></pre>
<p>The date is in the same position, at index 2. But the high and low temperatures are at indexes 3 and 4, so we’ll need to change the indexes in our code to reflect these new positions. Instead of including an average temperature reading for the day, this station includes <code>TOBS</code>, a reading for a specific observation time.</p>
<p>Change <em>sitka_highs_lows.py</em> to generate a graph for Death Valley using the indexes we just noted, and see what happens:</p>
<p class="CodeLabel"><b>death_valley_highs_lows.py</b></p>
<pre><code><em class="LiteralGrayItalic">--snip--</em>
path = Path('weather_data/death_valley_2021_simple.csv')
<span class="LiteralGray">lines = path.read_text().splitlines()</span>
<span class="LiteralGray">    </span><em class="LiteralGrayItalic">--snip--</em>
<span class="LiteralGray"># Extract dates, and high and low temperatures.</span>
<span class="LiteralGray">dates, highs, lows = [], [], []</span>
<span class="LiteralGray">for row in reader:</span>
<span class="LiteralGray">    current_date = datetime.strptime(row[2], '%Y-%m-%d')</span>
    high = int(row[3])
    low = int(row[4])
<span class="LiteralGray">    dates.append(current_date)</span>
<em class="LiteralGrayItalic">--snip--</em></code></pre>
<p>We update the program to read from the Death Valley data file, and we change the indexes to correspond to this file’s <code>TMAX</code> and <code>TMIN</code> positions.</p>
<p>When we run the program, we get an error:</p>
<pre><code>Traceback (most recent call last):
  File "death_valley_highs_lows.py", line 17, in &lt;module&gt;
    high = int(row[3])
<span class="CodeAnnotationHang" aria-label="annotation1">❶</span> ValueError: invalid literal for int() with base 10: ''</code></pre>
<p><span epub:type="pagebreak" title="340" id="Page_340"/>The traceback tells us that Python can’t process the high temperature for one of the dates because it can’t turn an empty string (<code>''</code>) into an integer <span class="CodeAnnotation" aria-label="annotation1">❶</span>. Rather than looking through the data to find out which reading is missing, we’ll just handle cases of missing data directly.</p>
<p>We’ll run error-checking code when the values are being read from the CSV file to handle exceptions that might arise. Here’s how to do this:</p>
<p class="CodeLabel"><b>death_valley_highs_lows.py</b></p>
<pre><code><em class="LiteralGrayItalic">--snip--</em>
<span class="LiteralGray">for row in reader:</span>
<span class="LiteralGray">    current_date = datetime.strptime(row[2], '%Y-%m-%d')</span>
<span class="CodeAnnotationHang" aria-label="annotation1">❶</span>     try:
<span class="LiteralGray">        high = int(row[3])</span>
<span class="LiteralGray">        low = int(row[4])</span>
    except ValueError:
<span class="CodeAnnotationHang" aria-label="annotation2">❷</span><span class="LiteralGray">         </span>print(f"Missing data for {current_date}")
<span class="CodeAnnotationHang" aria-label="annotation3">❸</span>     else:
<span class="LiteralGray">        dates.append(current_date)</span>
<span class="LiteralGray">        highs.append(high)</span>
<span class="LiteralGray">        lows.append(low)</span>

<span class="LiteralGray"># Plot the high and low temperatures.</span>
<em class="LiteralGrayItalic">--snip--</em>

<span class="LiteralGray"># Format plot.</span>
<span class="CodeAnnotationHang" aria-label="annotation4">❹</span> title = "Daily High and Low Temperatures, 2021\nDeath Valley, CA"
ax.set_title(title, fontsize=20)
<span class="LiteralGray">ax.set_xlabel('', fontsize=16)</span>
<em class="LiteralGrayItalic">--snip--</em></code></pre>
<p>Each time we examine a row, we try to extract the date and the high and low temperature <span class="CodeAnnotation" aria-label="annotation1">❶</span>. If any data is missing, Python will raise a <code>ValueError</code> and we handle it by printing an error message that includes the date of the missing data <span class="CodeAnnotation" aria-label="annotation2">❷</span>. After printing the error, the loop will continue processing the next row. If all data for a date is retrieved without error, the <code>else</code> block will run and the data will be appended to the appropriate lists <span class="CodeAnnotation" aria-label="annotation3">❸</span>. Because we’re plotting information for a new location, we update the title to include the location on the plot, and we use a smaller font size to accommodate the longer title <span class="CodeAnnotation" aria-label="annotation4">❹</span>.</p>
<p>When you run <em>death_valley_highs_lows.py</em> now, you’ll see that only one date had missing data:</p>
<pre><code>Missing data for 2021-05-04 00:00:00</code></pre>
<p>Because the error is handled appropriately, our code is able to generate a plot, which skips over the missing data. <a href="#figure16-6" id="figureanchor16-6">Figure 16-6</a> shows the resulting plot.</p>
<p>Comparing this graph to the Sitka graph, we can see that Death Valley is warmer overall than southeast Alaska, as we expect. Also, the range of temperatures each day is greater in the desert. The height of the shaded region makes this clear.</p>
<span epub:type="pagebreak" title="341" id="Page_341"/><figure>
<img src="Images/f16006.png" class="" alt="" width="654" height="350"/>
<figcaption><p><a id="figure16-6">Figure 16-6</a>: Daily high and low temperatures for Death Valley</p></figcaption>
</figure>
<p>Many datasets you work with will have missing, improperly formatted, or incorrect data. You can use the tools you learned in the first half of this book to handle these situations. Here we used a <code>try</code>-<code>except</code>-<code>else</code> block to handle missing data. Sometimes you’ll use <code>continue</code> to skip over some data, or use <code>remove()</code> or <code>del</code> to eliminate some data after it’s been extracted. Use any approach that works, as long as the result is a meaningful, accurate visualization.</p>
<h3 id="h2-502703c16-0011">Downloading Your Own Data</h3>
<p class="BodyFirst">To download your own weather data, follow these steps:</p>
<ol class="decimal">
<li value="1">Visit the NOAA Climate Data Online site at <a href="https://www.ncdc.noaa.gov/cdo-web" class="LinkURL">https://www.ncdc.noaa.gov/cdo-web</a>. In the Discover Data By section, click <b>Search Tool</b>. In the Select a Dataset box, choose <b>Daily Summaries</b>.</li>
<li value="2">Select a date range, and in the Search For section, choose <b>ZIP Codes</b>. Enter the ZIP code you’re interested in and click <b>Search</b>.</li>
<li value="3">On the next page, you’ll see a map and some information about the area you’re focusing on. Below the location name, click <b>View Full Details</b>, or click the map and then click <b>Full Details</b>.</li>
<li value="4">Scroll down and click <b>Station List</b> to see the weather stations that are available in this area. Click one of the station names and then click <b>Add to Cart</b>. This data is free, even though the site uses a shopping cart icon. In the upper-right corner, click the cart.</li>
<li value="5">In Select the Output Format, choose <b>Custom GHCN-Daily CSV</b>. Make sure the date range is correct and click <b>Continue</b>.</li>
<li value="6"><span epub:type="pagebreak" title="342" id="Page_342"/>On the next page, you can select the kinds of data you want. You can download one kind of data (for example, focusing on air temperature) or you can download all the data available from this station. Make your choices and then click <b>Continue</b>.</li>
<li value="7">On the last page, you’ll see a summary of your order. Enter your email address and click <b>Submit Order</b>. You’ll receive a confirmation that your order was received, and in a few minutes, you should receive another email with a link to download your data.</li>
</ol>
<p>The data you download should be structured just like the data we worked with in this section. It might have different headers than those you saw in this section, but if you follow the same steps we used here, you should be able to generate visualizations of the data you’re interested in.</p>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="box">
<h2>Try It Yourself</h2>
<p class="BoxBodyCustom"><span id="h2-502703c16-12" class="BoxNumber">16-1.	Sitka Rainfall:</span> Sitka is located in a temperate rainforest, so it gets a fair amount of rainfall. In the data file <em>sitka_weather_2021_full.csv</em> is a header called <code>PRCP</code>, which represents daily rainfall amounts. Make a visualization focusing on the data in this column. You can repeat the exercise for Death Valley if you’re curious how little rainfall occurs in a desert.</p>
<p class="BoxBodyCustom"><span id="h2-502703c16-13" class="BoxNumber">16-2.	Sitka–Death Valley Comparison:</span> The temperature scales on the Sitka and Death Valley graphs reflect the different data ranges. To accurately compare the temperature range in Sitka to that of Death Valley, you need identical scales on the <em>y</em>-axis. Change the settings for the <em>y</em>-axis on one or both of the charts in Figures 16-5 and 16-6. Then make a direct comparison between temperature ranges in Sitka and Death Valley (or any two places you want to compare).</p>
<p class="BoxBodyCustom"><span id="h2-502703c16-14" class="BoxNumber">16-3.	San Francisco:</span> Are temperatures in San Francisco more like temperatures in Sitka or temperatures in Death Valley? Download some data for San Francisco, and generate a high-low temperature plot for San Francisco to make a comparison.</p>
<p class="BoxBodyCustom"><span id="h2-502703c16-15" class="BoxNumber">16-4.	Automatic Indexes:</span> In this section, we hardcoded the indexes corresponding to the <code>TMIN</code> and <code>TMAX</code> columns. Use the header row to determine the indexes for these values, so your program can work for Sitka or Death Valley. Use the station name to automatically generate an appropriate title for your graph as well.</p>
<p class="BoxBodyCustom"><span id="h2-502703c16-16" class="BoxNumber">16-5.	Explore:</span> Generate a few more visualizations that examine any other weather aspect you’re interested in for any locations you’re curious about.</p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<h2 id="h1-502703c16-0002">Mapping Global Datasets: GeoJSON Format</h2>
<p class="BodyFirst">In this section, you’ll download a dataset representing all the earthquakes that have occurred in the world during the previous month. Then you’ll make a map showing the location of these earthquakes and how significant <span epub:type="pagebreak" title="343" id="Page_343"/>each one was. Because the data is stored in the GeoJSON format, we’ll work with it using the <code>json</code> module. Using Plotly’s <code>scatter_geo()</code> plot, you’ll create visualizations that clearly show the global distribution of earthquakes.</p>
<h3 id="h2-502703c16-0012">Downloading Earthquake Data</h3>
<p class="BodyFirst">Make a folder called <em>eq_data</em> inside the folder where you’re saving this chapter’s programs. Copy the file <em>eq_1_day_m1.geojson</em> into this new folder. Earthquakes are categorized by their magnitude on the Richter scale. This file includes data for all earthquakes with a magnitude M1 or greater that took place in the last 24 hours (at the time of this writing). This data comes from one of the United States Geological Survey’s earthquake data feeds, at <a href="https://earthquake.usgs.gov/earthquakes/feed" class="LinkURL">https://earthquake.usgs.gov/earthquakes/feed</a>.</p>
<h3 id="h2-502703c16-0013">Examining GeoJSON Data</h3>
<p class="BodyFirst">When you open <em>eq_1_day_m1.geojson</em>, you’ll see that it’s very dense and hard to read:</p>
<pre><code>{"type":"FeatureCollection","metadata":{"generated":1649052296000,...
{"type":"Feature","properties":{"mag":1.6,"place":"63 km SE of Ped...
{"type":"Feature","properties":{"mag":2.2,"place":"27 km SSE of Ca...
{"type":"Feature","properties":{"mag":3.7,"place":"102 km SSE of S...
{"type":"Feature","properties":{"mag":2.92000008,"place":"49 km SE...
{"type":"Feature","properties":{"mag":1.4,"place":"44 km NE of Sus...
<var>--snip--</var></code></pre>
<p>This file is formatted more for machines than humans. But we can see that the file contains some dictionaries, as well as information that we’re interested in, such as earthquake magnitudes and locations.</p>
<p>The <code>json</code> module provides a variety of tools for exploring and working with JSON data. Some of these tools will help us reformat the file so we can look at the raw data more easily before we work with it programmatically.</p>
<p>Let’s start by loading the data and displaying it in a format that’s easier to read. This is a long data file, so instead of printing it, we’ll rewrite the data to a new file. Then we can open that file and scroll back and forth through the data more easily:</p>
<p class="CodeLabel"><b>eq_explore_data.py</b></p>
<pre><code>from pathlib import Path
import json

# Read data as a string and convert to a Python object.
path = Path('eq_data/eq_data_1_day_m1.geojson')
contents = path.read_text()
<span class="CodeAnnotationHang" aria-label="annotation1">❶</span> all_eq_data = json.loads(contents)

# Create a more readable version of the data file.
<span class="CodeAnnotationHang" aria-label="annotation2">❷</span> path = Path('eq_data/readable_eq_data.geojson')
<span class="CodeAnnotationHang" aria-label="annotation3">❸</span> readable_contents = json.dumps(all_eq_data, indent=4)
path.write_text(readable_contents)</code></pre>
<p><span epub:type="pagebreak" title="344" id="Page_344"/>We read the data file as a string, and use <code>json.loads()</code> to convert the string representation of the file to a Python object <span class="CodeAnnotation" aria-label="annotation1">❶</span>. This is the same approach we used in <span class="xref" itemid="xref_target_Chapter 10">Chapter 10</span>. In this case, the entire dataset is converted to a single dictionary, which we assign to <code>all_eq_data</code>. We then define a new <code>path</code> where we can write this same data in a more readable format <span class="CodeAnnotation" aria-label="annotation2">❷</span>. The <code>json.dumps()</code> function that you saw in <span class="xref" itemid="xref_target_Chapter 10">Chapter 10</span> can take an optional <code>indent</code> argument <span class="CodeAnnotation" aria-label="annotation3">❸</span>, which tells it how much to indent nested elements in the data structure.</p>
<p>When you look in your <em>eq_data</em> directory and open the file <em>readable_eq_data.json</em>, here’s the first part of what you’ll see:</p>
<p class="CodeLabel"><b>readable_eq_data.json</b></p>
<pre><code>{
    "type": "FeatureCollection",
<span class="CodeAnnotationHang" aria-label="annotation1">❶</span>     "metadata": {
        "generated": 1649052296000,
        "url": "https://earthquake.usgs.gov/earthquakes/.../1.0_day.geojson",
        "title": "USGS Magnitude 1.0+ Earthquakes, Past Day",
        "status": 200,
        "api": "1.10.3",
        "count": 160
    },
<span class="CodeAnnotationHang" aria-label="annotation2">❷</span>     "features": [
    <em class="LiteralGrayItalic">--snip--</em></code></pre>
<p>The first part of the file includes a section with the key <code>"metadata"</code><span class="CodeAnnotation" aria-label="annotation1">❶</span>. This tells us when the data file was generated and where we can find the data online. It also gives us a human-readable title and the number of earthquakes included in this file. In this 24-hour period, <code>160</code> earthquakes were recorded.</p>
<p>This GeoJSON file has a structure that’s helpful for location-based data. The information is stored in a list associated with the key <code>"features"</code> <span class="CodeAnnotation" aria-label="annotation2">❷</span>. Because this file contains earthquake data, the data is in list form where every item in the list corresponds to a single earthquake. This structure might look confusing, but it’s quite powerful. It allows geologists to store as much information as they need to in a dictionary about each earthquake, and then stuff all those dictionaries into one big list.</p>
<p>Let’s look at a dictionary representing a single earthquake:</p>
<p class="CodeLabel"><b>readable_eq_data.json</b></p>
<pre><code>    <em class="LiteralGrayItalic">--snip--</em>
        {
            "type": "Feature",
<span class="CodeAnnotationHang" aria-label="annotation1">❶</span>             "properties": {
                "mag": 1.6,
<var>                --snip--</var>
<span class="CodeAnnotationHang" aria-label="annotation2">❷</span>                 "title": "M 1.6 - 27 km NNW of Susitna, Alaska"
            },
<span class="CodeAnnotationHang" aria-label="annotation3">❸</span>             "geometry": {
                "type": "Point",
                "coordinates": [
<span class="CodeAnnotationHang" aria-label="annotation4">❹</span>                     -150.7585,
<span class="CodeAnnotationHang" aria-label="annotation5">❺</span>                     61.7591,
                    56.3
<span epub:type="pagebreak" title="345" id="Page_345"/>                ]
            },
            "id": "ak0224bju1jx"
        },</code></pre>
<p>The key <code>"properties"</code> contains a lot of information about each earthquake <span class="CodeAnnotation" aria-label="annotation1">❶</span>. We’re mainly interested in the magnitude of each earthquake, associated with the key <code>"mag"</code>. We’re also interested in the <code>"title"</code> of each event, which provides a nice summary of its magnitude and location <span class="CodeAnnotation" aria-label="annotation2">❷</span>.</p>
<p>The key <code>"geometry"</code> helps us understand where the earthquake occurred <span class="CodeAnnotation" aria-label="annotation3">❸</span>. We’ll need this information to map each event. We can find the longitude <span class="CodeAnnotation" aria-label="annotation4">❹</span> and the latitude <span class="CodeAnnotation" aria-label="annotation5">❺</span> for each earthquake in a list associated with the key <code>"coordinates"</code>.</p>
<p>This file contains way more nesting than we’d use in the code we write, so if it looks confusing, don’t worry: Python will handle most of the complexity. We’ll only be working with one or two nesting levels at a time. We’ll start by pulling out a dictionary for each earthquake that was recorded in the 24-hour time period.</p>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="note">
<h2><span class="NoteHead">Note</span></h2>
<p>	When we talk about locations, we often say the location’s latitude first, followed by its longitude. This convention probably arose because humans discovered latitude long before we developed the concept of longitude. However, many geospatial frameworks list the longitude first and then the latitude, because this corresponds to the (<em>x</em>,<em> y</em>) convention we use in mathematical representations. The GeoJSON format follows the (longitude, latitude) convention. If you use a different framework, it’s important to learn what convention that framework follows.</p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<h3 id="h2-502703c16-0014">Making a List of All Earthquakes</h3>
<p class="BodyFirst">First, we’ll make a list that contains all the information about every earthquake that occurred.</p>
<p class="CodeLabel"><b>eq_explore_data.py</b></p>
<pre><code><span class="LiteralGray">from pathlib import Path</span>
<span class="LiteralGray">import json</span>

<span class="LiteralGray"># Read data as a string and convert to a Python object.</span>
<span class="LiteralGray">path = Path('eq_data/eq_data_1_day_m1.geojson')</span>
<span class="LiteralGray">contents = path.read_text()</span>
<span class="LiteralGray">all_eq_data = json.loads(contents)</span>

# Examine all earthquakes in the dataset.
all_eq_dicts = all_eq_data['features']
print(len(all_eq_dicts))</code></pre>
<p>We take the data associated with the key <code>'features'</code> in the <code>all_eq_data</code> dictionary, and assign it to <code>all_eq_dicts</code>. We know this file contains records of 160 earthquakes, and the output verifies that we’ve captured all the earthquakes in the file:</p>
<pre><code>160</code></pre>
<p><span epub:type="pagebreak" title="346" id="Page_346"/>Notice how short this code is. The neatly formatted file <em>readable_eq_data.json</em> has over 6,000 lines. But in just a few lines, we can read through all that data and store it in a Python list. Next, we’ll pull the magnitudes from each earthquake.</p>
<h3 id="h2-502703c16-0015">Extracting Magnitudes</h3>
<p class="BodyFirst">We can loop through the list containing data about each earthquake, and extract any information we want. Let’s pull out the magnitude of each earthquake:</p>
<p class="CodeLabel"><b>eq_explore_data.py</b></p>
<pre><code><em class="LiteralGrayItalic">--snip--</em>
<span class="LiteralGray">all_eq_dicts = all_eq_data['features']</span>

<span class="CodeAnnotationHang" aria-label="annotation1">❶</span> mags = []
for eq_dict in all_eq_dicts:
<span class="CodeAnnotationHang" aria-label="annotation2">❷</span>     mag = eq_dict['properties']['mag']
    mags.append(mag)

print(mags[:10])</code></pre>
<p>We make an empty list to store the magnitudes, and then loop through the list <code>all_eq_dicts</code> <span class="CodeAnnotation" aria-label="annotation1">❶</span>. Inside this loop, each earthquake is represented by the dictionary <code>eq_dict</code>. Each earthquake’s magnitude is stored in the <code>'properties'</code> section of this dictionary, under the key <code>'mag'</code> <span class="CodeAnnotation" aria-label="annotation2">❷</span>. We store each magnitude in the variable <code>mag</code> and then append it to the list <code>mags</code>.</p>
<p>We print the first <code>10</code> magnitudes, so we can see whether we’re getting the correct data:</p>
<pre><code>[1.6, 1.6, 2.2, 3.7, 2.92000008, 1.4, 4.6, 4.5, 1.9, 1.8]</code></pre>
<p>Next, we’ll pull the location data for each earthquake, and then we can make a map of the earthquakes.</p>
<h3 id="h2-502703c16-0016">Extracting Location Data</h3>
<p class="BodyFirst">The location data for each earthquake is stored under the key <code>"geometry"</code>. Inside the geometry dictionary is a <code>"coordinates"</code> key, and the first two values in this list are the longitude and latitude. Here’s how we’ll pull this data:</p>
<p class="CodeLabel"><b>eq_explore_data.py</b></p>
<pre><code><em class="LiteralGrayItalic">--snip--</em>
<span class="LiteralGray">all_eq_dicts = all_eq_data['features']</span>

mags, lons, lats = [], [], []
<span class="LiteralGray">for eq_dict in all_eq_dicts:</span>
<span class="LiteralGray">    mag = eq_dict['properties']['mag']</span>
<span class="CodeAnnotationHang" aria-label="annotation1">❶</span>     lon = eq_dict['geometry']['coordinates'][0]
    lat = eq_dict['geometry']['coordinates'][1]
<span class="LiteralGray">    mags.append(mag)</span>
    lons.append(lon)
<span epub:type="pagebreak" title="347" id="Page_347"/>    lats.append(lat)

<span class="LiteralGray">print(mags[:10])</span>
print(lons[:5])
print(lats[:5])</code></pre>
<p>We make empty lists for the longitudes and latitudes. The code <code>eq_dict['geometry']</code> accesses the dictionary representing the geometry element of the earthquake <span class="CodeAnnotation" aria-label="annotation1">❶</span>. The second key, <code>'coordinates'</code>, pulls the list of values associated with <code>'coordinates'</code>. Finally, the <code>0</code> index asks for the first value in the list of coordinates, which corresponds to an earthquake’s longitude.</p>
<p>When we print the first <code>5</code> longitudes and latitudes, the output shows that we’re pulling the correct data:</p>
<pre><code><span class="LiteralGray">[1.6, 1.6, 2.2, 3.7, 2.92000008, 1.4, 4.6, 4.5, 1.9, 1.8]</span>
[-150.7585, -153.4716, -148.7531, -159.6267, -155.248336791992]
[61.7591, 59.3152, 63.1633, 54.5612, 18.7551670074463]</code></pre>
<p>With this data, we can move on to mapping each earthquake.</p>
<h3 id="h2-502703c16-0017">Building a World Map</h3>
<p class="BodyFirst">Using the information we’ve pulled so far, we can build a simple world map. Although it won’t look presentable yet, we want to make sure the information is displayed correctly before focusing on style and presentation issues. Here’s the initial map:</p>
<p class="CodeLabel"><b>eq_world_map.py</b></p>
<pre><code><span class="LiteralGray">from pathlib import Path</span>
<span class="LiteralGray">import json</span>

import plotly.express as px

<em class="LiteralGrayItalic">--snip--</em>
<span class="LiteralGray">for eq_dict in all_eq_dicts:</span>
<span class="LiteralGray">    </span><em class="LiteralGrayItalic">--snip--</em>

title = 'Global Earthquakes'
<span class="CodeAnnotationHang" aria-label="annotation1">❶</span> fig = px.scatter_geo(lat=lats, lon=lons, title=title)
fig.show()</code></pre>
<p>We import <code>plotly.express</code> with the alias <code>px</code>, just as we did in <span class="xref" itemid="xref_target_Chapter 15">Chapter 15</span>. The <code>scatter_geo()</code> function <span class="CodeAnnotation" aria-label="annotation1">❶</span> allows you to overlay a scatterplot of geographic data on a map. In the simplest use of this chart type, you only need to provide a list of latitudes and a list of longitudes. We pass the list <code>lats</code> to the <code>lat</code> argument, and <code>lons</code> to the <code>lon</code> argument.</p>
<p>When you run this file, you should see a map that looks like the one in <a href="#figure16-7" id="figureanchor16-7">Figure 16-7</a>. This again shows the power of the Plotly Express library; in just three lines of code, we have a map of global earthquake activity.</p>
<span epub:type="pagebreak" title="348" id="Page_348"/><figure>
<img src="Images/f16007.png" class="keyline" alt="" width="694" height="429"/>
<figcaption><p><a id="figure16-7">Figure 16-7</a>: A simple map showing where all the earthquakes in the last 24 hours occurred</p></figcaption>
</figure>
<p>Now that we know the information in our dataset is being plotted correctly, we can make a few changes to make the map more meaningful and easier to read.</p>
<h3 id="h2-502703c16-0018">Representing Magnitudes</h3>
<p class="BodyFirst">A map of earthquake activity should show the magnitude of each earthquake. We can also include more data, now that we know the data is being plotted correctly.</p>
<pre><code><em class="LiteralGrayItalic">--snip--</em>
<span class="LiteralGray"># Read data as a string and convert to a Python object.</span>
path = Path('eq_data/eq_data_30_day_m1.geojson')
<span class="LiteralGray">contents = path.read_text()</span>
<em class="LiteralGrayItalic">--snip--</em>

<span class="LiteralGray">title = 'Global Earthquakes'</span>
fig = px.scatter_geo(lat=lats, lon=lons, size=mags, title=title)
<span class="LiteralGray">fig.show()</span></code></pre>
<p>We load the file <em>eq_data_30_day_m1.geojson</em>, to include a full 30 days’ worth of earthquake activity. We also use the size argument in the <code>px.scatter_geo()</code> call, which specifies how the points on the map will be sized. We pass the list <code>mags</code> to <code>size</code>, so earthquakes with a higher magnitude will show up as larger points on the map.</p>
<p>The resulting map is shown in <a href="#figure16-8" id="figureanchor16-8">Figure 16-8</a>. Earthquakes usually occur near tectonic plate boundaries, and the longer period of earthquake activity included in this map reveals the exact locations of these boundaries.</p>
<span epub:type="pagebreak" title="349" id="Page_349"/><figure>
<img src="Images/f16008.png" class="keyline" alt="" width="694" height="429"/>
<figcaption><p><a id="figure16-8">Figure 16-8</a>: The map now shows the magnitude of all earthquakes in the last 30 days.</p></figcaption>
</figure>
<p>This map is better, but it’s still difficult to pick out which points represent the most significant earthquakes. We can improve this further by using color to represent magnitudes as well.</p>
<h3 id="h2-502703c16-0019">Customizing Marker Colors</h3>
<p class="BodyFirst">We can use Plotly’s color scales to customize each marker’s color, according to the severity of the corresponding earthquake. We’ll also use a different projection for the base map.</p>
<p class="CodeLabel"><b>eq_world_map.py</b></p>
<pre><code><em class="LiteralGrayItalic">--snip--</em>
fig = px.scatter_geo(lat=lats, lon=lons, size=mags, title=title,
<span class="CodeAnnotationHang" aria-label="annotation1">❶</span>         color=mags,
<span class="CodeAnnotationHang" aria-label="annotation2">❷</span>         color_continuous_scale='Viridis',
<span class="CodeAnnotationHang" aria-label="annotation3">❸</span>         labels={'color':'Magnitude'},
<span class="CodeAnnotationHang" aria-label="annotation4">❹</span>         projection='natural earth',
    )
<span class="LiteralGray">fig.show()</span></code></pre>
<p>All the significant changes here occur in the <code>px.scatter_geo()</code> function call. The <code>color</code> argument tells Plotly what values it should use to determine where each marker falls on the color scale <span class="CodeAnnotation" aria-label="annotation1">❶</span>. We use the <code>mags</code> list to determine the color for each point, just as we did with the <code>size</code> argument.</p>
<p>The <code>color_continuous_scale</code> argument tells Plotly which color scale to use <span class="CodeAnnotation" aria-label="annotation2">❷</span>. <em>Viridis</em> is a color scale that ranges from dark blue to bright yellow, and it works well for this dataset. By default, the color scale on the right of the map is labeled <em>color</em>; this is not representative of what the colors actually mean. The <code>labels</code> argument, shown in <span class="xref" itemid="xref_target_Chapter 15">Chapter 15</span>, takes a dictionary as a value <span class="CodeAnnotation" aria-label="annotation3">❸</span>. We only need to set one custom label on this chart, making sure the color scale is labeled <em>Magnitude</em> instead of <em>color</em>.</p>
<p><span epub:type="pagebreak" title="350" id="Page_350"/>We add one more argument, to modify the base map over which the earthquakes are plotted. The <code>projection</code> argument accepts a number of common map projections <span class="CodeAnnotation" aria-label="annotation4">❹</span>. Here we use the <code>'natural earth'</code> projection, which rounds the ends of the map. Also, note the trailing comma after this last argument. When a function call has a long list of arguments spanning multiple lines like this, it’s common practice to add a trailing comma so you’re always ready to add another argument on the next line.</p>
<p>When you run the program now, you’ll see a much nicer-looking map. In <a href="#figure16-9" id="figureanchor16-9">Figure 16-9</a>, the color scale shows the severity of individual earthquakes; the most severe earthquakes stand out as light-yellow points, in contrast to many darker points. You can also tell which regions of the world have more significant earthquake activity.</p>
<figure>
<img src="Images/f16009.png" class="keyline" alt="" width="638" height="395"/>
<figcaption><p><a id="figure16-9">Figure 16-9</a>: In 30 days’ worth of earthquakes, color and size are used to represent the magnitude of each earthquake.</p></figcaption>
</figure>
<h3 id="h2-502703c16-0020">Other Color Scales</h3>
<p class="BodyFirst">You can choose from a number of other color scales. To see the available color scales, enter the following two lines in a Python terminal session:</p>
<pre><code>&gt;&gt;&gt; <b>import plotly.express as px</b>
&gt;&gt;&gt; <b>px.colors.named_colorscales()</b>
['aggrnyl', 'agsunset', 'blackbody', ..., 'mygbm']</code></pre>
<p>Feel free to try out these color scales in the earthquake map, or with any dataset where continuously varying colors can help show patterns in the data.</p>
<h3 id="h2-502703c16-0021">Adding Hover Text</h3>
<p class="BodyFirst">To finish this map, we’ll add some informative text that appears when you hover over the marker representing an earthquake. In addition to showing the longitude and latitude, which appear by default, we’ll show the magnitude and provide a description of the approximate location as well.</p>
<p><span epub:type="pagebreak" title="351" id="Page_351"/>To make this change, we need to pull a little more data from the file:</p>
<p class="CodeLabel"><b>eq_world_map.py</b></p>
<pre><code><em class="LiteralGrayItalic">--snip--</em>
<span class="CodeAnnotationHang" aria-label="annotation1">❶</span> mags, lons, lats, eq_titles = [], [], [], []
<span class="LiteralGray">    mag = eq_dict['properties']['mag']</span>
<span class="LiteralGray">    lon = eq_dict['geometry']['coordinates'][0]</span>
<span class="LiteralGray">    lat = eq_dict['geometry']['coordinates'][1]</span>
<span class="CodeAnnotationHang" aria-label="annotation2">❷</span>     eq_title = eq_dict['properties']['title']
<span class="LiteralGray">    mags.append(mag)</span>
<span class="LiteralGray">    lons.append(lon)</span>
<span class="LiteralGray">    lats.append(lat)</span>
    eq_titles.append(eq_title)

<span class="LiteralGray">title = 'Global Earthquakes'</span>
<span class="LiteralGray">fig = px.scatter_geo(lat=lats, lon=lons, size=mags, title=title,</span>
<span class="LiteralGray">        </span><em class="LiteralGrayItalic">--snip--</em>
<span class="LiteralGray">        projection='natural earth',</span>
<span class="CodeAnnotationHang" aria-label="annotation3">❸</span>         hover_name=eq_titles,
<span class="LiteralGray">    )</span>
<span class="LiteralGray">fig.show()</span></code></pre>
<p>We first make a list called <code>eq_titles</code> to store the title of each earthquake <span class="CodeAnnotation" aria-label="annotation1">❶</span>. The <code>'title'</code> section of the data contains a descriptive name of the magnitude and location of each earthquake, in addition to its longitude and latitude. We pull this information and assign it to the variable <code>eq_title</code> <span class="CodeAnnotation" aria-label="annotation2">❷</span>, and then append it to the list <code>eq_titles</code>.</p>
<p>In the <code>px.scatter_geo()</code> call, we pass <code>eq_titles</code> to the <code>hover_name</code> argument <span class="CodeAnnotation" aria-label="annotation3">❸</span>. Plotly will now add the information from the title of each earthquake to the hover text on each point. When you run this program, you should be able to hover over any marker, see a description of where that earthquake took place, and read its exact magnitude. An example of this information is shown in <a href="#figure16-10" id="figureanchor16-10">Figure 16-10</a>.</p>
<figure>
<img src="Images/f16010.png" class="keyline" alt="" width="579" height="340"/>
<figcaption><p><a id="figure16-10">Figure 16-10</a>: The hover text now includes a summary of each earthquake.</p></figcaption>
</figure>
<p>This is impressive! In less than 30 lines of code, we’ve created a visually appealing and meaningful map of global earthquake activity that also <span epub:type="pagebreak" title="352" id="Page_352"/>illustrates the geological structure of the planet. Plotly offers a wide range of ways you can customize the appearance and behavior of your visualizations. Using Plotly’s many options, you can make charts and maps that show exactly what you want them to.</p>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="box">
<h2>Try It Yourself</h2>
<p class="BoxBodyCustom"><span id="h2-502703c16-27" class="BoxNumber">16-6.	Refactoring:</span> The loop that pulls data from <code>all_eq_dicts</code> uses variables for the magnitude, longitude, latitude, and title of each earthquake before appending these values to their appropriate lists. This approach was chosen for clarity in how to pull data from a GeoJSON file, but it’s not necessary in your code. Instead of using these temporary variables, pull each value from <code>eq_dict</code> and append it to the appropriate list in one line. Doing so should shorten the body of this loop to just four lines.</p>
<p class="BoxBodyCustom"><span id="h2-502703c16-28" class="BoxNumber">16-7.	Automated Title:</span> In this section, we used the generic title <em>Global Earthquakes</em>. Instead, you can use the title for the dataset in the metadata part of the GeoJSON file. Pull this value and assign it to the variable <code>title</code>.</p>
<p class="BoxBodyCustom"><span id="h2-502703c16-29" class="BoxNumber">16-8.	Recent Earthquakes:</span> You can find online data files containing information about the most recent earthquakes over 1-hour, 1-day, 7-day, and 30-day periods. Go to <a href="https://earthquake.usgs.gov/earthquakes/feed/v1.0/geojson.php" class="LinkURL">https://earthquake.usgs.gov/earthquakes/feed/v1.0/geojson.php</a> and you’ll see a list of links to datasets for various time periods, focusing on earthquakes of different magnitudes. Download one of these datasets and create a visualization of the most recent earthquake activity.</p>
<p class="BoxBodyCustom"><span id="h2-502703c16-30" class="BoxNumber">16-9.	World Fires: </span>In the resources for this chapter, you’ll find a file called <em>world_fires_1_day.csv</em>. This file contains information about fires burning in different locations around the globe, including the latitude, longitude, and brightness of each fire. Using the data-processing work from the first part of this chapter and the mapping work from this section, make a map that shows which parts of the world are affected by fires.</p>
<p class="BoxBody">You can download more recent versions of this data at <a href="https://earthdata.nasa.gov/earth-observation-data/near-real-time/firms/active-fire-data" class="LinkURL">https://earthdata.nasa.gov/earth-observation-data/near-real-time/firms/active-fire-data</a>. You can find links to the data in CSV format in the <em>SHP, KML, and TXT Files</em> section.</p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<h2 id="h1-502703c16-0003">Summary</h2>
<p class="BodyFirst">In this chapter, you learned how to work with real-world datasets. You processed CSV and GeoJSON files, and extracted the data you want to focus on. Using historical weather data, you learned more about working with Matplotlib, including how to use the <code>datetime</code> module and how to plot multiple data series on one chart. You plotted geographical data on a world map in Plotly, and learned to customize the style of the map.</p>
<p>As you gain experience working with CSV and JSON files, you’ll be able to process almost any data you want to analyze. You can download most online datasets in either or both of these formats. By working with these <span epub:type="pagebreak" title="353" id="Page_353"/>formats, you’ll be able to learn how to work with other data formats more easily as well.</p>
<p>In the next chapter, you’ll write programs that automatically gather their own data from online sources, and then you’ll create visualizations of that data. These are fun skills to have if you want to program as a hobby and are critical skills if you’re interested in programming professionally.</p>
</section>
</div>
<div id="sbo-rt-content"><section>
<header>
<h1 class="chapter">
<span class="ChapterNumber"><span epub:type="pagebreak" title="355" id="Page_355"/>17</span><br/>
<span class="ChapterTitle">Working with APIs</span></h1>
</header>
<figure class="opener">
<img src="Images/chapterart.png" alt="" width="406" height="406"/>
</figure>
<p class="ChapterIntro">In this chapter, you’ll learn how to write a self-contained program that generates a visualization based on data it retrieves. Your program will use an <em>application programming interface (</em><em>API)</em> to automatically request specific information from a website and then use that information to generate a visualization. Because programs written like this will always use current data to generate a visualization, even when that data might be rapidly changing, the visualization will always be up to date.</p>
<h2 id="h1-502703c17-0001">Using an API</h2>
<p class="BodyFirst">An API is a part of a website designed to interact with programs. Those programs use very specific URLs to request certain information. This kind of request is called an <em>API call</em>. The requested data will be returned in an <span epub:type="pagebreak" title="356" id="Page_356"/>easily processed format, such as JSON or CSV. Most apps that use external data sources, such as apps that integrate with social media sites, rely on API calls.</p>
<h3 id="h2-502703c17-0001">Git and GitHub</h3>
<p class="BodyFirst">We’ll base our visualization on information from GitHub (<a href="https://github.com" class="LinkURL">https://github.com</a>), a site that allows programmers to collaborate on coding projects. We’ll use GitHub’s API to request information about Python projects on the site, and then generate an interactive visualization of the relative popularity of these projects using Plotly.</p>
<p>GitHub takes its name from Git, a distributed version control system. Git helps people manage their work on a project in a way that prevents changes made by one person from interfering with changes other people are making. When you implement a new feature in a project, Git tracks the changes you make to each file. When your new code works, you <em>commit</em> the changes you’ve made, and Git records the new state of your project. If you make a mistake and want to revert your changes, you can easily return to any previously working state. (To learn more about version control using Git, see <span class="xref" itemid="xref_target_Appendix D">Appendix D</span>.) Projects on GitHub are stored in <em>repositories</em>, which contain everything associated with the project: its code, information on its collaborators, any issues or bug reports, and so on.</p>
<p>When users on GitHub like a project, they can “star” it to show their support and keep track of projects they might want to use. In this chapter, we’ll write a program to automatically download information about the most-starred Python projects on GitHub, and then we’ll create an informative visualization of these projects.</p>
<h3 id="h2-502703c17-0002">Requesting Data Using an API Call</h3>
<p class="BodyFirst">GitHub’s API lets you request a wide range of information through API calls. To see what an API call looks like, enter the following into your browser’s address bar and press ENTER:</p>
<pre><code><b>https://api.github.com/search/repositories?q=language:python+sort:stars</b></code></pre>
<p>This call returns the number of Python projects currently hosted on GitHub, as well as information about the most popular Python repositories. Let’s examine the call. The first part, <code>https://api.github.com/</code>, directs the request to the part of GitHub that responds to API calls. The next part, <code>search/repositories</code>, tells the API to conduct a search through all the repositories on GitHub.</p>
<p>The question mark after <code>repositories</code> signals that we’re about to pass an argument. The <code>q</code> stands for <em>query</em>, and the equal sign (<code>=</code>) lets us begin specifying a query (<code>q=</code>). By using <code>language:python</code>, we indicate that we want information only on repositories that have Python as the primary language. The final part, <code>+sort:stars</code>, sorts the projects by the number of stars they’ve been given.</p>
<p><span epub:type="pagebreak" title="357" id="Page_357"/>The following snippet shows the first few lines of the response:</p>
<pre><code>{
<span class="CodeAnnotationHang" aria-label="annotation1">❶</span>   "total_count": 8961993,
<span class="CodeAnnotationHang" aria-label="annotation2">❷</span>   "incomplete_results": true,
<span class="CodeAnnotationHang" aria-label="annotation3">❸</span>   "items": [
    {
      "id": 54346799,
      "node_id": "MDEwOlJlcG9zaXRvcnk1NDM0Njc5OQ==",
      "name": "public-apis",
      "full_name": "public-apis/public-apis",
<var>      --snip--</var></code></pre>
<p>You can see from the response that this URL is not primarily intended to be entered by humans, because it’s in a format that’s meant to be processed by a program. GitHub found just under nine million Python projects as of this writing <span class="CodeAnnotation" aria-label="annotation1">❶</span>. The value for <code>"incomplete_results"</code> is <code>true</code>, which tells us that GitHub didn’t fully process the query <span class="CodeAnnotation" aria-label="annotation2">❷</span>. GitHub limits how long each query can run, in order to keep the API responsive for all users. In this case it found some of the most popular Python repositories, but it didn’t have time to find all of them; we’ll fix that in a moment. The <code>"items"</code> returned are displayed in the list that follows, which contains details about the most popular Python projects on GitHub <span class="CodeAnnotation" aria-label="annotation3">❸</span>.</p>
<h3 id="h2-502703c17-0003">Installing Requests</h3>
<p class="BodyFirst">The <em>Requests</em> package allows a Python program to easily request information from a website and examine the response. Use pip to install Requests:</p>
<pre><code>$ <b>python -m pip install --user requests</b></code></pre>
<p>If you use a command other than <code class="bold">python</code> to run programs or start a terminal session, such as <code class="bold">python3</code>, your command will look like this:</p>
<pre><code>$ <b>python3 -m pip install --user requests</b></code></pre>
<h3 id="h2-502703c17-0004">Processing an API Response</h3>
<p class="BodyFirst">Now we’ll write a program to automatically issue an API call and process the results:</p>
<p class="CodeLabel"><b>python_repos.py</b></p>
<pre><code>import requests

# Make an API call and check the response.
<span class="CodeAnnotationHang" aria-label="annotation1">❶</span> url = "https://api.github.com/search/repositories"
url += "?q=language:python+sort:stars+stars:&gt;10000"

<span class="CodeAnnotationHang" aria-label="annotation2">❷</span> headers = {"Accept": "application/vnd.github.v3+json"}
<span class="CodeAnnotationHang" aria-label="annotation3">❸</span> r = requests.get(url, headers=headers)
<span class="CodeAnnotationHang" aria-label="annotation4">❹</span> print(f"Status code: {r.status_code}")

<span epub:type="pagebreak" title="358" id="Page_358"/># Convert the response object to a dictionary.
<span class="CodeAnnotationHang" aria-label="annotation5">❺</span> response_dict = r.json()

# Process results.
print(response_dict.keys())</code></pre>
<p>We first import the <code>requests</code> module. Then we assign the URL of the API call to the <code>url</code> variable <span class="CodeAnnotation" aria-label="annotation1">❶</span>. This is a long URL, so we break it into two lines. The first line is the main part of the URL, and the second line is the query string. We’ve included one more condition to the original query string: <code>stars:&gt;10000</code>, which tells GitHub to only look for Python repositories that have more than 10,000 stars. This should allow GitHub to return a complete, consistent set of results.</p>
<p>GitHub is currently on the third version of its API, so we define headers for the API call that ask explicitly to use this version of the API, and return the results in the JSON format <span class="CodeAnnotation" aria-label="annotation2">❷</span>. Then we use <code>requests</code> to make the call to the API <span class="CodeAnnotation" aria-label="annotation3">❸</span>. We call <code>get()</code> and pass it the URL and the header that we defined, and we assign the response object to the variable <code>r</code>.</p>
<p>The response object has an attribute called <code>status_code</code>, which tells us whether the request was successful. (A status code of 200 indicates a successful response.) We print the value of <code>status_code</code> so we can make sure the call went through successfully <span class="CodeAnnotation" aria-label="annotation4">❹</span>. We asked the API to return the information in JSON format, so we use the <code>json()</code> method to convert the information to a Python dictionary <span class="CodeAnnotation" aria-label="annotation5">❺</span>. We assign the resulting dictionary to <code>response_dict</code>.</p>
<p>Finally, we print the keys from <code>response_dict</code> and see the following output:</p>
<pre><code>Status code: 200
dict_keys(['total_count', 'incomplete_results', 'items'])</code></pre>
<p>Because the status code is <code>200</code>, we know that the request was successful. The response dictionary contains only three keys: <code>'total_count'</code>, <code>'incomplete_results'</code>, and <code>'items'</code>. Let’s take a look inside the response dictionary.</p>
<h3 id="h2-502703c17-0005">Working with the Response Dictionary</h3>
<p class="BodyFirst">With the information from the API call represented as a dictionary, we can work with the data stored there. Let’s generate some output that summarizes the information. This is a good way to make sure we received the information we expected, and to start examining the information we’re interested in:</p>
<p class="CodeLabel"><b>python_repos.py</b></p>
<pre><code><span class="LiteralGray">import requests</span>

<span class="LiteralGray"># Make an API call and store the response.</span>
<em class="LiteralGrayItalic">--snip--</em>

<span class="LiteralGray"># Convert the response object to a dictionary.</span>
<span class="LiteralGray">response_dict = r.json()</span>
<span epub:type="pagebreak" title="359" id="Page_359"/><span class="CodeAnnotationHang" aria-label="annotation1">❶</span> print(f"Total repositories: {response_dict['total_count']}")
print(f"Complete results: {not response_dict['incomplete_results']}")

# Explore information about the repositories.
<span class="CodeAnnotationHang" aria-label="annotation2">❷</span> repo_dicts = response_dict['items']
print(f"Repositories returned: {len(repo_dicts)}")

# Examine the first repository.
<span class="CodeAnnotationHang" aria-label="annotation3">❸</span> repo_dict = repo_dicts[0]
<span class="CodeAnnotationHang" aria-label="annotation4">❹</span> print(f"\nKeys: {len(repo_dict)}")
<span class="CodeAnnotationHang" aria-label="annotation5">❺</span> for key in sorted(repo_dict.keys()):
    print(key)</code></pre>
<p>We start exploring the response dictionary by printing the value associated with <code>'total_count'</code>, which represents the total number of Python repositories returned by this API call <span class="CodeAnnotation" aria-label="annotation1">❶</span>. We also use the value associated with <code>'incomplete_results'</code>, so we'll know if GitHub was able to fully process the query. Rather than printing this value directly, we print its opposite: a value of <code>True</code> will indicate that we received a complete set of results.</p>
<p>The value associated with <code>'items'</code> is a list containing a number of dictionaries, each of which contains data about an individual Python repository. We assign this list of dictionaries to <code>repo_dicts</code> <span class="CodeAnnotation" aria-label="annotation2">❷</span>. We then print the length of <code>repo_dicts</code> to see how many repositories we have information for.</p>
<p>To look closer at the information returned about each repository, we pull out the first item from <code>repo_dicts</code> and assign it to <code>repo_dict</code> <span class="CodeAnnotation" aria-label="annotation3">❸</span>. We then print the number of keys in the dictionary to see how much information we have <span class="CodeAnnotation" aria-label="annotation4">❹</span>. Finally, we print all the dictionary’s keys to see what kind of information is included <span class="CodeAnnotation" aria-label="annotation5">❺</span>.</p>
<p>The results give us a clearer picture of the actual data:</p>
<pre><code>Status code: 200
<span class="CodeAnnotationHang" aria-label="annotation1">❶</span> Total repositories: 248
<span class="CodeAnnotationHang" aria-label="annotation2">❷</span> Complete results: True
Repositories returned: 30

<span class="CodeAnnotationHang" aria-label="annotation3">❸</span> Keys: 78
allow_forking
archive_url
archived
<var>--snip--</var>
url
visiblity
watchers
watchers_count</code></pre>
<p>At the time of this writing, there are only <code>248</code> Python repositories with over 10,000 stars <span class="CodeAnnotation" aria-label="annotation1">❶</span>. We can see that GitHub was able to fully process the API call <span class="CodeAnnotation" aria-label="annotation2">❷</span>. In this response, GitHub returned information about the first <code>30</code> repositories that match the conditions of our query. If we want more repositories, we can request additional pages of data.</p>
<p><span epub:type="pagebreak" title="360" id="Page_360"/>GitHub’s API returns a lot of information about each repository: there are <code>78</code> keys in <code>repo_dict</code> <span class="CodeAnnotation" aria-label="annotation3">❸</span>. When you look through these keys, you’ll get a sense of the kind of information you can extract about a project. (The only way to know what information is available through an API is to read the documentation or to examine the information through code, as we’re doing here.)</p>
<p>Let’s pull out the values for some of the keys in <code>repo_dict</code>:</p>
<p class="CodeLabel"><b>python_repos.py</b></p>
<pre><code><em class="LiteralGrayItalic">--snip--</em>
<span class="LiteralGray"># Examine the first repository.</span>
<span class="LiteralGray">repo_dict = repo_dicts[0]</span>

print("\nSelected information about first repository:")
<span class="CodeAnnotationHang" aria-label="annotation1">❶</span> print(f"Name: {repo_dict['name']}")
<span class="CodeAnnotationHang" aria-label="annotation2">❷</span> print(f"Owner: {repo_dict['owner']['login']}")
<span class="CodeAnnotationHang" aria-label="annotation3">❸</span> print(f"Stars: {repo_dict['stargazers_count']}")
print(f"Repository: {repo_dict['html_url']}")
<span class="CodeAnnotationHang" aria-label="annotation4">❹</span> print(f"Created: {repo_dict['created_at']}")
<span class="CodeAnnotationHang" aria-label="annotation5">❺</span> print(f"Updated: {repo_dict['updated_at']}")
print(f"Description: {repo_dict['description']}")</code></pre>
<p>Here, we print the values for a number of keys from the first repository’s dictionary. We start with the name of the project <span class="CodeAnnotation" aria-label="annotation1">❶</span>. An entire dictionary represents the project’s owner, so we use the key <code>owner</code> to access the dictionary representing the owner, and then use the key <code>login</code> to get the owner’s login name <span class="CodeAnnotation" aria-label="annotation2">❷</span>. Next, we print how many stars the project has earned <span class="CodeAnnotation" aria-label="annotation3">❸</span> and the URL for the project’s GitHub repository. We then show when it was created <span class="CodeAnnotation" aria-label="annotation4">❹</span> and when it was last updated <span class="CodeAnnotation" aria-label="annotation5">❺</span>. Finally, we print the repository’s description.</p>
<p>The output should look something like this:</p>
<pre><code>Status code: 200
Total repositories: 248
Complete results: True
Repositories returned: 30

Selected information about first repository:
Name: public-apis
Owner: public-apis
Stars: 191493
Repository: https://github.com/public-apis/public-apis
Created: 2016-03-20T23:49:42Z
Updated: 2022-05-12T06:37:11Z
Description: A collective list of free APIs</code></pre>
<p>We can see that the most-starred Python project on GitHub as of this writing is <em>public-apis</em>. Its owner is an organization with the same name, and it has been starred by almost 200,000 GitHub users. We can see the URL for the project’s repository, its creation date of March 2016, and that it was updated recently. Additionally, the description tells us that <em>public-apis</em> contains a list of free APIs that programmers might be interested in.</p>
<h3 id="h2-502703c17-0006"><span epub:type="pagebreak" title="361" id="Page_361"/>Summarizing the Top Repositories</h3>
<p class="BodyFirst">When we make a visualization for this data, we’ll want to include more than one repository. Let’s write a loop to print selected information about each repository the API call returns so we can include them all in the visualization:</p>
<p class="CodeLabel"><b>python_repos.py</b></p>
<pre><code><em class="LiteralGrayItalic">--snip--</em>
<span class="LiteralGray"># Explore information about the repositories.</span>
<span class="LiteralGray">repo_dicts = response_dict['items']</span>
<span class="LiteralGray">print(f"Repositories returned: {len(repo_dicts)}")</span>

<span class="CodeAnnotationHang" aria-label="annotation1">❶</span> print("\nSelected information about each repository:")
<span class="CodeAnnotationHang" aria-label="annotation2">❷</span> for repo_dict in repo_dicts:
<span class="LiteralGray">    print(f"\nName: {repo_dict['name']}")</span>
<span class="LiteralGray">    print(f"Owner: {repo_dict['owner']['login']}")</span>
<span class="LiteralGray">    print(f"Stars: {repo_dict['stargazers_count']}")</span>
<span class="LiteralGray">    print(f"Repository: {repo_dict['html_url']}")</span>
<span class="LiteralGray">    print(f"Description: {repo_dict['description']}")</span></code></pre>
<p>We first print an introductory message <span class="CodeAnnotation" aria-label="annotation1">❶</span>. Then we loop through all the dictionaries in <code>repo_dicts</code> <span class="CodeAnnotation" aria-label="annotation2">❷</span>. Inside the loop, we print the name of each project, its owner, how many stars it has, its URL on GitHub, and the project’s description:</p>
<pre><code>Status code: 200
Total repositories: 248
Complete results: True
Repositories returned: 30

Selected information about each repository:

Name: public-apis
Owner: public-apis
Stars: 191494
Repository: https://github.com/public-apis/public-apis
Description: A collective list of free APIs

Name: system-design-primer
Owner: donnemartin
Stars: 179952
Repository: https://github.com/donnemartin/system-design-primer
Description: Learn how to design large-scale systems. Prep for the system
  design interview.  Includes Anki flashcards.
<var>--snip--</var>

Name: PayloadsAllTheThings
Owner: swisskyrepo
Stars: 37227
Repository: https://github.com/swisskyrepo/PayloadsAllTheThings
Description: A list of useful payloads and bypass for Web Application Security
  and Pentest/CTF</code></pre>
<p><span epub:type="pagebreak" title="362" id="Page_362"/>Some interesting projects appear in these results, and it might be worth looking at a few. But don’t spend too much time here, because we’re about to create a visualization that will make the results much easier to read.</p>
<h3 id="h2-502703c17-0007">Monitoring API Rate Limits</h3>
<p class="BodyFirst">Most APIs have <em>rate limits</em>, which means there’s a limit to how many requests you can make in a certain amount of time. To see if you’re approaching GitHub’s limits, enter <a href="https://api.github.com/rate_limit%20" class="LinkURL">https://api.github.com/rate_limit </a>into a web browser. You should see a response that begins like this:</p>
<pre><code>{
  "resources": {
    <var>--snip--</var>
<span class="CodeAnnotationHang" aria-label="annotation1">❶</span>     "search": {
<span class="CodeAnnotationHang" aria-label="annotation2">❷</span>       "limit": 10,
<span class="CodeAnnotationHang" aria-label="annotation3">❸</span>       "remaining": 9,
<span class="CodeAnnotationHang" aria-label="annotation4">❹</span>       "reset": 1652338832,
      "used": 1,
      "resource": "search"
    },
    <var>--snip--</var></code></pre>
<p>The information we’re interested in is the rate limit for the search API <span class="CodeAnnotation" aria-label="annotation1">❶</span>. We see that the limit is 10 requests per minute <span class="CodeAnnotation" aria-label="annotation2">❷</span> and that we have 9 requests remaining for the current minute <span class="CodeAnnotation" aria-label="annotation3">❸</span>. The value associated with the key <code>"reset"</code> represents the time in <em>Unix</em> or <em>epoch time</em> (the number of seconds since midnight on January 1, 1970) when our quota will reset <span class="CodeAnnotation" aria-label="annotation4">❹</span>. If you reach your quota, you’ll get a short response that lets you know you’ve reached the API limit. If you reach the limit, just wait until your quota resets.</p>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="note">
<h2><span class="NoteHead">Note</span></h2>
<p>	Many APIs require you to register and obtain an API key or access token to make API calls. As of this writing, GitHub has no such requirement, but if you obtain an access token, your limits will be much higher.</p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<h2 id="h1-502703c17-0002">Visualizing Repositories Using Plotly</h2>
<p class="BodyFirst">Let’s make a visualization using the data we’ve gathered to show the relative popularity of Python projects on GitHub. We’ll make an interactive bar chart: the height of each bar will represent the number of stars the project has acquired, and you’ll be able to click the bar’s label to go to that project’s home on GitHub.</p>
<p><span epub:type="pagebreak" title="363" id="Page_363"/>Save a copy of the program we’ve been working on as <em>python_repos_visual.py</em>, then modify it so it reads as follows:</p>
<p class="CodeLabel"><b>python_repos_visual.py</b></p>
<pre><code><span class="LiteralGray">import requests</span>
import plotly.express as px

<span class="LiteralGray"># Make an API call and check the response.</span>
<span class="LiteralGray">url = "https://api.github.com/search/repositories"</span>
<span class="LiteralGray">url += "?q=language:python+sort:stars+stars:&gt;10000"</span>

<span class="LiteralGray">headers = {"Accept": "application/vnd.github.v3+json"}</span>
<span class="LiteralGray">r = requests.get(url, headers=headers)</span>
<span class="CodeAnnotationHang" aria-label="annotation1">❶</span><span class="LiteralGray"> print(f"Status code: {r.status_code}")</span>

# Process overall results.
<span class="LiteralGray">response_dict = r.json()</span>
<span class="CodeAnnotationHang" aria-label="annotation2">❷</span><span class="LiteralGray"> print(f"Complete results: {not response_dict['incomplete_results']}")</span>

# Process repository information.
<span class="LiteralGray">repo_dicts = response_dict['items']</span>
<span class="CodeAnnotationHang" aria-label="annotation3">❸</span> repo_names, stars = [], []
<span class="LiteralGray">for repo_dict in repo_dicts:</span>
    repo_names.append(repo_dict['name'])
    stars.append(repo_dict['stargazers_count'])

# Make visualization.
<span class="CodeAnnotationHang" aria-label="annotation4">❹</span> fig = px.bar(x=repo_names, y=stars)
fig.show()</code></pre>
<p>We import Plotly Express and then make the API call as we have been doing. We continue to print the status of the API call response so we’ll know if there is a problem <span class="CodeAnnotation" aria-label="annotation1">❶</span>. When we process the overall results, we continue to print the message confirming that we got a complete set of results <span class="CodeAnnotation" aria-label="annotation2">❷</span>. We remove the rest of the <code>print()</code> calls because we’re no longer in the exploratory phase; we know we have the data we want.</p>
<p>We then create two empty lists <span class="CodeAnnotation" aria-label="annotation3">❸</span> to store the data we’ll include in the initial chart. We’ll need the name of each project to label the bars (<code>repo_names</code>) and the number of stars to determine the height of the bars (<code>stars</code>). In the loop, we append the name of each project and the number of stars it has to these lists.</p>
<p>We make the initial visualization with just two lines of code <span class="CodeAnnotation" aria-label="annotation4">❹</span>. This is consistent with Plotly Express’s philosophy that you should be able to see your visualization as quickly as possible before refining its appearance. Here we use the <code>px.bar()</code> function to create a bar chart. We pass the list <code>repo_names</code> as the <code>x</code> argument and <code>stars</code> as the <code>y</code> argument.</p>
<p><a href="#figure17-1" id="figureanchor17-1">Figure 17-1</a> shows the resulting chart. We can see that the first few projects are significantly more popular than the rest, but all of them are important projects in the Python ecosystem.</p>
<span epub:type="pagebreak" title="364" id="Page_364"/><figure>
<img src="Images/f17001.png" class="keyline" alt="" width="694" height="429"/>
<figcaption><p><a id="figure17-1">Figure 17-1</a>: The most-starred Python projects on GitHub</p></figcaption>
</figure>
<h3 id="h2-502703c17-0008">Styling the Chart</h3>
<p class="BodyFirst">Plotly supports a number of ways to style and customize the plots, once you know the information in the plot is correct. We’ll make some changes in the initial <code>px.bar()</code> call and then make some further adjustments to the <code>fig</code> object after it’s been created.</p>
<p>We’ll start styling the chart by adding a title and labels for each axis:</p>
<p class="CodeLabel"><b>python_repos_visual.py</b></p>
<pre><code><em class="LiteralGrayItalic">--snip--</em>
<span class="LiteralGray"># Make visualization.</span>
title = "Most-Starred Python Projects on GitHub"
labels = {'x': 'Repository', 'y': 'Stars'}
fig = px.bar(x=repo_names, y=stars, title=title, labels=labels)

<span class="CodeAnnotationHang" aria-label="annotation1">❶</span> fig.update_layout(title_font_size=28, xaxis_title_font_size=20,
        yaxis_title_font_size=20)

<span class="LiteralGray">fig.show()</span></code></pre>
<p>We first add a title and labels for each axis, as we did in <span class="xref" itemid="xref_target_Chapters 15">Chapters 15</span> and <span class="xref" itemid="xref_target_16">16</span>. We then use the <code>fig.update_layout()</code> method to modify specific elements of the chart <span class="CodeAnnotation" aria-label="annotation1">❶</span>. Plotly uses a convention where aspects of a chart element are connected by underscores. As you become familiar with Plotly’s documentation, you’ll start to see consistent patterns in how different elements of a chart are named and modified. Here we set the title font size to <code>28</code> and the font size for each axis title to <code>20</code>. The result is shown in <a href="#figure17-2" id="figureanchor17-2">Figure 17-2</a>.</p>
<span epub:type="pagebreak" title="365" id="Page_365"/><figure>
<img src="Images/f17002.png" class="keyline" alt="" width="694" height="429"/>
<figcaption><p><a id="figure17-2">Figure 17-2</a>: A title has been added to the main chart, and to each axis as well.</p></figcaption>
</figure>
<h3 id="h2-502703c17-0009">Adding Custom Tooltips</h3>
<p class="BodyFirst">In Plotly, you can hover the cursor over an individual bar to show the information the bar represents. This is commonly called a <em>tooltip</em>, and in this case, it currently shows the number of stars a project has. Let’s create a custom tooltip to show each project’s description as well as the project’s owner.</p>
<p>We need to pull some additional data to generate the tooltips:</p>
<p class="CodeLabel"><b>python_repos_visual.py</b></p>
<pre><code><em class="LiteralGrayItalic">--snip--</em>
<span class="LiteralGray"># Process repository information.</span>
<span class="LiteralGray">repo_dicts = response_dict['items']</span>
<span class="CodeAnnotationHang" aria-label="annotation1">❶</span> repo_names, stars, hover_texts = [], [], []
<span class="LiteralGray">for repo_dict in repo_dicts:</span>
<span class="LiteralGray">    repo_names.append(repo_dict['name'])</span>
<span class="LiteralGray">    stars.append(repo_dict['stargazers_count'])</span>

    # Build hover texts.
<span class="CodeAnnotationHang" aria-label="annotation2">❷</span>     owner = repo_dict['owner']['login']
    description = repo_dict['description']
<span class="CodeAnnotationHang" aria-label="annotation3">❸</span>     hover_text = f"{owner}&lt;br /&gt;{description}"
    hover_texts.append(hover_text)

<span class="LiteralGray"># Make visualization.</span>
<span class="LiteralGray">title = "Most-Starred Python Projects on GitHub"</span>
<span class="LiteralGray">labels = {'x': 'Repository', 'y': 'Stars'}</span>
<span class="CodeAnnotationHang" aria-label="annotation4">❹</span> fig = px.bar(x=repo_names, y=stars, title=title, labels=labels,
        hover_name=hover_texts)

<span epub:type="pagebreak" title="366" id="Page_366"/><span class="LiteralGray">fig.update_layout(title_font_size=28, xaxis_title_font_size=20,</span>
<span class="LiteralGray">        yaxis_title_font_size=20)</span>

<span class="LiteralGray">fig.show()</span></code></pre>
<p>We first define a new empty list, <code>hover_texts</code>, to hold the text we want to display for each project <span class="CodeAnnotation" aria-label="annotation1">❶</span>. In the loop where we process the data, we pull the owner and the description for each project <span class="CodeAnnotation" aria-label="annotation2">❷</span>. Plotly allows you to use HTML code within text elements, so we generate a string for the label with a line break (<code>&lt;br /&gt;</code>) between the project owner’s username and the description <span class="CodeAnnotation" aria-label="annotation3">❸</span>. We then append this label to the list <code>hover_texts</code>.</p>
<p>In the <code>px.bar()</code> call, we add the <code>hover_name</code> argument and pass it <code>hover_texts</code> <span class="CodeAnnotation" aria-label="annotation4">❹</span>. This is the same approach we used to customize the label for each dot in the map of global earthquake activity. As Plotly creates each bar, it will pull labels from this list and only display them when the viewer hovers over a bar. <a href="#figure17-3" id="figureanchor17-3">Figure 17-3</a> shows one of these custom tooltips.</p>
<figure>
<img src="Images/f17003.png" class="keyline" alt="" width="571" height="399"/>
<figcaption><p><a id="figure17-3">Figure 17-3</a>: Hovering over a bar shows the project’s owner and description.</p></figcaption>
</figure>
<h3 id="h2-502703c17-0010">Adding Clickable Links</h3>
<p class="BodyFirst">Because Plotly allows you to use HTML on text elements, we can easily add links to a chart. Let’s use the <em>x</em>-axis labels as a way to let the viewer visit any project’s home page on GitHub. We need to pull the URLs from the data and use them when generating the <em>x</em>-axis labels:</p>
<p class="CodeLabel"><b>python_repos_visual.py</b></p>
<pre><code><em class="LiteralGrayItalic">--snip--</em>
<span class="LiteralGray"># Process repository information.</span>
<span class="LiteralGray">repo_dicts = response_dict['items']</span>
<span class="CodeAnnotationHang" aria-label="annotation1">❶</span> repo_links, stars, hover_texts = [], [], []
<span class="LiteralGray">for repo_dict in repo_dicts:</span>
    # Turn repo names into active links.
    repo_name = repo_dict['name']
<span class="CodeAnnotationHang" aria-label="annotation2">❷</span>     repo_url = repo_dict['html_url']
<span epub:type="pagebreak" title="367" id="Page_367"/><span class="CodeAnnotationHang" aria-label="annotation3">❸</span>     repo_link = f"&lt;a href='{repo_url}'&gt;{repo_name}&lt;/a&gt;"
    repo_links.append(repo_link)

<span class="LiteralGray">    stars.append(repo_dict['stargazers_count'])</span>
<span class="LiteralGray">    </span><em class="LiteralGrayItalic">--snip--</em>

<span class="LiteralGray"># Make visualization.</span>
<span class="LiteralGray">title = "Most-Starred Python Projects on GitHub"</span>
<span class="LiteralGray">labels = {'x': 'Repository', 'y': 'Stars'}</span>
fig = px.bar(x=repo_links, y=stars, title=title, labels=labels,
<span class="LiteralGray">        hover_name=hover_texts)</span>

<span class="LiteralGray">fig.update_layout(title_font_size=28, xaxis_title_font_size=20,</span>
<span class="LiteralGray">        yaxis_title_font_size=20)</span>

<span class="LiteralGray">fig.show()</span></code></pre>
<p>We update the name of the list we’re creating from <code>repo_names</code> to <code>repo_links</code> to more accurately communicate the kind of information we’re putting together for the chart <span class="CodeAnnotation" aria-label="annotation1">❶</span>. We then pull the URL for the project from <code>repo_dict</code> and assign it to the temporary variable <code>repo_url</code> <span class="CodeAnnotation" aria-label="annotation2">❷</span>. Next, we generate a link to the project <span class="CodeAnnotation" aria-label="annotation3">❸</span>. We use the HTML anchor tag, which has the form <code>&lt;a href='URL'&gt;link text&lt;/a&gt;</code>, to generate the link. We then append this link to <code>repo_links</code>.</p>
<p>When we call <code>px.bar()</code>, we use <code>repo_links</code> for the <em>x</em>-values in the chart. The result looks the same as before, but now the viewer can click any of the project names at the bottom of the chart to visit that project’s home page on GitHub. Now we have an interactive, informative visualization of data retrieved through an API!</p>
<h3 id="h2-502703c17-0011">Customizing Marker Colors</h3>
<p class="BodyFirst">Once a chart has been created, almost any aspect of the chart can be customized through an update method. We’ve used the <code>update_layout()</code> method previously. Another method, <code>update_traces()</code>, can be used to customize the data that’s represented on a chart.</p>
<p>Let’s change the bars to a darker blue, with some transparency:</p>
<pre><code><em class="LiteralGrayItalic">--snip--</em>
<span class="LiteralGray">fig.update_layout(title_font_size=28, xaxis_title_font_size=20,</span>
<span class="LiteralGray">        yaxis_title_font_size=20)</span>

fig.update_traces(marker_color='SteelBlue', marker_opacity=0.6)

<span class="LiteralGray">fig.show()</span></code></pre>
<p>In Plotly, a <em>trace</em> refers to a collection of data on a chart. The <code>update_traces()</code> method can take a number of different arguments; any argument that starts with <code>marker_</code> affects the markers on the chart. Here we set each marker’s color to <code>'SteelBlue'</code>; any named CSS color will work here. We also set the opacity of each marker to <code>0.6</code>. An opacity of 1.0 will be entirely opaque, and an opacity of 0 will be entirely invisible.</p>
<h3 id="h2-502703c17-0012"><span epub:type="pagebreak" title="368" id="Page_368"/>More About Plotly and the GitHub API</h3>
<p class="BodyFirst">Plotly’s documentation is extensive and well organized; however, it can be hard to know where to start reading. A good place to start is with the article “Plotly Express in Python,” at <a href="https://plotly.com/python/plotly-express" class="LinkURL">https://plotly.com/python/plotly-express</a>. This is an overview of all the plots you can make with Plotly Express, and you can find links to longer articles about each individual chart type.</p>
<p>If you want to understand how to customize Plotly charts better, the article “Styling Plotly Express Figures in Python” will expand on what you’ve seen in <span class="xref" itemid="xref_target_Chapters 15">Chapters 15</span>–<span class="xref" itemid="xref_target_17">17</span>. You can find this article at <a href="https://plotly.com/python/styling-plotly-express" class="LinkURL">https://plotly.com/python/styling-plotly-express</a>.</p>
<p>For more about the GitHub API, refer to its documentation at <a href="https://docs.github.com/en/rest" class="LinkURL">https://docs.github.com/en/rest</a>. Here you’ll learn how to pull a wide variety of information from GitHub. To expand on what you saw in this project, look for the Search section of the reference in the sidebar. If you have a GitHub account, you can work with your own data as well as the publicly available data from other users’ repositories.</p>
<h2 id="h1-502703c17-0003">The Hacker News API</h2>
<p class="BodyFirst">To explore how to use API calls on other sites, let’s take a quick look at Hacker News (<a href="https://news.ycombinator.com" class="LinkURL">https://news.ycombinator.com</a>). On Hacker News, people share articles about programming and technology and engage in lively discussions about those articles. The Hacker News API provides access to data about all submissions and comments on the site, and you can use the API without having to register for a key.</p>
<p>The following call returns information about the current top article as of this writing:</p>
<pre><code>https://hacker-news.firebaseio.com/v0/item/31353677.json</code></pre>
<p>When you enter this URL in a browser, you’ll see that the text on the page is enclosed by braces, meaning it’s a dictionary. But the response is difficult to examine without some better formatting. Let’s run this URL through the <code>json.dumps()</code> method, like we did in the earthquake project in <span class="xref" itemid="xref_target_Chapter 16">Chapter 16</span>, so we can explore the kind of information that’s returned about an article:</p>
<p class="CodeLabel"><b>hn_article.py</b></p>
<pre><code>import requests
import json

# Make an API call, and store the response.
url = "https://hacker-news.firebaseio.com/v0/item/31353677.json"
r = requests.get(url)
print(f"Status code: {r.status_code}")

# Explore the structure of the data.
response_dict = r.json()
response_string = json.dumps(response_dict, indent=4)
<span class="CodeAnnotationHang" aria-label="annotation1">❶</span> print(response_string)</code></pre>
<p><span epub:type="pagebreak" title="369" id="Page_369"/>Everything in this program should look familiar, because we’ve used it all in the previous two chapters. The main difference here is that we can print the formatted response string <span class="CodeAnnotation" aria-label="annotation1">❶</span> instead of writing it to a file, because the output is not particularly long.</p>
<p>The output is a dictionary of information about the article with the ID <code>31353677</code>:</p>
<pre><code>{
    "by": "sohkamyung",
<span class="CodeAnnotationHang" aria-label="annotation1">❶</span>     "descendants": 302,
    "id": 31353677,
<span class="CodeAnnotationHang" aria-label="annotation2">❷</span>     "kids": [
        31354987,
        31354235,
        <var>--snip--</var>
    ],
    "score": 785,
    "time": 1652361401,
<span class="CodeAnnotationHang" aria-label="annotation3">❸</span>     "title": "Astronomers reveal first image of the black hole
        at the heart of our galaxy",
    "type": "story",
<span class="CodeAnnotationHang" aria-label="annotation4">❹</span>     "url": "https://public.nrao.edu/news/.../"
}</code></pre>
<p>The dictionary contains a number of keys we can work with. The key <code>"descendants"</code> tells us the number of comments the article has received <span class="CodeAnnotation" aria-label="annotation1">❶</span>. The key <code>"kids"</code> provides the IDs of all comments made directly in response to this submission <span class="CodeAnnotation" aria-label="annotation2">❷</span>. Each of these comments might have comments of their own as well, so the number of descendants a submission has is usually greater than its number of kids. We can see the title of the article being discussed <span class="CodeAnnotation" aria-label="annotation3">❸</span> and a URL for the article being discussed as well <span class="CodeAnnotation" aria-label="annotation4">❹</span>.</p>
<p>The following URL returns a simple list of all the IDs of the current top articles on Hacker News:</p>
<pre><code>https://hacker-news.firebaseio.com/v0/topstories.json</code></pre>
<p>We can use this call to find out which articles are on the home page right now, and then generate a series of API calls similar to the one we just examined. With this approach, we can print a summary of all the articles on the front page of Hacker News at the moment:</p>
<p class="CodeLabel"><b>hn_submissions.py</b></p>
<pre><code>from operator import itemgetter

import requests

# Make an API call and check the response.
<span class="CodeAnnotationHang" aria-label="annotation1">❶</span> url = "https://hacker-news.firebaseio.com/v0/topstories.json"
r = requests.get(url)
print(f"Status code: {r.status_code}")

# Process information about each submission.
<span class="CodeAnnotationHang" aria-label="annotation2">❷</span> submission_ids = r.json()
<span epub:type="pagebreak" title="370" id="Page_370"/><span class="CodeAnnotationHang" aria-label="annotation3">❸</span> submission_dicts = []
for submission_id in submission_ids[:5]:
    # Make a new API call for each submission.
<span class="CodeAnnotationHang" aria-label="annotation4">❹</span>     url = f"https://hacker-news.firebaseio.com/v0/item/{submission_id}.json"
    r = requests.get(url)
    print(f"id: {submission_id}\tstatus: {r.status_code}")
    response_dict = r.json()

    # Build a dictionary for each article.
<span class="CodeAnnotationHang" aria-label="annotation5">❺</span>     submission_dict = {
        'title': response_dict['title'],
        'hn_link': f"https://news.ycombinator.com/item?id={submission_id}",
        'comments': response_dict['descendants'],
    }
<span class="CodeAnnotationHang" aria-label="annotation6">❻</span>     submission_dicts.append(submission_dict)

<span class="CodeAnnotationHang" aria-label="annotation7">❼</span> submission_dicts = sorted(submission_dicts, key=itemgetter('comments'),
                            reverse=True)

<span class="CodeAnnotationHang" aria-label="annotation8">❽</span> for submission_dict in submission_dicts:
    print(f"\nTitle: {submission_dict['title']}")
    print(f"Discussion link: {submission_dict['hn_link']}")
    print(f"Comments: {submission_dict['comments']}")</code></pre>
<p>First, we make an API call and print the status of the response <span class="CodeAnnotation" aria-label="annotation1">❶</span>. This API call returns a list containing the IDs of up to 500 of the most popular articles on Hacker News at the time the call is issued. We then convert the response object to a Python list <span class="CodeAnnotation" aria-label="annotation2">❷</span>, which we assign to <code>submission_ids</code>. We’ll use these IDs to build a set of dictionaries, each of which contains information about one of the current submissions.</p>
<p>We set up an empty list called <code>submission_dicts</code> to store these dictionaries <span class="CodeAnnotation" aria-label="annotation3">❸</span>. We then loop through the IDs of the top 30 submissions. We make a new API call for each submission by generating a URL that includes the current value of <code>submission_id</code> <span class="CodeAnnotation" aria-label="annotation4">❹</span>. We print the status of each request along with its ID, so we can see whether it’s successful.</p>
<p>Next, we create a dictionary for the submission currently being processed <span class="CodeAnnotation" aria-label="annotation5">❺</span>. We store the title of the submission, a link to the discussion page for that item, and the number of comments the article has received so far. Then we append each <code>submission_dict</code> to the list <code>submission_dicts</code> <span class="CodeAnnotation" aria-label="annotation6">❻</span>.</p>
<p>Each submission on Hacker News is ranked according to an overall score based on a number of factors, including how many times it’s been voted on, how many comments it’s received, and how recent the submission is. We want to sort the list of dictionaries by the number of comments. To do this, we use a function called <code>itemgetter()</code> <span class="CodeAnnotation" aria-label="annotation7">❼</span>, which comes from the <code>operator</code> module. We pass this function the key <code>'comments'</code>, and it pulls the value associated with that key from each dictionary in the list. The <code>sorted()</code> function then uses this value as its basis for sorting the list. We sort the list in reverse order, to place the most-commented stories first.</p>
<p>Once the list is sorted, we loop through the list <span class="CodeAnnotation" aria-label="annotation8">❽</span> and print out three pieces of information about each of the top submissions: the title, a link <span epub:type="pagebreak" title="371" id="Page_371"/>to the discussion page, and the number of comments the submission currently has:</p>
<pre><code>Status code: 200
id: 31390506    status: 200
id: 31389893    status: 200
id: 31390742    status: 200
<var>--snip--</var>

Title: Fly.io: The reclaimer of Heroku's magic
Discussion link: https://news.ycombinator.com/item?id=31390506
Comments: 134

Title: The weird Hewlett Packard FreeDOS option
Discussion link: https://news.ycombinator.com/item?id=31389893
Comments: 64

Title: Modern JavaScript Tutorial
Discussion link: https://news.ycombinator.com/item?id=31390742
Comments: 20
<var>--snip--</var></code></pre>
<p>You would use a similar process to access and analyze information with any API. With this data, you could make a visualization showing which submissions have inspired the most active recent discussions. This is also the basis for apps that provide a customized reading experience for sites like Hacker News. To learn more about what kind of information you can access through the Hacker News API, visit the documentation page at <a href="https://github.com/HackerNews/API" class="LinkURL">https://github.com/HackerNews/API</a>.</p>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="note">
<h2><span class="NoteHead">Note</span></h2>
<p>	Hacker News sometimes allows companies it supports to make special hiring posts, and comments are disabled on these posts. If you run this program while one of these posts is present, you’ll get a <code>KeyError</code>. If this causes an issue, you can wrap the code that builds <code>submission_dict</code> in a <code>try-except</code> block and skip over these posts.</p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="box">
<h2>Try It Yourself</h2>
<p class="BoxBodyCustom"><span id="h2-502703c17-13" class="BoxNumber">17-1.	Other Languages:</span> Modify the API call in <em>python_repos.py</em> so it generates a chart showing the most popular projects in other languages. Try languages such as <em>JavaScript</em>, <em>Ruby</em>, <em>C</em>, <em>Java</em>, <em>Perl</em>, <em>Haskell</em>, and <em>Go</em>.</p>
<p class="BoxBodyCustom"><span id="h2-502703c17-14" class="BoxNumber">17-2.	Active Discussions:</span> Using the data from <em>hn_submissions.py</em>, make a bar chart showing the most active discussions currently happening on Hacker News. The height of each bar should correspond to the number of comments each submission has. The label for each bar should include the submission’s title and act as a link to the discussion page for that submission. If you get a <code>KeyError</code> when creating a chart, use a <code>try-except</code> block to skip over the promotional posts.</p>
<p class="BoxBodyCustom"><span id="h2-502703c17-15" class="BoxNumber">17-3.	<span epub:type="pagebreak" title="372" id="Page_372"/>Testing python_repos.py:</span> In <em>python_repos.py</em>, we printed the value of <code>status_code</code> to make sure the API call was successful. Write a program called <em>test_python_repos.py</em> that uses <code>pytest</code> to assert that the value of <code>status_code</code> is 200. Figure out some other assertions you can make: for example, that the number of items returned is expected and that the total number of repositories is greater than a certain amount.</p>
<p class="BoxBodyCustom"><span id="h2-502703c17-16" class="BoxNumber">17-4.	Further Exploration:</span> Visit the documentation for Plotly and either the GitHub API or the Hacker News API. Use some of the information you find there to either customize the style of the plots we’ve already made or pull some different information and create your own visualizations. If you’re curious about exploring other APIs, take a look at the APIs mentioned in the GitHub repository at <a href="https://github.com/public-apis" class="LinkURL">https://github.com/public-apis</a>.</p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<h2 id="h1-502703c17-0004">Summary</h2>
<p class="BodyFirst">In this chapter, you learned how to use APIs to write self-contained programs that automatically gather the data they need and use that data to create a visualization. You used the GitHub API to explore the most-starred Python projects on GitHub, and you also looked briefly at the Hacker News API. You learned how to use the Requests package to automatically issue an API call and how to process the results of that call. We also introduced some Plotly settings that further customize the appearance of the charts you generate.</p>
<p>In the next chapter, you’ll use Django to build a web application as your final project.</p>
</section>
</div>
<div id="sbo-rt-content"><section>
<header>
<h1 class="chapter">
<span class="ChapterNumber"><span epub:type="pagebreak" title="373" id="Page_373"/>18</span><br/>
<span class="ChapterTitle">Getting Started with Django</span></h1>
</header>
<figure class="opener">
<img src="Images/chapterart.png" alt="" width="406" height="406"/>
</figure>
<p class="ChapterIntro">As the internet has evolved, the line between websites and mobile apps has blurred. Websites and apps both help users interact with data in a variety of ways. Fortunately, you can use Django to build a single project that serves a dynamic website as well as a set of mobile apps. <em>Django</em> is Python’s most popular <em>web framework</em>, a set of tools designed for building interactive web applications. In this chapter, you’ll learn how to use Django to build a project called Learning Log, an online journal system that lets you keep track of information you’ve learned about different topics.</p>
<p>We’ll write a specification for this project, and then define models for the data the app will work with. We’ll use Django’s admin system to enter some initial data, and then write views and templates so Django can build the site’s pages.</p>
<p>Django can respond to page requests and make it easier to read and write to a database, manage users, and much more. In <span class="xref" itemid="xref_target_Chapters 19">Chapters 19</span> and <span class="xref" itemid="xref_target_20">20</span>, <span epub:type="pagebreak" title="374" id="Page_374"/>you’ll refine the Learning Log project, and then deploy it to a live server so you (and everyone else in the world) can use it.</p>
<h2 id="h1-502703c18-0001">Setting Up a Project</h2>
<p class="BodyFirst">When starting work on something as significant as a web app, you first need to describe the project’s goals in a specification, or <em>spec</em>. Once you have a clear set of goals, you can start to identify manageable tasks to achieve those goals.</p>
<p>In this section, we’ll write a spec for Learning Log and start working on the first phase of the project. This will involve setting up a virtual environment and building out the initial aspects of a Django project.</p>
<h3 id="h2-502703c18-0001">Writing a Spec</h3>
<p class="BodyFirst">A full spec details the project goals, describes the project’s functionality, and discusses its appearance and user interface. Like any good project or business plan, a spec should keep you focused and help keep your project on track. We won’t write a full project spec here, but we’ll lay out a few clear goals to keep the development process focused. Here’s the spec we’ll use:</p>
<blockquote class="blockquote">
<p class="Blockquote">We’ll write a web app called Learning Log that allows users to log the topics they’re interested in and make journal entries as they learn about each topic. The Learning Log home page will describe the site and invite users to either register or log in. Once logged in, a user can create new topics, add new entries, and read and edit existing entries.</p>
</blockquote>
<p>When you’re researching a new topic, maintaining a journal of what you’ve learned can help you keep track of new information and information you’ve already found. This is especially true when studying technical subjects. A good app, like the one we’ll be creating, can help make this process more efficient.</p>
<h3 id="h2-502703c18-0002">Creating a Virtual Environment</h3>
<p class="BodyFirst">To work with Django, we’ll first set up a virtual environment. A <em>virtual environment </em>is a place on your system where you can install packages and isolate them from all other Python packages. Separating one project’s libraries from other projects is beneficial and will be necessary when we deploy Learning Log to a server in <span class="xref" itemid="xref_target_Chapter 20">Chapter 20</span>.</p>
<p>Create a new directory for your project called <em>learning_log</em>, switch to that directory in a terminal, and enter the following code to create a virtual environment:</p>
<pre><code>learning_log$ <b>python -m venv ll_env</b>
learning_log$</code></pre>
<p>Here we’re running the <code>venv</code> virtual environment module and using it to create an environment named <em>ll_env</em> (note that this name starts with <span epub:type="pagebreak" title="375" id="Page_375"/>two lowercase <em>L</em>s, not two ones). If you use a command such as <code>python3</code> when running programs or installing packages, make sure to use that command here.</p>
<h3 id="h2-502703c18-0003">Activating the Virtual Environment</h3>
<p class="BodyFirst">Now we need to activate the virtual environment, using the following command:</p>
<pre><code>learning_log$ <b>source ll_env/bin/activate</b>
(ll_env)learning_log$</code></pre>
<p>This command runs the script <em>activate</em> in <em>ll_env/bin/</em>. When the environment is active, you’ll see the name of the environment in parentheses. This indicates that you can install new packages to the environment and use packages that have already been installed. Packages you install in <em>ll_env</em> will not be available when the environment is inactive.</p>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="note">
<h2><span class="NoteHead">Note</span></h2>
<p>	If you’re using Windows, use the command <code class="bold">ll_env\Scripts\activate</code> (without the word <code>source</code>) to activate the virtual environment. If you’re using PowerShell, you might need to capitalize <code>Activate</code>.</p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<p>To stop using a virtual environment, enter <code class="bold">deactivate</code>:</p>
<pre><code>(ll_env)learning_log$ <b>deactivate</b>
learning_log$</code></pre>
<p>The environment will also become inactive when you close the terminal it’s running in.</p>
<h3 id="h2-502703c18-0004">Installing Django</h3>
<p class="BodyFirst">With the virtual environment activated, enter the following to update pip and install Django:</p>
<pre><code>(ll_env)learning_log$ <b>pip install --upgrade pip</b>
(ll_env)learning_log$ <b>pip install django</b>
Collecting django
<var>--snip--</var>
Installing collected packages: sqlparse, asgiref, django
Successfully installed asgiref-3.5.2 django-4.1 sqlparse-0.4.2
(ll_env)learning_log$</code></pre>
<p>Because it downloads resources from a variety of sources, pip is upgraded fairly often. It’s a good idea to upgrade pip whenever you make a new virtual environment.</p>
<p>We’re working in a virtual environment now, so the command to install Django is the same on all systems. There’s no need to use longer commands, such as <code>python -m pip install </code><var>package_name</var>, or to include the <code>--user</code> flag. Keep in mind that Django will be available only when the <em>ll_env</em> environment is active.</p>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="note">
<span epub:type="pagebreak" title="376" id="Page_376"/><h2><span class="NoteHead">Note</span></h2>
<p>	Django releases a new version about every eight months, so you may see a newer version when you install Django. This project will most likely work as it’s written here, even on newer versions of Django. If you want to make sure to use the same version of Django you see here, use the command <code class="bold">pip install django==4.1.*</code>. This will install the latest release of Django 4.1. If you have any issues related to the version you’re using, see the online resources for this book at <a href="https://ehmatthes.github.io/pcc_3e" class="LinkURL">https://ehmatthes.github.io/pcc_3e</a>.</p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<h3 id="h2-502703c18-0005">Creating a Project in Django</h3>
<p class="BodyFirst">Without leaving the active virtual environment (remember to look for <em>ll_env</em> in parentheses in the terminal prompt), enter the following commands to create a new project:</p>
<pre><code><span class="CodeAnnotationHang" aria-label="annotation1">❶</span> (ll_env)learning_log$ <b>django-admin startproject ll_project .</b>
<span class="CodeAnnotationHang" aria-label="annotation2">❷</span> (ll_env)learning_log$ <b>ls</b>
ll_env ll_project manage.py
<span class="CodeAnnotationHang" aria-label="annotation3">❸</span> (ll_env)learning_log$ <b>ls ll_project</b>
__init__.py asgi.py settings.py urls.py wsgi.py</code></pre>
<p>The <code>startproject</code> command <span class="CodeAnnotation" aria-label="annotation1">❶</span> tells Django to set up a new project called <em>ll_project</em>. The dot (<code>.</code>) at the end of the command creates the new project with a directory structure that will make it easy to deploy the app to a server when we’re finished developing it.</p>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="note">
<h2><span class="NoteHead">Note</span></h2>
<p>	Don’t forget this dot, or you might run into some configuration issues when you deploy the app. If you forget the dot, delete the files and folders that were created (except <em>ll_env</em>) and run the command again.</p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<p>Running the <code>ls</code> command (<code>dir</code> on Windows) <span class="CodeAnnotation" aria-label="annotation2">❷</span> shows that Django has created a new directory called <em>ll_project</em>. It also created a <em>manage.py</em> file, which is a short program that takes in commands and feeds them to the relevant part of Django. We’ll use these commands to manage tasks, such as working with databases and running servers.</p>
<p>The <em>ll_project</em> directory contains four files <span class="CodeAnnotation" aria-label="annotation3">❸</span>; the most important are <em>settings.py</em>, <em>urls.py</em>, and <em>wsgi.py</em>. The <em>settings.py</em> file controls how Django interacts with your system and manages your project. We’ll modify a few of these settings and add some settings of our own as the project evolves. The <em>urls.py</em> file tells Django which pages to build in response to browser requests. The <em>wsgi.py</em> file helps Django serve the files it creates. The filename is an acronym for “web server gateway interface.”</p>
<h3 id="h2-502703c18-0006">Creating the Database</h3>
<p class="BodyFirst">Django stores most of the information for a project in a database, so next we need to create a database that Django can work with. Enter the following command (still in an active environment):</p>
<pre><code>(ll_env)learning_log$ <b>python manage.py migrate</b>
<span class="CodeAnnotationHang" aria-label="annotation1">❶</span> Operations to perform:
<span epub:type="pagebreak" title="377" id="Page_377"/>  Apply all migrations: admin, auth, contenttypes, sessions
Running migrations:
  Applying contenttypes.0001_initial... OK
  Applying auth.0001_initial... OK
<var>  --snip--</var>
  Applying sessions.0001_initial... OK
<span class="CodeAnnotationHang" aria-label="annotation2">❷</span> (ll_env)learning_log$ <b>ls</b>
db.sqlite3 ll_env ll_project manage.py</code></pre>
<p>Anytime we modify a database, we say we’re <em>migrating</em> the database. Issuing the <code>migrate</code> command for the first time tells Django to make sure the database matches the current state of the project. The first time we run this command in a new project using SQLite (more about SQLite in a moment), Django will create a new database for us. Here, Django reports that it will prepare the database to store information it needs to handle administrative and authentication tasks <span class="CodeAnnotation" aria-label="annotation1">❶</span>.</p>
<p>Running the <code>ls</code> command shows that Django created another file called <em>db.sqlite3</em> <span class="CodeAnnotation" aria-label="annotation2">❷</span>. <em>SQLite</em> is a database that runs off a single file; it’s ideal for writing simple apps because you won’t have to pay much attention to managing the database.</p>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="note">
<h2><span class="NoteHead">Note</span></h2>
<p>	In an active virtual environment, use the command <code>python</code> to run <code>manage.py</code> commands, even if you use something different, like <code>python3</code>, to run other programs. In a virtual environment, the command <code>python</code> refers to the version of Python that was used to create the virtual environment.</p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<h3 id="h2-502703c18-0007">Viewing the Project</h3>
<p class="BodyFirst">Let’s make sure that Django has set up the project properly. Enter the <code class="bold">runserver</code> command to view the project in its current state:</p>
<pre><code>(ll_env)learning_log$ <b>python manage.py runserver</b>
Watching for file changes with StatReloader
Performing system checks...

<span class="CodeAnnotationHang" aria-label="annotation1">❶</span> System check identified no issues (0 silenced).
May 19, 2022 - 21:52:35
<span class="CodeAnnotationHang" aria-label="annotation2">❷</span> Django version 4.1, using settings 'll_project.settings'
<span class="CodeAnnotationHang" aria-label="annotation3">❸</span> Starting development server at http://127.0.0.1:8000/
Quit the server with CONTROL-C.</code></pre>
<p>Django should start a server called the <em>development server</em>, so you can view the project on your system to see how well it works. When you request a page by entering a URL in a browser, the Django server responds to that request by building the appropriate page and sending it to the browser.</p>
<p>Django first checks to make sure the project is set up properly <span class="CodeAnnotation" aria-label="annotation1">❶</span>; it then reports the version of Django in use and the name of the settings file in use <span class="CodeAnnotation" aria-label="annotation2">❷</span>. Finally, it reports the URL where the project is being served <span class="CodeAnnotation" aria-label="annotation3">❸</span>. The URL <em>http://127.0.0.1:8000/</em> indicates that the project is listening for requests on port 8000 on your computer, which is called a localhost. The <span epub:type="pagebreak" title="378" id="Page_378"/>term <em>localhost</em> refers to a server that only processes requests on your system; it doesn’t allow anyone else to see the pages you’re developing.</p>
<p>Open a web browser and enter the URL <em>http://localhost:8000/</em>, or <em>http://127.0.0.1:8000/</em> if the first one doesn’t work. You should see something like <a href="#figure18-1" id="figureanchor18-1">Figure 18-1</a>: a page that Django creates to let you know everything is working properly so far. Keep the server running for now, but when you want to stop the server, press CTRL-C in the terminal where the <code>runserver</code> command was issued.</p>
<figure>
<img src="Images/f18001.png" class="keyline" alt="" width="694" height="398"/>
<figcaption><p><a id="figure18-1">Figure 18-1</a>: Everything is working so far.</p></figcaption>
</figure>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="note">
<h2><span class="NoteHead">Note</span></h2>
<p>	If you receive the error message “That port is already in use,” tell Django to use a different port by entering <code class="bold">python manage.py runserver 8001</code> and then cycling through higher numbers until you find an open port.</p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="box">
<h2>Try It Yourself</h2>
<p class="BoxBodyCustom"><span id="h2-502703c18-08" class="BoxNumber">18-1.	New Projects:</span> To get a better idea of what Django does, build a couple empty projects and look at what Django creates. Make a new folder with a simple name, like <em>tik_gram</em> or <em>insta_tok</em> (outside of your <em>learning_log</em> directory), navigate to that folder in a terminal, and create a virtual environment. Install Django and run the command <code class="bold">django-admin.py startproject tg_project .</code> (making sure to include the dot at the end of the command).</p>
<p class="BoxBody">Look at the files and folders this command creates, and compare them to Learning Log. Do this a few times, until you’re familiar with what Django creates when starting a new project. Then delete the project directories if you wish.</p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<h2 id="h1-502703c18-0002"><span epub:type="pagebreak" title="379" id="Page_379"/>Starting an App</h2>
<p class="BodyFirst">A Django <em>project</em> is organized as a group of individual <em>apps</em> that work together to make the project work as a whole. For now, we’ll create one app to do most of our project’s work. We’ll add another app in <span class="xref" itemid="xref_target_Chapter 19">Chapter 19</span> to manage user accounts.</p>
<p>You should leave the development server running in the terminal window you opened earlier. Open a new terminal window (or tab) and navigate to the directory that contains <em>manage.py</em>. Activate the virtual environment, and then run the <code class="bold">startapp</code> command:</p>
<pre><code>learning_log$ <b>source ll_env/bin/activate</b>
(ll_env)learning_log$ <b>python manage.py startapp learning_logs</b>
<span class="CodeAnnotationHang" aria-label="annotation1">❶</span> (ll_env)learning_log$ <b>ls</b>
db.sqlite3 learning_logs ll_env ll_project manage.py
<span class="CodeAnnotationHang" aria-label="annotation2">❷</span> (ll_env)learning_log$ <b>ls learning_logs/</b>
__init__.py admin.py apps.py migrations models.py tests.py views.py</code></pre>
<p>The command <code>startapp </code><var>appname</var> tells Django to create the infrastructure needed to build an app. When you look in the project directory now, you’ll see a new folder called <em>learning_logs</em> <span class="CodeAnnotation" aria-label="annotation1">❶</span>. Use the <code class="bold">ls</code> command to see what Django has created <span class="CodeAnnotation" aria-label="annotation2">❷</span>. The most important files are <em>models.py</em>, <em>admin.py</em>, and <em>views.py</em>. We’ll use <em>models.py </em>to define the data we want to manage in our app. We’ll look at <em>admin.py</em> and <em>views.py</em> a little later.</p>
<h3 id="h2-502703c18-0008">Defining Models</h3>
<p class="BodyFirst">Let’s think about our data for a moment. Each user will need to create a number of topics in their learning log. Each entry they make will be tied to a topic, and these entries will be displayed as text. We’ll also need to store the timestamp of each entry so we can show users when they made each one.</p>
<p>Open the file <em>models.py</em> and look at its existing content:</p>
<p class="CodeLabel"><b>models.py</b></p>
<pre><code>from django.db import models

# Create your models here.</code></pre>
<p>A module called <code>models</code> is being imported, and we’re being invited to create models of our own. A <em>model</em> tells Django how to work with the data that will be stored in the app. A model is a class; it has attributes and methods, just like every class we’ve discussed. Here’s the model for the topics users will store:</p>
<pre><code><span class="LiteralGray">from django.db import models</span>

class Topic(models.Model):
    """A topic the user is learning about."""
<span class="CodeAnnotationHang" aria-label="annotation1">❶</span>     text = models.CharField(max_length=200)
<span class="CodeAnnotationHang" aria-label="annotation2">❷</span>     date_added = models.DateTimeField(auto_now_add=True)

<span epub:type="pagebreak" title="380" id="Page_380"/><span class="CodeAnnotationHang" aria-label="annotation3">❸</span>     def __str__(self):
        """Return a string representation of the model."""
        return self.text</code></pre>
<p>We’ve created a class called <code>Topic</code>, which inherits from <code>Model</code>—a parent class included in Django that defines a model’s basic functionality. We add two attributes to the <code>Topic</code> class: <code>text</code> and <code>date_added</code>.</p>
<p>The <code>text</code> attribute is a <code>CharField</code>, a piece of data that’s made up of characters or text <span class="CodeAnnotation" aria-label="annotation1">❶</span>. You use <code>CharField</code> when you want to store a small amount of text, such as a name, a title, or a city. When we define a <code>CharField</code> attribute, we have to tell Django how much space it should reserve in the database. Here we give it a <code>max_length</code> of <code>200</code> characters, which should be enough to hold most topic names.</p>
<p>The <code>date_added</code> attribute is a <code>DateTimeField</code>, a piece of data that will record a date and time <span class="CodeAnnotation" aria-label="annotation2">❷</span>. We pass the argument <code>auto_now_add=True</code>, which tells Django to automatically set this attribute to the current date and time whenever the user creates a new topic.</p>
<p>It’s a good idea to tell Django how you want it to represent an instance of a model. If a model has a <code>__str__()</code> method, Django calls that method whenever it needs to generate output referring to an instance of that model. Here we’ve written a <code>__str__()</code> method that returns the value assigned to the <code>text</code> attribute <span class="CodeAnnotation" aria-label="annotation3">❸</span>.</p>
<p>To see the different kinds of fields you can use in a model, see the “Model Field Reference” page at <a href="https://docs.djangoproject.com/en/4.1/ref/models/fields" class="LinkURL">https://docs.djangoproject.com/en/4.1/ref/models/fields</a>. You won’t need all the information right now, but it will be extremely useful when you’re developing your own Django projects.</p>
<h3 id="h2-502703c18-0009">Activating Models</h3>
<p class="BodyFirst">To use our models, we have to tell Django to include our app in the overall project. Open <em>settings.py</em> (in the <em>ll_project</em> directory); you’ll see a section that tells Django which apps are installed in the project:</p>
<p class="CodeLabel"><b>settings.py</b></p>
<pre><code><var>--snip--</var>
INSTALLED_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
]
<var>--snip--</var></code></pre>
<p>Add our app to this list by modifying <code>INSTALLED_APPS</code> so it looks like this:</p>
<pre><code><em class="LiteralGrayItalic">--snip--</em>
<span class="LiteralGray">INSTALLED_APPS = [</span>
    # My apps.
    'learning_logs',

<span epub:type="pagebreak" title="381" id="Page_381"/>    # Default django apps.
<span class="LiteralGray">    'django.contrib.admin',</span>
<span class="LiteralGray">    </span><em class="LiteralGrayItalic">--snip--</em>
<span class="LiteralGray">]</span>
<em class="LiteralGrayItalic">--snip--</em></code></pre>
<p>Grouping apps together in a project helps keep track of them as the project grows to include more apps. Here we start a section called <code>My apps</code>, which includes only <code>'learning_logs'</code> for now. It’s important to place your own apps before the default apps, in case you need to override any behavior of the default apps with your own custom behavior.</p>
<p>Next, we need to tell Django to modify the database so it can store information related to the model <code>Topic</code>. From the terminal, run the following command:</p>
<pre><code>(ll_env)learning_log$ <b>python manage.py makemigrations learning_logs</b>
Migrations for 'learning_logs':
  learning_logs/migrations/0001_initial.py
    - Create model Topic
(ll_env)learning_log$</code></pre>
<p>The command <code>makemigrations</code> tells Django to figure out how to modify the database so it can store the data associated with any new models we’ve defined. The output here shows that Django has created a migration file called <em>0001_initial.py</em>. This migration will create a table for the model <code>Topic</code> in the database.</p>
<p>Now we’ll apply this migration and have Django modify the database for us:</p>
<pre><code>(ll_env)learning_log$ <b>python manage.py migrate</b>
Operations to perform:
  Apply all migrations: admin, auth, contenttypes, learning_logs, sessions
Running migrations:
  Applying learning_logs.0001_initial... OK</code></pre>
<p>Most of the output from this command is identical to the output from the first time we issued the <code>migrate</code> command. We need to check the last line in this output, where Django confirms that the migration for <code>learning_logs</code> worked <code>OK</code>.</p>
<p>Whenever we want to modify the data that Learning Log manages, we’ll follow these three steps: modify <em>models.py</em>, call <code>makemigrations</code> on <code>learning_logs</code>, and tell Django to <code>migrate</code> the project.</p>
<h3 id="h2-502703c18-0010">The Django Admin Site</h3>
<p class="BodyFirst">Django makes it easy to work with your models through its admin site. Django’s <em>admin site</em> is only meant to be used by the site’s administrators; it’s not meant for regular users. In this section, we’ll set up the admin site and use it to add some topics through the <code>Topic</code> model.</p>
<h4 id="h3-502703c18-0001"><span epub:type="pagebreak" title="382" id="Page_382"/>Setting Up a Superuser</h4>
<p class="BodyFirst">Django allows you to create a <em>superuser</em>, a user who has all privileges available on the site. A user’s <em>privileges</em> control the actions they can take. The most restrictive privilege settings allow a user to only read public information on the site. Registered users typically have the privilege of reading their own private data and some selected information available only to members. To effectively administer a project, the site owner usually needs access to all information stored on the site. A good administrator is careful with their users’ sensitive information, because users put a lot of trust into the apps they access.</p>
<p>To create a superuser in Django, enter the following command and respond to the prompts:</p>
<pre><code>(ll_env)learning_log$ <b>python manage.py createsuperuser</b>
<span class="CodeAnnotationHang" aria-label="annotation1">❶</span> Username (leave blank to use 'eric'): <b>ll_admin</b>
<span class="CodeAnnotationHang" aria-label="annotation2">❷</span> Email address:
<span class="CodeAnnotationHang" aria-label="annotation3">❸</span> Password:
Password (again):
Superuser created successfully.
(ll_env)learning_log$</code></pre>
<p>When you issue the command <code>createsuperuser</code>, Django prompts you to enter a username for the superuser <span class="CodeAnnotation" aria-label="annotation1">❶</span>. Here I’m using <code>ll_admin</code>, but you can enter any username you want. You can enter an email address or just leave this field blank <span class="CodeAnnotation" aria-label="annotation2">❷</span>. You’ll need to enter your password twice <span class="CodeAnnotation" aria-label="annotation3">❸</span>.</p>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="note">
<h2><span class="NoteHead">Note</span></h2>
<p>	Some sensitive information can be hidden from a site’s administrators. For example, Django doesn’t store the password you enter; instead, it stores a string derived from the password, called a <em>hash</em>. Each time you enter your password, Django hashes your entry and compares it to the stored hash. If the two hashes match, you’re authenticated. By requiring hashes to match, Django ensures that if an attacker gains access to a site’s database, they’ll be able to read the stored hashes but not the passwords. When a site is set up properly, it’s almost impossible to get the original passwords from the hashes.</p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<h4 id="h3-502703c18-0002">Registering a Model with the Admin Site</h4>
<p class="BodyFirst">Django includes some models in the admin site automatically, such as <code>User</code> and <code>Group</code>, but the models we create need to be added manually.</p>
<p>When we started the <code>learning_logs</code> app, Django created an <em>admin.py</em> file in the same directory as <em>models.py</em>. Open the <em>admin.py</em> file:</p>
<p class="CodeLabel"><b>admin.py</b></p>
<pre><code>from django.contrib import admin

# Register your models here.</code></pre>
<p><span epub:type="pagebreak" title="383" id="Page_383"/>To register <code>Topic</code> with the admin site, enter the following:</p>
<pre><code><span class="LiteralGray">from django.contrib import admin</span>

from .models import Topic

admin.site.register(Topic)</code></pre>
<p>This code first imports the model we want to register, <code>Topic</code>. The dot in front of <code>models</code> tells Django to look for <em>models.py</em> in the same directory as <em>admin.py</em>. The code <code>admin.site.register()</code> tells Django to manage our model through the admin site.</p>
<p>Now use the superuser account to access the admin site. Go to <em>http://localhost:8000/admin/</em> and enter the username and password for the superuser you just created. You should see a screen similar to the one shown in <a href="#figure18-2" id="figureanchor18-2">Figure 18-2</a>. This page allows you to add new users and groups, and change existing ones. You can also work with data related to the <code>Topic</code> model that we just defined.</p>
<figure>
<img src="Images/f18002.png" class="keyline" alt="" width="694" height="289"/>
<figcaption><p><a id="figure18-2">Figure 18-2</a>: The admin site with <span class="LiteralInCaption"><code>Topic</code></span> included</p></figcaption>
</figure>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="note">
<h2><span class="NoteHead">Note</span></h2>
<p>	If you see a message in your browser that the web page is not available, make sure you still have the Django server running in a terminal window. If you don’t, activate a virtual environment and reissue the command <code class="bold">python manage.py runserver</code>. If you’re having trouble viewing your project at any point in the development process, closing any open terminals and reissuing the <code class="bold">runserver</code> command is a good first troubleshooting step.</p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<h4 id="h3-502703c18-0003">Adding Topics</h4>
<p class="BodyFirst">Now that <code>Topic</code> has been registered with the admin site, let’s add our first topic. Click <b>Topics</b> to go to the Topics page, which is mostly empty, because we have no topics to manage yet. Click <b>Add Topic</b>, and a form for adding a new topic appears. Enter <code class="bold">Chess</code> in the first box and click <b>Save</b>. You’ll be sent back to the Topics admin page, and you’ll see the topic you just created.</p>
<p>Let’s create a second topic so we’ll have more data to work with. Click <b>Add Topic</b> again, and enter <code class="bold">Rock Climbing</code>. Click <b>Save</b>, and you’ll be sent back to the main Topics page again. Now you’ll see Chess and Rock Climbing listed.</p>
<h3 id="h2-502703c18-0011"><span epub:type="pagebreak" title="384" id="Page_384"/>Defining the Entry Model</h3>
<p class="BodyFirst">For a user to record what they’ve been learning about chess and rock climbing, we need to define a model for the kinds of entries users can make in their learning logs. Each entry needs to be associated with a particular topic. This relationship is called a <em>many-to-one relationship</em>, meaning many entries can be associated with one topic.</p>
<p>Here’s the code for the <code>Entry</code> model. Place it in your <em>models.py </em>file:</p>
<p class="CodeLabel"><b>models.py</b></p>
<pre><code><span class="LiteralGray">from django.db import models</span>

<span class="LiteralGray">class Topic(models.Model):</span>
<span class="LiteralGray">    </span><em class="LiteralGrayItalic">--snip--</em>

<span class="CodeAnnotationHang" aria-label="annotation1">❶</span> class Entry(models.Model):
    """Something specific learned about a topic."""
<span class="CodeAnnotationHang" aria-label="annotation2">❷</span>     topic = models.ForeignKey(Topic, on_delete=models.CASCADE)
<span class="CodeAnnotationHang" aria-label="annotation3">❸</span>     text = models.TextField()
    date_added = models.DateTimeField(auto_now_add=True)

<span class="CodeAnnotationHang" aria-label="annotation4">❹</span>     class Meta:
        verbose_name_plural = 'entries'

    def __str__(self):
        """Return a simple string representing the entry."""
<span class="CodeAnnotationHang" aria-label="annotation5">❺</span>         return f"{self.text[:50]}..."</code></pre>
<p>The <code>Entry</code> class inherits from Django’s base <code>Model</code> class, just as <code>Topic</code> did <span class="CodeAnnotation" aria-label="annotation1">❶</span>. The first attribute, <code>topic</code>, is a <code>ForeignKey</code> instance <span class="CodeAnnotation" aria-label="annotation2">❷</span>. A <em>foreign key</em> is a database term; it’s a reference to another record in the database. This is the code that connects each entry to a specific topic. Each topic is assigned a <em>key</em>, or ID, when it’s created. When Django needs to establish a connection between two pieces of data, it uses the keys associated with each piece of information. We’ll use these connections shortly to retrieve all the entries associated with a certain topic. The <code>on_delete=models.CASCADE</code> argument tells Django that when a topic is deleted, all the entries associated with that topic should be deleted as well. This is known as a <em>cascading delete</em>.</p>
<p>Next is an attribute called <code>text</code>, which is an instance of <code>TextField</code> <span class="CodeAnnotation" aria-label="annotation3">❸</span>. This kind of field doesn’t need a size limit, because we don’t want to limit the size of individual entries. The <code>date_added</code> attribute allows us to present entries in the order they were created, and to place a timestamp next to each entry.</p>
<p>The <code>Meta</code> class is nested inside the <code>Entry</code> class <span class="CodeAnnotation" aria-label="annotation4">❹</span>. The <code>Meta</code> class holds extra information for managing a model; here, it lets us set a special attribute telling Django to use <code>Entries </code>when it needs to refer to more than one entry. Without this, Django would refer to multiple entries as <code>Entrys</code>.</p>
<p>The <code>__str__()</code> method tells Django which information to show when it refers to individual entries. Because an entry can be a long body of text, <code>__str__()</code> returns just the first <code>50</code> characters of <code>text</code> <span class="CodeAnnotation" aria-label="annotation5">❺</span>. We also add an ellipsis to clarify that we’re not always displaying the entire entry.</p>
<h3 id="h2-502703c18-0012"><span epub:type="pagebreak" title="385" id="Page_385"/>Migrating the Entry Model</h3>
<p class="BodyFirst">Because we’ve added a new model, we need to migrate the database again. This process will become quite familiar: you modify <em>models.py</em>, run the command <code class="bold">python manage.py makemigrations </code><var class="bold">app_name</var>, and then run the command <code class="bold">python manage.py migrate</code>.</p>
<p>Migrate the database and check the output by entering the following commands:</p>
<pre><code>(ll_env)learning_log$ <b>python manage.py makemigrations learning_logs</b>
Migrations for 'learning_logs':
<span class="CodeAnnotationHang" aria-label="annotation1">❶</span>   learning_logs/migrations/0002_entry.py
    - Create model Entry
(ll_env)learning_log$ <b>python manage.py migrate</b>
Operations to perform:
<var>  --snip--</var>
<span class="CodeAnnotationHang" aria-label="annotation2">❷</span>   Applying learning_logs.0002_entry... OK</code></pre>
<p>A new migration called <em>0002_entry.py</em> is generated, which tells Django how to modify the database to store information related to the model <code>Entry</code> <span class="CodeAnnotation" aria-label="annotation1">❶</span>. When we issue the <code>migrate</code> command, we see that Django applied this migration and everything worked properly <span class="CodeAnnotation" aria-label="annotation2">❷</span>.</p>
<h3 id="h2-502703c18-0013">Registering Entry with the Admin Site</h3>
<p class="BodyFirst">We also need to register the <code>Entry</code> model. Here’s what <em>admin.py</em> should look like now:</p>
<p class="CodeLabel"><b>admin.py</b></p>
<pre><code><span class="LiteralGray">from django.contrib import admin</span>

from .models import Topic, Entry

<span class="LiteralGray">admin.site.register(Topic)</span>
admin.site.register(Entry)</code></pre>
<p>Go back to <em>http://localhost/admin/</em>, and you should see Entries listed under <em>Learning_Logs</em>. Click the <b>Add</b> link for Entries, or click <b>Entries</b> and then choose <b>Add entry</b>. You should see a drop-down list to select the topic you’re creating an entry for and a text box for adding an entry. Select <b>Chess</b> from the drop-down list, and add an entry. Here’s the first entry I made:</p>
<blockquote class="blockquote">
<p class="Blockquote">The opening is the first part of the game, roughly the first ten moves or so. In the opening, it’s a good idea to do three things—bring out your bishops and knights, try to control the center of the board, and castle your king.</p>

<p class="Blockquote">Of course, these are just guidelines. It will be important to learn when to follow these guidelines and when to disregard these suggestions.</p></blockquote>
<p>When you click <b>Save</b>, you’ll be brought back to the main admin page for entries. Here, you’ll see the benefit of using <code>text[:50]</code> as the string representation for each entry; it’s much easier to work with multiple entries in <span epub:type="pagebreak" title="386" id="Page_386"/>the admin interface if you see only the first part of an entry, rather than the entire text of each entry.</p>
<p>Make a second entry for Chess and one entry for Rock Climbing so we have some initial data. Here’s a second entry for Chess:</p>
<blockquote class="blockquote">
<p class="Blockquote">In the opening phase of the game, it’s important to bring out your bishops and knights. These pieces are powerful and maneuverable enough to play a significant role in the beginning moves of a game.</p>
</blockquote>
<p>And here’s a first entry for Rock Climbing:</p>
<blockquote class="blockquote">
<p class="Blockquote">One of the most important concepts in climbing is to keep your weight on your feet as much as possible. There’s a myth that climbers can hang all day on their arms. In reality, good climbers have practiced specific ways of keeping their weight over their feet whenever possible.</p>
</blockquote>
<p>These three entries will give us something to work with as we continue to develop Learning Log.</p>
<h3 id="h2-502703c18-0014">The Django Shell</h3>
<p class="BodyFirst">Now that we’ve entered some data, we can examine it programmatically through an interactive terminal session. This interactive environment is called the Django <em>shell</em>, and it’s a great environment for testing and troubleshooting your project. Here’s an example of an interactive shell session:</p>
<pre><code>(ll_env)learning_log$ <b>python manage.py shell</b>
<span class="CodeAnnotationHang" aria-label="annotation1">❶</span> &gt;&gt;&gt; <b>from learning_logs.models import Topic</b>
&gt;&gt;&gt; <b>Topic.objects.all()</b>
&lt;QuerySet [&lt;Topic: Chess&gt;, &lt;Topic: Rock Climbing&gt;]&gt;</code></pre>
<p>The command <code>python manage.py shell</code>, run in an active virtual environment, launches a Python interpreter that you can use to explore the data stored in your project’s database. Here, we import the model <code>Topic</code> from the <code>learning_logs.models</code> module <span class="CodeAnnotation" aria-label="annotation1">❶</span>. We then use the method <code>Topic.objects.all()</code> to get all instances of the model <code>Topic</code>; the list that’s returned is called a <em>queryset</em>.</p>
<p>We can loop over a queryset just as we’d loop over a list. Here’s how you can see the ID that’s been assigned to each topic object:</p>
<pre><code>&gt;&gt;&gt; <b>topics = Topic.objects.all()</b>
&gt;&gt;&gt; <b>for topic in topics:</b>
...     <b>print(topic.id, topic)</b>
...
1 Chess
2 Rock Climbing</code></pre>
<p>We assign the queryset to <code>topics</code> and then print each topic’s <code>id</code> attribute and the string representation of each topic. We can see that <code>Chess</code> has an ID of <code>1</code> and <code>Rock Climbing</code> has an ID of <code>2</code>.</p>
<p><span epub:type="pagebreak" title="387" id="Page_387"/>If you know the ID of a particular object, you can use the method <code>Topic.objects.get()</code> to retrieve that object and examine any attribute the object has. Let’s look at the <code>text</code> and <code>date_added</code> values for <code>Chess</code>:</p>
<pre><code>&gt;&gt;&gt; <b>t = Topic.objects.get(id=1)</b>
&gt;&gt;&gt; <b>t.text</b>
'Chess'
&gt;&gt;&gt; <b>t.date_added</b>
datetime.datetime(2022, 5, 20, 3, 33, 36, 928759,
    tzinfo=datetime.timezone.utc)</code></pre>
<p>We can also look at the entries related to a certain topic. Earlier, we defined the <code>topic</code> attribute for the <code>Entry</code> model. This was a <code>ForeignKey</code>, a connection between each entry and a topic. Django can use this connection to get every entry related to a certain topic, like this:</p>
<pre><code><span class="CodeAnnotationHang" aria-label="annotation1">❶</span> &gt;&gt;&gt; <b>t.entry_set.all()</b>
&lt;QuerySet [&lt;Entry: The opening is the first part of the game, roughly...&gt;, &lt;Entry:
In the opening phase of the game, it's important t...&gt;]&gt;</code></pre>
<p>To get data through a foreign key relationship, you use the lowercase name of the related model followed by an underscore and the word <code>set</code> <span class="CodeAnnotation" aria-label="annotation1">❶</span>. For example, say you have the models <code>Pizza</code> and <code>Topping</code>, and <code>Topping</code> is related to <code>Pizza</code> through a foreign key. If your object is called <code>my_pizza</code>, representing a single pizza, you can get all of the pizza’s toppings using the code <code>my_pizza.topping_set.all()</code>.</p>
<p>We’ll use this syntax when we begin to code the pages users can request. The shell is really useful for making sure your code retrieves the data you want it to. If your code works as you expect it to in the shell, it should also work properly in the files within your project. If your code generates errors or doesn’t retrieve the data you expect it to, it’s much easier to troubleshoot your code in the simple shell environment than within the files that generate web pages. We won’t refer to the shell much, but you should continue using it to practice working with Django’s syntax for accessing the data stored in the project.</p>
<p>Each time you modify your models, you’ll need to restart the shell to see the effects of those changes. To exit a shell session, press CTRL-D; on Windows, press CTRL-Z and then press ENTER.</p>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="box">
<h2>Try It Yourself</h2>
<p class="BoxBodyCustom"><span id="h2-502703c18-16" class="BoxNumber">18-2.	Short Entries:</span> The <code>__str__()</code> method in the <code>Entry</code> model currently appends an ellipsis to every instance of <code>Entry</code> when Django shows it in the admin site or the shell. Add an <code>if</code> statement to the <code>__str__()</code> method that adds an ellipsis <span epub:type="pagebreak" title="388" id="Page_388"/>only if the entry is longer than 50 characters. Use the admin site to add an entry that’s fewer than 50 characters in length, and check that it doesn’t have an ellipsis when viewed.</p>
<p class="BoxBodyCustom"><span id="h2-502703c18-17" class="BoxNumber">18-3.	The Django API:</span> When you write code to access the data in your project, you’re writing a <em>query</em>. Skim through the documentation for querying your data at <a href="https://docs.djangoproject.com/en/4.1/topics/db/queries" class="LinkURL">https://docs.djangoproject.com/en/4.1/topics/db/queries</a><em>.</em> Much of what you see will look new to you, but it will be quite useful as you start to work on your own projects.</p>
<p class="BoxBodyCustom"><span id="h2-502703c18-18" class="BoxNumber">18-4.	Pizzeria:</span> Start a new project called <code>pizzeria_project</code> with an app called <code>pizzas</code>. Define a model <code>Pizza</code> with a field called <code>name</code>, which will hold name values, such as <code>Hawaiian</code> and <code>Meat Lovers</code>. Define a model called <code>Topping</code> with fields called <code>pizza</code> and <code>name</code>. The <code>pizza</code> field should be a foreign key to <code>Pizza</code>, and <code>name</code> should be able to hold values such as <code>pineapple</code>, <code>Canadian bacon</code>, and <code>sausage</code>.</p>
<p class="BoxBody">Register both models with the admin site, and use the site to enter some pizza names and toppings. Use the shell to explore the data you entered.</p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<h2 id="h1-502703c18-0003">Making Pages: The Learning Log Home Page</h2>
<p class="BodyFirst">Making web pages with Django consists of three stages: defining URLs, writing views, and writing templates. You can do these in any order, but in this project we’ll always start by defining the URL pattern. A <em>URL pattern</em> describes the way the URL is laid out. It also tells Django what to look for when matching a browser request with a site URL, so it knows which page to return.</p>
<p>Each URL then maps to a particular view. The <em>view</em> function retrieves and processes the data needed for that page. The view function often renders the page using a <em>template</em>, which contains the overall structure of the page. To see how this works, let’s make the home page for Learning Log. We’ll define the URL for the home page, write its view function, and create a simple template.</p>
<p>Because we just want to ensure that Learning Log works as it’s supposed to, we’ll make a simple page for now. A functioning web app is fun to style when it’s complete; an app that looks good but doesn’t work well is pointless. For now, the home page will display only a title and a brief description.</p>
<h3 id="h2-502703c18-0015">Mapping a URL</h3>
<p class="BodyFirst">Users request pages by entering URLs into a browser and clicking links, so we’ll need to decide what URLs are needed. The home page URL is first: it’s the base URL people use to access the project. At the moment, the base URL, <em>http://localhost:8000/</em>, returns the default Django site that lets us know the project was set up correctly. We’ll change this by mapping the base URL to Learning Log’s home page.</p>
<p><span epub:type="pagebreak" title="389" id="Page_389"/>In the main <em>ll_project</em> folder, open the file <em>urls.py</em>. You should see the following code:</p>
<p class="CodeLabel"><b>ll_project/urls.py</b></p>
<pre><code><span class="CodeAnnotationHang" aria-label="annotation1">❶</span> from django.contrib import admin
from django.urls import path

<span class="CodeAnnotationHang" aria-label="annotation2">❷</span> urlpatterns = [
<span class="CodeAnnotationHang" aria-label="annotation3">❸</span>     path('admin/', admin.site.urls),
]</code></pre>
<p>The first two lines import the <code>admin</code> module and a function to build URL paths <span class="CodeAnnotation" aria-label="annotation1">❶</span>. The body of the file defines the <code>urlpatterns</code> variable <span class="CodeAnnotation" aria-label="annotation2">❷</span>. In this <em>urls.py</em> file, which defines URLs for the project as a whole, the <code>urlpatterns</code> variable includes sets of URLs from the apps in the project. The list includes the module <code>admin.site.urls</code>, which defines all the URLs that can be requested from the admin site <span class="CodeAnnotation" aria-label="annotation3">❸</span>.</p>
<p>We need to include the URLs for <code>learning_logs</code>, so add the following:</p>
<pre><code><span class="LiteralGray">from django.contrib import admin</span>
from django.urls import path, include

<span class="LiteralGray">urlpatterns = [</span>
<span class="LiteralGray">    path('admin/', admin.site.urls),</span>
<span class="LiteralGray">    </span>path('', include('learning_logs.urls')),
<span class="LiteralGray">]</span></code></pre>
<p>We’ve imported the <code>include()</code> function, and we’ve also added a line to include the module <code>learning_logs.urls</code>.</p>
<p>The default <em>urls.py</em> is in the <em>ll_project </em>folder; now we need to make a second <em>urls.py</em> file in the <em>learning_logs </em>folder. Create a new Python file, save it as <em>urls.py</em> in <em>learning_logs</em>, and enter this code into it:</p>
<p class="CodeLabel"><b>learning_logs/urls.py</b></p>
<pre><code><span class="CodeAnnotationHang" aria-label="annotation1">❶</span> """Defines URL patterns for learning_logs."""

<span class="CodeAnnotationHang" aria-label="annotation2">❷</span> from django.urls import path

<span class="CodeAnnotationHang" aria-label="annotation3">❸</span> from . import views

<span class="CodeAnnotationHang" aria-label="annotation4">❹</span> app_name = 'learning_logs'
<span class="CodeAnnotationHang" aria-label="annotation5">❺</span> urlpatterns = [
    # Home page
<span class="CodeAnnotationHang" aria-label="annotation6">❻</span>     path('', views.index, name='index'),
]</code></pre>
<p>To make it clear which <em>urls.py</em> we’re working in, we add a docstring at the beginning of the file <span class="CodeAnnotation" aria-label="annotation1">❶</span>. We then import the <code>path</code> function, which is needed when mapping URLs to views <span class="CodeAnnotation" aria-label="annotation2">❷</span>. We also import the <code>views</code> module <span class="CodeAnnotation" aria-label="annotation3">❸</span>; the dot tells Python to import the <em>views.py</em> module from the same directory as the current <em>urls.py</em> module. The variable <code>app_name</code> helps Django distinguish this <em>urls.py</em> file from files of the same name in other apps within the project <span class="CodeAnnotation" aria-label="annotation4">❹</span>. The variable <code>urlpatterns</code> in this module is a list of individual pages that can be requested from the <code>learning_logs</code> app <span class="CodeAnnotation" aria-label="annotation5">❺</span>.</p>
<p><span epub:type="pagebreak" title="390" id="Page_390"/>The actual URL pattern is a call to the <code>path()</code> function, which takes three arguments <span class="CodeAnnotation" aria-label="annotation6">❻</span>. The first argument is a string that helps Django route the current request properly. Django receives the requested URL and tries to route the request to a view. It does this by searching all the URL patterns we’ve defined to find one that matches the current request. Django ignores the base URL for the project (<em>http://localhost:8000/</em>), so the empty string (<code>''</code>) matches the base URL. Any other URL won’t match this pattern, and Django will return an error page if the URL requested doesn’t match any existing URL patterns.</p>
<p>The second argument in <code>path()</code> <span class="CodeAnnotation" aria-label="annotation6">❻</span> specifies which function to call in <em>views.py</em>. When a requested URL matches the pattern we’re defining, Django calls the <code>index()</code> function from <em>views.py</em>. (We’ll write this view function in the next section.) The third argument provides the name <em>index</em> for this URL pattern so we can refer to it more easily in other files throughout the project. Whenever we want to provide a link to the home page, we’ll use this name instead of writing out a URL.</p>
<h3 id="h2-502703c18-0016">Writing a View</h3>
<p class="BodyFirst">A view function takes in information from a request, prepares the data needed to generate a page, and then sends the data back to the browser. It often does this by using a template that defines what the page will look like.</p>
<p>The file <em>views.py</em> in <em>learning_logs</em> was generated automatically when we ran the command <code>python manage.py startapp</code>. Here’s what’s in <em>views.py</em> right now:</p>
<p class="CodeLabel"><b>views.py</b></p>
<pre><code>from django.shortcuts import render

# Create your views here.</code></pre>
<p>Currently, this file just imports the <code>render()</code> function, which renders the response based on the data provided by views. Open <em>views.py</em> and add the following code for the home page:</p>
<pre><code><span class="LiteralGray">from django.shortcuts import render</span>

def index(request):
    """The home page for Learning Log."""
    return render(request, 'learning_logs/index.html')</code></pre>
<p>When a URL request matches the pattern we just defined, Django looks for a function called <code>index()</code> in the <em>views.py </em>file. Django then passes the <code>request</code> object to this view function. In this case, we don’t need to process any data for the page, so the only code in the function is a call to <code>render()</code>. The <code>render()</code> function here passes two arguments: the original <code>request</code> object and a template it can use to build the page. Let’s write this template.</p>
<h3 id="h2-502703c18-0017">Writing a Template</h3>
<p class="BodyFirst">The template defines what the page should look like, and Django fills in the relevant data each time the page is requested. A template allows you to <span epub:type="pagebreak" title="391" id="Page_391"/>access any data provided by the view. Because our view for the home page provides no data, this template is fairly simple.</p>
<p>Inside the <em>learning_logs</em> folder, make a new folder called <em>templates</em>. Inside the <em>templates</em> folder, make another folder called <em>learning_logs</em>. This might seem a little redundant (we have a folder named <em>learning_logs</em> inside a folder named <em>templates</em> inside a folder named <em>learning_logs</em>), but it sets up a structure that Django can interpret unambiguously, even in the context of a large project containing many individual apps. Inside the inner <em>learning_logs</em> folder, make a new file called <em>index.html</em>. The path to the file will be <em>ll_project/learning_logs/templates/learning_logs/index.html</em>. Enter the following code into that file:</p>
<p class="CodeLabel"><b>index.html</b></p>
<pre><code>&lt;p&gt;Learning Log&lt;/p&gt;

&lt;p&gt;Learning Log helps you keep track of your learning, for any topic you're
interested in.&lt;/p&gt;</code></pre>
<p>This is a very simple file. If you’re not familiar with HTML, the <code>&lt;p&gt;&lt;/p&gt;</code> tags signify paragraphs. The <code>&lt;p&gt;</code> tag opens a paragraph, and the <code>&lt;/p&gt;</code> tag closes a paragraph. We have two paragraphs: the first acts as a title, and the second describes what users can do with Learning Log.</p>
<p>Now when you request the project’s base URL, <em>http://localhost:8000/</em>, you should see the page we just built instead of the default Django page. Django will take the requested URL, and that URL will match the pattern <code>''</code>; then Django will call the function <code>views.index()</code>, which will render the page using the template contained in <em>index.html</em>. <a href="#figure18-3" id="figureanchor18-3">Figure 18-3</a> shows the resulting page.</p>
<figure>
<img src="Images/f18003.png" class="keyline" alt="" width="694" height="299"/>
<figcaption><p><a id="figure18-3">Figure 18-3</a>: The home page for Learning Log</p></figcaption>
</figure>
<p>Although it might seem like a complicated process for creating one page, this separation between URLs, views, and templates works quite well. It allows you to think about each aspect of a project separately. In larger projects, it allows individuals working on the project to focus on the areas in which they’re strongest. For example, a database specialist can focus on the models, a programmer can focus on the view code, and a frontend specialist can focus on the templates.</p>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="note">
<span epub:type="pagebreak" title="392" id="Page_392"/><h2><span class="NoteHead">Note</span></h2>
<p>	You might see the following error message:</p>
<pre><code>ModuleNotFoundError: No module named 'learning_logs.urls'</code></pre>
<p class="Continued">If you do, stop the development server by pressing CTRL-C in the terminal window where you issued the <code>runserver</code> command. Then reissue the command <code class="bold">python manage.py runserver</code>. You should be able to see the home page. Anytime you run into an error like this, try stopping and restarting the server.</p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="box">
<h2>Try It Yourself</h2>
<p class="BoxBodyCustom"><span id="h2-502703c18-22" class="BoxNumber">18-5.	Meal Planner:</span> Consider an app that helps people plan their meals throughout the week. Make a new folder called <em>meal_planner</em>, and start a new Django project inside this folder. Then make a new app called <code>meal_plans</code>. Make a simple home page for this project.</p>
<p class="BoxBodyCustom"><span id="h2-502703c18-23" class="BoxNumber">18-6.	Pizzeria Home Page:</span> Add a home page to the Pizzeria project you started in <span class="xref" itemid="xref_target_Exercise 18-4 (page 388)">Exercise 18-4 (page 388)</span>.</p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<h2 id="h1-502703c18-0004">Building Additional Pages</h2>
<p class="BodyFirst">Now that we’ve established a routine for building a page, we can start to build out the Learning Log project. We’ll build two pages that display data: a page that lists all topics and a page that shows all the entries for a particular topic. For each page, we’ll specify a URL pattern, write a view function, and write a template. But before we do this, we’ll create a base template that all templates in the project can inherit from.</p>
<h3 id="h2-502703c18-0018">Template Inheritance</h3>
<p class="BodyFirst">When building a website, some elements will need to be repeated on each page. Rather than writing these elements directly into each page, you can write a base template containing the repeated elements and then have each page inherit from the base. This approach lets you focus on developing the unique aspects of each page, and makes it much easier to change the overall look and feel of the project.</p>
<h4 id="h3-502703c18-0004">The Parent Template</h4>
<p class="BodyFirst">We’ll create a template called <em>base.html</em> in the same directory as <em>index.html</em>. This file will contain elements common to all pages; every other template will inherit from <em>base.html</em>. The only element we want to repeat on each page right now is the title at the top. Because we’ll include this template on every page, let’s make the title a link to the home page:</p>
<p class="CodeLabel"><b>base.html</b></p>
<pre><code>&lt;p&gt;
<span class="CodeAnnotationHang" aria-label="annotation1">❶</span>   &lt;a href="{% url 'learning_logs:index' %}"&gt;Learning Log&lt;/a&gt;
<span epub:type="pagebreak" title="393" id="Page_393"/>&lt;/p&gt;

<span class="CodeAnnotationHang" aria-label="annotation2">❷</span> {% block content %}{% endblock content %}</code></pre>
<p>The first part of this file creates a paragraph containing the name of the project, which also acts as a home page link. To generate a link, we use a <em>template tag</em>, which is indicated by braces and percent signs (<code>{% %}</code>). A template tag generates information to be displayed on a page. The template tag <code>{% url 'learning_logs:index' %}</code> shown here generates a URL matching the URL pattern defined in <em>learning_logs/urls.py</em> with the name <code>'index'</code> <span class="CodeAnnotation" aria-label="annotation1">❶</span>. In this example, <code>learning_logs</code> is the <em>namespace</em> and <code>index</code> is a uniquely named URL pattern in that namespace. The namespace comes from the value we assigned to <code>app_name</code> in the <em>learning_logs/urls.py</em> file.</p>
<p>In a simple HTML page, a link is surrounded by the <em>anchor</em> <em>tag</em> <code>&lt;a&gt;</code>:</p>
<pre><code>&lt;a href="<var>link_url</var>"&gt;<var>link text</var>&lt;/a&gt;</code></pre>
<p>Having the template tag generate the URL for us makes it much easier to keep our links up to date. We only need to change the URL pattern in <em>urls.py</em>, and Django will automatically insert the updated URL the next time the page is requested. Every page in our project will inherit from <em>base.html</em>, so from now on, every page will have a link back to the home page.</p>
<p>On the last line, we insert a pair of <code>block</code> tags <span class="CodeAnnotation" aria-label="annotation2">❷</span>. This block, named <code>content</code>, is a placeholder; the child template will define the kind of information that goes in the <code>content</code> block.</p>
<p>A child template doesn’t have to define every block from its parent, so you can reserve space in parent templates for as many blocks as you like; the child template uses only as many as it needs.</p>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="note">
<h2><span class="NoteHead">Note</span></h2>
<p>	In Python code, we almost always use four spaces when we indent. Template files tend to have more levels of nesting than Python files, so it’s common to use only two spaces for each indentation level.</p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<h4 id="h3-502703c18-0005">The Child Template</h4>
<p class="BodyFirst">Now we need to rewrite <em>index.html</em> to inherit from <em>base.html</em>. Add the following code to <em>index.html</em>:</p>
<p class="CodeLabel"><b>index.html</b></p>
<pre><code><span class="CodeAnnotationHang" aria-label="annotation1">❶</span> {% extends 'learning_logs/base.html' %}

<span class="CodeAnnotationHang" aria-label="annotation2">❷</span> {% block content %}
<span class="LiteralGray">  &lt;p&gt;Learning Log helps you keep track of your learning, for any topic you're</span>
<span class="LiteralGray">  interested in.&lt;/p&gt;</span>
<span class="CodeAnnotationHang" aria-label="annotation3">❸</span> {% endblock content %}</code></pre>
<p>If you compare this to the original <em>index.html</em>, you can see that we’ve replaced the Learning Log title with the code for inheriting from a parent template <span class="CodeAnnotation" aria-label="annotation1">❶</span>. A child template must have an <code>{% extends %}</code> tag on the first line to tell Django which parent template to inherit from. The file <em>base.html</em> <span epub:type="pagebreak" title="394" id="Page_394"/>is part of <code>learning_logs</code>, so we include <em>learning_logs</em> in the path to the parent template. This line pulls in everything contained in the <em>base.html</em> template and allows <em>index.html</em> to define what goes in the space reserved by the <code>content</code> block.</p>
<p>We define the content block by inserting a <code>{% block %}</code> tag with the name <code>content</code> <span class="CodeAnnotation" aria-label="annotation2">❷</span>. Everything that we aren’t inheriting from the parent template goes inside the <code>content</code> block. Here, that’s the paragraph describing the Learning Log project. We indicate that we’re finished defining the content by using an <code>{% endblock content %}</code> tag <span class="CodeAnnotation" aria-label="annotation3">❸</span>. The <code>{% endblock %}</code> tag doesn’t require a name, but if a template grows to contain multiple blocks, it can be helpful to know exactly which block is ending.</p>
<p>You can start to see the benefit of template inheritance: in a child template, we only need to include content that’s unique to that page. This not only simplifies each template, but also makes it much easier to modify the site. To modify an element common to many pages, you only need to modify the parent template. Your changes are then carried over to every page that inherits from that template. In a project that includes tens or hundreds of pages, this structure can make it much easier and faster to improve your site.</p>
<p>In a large project, it’s common to have one parent template called <em>base.html</em> for the entire site and parent templates for each major section of the site. All the section templates inherit from <em>base.html</em>, and each page in the site inherits from a section template. This way you can easily modify the look and feel of the site as a whole, any section in the site, or any individual page. This configuration provides a very efficient way to work, and encourages you to steadily update your project over time.</p>
<h3 id="h2-502703c18-0019">The Topics Page</h3>
<p class="BodyFirst">Now that we have an efficient approach to building pages, we can focus on our next two pages: the general topics page and the page to display entries for a single topic. The topics page will show all topics that users have created, and it’s the first page that will involve working with data.</p>
<h4 id="h3-502703c18-0006">The Topics URL Pattern</h4>
<p class="BodyFirst">First, we define the URL for the topics page. It’s common to choose a simple URL fragment that reflects the kind of information presented on the page. We’ll use the word <em>topics</em>, so the URL <em>http://localhost:8000/topics/</em> will return this page. Here’s how we modify <em>learning_logs/urls.py</em>:</p>
<p class="CodeLabel"><b>learning_logs/urls.py</b></p>
<pre><code><span class="LiteralGray">"""Defines URL patterns for learning_logs."""</span>
<em class="LiteralGrayItalic">--snip--</em>
<span class="LiteralGray">urlpatterns = [</span>
<span class="LiteralGray">    # Home page</span>
<span class="LiteralGray">    path('', views.index, name='index'),</span>
    # Page that shows all topics.
    path('topics/', views.topics, name='topics'),
<span class="LiteralGray">]</span></code></pre>
<p><span epub:type="pagebreak" title="395" id="Page_395"/>The new URL pattern is the word <em>topics</em>, followed by a forward slash. When Django examines a requested URL, this pattern will match any URL that has the base URL followed by <em>topics</em>. You can include or omit a forward slash at the end, but there can’t be anything else after the word <em>topics</em>, or the pattern won’t match. Any request with a URL that matches this pattern will then be passed to the function <code>topics()</code> in <em>views.py</em>.</p>
<h4 id="h3-502703c18-0007">The Topics View</h4>
<p class="BodyFirst">The <code>topics()</code> function needs to retrieve some data from the database and send it to the template. Add the following to <em>views.py</em>:</p>
<p class="CodeLabel"><b>views.py</b></p>
<pre><code><span class="LiteralGray">from django.shortcuts import render</span>

<span class="CodeAnnotationHang" aria-label="annotation1">❶</span> from .models import Topic

<span class="LiteralGray">def index(request):</span>
<span class="LiteralGray">    </span><em class="LiteralGrayItalic">--snip--</em>

<span class="CodeAnnotationHang" aria-label="annotation2">❷</span> def topics(request):
    """Show all topics."""
<span class="CodeAnnotationHang" aria-label="annotation3">❸</span>     topics = Topic.objects.order_by('date_added')
<span class="CodeAnnotationHang" aria-label="annotation4">❹</span>     context = {'topics': topics}
<span class="CodeAnnotationHang" aria-label="annotation5">❺</span>     return render(request, 'learning_logs/topics.html', context)</code></pre>
<p>We first import the model associated with the data we need <span class="CodeAnnotation" aria-label="annotation1">❶</span>. The <code>topics()</code> function needs one parameter: the <code>request</code> object Django received from the server <span class="CodeAnnotation" aria-label="annotation2">❷</span>. We query the database by asking for the <code>Topic</code> objects, sorted by the <code>date_added</code> attribute <span class="CodeAnnotation" aria-label="annotation3">❸</span>. We assign the resulting queryset to <code>topics</code>.</p>
<p>We then define a context that we’ll send to the template <span class="CodeAnnotation" aria-label="annotation4">❹</span>. A <em>context</em> is a dictionary in which the keys are names we’ll use in the template to access the data we want, and the values are the data we need to send to the template. In this case, there’s one key-value pair, which contains the set of topics we’ll display on the page. When building a page that uses data, we call <code>render()</code> with the <code>request</code> object, the template we want to use, and the <code>context</code> dictionary <span class="CodeAnnotation" aria-label="annotation5">❺</span>.</p>
<h4 id="h3-502703c18-0008">The Topics Template</h4>
<p class="BodyFirst">The template for the topics page receives the <code>context</code> dictionary, so the template can use the data that <code>topics()</code> provides. Make a file called <em>topics.html</em> in the same directory as <em>index.html</em>. Here’s how we can display the topics in the template:</p>
<p class="CodeLabel"><b>topics.html</b></p>
<pre><code>{% extends 'learning_logs/base.html' %}

{% block content %}

  &lt;p&gt;Topics&lt;/p&gt;

<span epub:type="pagebreak" title="396" id="Page_396"/><span class="CodeAnnotationHang" aria-label="annotation1">❶</span>   &lt;ul&gt;
<span class="CodeAnnotationHang" aria-label="annotation2">❷</span>     {% for topic in topics %}
<span class="CodeAnnotationHang" aria-label="annotation3">❸</span>       &lt;li&gt;{{ topic.text }}&lt;/li&gt;
<span class="CodeAnnotationHang" aria-label="annotation4">❹</span>     {% empty %}
      &lt;li&gt;No topics have been added yet.&lt;/li&gt;
<span class="CodeAnnotationHang" aria-label="annotation5">❺</span>     {% endfor %}
<span class="CodeAnnotationHang" aria-label="annotation6">❻</span>   &lt;/ul&gt;

{% endblock content %}</code></pre>
<p>We use the <code>{% extends %}</code> tag to inherit from <em>base.html</em>, just as we did on the home page, and then we open a <code>content</code> block. The body of this page contains a bulleted list of the topics that have been entered. In standard HTML, a bulleted list is called an <em>unordered list</em> and is indicated by the tags <code>&lt;ul&gt;&lt;/ul&gt;</code>. The opening tag <code>&lt;ul&gt;</code> begins the bulleted list of topics <span class="CodeAnnotation" aria-label="annotation1">❶</span>.</p>
<p>Next we use a template tag that’s equivalent to a <code>for</code> loop, which loops through the list <code>topics</code> from the <code>context</code> dictionary <span class="CodeAnnotation" aria-label="annotation2">❷</span>. The code used in templates differs from Python in some important ways. Python uses indentation to indicate which lines of a <code>for</code> statement are part of a loop. In a template, every <code>for</code> loop needs an explicit <code>{% endfor %}</code> tag indicating where the end of the loop occurs. So in a template, you’ll see loops written like this:</p>
<pre><code>{% for <var>item</var> in <var>list</var> %}
  <var>do something with each item</var>
{% endfor %}</code></pre>
<p>Inside the loop, we want to turn each topic into an item in the bulleted list. To print a variable in a template, wrap the variable name in double braces. The braces won’t appear on the page; they just indicate to Django that we’re using a template variable. So the code <code>{{ topic.text }}</code> <span class="CodeAnnotation" aria-label="annotation3">❸</span> will be replaced by the value of the current topic’s <code>text</code> attribute on each pass through the loop. The HTML tag <code>&lt;li&gt;&lt;/li&gt;</code> indicates a <em>list item</em>. Anything between these tags, inside a pair of <code>&lt;ul&gt;&lt;/ul&gt;</code> tags, will appear as a bulleted item in the list.</p>
<p>We also use the <code>{% empty %}</code> template tag <span class="CodeAnnotation" aria-label="annotation4">❹</span>, which tells Django what to do if there are no items in the list. In this case, we print a message informing the user that no topics have been added yet. The last two lines close out the <code>for</code> loop <span class="CodeAnnotation" aria-label="annotation5">❺</span> and then close out the bulleted list <span class="CodeAnnotation" aria-label="annotation6">❻</span>.</p>
<p>Now we need to modify the base template to include a link to the topics page. Add the following code to <em>base.html</em>:</p>
<p class="CodeLabel"><b>base.html</b></p>
<pre><code><span class="LiteralGray">&lt;p&gt;</span>
<span class="CodeAnnotationHang" aria-label="annotation1">❶</span>   &lt;a href="{% url 'learning_logs:index' %}"&gt;Learning Log&lt;/a&gt; -
<span class="CodeAnnotationHang" aria-label="annotation2">❷</span>   &lt;a href="{% url 'learning_logs:topics' %}"&gt;Topics&lt;/a&gt;
<span class="LiteralGray">&lt;/p&gt;</span>

<span class="LiteralGray">{% block content %}{% endblock content %}</span></code></pre>
<p>We add a dash after the link to the home page <span class="CodeAnnotation" aria-label="annotation1">❶</span>, and then add a link to the topics page using the <code>{% url %}</code> template tag again <span class="CodeAnnotation" aria-label="annotation2">❷</span>. This line tells <span epub:type="pagebreak" title="397" id="Page_397"/>Django to generate a link matching the URL pattern with the name <code>'topics'</code> in <em>learning_logs/urls.py</em>.</p>
<p>Now when you refresh the home page in your browser, you’ll see a Topics link. When you click the link, you’ll see a page that looks similar to <a href="#figure18-4" id="figureanchor18-4">Figure 18-4</a>.</p>
<figure>
<img src="Images/f18004.png" class="keyline" alt="" width="694" height="299"/>
<figcaption><p><a id="figure18-4">Figure 18-4</a>: The topics page</p></figcaption>
</figure>
<h3 id="h2-502703c18-0020">Individual Topic Pages</h3>
<p class="BodyFirst">Next, we need to create a page that can focus on a single topic, showing the topic name and all the entries for that topic. We’ll define a new URL pattern, write a view, and create a template. We’ll also modify the topics page so each item in the bulleted list links to its corresponding topic page.</p>
<h4 id="h3-502703c18-0009">The Topic URL Pattern</h4>
<p class="BodyFirst">The URL pattern for the topic page is a little different from the prior URL patterns because it will use the topic’s <code>id</code> attribute to indicate which topic was requested. For example, if the user wants to see the detail page for the Chess topic (where the <code>id</code> is 1), the URL will be <em>http://localhost:8000/topics/1/</em>. Here’s a pattern to match this URL, which you should place in <em>learning_logs/urls.py</em>:</p>
<p class="CodeLabel"><b>learning_logs/urls.py</b></p>
<pre><code><em class="LiteralGrayItalic">--snip--</em>
<span class="LiteralGray">urlpatterns = [</span>
<span class="LiteralGray">    </span><em class="LiteralGrayItalic">--snip--</em>
    # Detail page for a single topic.
    path('topics/&lt;int:topic_id&gt;/', views.topic, name='topic'),
<span class="LiteralGray">]</span></code></pre>
<p>Let’s examine the string <code>'topics/&lt;int:topic_id&gt;/'</code> in this URL pattern. The first part of the string tells Django to look for URLs that have the word <em>topics</em> after the base URL. The second part of the string, <code>/&lt;int:topic_id&gt;/</code>, matches an integer between two forward slashes and assigns the integer value to an argument called <code>topic_id</code>.</p>
<p><span epub:type="pagebreak" title="398" id="Page_398"/>When Django finds a URL that matches this pattern, it calls the view function <code>topic()</code> with the value assigned to <code>topic_id</code> as an argument. We’ll use the value of <code>topic_id</code> to get the correct topic inside the function.</p>
<h4 id="h3-502703c18-0010">The Topic View</h4>
<p class="BodyFirst">The <code>topic()</code> function needs to get the topic and all associated entries from the database, much like what we did earlier in the Django shell:</p>
<p class="CodeLabel"><b>views.py</b></p>
<pre><code><var>--snip--</var>
<span class="CodeAnnotationHang" aria-label="annotation1">❶</span> def topic(request, topic_id):
    """Show a single topic and all its entries."""
<span class="CodeAnnotationHang" aria-label="annotation2">❷</span>     topic = Topic.objects.get(id=topic_id)
<span class="CodeAnnotationHang" aria-label="annotation3">❸</span>     entries = topic.entry_set.order_by('-date_added')
<span class="CodeAnnotationHang" aria-label="annotation4">❹</span>     context = {'topic': topic, 'entries': entries}
<span class="CodeAnnotationHang" aria-label="annotation5">❺</span>     return render(request, 'learning_logs/topic.html', context)</code></pre>
<p>This is the first view function that requires a parameter other than the <code>request</code> object. The function accepts the value captured by the expression <code>/&lt;int:topic_id&gt;/</code> and assigns it to <code>topic_id</code> <span class="CodeAnnotation" aria-label="annotation1">❶</span>. Then we use <code>get()</code> to retrieve the topic, just as we did in the Django shell <span class="CodeAnnotation" aria-label="annotation2">❷</span>. Next, we get all of the entries associated with this topic and order them according to <code>date_added</code> <span class="CodeAnnotation" aria-label="annotation3">❸</span>. The minus sign in front of <code>date_added</code> sorts the results in reverse order, which will display the most recent entries first. We store the topic and entries in the <code>context</code> dictionary <span class="CodeAnnotation" aria-label="annotation4">❹</span> and call <code>render()</code> with the <code>request</code> object, the <em>topic.html</em> template, and the <code>context</code> dictionary <span class="CodeAnnotation" aria-label="annotation5">❺</span>.</p>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="note">
<h2><span class="NoteHead">Note</span></h2>
<p>	The code phrases at <span class="CodeAnnotation" aria-label="annotation2">❷</span> and <span class="CodeAnnotation" aria-label="annotation3">❸</span> are called <em>queries</em>, because they query the database for specific information. When you’re writing queries like these in your own projects, it’s helpful to try them out in the Django shell first. You’ll get much quicker feedback in the shell than you would by writing a view and template and then checking the results in a browser.</p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<h4 id="h3-502703c18-0011">The Topic Template</h4>
<p class="BodyFirst">The template needs to display the name of the topic and the entries. We also need to inform the user if no entries have been made yet for this topic.</p>
<p class="CodeLabel"><b>topic.html</b></p>
<pre><code>{% extends 'learning_logs/base.html' %}

{% block content %}

<span class="CodeAnnotationHang" aria-label="annotation1">❶</span>   &lt;p&gt;Topic: {{ topic.text }}&lt;/p&gt;

  &lt;p&gt;Entries:&lt;/p&gt;
<span class="CodeAnnotationHang" aria-label="annotation2">❷</span>   &lt;ul&gt;
<span class="CodeAnnotationHang" aria-label="annotation3">❸</span>     {% for entry in entries %}
      &lt;li&gt;
<span class="CodeAnnotationHang" aria-label="annotation4">❹</span>         &lt;p&gt;{{ entry.date_added|date:'M d, Y H:i' }}&lt;/p&gt;
<span class="CodeAnnotationHang" aria-label="annotation5">❺</span>         &lt;p&gt;{{ entry.text|linebreaks }}&lt;/p&gt;
      &lt;/li&gt;
<span class="CodeAnnotationHang" aria-label="annotation6">❻</span>     {% empty %}
<span epub:type="pagebreak" title="399" id="Page_399"/>      &lt;li&gt;There are no entries for this topic yet.&lt;/li&gt;
    {% endfor %}
  &lt;/ul&gt;

{% endblock content %}</code></pre>
<p>We extend <em>base.html</em>, as we’ll do for all pages in the project. Next, we show the <code>text</code> attribute of the topic that’s been requested <span class="CodeAnnotation" aria-label="annotation1">❶</span>. The variable <code>topic</code> is available because it’s included in the <code>context</code> dictionary. We then start a bulleted list <span class="CodeAnnotation" aria-label="annotation2">❷</span> to show each of the entries and loop through them <span class="CodeAnnotation" aria-label="annotation3">❸</span>, as we did with the topics earlier.</p>
<p>Each bullet lists two pieces of information: the timestamp and the full text of each entry. For the timestamp <span class="CodeAnnotation" aria-label="annotation4">❹</span>, we display the value of the attribute <code>date_added</code>. In Django templates, a vertical line (<code>|</code>) represents a template <em>filter</em>—a function that modifies the value in a template variable during the rendering process. The filter <code>date:'M d, Y H:i'</code> displays timestamps in the format <em>January 1, 2022 23:00</em>. The next line displays the value of the current entry’s <code>text</code> attribute. The filter <code>linebreaks</code> <span class="CodeAnnotation" aria-label="annotation5">❺</span> ensures that long text entries include line breaks in a format understood by browsers, rather than showing a block of uninterrupted text. We again use the <code>{% empty %}</code> template tag <span class="CodeAnnotation" aria-label="annotation6">❻</span> to print a message informing the user that no entries have been made.</p>
<h4 id="h3-502703c18-0012">Links from the Topics Page</h4>
<p class="BodyFirst">Before we look at the topic page in a browser, we need to modify the topics template so each topic links to the appropriate page. Here’s the change you need to make to <em>topics.html</em>:</p>
<p class="CodeLabel"><b>topics.html</b></p>
<pre><code><em class="LiteralGrayItalic">--snip--</em>
    <span class="LiteralGray">{% for topic in topics %}</span>
      &lt;li&gt;
        &lt;a href="{% url 'learning_logs:topic' topic.id %}"&gt;
          {{ topic.text }}&lt;/a&gt;&lt;/li&gt;
      &lt;/li&gt;
<span class="LiteralGray">    {% empty %}</span>
<em class="LiteralGrayItalic">--snip--</em></code></pre>
<p>We use the URL template tag to generate the proper link, based on the URL pattern in <code>learning_logs</code> with the name <code>'topic'</code>. This URL pattern requires a <code>topic_id</code> argument, so we add the attribute <code>topic.id</code> to the URL template tag. Now each topic in the list of topics is a link to a topic page, such as <em>http://localhost:8000/topics/1/</em>.</p>
<p>When you refresh the topics page and click a topic, you should see a page that looks like <a href="#figure18-5" id="figureanchor18-5">Figure 18-5</a>.</p>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="note">
<h2><span class="NoteHead">Note</span></h2>
<p>	There’s a subtle but important difference between <code>topic.id</code> and <code>topic_id</code>. The expression <code>topic.id</code> examines a topic and retrieves the value of the corresponding ID. The variable <code>topic_id</code> is a reference to that ID in the code. If you run into errors when working with IDs, make sure you’re using these expressions in the appropriate ways.</p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<span epub:type="pagebreak" title="400" id="Page_400"/><figure>
<img src="Images/f18005.png" class="keyline" alt="" width="694" height="410"/>
<figcaption><p><a id="figure18-5">Figure 18-5</a>: The detail page for a single topic, showing all entries for a topic</p></figcaption>
</figure>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="box">
<h2>Try It Yourself</h2>
<p class="BoxBodyCustom"><span id="h2-502703c18-27" class="BoxNumber">18-7.	Template Documentation:</span> Skim the Django template documentation at <a href="https://docs.djangoproject.com/en/4.1/ref/templates" class="LinkURL">https://docs.djangoproject.com/en/4.1/ref/templates</a>. You can refer back to it when you’re working on your own projects.</p>
<p class="BoxBodyCustom"><span id="h2-502703c18-28" class="BoxNumber">18-8.	Pizzeria Pages:</span> Add a page to the Pizzeria project from Exercise 18-6 (<span class="xref" itemid="xref_target_page 392">page 392</span>) that shows the names of available pizzas. Then link each pizza name to a page displaying the pizza’s toppings. Make sure you use template inheritance to build your pages efficiently.</p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<h2 id="h1-502703c18-0005">Summary</h2>
<p class="BodyFirst">In this chapter, you learned how to start building a simple web app using the Django framework. You saw a brief project specification, installed Django to a virtual environment, set up a project, and checked that the project was set up correctly. You set up an app and defined models to represent the data for your app. You learned about databases and how Django helps you migrate your database after you make a change to your models. You created a superuser for the admin site, and you used the admin site to enter some initial data.</p>
<p>You also explored the Django shell, which allows you to work with your project’s data in a terminal session. You learned how to define URLs, create view functions, and write templates to make pages for your site. You also used template inheritance to simplify the structure of individual templates and make it easier to modify the site as the project evolves.</p>
<p><span epub:type="pagebreak" title="401" id="Page_401"/>In <span class="xref" itemid="xref_target_Chapter 19">Chapter 19</span>, you’ll make intuitive, user-friendly pages that allow users to add new topics and entries and edit existing entries without going through the admin site. You’ll also add a user registration system, allowing users to create an account and make their own learning log. This is the heart of a web app—the ability to create something that any number of users can interact with.</p>
</section>
</div>
<div id="sbo-rt-content"><section>
<header>
<h1 class="chapter">
<span class="ChapterNumber"><span epub:type="pagebreak" title="403" id="Page_403"/>19</span><br/>
<span class="ChapterTitle">User Accounts</span></h1>
</header>
<figure class="opener">
<img src="Images/chapterart.png" alt="" width="406" height="406"/>
</figure>
<p class="ChapterIntro">At the heart of a web application is the ability for any user, anywhere in the world, to register an account with your app and start using it. In this chapter, you’ll build forms so users can add their own topics and entries, and edit existing entries. You’ll also learn how Django guards against common attacks against form-based pages, so you won’t have to spend much time thinking about securing your apps.</p>
<p>You’ll also implement a user authentication system. You’ll build a registration page for users to create accounts, and then restrict access to certain pages to logged-in users only. Then you’ll modify some of the view functions so users can only see their own data. You’ll learn to keep your users’ data safe and secure.</p>
<h2 id="h1-502703c19-0001"><span epub:type="pagebreak" title="404" id="Page_404"/>Allowing Users to Enter Data</h2>
<p class="BodyFirst">Before we build an authentication system for creating accounts, we’ll first add some pages that allow users to enter their own data. We’ll give users the ability to add a new topic, add a new entry, and edit their previous entries.</p>
<p>Currently, only a superuser can enter data through the admin site. We don’t want users to interact with the admin site, so we’ll use Django’s form-building tools to build pages that allow users to enter data.</p>
<h3 id="h2-502703c19-0001">Adding New Topics</h3>
<p class="BodyFirst">Let’s start by allowing users to add a new topic. Adding a form-based page works in much the same way as adding the pages we’ve already built: we define a URL, write a view function, and write a template. The one significant difference is the addition of a new module called <em>forms.py</em>, which will contain the forms.</p>
<h4 id="h3-502703c19-0001">The Topic ModelForm</h4>
<p class="BodyFirst">Any page that lets a user enter and submit information on a web page involves an HTML element called a <em>form</em>. When users enter information, we need to <em>validate</em> that the information provided is the right kind of data and is not malicious, such as code designed to interrupt our server. We then need to process and save valid information to the appropriate place in the database. Django automates much of this work.</p>
<p>The simplest way to build a form in Django is to use a <code>ModelForm</code>, which uses the information from the models we defined in <span class="xref" itemid="xref_target_Chapter 18">Chapter 18</span> to build a form automatically. Write your first form in the file <em>forms.py</em>, which should be created in the same directory as <em>models.py</em>:</p>
<p class="CodeLabel"><b>forms.py</b></p>
<pre><code>from django import forms

from .models import Topic

<span class="CodeAnnotationHang" aria-label="annotation1">❶</span> class TopicForm(forms.ModelForm):
    class Meta:
<span class="CodeAnnotationHang" aria-label="annotation2">❷</span>         model = Topic
<span class="CodeAnnotationHang" aria-label="annotation3">❸</span>         fields = ['text']
<span class="CodeAnnotationHang" aria-label="annotation4">❹</span>         labels = {'text': ''}</code></pre>
<p>We first import the <code>forms</code> module and the model we’ll work with, <code>Topic</code>. We then define a class called <code>TopicForm</code>, which inherits from <code>forms.ModelForm</code> <span class="CodeAnnotation" aria-label="annotation1">❶</span>.</p>
<p>The simplest version of a <code>ModelForm</code> consists of a nested <code>Meta</code> class telling Django which model to base the form on and which fields to include in the form. Here we specify that the form should be based on the <code>Topic</code> model <span class="CodeAnnotation" aria-label="annotation2">❷</span>, and that it should only include the <code>text</code> field <span class="CodeAnnotation" aria-label="annotation3">❸</span>. The empty string in the labels dictionary tells Django not to generate a label for the <code>text</code> field <span class="CodeAnnotation" aria-label="annotation4">❹</span>.</p>
<h4 id="h3-502703c19-0002"><span epub:type="pagebreak" title="405" id="Page_405"/>The new_topic URL</h4>
<p class="BodyFirst">The URL for a new page should be short and descriptive. When the user wants to add a new topic, we’ll send them to <em>http://localhost:8000/new_topic/</em>. Here’s the URL pattern for the <code>new_topic</code> page; add this to <em>learning_logs/urls.py</em>:</p>
<p class="CodeLabel"><b>learning_logs/urls.py</b></p>
<pre><code><em class="LiteralGrayItalic">--snip--</em>
<span class="LiteralGray">urlpatterns = [</span>
<span class="LiteralGray">    </span><em class="LiteralGrayItalic">--snip--</em>
<span class="LiteralGray">    </span># Page for adding a new topic.
    path('new_topic/', views.new_topic, name='new_topic'),
<span class="LiteralGray">]</span></code></pre>
<p>This URL pattern sends requests to the view function <code>new_topic()</code>, which we’ll write next.</p>
<h4 id="h3-502703c19-0003">The new_topic() View Function</h4>
<p class="BodyFirst">The <code>new_topic()</code> function needs to handle two different situations: initial requests for the <code>new_topic</code> page, in which case it should show a blank form; and the processing of any data submitted in the form. After data from a submitted form is processed, it needs to redirect the user back to the <code>topics</code> page:</p>
<p class="CodeLabel"><b>views.py</b></p>
<pre><code>from django.shortcuts import render, redirect

<span class="LiteralGray">from .models import Topic</span>
from .forms import TopicForm

<em class="LiteralGrayItalic">--snip--</em>
def new_topic(request):
    """Add a new topic."""
<span class="CodeAnnotationHang" aria-label="annotation1">❶</span>     if request.method != 'POST':
        # No data submitted; create a blank form.
<span class="CodeAnnotationHang" aria-label="annotation2">❷</span>         form = TopicForm()
    else:
        # POST data submitted; process data.
<span class="CodeAnnotationHang" aria-label="annotation3">❸</span>         form = TopicForm(data=request.POST)
<span class="CodeAnnotationHang" aria-label="annotation4">❹</span>         if form.is_valid():
<span class="CodeAnnotationHang" aria-label="annotation5">❺</span>             form.save()
<span class="CodeAnnotationHang" aria-label="annotation6">❻</span>             return redirect('learning_logs:topics')

    # Display a blank or invalid form.
<span class="CodeAnnotationHang" aria-label="annotation7">❼</span>     context = {'form': form}
    return render(request, 'learning_logs/new_topic.html', context)</code></pre>
<p>We import the function <code>redirect</code>, which we’ll use to redirect the user back to the <code>topics</code> page after they submit their topic. We also import the form we just wrote, <code>TopicForm</code>.</p>
<h4 id="h3-502703c19-0004"><span epub:type="pagebreak" title="406" id="Page_406"/>GET and POST Requests</h4>
<p class="BodyFirst">The two main types of requests you’ll use when building apps are GET and POST. You use <em>GET</em> requests for pages that only read data from the server. You usually use <em>POST</em> requests when the user needs to submit information through a form. We’ll be specifying the POST method for processing all of our forms. (A few other kinds of requests exist, but we won’t use them in this project.)</p>
<p>The <code>new_topic()</code> function takes in the <code>request</code> object as a parameter. When the user initially requests this page, their browser will send a GET request. Once the user has filled out and submitted the form, their browser will submit a POST request. Depending on the request, we’ll know whether the user is requesting a blank form (GET) or asking us to process a completed form (POST).</p>
<p>We use an <code>if</code> test to determine whether the request method is GET or POST <span class="CodeAnnotation" aria-label="annotation1">❶</span>. If the request method isn’t POST, the request is probably GET, so we need to return a blank form. (If it’s another kind of request, it’s still safe to return a blank form.) We make an instance of <code>TopicForm</code> <span class="CodeAnnotation" aria-label="annotation2">❷</span>, assign it to the variable <code>form</code>, and send the form to the template in the <code>context</code> dictionary <span class="CodeAnnotation" aria-label="annotation7">❼</span>. Because we included no arguments when instantiating <code>TopicForm</code>, Django creates a blank form that the user can fill out.</p>
<p>If the request method is POST, the <code>else</code> block runs and processes the data submitted in the form. We make an instance of <code>TopicForm</code> <span class="CodeAnnotation" aria-label="annotation3">❸</span> and pass it the data entered by the user, which is assigned to <code>request.POST</code>. The <code>form</code> object that’s returned contains the information submitted by the user.</p>
<p>We can’t save the submitted information in the database until we’ve checked that it’s valid <span class="CodeAnnotation" aria-label="annotation4">❹</span>. The <code>is_valid()</code> method checks that all required fields have been filled in (all fields in a form are required by default) and that the data entered matches the field types expected—for example, that the length of <code>text</code> is less than 200 characters, as we specified in <em>models.py</em> in <span class="xref" itemid="xref_target_Chapter 18">Chapter 18</span>. This automatic validation saves us a lot of work. If everything is valid, we can call <code>save()</code> <span class="CodeAnnotation" aria-label="annotation5">❺</span>, which writes the data from the form to the database.</p>
<p>Once we’ve saved the data, we can leave this page. The <code>redirect()</code> function takes in the name of a view and redirects the user to the page associated with that view. Here we use <code>redirect()</code> to redirect the user’s browser to the <code>topics</code> page <span class="CodeAnnotation" aria-label="annotation6">❻</span>, where the user should see the topic they just entered in the list of topics.</p>
<p>The <code>context</code> variable is defined at the end of the view function, and the page is rendered using the template <em>new_topic.html</em>, which we’ll create next. This code is placed outside of any <code>if</code> block; it will run if a blank form was created, and it will run if a submitted form is determined to be invalid. An invalid form will include some default error messages to help the user submit acceptable data.</p>
<h4 id="h3-502703c19-0005"><span epub:type="pagebreak" title="407" id="Page_407"/>The new_topic Template</h4>
<p class="BodyFirst">Now we’ll make a new template called <em>new_topic.html</em> to display the form we just created:</p>
<p class="CodeLabel"><b>new_topic.html</b></p>
<pre><code>{% extends "learning_logs/base.html" %}

{% block content %}
  &lt;p&gt;Add a new topic:&lt;/p&gt;

<span class="CodeAnnotationHang" aria-label="annotation1">❶</span>   &lt;form action="{% url 'learning_logs:new_topic' %}" method='post'&gt;
<span class="CodeAnnotationHang" aria-label="annotation2">❷</span>     {% csrf_token %}
<span class="CodeAnnotationHang" aria-label="annotation3">❸</span>     {{ form.as_div }}
<span class="CodeAnnotationHang" aria-label="annotation4">❹</span>     &lt;button name="submit"&gt;Add topic&lt;/button&gt;
  &lt;/form&gt;

{% endblock content %}</code></pre>
<p>This template extends <em>base.html</em>, so it has the same base structure as the rest of the pages in Learning Log. We use the <code>&lt;form&gt;&lt;/form&gt;</code> tags to define an HTML form <span class="CodeAnnotation" aria-label="annotation1">❶</span>. The <code>action</code> argument tells the browser where to send the data submitted in the form; in this case, we send it back to the view function <code>new_topic()</code>. The <code>method</code> argument tells the browser to submit the data as a POST request.</p>
<p>Django uses the template tag <code>{% csrf_token %}</code> <span class="CodeAnnotation" aria-label="annotation2">❷</span> to prevent attackers from using the form to gain unauthorized access to the server. (This kind of attack is called a <em>cross-site request forgery</em>.) Next, we display the form; here you can see how simple Django can make certain tasks, such as displaying a form. We only need to include the template variable <code>{{ form.as_div }}</code> for Django to create all the fields necessary to display the form automatically <span class="CodeAnnotation" aria-label="annotation3">❸</span>. The <code>as_div</code> modifier tells Django to render all the form elements as HTML <code>&lt;div&gt;&lt;/div&gt;</code> elements; this is a simple way to display the form neatly.</p>
<p>Django doesn’t create a submit button for forms, so we define one before closing the form <span class="CodeAnnotation" aria-label="annotation4">❹</span>.</p>
<h4 id="h3-502703c19-0006">Linking to the new_topic Page</h4>
<p class="BodyFirst">Next, we include a link to the <code>new_topic</code> page on the <code>topics</code> page:</p>
<p class="CodeLabel"><b>topics.html</b></p>
<pre><code><span class="LiteralGray">{% extends "learning_logs/base.html" %}</span>

<span class="LiteralGray">{% block content %}</span>

<span class="LiteralGray">  &lt;p&gt;Topics&lt;/p&gt;</span>

<span class="LiteralGray">  &lt;ul&gt;</span>
<span class="LiteralGray">    </span><em class="LiteralGrayItalic">--snip--</em>
<span class="LiteralGray">  &lt;/ul&gt;</span>

<span class="LiteralGray">  </span>&lt;a href="{% url 'learning_logs:new_topic' %}"&gt;Add a new topic&lt;/a&gt;

<span class="LiteralGray">{% endblock content %}</span></code></pre>
<p><span epub:type="pagebreak" title="408" id="Page_408"/>Place the link after the list of existing topics. <a href="#figure19-1" id="figureanchor19-1">Figure 19-1</a> shows the resulting form; try using the form to add a few new topics of your own.</p>
<figure>
<img src="Images/f19001.png" class="keyline" alt="" width="581" height="342"/>
<figcaption><p><a id="figure19-1">Figure 19-1</a>: The page for adding a new topic</p></figcaption>
</figure>
<h3 id="h2-502703c19-0002">Adding New Entries</h3>
<p class="BodyFirst">Now that the user can add a new topic, they’ll want to add new entries too. We’ll again define a URL, write a view function and a template, and link to the page. But first, we’ll add another class to <em>forms.py</em>.</p>
<h4 id="h3-502703c19-0007">The Entry ModelForm</h4>
<p class="BodyFirst">We need to create a form associated with the <code>Entry</code> model, but this time, with a bit more customization than <code>TopicForm</code>:</p>
<p class="CodeLabel"><b>forms.py</b></p>
<pre><code><span class="LiteralGray">from django import forms</span>

from .models import Topic, Entry

<span class="LiteralGray">class TopicForm(forms.ModelForm):</span>
<span class="LiteralGray">    </span><em class="LiteralGrayItalic">--snip--</em>

class EntryForm(forms.ModelForm):
    class Meta:
        model = Entry
        fields = ['text']
<span class="CodeAnnotationHang" aria-label="annotation1">❶</span>         labels = {'text': ''}
<span class="CodeAnnotationHang" aria-label="annotation2">❷</span>         widgets = {'text': forms.Textarea(attrs={'cols': 80})}</code></pre>
<p>We update the <code>import</code> statement to include <code>Entry</code> as well as <code>Topic</code>. We make a new class called <code>EntryForm</code> that inherits from <code>forms.ModelForm</code>. The <code>EntryForm</code> class has a nested <code>Meta</code> class listing the model it’s based on, and the field to include in the form. We again give the field <code>'text'</code> a blank label <span class="CodeAnnotation" aria-label="annotation1">❶</span>.</p>
<p>For <code>EntryForm</code>, we include the <code>widgets</code> attribute <span class="CodeAnnotation" aria-label="annotation2">❷</span>. A <em>widget</em> is an HTML form element, such as a single-line text box, multiline text area, or drop-down list. By including the <code>widgets</code> attribute, you can override Django’s <span epub:type="pagebreak" title="409" id="Page_409"/>default widget choices. Here we’re telling Django to use a <code>forms.Textarea</code> element with a width of 80 columns, instead of the default 40 columns. This gives users enough room to write a meaningful entry.</p>
<h4 id="h3-502703c19-0008">The new_entry URL</h4>
<p class="BodyFirst">New entries must be associated with a particular topic, so we need to include a <code>topic_id</code> argument in the URL for adding a new entry. Here’s the URL, which you add to <em>learning_logs/urls.py</em>:</p>
<p class="CodeLabel"><b>learning_logs/urls.py</b></p>
<pre><code><em class="LiteralGrayItalic">--snip--</em>
<span class="LiteralGray">urlpatterns = [</span>
<span class="LiteralGray">    </span><em class="LiteralGrayItalic">--snip--</em>
    # Page for adding a new entry.
    path('new_entry/&lt;int:topic_id&gt;/', views.new_entry, name='new_entry'),
<span class="LiteralGray">]</span></code></pre>
<p>This URL pattern matches any URL with the form <em>http://localhost:8000/new_entry/id/</em>, where <var>id</var> is a number matching the topic ID. The code <code>&lt;int:topic_id&gt;</code> captures a numerical value and assigns it to the variable <code>topic_id</code>. When a URL matching this pattern is requested, Django sends the request and the topic’s ID to the <code>new_entry()</code> view function.</p>
<h4 id="h3-502703c19-0009">The new_entry() View Function</h4>
<p class="BodyFirst">The view function for <code>new_entry</code> is much like the function for adding a new topic. Add the following code to your <em>views.py</em> file:</p>
<p class="CodeLabel"><b>views.py</b></p>
<pre><code><span class="LiteralGray">from django.shortcuts import render, redirect</span>

<span class="LiteralGray">from .models import Topic</span>
from .forms import TopicForm, EntryForm

<em class="LiteralGrayItalic">--snip--</em>
def new_entry(request, topic_id):
    """Add a new entry for a particular topic."""
<span class="CodeAnnotationHang" aria-label="annotation1">❶</span>     topic = Topic.objects.get(id=topic_id)

<span class="CodeAnnotationHang" aria-label="annotation2">❷</span>     if request.method != 'POST':
        # No data submitted; create a blank form.
<span class="CodeAnnotationHang" aria-label="annotation3">❸</span>         form = EntryForm()
    else:
        # POST data submitted; process data.
<span class="CodeAnnotationHang" aria-label="annotation4">❹</span>         form = EntryForm(data=request.POST)
        if form.is_valid():
<span class="CodeAnnotationHang" aria-label="annotation5">❺</span>             new_entry = form.save(commit=False)
<span class="CodeAnnotationHang" aria-label="annotation6">❻</span>             new_entry.topic = topic
            new_entry.save()
<span class="CodeAnnotationHang" aria-label="annotation7">❼</span>             return redirect('learning_logs:topic', topic_id=topic_id)

    # Display a blank or invalid form.
    context = {'topic': topic, 'form': form}
    return render(request, 'learning_logs/new_entry.html', context)</code></pre>
<p><span epub:type="pagebreak" title="410" id="Page_410"/>We update the <code>import</code> statement to include the <code>EntryForm</code> we just made. The definition of <code>new_entry()</code> has a <code>topic_id</code> parameter to store the value it receives from the URL. We’ll need the topic to render the page and process the form’s data, so we use <code>topic_id</code> to get the correct topic object <span class="CodeAnnotation" aria-label="annotation1">❶</span>.</p>
<p>Next, we check whether the request method is POST or GET <span class="CodeAnnotation" aria-label="annotation2">❷</span>. The <code>if</code> block executes if it’s a GET request, and we create a blank instance of <code>EntryForm</code> <span class="CodeAnnotation" aria-label="annotation3">❸</span>.</p>
<p>If the request method is POST, we process the data by making an instance of <code>EntryForm</code>, populated with the POST data from the <code>request</code> object <span class="CodeAnnotation" aria-label="annotation4">❹</span>. We then check whether the form is valid. If it is, we need to set the entry object’s <code>topic</code> attribute before saving it to the database. When we call <code>save()</code>, we include the argument <code>commit=False</code> <span class="CodeAnnotation" aria-label="annotation5">❺</span> to tell Django to create a new entry object and assign it to <code>new_entry</code>, without saving it to the database yet. We set the <code>topic</code> attribute of <code>new_entry</code> to the topic we pulled from the database at the beginning of the function <span class="CodeAnnotation" aria-label="annotation6">❻</span>. Then we call <code>save()</code> with no arguments, saving the entry to the database with the correct associated topic.</p>
<p>The <code>redirect()</code> call requires two arguments: the name of the view we want to redirect to and the argument that view function requires <span class="CodeAnnotation" aria-label="annotation7">❼</span>. Here, we’re redirecting to <code>topic()</code>, which needs the argument <code>topic_id</code>. This view then renders the topic page that the user made an entry for, and they should see their new entry in the list of entries.</p>
<p>At the end of the function, we create a <code>context</code> dictionary and render the page using the <em>new_entry.html</em> template. This code will execute for a blank form, or for a form that’s been submitted but turns out to be invalid.</p>
<h4 id="h3-502703c19-0010">The new_entry Template</h4>
<p class="BodyFirst">As you can see in the following code, the template for <code>new_entry</code> is similar to the template for <code>new_topic</code>:</p>
<p class="CodeLabel"><b>new_entry.html</b></p>
<pre><code>{% extends "learning_logs/base.html" %}

{% block content %}

<span class="CodeAnnotationHang" aria-label="annotation1">❶</span>   &lt;p&gt;&lt;a href="{% url 'learning_logs:topic' topic.id %}"&gt;{{ topic }}&lt;/a&gt;&lt;/p&gt;

  &lt;p&gt;Add a new entry:&lt;/p&gt;
<span class="CodeAnnotationHang" aria-label="annotation2">❷</span>   &lt;form action="{% url 'learning_logs:new_entry' topic.id %}" method='post'&gt;
    {% csrf_token %}
    {{ form.as_div }}
    &lt;button name='submit'&gt;Add entry&lt;/button&gt;
  &lt;/form&gt;

{% endblock content %}</code></pre>
<p>We show the topic at the top of the page <span class="CodeAnnotation" aria-label="annotation1">❶</span>, so the user can see which topic they’re adding an entry to. The topic also acts as a link back to the main page for that topic.</p>
<p><span epub:type="pagebreak" title="411" id="Page_411"/>The form’s <code>action</code> argument includes the <code>topic.id</code> value in the URL, so the view function can associate the new entry with the correct topic <span class="CodeAnnotation" aria-label="annotation2">❷</span>. Other than that, this template looks just like <em>new_topic.html</em>.</p>
<h4 id="h3-502703c19-0011">Linking to the new_entry Page</h4>
<p class="BodyFirst">Next, we need to include a link to the <code>new_entry</code> page from each topic page, in the topic template:</p>
<p class="CodeLabel"><b>topic.html</b></p>
<pre><code><span class="LiteralGray">{% extends "learning_logs/base.html" %}</span>

<span class="LiteralGray">{% block content %}</span>

<span class="LiteralGray">  &lt;p&gt;Topic: {{ topic }}&lt;/p&gt;</span>

<span class="LiteralGray">  &lt;p&gt;Entries:&lt;/p&gt;</span>
  &lt;p&gt;
    &lt;a href="{% url 'learning_logs:new_entry' topic.id %}"&gt;Add new entry&lt;/a&gt;
  &lt;/p&gt;

<span class="LiteralGray">  &lt;ul&gt;</span>
<span class="LiteralGray">  </span><em class="LiteralGrayItalic">--snip--</em>
<span class="LiteralGray">  &lt;/ul&gt;</span>

<span class="LiteralGray">{% endblock content %}</span></code></pre>
<p>We place the link to add entries just before showing the entries, because adding a new entry will be the most common action on this page. <a href="#figure19-2" id="figureanchor19-2">Figure 19-2</a> shows the <code>new_entry</code> page. Now users can add new topics and as many entries as they want for each topic. Try out the <code>new_entry</code> page by adding a few entries to some of the topics you’ve created.</p>
<figure>
<img src="Images/f19002.png" class="keyline" alt="" width="679" height="399"/>
<figcaption><p><a id="figure19-2">Figure 19-2</a>: The <span class="LiteralInCaption"><code>new_entry</code></span> page</p></figcaption>
</figure>
<h3 id="h2-502703c19-0003"><span epub:type="pagebreak" title="412" id="Page_412"/>Editing Entries</h3>
<p class="BodyFirst">Now we’ll make a page so users can edit the entries they’ve added.</p>
<h4 id="h3-502703c19-0012">The edit_entry URL</h4>
<p class="BodyFirst">The URL for the page needs to pass the ID of the entry to be edited. Here’s <em>learning_logs/urls.py</em>:</p>
<p class="CodeLabel"><b>urls.py</b></p>
<pre><code><em class="LiteralGrayItalic">--snip--</em>
<span class="LiteralGray">urlpatterns = [</span>
<span class="LiteralGray">    </span><em class="LiteralGrayItalic">--snip--</em>
    # Page for editing an entry.
    path('edit_entry/&lt;int:entry_id&gt;/', views.edit_entry, name='edit_entry'),
<span class="LiteralGray">]</span></code></pre>
<p>This URL pattern matches URLs like <em>http://localhost:8000/edit_entry/id/</em>. Here the value of <var>id</var> is assigned to the parameter <code>entry_id</code>. Django sends requests that match this format to the view function <code>edit_entry()</code>.</p>
<h4 id="h3-502703c19-0013">The edit_entry() View Function</h4>
<p class="BodyFirst">When the <code>edit_entry</code> page receives a GET request, the <code>edit_entry()</code> function returns a form for editing the entry. When the page receives a POST request with revised entry text, it saves the modified text into the database:</p>
<p class="CodeLabel"><b>views.py</b></p>
<pre><code><span class="LiteralGray">from django.shortcuts import render, redirect</span>

from .models import Topic, Entry
<span class="LiteralGray">from .forms import TopicForm, EntryForm</span>
<em class="LiteralGrayItalic">--snip--</em>

def edit_entry(request, entry_id):
    """Edit an existing entry."""
<span class="CodeAnnotationHang" aria-label="annotation1">❶</span>     entry = Entry.objects.get(id=entry_id)
    topic = entry.topic

    if request.method != 'POST':
        # Initial request; pre-fill form with the current entry.
<span class="CodeAnnotationHang" aria-label="annotation2">❷</span>         form = EntryForm(instance=entry)
    else:
        # POST data submitted; process data.
<span class="CodeAnnotationHang" aria-label="annotation3">❸</span>         form = EntryForm(instance=entry, data=request.POST)
        if form.is_valid():
<span class="CodeAnnotationHang" aria-label="annotation4">❹</span>             form.save()
<span class="CodeAnnotationHang" aria-label="annotation5">❺</span>             return redirect('learning_logs:topic', topic_id=topic.id)

    context = {'entry': entry, 'topic': topic, 'form': form}
    return render(request, 'learning_logs/edit_entry.html', context)</code></pre>
<p>We first import the <code>Entry</code> model. We then get the entry object that the user wants to edit <span class="CodeAnnotation" aria-label="annotation1">❶</span> and the topic associated with this entry. In the <code>if</code> <span epub:type="pagebreak" title="413" id="Page_413"/>block, which runs for a GET request, we make an instance of <code>EntryForm</code> with the argument <code>instance=entry</code> <span class="CodeAnnotation" aria-label="annotation2">❷</span>. This argument tells Django to create the form, prefilled with information from the existing entry object. The user will see their existing data and be able to edit that data.</p>
<p>When processing a POST request, we pass both the <code>instance=entry</code> and the <code>data=request.POST</code> arguments <span class="CodeAnnotation" aria-label="annotation3">❸</span>. These arguments tell Django to create a form instance based on the information associated with the existing entry object, updated with any relevant data from <code>request.POST</code>. We then check whether the form is valid; if it is, we call <code>save()</code> with no arguments because the entry is already associated with the correct topic <span class="CodeAnnotation" aria-label="annotation4">❹</span>. We then redirect to the <code>topic</code> page, where the user should see the updated version of the entry they edited <span class="CodeAnnotation" aria-label="annotation5">❺</span>.</p>
<p>If we’re showing an initial form for editing the entry or if the submitted form is invalid, we create the <code>context</code> dictionary and render the page using the <em>edit_entry.html</em> template.</p>
<h4 id="h3-502703c19-0014">The edit_entry Template</h4>
<p class="BodyFirst">Next, we create an <em>edit_entry.html </em>template, which is similar to <em>new_entry.html</em>:</p>
<p class="CodeLabel"><b>edit_entry.html</b></p>
<pre><code>{% extends "learning_logs/base.html" %}

{% block content %}

  &lt;p&gt;&lt;a href="{% url 'learning_logs:topic' topic.id %}"&gt;{{ topic }}&lt;/a&gt;&lt;/p&gt;

  &lt;p&gt;Edit entry:&lt;/p&gt;

<span class="CodeAnnotationHang" aria-label="annotation1">❶</span>   &lt;form action="{% url 'learning_logs:edit_entry' entry.id %}" method='post'&gt;
    {% csrf_token %}
    {{ form.as_div }}
<span class="CodeAnnotationHang" aria-label="annotation2">❷</span>     &lt;button name="submit"&gt;Save changes&lt;/button&gt;
  &lt;/form&gt;

{% endblock content %}</code></pre>
<p>The <code>action</code> argument sends the form back to the <code>edit_entry()</code> function for processing <span class="CodeAnnotation" aria-label="annotation1">❶</span>. We include the <code>entry.id</code> as an argument in the <code>{% url %}</code> tag, so the view function can modify the correct entry object. We label the submit button as <code>Save changes</code> to remind the user they’re saving edits, not creating a new entry <span class="CodeAnnotation" aria-label="annotation2">❷</span>.</p>
<h4 id="h3-502703c19-0015">Linking to the edit_entry Page</h4>
<p class="BodyFirst">Now we need to include a link to the <code>edit_entry</code> page for each entry on the topic page:</p>
<p class="CodeLabel"><b>topic.html</b></p>
<pre><code><em class="LiteralGrayItalic">--snip--</em>
<span class="LiteralGray">    {% for entry in entries %}</span>
<span class="LiteralGray">      &lt;li&gt;</span>
<span epub:type="pagebreak" title="414" id="Page_414"/><span class="LiteralGray">        &lt;p&gt;{{ entry.date_added|date:'M d, Y H:i' }}&lt;/p&gt;</span>
<span class="LiteralGray">        &lt;p&gt;{{ entry.text|linebreaks }}&lt;/p&gt;</span>
<span class="LiteralGray">        </span>&lt;p&gt;
          &lt;a href="{% url 'learning_logs:edit_entry' entry.id %}"&gt;
           Edit entry&lt;/a&gt;&lt;/p&gt;
<span class="LiteralGray">      &lt;/li&gt;</span>
<em class="LiteralGrayItalic">--snip--</em></code></pre>
<p>We include the edit link after each entry’s date and text has been displayed. We use the <code>{% url %}</code> template tag to determine the URL for the named URL pattern <code>edit_entry</code>, along with the ID attribute of the current entry in the loop (<code>entry.id</code>). The link text <code>Edit entry</code> appears after each entry on the page. <a href="#figure19-3" id="figureanchor19-3">Figure 19-3</a> shows what the topic page looks like with these links.</p>
<figure>
<img src="Images/f19003.png" class="keyline" alt="" width="694" height="522"/>
<figcaption><p><a id="figure19-3">Figure 19-3</a>: Each entry now has a link for editing that entry.</p></figcaption>
</figure>
<p>Learning Log now has most of the functionality it needs. Users can add topics and entries, and they can read through any set of entries they want. In the next section, we’ll implement a user registration system so anyone can make an account with Learning Log and create their own set of topics and entries.</p>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="box">
<h2><span epub:type="pagebreak" title="415" id="Page_415"/>Try It Yourself</h2>
<p class="BoxBodyCustom"><span id="h2-502703c19-04" class="BoxNumber">19-1.	Blog:</span> Start a new Django project called <em>Blog</em>. Create an app called <em>blogs</em>, with one model that represents an overall blog, and one model that represents an individual blog post. Give each model an appropriate set of fields. Create a superuser for the project, and use the admin site to make a blog and a couple of short posts. Make a home page that shows all posts in an appropriate order.</p>
<p class="BoxBody">Create pages for making a blog, for making new posts, and for editing existing posts. Use your pages to make sure they work.</p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<h2 id="h1-502703c19-0002">Setting Up User Accounts</h2>
<p class="BodyFirst">In this section, we’ll set up a user registration and authorization system so people can register an account, log in, and log out. We’ll create a new app to contain all the functionality related to working with users. We’ll use the default user authentication system included with Django to do as much of the work as possible. We’ll also modify the <code>Topic</code> model slightly so every topic belongs to a certain user.</p>
<h3 id="h2-502703c19-0004">The accounts App</h3>
<p class="BodyFirst">We’ll start by creating a new app called <code>accounts</code>, using the <code>startapp</code> command:</p>
<pre><code>(ll_env)learning_log$ <b>python manage.py startapp accounts</b>
(ll_env)learning_log$ <b>ls</b>
<span class="CodeAnnotationHang" aria-label="annotation1">❶</span> accounts db.sqlite3 learning_logs ll_env ll_project manage.py
(ll_env)learning_log$ <b>ls accounts</b>
<span class="CodeAnnotationHang" aria-label="annotation2">❷</span> __init__.py admin.py apps.py migrations models.py tests.py views.py</code></pre>
<p>The default authentication system is built around the concept of user accounts, so using the name <code>accounts</code> makes integration with the default system easier. The <code>startapp</code> command shown here makes a new directory called <em>accounts</em> <span class="CodeAnnotation" aria-label="annotation1">❶</span> with a structure identical to the <code>learning_logs</code> app <span class="CodeAnnotation" aria-label="annotation2">❷</span>.</p>
<h4 id="h3-502703c19-0016">Adding accounts to settings.py</h4>
<p class="BodyFirst">We need to add our new app to <code>INSTALLED_APPS</code> in <em>settings.py</em>, like so:</p>
<p class="CodeLabel"><b>settings.py</b></p>
<pre><code><em class="LiteralGrayItalic">--snip--</em>
<span class="LiteralGray">INSTALLED_APPS = [</span>
<span class="LiteralGray">    # My apps</span>
<span class="LiteralGray">    'learning_logs',</span>
    'accounts',

<span epub:type="pagebreak" title="416" id="Page_416"/><span class="LiteralGray">    # Default django apps.</span>
<span class="LiteralGray">    </span><em class="LiteralGrayItalic">--snip--</em>
<span class="LiteralGray">]</span>
<em class="LiteralGrayItalic">--snip--</em></code></pre>
<p>Now Django will include the <code>accounts</code> app in the overall project.</p>
<h4 id="h3-502703c19-0017">Including the URLs from accounts</h4>
<p class="BodyFirst">Next, we need to modify the root <em>urls.py</em> so it includes the URLs we’ll write for the <code>accounts</code> app:</p>
<p class="CodeLabel"><b>ll_project/urls.py</b></p>
<pre><code><span class="LiteralGray">from django.contrib import admin</span>
<span class="LiteralGray">from django.urls import path, include</span>

<span class="LiteralGray">urlpatterns = [</span>
<span class="LiteralGray">    path('admin/', admin.site.urls),</span>
    path('accounts/', include('accounts.urls')),
<span class="LiteralGray">    path('', include('learning_logs.urls')),</span>
<span class="LiteralGray">]</span></code></pre>
<p>We add a line to include the file <em>urls.py</em> from <code>accounts</code>. This line will match any URL that starts with the word <em>accounts</em>, such as <em>http://localhost:8000/accounts/login/</em>.</p>
<h3 id="h2-502703c19-0005">The Login Page</h3>
<p class="BodyFirst">We’ll first implement a login page. We’ll use the default <code>login</code> view Django provides, so the URL pattern for this app looks a little different. Make a new <em>urls.py</em> file in the directory <em>ll_project/accounts/</em> and add the following to it:</p>
<p class="CodeLabel"><b>accounts/urls.py</b></p>
<pre><code>"""Defines URL patterns for accounts."""

from django.urls import path, include

app_name = 'accounts'
urlpatterns = [
    # Include default auth urls.
    path('', include('django.contrib.auth.urls')),
]</code></pre>
<p>We import the <code>path</code> function, and then import the <code>include</code> function so we can include some default authentication URLs that Django has defined. These default URLs include named URL patterns, such as <code>'login'</code> and <code>'logout'</code>. We set the variable <code>app_name</code> to <code>'accounts'</code> so Django can distinguish these URLs from URLs belonging to other apps. Even default URLs provided by Django, when included in the <code>accounts</code> app’s <em>urls.py</em> file, will be accessible through the <code>accounts</code> namespace.</p>
<p><span epub:type="pagebreak" title="417" id="Page_417"/>The login page’s pattern matches the URL <em>http://localhost:8000/accounts/login/</em>. When Django reads this URL, the word <em>accounts</em> tells Django to look in <em>accounts/urls.py</em>, and <em>login</em> tells it to send requests to Django’s default <code>login</code> view.</p>
<h4 id="h3-502703c19-0018">The login Template</h4>
<p class="BodyFirst">When the user requests the login page, Django will use a default view function, but we still need to provide a template for the page. The default authentication views look for templates inside a folder called <em>registration</em>, so we’ll need to make that folder. Inside the <em>ll_project/accounts/</em> directory, make a directory called <em>templates</em>; inside that, make another directory called <em>registration</em>. Here’s the <em>login.html</em> template, which should be saved in <em>ll_project/accounts/templates/registration</em>:</p>
<p class="CodeLabel"><b>login.html</b></p>
<pre><code>{% extends 'learning_logs/base.html' %}

{% block content %}

<span class="CodeAnnotationHang" aria-label="annotation1">❶</span>   {% if form.errors %}
    &lt;p&gt;Your username and password didn't match. Please try again.&lt;/p&gt;
  {% endif %}

<span class="CodeAnnotationHang" aria-label="annotation2">❷</span>   &lt;form action="{% url 'accounts:login' %}" method='post'&gt;
    {% csrf_token %}
<span class="CodeAnnotationHang" aria-label="annotation3">❸</span>     {{ form.as_div }}

<span class="CodeAnnotationHang" aria-label="annotation4">❹</span>     &lt;button name="submit"&gt;Log in&lt;/button&gt;
  &lt;/form&gt;

{% endblock content %}</code></pre>
<p>This template extends <em>base.html</em> to ensure that the login page will have the same look and feel as the rest of the site. Note that a template in one app can inherit from a template in another app.</p>
<p>If the form’s <code>errors</code> attribute is set, we display an error message <span class="CodeAnnotation" aria-label="annotation1">❶</span>, reporting that the username and password combination doesn’t match anything stored in the database.</p>
<p>We want the login view to process the form, so we set the <code>action</code> argument as the URL of the login page <span class="CodeAnnotation" aria-label="annotation2">❷</span>. The login view sends a <code>form</code> object to the template, and it’s up to us to display the form <span class="CodeAnnotation" aria-label="annotation3">❸</span> and add a submit button <span class="CodeAnnotation" aria-label="annotation4">❹</span>.</p>
<h4 id="h3-502703c19-0019">The LOGIN_REDIRECT_URL Settting</h4>
<p class="BodyFirst">Once a user logs in successfully, Django needs to know where to send that user. We control this in the settings file.</p>
<p><span epub:type="pagebreak" title="418" id="Page_418"/>Add the following code to the end of <em>settings.py</em>:</p>
<p class="CodeLabel"><b>settings.py</b></p>
<pre><code><em class="LiteralGrayItalic">--snip--</em>
# My settings.
LOGIN_REDIRECT_URL = 'learning_logs:index'</code></pre>
<p>With all the default settings in <em>settings.py</em>, it’s helpful to mark off the section where we’re adding new settings. The first new setting we’ll add is <code>LOGIN_REDIRECT_URL</code>, which tells Django which URL to redirect to after a successful login attempt.</p>
<h4 id="h3-502703c19-0020">Linking to the Login Page</h4>
<p class="BodyFirst">Let’s add the login link to <em>base.html</em> so it appears on every page. We don’t want the link to display when the user is already logged in, so we nest it inside an <code>{% if %}</code> tag:</p>
<p class="CodeLabel"><b>base.html</b></p>
<pre><code><span class="LiteralGray">&lt;p&gt;</span>
<span class="LiteralGray">  &lt;a href="{% url 'learning_logs:index' %}"&gt;Learning Log&lt;/a&gt; -</span>
<span class="LiteralGray">  </span>&lt;a href="{% url 'learning_logs:topics' %}"&gt;Topics&lt;/a&gt; -
<span class="CodeAnnotationHang" aria-label="annotation1">❶</span>   {% if user.is_authenticated %}
<span class="CodeAnnotationHang" aria-label="annotation2">❷</span>     Hello, {{ user.username }}.
  {% else %}
<span class="CodeAnnotationHang" aria-label="annotation3">❸</span>     &lt;a href="{% url 'accounts:login' %}"&gt;Log in&lt;/a&gt;
  {% endif %}
<span class="LiteralGray">&lt;/p&gt;</span>

<span class="LiteralGray">{% block content %}{% endblock content %}</span></code></pre>
<p>In Django’s authentication system, every template has a <code>user</code> object available that always has an <code>is_authenticated</code> attribute set: the attribute is <code>True</code> if the user is logged in and <code>False</code> if they aren’t. This attribute allows you to display one message to authenticated users and another to unauthenticated users.</p>
<p>Here we display a greeting to users currently logged in <span class="CodeAnnotation" aria-label="annotation1">❶</span>. Authenticated users have an additional <code>username</code> attribute set, which we use to personalize the greeting and remind the user they’re logged in <span class="CodeAnnotation" aria-label="annotation2">❷</span>. For users who haven’t been authenticated, we display a link to the login page <span class="CodeAnnotation" aria-label="annotation3">❸</span>.</p>
<h4 id="h3-502703c19-0021">Using the Login Page</h4>
<p class="BodyFirst">We’ve already set up a user account, so let’s log in to see if the page works. Go to <em>http://localhost:8000/admin/</em>. If you’re still logged in as an admin, look for a <b>logout</b> link in the header and click it.</p>
<p>When you’re logged out, go to <em>http://localhost:8000/accounts/login/</em>. You should see a login page similar to the one shown in <a href="#figure19-4" id="figureanchor19-4">Figure 19-4</a>. Enter the username and password you set up earlier, and you should be brought back to the home page. The header on the home page should display a greeting personalized with your username.</p>
<span epub:type="pagebreak" title="419" id="Page_419"/><figure>
<img src="Images/f19004.png" class="keyline" alt="" width="624" height="368"/>
<figcaption><p><a id="figure19-4">Figure 19-4</a>: The login page</p></figcaption>
</figure>
<h3 id="h2-502703c19-0006">Logging Out</h3>
<p class="BodyFirst">Now we need to provide a way for users to log out. Logout requests should be submitted as POST requests, so we’ll add a small logout form to <em>base.html</em>. When users click the logout button, they’ll go to a page confirming that they’ve been logged out.</p>
<h4 id="h3-502703c19-0022">Adding a Logout Form to base.html</h4>
<p class="BodyFirst">We’ll add the form for logging out to <em>base.html</em> so it’s available on every page. We’ll include it in another <code>if</code> block, so only users who are already logged in can see it:</p>
<p class="CodeLabel"><b>base.html</b></p>
<pre><code><em class="LiteralGrayItalic">--snip--</em>
<span class="LiteralGray">{% block content %}{% endblock content %}</span>

{% if user.is_authenticated %}
<span class="CodeAnnotationHang" aria-label="annotation1">❶</span>   &lt;hr /&gt;
<span class="CodeAnnotationHang" aria-label="annotation2">❷</span>   &lt;form action="{% url 'accounts:logout' %}" method='post'&gt;
    {% csrf_token %}
    &lt;button name='submit'&gt;Log out&lt;/button&gt;
  &lt;/form&gt;
{% endif %}</code></pre>
<p>The default URL pattern for logging out is <code>'accounts/logout/'</code>. However, the request has to be sent as a POST request; otherwise, attackers can easily force logout requests. To make the logout request use POST, we define a simple form.</p>
<p>We place the form at the bottom of the page, below a horizontal rule element (<code>&lt;hr /&gt;</code>) <span class="CodeAnnotation" aria-label="annotation1">❶</span>. This is an easy way to always keep the logout button in a <span epub:type="pagebreak" title="420" id="Page_420"/>consistent position below any other content on the page. The form itself has the logout URL as its <code>action</code> argument, and <code>'post'</code> as the request method <span class="CodeAnnotation" aria-label="annotation2">❷</span>. Every form in Django needs to include the <code>{% csrf_token %}</code>, even a simple form like this one. This form is empty except for the submit button.</p>
<h4 id="h3-502703c19-0023">The LOGOUT_REDIRECT_URL Setting</h4>
<p class="BodyFirst">When the user clicks the logout button, Django needs to know where to send them. We control this behavior in <em>settings.py</em>:</p>
<p class="CodeLabel"><b>settings.py</b></p>
<pre><code><em class="LiteralGrayItalic">--snip--</em>
<span class="LiteralGray"># My settings.</span>
<span class="LiteralGray">LOGIN_REDIRECT_URL = 'learning_logs:index'</span>
LOGOUT_REDIRECT_URL = 'learning_logs:index'</code></pre>
<p>The <code>LOGOUT_REDIRECT_URL</code> setting shown here tells Django to redirect logged-out users back to the home page. This is a simple way to confirm that they were logged out, because they should no longer see their username after logging out.</p>
<h3 id="h2-502703c19-0007">The Registration Page</h3>
<p class="BodyFirst">Next, we’ll build a page so new users can register. We’ll use Django’s default <code>UserCreationForm</code>, but write our own view function and template.</p>
<h4 id="h3-502703c19-0024">The register URL</h4>
<p class="BodyFirst">The following code provides the URL pattern for the registration page, which should be placed in <em>accounts/urls.py</em>:</p>
<p class="CodeLabel"><b>accounts/urls.py</b></p>
<pre><code><span class="LiteralGray">"""Defines URL patterns for accounts."""</span>

<span class="LiteralGray">from django.urls import path, include</span>

from . import views

<span class="LiteralGray">app_name = accounts</span>
<span class="LiteralGray">urlpatterns = [</span>
<span class="LiteralGray">    # Include default auth urls.</span>
<span class="LiteralGray">    path('', include('django.contrib.auth.urls')),</span>
    # Registration page.
    path('register/', views.register, name='register'),
<span class="LiteralGray">]</span></code></pre>
<p>We import the <code>views</code> module from <code>accounts</code>, which we need because we’re writing our own view for the registration page. The pattern for the registration page matches the URL <em>http://localhost:8000/accounts/register/</em> and sends requests to the <code>register()</code> function we’re about to write.</p>
<h4 id="h3-502703c19-0025"><span epub:type="pagebreak" title="421" id="Page_421"/>The register() View Function</h4>
<p class="BodyFirst">The <code>register()</code> view function needs to display a blank registration form when the registration page is first requested, and then process completed registration forms when they’re submitted. When a registration is successful, the function also needs to log the new user in. Add the following code to<em> accounts/views.py</em>:</p>
<p class="CodeLabel"><b>accounts/views.py</b></p>
<pre><code>from django.shortcuts import render, redirect
from django.contrib.auth import login
from django.contrib.auth.forms import UserCreationForm

def register(request):
    """Register a new user."""
    if request.method != 'POST':
        # Display blank registration form.
<span class="CodeAnnotationHang" aria-label="annotation1">❶</span>         form = UserCreationForm()
    else:
        # Process completed form.
<span class="CodeAnnotationHang" aria-label="annotation2">❷</span>         form = UserCreationForm(data=request.POST)

<span class="CodeAnnotationHang" aria-label="annotation3">❸</span>         if form.is_valid():
<span class="CodeAnnotationHang" aria-label="annotation4">❹</span>             new_user = form.save()
            # Log the user in and then redirect to home page.
<span class="CodeAnnotationHang" aria-label="annotation5">❺</span>             login(request, new_user)
<span class="CodeAnnotationHang" aria-label="annotation6">❻</span>             return redirect('learning_logs:index')

    # Display a blank or invalid form.
    context = {'form': form}
    return render(request, 'registration/register.html', context)</code></pre>
<p>We import the <code>render()</code> and <code>redirect()</code> functions, and then we import the <code>login()</code> function to log the user in if their registration information is correct. We also import the default <code>UserCreationForm</code>. In the <code>register()</code> function, we check whether we’re responding to a POST request. If we’re not, we make an instance of <code>UserCreationForm</code> with no initial data <span class="CodeAnnotation" aria-label="annotation1">❶</span>.</p>
<p>If we’re responding to a POST request, we make an instance of <code>UserCreationForm</code> based on the submitted data <span class="CodeAnnotation" aria-label="annotation2">❷</span>. We check that the data is valid <span class="CodeAnnotation" aria-label="annotation3">❸</span>—in this case, that the username has the appropriate characters, the passwords match, and the user isn’t trying to do anything malicious in their submission.</p>
<p>If the submitted data is valid, we call the form’s <code>save()</code> method to save the username and the hash of the password to the database <span class="CodeAnnotation" aria-label="annotation4">❹</span>. The <code>save()</code> method returns the newly created user object, which we assign to <code>new_user</code>. When the user’s information is saved, we log them in by calling the <code>login()</code> function with the <code>request</code> and <code>new_user</code> objects <span class="CodeAnnotation" aria-label="annotation5">❺</span>, which creates a valid session for the new user. Finally, we redirect the user to the home page <span class="CodeAnnotation" aria-label="annotation6">❻</span>, <span epub:type="pagebreak" title="422" id="Page_422"/>where a personalized greeting in the header tells them their registration was successful.</p>
<p>At the end of the function, we render the page, which will be either a blank form or a submitted form that’s invalid.</p>
<h4 id="h3-502703c19-0026">The register Template</h4>
<p class="BodyFirst">Now create a template for the registration page, which will be similar to the login page. Be sure to save it in the same directory as <em>login.html</em>:</p>
<p class="CodeLabel"><b>register.html</b></p>
<pre><code>{% extends "learning_logs/base.html" %}

{% block content %}

  &lt;form action="{% url 'accounts:register' %}" method='post'&gt;
    {% csrf_token %}
    {{ form.as_div }}

    &lt;button name="submit"&gt;Register&lt;/button&gt;
  &lt;/form&gt;

{% endblock content %}</code></pre>
<p>This should look like the other form-based templates we’ve been writing. We use the <code>as_div</code> method again so Django will display all the fields in the form appropriately, including any error messages if the form isn’t filled out correctly.</p>
<h4 id="h3-502703c19-0027">Linking to the Registration Page</h4>
<p class="BodyFirst">Next, we’ll add code to show the registration page link to any user who isn’t currently logged in:</p>
<p class="CodeLabel"><b>base.html</b></p>
<pre><code><em class="LiteralGrayItalic">--snip--</em>
<span class="LiteralGray">  {% if user.is_authenticated %}</span>
<span class="LiteralGray">    Hello, {{ user.username }}.</span>
<span class="LiteralGray">  {% else %}</span>
<span class="LiteralGray">    </span>&lt;a href="{% url 'accounts:register' %}"&gt;Register&lt;/a&gt; -
<span class="LiteralGray">    &lt;a href="{% url 'accounts:login' %}"&gt;Log in&lt;/a&gt;</span>
<span class="LiteralGray">  {% endif %}</span>
<em class="LiteralGrayItalic">--snip--</em></code></pre>
<p>Now users who are logged in see a personalized greeting and a logout button. Users who aren’t logged in see a registration link and a login link. Try out the registration page by making several user accounts with different usernames.</p>
<p>In the next section, we’ll restrict some of the pages so they’re available only to registered users, and we’ll make sure every topic belongs to a specific user.</p>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="note">
<span epub:type="pagebreak" title="423" id="Page_423"/><h2><span class="NoteHead">Note</span></h2>
<p>	The registration system we’ve set up allows anyone to make any number of accounts for Learning Log. Some systems require users to confirm their identity by sending a confirmation email that users must reply to. By doing so, the system generates fewer spam accounts than the simple system we’re using here. However, when you’re learning to build apps, it’s perfectly appropriate to practice with a simple user registration system like the one we’re using.</p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="box">
<h2>Try It Yourself</h2>
<p class="BoxBodyCustom"><span id="h2-502703c19-09" class="BoxNumber">19-2.	Blog Accounts:</span> Add a user authentication and registration system to the Blog project you started in Exercise 19-1 (<span class="xref" itemid="xref_target_page 415">page 415</span>). Make sure logged-in users see their username somewhere on the screen and unregistered users see a link to the registration page.</p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<h2 id="h1-502703c19-0003">Allowing Users to Own Their Data</h2>
<p class="BodyFirst">Users should be able to enter private data in their learning logs, so we’ll create a system to figure out which data belongs to which user. Then we’ll restrict access to certain pages so users can only work with their own data.</p>
<p>We’ll modify the <code>Topic</code> model so every topic belongs to a specific user. This will also take care of entries, because every entry belongs to a specific topic. We’ll start by restricting access to certain pages.</p>
<h3 id="h2-502703c19-0008">Restricting Access with @login_required</h3>
<p class="BodyFirst">Django makes it easy to restrict access to certain pages through the <code>@login_required</code> decorator. Recall from <span class="xref" itemid="xref_target_Chapter 11">Chapter 11</span> that a <em>decorator</em> is a directive placed just before a function definition, which modifies how the function behaves. Let’s look at an example.</p>
<h4 id="h3-502703c19-0028">Restricting Access to the Topics Page</h4>
<p class="BodyFirst">Each topic will be owned by a user, so only registered users can request the topics page. Add the following code to <em>learning_logs/views.py</em>:</p>
<p class="CodeLabel"><b>learning_logs/views.py</b></p>
<pre><code><span class="LiteralGray">from django.shortcuts import render, redirect</span>
from django.contrib.auth.decorators import login_required

<span class="LiteralGray">from .models import Topic, Entry</span>
<em class="LiteralGrayItalic">--snip--</em>

@login_required
<span class="LiteralGray">def topics(request):</span>
<span class="LiteralGray">    """Show all topics."""</span>
<span class="LiteralGray">    </span><em class="LiteralGrayItalic">--snip--</em></code></pre>
<p><span epub:type="pagebreak" title="424" id="Page_424"/>We first import the <code>login_required()</code> function. We apply <code>login_required()</code> as a decorator to the <code>topics()</code> view function by prepending <code>login_required</code> with the <code>@</code> symbol. As a result, Python knows to run the code in <code>login_required()</code> before the code in <code>topics()</code>.</p>
<p>The code in <code>login_required()</code> checks whether a user is logged in, and Django runs the code in <code>topics()</code> only if they are. If the user isn’t logged in, they’re redirected to the login page.</p>
<p>To make this redirect work, we need to modify <em>settings.py</em> so Django knows where to find the login page. Add the following at the end of <em>settings.py</em>:</p>
<p class="CodeLabel"><b>settings.py</b></p>
<pre><code><em class="LiteralGrayItalic">--snip--</em>
<span class="LiteralGray"># My settings.</span>
<span class="LiteralGray">LOGIN_REDIRECT_URL = 'learning_logs:index'</span>
<span class="LiteralGray">LOGOUT_REDIRECT_URL = 'learning_logs:index'</span>
LOGIN_URL = 'accounts:login'</code></pre>
<p>Now when an unauthenticated user requests a page protected by the <code>@login_required</code> decorator, Django will send the user to the URL defined by <code>LOGIN_URL</code> in <em>settings.py</em>.</p>
<p>You can test this setting by logging out of any user accounts and going to the home page. Click the <b>Topics</b> link, which should redirect you to the login page. Then log in to any of your accounts, and from the home page, click the <b>Topics</b> link again. You should be able to access the topics page.</p>
<h4 id="h3-502703c19-0029">Restricting Access Throughout Learning Log</h4>
<p class="BodyFirst">Django makes it easy to restrict access to pages, but you have to decide which pages to protect. It’s best to think about which pages need to be unrestricted first, and then restrict all the other pages in the project. You can easily correct over-restricted access, and it’s less dangerous than leaving sensitive pages unrestricted.</p>
<p>In Learning Log, we’ll keep the home page and the registration page unrestricted. We’ll restrict access to every other page.</p>
<p>Here’s <em>learning_logs/views.py</em> with <code>@login_required</code> decorators applied to every view except <code>index()</code>:</p>
<p class="CodeLabel"><b>learning_logs/views.py</b></p>
<pre><code><em class="LiteralGrayItalic">--snip--</em>
<span class="LiteralGray">@login_required</span>
<span class="LiteralGray">def topics(request):</span>
<span class="LiteralGray">    </span><em class="LiteralGrayItalic">--snip--</em>

@login_required
<span class="LiteralGray">def topic(request, topic_id):</span>
<span class="LiteralGray">    </span><em class="LiteralGrayItalic">--snip--</em>

@login_required
<span class="LiteralGray">def new_topic(request):</span>
<span class="LiteralGray">    </span><em class="LiteralGrayItalic">--snip--</em>

<span epub:type="pagebreak" title="425" id="Page_425"/>@login_required
<span class="LiteralGray">def new_entry(request, topic_id):</span>
<span class="LiteralGray">    </span><em class="LiteralGrayItalic">--snip--</em>

@login_required
<span class="LiteralGray">def edit_entry(request, entry_id):</span>
<span class="LiteralGray">    </span><em class="LiteralGrayItalic">--snip--</em></code></pre>
<p>Try accessing each of these pages while logged out; you should be redirected back to the login page. You’ll also be unable to click links to pages such as <code>new_topic</code>. But if you enter the URL <em>http://localhost:8000/new_topic/</em>, you’ll be redirected to the login page. You should restrict access to any URL that’s publicly accessible and relates to private user data.</p>
<h3 id="h2-502703c19-0009">Connecting Data to Certain Users</h3>
<p class="BodyFirst">Next, we need to connect the data to the user who submitted it. We only need to connect the data highest in the hierarchy to a user, and the lower-level data will follow. In Learning Log, topics are the highest level of data in the app, and all entries are connected to a topic. As long as each topic belongs to a specific user, we can trace the ownership of each entry in the database.</p>
<p>We’ll modify the <code>Topic</code> model by adding a foreign key relationship to a user. We’ll then have to migrate the database. Finally, we’ll modify some of the views so they only show the data associated with the currently logged-in user.</p>
<h4 id="h3-502703c19-0030">Modifying the Topic Model</h4>
<p class="BodyFirst">The modification to <em>models.py</em> is just two lines:</p>
<p class="CodeLabel"><b>models.py</b></p>
<pre><code><span class="LiteralGray">from django.db import models</span>
from django.contrib.auth.models import User

<span class="LiteralGray">class Topic(models.Model):</span>
<span class="LiteralGray">   """A topic the user is learning about."""</span>
<span class="LiteralGray">    Text = models.CharField(max_length=200)</span>
<span class="LiteralGray">    date_added = models.DateTimeField(auto_now_add=True)</span>
    owner = models.ForeignKey(User, on_delete=models.CASCADE)

<span class="LiteralGray">    def __str__(self):</span>
<span class="LiteralGray">        """Return a string representing the topic."""</span>
<span class="LiteralGray">        Return self.text</span>

<span class="LiteralGray">class Entry(models.Model):</span>
<span class="LiteralGray">    </span><em class="LiteralGrayItalic">--snip--</em></code></pre>
<p>We import the <code>User</code> model from <code>django.contrib.auth</code>. Then we add an <code>owner</code> field to <code>Topic</code>, which establishes a foreign key relationship to the <code>User</code> model. If a user is deleted, all the topics associated with that user will be deleted as well.</p>
<h4 id="h3-502703c19-0031"><span epub:type="pagebreak" title="426" id="Page_426"/>Identifying Existing Users</h4>
<p class="BodyFirst">When we migrate the database, Django will modify the database so it can store a connection between each topic and a user. To make the migration, Django needs to know which user to associate with each existing topic. The simplest approach is to start by assigning all existing topics to one user—for example, the superuser. But first, we need to know that user’s ID.</p>
<p>Let’s look at the IDs of all users created so far. Start a Django shell session and issue the following commands:</p>
<pre><code>(ll_env)learning_log$ <b>python manage.py shell</b>
<span class="CodeAnnotationHang" aria-label="annotation1">❶</span> &gt;&gt;&gt; <b>from django.contrib.auth.models import User</b>
<span class="CodeAnnotationHang" aria-label="annotation2">❷</span> &gt;&gt;&gt; <b>User.objects.all()</b>
&lt;QuerySet [&lt;User: ll_admin&gt;, &lt;User: eric&gt;, &lt;User: willie&gt;]&gt;
<span class="CodeAnnotationHang" aria-label="annotation3">❸</span> &gt;&gt;&gt; <b>for user in User.objects.all():</b>
...     <b>print(user.username, user.id)</b>
...
ll_admin 1
eric 2
willie 3
&gt;&gt;&gt;</code></pre>
<p>We first import the <code>User</code> model into the shell session <span class="CodeAnnotation" aria-label="annotation1">❶</span>. We then look at all the users that have been created so far <span class="CodeAnnotation" aria-label="annotation2">❷</span>. The output shows three users for my version of the project: <code>ll_admin</code>, <code>eric</code>, and <code>willie</code>.</p>
<p>Next, we loop through the list of users and print each user’s username and ID <span class="CodeAnnotation" aria-label="annotation3">❸</span>. When Django asks which user to associate the existing topics with, we’ll use one of these ID values.</p>
<h4 id="h3-502703c19-0032">Migrating the Database</h4>
<p class="BodyFirst">Now that we know the IDs, we can migrate the database. When we do this, Python will ask us to connect the <code>Topic</code> model to a particular owner temporarily or to add a default to our <em>models.py</em> file to tell it what to do. Choose option <b>1</b>:</p>
<pre><code><span class="CodeAnnotationHang" aria-label="annotation1">❶</span> (ll_env)learning_log$ <b>python manage.py makemigrations learning_logs</b>
<span class="CodeAnnotationHang" aria-label="annotation2">❷</span> It is impossible to add a non-nullable field 'owner' to topic without
specifying a default. This is because...
<span class="CodeAnnotationHang" aria-label="annotation3">❸</span> Please select a fix:
 1) Provide a one-off default now (will be set on all existing rows with a
    null value for this column)
 2) Quit and manually define a default value in models.py.
<span class="CodeAnnotationHang" aria-label="annotation4">❹</span> Select an option: <b>1</b>
<span class="CodeAnnotationHang" aria-label="annotation5">❺</span> Please enter the default value now, as valid Python
The datetime and django.utils.timezone modules are available...
Type 'exit' to exit this prompt
<span class="CodeAnnotationHang" aria-label="annotation6">❻</span> &gt;&gt;&gt; <b>1</b>
Migrations for 'learning_logs':
  learning_logs/migrations/0003_topic_owner.py
- Add field owner to topic
(ll_env)learning_log$</code></pre>
<p><span epub:type="pagebreak" title="427" id="Page_427"/>We start by issuing the <code>makemigrations</code> command <span class="CodeAnnotation" aria-label="annotation1">❶</span>. In the output, Django indicates that we’re trying to add a required (<em>non-nullable</em>) field to an existing model (<code>topic</code>) with no default value specified <span class="CodeAnnotation" aria-label="annotation2">❷</span>. Django gives us two options: we can provide a default right now, or we can quit and add a default value in <em>models.py</em> <span class="CodeAnnotation" aria-label="annotation3">❸</span>. Here I’ve chosen the first option <span class="CodeAnnotation" aria-label="annotation4">❹</span>. Django then asks us to enter the default value <span class="CodeAnnotation" aria-label="annotation5">❺</span>.</p>
<p>To associate all existing topics with the original admin user, <code>ll_admin</code>, I entered the user ID of <code>1</code> <span class="CodeAnnotation" aria-label="annotation6">❻</span>. You can use the ID of any user you’ve created; it doesn’t have to be a superuser. Django then migrates the database using this value and generates the migration file <em>0003_topic_owner.py</em>, which adds the field <code>owner</code> to the <code>Topic</code> model.</p>
<p>Now we can execute the migration. Enter the following in an active virtual environment:</p>
<pre><code>(ll_env)learning_log$ <b>python manage.py migrate</b>
Operations to perform:
  Apply all migrations: admin, auth, contenttypes, learning_logs, sessions
Running migrations:
<span class="CodeAnnotationHang" aria-label="annotation1">❶</span>   Applying learning_logs.0003_topic_owner... OK
(ll_env)learning_log$</code></pre>
<p>Django applies the new migration, and the result is <code>OK</code> <span class="CodeAnnotation" aria-label="annotation1">❶</span>.</p>
<p>We can verify that the migration worked as expected in a shell session, like this:</p>
<pre><code>&gt;&gt;&gt; <b>from learning_logs.models import Topic</b>
&gt;&gt;&gt; <b>for topic in Topic.objects.all():</b>
...     <b>print(topic, topic.owner)</b>
...
Chess ll_admin
Rock Climbing ll_admin
&gt;&gt;&gt;</code></pre>
<p>We import <code>Topic</code> from <code>learning_logs.models</code> and then loop through all existing topics, printing each topic and the user it belongs to. You can see that each topic now belongs to the user <code>ll_admin</code>. (If you get an error when you run this code, try exiting the shell and starting a new shell.)</p>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="note">
<h2><span class="NoteHead">Note</span></h2>
<p>	You can simply reset the database instead of migrating, but that will lose all existing data. It’s good practice to learn how to migrate a database while maintaining the integrity of users’ data. If you do want to start with a fresh database, issue the command <code class="bold">python manage.py flush</code> to rebuild the database structure. You’ll have to create a new superuser, and all of your data will be gone.</p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<h3 id="h2-502703c19-0010">Restricting Topics Access to Appropriate Users</h3>
<p class="BodyFirst">Currently, if you’re logged in, you’ll be able to see all the topics, no matter which user you’re logged in as. We’ll change that by showing users only the topics that belong to them.</p>
<p><span epub:type="pagebreak" title="428" id="Page_428"/>Make the following change to the <code>topics()</code> function in <em>views.py</em>:</p>
<p class="CodeLabel"><b>learning_logs/views.py</b></p>
<pre><code><em class="LiteralGrayItalic">--snip--</em>
<span class="LiteralGray">@login_required</span>
<span class="LiteralGray">def topics(request):</span>
<span class="LiteralGray">    """Show all topics."""</span>
    topics = Topic.objects.filter(owner=request.user).order_by('date_added')
<span class="LiteralGray">    context = {'topics': topics}</span>
<span class="LiteralGray">    return render(request, 'learning_logs/topics.html', context)</span>
<em class="LiteralGrayItalic">--snip--</em></code></pre>
<p>When a user is logged in, the <code>request</code> object has a <code>request.user</code> attribute set, which contains information about the user. The query <code>Topic.objects.filter(owner=request.user)</code> tells Django to retrieve only the <code>Topic</code> objects from the database whose <code>owner</code> attribute matches the current user. Because we’re not changing how the topics are displayed, we don’t need to change the template for the topics page at all.</p>
<p>To see if this works, log in as the user you connected all existing topics to, and go to the topics page. You should see all the topics. Now log out and log back in as a different user. You should see the message “No topics have been added yet.”</p>
<h3 id="h2-502703c19-0011">Protecting a User’s Topics</h3>
<p class="BodyFirst">We haven’t restricted access to the topic pages yet, so any registered user could try a bunch of URLs (like <em>http://localhost:8000/topics/1/</em>) and retrieve topic pages that happen to match.</p>
<p>Try it yourself. While logged in as the user that owns all topics, copy the URL or note the ID in the URL of a topic, and then log out and log back in as a different user. Enter that topic’s URL. You should be able to read the entries, even though you’re logged in as a different user.</p>
<p>We’ll fix this now by performing a check before retrieving the requested entries in the <code>topic()</code> view function:</p>
<p class="CodeLabel"><b>learning_logs/views.py</b></p>
<pre><code><span class="LiteralGray">from django.shortcuts import render, redirect</span>
<span class="LiteralGray">from django.contrib.auth.decorators import login_required</span>
<span class="CodeAnnotationHang" aria-label="annotation1">❶</span> from django.http import Http404

<em class="LiteralGrayItalic">--snip--</em>
<span class="LiteralGray">@login_required</span>
<span class="LiteralGray">def topic(request, topic_id):</span>
<span class="LiteralGray">    """Show a single topic and all its entries."""</span>
<span class="LiteralGray">    topic = Topic.objects.get(id=topic_id)</span>
    # Make sure the topic belongs to the current user.
<span class="CodeAnnotationHang" aria-label="annotation2">❷</span>     if topic.owner != request.user:
        raise Http404

<span class="LiteralGray">    entries = topic.entry_set.order_by('-date_added')</span>
<span class="LiteralGray">    context = {'topic': topic, 'entries': entries}</span>
<span class="LiteralGray">    return render(request, 'learning_logs/topic.html', context)</span>
<em class="LiteralGrayItalic">--snip--</em></code></pre>
<p><span epub:type="pagebreak" title="429" id="Page_429"/>A 404 response is a standard error response that’s returned when a requested resource doesn’t exist on a server. Here we import the <code>Http404</code> exception <span class="CodeAnnotation" aria-label="annotation1">❶</span>, which we’ll raise if the user requests a topic they shouldn’t have access to. After receiving a topic request, we make sure the topic’s user matches the currently logged-in user before rendering the page. If the requested topic’s owner is not the same as the current user, we raise the <code>Http404</code> exception <span class="CodeAnnotation" aria-label="annotation2">❷</span>, and Django returns a 404-error page.</p>
<p>Now if you try to view another user’s topic entries, you’ll see a “Page Not Found” message from Django. In <span class="xref" itemid="xref_target_Chapter 20">Chapter 20</span>, we’ll configure the project so users will see a proper error page instead of a debugging page.</p>
<h3 id="h2-502703c19-0012">Protecting the edit_entry Page</h3>
<p class="BodyFirst">The <code>edit_entry</code> pages have URLs of the form <em>http://localhost:8000/edit_entry/entry_id/</em>, where the <var>entry_id</var> is a number. Let’s protect this page so no one can use the URL to gain access to someone else’s entries:</p>
<p class="CodeLabel"><b>learning_logs/views.py</b></p>
<pre><code><em class="LiteralGrayItalic">--snip--</em>
<span class="LiteralGray">@login_required</span>
<span class="LiteralGray">def edit_entry(request, entry_id):</span>
<span class="LiteralGray">    """Edit an existing entry."""</span>
<span class="LiteralGray">    entry = Entry.objects.get(id=entry_id)</span>
<span class="LiteralGray">    topic = entry.topic</span>
    if topic.owner != request.user:
        raise Http404

    <span class="LiteralGray">if request.method != 'POST':</span>
<span class="LiteralGray">        </span><em class="LiteralGrayItalic">--snip--</em></code></pre>
<p>We retrieve the entry and the topic associated with this entry. We then check whether the owner of the topic matches the currently logged-in user; if they don’t match, we raise an <code>Http404</code> exception.</p>
<h3 id="h2-502703c19-0013">Associating New Topics with the Current User</h3>
<p class="BodyFirst">Currently, the page for adding new topics is broken because it doesn’t associate new topics with any particular user. If you try adding a new topic, you’ll see the message <code>IntegrityError</code> along with <code>NOT NULL constraint failed: learning_logs_topic.owner_id</code>. Django is saying you can’t create a new topic without specifying a value for the topic’s <code>owner</code> field.</p>
<p>There’s a straightforward fix for this problem, because we have access to the current user through the <code>request</code> object. Add the following code, which associates the new topic with the current user:</p>
<p class="CodeLabel"><b>learning_logs/views.py</b></p>
<pre><code><em class="LiteralGrayItalic">--snip--</em>
<span class="LiteralGray">@login_required</span>
<span class="LiteralGray">def new_topic(request):</span>
<span class="LiteralGray">    </span><em class="LiteralGrayItalic">--snip--</em>
<span class="LiteralGray">    else:</span>
<span class="LiteralGray">        # POST data submitted; process data.</span>
<span class="LiteralGray">        form = TopicForm(data=request.POST)</span>
<span class="LiteralGray">        if form.is_valid():</span>
<span epub:type="pagebreak" title="430" id="Page_430"/><span class="CodeAnnotationHang" aria-label="annotation1">❶</span>             new_topic = form.save(commit=False)
<span class="CodeAnnotationHang" aria-label="annotation2">❷</span>             new_topic.owner = request.user
<span class="CodeAnnotationHang" aria-label="annotation3">❸</span>             new_topic.save()
<span class="LiteralGray">            return redirect('learning_logs:topics')</span>

<span class="LiteralGray">    # Display a blank or invalid form.</span>
<span class="LiteralGray">    context = {'form': form}</span>
<span class="LiteralGray">    return render(request, 'learning_logs/new_topic.html', context)</span>
<span class="LiteralGray"> </span><em class="LiteralGrayItalic">--snip--</em></code></pre>
<p>When we first call <code>form.save()</code>, we pass the <code>commit=False</code> argument because we need to modify the new topic before saving it to the database <span class="CodeAnnotation" aria-label="annotation1">❶</span>. We then set the new topic’s <code>owner</code> attribute to the current user <span class="CodeAnnotation" aria-label="annotation2">❷</span>. Finally, we call <code>save()</code> on the topic instance we just defined <span class="CodeAnnotation" aria-label="annotation3">❸</span>. Now the topic has all the required data and will save successfully.</p>
<p>You should be able to add as many new topics as you want for as many different users as you want. Each user will only have access to their own data, whether they’re viewing data, entering new data, or modifying old data.</p>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="box">
<h2>Try It Yourself</h2>
<p class="BoxBodyCustom"><span id="h2-502703c19-16" class="BoxNumber">19-3.	Refactoring:</span> There are two places in <em>views.py</em> where we make sure the user associated with a topic matches the currently logged-in user. Put the code for this check in a function called <code>check_topic_owner()</code>, and call this function where appropriate.</p>
<p class="BoxBodyCustom"><span id="h2-502703c19-17" class="BoxNumber">19-4.	Protecting new_entry:</span> Currently, a user can add a new entry to another user’s learning log by entering a URL with the ID of a topic belonging to another user. Prevent this attack by checking that the current user owns the entry’s topic before saving the new entry.</p>
<p class="BoxBodyCustom"><span id="h2-502703c19-18" class="BoxNumber">19-5.	Protected Blog:</span> In your Blog project, make sure each blog post is connected to a particular user. Make sure all posts are publicly accessible but only registered users can add posts and edit existing posts. In the view that allows users to edit their posts, make sure the user is editing their own post before processing the form.</p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<h2 id="h1-502703c19-0004">Summary</h2>
<p class="BodyFirst">In this chapter, you learned how forms allow users to add new topics and entries, and edit existing entries. You then learned how to implement user accounts. You gave existing users the ability to log in and out, and used Django’s default <code>UserCreationForm</code> to let people create new accounts.</p>
<p><span epub:type="pagebreak" title="431" id="Page_431"/>After building a simple user authentication and registration system, you restricted access to logged-in users for certain pages using the <code>@login_required</code> decorator. You then assigned data to specific users through a foreign key relationship. You also learned to migrate the database when the migration requires you to specify some default data.</p>
<p>Finally, you learned how to make sure a user can only see data that belongs to them by modifying the view functions. You retrieved appropriate data using the <code>filter()</code> method, and compared the owner of the requested data to the currently logged-in user.</p>
<p>It might not always be immediately obvious what data you should make available and what data you should protect, but this skill will come with practice. The decisions we’ve made in this chapter to secure our users’ data also illustrate why working with others is a good idea when building a project: having someone else look over your project makes it more likely that you’ll spot vulnerable areas.</p>
<p>You now have a fully functioning project running on your local machine. In the final chapter, you’ll style Learning Log to make it visually appealing, and you’ll deploy the project to a server so anyone with internet access can register and make an account.</p>
</section>
</div>
<div id="sbo-rt-content"><section>
<header>
<h1 class="chapter">
<span class="ChapterNumber"><span epub:type="pagebreak" title="433" id="Page_433"/>20</span><br/>
<span class="ChapterTitle">Styling and Deploying an App</span></h1>
</header>
<figure class="opener">
<img src="Images/chapterart.png" alt="" width="406" height="406"/>
</figure>
<p class="ChapterIntro">Learning Log is fully functional now, but it has no styling and runs only on your local machine. In this chapter, you’ll style the project in a simple but professional manner and then deploy it to a live server so anyone in the world can make an account and use it.</p>
<p>For the styling, we’ll use the <em>Bootstrap</em> library, a collection of tools for styling web applications so they look professional on all modern devices, from a small phone to a large desktop monitor. To do this, we’ll use the django-bootstrap5 app, which will also give you practice using apps made by other Django developers.</p>
<p>We’ll deploy Learning Log using <em>Platform.sh</em>, a site that lets you push your project to one of its servers, making it available to anyone with an internet connection. We’ll also start using a version control system called Git to track changes to the project.</p>
<p><span epub:type="pagebreak" title="434" id="Page_434"/>When you’re finished with Learning Log, you’ll be able to develop simple web applications, give them a professional look and feel, and deploy them to a live server. You’ll also be able to use more advanced learning resources as you develop your skills.</p>
<h2 id="h1-502703c20-0001">Styling Learning Log</h2>
<p class="BodyFirst">We’ve purposely ignored styling until now to focus on Learning Log’s functionality first. This is a good way to approach development, because an app is only useful if it works. Once an app is working, its appearance is critical so people will want to use it.</p>
<p>In this section, we’ll install the django-bootstrap5 app and add it to the project. We’ll then use it to style the individual pages in the project, so all the pages have a consistent look and feel.</p>
<h3 id="h2-502703c20-0001">The django-bootstrap5 App</h3>
<p class="BodyFirst">We’ll use django-bootstrap5 to integrate Bootstrap into our project. This app downloads the required Bootstrap files, places them in an appropriate location in your project, and makes the styling directives available in your project’s templates.</p>
<p>To install django-bootstrap5, issue the following command in an active virtual environment:</p>
<pre><code>(ll_env)learning_log$ <b>pip install django-bootstrap5</b>
<var>--snip--</var>
Successfully installed beautifulsoup4-4.11.1 django-bootstrap5-21.3
    soupsieve-2.3.2.post1</code></pre>
<p>Next, we need to add django-bootstrap5 to <code>INSTALLED_APPS</code> in <em>settings.py</em>:</p>
<p class="CodeLabel"><b>settings.py</b></p>
<pre><code><em class="LiteralGrayItalic">--snip--</em>
<span class="LiteralGray">INSTALLED_APPS = [</span>
<span class="LiteralGray">    # My apps.</span>
<span class="LiteralGray">    'learning_logs',</span>
<span class="LiteralGray">    'accounts',</span>

    # Third party apps.
    'django_bootstrap5',

<span class="LiteralGray">    # Default django apps.</span>
<span class="LiteralGray">    'django.contrib.admin',</span>
<span class="LiteralGray">    </span><em class="LiteralGrayItalic">--snip--</em></code></pre>
<p>Start a new section called <code>Third party apps</code>, for apps created by other developers, and add <code>'django_bootstrap5'</code> to this section. Make sure you place this section after <code>My apps</code> but before the section containing Django’s default apps.</p>
<h3 id="h2-502703c20-0002">Using Bootstrap to Style Learning Log</h3>
<p class="BodyFirst">Bootstrap is a large collection of styling tools. It also has a number of templates you can apply to your project to create an overall style. It’s much easier to use these templates than to use individual styling tools. To see the <span epub:type="pagebreak" title="435" id="Page_435"/>templates Bootstrap offers, go to <a href="https://getbootstrap.com" class="LinkURL">https://getbootstrap.com</a> and click <b>Examples</b>. We’ll use the<em> Navbar static</em> template, which provides a simple top navigation bar and a container for the page’s content.</p>
<p><a href="#figure20-1" id="figureanchor20-1">Figure 20-1</a> shows what the home page will look like after we apply Bootstrap’s template to <em>base.html</em> and modify<em> index.html</em> slightly.</p>
<figure>
<img src="Images/f20001.png" class="keyline" alt="" width="604" height="392"/>
<figcaption><p><a id="figure20-1">Figure 20-1</a>: The Learning Log home page using Bootstrap</p></figcaption>
</figure>
<h3 id="h2-502703c20-0003">Modifying base.html</h3>
<p class="BodyFirst">We need to rewrite <em>base.html</em> using the Bootstrap template. We’ll develop the new<em> base.html </em>in sections. This is a large file; you may want to copy this file from the online resources, available at <a href="https://ehmatthes.github.io/pcc_3e" class="LinkURL">https://ehmatthes.github.io/pcc_3e</a>. If you do copy the file, you should still read through the following section to understand the changes that were made.</p>
<h4 id="h3-502703c20-0001">Defining the HTML Headers</h4>
<p class="BodyFirst">The first change we’ll make to <em>base.html</em> defines the HTML headers in the file. We’ll also add some requirements for using Bootstrap in our templates, and give the page a title. Delete everything in <em>base.html</em> and replace it with the following code:</p>
<p class="CodeLabel"><b>base.html</b></p>
<pre><code><span class="CodeAnnotationHang" aria-label="annotation1">❶</span> &lt;!doctype html&gt;
<span class="CodeAnnotationHang" aria-label="annotation2">❷</span> &lt;html lang="en"&gt;
<span class="CodeAnnotationHang" aria-label="annotation3">❸</span> &lt;head&gt;
  &lt;meta charset="utf-8"&gt;
  &lt;meta name="viewport" content="width=device-width, initial-scale=1"&gt;
<span class="CodeAnnotationHang" aria-label="annotation4">❹</span>   &lt;title&gt;Learning Log&lt;/title&gt;

<span class="CodeAnnotationHang" aria-label="annotation5">❺</span>   {% load django_bootstrap5 %}
  {% bootstrap_css %}
  {% bootstrap_javascript %}

&lt;/head&gt;</code></pre>
<p><span epub:type="pagebreak" title="436" id="Page_436"/>We first declare this file as an HTML document <span class="CodeAnnotation" aria-label="annotation1">❶</span> written in English <span class="CodeAnnotation" aria-label="annotation2">❷</span>. An HTML file is divided into two main parts: the <em>head</em> and the <em>body</em>. The head of the file begins with an opening <code>&lt;head&gt;</code> tag <span class="CodeAnnotation" aria-label="annotation3">❸</span>. The head of an HTML file doesn’t hold any of the page’s content; it just tells the browser what it needs to know to display the page correctly. We include a <code>&lt;title&gt;</code> element for the page, which will display in the browser’s title bar whenever Learning Log is open <span class="CodeAnnotation" aria-label="annotation4">❹</span>.</p>
<p>Before closing the head section, we load the collection of template tags available in django-bootstrap5 <span class="CodeAnnotation" aria-label="annotation5">❺</span>. The template tag <code>{% bootstrap_css %}</code> is a custom tag from django-bootstrap5; it loads all of the CSS files required to implement Bootstrap styles. The tag that follows enables all the interactive behavior you might use on a page, such as collapsible navigation bars. The closing <code>&lt;/head&gt;</code> tag appears on the last line.</p>
<p>All Bootstrap styling options are now available in any template that inherits from <em>base.html</em>. If you want to use custom template tags from django-bootstrap5, each template will need to include the <code>{% load django_bootstrap5 %}</code> tag.</p>
<h4 id="h3-502703c20-0002">Defining the Navigation Bar</h4>
<p class="BodyFirst">The code that defines the navigation bar at the top of the page is fairly long, because it has to work equally well on narrow phone screens and wide desktop monitors. We’ll work through the navigation bar in sections.</p>
<p>Here’s the first part of the navigation bar:</p>
<p class="CodeLabel"><b>base.html</b></p>
<pre><code><em class="LiteralGrayItalic">--snip--</em>
<span class="LiteralGray">&lt;/head&gt;</span>
&lt;body&gt;

<span class="CodeAnnotationHang" aria-label="annotation1">❶</span>   &lt;nav class="navbar navbar-expand-md navbar-light bg-light mb-4 border"&gt;
    &lt;div class="container-fluid"&gt;
<span class="CodeAnnotationHang" aria-label="annotation2">❷</span>       &lt;a class="navbar-brand" href="{% url 'learning_logs:index' %}"&gt;
          Learning Log&lt;/a&gt;

<span class="CodeAnnotationHang" aria-label="annotation3">❸</span>       &lt;button class="navbar-toggler" type="button" data-bs-toggle="collapse"
        data-bs-target="#navbarCollapse" aria-controls="navbarCollapse"
        aria-expanded="false" aria-label="Toggle navigation"&gt;
        &lt;span class="navbar-toggler-icon"&gt;&lt;/span&gt;
      &lt;/button&gt;

<span class="CodeAnnotationHang" aria-label="annotation4">❹</span>       &lt;div class="collapse navbar-collapse" id="navbarCollapse"&gt;
<span class="CodeAnnotationHang" aria-label="annotation5">❺</span>         &lt;ul class="navbar-nav me-auto mb-2 mb-md-0"&gt;
<span class="CodeAnnotationHang" aria-label="annotation6">❻</span>           &lt;li class="nav-item"&gt;
<span class="CodeAnnotationHang" aria-label="annotation7">❼</span>             &lt;a class="nav-link" href="{% url 'learning_logs:topics' %}"&gt;
              Topics&lt;/a&gt;&lt;/li&gt;
        &lt;/ul&gt; &lt;!-- End of links on left side of navbar --&gt;
      &lt;/div&gt; &lt;!-- Closes collapsible parts of navbar --&gt;

    &lt;/div&gt; &lt;!-- Closes navbar's container --&gt;
  &lt;/nav&gt; &lt;!-- End of navbar --&gt;

<span epub:type="pagebreak" title="437" id="Page_437"/><span class="CodeAnnotationHang" aria-label="annotation8">❽</span> {% block content %}{% endblock content %}

&lt;/body&gt;
&lt;/html&gt;</code></pre>
<p>The first new element is the opening <code>&lt;body&gt;</code> tag. The <em>body</em> of an HTML file contains the content users will see on a page. Next we have a <code>&lt;nav&gt;</code> element, which opens the code for the navigation bar at the top of the page <span class="CodeAnnotation" aria-label="annotation1">❶</span>. Everything contained in this element is styled according to the Bootstrap style rules defined by the selectors <code>navbar</code>, <code>navbar-expand-md</code>, and the rest that you see here. A <em>selector</em> determines which elements on a page a certain style rule applies to. The <code>navbar-light</code> and <code>bg-light</code> selectors style the navigation bar with a light-themed background. The <code>mb</code> in <code>mb-4</code> is short for <em>margin-bottom</em>; this selector ensures that a little space appears between the navigation bar and the rest of the page. The <code>border</code> selector provides a thin border around the light background to set it off a little from the rest of the page.</p>
<p>The <code>&lt;div&gt;</code> tag on the next line opens a resizable container that will hold the overall navigation bar. The term <em>div</em> is short for <em>division</em>; you build a web page by dividing it into sections and defining style and behavior rules that apply to that section. Any styling or behavior rules that are defined in an opening <code>&lt;div&gt;</code> tag affect everything you see until its corresponding closing tag, written as <code>&lt;/div&gt;</code>.</p>
<p>Next we set the project’s name, <code>Learning Log</code>, to appear as the first element on the navigation bar <span class="CodeAnnotation" aria-label="annotation2">❷</span>. This will also serve as a link to the home page, just as it’s been doing in the minimally styled version of the project we built in the previous two chapters. The <code>navbar-brand</code> selector styles this link so it stands out from the rest of the links and helps add some branding to the site.</p>
<p>The Bootstrap template then defines a button that appears if the browser window is too narrow to display the whole navigation bar horizontally <span class="CodeAnnotation" aria-label="annotation3">❸</span>. When the user clicks the button, the navigation elements appear in a drop-down list. The <code>collapse</code> reference causes the navigation bar to collapse when the user shrinks the browser window or when the site is displayed on devices with small screens.</p>
<p>Next, we open a new section (<code>&lt;div&gt;</code>) of the navigation bar <span class="CodeAnnotation" aria-label="annotation4">❹</span>. This is the part of the navigation bar that can collapse depending on the size of the browser window.</p>
<p>Bootstrap defines navigation elements as items in an unordered list <span class="CodeAnnotation" aria-label="annotation5">❺</span>, with style rules that make it look nothing like a list. Every link or element you need on the bar can be included as an item in an unordered list <span class="CodeAnnotation" aria-label="annotation6">❻</span>. Here, the only item in the list is our link to the topics page <span class="CodeAnnotation" aria-label="annotation7">❼</span>. Notice the closing <code>&lt;/li&gt;</code> tag at the end of the link; every opening tag needs a corresponding closing tag.</p>
<p>The rest of the lines shown here close out all of the tags that have been opened. In HTML, a comment is written like this:</p>
<pre><code>&lt;!-- This is an HTML comment. --&gt;</code></pre>
<p><span epub:type="pagebreak" title="438" id="Page_438"/>Closing tags don’t usually have comments, but if you’re new to HTML, it can be really helpful to label some of your closing tags. A single missing tag or an extra tag can throw off the layout of an entire page. We include the <code>content</code> block <span class="CodeAnnotation" aria-label="annotation8">❽</span> and the closing <code>&lt;/body&gt;</code> and <code>&lt;/html&gt;</code> tags as well.</p>
<p>We’re not finished with the navigation bar, but we now have a complete HTML document. If <code>runserver</code> is currently active, stop the current server and restart it. Go to the project’s home page, and you should see a navigation bar that has some of the elements shown in <a href="#figure20-1">Figure 20-1</a>. Now let’s add the rest of the elements to the navigation bar.</p>
<h4 id="h3-502703c20-0003">Adding User Account Links</h4>
<p class="BodyFirst">We still need to add the links associated with user accounts. We’ll start by adding all of the account-related links except the logout form.</p>
<p>Make the following changes to <em>base.html</em>:</p>
<p class="CodeLabel"><b>base.html</b></p>
<pre><code>        <em class="LiteralGrayItalic">--snip--</em>
<span class="LiteralGray">        &lt;/ul&gt; &lt;!-- End of links on left side of navbar --&gt;</span>

        &lt;!-- Account-related links --&gt;
<span class="CodeAnnotationHang" aria-label="annotation1">❶</span>         &lt;ul class="navbar-nav ms-auto mb-2 mb-md-0"&gt;

<span class="CodeAnnotationHang" aria-label="annotation2">❷</span>           {% if user.is_authenticated %}
            &lt;li class="nav-item"&gt;
<span class="CodeAnnotationHang" aria-label="annotation3">❸</span>               &lt;span class="navbar-text me-2"&gt;Hello, {{ user.username }}.
                &lt;/span&gt;&lt;/li&gt;
<span class="CodeAnnotationHang" aria-label="annotation4">❹</span>           {% else %}
            &lt;li class="nav-item"&gt;
              &lt;a class="nav-link" href="{% url 'accounts:register' %}"&gt;
                  Register&lt;/a&gt;&lt;/li&gt;
            &lt;li class="nav-item"&gt;
              &lt;a class="nav-link" href="{% url 'accounts:login' %}"&gt;
                  Log in&lt;/a&gt;&lt;/li&gt;
          {% endif %}

        &lt;/ul&gt; &lt;!-- End of account-related links --&gt;

<span class="LiteralGray">      &lt;/div&gt; &lt;!-- Closes collapsible parts of navbar --&gt;</span>
<span class="LiteralGray">      </span><em class="LiteralGrayItalic">--snip--</em></code></pre>
<p>We begin a new set of links by using another opening <code>&lt;ul&gt;</code> tag <span class="CodeAnnotation" aria-label="annotation1">❶</span>. You can have as many groups of links as you need on a page. The selector <code>ms-auto</code> is short for <em>margin-start-automatic</em>: this selector examines the other elements in the navigation bar and works out a left (start) margin that pushes this group of links to the right side of the browser window.</p>
<p>The <code>if</code> block is the same conditional block we used earlier to display appropriate messages to users, depending on whether they’re logged in <span class="CodeAnnotation" aria-label="annotation2">❷</span>. The block is a little longer now because there are some styling rules inside the conditional tags. The greeting for authenticated users is wrapped in a <code>&lt;span&gt;</code> element <span class="CodeAnnotation" aria-label="annotation3">❸</span>. A <em>span element</em> styles pieces of text or elements of a page that are part of a longer line. While div elements create their own divisions in a page, span elements are continuous within a larger section. This can <span epub:type="pagebreak" title="439" id="Page_439"/>be confusing at first, because many pages have deeply nested div elements. Here, we’re using the span element to style informational text on the navigation bar: in this case, the logged-in user’s name.</p>
<p>In the <code>else</code> block, which runs for unauthenticated users, we include the links for registering a new account and logging in <span class="CodeAnnotation" aria-label="annotation4">❹</span>. These should look just like the link to the topics page.</p>
<p>If you wanted to add more links to the navigation bar, you’d add another <code>&lt;li&gt;</code> item to one of the <code>&lt;ul&gt;</code> groups that we’ve defined, using styling directives like the ones you’ve seen here.</p>
<p>Now let’s add the logout form to the navigation bar.</p>
<h4 id="h3-502703c20-0004">Adding the Logout Form to the Navigation Bar</h4>
<p class="BodyFirst">When we first wrote the logout form, we added it to the bottom of <em>base.html</em>. Now let’s put it in a better place, in the navigation bar:</p>
<p class="CodeLabel"><b>base.html</b></p>
<pre><code><span class="LiteralGray">        </span><em class="LiteralGrayItalic">--snip--</em>
<span class="LiteralGray">        &lt;/ul&gt; &lt;!-- End of account-related links --&gt;</span>

        {% if user.is_authenticated %}
          &lt;form action="{% url 'accounts:logout' %}" method='post'&gt;
            {% csrf_token %}
<span class="CodeAnnotationHang" aria-label="annotation1">❶</span>             &lt;button name='submit' class='btn btn-outline-secondary btn-sm'&gt;
                Log out&lt;/button&gt;
          &lt;/form&gt;
        {% endif %}

<span class="LiteralGray">      &lt;/div&gt; &lt;!-- Closes collapsible parts of navbar --&gt;</span>
<span class="LiteralGray">      </span><em class="LiteralGrayItalic">--snip--</em></code></pre>
<p>The logout form should be placed after the set of account-related links, but inside the collapsible section of the navigation bar. The only change in the form is the addition of a number of Bootstrap styling classes in the <code>&lt;button&gt;</code> element, which apply Bootstrap styling elements to the logout button <span class="CodeAnnotation" aria-label="annotation1">❶</span>.</p>
<p>Reload the home page, and you should be able to log in and out using any of the accounts you’ve created.</p>
<p>There’s still a bit more we need to add to <em>base.html</em>. We need to define two blocks that the individual pages can use to place the content specific to those pages.</p>
<h4 id="h3-502703c20-0005">Defining the Main Part of the Page</h4>
<p class="BodyFirst">The rest of <em>base.html</em> contains the main part of the page:</p>
<p class="CodeLabel"><b>base.html</b></p>
<pre><code><span class="LiteralGray">  </span><em class="LiteralGrayItalic">--snip--</em>
<span class="LiteralGray">  &lt;/nav&gt; &lt;!-- End of navbar --&gt;</span>

<span class="CodeAnnotationHang" aria-label="annotation1">❶</span>   &lt;main class="container"&gt;
<span class="CodeAnnotationHang" aria-label="annotation2">❷</span>     &lt;div class="pb-2 mb-2 border-bottom"&gt;
      {% block page_header %}{% endblock page_header %}
    &lt;/div&gt;
<span epub:type="pagebreak" title="440" id="Page_440"/><span class="CodeAnnotationHang" aria-label="annotation3">❸</span>     &lt;div&gt;
      <span class="LiteralGray">{% block content %}{% endblock content %}</span>
    &lt;/div&gt;
  &lt;/main&gt;

<span class="LiteralGray">&lt;/body&gt;</span>
<span class="LiteralGray">&lt;/html&gt;</span></code></pre>
<p>We first open a <code>&lt;main&gt;</code> tag <span class="CodeAnnotation" aria-label="annotation1">❶</span>. The <em>main</em> element is used for the most significant part of the body of a page. Here we assign the bootstrap selector <code>container</code>, which is a simple way to group elements on a page. We’ll place two div elements in this container.</p>
<p>The first div element contains a <code>page_header</code> block <span class="CodeAnnotation" aria-label="annotation2">❷</span>. We’ll use this block to title most pages. To make this section stand out from the rest of the page, we place some padding below the header. <em>Padding</em> refers to space between an element’s content and its border. The selector <code>pb-2</code> is a bootstrap directive that provides a moderate amount of padding at the bottom of the styled element. A <em>margin</em> is the space between an element’s border and other elements on the page. The selector <code>mb-2</code> provides a moderate amount of margin at the bottom of this div. We want a border on the bottom of this block, so we use the selector <code>border-bottom</code>, which provides a thin border at the bottom of the <code>page_header</code> block.</p>
<p>We then define one more div element that contains the block <code>content</code> <span class="CodeAnnotation" aria-label="annotation3">❸</span>. We don’t apply any specific style to this block, so we can style the content of any page as we see fit for that page. The end of the <em>base.html</em> file has closing tags for the <code>main</code>, <code>body</code>, and <code>html</code> elements.</p>
<p>When you load Learning Log’s home page in a browser, you should see a professional-looking navigation bar that matches the one shown in <a href="#figure20-1">Figure 20-1</a>. Try resizing the window so it’s really narrow; a button should replace the navigation bar. Click the button, and all the links should appear in a drop-down list.</p>
<h3 id="h2-502703c20-0004">Styling the Home Page Using a Jumbotron</h3>
<p class="BodyFirst">To update the home page, we’ll use a Bootstrap element called a <em>jumbotron</em>, a large box that stands out from the rest of the page. Typically, it’s used on home pages to hold a brief description of the overall project and a call to action that invites the viewer to get involved.</p>
<p>Here’s the revised <em>index.html</em> file:</p>
<p class="CodeLabel"><b>index.html</b></p>
<pre><code><span class="LiteralGray">{% extends "learning_logs/base.html" %}</span>

<span class="CodeAnnotationHang" aria-label="annotation1">❶</span> {% block page_header %}
<span class="CodeAnnotationHang" aria-label="annotation2">❷</span>   &lt;div class="p-3 mb-4 bg-light border rounded-3"&gt;
    &lt;div class="container-fluid py-4"&gt;
<span class="CodeAnnotationHang" aria-label="annotation3">❸</span>       &lt;h1 class="display-3"&gt;Track your learning.&lt;/h1&gt;

<span class="CodeAnnotationHang" aria-label="annotation4">❹</span>       &lt;p class="lead"&gt;Make your own Learning Log, and keep a list of the
      topics you're learning about. Whenever you learn something new
      about a topic, make an entry summarizing what you've learned.&lt;/p&gt;

<span epub:type="pagebreak" title="441" id="Page_441"/><span class="CodeAnnotationHang" aria-label="annotation5">❺</span>       &lt;a class="btn btn-primary btn-lg mt-1"
        href="{% url 'accounts:register' %}"&gt;Register &amp;raquo;&lt;/a&gt;
    &lt;/div&gt;
  &lt;/div&gt;
{% endblock page_header %}</code></pre>
<p>We first tell Django that we’re about to define what goes in the <code>page_header</code> block <span class="CodeAnnotation" aria-label="annotation1">❶</span>. A jumbotron is implemented as a pair of div elements with a set of styling directives applied to them <span class="CodeAnnotation" aria-label="annotation2">❷</span>. The outer div has padding and margin settings, a light background color, and rounded corners. The inner div is a container that changes along with the window size and has some padding as well. The <code>py-4</code> selector adds padding to the top and bottom of the div element. Feel free to adjust the numbers in these settings and see how the home page changes.</p>
<p>Inside the jumbotron are three elements. The first is a short message, <code>Track your learning</code>, that gives new visitors a sense of what Learning Log does <span class="CodeAnnotation" aria-label="annotation3">❸</span>. The <code>&lt;h1&gt;</code> element is a first-level header, and the <code>display-3</code> selector adds a thinner and taller look to this particular header. We also include a longer message that provides more information about what the user can do with their learning log <span class="CodeAnnotation" aria-label="annotation4">❹</span>. This is formatted as a <code>lead</code> paragraph, which is meant to stand out from regular paragraphs.</p>
<p>Rather than just using a text link, we create a button that invites users to register an account on Learning Log <span class="CodeAnnotation" aria-label="annotation5">❺</span>. This is the same link as in the header, but the button stands out on the page and shows the viewer what they need to do in order to start using the project. The selectors you see here style this as a large button that represents a call to action. The code <code>&amp;raquo;</code> is an <em>HTML entity</em> that looks like two right angle brackets combined (&gt;&gt;). Finally, we provide closing div tags and close the <code>page_header</code> block. With only two div elements in this file, it’s not particularly helpful to label the closing div tags. We aren’t adding anything else to this page, so we don’t need to define the <code>content</code> block in this template.</p>
<p>The home page now looks like <a href="#figure20-1">Figure 20-1</a>. This is a significant improvement over the unstyled version of the project!</p>
<h3 id="h2-502703c20-0005">Styling the Login Page</h3>
<p class="BodyFirst">We’ve refined the overall appearance of the login page, but the login form itself doesn’t have any styling yet. Let’s make the form look consistent with the rest of the page by modifying <em>login.html</em>:</p>
<p class="CodeLabel"><b>login.html</b></p>
<pre><code><span class="LiteralGray">{% extends 'learning_logs/base.html' %}</span>
<span class="CodeAnnotationHang" aria-label="annotation1">❶</span> {% load django_bootstrap5 %}

<span class="CodeAnnotationHang" aria-label="annotation2">❷</span> {% block page_header %}
  &lt;h2&gt;Log in to your account.&lt;/h2&gt;
{% endblock page_header %}

<span class="LiteralGray">{% block content %}</span>

<span epub:type="pagebreak" title="442" id="Page_442"/><span class="LiteralGray">  &lt;form action="{% url 'accounts:login' %}" method='post'&gt;</span>
<span class="LiteralGray">    {% csrf_token %}</span>
<span class="CodeAnnotationHang" aria-label="annotation3">❸</span>     {% bootstrap_form form %}
<span class="CodeAnnotationHang" aria-label="annotation4">❹</span>     {% bootstrap_button button_type="submit" content="Log in" %}
<span class="LiteralGray">  &lt;/form&gt;</span>

<span class="LiteralGray">{% endblock content %}</span></code></pre>
<p>We first load the <code>bootstrap5</code> template tags into this template <span class="CodeAnnotation" aria-label="annotation1">❶</span>. We then define the <code>page_header</code> block, which tells the user what the page is for <span class="CodeAnnotation" aria-label="annotation2">❷</span>. Notice that we’ve removed the <code>{% if form.errors %}</code> block from the template; django-bootstrap5 manages form errors automatically.</p>
<p>To display the form, we use the template tag <code>{% bootstrap_form %}</code> <span class="CodeAnnotation" aria-label="annotation3">❸</span>; this replaces the <code>{{ form.as_div }}</code> element we were using in <span class="xref" itemid="xref_target_Chapter 19">Chapter 19</span>. The <code>{% booststrap_form %}</code> template tag inserts Bootstrap style rules into the form’s individual elements as the form is rendered. To generate the submit button, we use the <code>{% bootstrap_button %}</code> tag with arguments that designate it as a submit button, and give it the label <code>Log in</code> <span class="CodeAnnotation" aria-label="annotation4">❹</span>.</p>
<p><a href="#figure20-2" id="figureanchor20-2">Figure 20-2</a> shows the login form now. The page is much cleaner, with consistent styling and a clear purpose. Try logging in with an incorrect username or password; you’ll see that even the error messages are styled consistently and integrate well with the overall site.</p>
<figure>
<img src="Images/f20002.png" class="keyline" alt="" width="624" height="406"/>
<figcaption><p><a id="figure20-2">Figure 20-2</a>: The login page styled with Bootstrap</p></figcaption>
</figure>
<h3 id="h2-502703c20-0006">Styling the Topics Page</h3>
<p class="BodyFirst">Let’s make sure the pages for viewing information are styled appropriately as well, starting with the topics page:</p>
<p class="CodeLabel"><b>topics.html</b></p>
<pre><code><span class="LiteralGray">{% extends 'learning_logs/base.html' %}</span>

{% block page_header %}
<span epub:type="pagebreak" title="443" id="Page_443"/><span class="CodeAnnotationHang" aria-label="annotation1">❶</span>   &lt;h1&gt;Topics&lt;/h1&gt;
{% endblock page_header %}

<span class="LiteralGray">{% block content %}</span>

<span class="CodeAnnotationHang" aria-label="annotation2">❷</span>   &lt;ul class="list-group border-bottom pb-2 mb-4"&gt;
<span class="LiteralGray">    {% for topic in topics %}</span>
<span class="CodeAnnotationHang" aria-label="annotation3">❸</span>       &lt;li class="list-group-item border-0"&gt;
        &lt;a href="{% url 'learning_logs:topic' topic.id %}"&gt;
          {{ topic.text }}&lt;/a&gt;
      &lt;/li&gt;
<span class="LiteralGray">    {% empty %}</span>
<span class="CodeAnnotationHang" aria-label="annotation4">❹</span>       &lt;li class="list-group-item border-0"&gt;No topics have been added yet.&lt;/li&gt;
<span class="LiteralGray">    {% endfor %}</span>
<span class="LiteralGray">  &lt;/ul&gt;</span>

<span class="LiteralGray">  &lt;a href="{% url 'learning_logs:new_topic' %}"&gt;Add a new topic&lt;/a&gt;</span>

<span class="LiteralGray">{% endblock content %}</span></code></pre>
<p>We don’t need the <code>{% load bootstrap5 %}</code> tag, because we’re not using any custom bootstrap5 template tags in this file. We move the heading <code>Topics</code> into the <code>page_header</code> block and make it an <code>&lt;h1&gt;</code> element instead of a simple paragraph <span class="CodeAnnotation" aria-label="annotation1">❶</span>.</p>
<p>The main content on this page is a list of topics, so we use Bootstrap’s <em>list group</em> component to render the page. This applies a simple set of styling directives to the overall list and to each item in the list. When we open the <code>&lt;ul&gt;</code> tag, we first include the <code>list-group</code> class to apply the default style directives to the list <span class="CodeAnnotation" aria-label="annotation2">❷</span>. We further customize the list by putting a border at the bottom of the list, a little padding below the list (<code>pb-2</code>), and a margin below the bottom border (<code>mb-4</code>).</p>
<p>Each item in the list needs the <code>list-group-item</code> class, and we customize the default style by removing the border around individual items <span class="CodeAnnotation" aria-label="annotation3">❸</span>. The message that’s displayed when the list is empty needs these same classes <span class="CodeAnnotation" aria-label="annotation4">❹</span>.</p>
<p>When you visit the topics page now, you should see a page with styling that matches the home page.</p>
<h3 id="h2-502703c20-0007">Styling the Entries on the Topic Page</h3>
<p class="BodyFirst">On the topic page, we’ll use Bootstrap’s card component to make each entry stand out. A <em>card</em> is a nestable set of divs with flexible, predefined styles that are perfect for displaying a topic’s entries:</p>
<p class="CodeLabel"><b>topic.html</b></p>
<pre><code><span class="LiteralGray">{% extends 'learning_logs/base.html' %}</span>

<span class="CodeAnnotationHang" aria-label="annotation1">❶</span> {% block page_header %}
  &lt;h1&gt;{{ topic.text }}&lt;/h1&gt;
{% endblock page_header %}

<span epub:type="pagebreak" title="444" id="Page_444"/><span class="LiteralGray">{% block content %}</span>
<span class="LiteralGray">  &lt;p&gt;</span>
<span class="LiteralGray">    &lt;a href="{% url 'learning_logs:new_entry' topic.id %}"&gt;Add new entry&lt;/a&gt;</span>
<span class="LiteralGray">  &lt;/p&gt;</span>

<span class="LiteralGray">  {% for entry in entries %}</span>
<span class="CodeAnnotationHang" aria-label="annotation2">❷</span>     &lt;div class="card mb-3"&gt;
      &lt;!-- Card header with timestamp and edit link --&gt;
<span class="CodeAnnotationHang" aria-label="annotation3">❸</span>       &lt;h4 class="card-header"&gt;
        {{ entry.date_added|date:'M d, Y H:i' }}
<span class="CodeAnnotationHang" aria-label="annotation4">❹</span>         &lt;small&gt;&lt;a href="{% url 'learning_logs:edit_entry' entry.id %}"&gt;
          edit entry&lt;/a&gt;&lt;/small&gt;
      &lt;/h4&gt;
      &lt;!-- Card body with entry text --&gt;
<span class="CodeAnnotationHang" aria-label="annotation5">❺</span>       &lt;div class="card-body"&gt;{{ entry.text|linebreaks }}&lt;/div&gt;
    &lt;/div&gt;
<span class="LiteralGray">  {% empty %}</span>
<span class="CodeAnnotationHang" aria-label="annotation6">❻</span>     &lt;p&gt;There are no entries for this topic yet.&lt;/p&gt;
<span class="LiteralGray">  {% endfor %}</span>

<span class="LiteralGray">{% endblock content %}</span></code></pre>
<p>We first place the topic in the <code>page_header</code> block <span class="CodeAnnotation" aria-label="annotation1">❶</span>. Then we delete the unordered list structure previously used in this template. Instead of making each entry a list item, we open a div element with the selector <code>card</code> <span class="CodeAnnotation" aria-label="annotation2">❷</span>. This card has two nested elements: one to hold the timestamp and the link to edit the entry, and another to hold the body of the entry. The <code>card</code> selector takes care of most of the styling we need for this div; we customize the card by adding a small margin to the bottom of each card (<code>mb-3</code>).</p>
<p>The first element in the card is a header, which is an <code>&lt;h4&gt;</code> element with the selector <code>card-header</code> <span class="CodeAnnotation" aria-label="annotation3">❸</span>. This header contains the date the entry was made and a link to edit the entry. The <code>&lt;small&gt;</code> tag around the <code>edit_entry</code> link makes it appear a little smaller than the timestamp <span class="CodeAnnotation" aria-label="annotation4">❹</span>. The second element is a div with the selector <code>card-body</code> <span class="CodeAnnotation" aria-label="annotation5">❺</span>, which places the text of the entry in a simple box on the card. Notice that the Django code for including the information on the page hasn’t changed; only elements that affect the appearance of the page have. Since we no longer have an unordered list, we’ve replaced the list item tags around the empty list message with simple paragraph tags <span class="CodeAnnotation" aria-label="annotation6">❻</span>.</p>
<p><a href="#figure20-3" id="figureanchor20-3">Figure 20-3</a> shows the topic page with its new look. Learning Log’s functionality hasn’t changed, but it looks significantly more professional and inviting to users.</p>
<p>If you want to use a different Bootstrap template for a project, follow a process that’s similar to what we’ve done so far in this chapter. Copy the template you want to use into <em>base.html</em>, and modify the elements that contain actual content so the template displays your project’s information. Then use Bootstrap’s individual styling tools to style the content on each page.</p>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="note">
<h2><span class="NoteHead">Note</span></h2>
<p>	The Bootstrap project has excellent documentation. Visit the home page at <a href="https://getbootstrap.com" class="LinkURL">https://getbootstrap.com</a> and click <b>Docs</b> to learn more about what Bootstrap offers.</p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<span epub:type="pagebreak" title="445" id="Page_445"/><figure>
<img src="Images/f20003.png" class="keyline" alt="" width="624" height="514"/>
<figcaption><p><a id="figure20-3">Figure 20-3</a>: The topic page with Bootstrap styling</p></figcaption>
</figure>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="box">
<h2>Try It Yourself</h2>
<p class="BoxBodyCustom"><span id="h2-502703c20-08" class="BoxNumber">20-1.	Other Forms: </span>We applied Bootstrap’s styles to the <code>login</code> page. Make similar changes to the rest of the form-based pages, including <code>new_topic</code>, <code>new_entry</code>, <code>edit_entry</code>, and <code>register</code>.</p>
<p class="BoxBodyCustom"><span id="h2-502703c20-09" class="BoxNumber">20-2.	Stylish Blog:</span> Use Bootstrap to style the Blog project you created in <span class="xref" itemid="xref_target_Chapter 19">Chapter 19</span>.</p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<h2 id="h1-502703c20-0002">Deploying Learning Log</h2>
<p class="BodyFirst">Now that we have a professional-looking project, let’s deploy it to a live server so anyone with an internet connection can use it. We’ll use Platform.sh, a web-based platform that allows you to manage the deployment of web applications. We’ll get Learning Log up and running on Platform.sh.</p>
<h3 id="h2-502703c20-0008">Making a Platform.sh Account</h3>
<p class="BodyFirst">To make an account, go to <a href="https://platform.sh" class="LinkURL">https://platform.sh</a> and click the <b>Free Trial</b> button. Platform.sh has a free tier that, as of this writing, does not require a credit card. The trial period allows you to deploy an app with minimal resources, which lets you test your project in a live deployment before committing to a paid hosting plan.</p>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="note">
<span epub:type="pagebreak" title="446" id="Page_446"/><h2><span class="NoteHead">Note</span></h2>
<p>	The specific limits of trial plans tend to change periodically, as hosting platforms fight spam and abuse of resources. You can see the current limits of the free trial at <a href="https://platform.sh/free-trial" class="LinkURL">https://platform.sh/free-trial</a>.</p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<h3 id="h2-502703c20-0009">Installing the Platform.sh CLI</h3>
<p class="BodyFirst">To deploy and manage a project on Platform.sh, you’ll need the tools available in the Command Line Interface (CLI). To install the latest version of the CLI, visit <a href="https://docs.platform.sh/development/cli.html" class="LinkURL">https://docs.platform.sh/development/cli.html</a> and follow the instructions for your operating system.</p>
<p>On most systems, you can install the CLI by running the following command in a terminal:</p>
<pre><code>$ curl -fsS https://platform.sh/cli/installer | php</code></pre>
<p>After this command has finished running, you will need to open a new terminal window before you can use the CLI.</p>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="note">
<h2><span class="NoteHead">Note</span></h2>
<p>	This command will probably not work in a standard terminal on Windows. You can use Windows Subsystem for Linux (WSL) or a Git Bash terminal. If you need to install PHP, you can use the XAMPP installer from <a href="https://apachefriends.org" class="LinkURL">https://apachefriends.org</a>. If you have any difficulty installing the Platform.sh CLI, see the more detailed installation instructions in <span class="xref" itemid="xref_target_Appendix E">Appendix E</span>.</p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<h3 id="h2-502703c20-0010">Installing platformshconfig</h3>
<p class="BodyFirst">You’ll also need to install one additional package, <code>platformshconfig</code>. This package helps detect whether the project is running on your local system or on a Platform.sh server. In an active virtual environment, issue the following command:</p>
<pre><code>(ll_env)learning_log$ <b>pip install platformshconfig</b></code></pre>
<p>We’ll use this package to modify the project’s settings when it’s running on the live server.</p>
<h3 id="h2-502703c20-0011">Creating a requirements.txt File</h3>
<p class="BodyFirst">The remote server needs to know which packages Learning Log depends on, so we’ll use pip to generate a file listing them. Again, from an active virtual environment, issue the following command:</p>
<pre><code>(ll_env)learning_log$ <b>pip freeze &gt; requirements.txt</b></code></pre>
<p>The <code>freeze</code> command tells pip to write the names of all the packages currently installed in the project into the file <em>requirements.txt</em>. Open this file to see the packages and version numbers installed in your project:</p>
<p class="CodeLabel"><b>requirements.txt</b></p>
<pre><code>asgiref==3.5.2
beautifulsoup4==4.11.1
Django==4.1
<span epub:type="pagebreak" title="447" id="Page_447"/>django-bootstrap5==21.3
platformshconfig==2.4.0
soupsieve==2.3.2.post1
sqlparse==0.4.2</code></pre>
<p>Learning Log already depends on specific versions of seven different packages, so it requires a matching environment to run properly on a remote server. (We installed three of these packages manually, and four of them were installed automatically as dependencies of these packages.)</p>
<p>When we deploy Learning Log, Platform.sh will install all the packages listed in <em>requirements.txt</em>, creating an environment with the same packages we’re using locally. Because of this, we can be confident the deployed project will function just like it has on our local system. This approach to managing a project is critical as you start to build and maintain multiple projects on your system.</p>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="note">
<h2><span class="NoteHead">Note</span></h2>
<p>	If the version number for a package listed on your system differs from what’s shown here, keep the version you have on your system.</p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<h3 id="h2-502703c20-0012">Additional Deployment Requirements</h3>
<p class="BodyFirst">The live server requires two additional packages. These packages are used to serve the project in a production environment, where many users can be making requests at the same time.</p>
<p>In the same directory where <em>requirements.txt</em> is saved, make a new file called <em>requirements_remote.txt</em>. Add the following two packages to it:</p>
<p class="CodeLabel"><b>requirements_remote.txt</b></p>
<pre><code># Requirements for live project.
gunicorn
psycopg2</code></pre>
<p>The <code>gunicorn</code> package responds to requests as they come in to the remote server; this takes the place of the development server we’ve been using locally. The <code>psycopg2</code> package is required to let Django manage the Postgres database that Platform.sh uses. <em>Postgres</em> is an open source database that’s extremely well suited to production apps.</p>
<h3 id="h2-502703c20-0013">Adding Configuration Files</h3>
<p class="BodyFirst">Every hosting platform requires some configuration for a project to run correctly on its servers. In this section, we’ll add three configuration files:</p>
<p class="RunInPara"><span class="RunInHead"><em>.platform.app.yaml</em></span>  This is the main configuration file for the project. This tells Platform.sh what kind of project we’re trying to deploy and what kinds of resources our project needs, and it includes commands for building the project on the server.</p>
<p class="RunInPara"><span class="RunInHead"><em>.platform/routes.yaml</em></span>  This file defines the routes to our project. When a request is received by Platform.sh, this is the configuration that helps direct these requests to our specific project.</p>
<p class="RunInPara"><span class="RunInHead"><em>.platform/services.yaml</em></span>  This file defines any additional services our project needs.</p>
<p><span epub:type="pagebreak" title="448" id="Page_448"/>These are all YAML (YAML Ain’t Markup Language) files. <em>YAML</em> is a language designed for writing configuration files; it’s made to be read easily by both humans and computers. You can write or modify a typical YAML file by hand, but a computer can also read and interpret the file unambiguously.</p>
<p>YAML files are great for deployment configuration, because they give you a good deal of control over what happens during the deployment process.</p>
<h4 id="h3-502703c20-0006">Making Hidden Files Visible</h4>
<p class="BodyFirst">Most operating systems hide files and folders that begin with a dot, such as <em>.platform</em>. When you open a file browser, you won’t see these kinds of files and folders by default. But as a programmer, you’ll need to see them. Here’s how to view hidden files, depending on your operating system:</p>
<ul>
<li>On Windows, open Windows Explorer, and then open a folder such as <em>Desktop</em>. Click the <b>View</b> tab, and make sure <b>File name extensions</b> and <b>Hidden items</b> are checked.</li>
<li>On macOS, you can press ⌘-SHIFT-. (dot) in any Finder window to see hidden files and folders.</li>
<li>On Linux systems such as Ubuntu, you can press CTRL-H in any file browser to display hidden files and folders. To make this setting permanent, open a file browser such as Nautilus and click the options tab (indicated by three lines). Select the <b>Show Hidden Files</b> checkbox.</li>
</ul>
<h4 id="h3-502703c20-0007">The .platform.app.yaml Configuration File</h4>
<p class="BodyFirst">The first configuration file is the longest, because it controls the overall deployment process. We’ll show it in parts; you can either enter it by hand in your text editor or download a copy from the online resources at <a href="https://ehmatthes.github.io/pcc_3e" class="LinkURL">https://ehmatthes.github.io/pcc_3e</a>.</p>
<p>Here’s the first part of <em>.platform.app.yaml</em>, which should be saved in the same directory as <em>manage.py</em>:</p>
<p class="CodeLabel"><b>.platform.app.yaml</b></p>
<pre><code><span class="CodeAnnotationHang" aria-label="annotation1">❶</span> name: "ll_project"
type: "python:3.10"

<span class="CodeAnnotationHang" aria-label="annotation2">❷</span> relationships:
    database: "db:postgresql"

# The configuration of the app when it's exposed to the web.
<span class="CodeAnnotationHang" aria-label="annotation3">❸</span> web:
    upstream:
        socket_family: unix
    commands:
<span class="CodeAnnotationHang" aria-label="annotation4">❹</span>         start: "gunicorn -w 4 -b unix:$SOCKET ll_project.wsgi:application"
<span class="CodeAnnotationHang" aria-label="annotation5">❺</span>     locations:
        "/":
            passthru: true
        "/static":
<span epub:type="pagebreak" title="449" id="Page_449"/>            root: "static"
            expires: 1h
            allow: true

# The size of the persistent disk of the application (in MB).
<span class="CodeAnnotationHang" aria-label="annotation6">❻</span> disk: 512</code></pre>
<p>When you save this file, make sure you include the dot at the beginning of the filename. If you omit the dot, Platform.sh won’t find the file and your project will not be deployed.</p>
<p>You don’t need to understand everything in <em>.platform.app.yaml</em> at this point; I’ll highlight the most important parts of the configuration. The file starts off by specifying the <code>name</code> of the project, which we’re calling <code>'ll_project'</code> to be consistent with the name we used when starting the project <span class="CodeAnnotation" aria-label="annotation1">❶</span>. We also need to specify the version of Python we’re using (3.10 at the time of this writing). You can find a list of supported versions at <a href="https://docs.platform.sh/languages/python.html" class="LinkURL">https://docs.platform.sh/languages/python.html</a>.</p>
<p>Next is a section labeled <code>relationships</code> that defines other services the project needs <span class="CodeAnnotation" aria-label="annotation2">❷</span>. Here the only relationship is to a Postgres database. After that is the <code>web</code> section <span class="CodeAnnotation" aria-label="annotation3">❸</span>. The <code>commands:start</code> section tells Platform.sh what process to use to serve incoming requests. Here we’re specifying that <code>gunicorn</code> will handle requests <span class="CodeAnnotation" aria-label="annotation4">❹</span>. This command takes the place of the <code>python manage.py runserver</code> command we’ve been using locally.</p>
<p>The <code>locations</code> section tells Platform.sh where to send incoming requests <span class="CodeAnnotation" aria-label="annotation5">❺</span>. Most requests should be passed through to <code>gunicorn</code>; our <em>urls.py</em> files will tell <code>gunicorn</code> exactly how to handle those requests. Requests for static files will be handled separately and will be refreshed once an hour. The last line shows that we’re requesting 512MB of disk space on one of Platform.sh’s servers <span class="CodeAnnotation" aria-label="annotation6">❻</span>.</p>
<p>The rest of <a href="http://.platform.app.yaml" class="LinkURL">.platform.app.yaml</a> is as follows:</p>
<pre><code><em class="LiteralGrayItalic">--snip--</em>
<span class="LiteralGray">disk: 512</span>

# Set a local read/write mount for logs.
<span class="CodeAnnotationHang" aria-label="annotation1">❶</span> mounts:
    "logs":
        source: local
        source_path: logs

# The hooks executed at various points in the lifecycle of the application.
<span class="CodeAnnotationHang" aria-label="annotation2">❷</span> hooks:
    build: |
<span class="CodeAnnotationHang" aria-label="annotation3">❸</span>         pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements_remote.txt

        mkdir logs
<span class="CodeAnnotationHang" aria-label="annotation4">❹</span>         python manage.py collectstatic
        rm -rf logs
<span class="CodeAnnotationHang" aria-label="annotation5">❺</span>     deploy: |
        python manage.py migrate</code></pre>
<p><span epub:type="pagebreak" title="450" id="Page_450"/>The <code>mounts</code> section <span class="CodeAnnotation" aria-label="annotation1">❶</span> lets us define directories where we can read and write data while the project is running. This section defines a <em>logs/</em> directory for the deployed project.</p>
<p>The <code>hooks</code> section <span class="CodeAnnotation" aria-label="annotation2">❷</span> defines actions that are taken at various points during the deployment process. In the <code>build</code> section, we install all the packages that are required to serve the project in the live environment <span class="CodeAnnotation" aria-label="annotation3">❸</span>. We also run <code>collectstatic</code> <span class="CodeAnnotation" aria-label="annotation4">❹</span>, which collects all the static files needed for the project into one place so they can be served efficiently.</p>
<p>Finally, in the <code>deploy</code> section <span class="CodeAnnotation" aria-label="annotation5">❺</span>, we specify that migrations should be run each time the project is deployed. In a simple project, this will have no effect when there have been no changes.</p>
<p>The other two configuration files are much shorter; let’s write them now.</p>
<h4 id="h3-502703c20-0008">The routes.yaml Configuration File</h4>
<p class="BodyFirst">A <em>route</em> is the path a request takes as it’s processed by the server. When a request is received by Platform.sh, it needs to know where to send the request.</p>
<p>Make a new folder called <em>.platform</em>, in the same directory as <em>manage.py</em>. Make sure you include the dot at the beginning of the name. Inside that folder, make a file called <em>routes.yaml</em> and enter the following:</p>
<p class="CodeLabel"><b>.platform/routes.yaml</b></p>
<pre><code># Each route describes how an incoming URL will be processed by Platform.sh.

"https://{default}/":
    type: upstream
    upstream: "ll_project:http"

"https://www.{default}/":
    type: redirect
    to: "https://{default}/"</code></pre>
<p>This file makes sure requests like <em>https://project_url.com</em> and <em>www.project_url.com</em> all get routed to the same place.</p>
<h4 id="h3-502703c20-0009">The services.yaml Configuration File</h4>
<p class="BodyFirst">This last configuration file specifies services that our project needs in order to run. Save this file in the <em>.platform/</em> directory, alongside <em>routes.yaml</em>:</p>
<p class="CodeLabel"><b>.platform/routes.yaml</b></p>
<pre><code># Each service listed will be deployed in its own container as part of your
#   Platform.sh project.

db:
    type: postgresql:12
    disk: 1024</code></pre>
<p>This file defines one service, a Postgres database.</p>
<h3 id="h2-502703c20-0014"><span epub:type="pagebreak" title="451" id="Page_451"/>Modifying settings.py for Platform.sh</h3>
<p class="BodyFirst">Now we need to add a section at the end of <em>settings.py</em> to modify some settings for the Platform.sh environment. Add this code to the very end of <em>settings.py</em>:</p>
<p class="CodeLabel"><b>settings.py</b></p>
<pre><code><em class="LiteralGrayItalic">--snip--</em>
# Platform.sh settings.
<span class="CodeAnnotationHang" aria-label="annotation1">❶</span> from platformshconfig import Config

config = Config()
<span class="CodeAnnotationHang" aria-label="annotation2">❷</span> if config.is_valid_platform():
<span class="CodeAnnotationHang" aria-label="annotation3">❸</span>     ALLOWED_HOSTS.append('.platformsh.site')

<span class="CodeAnnotationHang" aria-label="annotation4">❹</span>     if config.appDir:
        STATIC_ROOT = Path(config.appDir) / 'static'
<span class="CodeAnnotationHang" aria-label="annotation5">❺</span>     if config.projectEntropy:
        SECRET_KEY = config.projectEntropy

    if not config.in_build():
<span class="CodeAnnotationHang" aria-label="annotation6">❻</span>         db_settings = config.credentials('database')
        DATABASES = {
            'default': {
                'ENGINE': 'django.db.backends.postgresql',
                'NAME': db_settings['path'],
                'USER': db_settings['username'],
                'PASSWORD': db_settings['password'],
                'HOST': db_settings['host'],
                'PORT': db_settings['port'],
            },
        }</code></pre>
<p>We normally place <code>import</code> statements at the beginning of a module, but in this case, it’s helpful to keep all the remote-specific settings in one section. Here we import <code>Config</code> from <code>platformshconfig</code> <span class="CodeAnnotation" aria-label="annotation1">❶</span>, which helps determine settings on the remote server. We only modify settings if the method <code>config.is_valid_platform()</code> returns <code>True</code> <span class="CodeAnnotation" aria-label="annotation2">❷</span>, indicating the settings are being used on a Platform.sh server.</p>
<p>We modify <code>ALLOWED_HOSTS</code> to allow the project to be served by hosts ending in <em>.platformsh.site</em> <span class="CodeAnnotation" aria-label="annotation3">❸</span>. All projects deployed to the free tier will be served using this host. If settings are being loaded in the deployed app’s directory <span class="CodeAnnotation" aria-label="annotation4">❹</span>, we set <code>STATIC_ROOT</code> so that static files are served correctly. We also set a more secure <code>SECRET_KEY</code> on the remote server <span class="CodeAnnotation" aria-label="annotation5">❺</span>.</p>
<p>Finally, we configure the production database <span class="CodeAnnotation" aria-label="annotation6">❻</span>. This is only set if the build process has finished running and the project is being served. Everything you see here is necessary to let Django talk to the Postgres server that Platform.sh set up for the project.</p>
<h3 id="h2-502703c20-0015">Using Git to Track the Project’s Files</h3>
<p class="BodyFirst">As discussed in <span class="xref" itemid="xref_target_Chapter 17">Chapter 17</span>, Git is a version control program that allows you to take a snapshot of the code in your project each time you implement a new feature successfully. If anything goes wrong, you can easily return to <span epub:type="pagebreak" title="452" id="Page_452"/>the last working snapshot of your project; for example, if you accidentally introduce a bug while working on a new feature. Each snapshot is called a <em>commit</em>.</p>
<p>Using Git, you can try implementing new features without worrying about breaking your project. When you’re deploying to a live server, you need to make sure you’re deploying a working version of your project. To read more about Git and version control, see <span class="xref" itemid="xref_target_Appendix D">Appendix D</span>.</p>
<h4 id="h3-502703c20-0010">Installing Git</h4>
<p class="BodyFirst">Git may already be installed on your system. To find out, open a new terminal window and issue the command <code class="bold">git --version</code>:</p>
<pre><code>(ll_env)learning_log$ <b>git --version</b>
git version 2.30.1 (Apple Git-130)</code></pre>
<p>If you get a message indicating that Git is not installed, see the installation instructions in <span class="xref" itemid="xref_target_Appendix D">Appendix D</span>.</p>
<h4 id="h3-502703c20-0011">Configuring Git</h4>
<p class="BodyFirst">Git keeps track of who makes changes to a project, even when only one person is working on the project. To do this, Git needs to know your username and email. You must provide a username, but you can make up an email for your practice projects:</p>
<pre><code>(ll_env)learning_log$ <b>git config --global user.name "eric"</b>
(ll_env)learning_log$ <b>git config --global user.email "eric@example.com"</b></code></pre>
<p>If you forget this step, Git will prompt you for this information when you make your first commit.</p>
<h4 id="h3-502703c20-0012">Ignoring Files</h4>
<p class="BodyFirst">We don’t need Git to track every file in the project, so we’ll tell it to ignore some files. Create a file called <em>.gitignore</em> in the folder that contains <em>manage.py</em>. Notice that this filename begins with a dot and has no file extension. Here’s the code that goes in <em>.gitignore</em>:</p>
<p class="CodeLabel"><b>.gitignore</b></p>
<pre><code>ll_env/
__pycache__/
*.sqlite3</code></pre>
<p>We tell Git to ignore the entire <em>ll_env</em> directory, because we can re-create it automatically at any time. We also don’t track the <em>__pycache__</em> directory, which contains the <em>.pyc</em> files that are created automatically when the <em>.py</em> files are executed. We don’t track changes to the local database, because it’s a bad habit: if you’re ever using SQLite on a server, you might accidentally overwrite the live database with your local test database when you push the project to the server. The asterisk in <code>*.sqlite3</code> tells Git to ignore any file that ends with the extension <em>.sqlite3</em>.</p>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="note">
<span epub:type="pagebreak" title="453" id="Page_453"/><h2><span class="NoteHead">Note</span></h2>
<p>	If you’re using macOS, add <code>.DS_Store</code> to your <em>.gitignore</em> file. This is a file that stores information about folder settings on macOS, and it has nothing to do with this project.</p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<h4 id="h3-502703c20-0013">Committing the Project</h4>
<p class="BodyFirst">We need to initialize a Git repository for Learning Log, add all the necessary files to the repository, and commit the initial state of the project. Here’s how to do that:</p>
<pre><code><span class="CodeAnnotationHang" aria-label="annotation1">❶</span> (ll_env)learning_log$ <b>git init</b>
Initialized empty Git repository in /Users/eric/.../learning_log/.git/
<span class="CodeAnnotationHang" aria-label="annotation2">❷</span> (ll_env)learning_log$ <b>git add .</b>
<span class="CodeAnnotationHang" aria-label="annotation3">❸</span> (ll_env)learning_log$ <b>git commit -am "Ready for deployment to Platform.sh."</b>
[main (root-commit) c7ffaad] Ready for deployment to Platform.sh.
 42 files changed, 879 insertions(+)
 create mode 100644 .gitignore
 create mode 100644 .platform.app.yaml
<var> --snip--</var>
 create mode 100644 requirements_remote.txt
<span class="CodeAnnotationHang" aria-label="annotation4">❹</span> (ll_env)learning_log$ <b>git status</b>
On branch main
nothing to commit, working tree clean
(ll_env)learning_log$</code></pre>
<p>We issue the <code>git init</code> command to initialize an empty repository in the directory containing Learning Log <span class="CodeAnnotation" aria-label="annotation1">❶</span>. We then use the <code>git add .</code> command, which adds all the files that aren’t being ignored to the repository <span class="CodeAnnotation" aria-label="annotation2">❷</span>. (Don’t forget the dot.) Next, we issue the command <code>git commit -am</code> <code>"</code><var>commit message</var><code>"</code>: the <code>-a</code> flag tells Git to include all changed files in this commit, and the <code>-m</code> flag tells Git to record a log message <span class="CodeAnnotation" aria-label="annotation3">❸</span>.</p>
<p>Issuing the <code>git status</code> command <span class="CodeAnnotation" aria-label="annotation4">❹</span> indicates that we’re on the <em>main</em> branch and that our working tree is <em>clean</em>. This is the status you’ll want to see anytime you push your project to a remote server.</p>
<h3 id="h2-502703c20-0016">Creating a Project on Platform.sh</h3>
<p class="BodyFirst">At this point, the Learning Log project still runs on our local system and is also configured to run correctly on a remote server. We’ll use the Platform.sh CLI to create a new project on the server and then push our project to the remote server.</p>
<p>Make sure you’re in a terminal, at the <em>learning_log/</em> directory, and issue the following command:</p>
<pre><code>(ll_env)learning_log$ <b>platform login</b>
Opened URL: http://127.0.0.1:5000
Please use the browser to log in.
<var>--snip--</var>
<span class="CodeAnnotationHang" aria-label="annotation1">❶</span> Do you want to create an SSH configuration file automatically? [Y/n] <b>Y</b></code></pre>
<p><span epub:type="pagebreak" title="454" id="Page_454"/>This command will open a browser tab where you can log in. Once you’re logged in, you can close the browser tab and return to the terminal. If you’re prompted about creating an SSH configuration file <span class="CodeAnnotation" aria-label="annotation1">❶</span>, enter <code class="bold">Y</code> so you can connect to the remote server later.</p>
<p>Now we’ll create a project. There’s a lot of output, so we’ll look at the creation process in sections. Start by issuing the <code class="bold">create</code> command:</p>
<pre><code>(ll_env)learning_log$ <b>platform create</b>
* Project title (--title)
Default: Untitled Project
<span class="CodeAnnotationHang" aria-label="annotation1">❶</span> &gt; <b>ll_project</b>

* Region (--region)
The region where the project will be hosted
  <var>--snip--</var>
  [us-3.platform.sh] Moses Lake, United States (AZURE) [514 gC02eq/kWh]
<span class="CodeAnnotationHang" aria-label="annotation2">❷</span> &gt; <b>us-3.platform.sh</b>
* Plan (--plan)
Default: development
Enter a number to choose:
  [0] development
  <var>--snip--</var>
<span class="CodeAnnotationHang" aria-label="annotation3">❸</span> &gt; <b>0</b>

* Environments (--environments)
The number of environments
Default: 3
<span class="CodeAnnotationHang" aria-label="annotation4">❹</span> &gt; <b>3</b>

* Storage (--storage)
The amount of storage per environment, in GiB
Default: 5
<span class="CodeAnnotationHang" aria-label="annotation5">❺</span> &gt; <b>5</b></code></pre>
<p>The first prompt asks for a name for the project <span class="CodeAnnotation" aria-label="annotation1">❶</span>, so we use the name <code class="bold">ll_project</code>. The next prompt asks which region we’d like the server to be in <span class="CodeAnnotation" aria-label="annotation2">❷</span>. Choose the server closest to you; for me, that’s <code>us-3.platform.sh</code>. For the rest of the prompts, you can accept the defaults: a server on the lowest development plan <span class="CodeAnnotation" aria-label="annotation3">❸</span>, three environments for the project <span class="CodeAnnotation" aria-label="annotation4">❹</span>, and 5GB of storage for the overall project <span class="CodeAnnotation" aria-label="annotation5">❺</span>.</p>
<p>There are three more prompts to respond to:</p>
<pre><code>Default branch (--default-branch)
The default Git branch name for the project (the production environment)
Default: main
<span class="CodeAnnotationHang" aria-label="annotation1">❶</span> &gt; <b>main</b>

Git repository detected: /Users/eric/.../learning_log
<span class="CodeAnnotationHang" aria-label="annotation2">❷</span> Set the new project ll_project as the remote for this repository? [Y/n] <b>Y</b>

The estimated monthly cost of this project is: $10 USD
<span class="CodeAnnotationHang" aria-label="annotation3">❸</span> Are you sure you want to continue? [Y/n] <b>Y</b>

<span epub:type="pagebreak" title="455" id="Page_455"/>The Platform.sh Bot is activating your project

      ▀▄   ▄▀
    █▄█▀███▀█▄█
    ▀█████████▀
     ▄▀     ▀▄

The project is now ready!</code></pre>
<p>A Git repository can have multiple branches; Platform.sh is asking us if the default branch for the project should be <code>main</code> <span class="CodeAnnotation" aria-label="annotation1">❶</span>. It then asks if we want to connect the local project’s repository to the remote repository <span class="CodeAnnotation" aria-label="annotation2">❷</span>. Finally, we’re informed that this project will cost about $10 per month if we keep it running beyond the free trial period <span class="CodeAnnotation" aria-label="annotation3">❸</span>. If you haven’t entered a credit card yet, you shouldn’t have to worry about this cost. Platform.sh will simply suspend your project if you exceed the free trial’s limits without adding a credit card.</p>
<h3 id="h2-502703c20-0017">Pushing to Platform.sh</h3>
<p class="BodyFirst">The last step before seeing the live version of the project is to push our code to the remote server. To do that, issue the following command:</p>
<pre><code>(ll_env)learning_log$ <b>platform push</b>
<span class="CodeAnnotationHang" aria-label="annotation1">❶</span> Are you sure you want to push to the main (production) branch? [Y/n] <b>Y</b>
<var>--snip--</var>
The authenticity of host 'git.us-3.platform.sh (...)' can't be established.
RSA key fingerprint is SHA256:Tvn...7PM
<span class="CodeAnnotationHang" aria-label="annotation2">❷</span> Are you sure you want to continue connecting (yes/no/[fingerprint])? <b>Y</b>
Pushing HEAD to the existing environment main
  <var>--snip--</var>
  To git.us-3.platform.sh:3pp3mqcexhlvy.git
   * [new branch]      HEAD -&gt; main</code></pre>
<p>When you issue the command <code class="bold">platform push</code>, you’ll be asked for one more confirmation that you want to push the project <span class="CodeAnnotation" aria-label="annotation1">❶</span>. You may also see a message about the authenticity of Platform.sh, if this is your first time connecting to the site <span class="CodeAnnotation" aria-label="annotation2">❷</span>. Enter <code class="bold">Y</code> for each of these prompts, and you’ll see a bunch of output scroll by. This output will probably look confusing at first, but if anything goes wrong, it’s really useful to have during troubleshooting. If you skim through the output, you can see where Platform.sh installs necessary packages, collects static files, applies migrations, and sets up URLs for the project.</p>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="note">
<h2><span class="NoteHead">Note</span></h2>
<p>	You may see an error from something that you can easily diagnose, such as a typo in one of the configuration files. If this happens, fix the error in your text editor, save the file, and reissue the <code class="bold">git commit</code> command. Then you can run <code class="bold">platform push</code> again.</p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<h3 id="h2-502703c20-0018"><span epub:type="pagebreak" title="456" id="Page_456"/>Viewing the Live Project</h3>
<p class="BodyFirst">Once the push is complete, you can open the project:</p>
<pre><code>(ll_env)learning_log$ <b>platform url</b>
Enter a number to open a URL
  [0] https://main-bvxea6i-wmye2fx7wwqgu.us-3.platformsh.site/
  <var>--snip--</var>
 &gt; <b>0</b></code></pre>
<p>The <code>platform url</code> command lists the URLs associated with a deployed project; you’ll be given a choice of several URLs that are all valid for your project. Choose one, and your project should open in a new browser tab! This will look just like the project we’ve been running locally, but you can share this URL with anyone in the world, and they can access and use your project.</p>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="note">
<h2><span class="NoteHead">Note</span></h2>
<p>	When you deploy your project using a trial account, don’t be surprised if it sometimes takes longer than usual for a page to load. On most hosting platforms, free resources that are idle are often suspended and only restarted when new requests come in. Most platforms are much more responsive on paid hosting plans.</p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<h3 id="h2-502703c20-0019">Refining the Platform.sh Deployment</h3>
<p class="BodyFirst">Now we’ll refine the deployment by creating a superuser, just as we did locally. We’ll also make the project more secure by changing the setting <code>DEBUG</code> to <code>False</code>, so error messages won’t show users any extra information that they could use to attack the server.</p>
<h4 id="h3-502703c20-0014">Creating a Superuser on Platform.sh</h4>
<p class="BodyFirst">The database for the live project has been set up, but it’s completely empty. All the users we created earlier only exist in our local version of the project.</p>
<p>To create a superuser on the live version of the project, we’ll start an SSH (secure socket shell) session where we can run management commands on the remote server:</p>
<pre><code>(ll_env)learning_log$ <b>platform environment:ssh</b>

 ___ _      _    __                    _
| _ \ |__ _| |_ / _|___ _ _ _ __    __| |_
|  _/ / _` |  _|  _/ _ \ '_| '  \ _(_-&lt; ' \
|_| |_\__,_|\__|_| \___/_| |_|_|_(_)__/_||_|

 Welcome to Platform.sh.

<span class="CodeAnnotationHang" aria-label="annotation1">❶</span> web@ll_project.0:~$ <b>ls</b>
accounts  learning_logs  ll_project  logs  manage.py  requirements.txt
    requirements_remote.txt  static
<span class="CodeAnnotationHang" aria-label="annotation2">❷</span> web@ll_project.0:~$ <b>python manage.py createsuperuser</b>
<span class="CodeAnnotationHang" aria-label="annotation3">❸</span> Username (leave blank to use 'web'): <b>ll_admin_live</b>
Email address:
<span epub:type="pagebreak" title="457" id="Page_457"/>Password:
Password (again):
Superuser created successfully.
<span class="CodeAnnotationHang" aria-label="annotation4">❹</span> web@ll_project.0:~$ <b>exit</b>
logout
Connection to ssh.us-3.platform.sh closed.
<span class="CodeAnnotationHang" aria-label="annotation5">❺</span> (ll_env)learning_log$</code></pre>
<p>When you first run the <code class="bold">platform environment:ssh</code> command, you may get another prompt about the authenticity of this host. If you see this message, enter <code class="bold">Y</code> and you should be logged in to a remote terminal session.</p>
<p>After running the <code class="bold">ssh</code> command, your terminal acts just like a terminal on the remote server. Note that your prompt has changed to indicate that you’re in a <code>web</code> session associated with the project named <code>ll_project</code> <span class="CodeAnnotation" aria-label="annotation1">❶</span>. If you issue the <code class="bold">ls</code> command, you’ll see the files that have been pushed to the Platform.sh server.</p>
<p>Issue the same <code class="bold">createsuperuser</code> command we used in <span class="xref" itemid="xref_target_Chapter 18">Chapter 18</span> <span class="CodeAnnotation" aria-label="annotation2">❷</span>. This time, I entered an admin username, <code class="bold">ll_admin_live</code>, that’s distinct from the one I used locally <span class="CodeAnnotation" aria-label="annotation3">❸</span>. When you’re finished working in the remote terminal session, enter the <code class="bold">exit</code> command <span class="CodeAnnotation" aria-label="annotation4">❹</span>. Your prompt will indicate that you’re working in your local system again <span class="CodeAnnotation" aria-label="annotation5">❺</span>.</p>
<p>Now you can add <em>/admin/</em> to the end of the URL for the live app and log in to the admin site. If others have already started using your project, be aware that you’ll have access to all their data! Take this responsibility seriously, and users will continue to trust you with their data.</p>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="note">
<h2><span class="NoteHead">Note</span></h2>
<p>	Windows users will use the same commands shown here (such as <code>ls</code> instead of <code>dir</code>), because you’re running a Linux terminal through a remote connection.</p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<h4 id="h3-502703c20-0015">Securing the Live Project</h4>
<p class="BodyFirst">There’s one glaring security issue in the way our project is currently deployed: the setting <code>DEBUG = True</code> in <em>settings.py</em>, which provides debug messages when errors occur. Django’s error pages give you vital debugging information when you’re developing a project; however, they give way too much information to attackers if you leave them enabled on a live server.</p>
<p>To see how bad this is, go to the home page of your deployed project. Log in to a user’s account and add <em>/topics/999/</em> to the end of the home page URL. Assuming you haven’t made thousands of topics, you should see a page with the message <em>DoesNotExist at /topics/999/</em>. If you scroll down, you should see a whole bunch of information about the project and the server. You won’t want your users to see this, and you certainly wouldn’t want this information available to anyone interested in attacking the site.</p>
<p>We can prevent this information from being shown on the live site by setting <code>DEBUG = False</code> in the part of <em>settings.py</em> that only applies to the deployed version of the project. This way you’ll continue to see debugging information locally, where that information is useful, but it won’t show up on the live site.</p>
<p><span epub:type="pagebreak" title="458" id="Page_458"/>Open <em>settings.py</em> in your text editor, and add one line of code to the part that modifies settings for Platform.sh:</p>
<p class="CodeLabel"><b>settings.py</b></p>
<pre><code><em class="LiteralGrayItalic">--snip--</em>
<span class="LiteralGray">if config.is_valid_platform():</span>
<span class="LiteralGray">    ALLOWED_HOSTS.append('.platformsh.site')</span>
    DEBUG = False
    <em class="LiteralGrayItalic">--snip--</em></code></pre>
<p>All the work to set up configuration for the deployed version of the project has paid off. When we want to adjust the live version of the project, we just change the relevant part of the configuration we set up earlier.</p>
<h4 id="h3-502703c20-0016">Committing and Pushing Changes</h4>
<p class="BodyFirst">Now we need to commit the changes made to <em>settings.py</em> and push the changes to Platform.sh. Here’s a terminal session showing the first part of this process:</p>
<pre><code><span class="CodeAnnotationHang" aria-label="annotation1">❶</span> (ll_env)learning_log$ <b>git commit -am "Set DEBUG False on live site."</b>
[main d2ad0f7] Set DEBUG False on live site.
  1 file changed, 1 insertion(+)
<span class="CodeAnnotationHang" aria-label="annotation2">❷</span> (ll_env)learning_log$ <b>git status</b>
On branch main
nothing to commit, working tree clean
(ll_env)learning_log$</code></pre>
<p>We issue the <code>git commit</code> command with a short but descriptive commit message <span class="CodeAnnotation" aria-label="annotation1">❶</span>. Remember the <code>-am</code> flag makes sure Git commits all the files that have changed and records the log message. Git recognizes that one file has changed and commits this change to the repository.</p>
<p>Running <code class="bold">git status</code> shows that we’re working on the <code>main</code> branch of the repository and that there are now no new changes to commit <span class="CodeAnnotation" aria-label="annotation2">❷</span>. It’s important to check the status before pushing to a remote server. If you don’t see a clean status, then some changes haven’t been committed and those changes won’t be pushed to the server. You can try issuing the <code>commit</code> command again; if you’re not sure how to resolve the issue, read through <span class="xref" itemid="xref_target_Appendix D">Appendix D</span> to better understand how to work with Git.</p>
<p>Now let’s push the updated repository to Platform.sh:</p>
<pre><code>(ll_env)learning_log$ <b>platform push</b>
Are you sure you want to push to the main (production) branch? [Y/n] <b>Y</b>
Pushing HEAD to the existing environment main
<var>--snip--</var>
  To git.us-3.platform.sh:wmye2fx7wwqgu.git
     fce0206..d2ad0f7  HEAD -&gt; main
(ll_env)learning_log$</code></pre>
<p>Platform.sh recognizes that the repository has been updated, and it rebuilds the project to make sure all the changes have been taken into account. It doesn’t rebuild the database, so we haven’t lost any data.</p>
<p><span epub:type="pagebreak" title="459" id="Page_459"/>To make sure this change took effect, visit the <em class="Italic">/topics/999/</em> URL again. You should see just the message <em>Server Error (500)</em>, with no sensitive information about the project at all.</p>
<h3 id="h2-502703c20-0020">Creating Custom Error Pages</h3>
<p class="BodyFirst">In <span class="xref" itemid="xref_target_Chapter 19">Chapter 19</span>, we configured Learning Log to return a 404 error if the user requests a topic or entry that doesn’t belong to them. Now you’ve seen a 500 server error as well. A 404 error usually means your Django code is correct, but the object being requested doesn’t exist. A 500 error usually means there’s an error in the code you’ve written, such as an error in a function in <em>views.py</em>. Django currently returns the same generic error page in both situations, but we can write our own 404 and 500 error page templates that match Learning Log’s overall appearance. These templates belong in the root template directory.</p>
<h4 id="h3-502703c20-0017">Making Custom Templates</h4>
<p class="BodyFirst">In the <em>learning_log</em> folder, make a new folder called <em>templates</em>. Then make a new file called <em>404.html</em>; the path to this file should be <em>learning_log/templates/404.html</em>. Here’s the code for this file:</p>
<p class="CodeLabel"><b>404.html</b></p>
<pre><code>{% extends "learning_logs/base.html" %}

{% block page_header %}
  &lt;h2&gt;The item you requested is not available. (404)&lt;/h2&gt;
{% endblock page_header %}</code></pre>
<p>This simple template provides the generic 404 error page information but is styled to match the rest of the site.</p>
<p>Make another file called <em>500.html</em> using the following code:</p>
<p class="CodeLabel"><b>500.html</b></p>
<pre><code>{% extends "learning_logs/base.html" %}

{% block page_header %}
  &lt;h2&gt;There has been an internal error. (500)&lt;/h2&gt;
{% endblock page_header %}</code></pre>
<p>These new files require a slight change to <em>settings.py</em>.</p>
<p class="CodeLabel"><b>settings.py</b></p>
<pre><code><em class="LiteralGrayItalic">--snip--</em>
<span class="LiteralGray">TEMPLATES = [</span>
<span class="LiteralGray">    {</span>
<span class="LiteralGray">        'BACKEND': 'django.template.backends.django.DjangoTemplates',</span>
        'DIRS': [BASE_DIR / 'templates'],
<span class="LiteralGray">        'APP_DIRS': True,</span>
<span class="LiteralGray">        </span><em class="LiteralGrayItalic">--snip--</em>
<span class="LiteralGray">    },</span>
<span class="LiteralGray">]</span>
<em class="LiteralGrayItalic">--snip--</em></code></pre>
<p><span epub:type="pagebreak" title="460" id="Page_460"/>This change tells Django to look in the root template directory for the error page templates and any other templates that aren’t associated with a particular app.</p>
<h4 id="h3-502703c20-0018">Pushing the Changes to Platform.sh</h4>
<p class="BodyFirst">Now we need to commit the changes we just made and push them to Platform.sh:</p>
<pre><code><span class="CodeAnnotationHang" aria-label="annotation1">❶</span> (ll_env)learning_log$ <b>git add .</b>
<span class="CodeAnnotationHang" aria-label="annotation2">❷</span> (ll_env)learning_log$ <b>git commit -am "Added custom 404 and 500 error pages."</b>
 3 files changed, 11 insertions(+), 1 deletion(-)
 create mode 100644 templates/404.html
 create mode 100644 templates/500.html
<span class="CodeAnnotationHang" aria-label="annotation3">❸</span> (ll_env)learning_log$ <b>platform push</b>
<var>--snip--</var>
  To git.us-3.platform.sh:wmye2fx7wwqgu.git
     d2ad0f7..9f042ef  HEAD -&gt; main
(ll_env)learning_log$</code></pre>
<p>We issue the <code>git add .</code> command <span class="CodeAnnotation" aria-label="annotation1">❶</span> because we created some new files in the project. Then we commit the changes <span class="CodeAnnotation" aria-label="annotation2">❷</span> and push the updated project to Platform.sh <span class="CodeAnnotation" aria-label="annotation3">❸</span>.</p>
<p>Now when an error page appears, it should have the same styling as the rest of the site, making for a smoother user experience when errors arise.</p>
<h3 id="h2-502703c20-0021">Ongoing Development</h3>
<p class="BodyFirst">You might want to further develop Learning Log after your initial push to a live server, or you might want to develop your own projects to deploy. When doing so, there’s a fairly consistent process for updating your projects.</p>
<p>First, you’ll make the necessary changes to your local project. If your changes result in any new files, add those files to the Git repository using the command <code>git add .</code> (making sure to include the dot at the end of the command). Any change that requires a database migration will need this command, because each migration generates a new migration file.</p>
<p>Second, commit the changes to your repository using <code>git commit -am "</code><var>commit message</var><code>"</code>. Then push your changes to Platform.sh, using the command <code>platform push</code>. Visit your live project and make sure the changes you expect to see have taken effect.</p>
<p>It’s easy to make mistakes during this process, so don’t be surprised when something goes wrong. If the code doesn’t work, review what you’ve done and try to spot the mistake. If you can’t find the mistake or you can’t figure out how to undo it, refer to the suggestions for getting help in <span class="xref" itemid="xref_target_Appendix C">Appendix C</span>. Don’t be shy about asking for help: everyone else learned to build projects by asking the same questions you’re likely to ask, so someone will be happy to help you. Solving each problem that arises helps you steadily develop your skills until you’re building meaningful, reliable projects and answering other people’s questions as well.</p>
<h3 id="h2-502703c20-0022"><span epub:type="pagebreak" title="461" id="Page_461"/>Deleting a Project on Platform.sh</h3>
<p class="BodyFirst">It’s great practice to run through the deployment process a number of times with the same project or with a series of small projects, to get the hang of deployment. But you’ll need to know how to delete a project that’s been deployed. Platform.sh also limits the number of projects you can host for free, and you don’t want to clutter your account with practice projects.</p>
<p>You can delete a project using the CLI:</p>
<pre><code>(ll_env)learning_log$ <b>platform project:delete</b></code></pre>
<p>You’ll be asked to confirm that you want to take this destructive action. Respond to the prompts, and your project will be deleted.</p>
<p>The command <code>platform create</code> also gave the local Git repository a reference to the remote repository on Platform.sh’s servers. You can remove this remote from the command line as well:</p>
<pre><code>(ll_env)learning_log$ <b>git remote</b>
platform
(ll_env)learning_log$ <b>git remote remove platform</b></code></pre>
<p>The command <code>git remote</code> lists the names of all remote URLs associated with the current repository. The command <code>git remote remove</code><code class="bold"> </code><var>remote_name</var> deletes these remote URLs from the local repository.</p>
<p>You can also delete a project’s resources by logging in to the Platform.sh website and visiting your dashboard at <a href="https://console.platform.sh" class="LinkURL">https://console.platform.sh</a>. This page lists all your active projects. Click the three dots in a project’s box, and click <b>Edit Plan</b>. This is a pricing page for the project; click the <b>Delete Project</b> button at the bottom of the page, and you’ll be shown a confirmation page where you can follow through with the deletion. Even if you deleted your project using the CLI, it’s a good idea to familiarize yourself with the dashboard of any hosting provider you deploy to.</p>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="note">
<h2><span class="NoteHead">Note</span></h2>
<p>	Deleting a project on Platform.sh does nothing to your local version of the project. If no one has used your deployed project and you’re just practicing the deployment process, it’s perfectly reasonable to delete your project on Platform.sh and redeploy it. Just be aware that if things stop working, you may have run into the host’s free-tier limitations.</p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="box">
<h2>Try It Yourself</h2>
<p class="BoxBodyCustom"><span id="h2-502703c20-25" class="BoxNumber">20-3.	Live Blog:</span> Deploy the Blog project you’ve been working on to Platform.sh. Make sure you set <code>DEBUG</code> to <code>False</code>, so users don’t see the full Django error pages when something goes wrong.</p>
<p class="BoxBodyCustom"><span id="h2-502703c20-26" class="BoxNumber">20-4.	<span epub:type="pagebreak" title="462" id="Page_462"/>Extended Learning Log:</span> Add one feature to Learning Log, and push the change to your live deployment. Try a simple change, such as writing more about the project on the home page. Then try adding a more advanced feature, such as giving users the option of making a topic public. This would require an attribute called <code>public</code> as part of the <code>Topic</code> model (this should be set to <code>False</code> by default) and a form element on the new_topic page that allows the user to change a topic from private to public. You’d then need to migrate the project and revise <em>views.py</em> so any topic that’s public is visible to unauthenticated users as well.</p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<h2 id="h1-502703c20-0003">Summary</h2>
<p class="BodyFirst">In this chapter, you learned to give your projects a simple but professional appearance using the Bootstrap library and the django-bootstrap5 app. With Bootstrap, the styles you choose will work consistently on almost any device people use to access your project.</p>
<p>You learned about Bootstrap’s templates and used the <em>Navbar static</em> template to create a simple look and feel for Learning Log. You used a jumbotron to make a home page’s message stand out, and learned to style all the pages in a site consistently.</p>
<p>In the final part of the project, you learned how to deploy a project to a remote server so anyone can access it. You made a Platform.sh account and installed some tools that help manage the deployment process. You used Git to commit the working project to a repository, and then pushed the repository to a remote server on Platform.sh. Finally, you learned to begin securing your app by setting <code>DEBUG = False</code> on the live server. You also made custom error pages, so the inevitable errors that come up will look well-handled.</p>
<p>Now that you’ve finished Learning Log, you can start building your own projects. Start simple, and make sure the project works before adding complexity. Enjoy your continued learning, and good luck with your projects!</p>
</section>
</div></body></html>