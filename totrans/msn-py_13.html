<html><head></head><body>
<h2 class="h2" id="appa"><span epub:type="pagebreak" id="page_217"/><strong><span class="blue"><span class="big">A</span></span><br/>ESCAPE: THE COMPLETE GAME LISTING</strong></h2>
<div class="image1"><img src="../images/common01.jpg" alt="image"/></div>
<p class="noindent">This appendix shows the final listing for the <em>Escape</em> game. You can use it as a reference to see where to place particular functions and sections, or read through it if you want to see the whole listing in one place. This listing doesn’t include the temporary sections you wrote while building the game, such as the <span class="literal">EXPLORER</span> section. It just contains the code that is in the final game.</p>
<p class="indent">Remember that you can also download the <em>escape.py</em> listing and read it in IDLE, which lets you search it by pressing <small>CTRL</small>-F.</p>
<p class="indent">I’ve changed <span class="literal">PLAYER_NAME</span> to “Captain” in this listing. When you’re building or customizing the game, you can use your own name (see <span class="ent">➊</span> in <a href="ch04.xhtml#ch04list1">Listing 4-1</a> on <a href="ch04.xhtml#page_63">page 63</a>).</p>
<p class="indent">To test this project, I rebuilt the game using the instructions in this book. This game listing has been copied from game code that has been tested to completion on Windows, the Raspberry Pi 3 Model B+, and the Raspberry Pi 2 Model B.</p>
<p class="programs"><span epub:type="pagebreak" id="page_218"/><span class="red"># Escape - A Python Adventure</span><br/><span class="red"># by Sean McManus / www.sean.co.uk</span><br/><span class="red"># Art by Rafael Pimenta</span><br/><span class="red"># Typed in by PUT YOUR NAME HERE</span><br/><br/><span class="orange">import</span> time, random, math<br/><br/><span class="red">###############</span><br/><span class="red">## VARIABLES ##</span><br/><span class="red">###############</span><br/><br/>WIDTH = 800 <span class="red">#window size</span><br/>HEIGHT = 800<br/><br/><span class="red">#PLAYER variables</span><br/>PLAYER_NAME = <span class="green">"Captain"</span> <span class="red"># change this to your name!</span><br/>FRIEND1_NAME = <span class="green">"Karen"</span> <span class="red"># change this to a friend's name!</span><br/>FRIEND2_NAME = <span class="green">"Leo"</span> <span class="red"># change this to another friend's name!</span><br/>current_room = 31 <span class="red"># start room = 31</span><br/><br/>top_left_x = 100<br/>top_left_y = 150<br/><br/>DEMO_OBJECTS = [images.floor, images.pillar, images.soil]<br/><br/>LANDER_SECTOR = random.randint(1, 24)<br/>LANDER_X = random.randint(2, 11)<br/>LANDER_Y = random.randint(2, 11)<br/><br/>TILE_SIZE = 30<br/><br/>player_y, player_x = 2, 5<br/>game_over = <span class="orange">False</span><br/><br/>PLAYER = {<br/>    <span class="green">"left"</span>: [images.spacesuit_left, images.spacesuit_left_1,<br/>             images.spacesuit_left_2, images.spacesuit_left_3,<br/>             images.spacesuit_left_4<br/>             ],<br/>    <span class="green">"right"</span>: [images.spacesuit_right, images.spacesuit_right_1,<br/>              images.spacesuit_right_2, images.spacesuit_right_3,<br/>              images.spacesuit_right_4<br/>              ],<br/>    <span class="green">"up"</span>: [images.spacesuit_back, images.spacesuit_back_1,<br/>           images.spacesuit_back_2, images.spacesuit_back_3,<br/>           images.spacesuit_back_4<br/>           ],<br/>    <span class="green">"down"</span>: [images.spacesuit_front, images.spacesuit_front_1,<br/>             images.spacesuit_front_2, images.spacesuit_front_3,<br/>             images.spacesuit_front_4<br/>             ]<br/>    }<br/><br/><span epub:type="pagebreak" id="page_219"/>player_direction = <span class="green">"down"</span><br/>player_frame = 0<br/>player_image = PLAYER[player_direction][player_frame]<br/>player_offset_x, player_offset_y = 0, 0<br/><br/>PLAYER_SHADOW = {<br/>    <span class="green">"left"</span>: [images.spacesuit_left_shadow, images.spacesuit_left_1_shadow,<br/>             images.spacesuit_left_2_shadow, images.spacesuit_left_3_shadow,<br/>             images.spacesuit_left_3_shadow<br/>             ],<br/>    <span class="green">"right"</span>: [images.spacesuit_right_shadow, images.spacesuit_right_1_shadow,<br/>              images.spacesuit_right_2_shadow,<br/>              images.spacesuit_right_3_shadow, images.spacesuit_right_3_shadow<br/>              ],<br/>    <span class="green">"up"</span>: [images.spacesuit_back_shadow, images.spacesuit_back_1_shadow,<br/>           images.spacesuit_back_2_shadow, images.spacesuit_back_3_shadow,<br/>           images.spacesuit_back_3_shadow<br/>           ],<br/>    <span class="green">"down"</span>: [images.spacesuit_front_shadow, images.spacesuit_front_1_shadow,<br/>             images.spacesuit_front_2_shadow, images.spacesuit_front_3_shadow,<br/>             images.spacesuit_front_3_shadow<br/>             ]<br/>    }<br/><br/>player_image_shadow = PLAYER_SHADOW[<span class="green">"down"</span>][0]<br/><br/>PILLARS = [<br/>    images.pillar, images.pillar_95, images.pillar_80,<br/>    images.pillar_60, images.pillar_50<br/>    ]<br/><br/>wall_transparency_frame = 0<br/><br/>BLACK = (0, 0, 0)<br/>BLUE = (0, 155, 255)<br/>YELLOW = (255, 255, 0)<br/>WHITE = (255, 255, 255)<br/>GREEN = (0, 255, 0)<br/>RED = (128, 0, 0)<br/><br/>air, energy = 100, 100<br/>suit_stitched, air_fixed = <span class="orange">False</span>, <span class="orange">False</span><br/>launch_frame = 0<br/><br/><br/><span class="red">###############</span><br/><span class="red">##    MAP    ##</span><br/><span class="red">###############  </span><br/><br/>MAP_WIDTH = 5<br/>MAP_HEIGHT = 10<br/>MAP_SIZE = MAP_WIDTH * MAP_HEIGHT<br/><br/><span epub:type="pagebreak" id="page_220"/>GAME_MAP = [ [<span class="green">"Room 0 - where unused objects are kept"</span>, 0, 0, <span class="orange">False</span>, <span class="orange">False</span>] ]<br/><br/>outdoor_rooms = <span class="purple">range</span>(1, 26)<br/><span class="orange">for</span> planetsectors <span class="orange">in</span> <span class="purple">range</span>(1, 26): <span class="red">#rooms 1 to 25 are generated here</span><br/>    GAME_MAP.append( [<span class="green">"The dusty planet surface"</span>, 13, 13, <span class="orange">True</span>, <span class="orange">True</span>] )<br/><br/>GAME_MAP  += [<br/>        <span class="red">#["Room name", height, width, Top exit?, Right exit?]</span><br/>        [<span class="green">"The airlock"</span>, 13, 5, <span class="orange">True</span>, <span class="orange">False</span>], <span class="red"># room 26</span><br/>        [<span class="green">"The engineering lab"</span>, 13, 13, <span class="orange">False</span>, <span class="orange">False</span>], <span class="red"># room 27</span><br/>        [<span class="green">"Poodle Mission Control"</span>, 9, 13, <span class="orange">False</span>, <span class="orange">True</span>], <span class="red"># room 28</span><br/>        [<span class="green">"The viewing gallery"</span>, 9, 15, <span class="orange">False</span>, <span class="orange">False</span>], <span class="red"># room 29</span><br/>        [<span class="green">"The crew's bathroom"</span>, 5, 5, <span class="orange">False</span>, <span class="orange">False</span>], <span class="red"># room 30</span><br/>        [<span class="green">"The airlock entry bay"</span>, 7, 11, <span class="orange">True</span>, <span class="orange">True</span>], <span class="red"># room 31</span><br/>        [<span class="green">"Left elbow room"</span>, 9, 7, <span class="orange">True</span>, <span class="orange">False</span>], <span class="red"># room 32</span><br/>        [<span class="green">"Right elbow room"</span>, 7, 13, <span class="orange">True</span>, <span class="orange">True</span>], <span class="red"># room 33</span><br/>        [<span class="green">"The science lab"</span>, 13, 13, <span class="orange">False</span>, <span class="orange">True</span>], <span class="red"># room 34</span><br/>        [<span class="green">"The greenhouse"</span>, 13, 13, <span class="orange">True</span>, <span class="orange">False</span>], <span class="red"># room 35</span><br/>        [PLAYER_NAME + <span class="green">"'s sleeping quarters"</span>, 9, 11, <span class="orange">False</span>, <span class="orange">False</span>], <span class="red"># room 36</span><br/>        [<span class="green">"West corridor"</span>, 15, 5, <span class="orange">True</span>, <span class="orange">True</span>], <span class="red"># room 37</span><br/>        [<span class="green">"The briefing room"</span>, 7, 13, <span class="orange">False</span>, <span class="orange">True</span>], <span class="red"># room 38</span><br/>        [<span class="green">"The crew's community room"</span>, 11, 13, <span class="orange">True</span>, <span class="orange">False</span>], <span class="red"># room 39</span><br/>        [<span class="green">"Main Mission Control"</span>, 14, 14, <span class="orange">False</span>, <span class="orange">False</span>], <span class="red"># room 40</span><br/>        [<span class="green">"The sick bay"</span>, 12, 7, <span class="orange">True</span>, <span class="orange">False</span>], <span class="red"># room 41</span><br/>        [<span class="green">"West corridor"</span>, 9, 7, <span class="orange">True</span>, <span class="orange">False</span>], <span class="red"># room 42</span><br/>        [<span class="green">"Utilities control room"</span>, 9, 9, <span class="orange">False</span>, <span class="orange">True</span>], <span class="red"># room 43</span><br/>        [<span class="green">"Systems engineering bay"</span>, 9, 11, <span class="orange">False</span>, <span class="orange">False</span>], <span class="red"># room 44</span><br/>        [<span class="green">"Security portal to Mission Control"</span>, 7, 7, <span class="orange">True</span>, <span class="orange">False</span>], <span class="red"># room 45</span><br/>        [FRIEND1_NAME + <span class="green">"'s sleeping quarters"</span>, 9, 11, <span class="orange">True</span>, <span class="orange">True</span>], <span class="red"># room 46</span><br/>        [FRIEND2_NAME + <span class="green">"'s sleeping quarters"</span>, 9, 11, <span class="orange">True</span>, <span class="orange">True</span>], <span class="red"># room 47</span><br/>        [<span class="green">"The pipeworks"</span>, 13, 11, <span class="orange">True</span>, <span class="orange">False</span>], <span class="red"># room 48</span><br/>        [<span class="green">"The chief scientist's office"</span>, 9, 7, <span class="orange">True</span>, <span class="orange">True</span>], <span class="red"># room 49</span><br/>        [<span class="green">"The robot workshop"</span>, 9, 11, <span class="orange">True</span>, <span class="orange">False</span>] <span class="red"># room 50</span><br/>        ]<br/><br/><span class="red">#simple sanity check on map above to check data entry</span><br/><span class="orange">assert</span> <span class="purple">len</span>(GAME_MAP)-1 == MAP_SIZE, <span class="green">"Map size and GAME_MAP don't match"</span><br/><br/><br/><span class="red">###############</span><br/><span class="red">##  OBJECTS  ##</span><br/><span class="red">###############</span><br/><br/>objects = {<br/>    0: [images.floor, <span class="orange">None</span>, <span class="green">"The floor is shiny and clean"</span>],<br/>    1: [images.pillar, images.full_shadow, <span class="green">"The wall is smooth and cold"</span>],<br/>    2: [images.soil, <span class="orange">None</span>, <span class="green">"It's like a desert. Or should that be dessert?"</span>],<br/>    3: [images.pillar_low, images.half_shadow, <span class="green">"The wall is smooth and cold"</span>],<br/>    4: [images.bed, images.half_shadow, <span class="green">"A tidy and comfortable bed"</span>],<br/>    5: [images.table, images.half_shadow, <span class="green">"It's made from strong plastic."</span>],<br/>    6: [images.chair_left, <span class="orange">None</span>, <span class="green">"A chair with a soft cushion"</span>],<br/>    7: [images.chair_right, <span class="orange">None</span>, <span class="green">"A chair with a soft cushion"</span>],<br/>    8: [images.bookcase_tall, images.full_shadow,<br/>        <span class="green">"Bookshelves, stacked with reference books"</span>],<br/><span epub:type="pagebreak" id="page_221"/>    9: [images.bookcase_small, images.half_shadow,<br/>        <span class="green">"Bookshelves, stacked with reference books"</span>],<br/>    10: [images.cabinet, images.half_shadow,<br/>         <span class="green">"A small locker, for storing personal items"</span>],<br/>    11: [images.desk_computer, images.half_shadow,<br/>         <span class="green">"A computer. Use it to run life support diagnostics"</span>],<br/>    12: [images.plant, images.plant_shadow, <span class="green">"A spaceberry plant, grown here"</span>],<br/>    13: [images.electrical1, images.half_shadow,<br/>         <span class="green">"Electrical systems used for powering the space station"</span>],<br/>    14: [images.electrical2, images.half_shadow,<br/>         <span class="green">"Electrical systems used for powering the space station"</span>],<br/>    15: [images.cactus, images.cactus_shadow, <span class="green">"Ouch! Careful on the cactus!"</span>],<br/>    16: [images.shrub, images.shrub_shadow,<br/>         <span class="green">"A space lettuce. A bit limp, but amazing it's growing here!"</span>],<br/>    17: [images.pipes1, images.pipes1_shadow, <span class="green">"Water purification pipes"</span>],<br/>    18: [images.pipes2, images.pipes2_shadow,<br/>         <span class="green">"Pipes for the life support systems"</span>],<br/>    19: [images.pipes3, images.pipes3_shadow,<br/>         <span class="green">"Pipes for the life support systems"</span>],<br/>    20: [images.door, images.door_shadow, <span class="green">"Safety door. Opens automatically \</span><br/><span class="green">for astronauts in functioning spacesuits."</span>],<br/>    21: [images.door, images.door_shadow, <span class="green">"The airlock door. \</span><br/><span class="green">For safety reasons, it requires two person operation."</span>],<br/>    22: [images.door, images.door_shadow, <span class="green">"A locked door. It needs "</span> \<br/>         + PLAYER_NAME + <span class="green">"'s access card"</span>],<br/>    23: [images.door, images.door_shadow, <span class="green">"A locked door. It needs "</span> \<br/>         + FRIEND1_NAME + <span class="green">"'s access card"</span>],<br/>    24: [images.door, images.door_shadow, <span class="green">"A locked door. It needs "</span> \<br/>         + FRIEND2_NAME + <span class="green">"'s access card"</span>],<br/>    25: [images.door, images.door_shadow,<br/>         <span class="green">"A locked door. It is opened from Main Mission Control"</span>],<br/>    26: [images.door, images.door_shadow,<br/>         <span class="green">"A locked door in the engineering bay."</span>],<br/>    27: [images.map, images.full_shadow,<br/>         <span class="green">"The screen says the crash site was Sector: "</span> \<br/>         + <span class="purple">str</span>(LANDER_SECTOR) + <span class="green">" // X: "</span> + <span class="purple">str</span>(LANDER_X) + \<br/>         <span class="green">" // Y: "</span> + <span class="purple">str</span>(LANDER_Y)],<br/>    28: [images.rock_large, images.rock_large_shadow,<br/>         <span class="green">"A rock. Its coarse surface feels like a whetstone"</span>, <span class="green">"the rock"</span>],<br/>    29: [images.rock_small, images.rock_small_shadow,<br/>         <span class="green">"A small but heavy piece of Martian rock"</span>],<br/>    30: [images.crater, <span class="orange">None</span>, <span class="green">"A crater in the planet surface"</span>],<br/>    31: [images.fence, <span class="orange">None</span>,<br/>         <span class="green">"A fine gauze fence. It helps protect the station from dust storms"</span>],<br/>    32: [images.contraption, images.contraption_shadow,<br/>         <span class="green">"One of the scientific experiments. It gently vibrates"</span>],<br/>    33: [images.robot_arm, images.robot_arm_shadow,<br/>         <span class="green">"A robot arm, used for heavy lifting"</span>],<br/>    34: [images.toilet, images.half_shadow, <span class="green">"A sparkling clean toilet"</span>],<br/>    35: [images.sink, <span class="orange">None</span>, <span class="green">"A sink with running water"</span>, <span class="green">"the taps"</span>],<br/>    36: [images.globe, images.globe_shadow,<br/>         <span class="green">"A giant globe of the planet. It gently glows from inside"</span>],<br/>    37: [images.science_lab_table, <span class="orange">None</span>,<br/>         <span class="green">"A table of experiments, analyzing the planet soil and dust"</span>],<br/><span epub:type="pagebreak" id="page_222"/>    38: [images.vending_machine, images.full_shadow,<br/>         <span class="green">"A vending machine. It requires a credit."</span>, <span class="green">"the vending machine"</span>],<br/>    39: [images.floor_pad, <span class="orange">None</span>,<br/>         <span class="green">"A pressure sensor to make sure nobody goes out alone."</span>],<br/>    40: [images.rescue_ship, images.rescue_ship_shadow, <span class="green">"A rescue ship!"</span>],<br/>    41: [images.mission_control_desk, images.mission_control_desk_shadow, \<br/>         <span class="green">"Mission Control stations."</span>],<br/>    42: [images.button, images.button_shadow,<br/>         <span class="green">"The button for opening the time-locked door in engineering."</span>],<br/>    43: [images.whiteboard, images.full_shadow,<br/>         <span class="green">"The whiteboard is used in brainstorms and planning meetings."</span>],<br/>    44: [images.window, images.full_shadow,<br/>         <span class="green">"The window provides a view out onto the planet surface."</span>],<br/>    45: [images.robot, images.robot_shadow, <span class="green">"A cleaning robot, turned off."</span>],<br/>    46: [images.robot2, images.robot2_shadow,<br/>         <span class="green">"A planet surface exploration robot, awaiting set-up."</span>],<br/>    47: [images.rocket, images.rocket_shadow, <span class="green">"A 1-person craft in repair."</span>],<br/>    48: [images.toxic_floor, <span class="orange">None</span>, <span class="green">"Toxic floor - do not walk on!"</span>],<br/>    49: [images.drone, <span class="orange">None</span>, <span class="green">"A delivery drone"</span>],<br/>    50: [images.energy_ball, <span class="orange">None</span>, <span class="green">"An energy ball - dangerous!"</span>],<br/>    51: [images.energy_ball2, <span class="orange">None</span>, <span class="green">"An energy ball - dangerous!"</span>],<br/>    52: [images.computer, images.computer_shadow,<br/>         <span class="green">"A computer workstation, for managing space station systems."</span>],<br/>    53: [images.clipboard, <span class="orange">None</span>,<br/>         <span class="green">"A clipboard. Someone has doodled on it."</span>, <span class="green">"the clipboard"</span>],<br/>    54: [images.bubble_gum, <span class="orange">None</span>,<br/>         <span class="green">"A piece of sticky bubble gum. Spaceberry flavour."</span>, <span class="green">"bubble gum"</span>],<br/>    55: [images.yoyo, <span class="orange">None</span>, <span class="green">"A toy made of fine, strong string and plastic. \</span><br/><span class="green">Used for antigrav experiments."</span>, PLAYER_NAME + <span class="green">"'s yoyo"</span>],<br/>    56: [images.thread, <span class="orange">None</span>,<br/>         <span class="green">"A piece of fine, strong string"</span>, <span class="green">"a piece of string"</span>],<br/>    57: [images.needle, <span class="orange">None</span>,<br/>         <span class="green">"A sharp needle from a cactus plant"</span>, <span class="green">"a cactus needle"</span>],<br/>    58: [images.threaded_needle, <span class="orange">None</span>,<br/>         <span class="green">"A cactus needle, spearing a length of string"</span>, <span class="green">"needle and string"</span>],<br/>    59: [images.canister, <span class="orange">None</span>,<br/>         <span class="green">"The air canister has a leak."</span>, <span class="green">"a leaky air canister"</span>],<br/>    60: [images.canister, <span class="orange">None</span>,<br/>         <span class="green">"It looks like the seal will hold!"</span>, <span class="green">"a sealed air canister"</span>],<br/>    61: [images.mirror, <span class="orange">None</span>,<br/>         <span class="green">"The mirror throws a circle of light on the walls."</span>, <span class="green">"a mirror"</span>],<br/>    62: [images.bin_empty, <span class="orange">None</span>,<br/>         <span class="green">"A rarely used bin, made of light plastic"</span>, <span class="green">"a bin"</span>],<br/>    63: [images.bin_full, <span class="orange">None</span>,<br/>         <span class="green">"A heavy bin full of water"</span>, <span class="green">"a bin full of water"</span>],<br/>    64: [images.rags, <span class="orange">None</span>,<br/>         <span class="green">"An oily rag. Pick it up by a corner if you must!"</span>, <span class="green">"an oily rag"</span>],<br/>    65: [images.hammer, <span class="orange">None</span>,<br/>         <span class="green">"A hammer. Maybe good for cracking things open..."</span>, <span class="green">"a hammer"</span>],<br/>    66: [images.spoon, <span class="orange">None</span>, <span class="green">"A large serving spoon"</span>, <span class="green">"a spoon"</span>],<br/>    67: [images.food_pouch, <span class="orange">None</span>,<br/>         <span class="green">"A dehydrated food pouch. It needs water."</span>, <span class="green">"a dry food pack"</span>],<br/>    68: [images.food, <span class="orange">None</span>,<br/>         <span class="green">"A food pouch. Use it to get 100% energy."</span>, <span class="green">"ready-to-eat food"</span>],<br/><span epub:type="pagebreak" id="page_223"/>    69: [images.book, <span class="orange">None</span>, <span class="green">"The book has the words 'Don't Panic' on the \</span><br/><span class="green">cover in large, friendly letters"</span>, <span class="green">"a book"</span>],<br/>    70: [images.mp3_player, <span class="orange">None</span>,<br/>         <span class="green">"An MP3 player, with all the latest tunes"</span>, <span class="green">"an MP3 player"</span>],<br/>    71: [images.lander, <span class="orange">None</span>, <span class="green">"The Poodle, a small space exploration craft. \</span><br/><span class="green">Its black box has a radio sealed inside."</span>, <span class="green">"the Poodle lander"</span>],<br/>    72: [images.radio, <span class="orange">None</span>, <span class="green">"A radio communications system, from the \</span><br/><span class="green">Poodle"</span>, <span class="green">"a communications radio"</span>],<br/>    73: [images.gps_module, <span class="orange">None</span>, <span class="green">"A GPS Module"</span>, <span class="green">"a GPS module"</span>],<br/>    74: [images.positioning_system, <span class="orange">None</span>, <span class="green">"Part of a positioning system. \</span><br/><span class="green">Needs a GPS module."</span>, <span class="green">"a positioning interface"</span>],<br/>    75: [images.positioning_system, <span class="orange">None</span>,<br/>         <span class="green">"A working positioning system"</span>, <span class="green">"a positioning computer"</span>],<br/>    76: [images.scissors, <span class="orange">None</span>, <span class="green">"Scissors. They're too blunt to cut \</span><br/><span class="green">anything. Can you sharpen them?"</span>, <span class="green">"blunt scissors"</span>],<br/>    77: [images.scissors, <span class="orange">None</span>,<br/>         <span class="green">"Razor-sharp scissors. Careful!"</span>, <span class="green">"sharpened scissors"</span>],<br/>    78: [images.credit, <span class="orange">None</span>,<br/>         <span class="green">"A small coin for the station's vending systems"</span>,<br/>         <span class="green">"a station credit"</span>],<br/>    79: [images.access_card, <span class="orange">None</span>,<br/>         <span class="green">"This access card belongs to "</span> + PLAYER_NAME, <span class="green">"an access card"</span>],<br/>    80: [images.access_card, <span class="orange">None</span>,<br/>         <span class="green">"This access card belongs to "</span> + FRIEND1_NAME, <span class="green">"an access card"</span>],<br/>    81: [images.access_card, <span class="orange">None</span>,<br/>         <span class="green">"This access card belongs to "</span> + FRIEND2_NAME, <span class="green">"an access card"</span>]<br/>    }<br/><br/>items_player_may_carry = <span class="purple">list</span>(<span class="purple">range</span>(53, 82))<br/><span class="red"># Numbers below are for floor, pressure pad, soil, toxic floor.</span><br/>items_player_may_stand_on = items_player_may_carry + [0, 39, 2, 48]<br/><br/><br/><span class="red">###############</span><br/><span class="red">##  SCENERY  ##</span><br/><span class="red">###############</span><br/><br/><span class="red"># Scenery describes objects that cannot move between rooms.</span><br/><span class="red"># room number: [[object number, y position, x position]...]</span><br/>scenery = {<br/>    26: [[39,8,2]],<br/>    27: [[33,5,5], [33,1,1], [33,1,8], [47,5,2],<br/>         [47,3,10], [47,9,8], [42,1,6]],<br/>    28: [[27,0,3], [41,4,3], [41,4,7]],<br/>    29: [[7,2,6], [6,2,8], [12,1,13], [44,0,1],<br/>         [36,4,10], [10,1,1], [19,4,2], [17,4,4]],<br/>    30: [[34,1,1], [35,1,3]],<br/>    31: [[11,1,1], [19,1,8], [46,1,3]],<br/>    32: [[48,2,2], [48,2,3], [48,2,4], [48,3,2], [48,3,3],<br/>         [48,3,4], [48,4,2], [48,4,3], [48,4,4]],<br/>    33: [[13,1,1], [13,1,3], [13,1,8], [13,1,10], [48,2,1],<br/>         [48,2,7], [48,3,6], [48,3,3]],<br/>    34: [[37,2,2], [32,6,7], [37,10,4], [28,5,3]],<br/><span epub:type="pagebreak" id="page_224"/>    35: [[16,2,9], [16,2,2], [16,3,3], [16,3,8], [16,8,9], [16,8,2], [16,1,8],<br/>         [16,1,3], [12,8,6], [12,9,4], [12,9,8],<br/>         [15,4,6], [12,7,1], [12,7,11]],<br/>    36: [[4,3,1], [9,1,7], [8,1,8], [8,1,9],<br/>         [5,5,4], [6,5,7], [10,1,1], [12,1,2]],<br/>    37: [[48,3,1], [48,3,2], [48,7,1], [48,5,2], [48,5,3],<br/>         [48,7,2], [48,9,2], [48,9,3], [48,11,1], [48,11,2]],<br/>    38: [[43,0,2], [6,2,2], [6,3,5], [6,4,7], [6,2,9], [45,1,10]],<br/>    39: [[38,1,1], [7,3,4], [7,6,4], [5,3,6], [5,6,6],<br/>         [6,3,9], [6,6,9], [45,1,11], [12,1,8], [12,1,4]],<br/>    40: [[41,5,3], [41,5,7], [41,9,3], [41,9,7],<br/>         [13,1,1], [13,1,3], [42,1,12]],<br/>    41: [[4,3,1], [10,3,5], [4,5,1], [10,5,5], [4,7,1],<br/>         [10,7,5], [12,1,1], [12,1,5]],<br/>    44: [[46,4,3], [46,4,5], [18,1,1], [19,1,3],<br/>         [19,1,5], [52,4,7], [14,1,8]],<br/>    45: [[48,2,1], [48,2,2], [48,3,3], [48,3,4], [48,1,4], [48,1,1]],<br/>    46: [[10,1,1], [4,1,2], [8,1,7], [9,1,8], [8,1,9], [5,4,3], [7,3,2]],<br/>    47: [[9,1,1], [9,1,2], [10,1,3], [12,1,7], [5,4,4], [6,4,7], [4,1,8]],<br/>    48: [[17,4,1], [17,4,2], [17,4,3], [17,4,4], [17,4,5], [17,4,6], [17,4,7],<br/>         [17,8,1], [17,8,2], [17,8,3], [17,8,4],<br/>         [17,8,5], [17,8,6], [17,8,7], [14,1,1]],<br/>    49: [[14,2,2], [14,2,4], [7,5,1], [5,5,3], [48,3,3], [48,3,4]],<br/>    50: [[45,4,8], [11,1,1], [13,1,8], [33,2,1], [46,4,6]]<br/>    }<br/><br/>checksum = 0<br/>check_counter = 0<br/><span class="orange">for</span> key, room_scenery_list <span class="orange">in</span> scenery.items():<br/>    <span class="orange">for</span> scenery_item_list <span class="orange">in</span> room_scenery_list:<br/>        checksum += (scenery_item_list[0] * key<br/>                     + scenery_item_list[1] * (key + 1)<br/>                     + scenery_item_list[2] * (key + 2))<br/>        check_counter += 1<br/><span class="purple">print</span>(check_counter, <span class="green">"scenery items"</span>)<br/><span class="orange">assert</span> check_counter == 161, <span class="green">"Expected 161 scenery items"</span><br/><span class="orange">assert</span> checksum == 200095, <span class="green">"Error in scenery data"</span><br/><span class="purple">print</span>(<span class="green">"Scenery checksum: "</span> + <span class="purple">str</span>(checksum))<br/><br/><span class="orange">for</span> room <span class="orange">in</span> <span class="purple">range</span>(1, 26): <span class="red"># Add random scenery in planet locations.</span><br/>    <span class="orange">if</span> room != 13: <span class="red"># Skip room 13.</span><br/>        scenery_item = random.choice([16, 28, 29, 30])<br/>        scenery[room] = [[scenery_item, random.randint(2, 10),<br/>                          random.randint(2, 10)]]<br/><br/><span class="red"># Use loops to add fences to the planet surface rooms.</span><br/><span class="orange">for</span> room_coordinate <span class="orange">in</span> <span class="purple">range</span>(0, 13):<br/>    <span class="orange">for</span> room_number <span class="orange">in</span> [1, 2, 3, 4, 5]: <span class="red"># Add top fence</span><br/>        scenery[room_number] += [[31, 0, room_coordinate]]<br/>    <span class="orange">for</span> room_number <span class="orange">in</span> [1, 6, 11, 16, 21]: <span class="red"># Add left fence</span><br/>        scenery[room_number] += [[31, room_coordinate, 0]]<br/>    <span class="orange">for</span> room_number <span class="orange">in</span> [5, 10, 15, 20, 25]: <span class="red"># Add right fence</span><br/>        scenery[room_number] += [[31, room_coordinate, 12]]<br/><br/><span epub:type="pagebreak" id="page_225"/><span class="orange">del</span> scenery[21][-1] <span class="red"># Delete last fence panel in Room 21</span><br/><span class="orange">del</span> scenery[25][-1] <span class="red"># Delete last fence panel in Room 25</span><br/><br/><br/><span class="red">###############</span><br/><span class="red">## MAKE MAP  ##</span><br/><span class="red">###############</span><br/><br/><span class="orange">def</span> <span class="blue">get_floor_type</span>():<br/>    <span class="orange">if</span> current_room <span class="orange">in</span> outdoor_rooms:<br/>        <span class="orange">return</span> 2 <span class="red"># soil</span><br/>    <span class="orange">else</span>:<br/>        <span class="orange">return</span> 0 <span class="red"># tiled floor</span><br/><br/><span class="orange">def</span> <span class="blue">generate_map</span>():<br/><span class="red"># This function makes the map for the current room,</span><br/><span class="red"># using room data, scenery data and prop data.</span><br/>    <span class="orange">global</span> room_map, room_width, room_height, room_name, hazard_map<br/>    <span class="orange">global</span> top_left_x, top_left_y, wall_transparency_frame<br/>    room_data = GAME_MAP[current_room]<br/>    room_name = room_data[0]<br/>    room_height = room_data[1]<br/>    room_width = room_data[2]<br/><br/>    floor_type = get_floor_type()<br/>    <span class="orange">if</span> current_room <span class="orange">in</span> <span class="purple">range</span>(1, 21):<br/>        bottom_edge = 2 <span class="red">#soil</span><br/>        side_edge = 2 <span class="red">#soil</span><br/>    <span class="orange">if</span> current_room <span class="orange">in</span> <span class="purple">range</span>(21, 26):<br/>        bottom_edge = 1 <span class="red">#wall</span><br/>        side_edge = 2 <span class="red">#soil</span><br/>    <span class="orange">if</span> current_room &gt; 25:<br/>        bottom_edge = 1 <span class="red">#wall</span><br/>        side_edge = 1 <span class="red">#wall</span><br/><br/>    <span class="red"># Create top line of room map.</span><br/>    room_map=[[side_edge] * room_width]<br/>    <span class="red"># Add middle lines of room map (wall, floor to fill width, wall).</span><br/>    <span class="orange">for</span> y <span class="orange">in</span> <span class="purple">range</span>(room_height - 2):<br/>        room_map.append([side_edge]<br/>                        + [floor_type]*(room_width - 2) + [side_edge])<br/>    <span class="red"># Add bottom line of room map.</span><br/>    room_map.append([bottom_edge] * room_width)<br/><br/>    <span class="red"># Add doorways.</span><br/>    middle_row = <span class="purple">int</span>(room_height / 2)<br/>    middle_column = <span class="purple">int</span>(room_width / 2)<br/><br/>    <span class="orange">if</span> room_data[4]: <span class="red"># If exit at right of this room</span><br/>        room_map[middle_row][room_width - 1] = floor_type<br/>        room_map[middle_row+1][room_width - 1] = floor_type<br/>        room_map[middle_row-1][room_width - 1] = floor_type<br/><br/><span epub:type="pagebreak" id="page_226"/>    <span class="orange">if</span> current_room % MAP_WIDTH != 1: <span class="red"># If room is not on left of map</span><br/>        room_to_left = GAME_MAP[current_room - 1]<br/>        <span class="red"># If room on the left has a right exit, add left exit in this room</span><br/>        <span class="orange">if</span> room_to_left[4]:<br/>            room_map[middle_row][0] = floor_type<br/>            room_map[middle_row + 1][0] = floor_type<br/>            room_map[middle_row - 1][0] = floor_type<br/><br/>    <span class="orange">if</span> room_data[3]: <span class="red"># If exit at top of this room</span><br/>        room_map[0][middle_column] = floor_type<br/>        room_map[0][middle_column + 1] = floor_type<br/>        room_map[0][middle_column - 1] = floor_type<br/><br/>    <span class="orange">if</span> current_room &lt;= MAP_SIZE - MAP_WIDTH: <span class="red"># If room is not on bottom row</span><br/>        room_below = GAME_MAP[current_room+MAP_WIDTH]<br/>        <span class="red"># If room below has a top exit, add exit at bottom of this one</span><br/>        <span class="orange">if</span> room_below[3]:<br/>            room_map[room_height-1][middle_column] = floor_type<br/>            room_map[room_height-1][middle_column + 1] = floor_type<br/>            room_map[room_height-1][middle_column - 1] = floor_type<br/><br/>    <span class="orange">if</span> current_room <span class="orange">in</span> scenery:<br/>        <span class="orange">for</span> this_scenery <span class="orange">in</span> scenery[current_room]:<br/>            scenery_number = this_scenery[0]<br/>            scenery_y = this_scenery[1]<br/>            scenery_x = this_scenery[2]<br/>            room_map[scenery_y][scenery_x] = scenery_number<br/><br/>            image_here = objects[scenery_number][0]<br/>            image_width = image_here.get_width()<br/>            image_width_in_tiles = <span class="purple">int</span>(image_width / TILE_SIZE)<br/><br/>            <span class="orange">for</span> tile_number <span class="orange">in</span> <span class="purple">range</span>(1, image_width_in_tiles):<br/>                room_map[scenery_y][scenery_x + tile_number] = 255<br/><br/>    center_y = <span class="purple">int</span>(HEIGHT / 2) <span class="red"># Center of game window</span><br/>    center_x = <span class="purple">int</span>(WIDTH / 2)<br/>    room_pixel_width = room_width * TILE_SIZE <span class="red"># Size of room in pixels</span><br/>    room_pixel_height = room_height * TILE_SIZE<br/>    top_left_x = center_x - 0.5 * room_pixel_width<br/>    top_left_y = (center_y - 0.5 * room_pixel_height) + 110<br/><br/>    <span class="orange">for</span> prop_number, prop_info <span class="orange">in</span> props.items():<br/>        prop_room = prop_info[0]<br/>        prop_y = prop_info[1]<br/>        prop_x = prop_info[2]<br/>        <span class="orange">if</span> (prop_room == current_room <span class="orange">and</span><br/>            room_map[prop_y][prop_x] <span class="orange">in</span> [0, 39, 2]):<br/>                room_map[prop_y][prop_x] = prop_number<br/>                image_here = objects[prop_number][0]<br/>                image_width = image_here.get_width()<br/>                image_width_in_tiles = <span class="purple">int</span>(image_width / TILE_SIZE)<br/>                <span class="orange">for</span> tile_number <span class="orange">in</span> <span class="purple">range</span>(1, image_width_in_tiles):<br/>                    room_map[prop_y][prop_x + tile_number] = 255<br/><br/><span epub:type="pagebreak" id="page_227"/>    hazard_map = [] <span class="red"># empty list</span><br/>    <span class="orange">for</span> y <span class="orange">in</span> <span class="purple">range</span>(room_height):<br/>        hazard_map.append( [0] * room_width )<br/><br/><br/><span class="red">###############</span><br/><span class="red">## GAME LOOP ##</span><br/><span class="red">###############</span><br/><br/><span class="orange">def</span> <span class="blue">start_room</span>():<br/>    <span class="orange">global</span> airlock_door_frame<br/>    show_text(<span class="green">"You are here: "</span> + room_name, 0)<br/>    <span class="orange">if</span> current_room == 26: <span class="red"># Room with self-shutting airlock door</span><br/>        airlock_door_frame = 0<br/>        clock.schedule_interval(door_in_room_26, 0.05)<br/>    hazard_start()<br/><br/><span class="orange">def</span> <span class="blue">game_loop</span>():<br/>    <span class="orange">global</span> player_x, player_y, current_room<br/>    <span class="orange">global</span> from_player_x, from_player_y<br/>    <span class="orange">global</span> player_image, player_image_shadow<br/>    <span class="orange">global</span> selected_item, item_carrying, energy<br/>    <span class="orange">global</span> player_offset_x, player_offset_y<br/>    <span class="orange">global</span> player_frame, player_direction<br/><br/>    <span class="orange">if</span> game_over:<br/>        <span class="orange">return</span><br/><br/>    <span class="orange">if</span> player_frame &gt; 0:<br/>        player_frame += 1<br/>        time.sleep(0.05)<br/>        <span class="orange">if</span> player_frame == 5:<br/>            player_frame = 0<br/>            player_offset_x = 0<br/>            player_offset_y = 0<br/><br/><span class="red"># save player's current position</span><br/>    old_player_x = player_x<br/>    old_player_y = player_y<br/><br/><span class="red"># move if key is pressed</span><br/>    <span class="orange">if</span> player_frame == 0:<br/>        <span class="orange">if</span> keyboard.right:<br/>            from_player_x = player_x<br/>            from_player_y = player_y<br/>            player_x += 1<br/>            player_direction = <span class="green">"right"</span><br/>            player_frame = 1<br/>        <span class="orange">elif</span> keyboard.left: <span class="red">#elif stops player making diagonal movements</span><br/>            from_player_x = player_x<br/>            from_player_y = player_y<br/>            player_x -= 1<br/>            player_direction = <span class="green">"left"</span><br/>            player_frame = 1<br/><span epub:type="pagebreak" id="page_228"/>        <span class="orange">elif</span> keyboard.up:<br/>            from_player_x = player_x<br/>            from_player_y = player_y<br/>            player_y -= 1<br/>            player_direction = <span class="green">"up"</span><br/>            player_frame = 1<br/>        <span class="orange">elif</span> keyboard.down:<br/>            from_player_x = player_x<br/>            from_player_y = player_y<br/>            player_y += 1<br/>            player_direction = <span class="green">"down"</span><br/>            player_frame = 1        <br/><br/><span class="red"># check for exiting the room</span><br/>    <span class="orange">if</span> player_x == room_width: <span class="red"># through door on RIGHT</span><br/>        clock.unschedule(hazard_move)<br/>        current_room += 1<br/>        generate_map()<br/>        player_x = 0 <span class="red"># enter at left</span><br/>        player_y = <span class="purple">int</span>(room_height / 2) <span class="red"># enter at door</span><br/>        player_frame = 0<br/>        start_room()<br/>        <span class="orange">return</span><br/><br/>    <span class="orange">if</span> player_x == -1: <span class="red"># through door on LEFT</span><br/>        clock.unschedule(hazard_move)<br/>        current_room -= 1<br/>        generate_map()<br/>        player_x = room_width - 1  <span class="red"># enter at right</span><br/>        player_y = <span class="purple">int</span>(room_height / 2) <span class="red"># enter at door</span><br/>        player_frame = 0<br/>        start_room()<br/>        <span class="orange">return</span><br/><br/>    <span class="orange">if</span> player_y == room_height: <span class="red"># through door at BOTTOM</span><br/>        clock.unschedule(hazard_move)<br/>        current_room += MAP_WIDTH<br/>        generate_map()<br/>        player_y = 0 <span class="red"># enter at top</span><br/>        player_x = <span class="purple">int</span>(room_width / 2) <span class="red"># enter at door</span><br/>        player_frame = 0<br/>        start_room()<br/>        <span class="orange">return</span><br/><br/>    <span class="orange">if</span> player_y == -1: <span class="red"># through door at TOP</span><br/>        clock.unschedule(hazard_move)<br/>        current_room -= MAP_WIDTH<br/>        generate_map()<br/>        player_y = room_height - 1 <span class="red"># enter at bottom</span><br/>        player_x = <span class="purple">int</span>(room_width / 2) <span class="red"># enter at door</span><br/>        player_frame = 0<br/>        start_room()<br/>        <span class="orange">return</span><br/><br/><span epub:type="pagebreak" id="page_229"/>    <span class="orange">if</span> keyboard.g:<br/>        pick_up_object()<br/><br/>    <span class="orange">if</span> keyboard.tab <span class="orange">and</span> <span class="purple">len</span>(in_my_pockets) &gt; 0:<br/>        selected_item += 1<br/>        <span class="orange">if</span> selected_item &gt; <span class="purple">len</span>(in_my_pockets) - 1:<br/>            selected_item = 0<br/>        item_carrying = in_my_pockets[selected_item]<br/>        display_inventory()<br/><br/>    <span class="orange">if</span> keyboard.d <span class="orange">and</span> item_carrying:<br/>        drop_object(old_player_y, old_player_x)<br/><br/>    <span class="orange">if</span> keyboard.space:<br/>        examine_object()<br/><br/>    <span class="orange">if</span> keyboard.u:<br/>        use_object()<br/><br/><span class="red">#### Teleporter for testing</span><br/><span class="red">#### Remove this section for the real game</span><br/><span class="red">##    if keyboard.x:</span><br/><span class="red">##        current_room = int(input("Enter room number:"))</span><br/><span class="red">##        player_x = 2</span><br/><span class="red">##        player_y = 2</span><br/><span class="red">##        generate_map()</span><br/><span class="red">##        start_room()</span><br/><span class="red">##        sounds.teleport.play()</span><br/><span class="red">#### Teleport section ends</span><br/><br/>  <span class="red"># If the player is standing somewhere they shouldn't, move them back.</span><br/>    <span class="orange">if</span> room_map[player_y][player_x] <span class="orange">not</span> <span class="orange">in</span> items_player_may_stand_on \<br/>               <span class="orange">or</span> hazard_map[player_y][player_x] != 0:<br/>        player_x = old_player_x<br/>        player_y = old_player_y<br/>        player_frame = 0<br/><br/>    <span class="orange">if</span> room_map[player_y][player_x] == 48: <span class="red"># toxic floor</span><br/>        deplete_energy(1)<br/><br/>    <span class="orange">if</span> player_direction == <span class="green">"right"</span> <span class="orange">and</span> player_frame &gt; 0:<br/>        player_offset_x = -1 + (0.25 * player_frame)<br/>    <span class="orange">if</span> player_direction == <span class="green">"left"</span> <span class="orange">and</span> player_frame &gt; 0:<br/>        player_offset_x = 1 - (0.25 * player_frame)<br/>    <span class="orange">if</span> player_direction == <span class="green">"up"</span> <span class="orange">and</span> player_frame &gt; 0:<br/>        player_offset_y = 1 - (0.25 * player_frame)<br/>    <span class="orange">if</span> player_direction == <span class="green">"down"</span> <span class="orange">and</span> player_frame &gt; 0:<br/>        player_offset_y = -1 + (0.25 * player_frame)<br/><br/><br/><span class="red">###############</span><br/><span class="red">##  DISPLAY  ##</span><br/><span class="red">###############</span><br/><br/><span epub:type="pagebreak" id="page_230"/><span class="orange">def</span> <span class="blue">draw_image</span>(image, y, x):<br/>    screen.blit(<br/>        image,<br/>        (top_left_x + (x * TILE_SIZE),<br/>         top_left_y + (y * TILE_SIZE) - image.get_height())<br/>        )<br/><br/><span class="orange">def</span> <span class="blue">draw_shadow</span>(image, y, x):<br/>    screen.blit(<br/>        image,<br/>        (top_left_x + (x * TILE_SIZE),<br/>         top_left_y + (y * TILE_SIZE))<br/>        )<br/><br/><span class="orange">def</span> <span class="blue">draw_player</span>():<br/>    player_image = PLAYER[player_direction][player_frame]<br/>    draw_image(player_image, player_y + player_offset_y,<br/>               player_x + player_offset_x)<br/>    player_image_shadow = PLAYER_SHADOW[player_direction][player_frame]<br/>    draw_shadow(player_image_shadow, player_y + player_offset_y,<br/>                player_x + player_offset_x)<br/><br/><span class="orange">def</span> <span class="blue">draw</span>():<br/>    <span class="orange">if</span> game_over:<br/>        <span class="orange">return</span><br/><br/>    <span class="red"># Clear the game arena area.</span><br/>    box = Rect((0, 150), (800, 600))<br/>    screen.draw.filled_rect(box, RED)<br/>    box = Rect ((0, 0), (800, top_left_y + (room_height - 1)*30))<br/>    screen.surface.set_clip(box)<br/>    floor_type = get_floor_type()<br/><br/>    <span class="orange">for</span> y <span class="orange">in</span> <span class="purple">range</span>(room_height): <span class="red"># Lay down floor tiles, then items on floor.</span><br/>        <span class="orange">for</span> x <span class="orange">in</span> <span class="purple">range</span>(room_width):<br/>            draw_image(objects[floor_type][0], y, x)<br/>            <span class="red"># Next line enables shadows to fall on top of objects on floor</span><br/>            <span class="orange">if</span> room_map[y][x] <span class="orange">in</span> items_player_may_stand_on:<br/>                draw_image(objects[room_map[y][x]][0], y, x)<br/><br/>    <span class="red"># Pressure pad in room 26 is added here, so props can go on top of it.</span><br/>    <span class="orange">if</span> current_room == 26:<br/>        draw_image(objects[39][0], 8, 2)<br/>        image_on_pad = room_map[8][2]<br/>        <span class="orange">if</span> image_on_pad &gt; 0:<br/>            draw_image(objects[image_on_pad][0], 8, 2)<br/><br/>    <span class="orange">for</span> y <span class="orange">in</span> <span class="purple">range</span>(room_height):<br/>        <span class="orange">for</span> x <span class="orange">in</span> <span class="purple">range</span>(room_width):<br/>            item_here = room_map[y][x]<br/>            <span class="red"># Player cannot walk on 255: it marks spaces used by wide objects.</span><br/>            <span class="orange">if</span> item_here <span class="orange">not</span> <span class="orange">in</span> items_player_may_stand_on + [255]:<br/>                image = objects[item_here][0]<br/><span epub:type="pagebreak" id="page_231"/>                <span class="orange">if</span> (current_room <span class="orange">in</span> outdoor_rooms<br/>                    <span class="orange">and</span> y == room_height - 1<br/>                    <span class="orange">and</span> room_map[y][x] == 1) <span class="orange">or</span> \<br/>                    (current_room <span class="orange">not</span> <span class="orange">in</span> outdoor_rooms<br/>                    <span class="orange">and</span> y == room_height - 1<br/>                    <span class="orange">and</span> room_map[y][x] == 1<br/>                    <span class="orange">and</span> x &gt; 0<br/>                    <span class="orange">and</span> x &lt; room_width - 1):<br/>                    <span class="red"># Add transparent wall image in the front row.</span><br/>                    image = PILLARS[wall_transparency_frame]<br/>               <br/><br/>                draw_image(image, y, x)<br/><br/>                <span class="orange">if</span> objects[item_here][1] <span class="orange">is not</span> <span class="orange">None</span>: <span class="red"># If object has a shadow</span><br/>                    shadow_image = objects[item_here][1]<br/>                    <span class="red"># if shadow might need horizontal tiling</span><br/>                    <span class="orange">if</span> shadow_image <span class="orange">in</span> [images.half_shadow,<br/>                                        images.full_shadow]:<br/>                        shadow_width = <span class="purple">int</span>(image.get_width() / TILE_SIZE)<br/>                        <span class="red"># Use shadow across width of object.</span><br/>                        <span class="orange">for</span> z <span class="orange">in</span> <span class="purple">range</span>(0, shadow_width):<br/>                            draw_shadow(shadow_image, y, x+z)<br/>                    <span class="orange">else</span>:<br/>                        draw_shadow(shadow_image, y, x)<br/><br/>            hazard_here = hazard_map[y][x]<br/>            <span class="orange">if</span> hazard_here != 0: <span class="red"># If there's a hazard at this position</span><br/>                draw_image(objects[hazard_here][0], y, x)<br/><br/>        <span class="orange">if</span> (player_y == y):<br/>                draw_player()<br/><br/>    screen.surface.set_clip(<span class="orange">None</span>)<br/><br/><span class="orange">def</span> <span class="blue">adjust_wall_transparency</span>():<br/>    <span class="orange">global</span> wall_transparency_frame<br/><br/>    <span class="orange">if</span> (player_y == room_height - 2<br/>        <span class="orange">and</span> room_map[room_height - 1][player_x] == 1<br/>        <span class="orange">and</span> wall_transparency_frame &lt; 4):  <br/>        wall_transparency_frame += 1 <span class="red"># Fade wall out.</span><br/><br/>    <span class="orange">if</span> ((player_y &lt; room_height - 2<br/>            <span class="orange">or</span> room_map[room_height - 1][player_x] != 1)<br/>            <span class="orange">and</span> wall_transparency_frame &gt; 0):<br/>        wall_transparency_frame -= 1 <span class="red"># Fade wall in.</span><br/><br/><span class="orange">def</span> <span class="blue">show_text</span>(text_to_show, line_number):<br/>    <span class="orange">if</span> game_over:<br/>        <span class="orange">return</span><br/>    text_lines = [15, 50]<br/>    box = Rect((0, text_lines[line_number]), (800, 35))<br/>    screen.draw.filled_rect(box, BLACK)<br/>    screen.draw.text(text_to_show,<br/>                     (20, text_lines[line_number]), color=GREEN)<br/><br/><br/><span epub:type="pagebreak" id="page_232"/><span class="red">###############</span><br/><span class="red">##   PROPS   ##</span><br/><span class="red">###############</span><br/><br/><span class="red"># Props are objects that may move between rooms, appear or disappear.</span><br/><span class="red"># All props must be set up here. Props not yet in the game go into room 0.</span><br/><span class="red"># object number : [room, y, x]</span><br/>props = {<br/>    20: [31, 0, 4], 21: [26, 0, 1], 22: [41, 0, 2], 23: [39, 0, 5],<br/>    24: [45, 0, 2],<br/>    25: [32, 0, 2], 26: [27, 12, 5], <span class="red"># two sides of same door</span><br/>    40: [0, 8, 6], 53: [45, 1, 5], 54: [0, 0, 0], 55: [0, 0, 0],<br/>    56: [0, 0, 0], 57: [35, 4, 6], 58: [0, 0, 0], 59: [31, 1, 7],<br/>    60: [0, 0, 0], 61: [36, 1, 1], 62: [36, 1, 6], 63: [0, 0, 0],<br/>    64: [27, 8, 3], 65: [50, 1, 7], 66: [39, 5, 6], 67: [46, 1, 1],<br/>    68: [0, 0, 0], 69: [30, 3, 3], 70: [47, 1, 3],<br/>    71: [0, LANDER_Y, LANDER_X], 72: [0, 0, 0], 73: [27, 4, 6],<br/>    74: [28, 1, 11], 75: [0, 0, 0], 76: [41, 3, 5], 77: [0, 0, 0],<br/>    78: [35, 9, 11], 79: [26, 3, 2], 80: [41, 7, 5], 81: [29, 1, 1]<br/>    }<br/><br/>checksum = 0<br/><span class="orange">for</span> key, prop <span class="orange">in</span> props.items():<br/>    <span class="orange">if</span> key != 71: <span class="red"># 71 is skipped because it's different each game.</span><br/>        checksum += (prop[0] * key<br/>                     + prop[1] * (key + 1)<br/>                     + prop[2] * (key + 2))<br/><span class="purple">print</span>(<span class="purple">len</span>(props), <span class="green">"props"</span>)<br/><span class="orange">assert</span> <span class="purple">len</span>(props) == 37, <span class="green">"Expected 37 prop items"</span><br/><span class="purple">print</span>(<span class="green">"Prop checksum:"</span>, checksum)<br/><span class="orange">assert</span> checksum == 61414, <span class="green">"Error in props data"</span><br/><br/>in_my_pockets = [55]<br/>selected_item = 0 <span class="red"># the first item</span><br/>item_carrying = in_my_pockets[selected_item]<br/><br/>RECIPES = [<br/>    [62, 35, 63], [76, 28, 77], [78, 38, 54], [73, 74, 75],<br/>    [59, 54, 60], [77, 55, 56], [56, 57, 58], [71, 65, 72],<br/>    [88, 58, 89], [89, 60, 90], [67, 35, 68]<br/>    ]<br/><br/>checksum = 0<br/>check_counter = 1<br/><span class="orange">for</span> recipe <span class="orange">in</span> RECIPES:<br/>    checksum += (recipe[0] * check_counter<br/>                 + recipe[1] * (check_counter + 1)<br/>                 + recipe[2] * (check_counter + 2))<br/>    check_counter += 3<br/><span class="purple">print</span>(<span class="purple">len</span>(RECIPES), <span class="green">"recipes"</span>)<br/><span class="orange">assert</span> <span class="purple">len</span>(RECIPES) == 11, <span class="green">"Expected 11 recipes"</span><br/><span class="orange">assert</span> checksum == 37296, <span class="green">"Error in recipes data"</span><br/><span class="purple">print</span>(<span class="green">"Recipe checksum:"</span>, checksum)<br/><br/><br/><span epub:type="pagebreak" id="page_233"/><span class="red">#######################</span><br/><span class="red">## PROP INTERACTIONS ##</span><br/><span class="red">#######################</span><br/><br/><span class="orange">def</span> <span class="blue">find_object_start_x</span>():<br/>    checker_x = player_x<br/>    <span class="orange">while</span> room_map[player_y][checker_x] == 255:<br/>        checker_x -= 1<br/>    <span class="orange">return</span> checker_x<br/><br/><span class="orange">def</span> <span class="blue">get_item_under_player</span>():<br/>    item_x = find_object_start_x()<br/>    item_player_is_on = room_map[player_y][item_x]<br/>    <span class="orange">return</span> item_player_is_on<br/><br/><span class="orange">def</span> <span class="blue">pick_up_object</span>():<br/>    <span class="orange">global</span> room_map<br/>    <span class="red"># Get object number at player's location.</span><br/>    item_player_is_on = get_item_under_player()<br/>    <span class="orange">if</span> item_player_is_on <span class="orange">in</span> items_player_may_carry:<br/>        <span class="red"># Clear the floor space.</span><br/>        room_map[player_y][player_x] = get_floor_type()<br/>        add_object(item_player_is_on)<br/>        show_text(<span class="green">"Now carrying "</span> + objects[item_player_is_on][3], 0)<br/>        sounds.pickup.play()<br/>        time.sleep(0.5)<br/>    <span class="orange">else</span>:<br/>        show_text(<span class="green">"You can't carry that!"</span>, 0)<br/><br/><span class="orange">def</span> <span class="blue">add_object</span>(item): <span class="red"># Adds item to inventory.</span><br/>    <span class="orange">global</span> selected_item, item_carrying<br/>    in_my_pockets.append(item)<br/>    item_carrying = item<br/>    <span class="red"># Minus one because indexes start at 0.</span><br/>    selected_item = <span class="purple">len</span>(in_my_pockets) - 1<br/>    display_inventory()<br/>    props[item][0] = 0 <span class="red"># Carried objects go into room 0 (off the map).</span><br/><br/><span class="orange">def</span> <span class="blue">display_inventory</span>():<br/>    box = Rect((0, 45), (800, 105))<br/>    screen.draw.filled_rect(box, BLACK)<br/><br/>    <span class="orange">if</span> <span class="purple">len</span>(in_my_pockets) == 0:<br/>        <span class="orange">return</span><br/><br/>    start_display = (selected_item // 16) * 16<br/>    list_to_show = in_my_pockets[start_display : start_display + 16]<br/>    selected_marker = selected_item % 16<br/><br/>    <span class="orange">for</span> item_counter <span class="orange">in</span> <span class="purple">range</span>(<span class="purple">len</span>(list_to_show)):<br/>        item_number = list_to_show[item_counter]<br/>        image = objects[item_number][0]<br/>        screen.blit(image, (25 + (46 * item_counter), 90))<br/><span epub:type="pagebreak" id="page_234"/>    box_left = (selected_marker * 46) - 3<br/>    box = Rect((22 + box_left, 85), (40, 40))<br/>    screen.draw.rect(box, WHITE)<br/>    item_highlighted = in_my_pockets[selected_item]<br/>    description = objects[item_highlighted][2]<br/>    screen.draw.text(description, (20, 130), color=<span class="green">"white"</span>)<br/><br/><span class="orange">def</span> <span class="blue">drop_object</span>(old_y, old_x):<br/>    <span class="orange">global</span> room_map, props<br/>    <span class="orange">if</span> room_map[old_y][old_x] <span class="orange">in</span> [0, 2, 39]: <span class="red"># places you can drop things</span><br/>        props[item_carrying][0] = current_room<br/>        props[item_carrying][1] = old_y<br/>        props[item_carrying][2] = old_x<br/>        room_map[old_y][old_x] = item_carrying<br/>        show_text(<span class="green">"You have dropped "</span> + objects[item_carrying][3], 0)<br/>        sounds.drop.play()<br/>        remove_object(item_carrying)<br/>        time.sleep(0.5)<br/>    <span class="orange">else</span>: <span class="red"># This only happens if there is already a prop here</span><br/>        show_text(<span class="green">"You can't drop that there."</span>, 0)<br/>        time.sleep(0.5)<br/><br/><span class="orange">def</span> <span class="blue">remove_object</span>(item): <span class="red"># Takes item out of inventory</span><br/>    <span class="orange">global</span> selected_item, in_my_pockets, item_carrying<br/>    in_my_pockets.remove(item)<br/>    selected_item = selected_item - 1<br/>    <span class="orange">if</span> selected_item &lt; 0:<br/>        selected_item = 0<br/>    <span class="orange">if</span> <span class="purple">len</span>(in_my_pockets) == 0: <span class="red"># If they're not carrying anything</span><br/>        item_carrying = <span class="orange">False</span> <span class="red"># Set item_carrying to False</span><br/>    <span class="orange">else</span>: <span class="red"># Otherwise set it to the new selected item</span><br/>        item_carrying = in_my_pockets[selected_item]<br/>    display_inventory()<br/><br/><span class="orange">def</span> <span class="blue">examine_object</span>():<br/>    item_player_is_on = get_item_under_player()<br/>    left_tile_of_item = find_object_start_x()<br/>    <span class="orange">if</span> item_player_is_on <span class="orange">in</span> [0, 2]: <span class="red"># don't describe the floor</span><br/>        <span class="orange">return</span><br/>    description = <span class="green">"You see: "</span> + objects[item_player_is_on][2]<br/>    <span class="orange">for</span> prop_number, details <span class="orange">in</span> props.items():<br/>        <span class="red"># props = object number: [room number, y, x]</span><br/>        <span class="orange">if</span> details[0] == current_room: <span class="red"># if prop is in the room</span><br/>            <span class="red"># If prop is hidden (= at player's location but not on map)</span><br/>            <span class="orange">if</span> (details[1] == player_y<br/>                <span class="orange">and</span> details[2] == left_tile_of_item<br/>                <span class="orange">and</span> room_map[details[1]][details[2]] != prop_number):<br/>                add_object(prop_number)<br/>                description = <span class="green">"You found "</span> + objects[prop_number][3]<br/>                sounds.combine.play()<br/>    show_text(description, 0)<br/>    time.sleep(0.5)<br/><br/><br/><span epub:type="pagebreak" id="page_235"/><span class="red">#################</span><br/><span class="red">## USE OBJECTS ##</span><br/><span class="red">#################</span><br/><br/><span class="orange">def</span> <span class="blue">use_object</span>():<br/>    <span class="orange">global</span> room_map, props, item_carrying, air, selected_item, energy<br/>    <span class="orange">global</span> in_my_pockets, suit_stitched, air_fixed, game_over<br/><br/>    use_message = <span class="green">"You fiddle around with it but don't get anywhere."</span><br/>    standard_responses = {<br/>        4: <span class="green">"Air is running out! You can't take this lying down!"</span>,<br/>        6: <span class="green">"This is no time to sit around!"</span>,<br/>        7: <span class="green">"This is no time to sit around!"</span>,<br/>        32: <span class="green">"It shakes and rumbles, but nothing else happens."</span>,<br/>        34: <span class="green">"Ah! That's better. Now wash your hands."</span>,<br/>        35: <span class="green">"You wash your hands and shake the water off."</span>,<br/>        37: <span class="green">"The test tubes smoke slightly as you shake them."</span>,<br/>        54: <span class="green">"You chew the gum. It's sticky like glue."</span>,<br/>        55: <span class="green">"The yoyo bounces up and down, slightly slower than on Earth"</span>,<br/>        56: <span class="green">"It's a bit too fiddly. Can you thread it on something?"</span>,<br/>        59: <span class="green">"You need to fix the leak before you can use the canister"</span>,<br/>        61: <span class="green">"You try signalling with the mirror, but nobody can see you."</span>,<br/>        62: <span class="green">"Don't throw resources away. Things might come in handy..."</span>,<br/>        67: <span class="green">"To enjoy yummy space food, just add water!"</span>,<br/>        75: <span class="green">"You are at Sector: "</span> + <span class="purple">str</span>(current_room) + <span class="green">" // X: "</span> \<br/>            + <span class="purple">str</span>(player_x) + <span class="green">" // Y: "</span> + <span class="purple">str</span>(player_y)  <br/>        }<br/><br/>    <span class="red"># Get object number at player's location.</span><br/>    item_player_is_on = get_item_under_player()<br/>    <span class="orange">for</span> this_item <span class="orange">in</span> [item_player_is_on, item_carrying]:<br/>        <span class="orange">if</span> this_item <span class="orange">in</span> standard_responses:<br/>            use_message = standard_responses[this_item]<br/><br/>    <span class="orange">if</span> item_carrying == 70 <span class="orange">or</span> item_player_is_on == 70:<br/>        use_message = <span class="green">"Banging tunes!"</span><br/>        sounds.steelmusic.play(2)<br/><br/>    <span class="orange">elif</span> item_player_is_on == 11:<br/>        use_message = <span class="green">"AIR: "</span> + <span class="purple">str</span>(air) + \<br/>                      <span class="green">"% / ENERGY "</span> + <span class="purple">str</span>(energy) + <span class="green">"% / "</span><br/>        <span class="orange">if</span> <span class="orange">not</span> suit_stitched:<br/>            use_message += <span class="green">"*ALERT* SUIT FABRIC TORN / "</span><br/>        <span class="orange">if</span> <span class="orange">not</span> air_fixed:<br/>            use_message += <span class="green">"*ALERT* SUIT AIR BOTTLE MISSING"</span><br/>        <span class="orange">if</span> suit_stitched <span class="orange">and</span> air_fixed:<br/>            use_message += <span class="green">" SUIT OK"</span><br/>        show_text(use_message, 0)<br/>        sounds.say_status_report.play()<br/>        time.sleep(0.5)<br/>        <span class="red"># If "on" the computer, player intention is clearly status update.</span><br/>        <span class="red"># Return to stop another object use accidentally overriding this.</span><br/>        <span class="orange">return</span><br/><br/><span epub:type="pagebreak" id="page_236"/>    <span class="orange">elif</span> item_carrying == 60 <span class="orange">or</span> item_player_is_on == 60:<br/>        use_message = <span class="green">"You fix "</span> + objects[60][3] + <span class="green">" to the suit"</span><br/>        air_fixed = <span class="orange">True</span><br/>        air = 90<br/>        air_countdown()<br/>        remove_object(60)<br/><br/>    <span class="orange">elif</span> (item_carrying == 58 <span class="orange">or</span> item_player_is_on == 58) \<br/>       <span class="orange">and</span> <span class="orange">not</span> suit_stitched:<br/>        use_message = <span class="green">"You use "</span> + objects[56][3] + \<br/>                      <span class="green">" to repair the suit fabric"</span><br/>        suit_stitched = <span class="orange">True</span><br/>        remove_object(58)<br/><br/>    <span class="orange">elif</span> item_carrying == 72 <span class="orange">or</span> item_player_is_on == 72:<br/>        use_message = <span class="green">"You radio for help. A rescue ship is coming. \</span><br/><span class="green">Rendezvous Sector 13, outside."</span><br/>        props[40][0] = 13<br/><br/>    <span class="orange">elif</span> (item_carrying == 66 <span class="orange">or</span> item_player_is_on == 66) \<br/>            <span class="orange">and</span> current_room in outdoor_rooms:<br/>        use_message = <span class="green">"You dig..."</span><br/>        <span class="orange">if</span> (current_room == LANDER_SECTOR<br/>            <span class="orange">and</span> player_x == LANDER_X<br/>            <span class="orange">and</span> player_y == LANDER_Y):<br/>            add_object(71)<br/>            use_message = <span class="green">"You found the Poodle lander!"</span><br/><br/>    <span class="orange">elif</span> item_player_is_on == 40:<br/>        clock.unschedule(air_countdown)<br/>        show_text(<span class="green">"Congratulations, "</span>+ PLAYER_NAME +<span class="green">"!"</span>, 0)<br/>        show_text(<span class="green">"Mission success! You have made it to safety."</span>, 1)<br/>        game_over = <span class="orange">True</span><br/>        sounds.take_off.play()<br/>        game_completion_sequence()<br/><br/>    <span class="orange">elif</span> item_player_is_on == 16:<br/>        energy += 1<br/>        <span class="orange">if</span> energy &gt; 100:<br/>            energy = 100<br/>        use_message = <span class="green">"You munch the lettuce and get a little energy back"</span><br/>        draw_energy_air()        <br/><br/>    <span class="orange">elif</span> item_player_is_on == 42:<br/>        <span class="orange">if</span> current_room == 27:<br/>            open_door(26)<br/>        props[25][0] = 0 <span class="red"># Door from RM32 to engineering bay</span><br/>        props[26][0] = 0 <span class="red"># Door inside engineering bay</span><br/>        clock.schedule_unique(shut_engineering_door, 60)<br/>        use_message = <span class="green">"You press the button"</span><br/>        show_text(<span class="green">"Door to engineering bay is open for 60 seconds"</span>, 1)<br/>        sounds.say_doors_open.play()<br/>        sounds.doors.play()<br/><br/><span epub:type="pagebreak" id="page_237"/>    <span class="orange">elif</span> item_carrying == 68 <span class="orange">or</span> item_player_is_on == 68:<br/>        energy = 100<br/>        use_message = <span class="green">"You use the food to restore your energy"</span><br/>        remove_object(68)<br/>        draw_energy_air()<br/><br/>    <span class="orange">if</span> suit_stitched <span class="orange">and</span> air_fixed: <span class="red"># open airlock access</span><br/>        <span class="orange">if</span> current_room == 31 <span class="orange">and</span> props[20][0] == 31:<br/>            open_door(20) <span class="red"># which includes removing the door</span><br/>            sounds.say_airlock_open.play()<br/>            show_text(<span class="green">"The computer tells you the airlock is now open."</span>, 1)<br/>        <span class="orange">elif</span> props[20][0] == 31:<br/>            props[20][0] = 0 <span class="red"># remove door from map</span><br/>            sounds.say_airlock_open.play()<br/>            show_text(<span class="green">"The computer tells you the airlock is now open."</span>, 1)<br/><br/>    <span class="orange">for</span> recipe <span class="orange">in</span> RECIPES:<br/>        ingredient1 = recipe[0]<br/>        ingredient2 = recipe[1]<br/>        combination = recipe[2]<br/>        <span class="orange">if</span> (item_carrying == ingredient1<br/>            <span class="orange">and</span> item_player_is_on == ingredient2) \<br/>            <span class="orange">or</span> (item_carrying == ingredient2<br/>                <span class="orange">and</span> item_player_is_on == ingredient1):<br/>            use_message = <span class="green">"You combine "</span> + objects[ingredient1][3] \<br/>                          + <span class="green">" and "</span> + objects[ingredient2][3] \<br/>                          + <span class="green">" to make "</span> + objects[combination][3]<br/>            <span class="orange">if</span> item_player_is_on <span class="orange">in</span> props.keys():<br/>                props[item_player_is_on][0] = 0<br/>                room_map[player_y][player_x] = get_floor_type()<br/>            in_my_pockets.remove(item_carrying)<br/>            add_object(combination)<br/>            sounds.combine.play()<br/><br/>    <span class="red"># {key object number: door object number}</span><br/>    ACCESS_DICTIONARY = { 79:22, 80:23, 81:24 }<br/>    <span class="orange">if</span> item_carrying <span class="orange">in</span> ACCESS_DICTIONARY:<br/>        door_number = ACCESS_DICTIONARY[item_carrying]<br/>        <span class="orange">if</span> props[door_number][0] == current_room:<br/>            use_message = <span class="green">"You unlock the door!"</span><br/>            sounds.say_doors_open.play()<br/>            sounds.doors.play()<br/>            open_door(door_number)<br/><br/>    show_text(use_message, 0)<br/>    time.sleep(0.5)<br/><br/><span class="orange">def</span> <span class="blue">game_completion_sequence</span>():<br/>    <span class="orange">global</span> launch_frame <span class="red">#(initial value is 0, set up in VARIABLES section)</span><br/>    box = Rect((0, 150), (800, 600))<br/>    screen.draw.filled_rect(box, (128, 0, 0))<br/>    box = Rect ((0, top_left_y - 30), (800, 390))<br/>    screen.surface.set_clip(box)<br/><span epub:type="pagebreak" id="page_238"/>    <span class="orange">for</span> y <span class="orange">in</span> <span class="purple">range</span>(0, 13):<br/>        <span class="orange">for</span> x <span class="orange">in</span> <span class="purple">range</span>(0, 13):<br/>            draw_image(images.soil, y, x)<br/><br/>    launch_frame += 1<br/>    <span class="orange">if</span> launch_frame &lt; 9:<br/>        draw_image(images.rescue_ship, 8 - launch_frame, 6)<br/>        draw_shadow(images.rescue_ship_shadow, 8 + launch_frame, 6)<br/>        clock.schedule(game_completion_sequence, 0.25)<br/>    <span class="orange">else</span>:<br/>        screen.surface.set_clip(<span class="orange">None</span>)<br/>        screen.draw.text(<span class="green">"MISSION"</span>, (200, 380), color = <span class="green">"white"</span>,<br/>                     fontsize = 128, shadow = (1, 1), scolor = <span class="green">"black"</span>)<br/>        screen.draw.text(<span class="green">"COMPLETE"</span>, (145, 480), color = <span class="green">"white"</span>,<br/>                     fontsize = 128, shadow = (1, 1), scolor = <span class="green">"black"</span>)<br/>        sounds.completion.play()<br/>        sounds.say_mission_complete.play()<br/><br/><br/><span class="red">###############</span><br/><span class="red">##   DOORS   ##</span><br/><span class="red">###############</span><br/><br/><span class="orange">def</span> <span class="blue">open_door</span>(opening_door_number):<br/>    <span class="orange">global</span> door_frames, door_shadow_frames<br/>    <span class="orange">global</span> door_frame_number, door_object_number<br/>    door_frames = [images.door1, images.door2, images.door3,<br/>                   images.door4, images.floor]<br/>    <span class="red"># (Final frame restores shadow ready for when door reappears).</span><br/>    door_shadow_frames = [images.door1_shadow, images.door2_shadow,<br/>                          images.door3_shadow, images.door4_shadow,<br/>                          images.door_shadow]<br/>    door_frame_number = 0<br/>    door_object_number = opening_door_number<br/>    do_door_animation()<br/><br/><span class="orange">def</span> <span class="blue">close_door</span>(closing_door_number):<br/>    <span class="orange">global</span> door_frames, door_shadow_frames<br/>    <span class="orange">global</span> door_frame_number, door_object_number, player_y<br/>    door_frames = [images.door4, images.door3, images.door2,<br/>                   images.door1, images.door]<br/>    door_shadow_frames = [images.door4_shadow, images.door3_shadow,<br/>                          images.door2_shadow, images.door1_shadow,<br/>                          images.door_shadow]<br/>    door_frame_number = 0<br/>    door_object_number = closing_door_number<br/>    <span class="red"># If player is in same row as a door, they must be in open doorway</span><br/>    <span class="orange">if</span> player_y == props[door_object_number][1]:<br/>        <span class="orange">if</span> player_y == 0: <span class="red"># if in the top doorway</span><br/>            player_y = 1 <span class="red"># move them down</span><br/>        <span class="orange">else</span>:<br/>            player_y = room_height - 2 <span class="red"># move them up</span><br/>    do_door_animation()<br/><br/><span epub:type="pagebreak" id="page_239"/><span class="orange">def</span> <span class="blue">do_door_animation</span>():<br/>    <span class="orange">global</span> door_frames, door_frame_number, door_object_number, objects<br/>    objects[door_object_number][0] = door_frames[door_frame_number]<br/>    objects[door_object_number][1] = door_shadow_frames[door_frame_number]<br/>    door_frame_number += 1<br/>    <span class="orange">if</span> door_frame_number == 5:<br/>        <span class="orange">if</span> door_frames[-1] == images.floor:<br/>            props[door_object_number][0] = 0 <span class="red"># remove door from props list</span><br/>        <span class="red"># Regenerate room map from the props</span><br/>        <span class="red"># to put the door in the room if required.</span><br/>        generate_map()<br/>    <span class="orange">else</span>:<br/>        clock.schedule(do_door_animation, 0.15)<br/><br/><span class="orange">def</span> <span class="blue">shut_engineering_door</span>():<br/>    <span class="orange">global</span> current_room, door_room_number, props<br/>    props[25][0] = 32 <span class="red"># Door from room 32 to the engineering bay.</span><br/>    props[26][0] = 27 <span class="red"># Door inside engineering bay.</span><br/>    generate_map() <span class="red"># Add door to room_map for if in affected room.</span><br/>    <span class="orange">if</span> current_room == 27:<br/>        close_door(26)<br/>    <span class="orange">if</span> current_room == 32:<br/>        close_door(25)<br/>    show_text(<span class="green">"The computer tells you the doors are closed."</span>, 1)<br/>    sounds.say_doors_closed.play()<br/><br/><span class="orange">def</span> <span class="blue">door_in_room_26</span>():<br/>    <span class="orange">global</span> airlock_door_frame, room_map<br/>    frames = [images.door, images.door1, images.door2,<br/>              images.door3,images.door4, images.floor<br/>              ]<br/><br/>    shadow_frames = [images.door_shadow, images.door1_shadow,<br/>                     images.door2_shadow, images.door3_shadow,<br/>                     images.door4_shadow, <span class="orange">None</span>]<br/><br/>    <span class="orange">if</span> current_room != 26:<br/>        clock.unschedule(door_in_room_26)<br/>        <span class="orange">return</span><br/><br/>    <span class="red"># prop 21 is the door in Room 26.</span><br/>    <span class="orange">if</span> ((player_y == 8 <span class="orange">and</span> player_x == 2) <span class="orange">or</span> props[63] == [26, 8, 2]) \<br/>            <span class="orange">and</span> props[21][0] == 26:<br/>        airlock_door_frame += 1<br/>        <span class="orange">if</span> airlock_door_frame == 5:<br/>            props[21][0] = 0 <span class="red"># Remove door from map when fully open.</span><br/>            room_map[0][1] = 0<br/>            room_map[0][2] = 0<br/>            room_map[0][3] = 0<br/><br/><span epub:type="pagebreak" id="page_240"/>    <span class="orange">if</span> ((player_y != 8 <span class="orange">or</span> player_x != 2) <span class="orange">and</span> props[63] != [26, 8, 2]) \<br/>            <span class="orange">and</span> airlock_door_frame &gt; 0:<br/>        <span class="orange">if</span> airlock_door_frame == 5:<br/>            <span class="red"># Add door to props and map so animation is shown.</span><br/>            props[21][0] = 26<br/>            room_map[0][1] = 21<br/>            room_map[0][2] = 255<br/>            room_map[0][3] = 255<br/>        airlock_door_frame -= 1<br/><br/>    objects[21][0] = frames[airlock_door_frame]<br/>    objects[21][1] = shadow_frames[airlock_door_frame]<br/><br/><br/><span class="red">###############</span><br/><span class="red">##    AIR    ##</span><br/><span class="red">###############</span><br/><br/><span class="orange">def</span> <span class="blue">draw_energy_air</span>():<br/>    box = Rect((20, 765), (350, 20))<br/>    screen.draw.filled_rect(box, BLACK)<br/>    screen.draw.text(<span class="green">"AIR"</span>, (20, 766), color=BLUE)<br/>    screen.draw.text(<span class="green">"ENERGY"</span>, (180, 766), color=YELLOW)<br/><br/>    <span class="orange">if</span> air &gt; 0:<br/>        box = Rect((50, 765), (air, 20))<br/>        screen.draw.filled_rect(box, BLUE) <span class="red"># Draw new air bar.</span><br/><br/>    <span class="orange">if</span> energy &gt; 0:<br/>        box = Rect((250, 765), (energy, 20))<br/>        screen.draw.filled_rect(box, YELLOW) <span class="red"># Draw new energy bar.</span><br/><br/><span class="orange">def</span> <span class="blue">end_the_game</span>(reason):<br/>    <span class="orange">global</span> game_over<br/>    show_text(reason, 1)<br/>    game_over = <span class="orange">True</span><br/>    sounds.say_mission_fail.play()<br/>    sounds.gameover.play()<br/>    screen.draw.text(<span class="green">"GAME OVER"</span>, (120, 400), color = <span class="green">"white"</span>,<br/>                     fontsize = 128, shadow = (1, 1), scolor = <span class="green">"black"</span>)<br/>    <br/><br/><span class="orange">def</span> <span class="blue">air_countdown</span>():<br/>    <span class="orange">global</span> air, game_over<br/>    <span class="orange">if</span> game_over:<br/>        <span class="orange">return</span> <span class="red"># Don't sap air when they're already dead.</span><br/>    air -= 1<br/>    <span class="orange">if</span> air == 20:<br/>        sounds.say_air_low.play()<br/>    <span class="orange">if</span> air == 10:<br/>        sounds.say_act_now.play()<br/>    draw_energy_air()<br/>    <span class="orange">if</span> air &lt; 1:<br/>        end_the_game(<span class="green">"You're out of air!"</span>)<br/><br/><span epub:type="pagebreak" id="page_241"/><span class="orange">def</span> <span class="blue">alarm</span>():<br/>    show_text(<span class="green">"Air is running out, "</span> + PLAYER_NAME<br/>              + <span class="green">"! Get to safety, then radio for help!"</span>, 1)<br/>    sounds.alarm.play(3)<br/>    sounds.say_breach.play()    <br/><br/><br/><span class="red">###############</span><br/><span class="red">##  HAZARDS  ##</span><br/><span class="red">###############</span><br/><br/>hazard_data = {<br/>    <span class="red"># room number: [[y, x, direction, bounce addition to direction]]</span><br/>    28: [[1, 8, 2, 1], [7, 3, 4, 1]], 32: [[1, 5, 4, -1]],<br/>    34: [[5, 1, 1, 1], [5, 5, 1, 2]], 35: [[4, 4, 1, 2], [2, 5, 2, 2]],<br/>    36: [[2, 1, 2, 2]], 38: [[1, 4, 3, 2], [5, 8, 1, 2]],<br/>    40: [[3, 1, 3, -1], [6, 5, 2, 2], [7, 5, 4, 2]],<br/>    41: [[4, 5, 2, 2], [6, 3, 4, 2], [8, 1, 2, 2]],<br/>    42: [[2, 1, 2, 2], [4, 3, 2, 2], [6, 5, 2, 2]],<br/>    46: [[2, 1, 2, 2]],<br/>    48: [[1, 8, 3, 2], [8, 8, 1, 2], [3, 9, 3, 2]]<br/>    }<br/><br/><span class="orange">def</span> <span class="blue">deplete_energy</span>(penalty):<br/>    <span class="orange">global</span> energy, game_over<br/>    <span class="orange">if</span> game_over:<br/>        <span class="orange">return</span> <span class="red"># Don't sap energy when they're already dead.</span><br/>    energy = energy - penalty<br/>    draw_energy_air()<br/>    <span class="orange">if</span> energy &lt; 1:<br/>        end_the_game(<span class="green">"You're out of energy!"</span>)<br/><br/><span class="orange">def</span> <span class="blue">hazard_start</span>():<br/>    <span class="orange">global</span> current_room_hazards_list, hazard_map<br/>    <span class="orange">if</span> current_room <span class="orange">in</span> hazard_data.keys():<br/>        current_room_hazards_list = hazard_data[current_room]<br/>        <span class="orange">for</span> hazard <span class="orange">in</span> current_room_hazards_list:<br/>            hazard_y = hazard[0]<br/>            hazard_x = hazard[1]<br/>            hazard_map[hazard_y][hazard_x] = 49 + (current_room % 3)<br/>        clock.schedule_interval(hazard_move, 0.15)<br/><br/><span class="orange">def</span> <span class="blue">hazard_move</span>():<br/>    <span class="orange">global</span> current_room_hazards_list, hazard_data, hazard_map<br/>    <span class="orange">global</span> old_player_x, old_player_y<br/><br/>    <span class="orange">if</span> game_over:<br/>        <span class="orange">return</span><br/><br/>    <span class="orange">for</span> hazard <span class="orange">in</span> current_room_hazards_list:<br/>        hazard_y = hazard[0]<br/>        hazard_x = hazard[1]<br/>        hazard_direction = hazard[2]<br/><span epub:type="pagebreak" id="page_242"/>        old_hazard_x = hazard_x<br/>        old_hazard_y = hazard_y<br/>        hazard_map[old_hazard_y][old_hazard_x] = 0<br/><br/>        <span class="orange">if</span> hazard_direction == 1: <span class="red"># up</span><br/>            hazard_y -= 1<br/>        <span class="orange">if</span> hazard_direction == 2: <span class="red"># right</span><br/>            hazard_x += 1<br/>        <span class="orange">if</span> hazard_direction == 3: <span class="red"># down</span><br/>            hazard_y += 1<br/>        <span class="orange">if</span> hazard_direction == 4: <span class="red"># left</span><br/>            hazard_x -= 1<br/><br/>        hazard_should_bounce = <span class="orange">False</span><br/><br/>        <span class="orange">if</span> (hazard_y == player_y <span class="orange">and</span> hazard_x == player_x) <span class="orange">or</span> \<br/>           (hazard_y == from_player_y <span class="orange">and</span> hazard_x == from_player_x<br/>            <span class="orange">and</span> player_frame &gt; 0):<br/>            sounds.ouch.play()<br/>            deplete_energy(10)<br/>            hazard_should_bounce = <span class="orange">True</span><br/><br/>        <span class="red"># Stop hazard going out of the doors</span><br/>        <span class="orange">if</span> hazard_x == room_width:<br/>            hazard_should_bounce = <span class="orange">True</span><br/>            hazard_x = room_width - 1<br/>        <span class="orange">if</span> hazard_x == -1:<br/>            hazard_should_bounce = <span class="orange">True</span><br/>            hazard_x = 0<br/>        <span class="orange">if</span> hazard_y == room_height:<br/>            hazard_should_bounce = <span class="orange">True</span><br/>            hazard_y = room_height - 1<br/>        <span class="orange">if</span> hazard_y == -1:<br/>            hazard_should_bounce = <span class="orange">True</span><br/>            hazard_y = 0<br/><br/>        <span class="red"># Stop when hazard hits scenery or another hazard.</span><br/>        <span class="orange">if</span> room_map[hazard_y][hazard_x] <span class="orange">not</span> <span class="orange">in</span> items_player_may_stand_on \<br/>               <span class="orange">or</span> hazard_map[hazard_y][hazard_x] != 0:<br/>            hazard_should_bounce = <span class="orange">True</span><br/><br/>        <span class="orange">if</span> hazard_should_bounce:<br/>            hazard_y = old_hazard_y <span class="red"># Move back to last valid position.</span><br/>            hazard_x = old_hazard_x<br/>            hazard_direction += hazard[3]<br/>            <span class="orange">if</span> hazard_direction &gt; 4:<br/>                hazard_direction -= 4<br/>            <span class="orange">if</span> hazard_direction &lt; 1:<br/>                hazard_direction += 4<br/>            hazard[2] = hazard_direction<br/><br/>        hazard_map[hazard_y][hazard_x] = 49 + (current_room % 3)<br/>        hazard[0] = hazard_y<br/>        hazard[1] = hazard_x<br/><br/><br/><span epub:type="pagebreak" id="page_243"/><span class="red">###############</span><br/><span class="red">##   START   ##</span><br/><span class="red">###############</span><br/><br/>clock.schedule_interval(game_loop, 0.03)<br/>generate_map()<br/>clock.schedule_interval(adjust_wall_transparency, 0.05)<br/>clock.schedule_unique(display_inventory, 1)<br/>clock.schedule_unique(draw_energy_air, 0.5)<br/>clock.schedule_unique(alarm, 10)<br/><span class="red"># A higher number below gives a longer time limit.</span><br/>clock.schedule_interval(air_countdown, 5)<br/>sounds.mission.play() <span class="red"># Intro music</span><span epub:type="pagebreak" id="page_244"/></p>
</body></html>