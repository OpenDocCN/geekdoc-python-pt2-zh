<html><head></head><body>
<h2 class="h2" id="ch06"><span epub:type="pagebreak" id="page_97"/><strong><span class="blue"><span class="big">6</span></span><br/>INSTALLING THE SPACE STATION EQUIPMENT</strong></h2>
<div class="image1"><img src="../images/common01.jpg" alt="image"/></div>
<p class="noindent">In <a href="ch05.xhtml#ch05">Chapter 5</a>, you prepared information about all the equipment you’ll use on your mission. In this chapter, you’ll install some of that equipment in the space station and use the <em>Explorer</em> to view any room or planet surface location. This is your first chance to explore the design of the Mars base that will become your home.</p>
<h3 class="h3" id="lev85"><strong>UNDERSTANDING THE DICTIONARY FOR THE SCENERY DATA</strong></h3>
<p class="noindent">There are two different types of objects on the space station:</p>
<ul>
<li class="noindent"><strong>Scenery</strong> is the equipment that stays in the same place throughout the <em>Escape</em> game and includes furniture, pipes, and electronic equipment.</li>
<li class="noindent"><span epub:type="pagebreak" id="page_98"/><strong>Props</strong> are items that can appear, disappear, or move around during the game. They include things the player can create and pick up. Props also include doors, which appear in the room when they’re closed and disappear when they’re open.</li>
</ul>
<p class="indent">The data for positioning scenery and the data for props are stored separately and organized differently. In this chapter, we’ll just add the scenery data.</p>
<p class="indent">Our program already knows the image and description to use for all the objects in the game, because they’re in the <span class="literal">objects</span> dictionary you created in <a href="ch05.xhtml#ch05">Chapter 5</a>. Now we’ll tell the program where to put the scenery objects in the space station. To do that, we’ll create a new dictionary called <span class="literal">scenery</span>. This is how we’ll structure the entry for one room:</p>
<p class="programs"><span class="codeitalic1">room number</span>: [<span class="red">[</span><span class="red">object number,</span> <span class="red">y</span><span class="red">,</span> <span class="red">x</span><span class="red">]</span>, <span class="green">[</span><span class="green">object number</span><span class="green">,</span> <span class="green">y</span><span class="green">,</span> <span class="green">x</span><span class="green">]</span>]</p>
<p class="indent">The key for the dictionary will be the room number. For each room number, the dictionary stores a list, with a square bracket at the start and the end of it. Each item in that list is another list that tells the program where in the room to put <em>one</em> object. Here, I’ve made one object red and the other green so you can see where they start and end.</p>
<p class="indentb">These are the three pieces of information you need for each object:</p>
<p class="hang"><strong>The object number</strong> This is the same as the number that is used as the key in the <span class="literal">objects</span> dictionary. For example, number 5 represents a table.</p>
<p class="hang"><strong>The object’s <em>y</em> position</strong> This is the object’s position in the room, from back to front. The back wall is usually in row 0, so we typically start placing objects at 1. The largest useful number will be the room height minus 2: we subtract 1 because the map positions start at 0 and subtract another 1 for the space the front wall occupies. In practice, it’s a good idea to leave a bit more space at the front of the room, because the front wall can obscure other items. You can check the size of the room in the <span class="literal">GAME_MAP</span> code you added in <a href="ch04.xhtml#ch04">Chapter 4</a>.</p>
<p class="hang"><strong>The object’s <em>x</em> position</strong> This tells the program how far across the room from left to right the object should be. Again, a wall is usually in position 0. The largest useful number will generally be the room width minus 2.</p>
<p class="indentt">To get a better understanding of these numbers, let’s take a look at <a href="ch06.xhtml#ch06fig1">Figure 6-1</a>, which shows one of the rooms on the space station as a screenshot and a map. In this image, the sink (S) is in the second row from the back, so its <em>y</em> position is 1. Remember that the wall in the first row at the back is in position <em>y</em> = 0. The sink’s <em>x</em> position is 3. There are two other tile spaces to the left of it, and the wall is in position <em>x</em> = 0.</p>
<div class="image"><span epub:type="pagebreak" id="page_99"/><a id="ch06fig1"/><img src="../images/fig6-1.jpg" alt="image"/></div>
<p class="figcap"><em>Figure 6-1: An example space station room as seen in the game (left) and represented by a map (right). T = toilet, S = sink, P = player.</em></p>
<p class="indent">Let’s look at the data for this room. Don’t enter this code yet. I’ll give you all the scenery data shortly.</p>
<p class="programs">scenery = {<br/>--<span class="codeitalic1">snip</span>--<br/>30: [[34,1,1], [35,1,3]],<br/>--<span class="codeitalic1">snip</span>--<br/>}</p>
<p class="indent">This code tells the program about the objects in room 30. Room 30 has object number 34, a toilet, in the top-left corner at position <em>y</em> = 1 and <em>x</em> = 1, and object number 35, a sink, at position number <em>y</em> = 1 and <em>x</em> = 3, quite close to the toilet.</p>
<p class="indent">You can have the same object in the room several times by adding a list for each position and using the same object number for them. For example, you could fill the room with toilets in different positions if you wanted to, although that would be a rather bizarre thing to do.</p>
<p class="indent">You don’t need to include the walls in the scenery data, because the program automatically adds them to the room when it creates the <span class="literal">room_map</span> list, as you’ve already seen.</p>
<p class="indent">Even though putting the information for each item into a list means adding more brackets, it’s much easier to understand the data at a glance. The brackets help you see how many items are in the room, which numbers are the object numbers, and which are the position numbers.</p>
<h3 class="h3" id="lev86"><strong>ADDING THE SCENERY DATA</strong></h3>
<p class="noindent">Open <em>listing5-8.py</em>, the final listing in <a href="ch05.xhtml#ch05">Chapter 5</a>. This listing contains your game map and objects data. Now we’ll add the scenery data to it.</p>
<p class="indent"><a href="ch06.xhtml#ch06list1">Listing 6-1</a> shows the scenery data. Add this new <span class="literal">SCENERY</span> section before the <span class="literal">MAKE MAP</span> section. Make sure the placement of the brackets and commas is correct. Remember that each piece of scenery needs a list of three numbers, <span epub:type="pagebreak" id="page_100"/>and each list is separated with a comma too. If you prefer not to type all the data in, use the file <em>data-chapter6.py</em>, which is in the <em>listings</em> folder. It contains the scenery dictionary for you to copy and paste into your program.</p>
<p class="margin"><em>listing6-1.py</em></p>
<p class="programs">   <span class="gray">--<span class="codeitalic1">snip</span>--</span><br/><br/>   <span class="gray">items_player_may_stand_on = items_player_may_carry + [0, 39, 2, 48]</span><br/><br/>   <span class="red">###############</span><br/>   <span class="red">##  SCENERY  ##</span><br/>   <span class="red">###############</span><br/><br/>   <span class="red"># Scenery describes objects that cannot move between rooms.</span><br/>   <span class="red"># room number: [[object number, y position, x position]...]</span><br/>   scenery = {<br/>       26: [[39,8,2]],<br/>       27: [[33,5,5], [33,1,1], [33,1,8], [47,5,2],<br/>            [47,3,10], [47,9,8], [42,1,6]],<br/>       28: [[27,0,3], [41,4,3], [41,4,7]],<br/>       29: [[7,2,6], [6,2,8], [12,1,13], [44,0,1],<br/>            [36,4,10], [10,1,1], [19,4,2], [17,4,4]],<br/>       30: [[34,1,1], [35,1,3]],<br/>       31: [[11,1,1], [19,1,8], [46,1,3]],<br/>       32: [[48,2,2], [48,2,3], [48,2,4], [48,3,2], [48,3,3],<br/>            [48,3,4], [48,4,2], [48,4,3], [48,4,4]],<br/>       33: [[13,1,1], [13,1,3], [13,1,8], [13,1,10], [48,2,1],<br/>            [48,2,7], [48,3,6], [48,3,3]],<br/>       34: [[37,2,2], [32,6,7], [37,10,4], [28,5,3]],<br/>       35: [[16,2,9], [16,2,2], [16,3,3], [16,3,8], [16,8,9], [16,8,2], [16,1,8],<br/>            [16,1,3], [12,8,6], [12,9,4], [12,9,8],<br/>            [15,4,6], [12,7,1], [12,7,11]],<br/>       36: [[4,3,1], [9,1,7], [8,1,8], [8,1,9],<br/>            [5,5,4], [6,5,7], [10,1,1], [12,1,2]],<br/>       37: [[48,3,1], [48,3,2], [48,7,1], [48,5,2], [48,5,3],<br/>            [48,7,2], [48,9,2], [48,9,3], [48,11,1], [48,11,2]],<br/>       38: [[43,0,2], [6,2,2], [6,3,5], [6,4,7], [6,2,9], [45,1,10]],<br/>       39: [[38,1,1], [7,3,4], [7,6,4], [5,3,6], [5,6,6],<br/>            [6,3,9], [6,6,9], [45,1,11], [12,1,8], [12,1,4]],<br/>       40: [[41,5,3], [41,5,7], [41,9,3], [41,9,7],<br/>            [13,1,1], [13,1,3], [42,1,12]],<br/>       41: [[4,3,1], [10,3,5], [4,5,1], [10,5,5], [4,7,1],<br/>            [10,7,5], [12,1,1], [12,1,5]],<br/>       44: [[46,4,3], [46,4,5], [18,1,1], [19,1,3],<br/>            [19,1,5], [52,4,7], [14,1,8]],<br/>       45: [[48,2,1], [48,2,2], [48,3,3], [48,3,4], [48,1,4], [48,1,1]],<br/>       46: [[10,1,1], [4,1,2], [8,1,7], [9,1,8], [8,1,9], [5,4,3], [7,3,2]],<br/>       47: [[9,1,1], [9,1,2], [10,1,3], [12,1,7], [5,4,4], [6,4,7], [4,1,8]],<br/>       48: [[17,4,1], [17,4,2], [17,4,3], [17,4,4], [17,4,5], [17,4,6], [17,4,7],<br/>            [17,8,1], [17,8,2], [17,8,3], [17,8,4],<br/>            [17,8,5], [17,8,6], [17,8,7], [14,1,1]],<br/>       49: [[14,2,2], [14,2,4], [7,5,1], [5,5,3], [48,3,3], [48,3,4]],<br/>       50: [[45,4,8], [11,1,1], [13,1,8], [33,2,1], [46,4,6]]<br/>       }<br/>   <span epub:type="pagebreak" id="page_101"/>checksum = 0<br/>   check_counter = 0<br/>   <span class="orange">for</span> key, room_scenery_list <span class="orange">in</span> scenery.items():<br/>       <span class="orange">for</span> scenery_item_list <span class="orange">in</span> room_scenery_list:<br/><span class="ent">➊</span>         checksum += (scenery_item_list[0] * key<br/>                        + scenery_item_list[1] * (key + 1)<br/>                        + scenery_item_list[2] * (key + 2))<br/>           check_counter += 1<br/>   <span class="purple">print</span>(check_counter, <span class="green">"scenery items"</span>)<br/><span class="ent">➋</span> <span class="orange">assert</span> check_counter == 161, <span class="green">"Expected 161 scenery items"</span><br/><span class="ent">➌</span> <span class="orange">assert</span> checksum == 200095, <span class="green">"Error in scenery data"</span><br/>   <span class="purple">print</span>(<span class="green">"Scenery checksum: "</span> + <span class="purple">str</span>(checksum))<br/><br/>   <span class="gray">###############</span><br/>   <span class="gray">## MAKE MAP  ##</span><br/>   <span class="gray">###############</span><br/>   <span class="gray">--<span class="codeitalic1">snip</span>--</span></p>
<p class="listing" id="ch06list1"><em>Listing 6-1: Adding the scenery data</em></p>
<p class="indent">Save your listing as <em>listing6-1.py</em>, and run it using <span class="codestrong">pgzrun listing6-1.py</span> in the command line. We’ve added some data, but we haven’t told the program to do anything with it, so you won’t see any change. But if you made a mistake entering the data, the program should stop and display the message <span class="literal">Error in</span> <span class="literal">scenery data</span>. In this case, go back and double-check your code against the book. Check that you entered the checksum number correctly first! <span class="ent">➌</span></p>
<p class="indent">The second half of this listing is a safety measure, called a <em>checksum</em>. It checks that all the data is present and correct by making a calculation involving the data and then checking the result against the correct answer. If there’s a mistake in the data you’ve entered, this bit of code will stop the program until you fix it. This stops your game from running with bugs in it. (Some errors could get through, but this code catches most mistakes.)</p>
<p class="indent">The program uses the <span class="literal">assert</span> instruction to check the data. The first instruction checks that the program has the right number of data items. If it doesn’t, the program stops and shows an error message <span class="ent">➋</span>. The program also checks whether the checksum (the result from the calculation) is the expected number, and if it isn’t, it stops the program <span class="ent">➌</span>. Notice that one of the instructions in <a href="ch06.xhtml#ch06list1">Listing 6-1</a> spreads across three lines <span class="ent">➊</span>: Python knows we haven’t finished the instruction until we close the final parenthesis.</p>
<div class="sidebar1">
<p class="sidebart"><strong>TIP</strong></p>
<p class="spara">If you want to change the scenery data, to redesign rooms or to add your own rooms, you will need to turn off the checksum. This is because the calculation based on your changed data will be different, so the checksum will fail and the program won’t run. You can simply put a <span class="literal">#</span> symbol before the two lines that start with <span class="literal">assert</span> <span class="ent">➋</span><span class="ent">➌</span> to switch them off. As you know, the <span class="literal">#</span> symbol is used for a comment, and Python ignores everything after it on the same line. It can be a handy off switch when you’re building or testing programs.</p>
</div>
<h3 class="h3" id="lev87"><span epub:type="pagebreak" id="page_102"/><strong>ADDING THE PERIMETER FENCE FOR THE PLANET SURFACE</strong></h3>
<p class="noindent">You might have noticed that we haven’t added any scenery for rooms 1 to 25 yet. Our data starts at room 26. As you might remember, the first 25 locations are outside on the planet surface. For simplicity, we’ll still call them rooms, although they have no walls.</p>
<p class="indent"><a href="ch06.xhtml#ch06fig2">Figure 6-2</a> shows rooms 1 to 25 on the map. A fence, shown as a dotted line in <a href="ch06.xhtml#ch06fig2">Figure 6-2</a>, surrounds the outside of these rooms. The fence stops people from wandering out of the compound and off the game map.</p>
<div class="image"><a id="ch06fig2"/><img src="../images/fig6-2.jpg" alt="image"/></div>
<p class="figcap"><em>Figure 6-2: Adding the fence around the planet surface locations</em></p>
<p class="indent">We need to add fences at the following locations:</p>
<ul>
<li class="noindent">On the left in rooms 1, 6, 11, 16, and 21</li>
<li class="noindent">At the top in rooms 1, 2, 3, 4, and 5</li>
<li class="noindent">On the right in rooms 5, 10, 15, 20, 25</li>
</ul>
<p class="indent">Each outside room has one item of planet surface scenery too, which is randomly chosen from a small selection of suitable items that includes rocks, shrubs, and craters. For the game, it doesn’t matter where these items are placed, so they can also be randomly positioned.</p>
<p class="indent"><a href="ch06.xhtml#ch06list2">Listing 6-2</a> shows the code that generates the random planet surface scenery and adds the fences. Add the code to the end of the <span class="literal">SCENERY</span> section you just created, and save your program as <em>listing6-2.py</em>. You can use <span class="codestrong">pgzrun listing6-2.py</span> to check whether the program reports any errors.</p>
<p class="margin"><em>listing6-2.py</em></p>
<p class="programs">   <span class="gray">--<span class="codeitalic1">snip</span>--</span><br/>   <span class="gray">print("Scenery checksum: " + str(checksum))</span><br/><br/>   <span class="orange">for</span> room <span class="orange">in</span> <span class="purple">range</span>(1, 26): <span class="red"># Add random scenery in planet locations.</span><br/><span class="ent">➊</span>     <span class="orange">if</span> room != 13: <span class="red"># Skip room 13.</span><br/><span class="ent">➋</span>         scenery_item = random.choice([16, 28, 29, 30])<br/><span class="ent">➌</span>         scenery[room] = [[scenery_item, random.randint(2, 10),<br/>                             random.randint(2, 10)]]<br/><br/>   <span class="red"># Use loops to add fences to the planet surface rooms.</span><br/><span class="ent">➍</span> <span class="orange">for</span> room_coordinate <span class="orange">in</span> <span class="purple">range</span>(0, 13):<br/><span class="ent">➎</span>     <span class="orange">for</span> room_number <span class="orange">in</span> [1, 2, 3, 4, 5]: <span class="red"># Add top fence</span><br/><span class="ent">➏</span>         scenery[room_number] += [[31, 0, room_coordinate]]<br/><span class="ent">➐</span>     <span class="orange">for</span> room_number <span class="orange">in</span> [1, 6, 11, 16, 21]: <span class="red"># Add left fence</span><br/><span class="ent">➑</span>         scenery[room_number] += [[31, room_coordinate, 0]]<br/>       <span class="orange">for</span> room_number <span class="orange">in</span> [5, 10, 15, 20, 25]: <span class="red"># Add right fence</span><br/><span class="ent">➒</span>         scenery[room_number] += [[31, room_coordinate, 12]]<br/><br/><span class="ent">➓</span> <span class="orange">del</span> scenery[21][-1] <span class="red"># Delete last fence panel in Room 21</span><br/>   <span class="orange">del</span> scenery[25][-1] <span class="red"># Delete last fence panel in Room 25</span><br/><br/><span epub:type="pagebreak" id="page_103"/>   <span class="gray">###############</span><br/>   <span class="gray">## MAKE MAP  ##</span><br/>   <span class="gray">###############</span><br/><br/>   <span class="gray">--<span class="codeitalic1">snip</span>--</span></p>
<p class="listing" id="ch06list2"><em>Listing 6-2: Generating random planet surface scenery</em></p>
<p class="indent">You don’t need to understand this code to enjoy building and playing <em>Escape</em>, but if you want to dig deeper, I’ll explain the code in more detail.</p>
<p class="indent">The first section in <a href="ch06.xhtml#ch06list2">Listing 6-2</a> adds the random scenery. For each room, <span class="literal">random.choice()</span> <span class="ent">➋</span> chooses a scenery item randomly. In the same way that <span class="literal">random.randint()</span> gave us a random number (like rolling dice), <span class="literal">random.choice()</span> gives us a random item (like a grab bag or lucky dip game). The item is chosen from the list <span class="literal">[16, 28, 29, 30]</span>. Those object numbers represent a shrub, a large rock, a small rock, and a crater, respectively.</p>
<p class="indent">We also add a new entry to the <span class="literal">scenery</span> dictionary for the room <span class="ent">➌</span>. This entry contains the random scenery item and random <em>y</em> and <em>x</em> positions for that item. The <em>y</em> and <em>x</em> positions place the item inside the room but not too near the edge.</p>
<p class="indent">The <span class="literal">!=</span> operator <span class="ent">➊</span> means “not equal to,” so scenery is added only if the room number is <em>not</em> 13. Who knows? Maybe it’ll be useful to have an empty space on the planet surface when you’re on your mission…</p>
<p class="indent">In the second part of <a href="ch06.xhtml#ch06list2">Listing 6-2</a>, we add the fences. All the planet surface locations are 13 tiles high and 13 tiles wide, so we can use one loop <span class="ent">➍</span> to add the top and side fences. The loop’s variable, <span class="literal">room_coordinate</span>, counts from 0 to 12, and each time around the loop, fence panels are put in place at the top and the sides of the appropriate rooms.</p>
<p class="indent">Inside the <span class="literal">room_coordinate</span> loop, there are three loops for the <span class="literal">room_number</span>. The first <span class="literal">room_number</span> loop <span class="ent">➎</span> adds a fence along the top row of the top rooms. Instead of using a <span class="literal">range()</span>, this time we’re looping through a list. Each time through the list, the variable <span class="literal">room_number</span> takes the next number from the list <span class="literal">[1, 2, 3, 4, 5]</span>. We add a piece of scenery to the scenery list for the room, using <span class="literal">+=</span> <span class="ent">➏</span>. This is scenery item 31 (a fence), in the top row of the room (at position <em>y</em> = 0). The <span class="literal">room_coordinate</span> value is used for the <em>x</em> position. This puts the top fence into rooms 1 to 5, in the top row of those rooms.</p>
<p class="indent">There are two other <span class="literal">room_number</span> loops inside the <span class="literal">room_coordinate</span> loop. The first one adds the left fence to rooms <span class="literal">1</span>, <span class="literal">6</span>, <span class="literal">11</span>, <span class="literal">16</span>, and <span class="literal">21</span> <span class="ent">➐</span>. This time, the program uses the <span class="literal">room_coordinate</span> variable for the <em>y</em> position and uses <span class="literal">0</span> for the <em>x</em> position <span class="ent">➑</span>. This puts fence panels along the left edge of those rooms. The second loop adds the right edge fence to rooms <span class="literal">5</span>, <span class="literal">10</span>, <span class="literal">15</span>, <span class="literal">20</span>, and <span class="literal">25</span>. This also uses the <span class="literal">room_coordinate</span> for the <em>y</em> position of the fence panel but uses <span class="literal">12</span> for the <em>x</em> coordinate, putting a fence along the right edge of those rooms <span class="ent">➒</span>.</p>
<p class="indent">We don’t want side fence panels where the outside area joins the space station wall. <a href="ch06.xhtml#ch06fig3">Figure 6-3</a> shows a map of room 21. The bottom-left corner of the room should be wall, so there shouldn’t be a fence panel here. The loops we used just added a fence panel here, though, so we use an <span epub:type="pagebreak" id="page_104"/>instruction <span class="ent">➓</span> to delete the last item of scenery added to this room, and to room 25, which is on the other side of the compound (see <a href="ch06.xhtml#ch06fig2">Figure 6-2</a>). It’s easier to add these two panels and take them out again than it is to write code that avoids putting these fence panels in. The index number <span class="literal">-1</span> is a handy shortcut for referring to the last item in a list.</p>
<div class="image"><a id="ch06fig3"/><img src="../images/fig6-3.jpg" alt="image"/></div>
<p class="figcap"><em>Figure 6-3: Map showing how the fence touches the wall in an outside room next to the space station</em></p>
<p class="indent">Using random scenery and loops to position fences enables us to have a large area to explore without having to type in data for over 200 fence panels and scenery items.</p>
<div class="sidebar1">
<p class="sidebart"><strong>TIP</strong></p>
<p class="spara">If you’re customizing the game and don’t want to add random scenery or fences in rooms 1 to 25, you can delete the code sections shown in <a href="ch06.xhtml#ch06list2">Listing 6-2</a>.</p>
</div>
<h3 class="h3" id="lev88"><strong>LOADING THE SCENERY INTO EACH ROOM</strong></h3>
<p class="noindent">Now that we’ve added scenery data to the program, let’s add some code so we can see the scenery in the space station! You might remember that the <span class="literal">generate_map()</span> function creates the <span class="literal">room_map</span> list for the room you’re currently exploring. The <span class="literal">room_map</span> list is used to display and navigate the room.</p>
<p class="indent">So far, the <span class="literal">generate_map()</span> function just calculates the size of the room and where the doors are, and places the floor and walls. We need to add <span epub:type="pagebreak" id="page_105"/>some code to extract the scenery from our new dictionary and add it to the <span class="literal">room_map</span>. But first, we’ll make one small but important adjustment to the program. In the <span class="literal">VARIABLES</span> section, near the start of the program, add the new line shown in <a href="ch06.xhtml#ch06list3">Listing 6-3</a>. Save your program as <em>listing6-3.py</em>.</p>
<p class="margin"><em>listing6-3.py</em></p>
<p class="programs"><span class="gray">--<span class="codeitalic1">snip</span>--</span><br/><br/><span class="gray">###############</span><br/><span class="gray">## VARIABLES ##</span><br/><span class="gray">###############</span><br/><br/><span class="gray">--<span class="codeitalic1">snip</span>--</span><br/><br/><span class="gray">LANDER_SECTOR = random.randint(1, 24)</span><br/><span class="gray">LANDER_X = random.randint(2, 11)</span><br/><span class="gray">LANDER_Y = random.randint(2, 11)</span><br/><br/>TILE_SIZE = 30<br/><br/><span class="gray">###############</span><br/><span class="gray">##    MAP    ##</span><br/><span class="gray">###############</span><br/><br/><span class="gray">--<span class="codeitalic1">snip</span>--</span></p>
<p class="listing" id="ch06list3"><em>Listing 6-3: Setting up the</em> <span class="codeitalic">TILE_SIZE</span> <em>variable</em></p>
<p class="indent">This line creates a variable to store the size of a tile. Using it makes the program easier to read because we can replace the number 30 with a more meaningful phrase. Instead of seeing the number 30 in the code and having to remember what it represents, we can see the words <span class="literal">TILE SIZE</span> instead, which gives us a hint about what the code is doing.</p>
<p class="indent">Next, find the <span class="literal">MAKE MAP</span> section of the program: it comes before the <span class="literal">EXPLORER</span> section. Add <a href="ch06.xhtml#ch06list4">Listing 6-4</a> to the end of the <span class="literal">MAKE MAP</span> section to place the scenery in the current room. All the code in <a href="ch06.xhtml#ch06list4">Listing 6-4</a> belongs to the <span class="literal">generate_map()</span> function, so we need to indent the first line by four spaces and then indent the remaining lines as shown. Save your program as <em>listing6-4.py</em>.</p>
<p class="margin"><em>listing6-4.py</em></p>
<p class="programs">   <span class="gray">--<span class="codeitalic1">snip</span>--</span><br/><br/>   <span class="gray">def generate_map():</span><br/>   <span class="gray">--<span class="codeitalic1">snip</span>--</span><br/><br/><span class="ent">➊</span>     <span class="orange">if</span> current_room <span class="orange">in</span> scenery:<br/><span class="ent">➋</span>         <span class="orange">for</span> this_scenery <span class="orange">in</span> scenery[current_room]:<br/><span class="ent">➌</span>             scenery_number = this_scenery[0]<br/><span class="ent">➍</span>             scenery_y = this_scenery[1]<br/><span class="ent">➎</span>             scenery_x = this_scenery[2]<br/><span class="ent">➏</span>             room_map[scenery_y][scenery_x] = scenery_number<br/><br/><span class="ent">➐</span>             image_here = objects[scenery_number][0]<br/><span class="ent">➑</span>             image_width = image_here.get_width()<br/><span epub:type="pagebreak" id="page_106"/><span class="ent">➒</span>             image_width_in_tiles = <span class="purple">int</span>(image_width / TILE_SIZE)<br/><span class="ent">➓</span>             <span class="orange">for</span> tile_number <span class="orange">in</span> <span class="purple">range</span>(1, image_width_in_tiles):<br/>                   room_map[scenery_y][scenery_x + tile_number] = 255<br/><br/>   <span class="gray">###############</span><br/>   <span class="gray">## EXPLORER  ##</span><br/>   <span class="gray">###############</span><br/><br/>   <span class="gray">--<span class="codeitalic1">snip</span>--</span></p>
<p class="listing" id="ch06list4"><em>Listing 6-4: Additional code for</em> <span class="codeitalic">generate_map()</span> <em>that adds the scenery for the current room to the</em> <span class="codeitalic">room_map</span> <em>list</em></p>
<p class="indent">Let’s break this down. The line at <span class="ent">➊</span> checks whether there’s an entry for the current room in the <span class="literal">scenery</span> dictionary. This check is essential because some rooms in our game might not have any scenery, and if we try to use a dictionary key that doesn’t exist, Python stops with an error.</p>
<p class="indent">We then set up a loop <span class="ent">➋</span> that cycles through the scenery items for the room and copies them into a list called <span class="literal">this_scenery</span>. The first time through the loop, <span class="literal">this_scenery</span> contains the list for the first scenery item. The second time, it contains the list for the second item, and so on until it reaches the final scenery item for the current room.</p>
<p class="indent">Each scenery item has a list containing its object number, <em>y</em> position, and <em>x</em> position. The program extracts these details from <span class="literal">this_scenery</span> using index numbers and puts them into variables called <span class="literal">scenery_number</span> <span class="ent">➌</span>, <span class="literal">scenery_y</span> <span class="ent">➍</span>, and <span class="literal">scenery_x</span> <span class="ent">➎</span>.</p>
<p class="indent">Now the program has all the information it needs to add the scenery item to <span class="literal">room_map</span>. You might remember that <span class="literal">room_map</span> stores the object number of the item in each position in the room. It uses the <em>y</em> position and <em>x</em> position in the room as list indexes. This program uses the <span class="literal">scenery_y</span> and <span class="literal">scenery_x</span> values as list indexes to put the item <span class="literal">scenery_number</span> into <span class="literal">room_map</span> <span class="ent">➏</span>.</p>
<p class="indent">If all our objects were one tile wide, that is all we would need to do. But some objects are wider and cover several tiles. For example, a wide object positioned in one tile might cover two more tiles to its right, but at the moment, the program only sees it in that one tile.</p>
<p class="indent">We need to add something to <span class="literal">room_map</span> in those additional spaces so the program knows the player can’t walk on those tiles. I’ve used the number 255 to represent a space that doesn’t have an object in it but also cannot be walked on.</p>
<p class="indent">Why the number 255? It’s a large enough number to give you space to add many more objects to the game if you want to, allowing for 254 items in the <span class="literal">objects</span> dictionary. Also, it feels like a nice number to me: it’s the highest number you can write with one byte of data (that mattered when I started writing games in the 1980s, and the computer only had about 65,000 bytes of memory to store all its data, graphics, and program code).</p>
<p class="indent">First, we need to figure out how wide an image is so we know how many tiles it fills. We use <span class="literal">scenery_number</span> as the dictionary key to get information about the object from the <span class="literal">objects</span> dictionary <span class="ent">➐</span>. We know the <span class="literal">objects</span> dictionary returns a list of information, the first item of which is <span epub:type="pagebreak" id="page_107"/>the image. So we use the index 0 to extract the image and put it into the variable <span class="literal">image_here</span>.</p>
<p class="indent">Then we can use Pygame Zero to find out the width of an image by adding <span class="literal">get_width()</span> after its name <span class="ent">➑</span>. We put that number into a variable called <span class="literal">image_width</span>. Because we need to know how many tiles the image covers, the program divides the image width (in pixels) by the tile size, 30, and makes it an integer (a whole number) <span class="ent">➒</span>. We must convert the number to an integer because we’re going to use it in the <span class="literal">range()</span> function <span class="ent">➓</span>, which can only take integers. If we didn’t convert the number, the width would be a floating-point number—a number with a decimal point.</p>
<p class="indent">Finally, we set up a loop that adds the value 255 in the spaces to the right of the scenery item, wherever the tile is covered <span class="ent">➓</span>.</p>
<p class="indent">If an image is 90 pixels wide, we divide it by the tile size of 30 and store the result, 3, in <span class="literal">image_width_in_tiles</span>. Then the loop counts to 2 using <span class="literal">range()</span> because we give it a range of 1 to <span class="literal">image_width_in_tiles</span> <span class="ent">➓</span>. We add the loop numbers to the <em>x</em> position of the object, and those positions in <span class="literal">room_map</span> are marked with 255. Large objects that cover three tiles now have 255 in the next two spaces to the right.</p>
<p class="indent">Now our program contains all the scenery and can add it to the <span class="literal">room_map</span>, ready for display. Next, we’ll make some small changes to the <span class="literal">EXPLORER</span> section so we can tour the space station.</p>
<h3 class="h3" id="lev89"><strong>UPDATING THE EXPLORER TO TOUR THE SPACE STATION</strong></h3>
<p class="noindent">The <span class="literal">EXPLORER</span> part of the program lets you view all the rooms on the space station and move around the map using the arrow keys. Let’s update that section so you can see all the scenery in place.</p>
<p class="indent">If your <em>Explorer</em> code includes any lines for adding scenery to the <span class="literal">room_map</span>, you’ll need to switch them off now. Although they’re a good way to experiment with a room design, they force the same scenery into every room and override the real room designs. Because these lines might include your ideas for room designs, rather than deleting them, you can comment them out so Python will ignore them. Click and drag the mouse to highlight all the lines at once, and then click <strong>Format</strong> <span class="ent">▸</span> <strong>Comment Out Region</strong> (or use the keyboard shortcut <small>ALT</small>-3). Comment symbols will be added at the start of the highlighted lines, as shown in <a href="ch06.xhtml#ch06list5">Listing 6-5</a>:</p>
<p class="margin"><em>listing6-5.py</em></p>
<p class="programs"><span class="gray">--<span class="codeitalic1">snip</span>--</span><br/><br/><span class="gray">###############</span><br/><span class="gray">## EXPLORER  ##</span><br/><span class="gray">###############</span><br/><br/><span class="gray">def draw():</span><br/>    <span class="gray">global room_height, room_width, room_map</span><br/>    <span class="gray">print(current_room)</span><br/>    <span class="gray">generate_map()</span><br/><span epub:type="pagebreak" id="page_108"/>    <span class="gray">screen.clear()</span><br/><span class="red">##    room_map[2][4] = 7</span><br/><span class="red">##    room_map[2][6] = 6</span><br/><span class="red">##    room_map[1][1] = 8</span><br/><span class="red">##    room_map[1][2] = 9</span><br/><span class="red">##    room_map[1][8] = 12</span><br/><span class="red">##    room_map[1][9] = 10</span><br/><span class="gray">--<span class="codeitalic1">snip</span>--</span></p>
<p class="listing" id="ch06list5"><em>Listing 6-5: Commenting out code in the</em> <span class="codeitalic">EXPLORER</span> <em>section</em></p>
<p class="indent">Now we need to make a small change to the code that displays the room so it doesn’t try to draw an image for a floor space marked with 255. That space will be covered by an image to the left of it, and we don’t have an entry in the <span class="literal">objects</span> dictionary for 255.</p>
<p class="indent"><a href="ch06.xhtml#ch06list6">Listing 6-6</a> shows the new line you need to add to the <span class="literal">EXPLORER</span> part of the program where indicated. The <span class="literal">if</span> statement makes sure the instructions that draw an object run only if the object number is not (<span class="literal">!=</span>) 255.</p>
<p class="indent">After adding the line, indent the existing code that comes after it by four spaces. The indentation tells Python that those instructions belong to the <span class="literal">if</span> instruction. You can either type four spaces at the start of the next two lines, or you can highlight them and click <strong>Format</strong> <span class="ent">▸</span> <strong>Indent Region</strong>.</p>
<p class="margin"><em>listing6-6.py</em></p>
<p class="programs"><span class="gray">--<span class="codeitalic1">snip</span>--</span><br/><br/><span class="gray">###############</span><br/><span class="gray">## EXPLORER  ##</span><br/><span class="gray">###############</span><br/><br/><span class="gray">--<span class="codeitalic1">snip</span>--</span><br/><br/>    <span class="gray">for y in range(room_height):</span><br/>        <span class="gray">for x in range(room_width):</span><br/>            <span class="orange">if</span> room_map[y][x] != 255:<br/>                image_to_draw = objects[room_map[y][x]][0]<br/>                screen.blit(image_to_draw,<br/>                    (top_left_x + (x*30),<br/>                    top_left_y + (y*30) - image_to_draw.get_height()))<br/><br/><span class="gray">--<span class="codeitalic1">snip</span>--</span></p>
<p class="listing" id="ch06list6"><em>Listing 6-6: Updating the</em> Explorer <em>so it doesn’t try to show image 255</em></p>
<p class="indent">Now you’re ready to take a tour of the base. Save the program as <em>listing6-6.py</em> and run it by entering <span class="codestrong">pgzrun listing6-6.py</span>. Use the arrow keys to move around the map and familiarize yourself with the layout of the space station. As before, the <em>Explorer</em> program allows you to move any direction around the map, even if a wall would block your path when playing the game.</p>
<p class="indent">All the scenery should be in place in the rooms. Wide objects should display correctly now, and you should be able to view all the rooms again because of the changes you made earlier in <a href="ch06.xhtml#ch06list5">Listing 6-5</a>. Some objects will <span epub:type="pagebreak" id="page_109"/>still have a black square under them because there’s no floor tile underneath, but we’ll fix that in <a href="ch08.xhtml#ch08">Chapter 8</a>.</p>
<p class="indent">The space station map and scenery are now complete. It’s time to move into the space station. In the next chapter, you’ll teleport down to the surface and set foot on Mars at last.</p>
<div class="sidebar">
<p class="sidebart" id="ch06sb1"><strong>TRAINING MISSION #1</strong></p>
<p class="spara">Can you add your own room design to the scenery data? Room number 43 has been left empty for you to fill. It is 9 × 9 tiles in size, so you can place objects in positions 1 to 7 in each direction (remember the wall!). You could base your design on a room you created previously in the <em>Explorer</em> in <a href="ch05.xhtml#ch05">Chapter 5</a> or invent a new layout. Remember that you need to turn off the <span class="literal">assert</span> instructions to stop the checksum complaining when the <span class="literal">scenery</span> numbers don’t add up.</p>
<p class="spara1">Your program’s <span class="literal">objects</span> dictionary (shown in <a href="ch05.xhtml#ch05">Chapter 5</a>) tells you the number of each object. Use object numbers between 1 and 47 to ensure that you don’t create any problems now that might affect the code when you complete and play the <em>Escape</em> game later.</p>
<p class="indent">If you get stuck, try building my example, which is shown in the <a href="ch06.xhtml#ch06sb2">Mission Debrief</a> on <a href="ch06.xhtml#page_110">page 110</a>. Change the value of <span class="literal">current_room</span> in the <span class="literal">VARIABLES</span> section to 43 so you can see your redesigned room when you first run the program. Remember to change <span class="literal">current_room</span> back to 31 when you’ve finished.</p>
</div>
<h3 class="h3" id="lev90"><strong>ARE YOU FIT TO FLY?</strong></h3>
<p class="noindentb">Check the following boxes to confirm that you’ve learned the key lessons in this chapter.</p>
<p class="square"><img src="../images/box.jpg" alt="Images"/>  Items that cannot move during the <em>Escape</em> game are called <em>scenery</em>.</p>
<p class="square"><img src="../images/box.jpg" alt="Images"/>  The <span class="literal">scenery</span> dictionary uses the room number as its key and provides a list of the fixed items in each room.</p>
<p class="square"><img src="../images/box.jpg" alt="Images"/>  Each scenery item is stored as a list containing the object number, <em>y</em> position, and <em>x</em> position.</p>
<p class="square"><img src="../images/box.jpg" alt="Images"/>  Checksums check whether the data has been changed or entered incorrectly.</p>
<p class="square"><img src="../images/box.jpg" alt="Images"/>  Loops can be used to add items to the <span class="literal">scenery</span> dictionary. Some scenery can be positioned randomly, too.</p>
<p class="square"><img src="../images/box.jpg" alt="Images"/>  The <span class="literal">generate_map()</span> function takes items that are in the current room from the <span class="literal">scenery</span> dictionary and puts them in the <span class="literal">room_map</span> list. Then the items can be displayed in the room.</p>
<p class="square"><img src="../images/box.jpg" alt="Images"/>  The number 255 in <span class="literal">room_map</span> represents a space that is covered by a wide object, when the object doesn’t start in that space.</p>
<div class="image" id="ch06sb2"><span epub:type="pagebreak" id="page_110"/><img src="../images/f0110-01.jpg" alt="image"/></div>
</body></html>