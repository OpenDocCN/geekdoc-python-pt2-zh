<html><head></head><body>
<h2 class="h2" id="ch07"><span epub:type="pagebreak" id="page_111"/><strong><span class="blue"><span class="big">7</span></span><br/>MOVING INTO THE SPACE STATION</strong></h2>
<div class="image1"><img src="../images/common01.jpg" alt="image"/></div>
<p class="noindent">Now that we’ve outfitted the space station with scenery, life support systems, and other equipment, it’s time to move in. In this chapter, you’ll see yourself in the space station for the first time, and you’ll be able to move around and explore the rooms. You might feel a bit stiff from the journey to begin with, but you’ll soon be walking all over the base.</p>
<p class="indent">You’ll discover how to animate the astronaut and use the keyboard controls to move them around. You’ll also add code to enable the astronaut to move between rooms. Is there life on Mars? There is now.</p>
<h3 class="h3" id="lev91"><span epub:type="pagebreak" id="page_112"/><strong>ARRIVING ON THE SPACE STATION</strong></h3>
<p class="noindent">We’ll use <a href="ch06.xhtml#ch06list6">Listing 6-6</a> from <a href="ch06.xhtml#ch06">Chapter 6</a> as a starting point in this chapter, so open <em>listing6-6.py</em>. We’ll add code to show you in your space suit in the space station. Eventually, you’ll be able to move around using the arrow keys.</p>
<h4 class="h4" id="lev92"><strong>DISABLING THE ROOM NAVIGATION CONTROLS IN THE EXPLORER SECTION</strong></h4>
<p class="noindent">So far, we’ve been using the arrow keys in the <span class="literal">EXPLORER</span> section to show different rooms on the map. We’re going to start using those keys to move the astronaut around the rooms. First, we need to disable the existing controls. Scroll down to the <span class="literal">EXPLORER</span> part of the program and highlight the instructions shown in <a href="ch07.xhtml#ch07list1">Listing 7-1</a>. Click <strong>Format</strong> <span class="ent">▸</span> <strong>Comment Out Region</strong> to turn those instructions into comments so the program will ignore them. (You can also just delete them if you prefer.) Save your program as <em>listing7-1.py</em>.</p>
<p class="margin"><em>listing7-1.py</em></p>
<p class="programs"><span class="gray">--<span class="codeitalic1">snip</span>--</span><br/><span class="red">##def movement():</span><br/><span class="red">##    global current_room</span><br/><span class="red">##    old_room = current_room</span><br/><span class="red">##    </span><br/><span class="red">##    if keyboard.left:</span><br/><span class="red">##        current_room -= 1</span><br/><span class="red">##    if keyboard.right:</span><br/><span class="red">##        current_room += 1</span><br/><span class="red">##    if keyboard.up:</span><br/><span class="red">##        current_room -= MAP_WIDTH</span><br/><span class="red">##    if keyboard.down:</span><br/><span class="red">##        current_room += MAP_WIDTH</span><br/><span class="red">##</span><br/><span class="red">##    if current_room &gt; 50:</span><br/><span class="red">##        current_room = 50</span><br/><span class="red">##    if current_room &lt; 1:</span><br/><span class="red">##        current_room = 1</span><br/><span class="red">##</span><br/><span class="red">##    if current_room != old_room:</span><br/><span class="red">##        print("Entering room:" + str(current_room))</span><br/><span class="red">##</span><br/><span class="red">##clock.schedule_interval(movement, 0.08)</span><br/><span class="gray">--<span class="codeitalic1">snip</span>--</span></p>
<p class="listing" id="ch07list1"><em>Listing 7-1: Turning off the keyboard controls in the</em> <span class="codeitalic">EXPLORER</span> <em>section</em></p>
<p class="indent">Now we can add code that uses the arrow keys to move the astronaut.</p>
<h4 class="h4" id="lev93"><strong>ADDING NEW VARIABLES</strong></h4>
<p class="noindent">Let’s start by setting up some variables. The most important of these are your starting coordinates where you’ll teleport in. As before, we add variables to the <span class="literal">VARIABLES</span> part of the program, near the start. Add the new lines in <a href="ch07.xhtml#ch07list2">Listing 7-2</a>. Save your program as <em>listing7-2.py</em>.</p>
<p class="margin"><span epub:type="pagebreak" id="page_113"/><em>listing7-2.py</em></p>
<p class="programs">   <span class="gray">--<span class="codeitalic1">snip</span>--</span><br/>   <span class="gray">TILE_SIZE = 30</span><br/><br/><span class="ent">➊</span> player_y, player_x = 2, 5<br/><span class="ent">➋</span> game_over = <span class="orange">False</span><br/><br/><span class="ent">➌</span> PLAYER = {<br/>       <span class="green">"left"</span>: [images.spacesuit_left, images.spacesuit_left_1,<br/>                images.spacesuit_left_2, images.spacesuit_left_3,<br/>                images.spacesuit_left_4<br/>                ],<br/>       <span class="green">"right"</span>: [images.spacesuit_right, images.spacesuit_right_1,<br/>                 images.spacesuit_right_2, images.spacesuit_right_3,<br/>                 images.spacesuit_right_4<br/>                 ],<br/>       <span class="green">"up"</span>: [images.spacesuit_back, images.spacesuit_back_1,<br/>              images.spacesuit_back_2, images.spacesuit_back_3,<br/>              images.spacesuit_back_4<br/>              ],<br/>       <span class="green">"down"</span>: [images.spacesuit_front, images.spacesuit_front_1,<br/>                images.spacesuit_front_2, images.spacesuit_front_3,<br/>                images.spacesuit_front_4<br/>                ]<br/>       }<br/><br/><span class="ent">➍</span> player_direction = "down"<br/><span class="ent">➎</span> player_frame = 0<br/><span class="ent">➏</span> player_image = PLAYER[player_direction][player_frame]<br/>   player_offset_x, player_offset_y = 0, 0<br/><br/>   <span class="gray">--<span class="codeitalic1">snip</span>--</span></p>
<p class="listing" id="ch07list2"><em>Listing 7-2: Adding player variables</em></p>
<p class="indent">The <span class="literal">VARIABLES</span> section already includes a value for <span class="literal">current_room</span>, which is the room you’ll start in. (If you changed the value of <span class="literal">current_room</span> while experimenting in <a href="ch06.xhtml#ch06">Chapter 6</a>, make sure you change it back to 31.) We make new <span class="literal">player_y</span> and <span class="literal">player_x</span> variables <span class="ent">➊</span> to contain numbers for your starting position in the room. Here, we’re setting up two variables in a single line. The numbers are put into the variables in the same order they’re listed, so <span class="literal">2</span> goes into <span class="literal">player_y</span> (the first number goes into the first variable), and <span class="literal">5</span> goes into <span class="literal">player_x</span>. These variables will change as you move around the rooms on the space station and will be used to check where you are and draw you in the correct place. Your position is measured using the same tile coordinates as for the scenery positions.</p>
<p class="indent">We also set up a <span class="literal">game_over</span> variable <span class="ent">➋</span> to tell the program whether the game has ended. At the start of the program, we set the variable to <span class="literal">False</span>. It will stay <span class="literal">False</span> until the game ends and then become <span class="literal">True</span>. The program checks this variable to see whether the player is allowed to move. It would be odd if the player kept moving after they died!</p>
<p class="indent">Next, we’ll set up the images for the player’s walking animation. Animation is a trick of the eye. You start with a series of similar pictures with <span epub:type="pagebreak" id="page_114"/>slight differences that show small movements. When you switch between them quickly, you can fool the eye into thinking the image is moving. In our game, we’ll use a series of images of the astronaut walking that show the legs in different positions. When we switch between them quickly, the astronaut’s legs will look like they’re moving.</p>
<div class="sidebar1">
<p class="sidebart"><strong>TIP</strong></p>
<p class="spara">The key to making animation work is to make sure the images are similar enough. If the images are too different, the effect doesn’t work.</p>
</div>
<p class="indent">Each image in an animation is known as a <em>frame</em>. <a href="ch07.xhtml#ch07tab1">Table 7-1</a> shows the animation frames we’ll use. We’ll number our frames starting at 0, which will be the resting position when the astronaut isn’t walking. When the player is walking up the screen, we see their back because they’re walking away from us in the room.</p>
<p class="tabcap" id="ch07tab1"><strong>Table 7-1:</strong> The Animation Frames for the Astronaut</p>
<table class="topbot-d">
<thead>
<tr>
<td style="vertical-align: top;" class="table-h"><p class="tab_th"><strong>Key</strong></p></td>
<td style="vertical-align: top;" class="table-h"><p class="tab_th"><strong>Frame 0</strong></p></td>
<td style="vertical-align: top;" class="table-h"><p class="tab_th"><strong>Frame 1</strong></p></td>
<td style="vertical-align: top;" class="table-h"><p class="tab_th"><strong>Frame 2</strong></p></td>
<td style="vertical-align: top;" class="table-h"><p class="tab_th"><strong>Frame 3</strong></p></td>
<td style="vertical-align: top;" class="table-h"><p class="tab_th"><strong>Frame 4</strong></p></td>
</tr>
</thead>
<tbody>
<tr>
<td style="vertical-align: top;" class="table-b"><p class="taba"><span class="literal">left</span></p></td>
<td style="vertical-align: top;" class="table-b"><p class="taba"><img src="../images/f0114-01.jpg" alt="image"/></p></td>
<td style="vertical-align: top;" class="table-b"><p class="taba"><img src="../images/f0114-02.jpg" alt="image"/></p></td>
<td style="vertical-align: top;" class="table-b"><p class="taba"><img src="../images/f0114-03.jpg" alt="image"/></p></td>
<td style="vertical-align: top;" class="table-b"><p class="taba"><img src="../images/f0114-04.jpg" alt="image"/></p></td>
<td style="vertical-align: top;" class="table-b"><p class="taba"><img src="../images/f0114-05.jpg" alt="image"/></p></td>
</tr>
<tr>
<td style="vertical-align: top;" class="table-b"><p class="taba"><span class="literal">right</span></p></td>
<td style="vertical-align: top;" class="table-b"><p class="taba"><img src="../images/f0114-06.jpg" alt="image"/></p></td>
<td style="vertical-align: top;" class="table-b"><p class="taba"><img src="../images/f0114-07.jpg" alt="image"/></p></td>
<td style="vertical-align: top;" class="table-b"><p class="taba"><img src="../images/f0114-08.jpg" alt="image"/></p></td>
<td style="vertical-align: top;" class="table-b"><p class="taba"><img src="../images/f0114-09.jpg" alt="image"/></p></td>
<td style="vertical-align: top;" class="table-b"><p class="taba"><img src="../images/f0114-10.jpg" alt="image"/></p></td>
</tr>
<tr>
<td style="vertical-align: top;" class="table-b"><p class="taba"><span class="literal">up</span></p></td>
<td style="vertical-align: top;" class="table-b"><p class="taba"><img src="../images/f0114-11.jpg" alt="image"/></p></td>
<td style="vertical-align: top;" class="table-b"><p class="taba"><img src="../images/f0114-12.jpg" alt="image"/></p></td>
<td style="vertical-align: top;" class="table-b"><p class="taba"><img src="../images/f0114-13.jpg" alt="image"/></p></td>
<td style="vertical-align: top;" class="table-b"><p class="taba"><img src="../images/f0114-14.jpg" alt="image"/></p></td>
<td style="vertical-align: top;" class="table-b"><p class="taba"><img src="../images/f0114-15.jpg" alt="image"/></p></td>
</tr>
<tr>
<td style="vertical-align: top;" class="table-ba"><p class="taba"><span class="literal">down</span></p></td>
<td style="vertical-align: top;" class="table-ba"><p class="taba"><img src="../images/f0114-16.jpg" alt="image"/></p></td>
<td style="vertical-align: top;" class="table-ba"><p class="taba"><img src="../images/f0114-17.jpg" alt="image"/></p></td>
<td style="vertical-align: top;" class="table-ba"><p class="taba"><img src="../images/f0114-18.jpg" alt="image"/></p></td>
<td style="vertical-align: top;" class="table-ba"><p class="taba"><img src="../images/f0114-19.jpg" alt="image"/></p></td>
<td style="vertical-align: top;" class="table-ba"><p class="taba"><img src="../images/f0114-20.jpg" alt="image"/></p></td>
</tr>
</tbody>
</table>
<p class="indent">The <span class="literal">PLAYER</span> dictionary <span class="ent">➌</span> stores the animation frames. The direction names—up, down, left, and right—are the dictionary keys. Each dictionary <span epub:type="pagebreak" id="page_115"/>entry is a list that has the image of the player standing, plus four animation frames for that direction of walking (see <a href="ch07.xhtml#ch07tab1">Table 7-1</a>). The <span class="literal">PLAYER</span> dictionary will be used together with the direction the player is facing <span class="ent">➍</span> and the number of the animation frame <span class="ent">➎</span> to display the correct image as the player walks or stands still. The <span class="literal">player_image</span> variable <span class="ent">➏</span> stores the current image of the astronaut.</p>
<div class="sidebar1">
<p class="sidebart"><strong>TIP</strong></p>
<p class="spara"><a href="appb.xhtml#appb">Appendix B</a> at the back of the book describes the important variables in the <em>Escape</em> program, so look there if you can’t remember what a particular variable does.</p>
</div>
<h4 class="h4" id="lev94"><strong>TELEPORTING ONTO THE SPACE STATION</strong></h4>
<p class="noindent">Get ready to beam down! With the starting coordinates in place, let’s add the code to make you appear in the space station.</p>
<p class="indent"><a href="ch07.xhtml#ch07list3">Listing 7-3</a> shows the lines you need to add to the <span class="literal">EXPLORER</span> part of the program. As before, you only need to add the new lines. Don’t change the other lines. Just use them to find your way around the program code. The first new line <span class="ent">➊</span> is indented by eight spaces because it’s inside a function and also inside a loop. Save your program as <em>listing7-3.py</em>.</p>
<p class="margin"><em>listing7-3.py</em></p>
<p class="programs">   <span class="gray">--<span class="codeitalic1">snip</span>--</span><br/>       <span class="gray">for y in range(room_height):</span><br/>        <span class="gray">for x in range(room_width):</span><br/>               <span class="gray">if room_map[y][x] != 255:</span> <br/>                   <span class="gray">image_to_draw = objects[room_map[y][x]][0]</span><br/>                   <span class="gray">screen.blit(image_to_draw,</span><br/>                       <span class="gray">(top_left_x + (x*30),</span><br/>                        <span class="gray">top_left_y + (y*30) - image_to_draw.get_height()))</span><br/><span class="ent">➊</span>         <span class="orange">if</span> player_y == y:<br/><span class="ent">➋</span>             image_to_draw = PLAYER[player_direction][player_frame]<br/><span class="ent">➌</span>             screen.blit(image_to_draw,<br/>                           (top_left_x + (player_x*30)+(player_offset_x*30),<br/>                            top_left_y + (player_y*30)+(player_offset_y*30)<br/>                            - image_to_draw.get_height()))<br/>   <span class="gray">--<span class="codeitalic1">snip</span>--</span></p>
<p class="listing" id="ch07list3"><em>Listing 7-3: Drawing the player in the room</em></p>
<p class="indent">These new instructions draw you in the room. The <span class="literal">y</span> loop draws the room from back to front. The <span class="literal">x</span> loop draws the scenery in each row from left to right.</p>
<p class="indent">After each row is drawn, the program checks whether the player is standing in that row <span class="ent">➊</span>. This instruction should be lined up with the <span class="literal">for x in range(room_width)</span> line rather than indented further, because it’s not inside the <span class="literal">x</span> loop. It will run once, after the <span class="literal">x</span> loop has finished.</p>
<p class="indent"><span epub:type="pagebreak" id="page_116"/>If the player <em>is</em> in the row the program has just drawn, the next line <span class="ent">➋</span> puts the picture of the player into the variable <span class="literal">image_to_draw</span>. The image is taken from the <span class="literal">PLAYER</span> dictionary of animation frames, using the player’s direction and the animation frame number.</p>
<p class="indent">The last new line <span class="ent">➌</span> draws the player using the <span class="literal">image_to_draw</span> variable you just set up, which contains the picture. It also uses the player’s <em>x</em> and <em>y</em> position variables to work out where to draw the image on the screen. <a href="ch03.xhtml#ch03">Chapter 3</a> explains how the position onscreen is calculated (see “<a href="ch03.xhtml#lev58">Working Out Where to Draw Each Item</a>” on <a href="ch03.xhtml#page_56">page 56</a>). The <span class="literal">player_offset_x</span> and <span class="literal">player_offset_y</span> variables were set up in <a href="ch07.xhtml#ch07list2">Listing 7-2</a> and are used to position the player partway between tiles as they walk between them. You’ll learn more about these variables shortly.</p>
<p class="indent">Get ready to teleport! Brace yourself! Take a deep breath.</p>
<p class="indent">Run your program using <span class="codestrong">pgzrun listing7-3.py</span>. If your teleportation was successful, you should be on the space station (see <a href="ch07.xhtml#ch07fig1">Figure 7-1</a>). If not, check the program changes you made in this chapter.</p>
<p class="indent">One side effect of teleporting is that at first you can’t move. As we add more code, you’ll find that the side effect wears off.</p>
<div class="image"><a id="ch07fig1"/><img src="../images/fig7-1.jpg" alt="image"/></div>
<p class="figcap"><em>Figure 7-1: The astronaut arrives!</em></p>
<h3 class="h3" id="lev95"><strong>ADDING THE MOVEMENT CODE</strong></h3>
<p class="noindent">Now we’ll add a totally new section called <span class="literal">GAME LOOP</span>. This is the heart of the program. The <span class="literal">game_loop()</span> function will run several times a second and enable you to move. Later in the book, we’ll add more instructions here that enable you to do things with the objects you find.</p>
<p class="indent">Add this new section between the <span class="literal">MAKE MAP</span> and <span class="literal">EXPLORER</span> sections. <a href="ch07.xhtml#ch07list4">Listing 7-4</a> shows you what it looks like. Save the program as <em>listing7-4.py</em>.</p>
<p class="margin"><em>listing7-4.py</em></p>
<p class="programs">   <span class="gray">--<span class="codeitalic1">snip</span>--</span><br/>               <span class="gray">for tile_number in range(1, image_width_in_tiles):</span><br/>                   <span class="gray">room_map[scenery_y][scenery_x + tile_number] = 255</span><br/><br/><span epub:type="pagebreak" id="page_117"/>   <span class="red">###############</span><br/>   <span class="red">## GAME LOOP ##</span><br/>   <span class="red">###############</span><br/><br/><span class="ent">➊</span> <span class="orange">def</span> <span class="blue">game_loop</span>():<br/><span class="ent">➋</span>     <span class="orange">global</span> player_x, player_y, current_room<br/>       <span class="orange">global</span> from_player_x, from_player_y<br/>       <span class="orange">global</span> player_image, player_image_shadow<br/>       <span class="orange">global</span> selected_item, item_carrying, energy<br/>       <span class="orange">global</span> player_offset_x, player_offset_y<br/>       <span class="orange">global</span> player_frame, player_direction<br/><br/><span class="ent">➌</span>     <span class="orange">if</span> game_over:<br/>           <span class="orange">return</span><br/><span class="ent">➍</span>     <span class="orange">if</span> player_frame &gt; 0:<br/>           player_frame += 1<br/>           time.sleep(0.05)<br/>           <span class="orange">if</span> player_frame == 5:<br/>               player_frame = 0<br/>               player_offset_x = 0<br/>               player_offset_y = 0<br/><br/><span class="ent">➎</span> <span class="red"># save player's current position</span><br/>       old_player_x = player_x<br/>       old_player_y = player_y<br/><br/><span class="ent">➏</span> <span class="red"># move if key is pressed</span><br/>       <span class="orange">if</span> player_frame == 0:<br/>           <span class="orange">if</span> keyboard.right:<br/>               from_player_x = player_x<br/>               from_player_y = player_y<br/>               player_x += 1<br/>               player_direction = <span class="green">"right"</span><br/>               player_frame = 1<br/>           <span class="orange">elif</span> keyboard.left: <span class="red">#elif stops player making diagonal movements</span><br/>               from_player_x = player_x<br/>               from_player_y = player_y<br/>               player_x -= 1<br/>               player_direction = <span class="green">"left"</span><br/>               player_frame = 1<br/>           <span class="orange">elif</span> keyboard.up:<br/>               from_player_x = player_x<br/>               from_player_y = player_y<br/>               player_y -= 1<br/>               player_direction = <span class="green">"up"</span><br/>               player_frame = 1<br/>           <span class="orange">elif</span> keyboard.down:<br/>               from_player_x = player_x<br/>               from_player_y = player_y<br/>               player_y += 1<br/>               player_direction = <span class="green">"down"</span><br/>               player_frame = 1<br/><br/><span epub:type="pagebreak" id="page_118"/><span class="ent">➐</span>     <span class="red"># If the player is standing somewhere they shouldn't, move them back.</span><br/>       <span class="red"># Keep the 2 comments below - you'll need them later</span><br/>       <span class="orange">if</span> room_map[player_y][player_x] <span class="orange">not in</span> items_player_may_stand_on: <span class="red">#\</span><br/>       <span class="red">#           or hazard_map[player_y][player_x] != 0:</span><br/>           player_x = old_player_x<br/>           player_y = old_player_y<br/><span class="ent">➑</span>         player_frame = 0<br/><br/><span class="ent">➒</span>     <span class="orange">if</span> player_direction == <span class="green">"right"</span> <span class="orange">and</span> player_frame &gt; 0:<br/>           player_offset_x = -1 + (0.25 * player_frame)<br/>       <span class="orange">if</span> player_direction == <span class="green">"left"</span> <span class="orange">and</span> player_frame &gt; 0:<br/>           player_offset_x = 1 - (0.25 * player_frame)<br/>       <span class="orange">if</span> player_direction == <span class="green">"up"</span> <span class="orange">and</span> player_frame &gt; 0:<br/>           player_offset_y = 1 - (0.25 * player_frame)<br/>       <span class="orange">if</span> player_direction == <span class="green">"down"</span> <span class="orange">and</span> player_frame &gt; 0:<br/>           player_offset_y = -1 + (0.25 * player_frame)<br/><br/>   <span class="gray">###############</span><br/>   <span class="gray">## EXPLORER  ##</span><br/>   <span class="gray">###############</span><br/><br/>   <span class="gray">--<span class="codeitalic1">snip</span>--</span></p>
<p class="listing" id="ch07list4"><em>Listing 7-4: Adding player movement</em></p>
<p class="indent">At the very end of the program, you also need to add a new section called <span class="literal">START</span>, which will make the <span class="literal">game_loop()</span> function run every 0.03 seconds. <a href="ch07.xhtml#ch07list5">Listing 7-5</a> shows you the lines to add. This instruction isn’t indented, because it doesn’t belong to a function. Python runs the instructions that <em>aren’t</em> inside a function in the order they appear in the program, from top to bottom. This instruction runs after all the variables, map, scenery, and prop data have been set up and the functions have been defined in the instructions above. Save your program as <em>listing7-5.py</em>.</p>
<p class="margin"><em>listing7-5.py</em></p>
<p class="programs"><span class="gray">--<span class="codeitalic1">snip</span>--</span><br/><span class="red">###############</span><br/><span class="red">##   START   ##</span><br/><span class="red">###############</span><br/><br/>clock.schedule_interval(game_loop, 0.03)<br/><br/><span class="gray">--<span class="codeitalic1">snip</span>--</span></p>
<p class="listing" id="ch07list5"><em>Listing 7-5: Setting the</em> <span class="codeitalic">game_loop()</span> <em>function to run regularly</em></p>
<p class="indent">Run the program using <span class="codestrong">pgzrun listing7-5.py</span>. You should be in the room (as shown in <a href="ch07.xhtml#ch07fig1">Figure 7-1</a>) and be able to move using the arrow keys! You might notice your legs disappear when you walk up the screen. This is a side effect of teleportation that will wear off when we improve the code for drawing rooms in <a href="ch08.xhtml#ch08">Chapter 8</a>.</p>
<p class="indent">At this point, the program won’t work properly if you walk out the door, but it should stop you from walking through walls or furniture. If you <em>can</em> <span epub:type="pagebreak" id="page_119"/>walk through objects, double-check the new code you just added. If you still have problems, carefully check the line that sets up the <span class="literal">items_player_may_stand_on</span> list at the end of the <span class="literal">OBJECTS</span> part of the program.</p>
<h3 class="h3" id="lev96"><strong>UNDERSTANDING THE MOVEMENT CODE</strong></h3>
<p class="noindent">If you want to play the game and customize it with your own designs, you don’t need to understand how the code in this chapter works. You can simply replace the images and the data for maps, scenery, and props. This movement code, and the code for moving between rooms, which you’ll add later in this chapter, should keep working. However, if you want to understand how the code works and want to see how you could add animation to your programs, I’ll break it down now. This code is the real engine of the game, so in many ways it’s the most exciting bit!</p>
<p class="indent">If you’re getting a sense of déjà vu, it’s because you’ve already seen much of this code. In <a href="ch02.xhtml#ch02">Chapter 2</a>, for your spacewalk, you used code to change the player’s position using keyboard controls and a function called <span class="literal">game_loop()</span> to control movement. Let’s refresh our memories and see what’s new in <a href="ch07.xhtml#ch07list4">Listing 7-4</a>.</p>
<p class="indent">In <a href="ch07.xhtml#ch07list4">Listing 7-4</a>, we define a function called <span class="literal">game_loop()</span> <span class="ent">➊</span> at the start of this new section. The <span class="literal">clock.schedule_interval()</span> function we added at the end of the program (see <a href="ch07.xhtml#ch07list5">Listing 7-5</a>) makes this <span class="literal">game_loop()</span> function run every 0.03 seconds. Each time the <span class="literal">game_loop()</span> function runs, it checks whether you’ve pressed an arrow key or are walking and, if so, updates your position.</p>
<p class="indent">At the start of <span class="literal">game_loop()</span>, we tell Python which variables are global variables <span class="ent">➋</span> (see “<a href="ch01.xhtml#lev30">Understanding the Spacewalk Listing</a>” on <a href="ch01.xhtml#page_27">page 27</a> for a refresher on why we need to do this). Some of these aren’t used yet, but we’ll need them later.</p>
<p class="indent">Then we check the <span class="literal">game_over</span> variable. If it’s set to <span class="literal">True</span> <span class="ent">➌</span>, the <span class="literal">game_loop()</span> function finishes without running any of its other instructions because the game is over. This variable stops the player from moving when the game ends. For now, it won’t do anything, because nothing in our program causes the game to end.</p>
<p class="indent">The <span class="literal">game_loop()</span> function checks whether the player is already walking <span class="ent">➍</span>. It takes four animation frames to walk one tile across the screen. If the player is moving, the <span class="literal">player_frame</span> variable contains a number between 1 and 4, which represents the animation frame being used. If the player is walking, the program increases the <span class="literal">player_frame</span> variable by 1 to move to the next animation frame. That means the <span class="literal">draw()</span> function in the <span class="literal">EXPLORER</span> section will show the next animation frame the next time it runs.</p>
<p class="indent">When <span class="literal">player_frame</span> reaches 5, it means all the animation frames have been shown and the animation has ended. In that case, the program resets <span class="literal">player_frame</span> to 0 to end the animation. When the animation ends, the program also resets the <span class="literal">player_offset_x</span> and <span class="literal">player_offset_y</span> variables. I’ll tell you what these do in a minute.</p>
<p class="indent">Next, we see whether the player has pressed a key to start a new walking animation. Before we let the player move, we save their current position <span class="ent">➎</span> <span epub:type="pagebreak" id="page_120"/>by storing the <em>x</em> position in the variable <span class="literal">old_player_x</span> and the <em>y</em> position in the variable <span class="literal">old_player_y</span>. We will use these variables to move the player back if they try to walk somewhere they shouldn’t, such as into a wall pillar.</p>
<p class="indent">The program then uses a familiar block of code to change the player’s <em>x</em> and <em>y</em> position variables if an arrow key is pressed <span class="ent">➏</span>. We measure the player’s position in tiles, the same units we use for positioning the scenery. This is different from when we used pixels as the measurement in <a href="ch01.xhtml#ch01">Chapter 1</a>.</p>
<p class="indent">When the player presses the right arrow key, the program adds 1 to the <em>x</em> position. If the player presses the left arrow key, it subtracts 1. We use similar code to change the <em>y</em> position if the player presses the up or down arrow keys.</p>
<p class="indent">When the player moves, the global variables <span class="literal">from_player_x</span> and <span class="literal">from_player_y</span> store the position the player is walking from. These variables will be used later to check whether the player has been hit by a hazard while walking. The <span class="literal">player_direction</span> variable is also set to the direction they’re moving, and the <span class="literal">player_frame</span> is set to 1, the first frame in the animation sequence.</p>
<p class="indent">As in <a href="ch01.xhtml#ch01">Chapter 1</a>, we use <span class="literal">elif</span> to combine our checks for a keypress. This ensures the player cannot change the <em>x</em> and <em>y</em> positions at the same time to move diagonally. In our 3D room, walking diagonally would enable the player to walk through obstacles, squeezing through impossible gaps.</p>
<p class="indent">After moving the player, we check whether the new position puts them somewhere they’re allowed to be <span class="ent">➐</span>. We do this by using <span class="literal">room_map</span> to see what item is in the position they’re standing at and checking it against the list <span class="literal">items_player_may_stand_on</span>. There is some code I’ve commented out here too, which we’ll need to enable later to stop players from walking through hazards.</p>
<p class="indent">We can use the keyword <span class="literal">in</span> to check whether something is in a list. By using the keyword <span class="literal">not</span> with it, we can see whether something is missing from a list. The following line means “If the number in the map where the player is standing isn’t in the list of items, the player is allowed to stand on . . .”</p>
<p class="programs"><span class="orange">if</span> room_map[player_y][player_x] <span class="orange">not</span> <span class="orange">in</span> items_player_may_stand_on:</p>
<p class="indent">If the player is standing on something that isn’t in the <span class="literal">items_player_may_stand_on</span> list, we reset the player’s <em>x</em> and <em>y</em> positions to their position before they moved.</p>
<p class="indent">All of this happens so fast that the player doesn’t notice anything. If they try to walk into a wall, it looks like they never went anywhere! This is a simpler way of stopping the player from walking through walls than checking whether each movement is allowed before making it.</p>
<p class="indent">The program also sets the <span class="literal">player_frame</span> variable to 0 if the player’s position must be reset <span class="ent">➑</span>. This turns off the player animation again.</p>
<p class="indent">When you press the right arrow key, the astronaut steps one tile to the right. It takes four frames to animate this, so the astronaut is displayed at positions that are partway across the tile while this animation plays out. The <span class="literal">player_offset_x</span> and <span class="literal">player_offset_y</span> variables are used to work <span epub:type="pagebreak" id="page_121"/>out where to draw the astronaut. These variables are calculated at the end of the <span class="literal">game_loop()</span> function <span class="ent">➒</span>. The <span class="literal">draw()</span> function (see <a href="ch07.xhtml#ch07list3">Listing 7-3</a>) multiplies the offset values by the size of a tile (30 pixels) because images are drawn in pixels. For example, if the offset is 0.25 tiles, the astronaut is drawn roughly 7 pixels away from the center of the new tile. The computer will round the number because you can’t position something using half a pixel.</p>
<p class="indent">Look at the left side of <a href="ch07.xhtml#ch07fig2">Figure 7-2</a>. For the first animation frame when the astronaut is walking left, we need to add three-quarters of a tile to the player’s new tile position (0.75). For the second animation frame, we add half a tile (0.5) to the player’s new tile position before drawing it. For the third animation frame, we add a quarter of a tile to the player’s new tile position.</p>
<div class="image"><a id="ch07fig2"/><img src="../images/fig7-2.jpg" alt="image"/></div>
<p class="figcap"><em>Figure 7-2: Understanding how the astronaut is positioned during the animation</em></p>
<p class="indent">We can calculate these offset numbers using the frame number. Here’s the calculation for walking left:</p>
<p class="programs">player_offset_x = 1 - (0.25 * player_frame)</p>
<p class="indent">Check that this calculation makes sense by working out the numbers on your own. For example, here is the calculation when the animation frame is 2:</p>
<p class="indenta">0.25 × 2 = 0.5</p>
<p class="indenta">1 − 0.5 = 0.5</p>
<p class="indent"><span epub:type="pagebreak" id="page_122"/>In <a href="ch07.xhtml#ch07fig2">Figure 7-2</a>, 0.5 is the correct offset for frame 2.</p>
<p class="indent">When the player walks right, we need to subtract part of a tile from the player’s position, so the offsets are negative. Look at the right side of <a href="ch07.xhtml#ch07fig2">Figure 7-2</a>. For frame 1, adding −0.75 puts the astronaut three-quarters of a tile to the <em>left</em> of their new position.</p>
<p class="indent">We can work out the <em>x</em> offset for walking right using the frame number too. Here’s the formula:</p>
<p class="programs">player_offset_x = -1 + (0.25 * player_frame)</p>
<div class="sidebar">
<p class="sidebart" id="ch07sb1"><strong>TRAINING MISSION #1</strong></p>
<p class="spara">Can you check that the formula works? Use it to find the offset values for frames 1 and 3, and check that they match the offset values in <a href="ch07.xhtml#ch07fig2">Figure 7-2</a>.</p>
</div>
<p class="indent">The offsets for the <em>y</em> direction work the same. When the astronaut is moving up, we calculate the <em>y</em> offset using the same formula as the left offset. When the astronaut is moving down, we calculate the <em>y</em> offset using the same formula as the right offset.</p>
<p class="indent">In summary, the <span class="literal">game_loop()</span> function does this:</p>
<ul>
<li class="noindent">If you’re not walking, it starts the walking animation when you press a key.</li>
<li class="noindent">If you are walking, it works out the next animation frame and the positions partway across the tile to use when drawing you.</li>
<li class="noindent">If you’ve reached the end of the animation sequence, it resets it so you can move again. The movement is fluid, so if you hold down a key, you’ll cycle through animation frames 1 to 4 and won’t see the standing position until you stop walking.</li>
</ul>
<h3 class="h3" id="lev97"><strong>MOVING BETWEEN ROOMS</strong></h3>
<p class="noindent">Now that you’re on your feet, you’ll want to explore the space station fully. Let’s add some code to the <span class="literal">game_loop()</span> function that lets you walk into the next room. Add the new code in <a href="ch07.xhtml#ch07list6">Listing 7-6</a>, which goes after we check for keypresses and before we check whether the player is standing somewhere they shouldn’t be. Make sure you include the instructions with comment symbols (<span class="literal">#</span>) at the start. We’ll need them later.</p>
<p class="indent">The grayed-out lines in <a href="ch07.xhtml#ch07list6">Listing 7-6</a> show you where to add the new code. Save your program as <em>listing7-6.py</em>. Run it using <span class="codestrong">pgzrun listing7-6.py</span> and then walk around the space station! This is a good time to look around, before the doors are fitted and certain areas are locked down.</p>
<p class="margin"><em>listing7-6.py</em></p>
<p class="programs">   <span class="gray">--<span class="codeitalic1">snip</span>--</span><br/><br/>   <span class="gray">def game_loop():</span><br/><br/><span epub:type="pagebreak" id="page_123"/>   <span class="gray">--<span class="codeitalic1">snip</span>--</span><br/>               <span class="gray">player_direction = "down"</span><br/>               <span class="gray">player_frame = 1   </span><br/>   <span class="red"># check for exiting the room</span><br/><span class="ent">➊</span>     <span class="orange">if</span> player_x == room_width: <span class="red"># through door on RIGHT</span><br/>           <span class="red">#clock.unschedule(hazard_move)</span><br/><span class="ent">➋</span>         current_room += 1<br/><span class="ent">➌</span>         generate_map()<br/><span class="ent">➍</span>         player_x = 0 <span class="red"># enter at left</span><br/><span class="ent">➎</span>         player_y = <span class="purple">int</span>(room_height / 2) <span class="red"># enter at door</span><br/><span class="ent">➏</span>         player_frame = 0<br/><span class="ent">➐</span>         <span class="red">#start_room()</span><br/><span class="ent">➑</span>         <span class="orange">return</span><br/><br/><span class="ent">➒</span>     <span class="orange">if</span> player_x == -1: <span class="red"># through door on LEFT</span><br/>           <span class="red">#clock.unschedule(hazard_move)</span><br/>           current_room -= 1<br/>           generate_map()<br/>           player_x = room_width - 1  <span class="red"># enter at right</span><br/>           player_y = <span class="purple">int</span>(room_height / 2) <span class="red"># enter at door</span><br/>           player_frame = 0<br/>           <span class="red">#start_room()</span><br/>           <span class="orange">return</span><br/><br/><span class="ent">➓</span>     <span class="orange">if</span> player_y == room_height: <span class="red"># through door at BOTTOM</span><br/>           <span class="red">#clock.unschedule(hazard_move)</span><br/>           current_room += MAP_WIDTH<br/>           generate_map()<br/>           player_y = 0 <span class="red"># enter at top</span><br/>           player_x = <span class="purple">int</span>(room_width / 2) <span class="red"># enter at door</span><br/>           player_frame = 0<br/>           <span class="red">#start_room()</span><br/>           <span class="orange">return</span><br/><br/>       <span class="orange">if</span> player_y == -1: <span class="red"># through door at TOP</span><br/>           <span class="red">#clock.unschedule(hazard_move)</span><br/>           current_room -= MAP_WIDTH<br/>           generate_map()<br/>           player_y = room_height - 1 <span class="red"># enter at bottom</span><br/>           player_x = <span class="purple">int</span>(room_width / 2) <span class="red"># enter at door</span><br/>           player_frame = 0<br/>           <span class="red">#start_room()</span><br/>           <span class="orange">return</span><br/><br/>     <span class="gray"># If the player is standing somewhere they shouldn't, move them back.</span><br/>       <span class="gray">if room_map[player_y][player_x] not in items_player_may_stand_on: #\</span> <br/>       <span class="gray">#           or hazard_map[player_y][player_x] != 0:</span><br/>           <span class="gray">player_x = old_player_x</span><br/>   <span class="gray">--<span class="codeitalic1">snip</span>--</span></p>
<p class="listing" id="ch07list6"><em>Listing 7-6: Enabling the player to move between rooms</em></p>
<p class="indent"><span epub:type="pagebreak" id="page_124"/>To see how this code works, let’s use an example room map. <a href="ch07.xhtml#ch07fig3">Figure 7-3</a> shows a room 9 tiles wide and 9 tiles high with exits on each wall. We’ll use this image to understand the player’s position when they’ve left the room.</p>
<p class="indent">As you know, the positions on the map are numbered starting at 0 in the top left. The yellow squares show where the player might be if they walked out of the room:</p>
<ul>
<li class="noindent">If the player’s <em>y</em> position is −1, they’ve walked out of the top exit.</li>
<li class="noindent">If the player’s <em>x</em> position is −1, they’ve walked out of the left exit.</li>
<li class="noindent">If the player’s <em>y</em> position is the same as the <span class="literal">room_height</span> variable, they’ve walked out of the bottom. The tile positions are numbered starting at 0, so if the player goes into row 9 in a room that has 9 rows, they’ve already left the room.</li>
<li class="noindent">Similarly, if the player’s <em>x</em> position is the same as the <span class="literal">room_width</span> variable, they’ve walked out of the right exit.</li>
</ul>
<div class="image"><a id="ch07fig3"/><img src="../images/fig7-3.jpg" alt="image"/></div>
<p class="figcap"><em>Figure 7-3: Working out whether the player has walked through an exit</em></p>
<p class="indent">The new code lines check whether the player position means they’ve walked out of the room. If the player’s <em>x</em> position is the same as <span class="literal">room_width</span> <span class="ent">➊</span>, they’re outside the door on the right, as shown in <a href="ch07.xhtml#ch07fig3">Figure 7-3</a>.</p>
<p class="indent">When a player leaves the room, we need to change the number of the room they’re in, which is stored in the <span class="literal">current_room</span> variable. When they go <span epub:type="pagebreak" id="page_125"/>through a door on the right, the room number increases by 1 <span class="ent">➋</span>. Look at the room map again (flip back to <a href="ch04.xhtml#ch04fig1">Figure 4-1</a> on <a href="ch04.xhtml#page_60">page 60</a>) to see that this makes sense: room numbers increase from left to right. For example, if the player is in room 33 and walks through the exit on the right, they end up in room 34.</p>
<p class="indent">The program then generates a new <span class="literal">room_map</span> list <span class="ent">➌</span> to use in displaying and navigating the new room. The player is repositioned at the opposite side of the room <span class="ent">➍</span>, so it looks like they’ve walked through the doorway. If the player exits to the right of the room, they enter the next room from the left <span class="ent">➍</span>.</p>
<p class="indent">Rooms are lots of different sizes, so we also need to change the player’s <em>y</em> position to put them in the middle of the doorway. Otherwise, the player might emerge from a wall! We set the player’s position to be half the height of the room <span class="ent">➎</span>, which means they’re right in the middle of the doorway. When they enter the room, we reset the player animation, too <span class="ent">➏</span>.</p>
<p class="indent">I’ve included a couple of features here that we’ll need later, so make sure you include the <span class="literal">clock.unschedule(hazard_move)</span> <span class="ent">➊</span> and <span class="literal">start_room()</span> <span class="ent">➐</span> instructions. The <span class="literal">start_room()</span> function will display the room name when the player enters a new room. We’ll talk about those instructions more later in the book.</p>
<p class="indent">Finally, the <span class="literal">return</span> instruction exits the <span class="literal">game_loop()</span> function <span class="ent">➑</span>. Any further instructions in the function won’t run this time around. When the function starts again, it will start from the top as usual.</p>
<p class="indent">The next code block <span class="ent">➒</span> checks whether the player went through the left door. To go through the left door, the program does the following:</p>
<ul>
<li class="noindent">Checks whether the <span class="literal">player_x</span> variable contains <span class="literal">-1</span> (see <a href="ch07.xhtml#ch07fig3">Figure 7-3</a>).</li>
<li class="noindent">Subtracts 1 from the current room number to go into the room on the left.</li>
<li class="noindent">Sets the player’s <em>x</em> position to be just inside the doorway on the right. This position is the <span class="literal">room_width</span> minus 1. (You can check this in <a href="ch07.xhtml#ch07fig3">Figure 7-3</a>. In a room that has a <span class="literal">room_width</span> of 9, the player’s <em>x</em> position should be 8.)</li>
<li class="noindent">Sets the player’s <em>y</em> position to the middle using the <span class="literal">room_height</span>. This is the same approach as walking through the right exit.</li>
</ul>
<p class="indent">The same code structure is used for the top and bottom exits <span class="ent">➓</span>. However, the program checks the player’s <em>y</em> position to see if they used an exit and sets their new position to enter through a top or bottom doorway.</p>
<p class="indent">This time, we change the room number by 5 instead of 1 because that’s how many rooms wide the game map is (see <a href="ch04.xhtml#ch04fig1">Figure 4-1</a>). For example, if you’re in room 37 and you go through the top exit, you end up in room 32 (which is 37 minus 5). If you’re in room 37 and go through the bottom exit, you end up in room 42 (37 plus 5). We stored the number 5 in the variable <span class="literal">MAP_WIDTH</span> earlier, and the program uses it here.</p>
<p class="indent">Now you’re able to freely explore the space station. In the next chapter, we’ll fix the remaining few bugs in the room display.</p>
<h3 class="h3" id="lev98"><span epub:type="pagebreak" id="page_126"/><strong>ARE YOU FIT TO FLY?</strong></h3>
<p class="noindentb">Check the following boxes to confirm that you’ve learned the key lessons in this chapter.</p>
<p class="square"><img src="../images/box.jpg" alt="Images"/>  The player’s position in the <em>Escape</em> game is measured in tiles, just like the scenery.</p>
<p class="square"><img src="../images/box.jpg" alt="Images"/>  The <span class="literal">game_loop()</span> function controls player movement and is scheduled to run every 0.03 seconds.</p>
<p class="square"><img src="../images/box.jpg" alt="Images"/>  If the player moves somewhere they aren’t allowed to be, they’re put back in their previous position so fast you won’t see them move.</p>
<p class="square"><img src="../images/box.jpg" alt="Images"/>  The program checks the player’s <em>x</em> and <em>y</em> positions to see whether they’ve walked out of an exit. If they have, they’ll appear in the middle of the opposite exit in the next room.</p>
<p class="square"><img src="../images/box.jpg" alt="Images"/>  The animation frames are stored in the <span class="literal">PLAYER</span> dictionary and have a list of images for each direction. The dictionary key is the direction name, and an index number gets the particular frame needed.</p>
<p class="square"><img src="../images/box.jpg" alt="Images"/>  Frame 0 is the standing-still position. Frames 1, 2, 3, and 4 show the astronaut walking.</p>
<p class="square"><img src="../images/box.jpg" alt="Images"/>  The <span class="literal">game_loop()</span> function increases the animation frame number used when the player is walking.</p>
<p class="square"><img src="../images/box.jpg" alt="Images"/>  The <span class="literal">player_offset_x</span> and <span class="literal">player_offset_y</span> variables are used to position the astronaut correctly when walking into a new tile.</p>
<div class="image" id="ch07sb2"><img src="../images/f0126-01.jpg" alt="image"/></div>
</body></html>