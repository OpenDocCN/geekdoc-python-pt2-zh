## **6**

用**隐形墨水写字**

![image](../images/common01.jpg)

2012年秋季，犯罪剧*Elementary*在CBS电视网络首播。该剧是对福尔摩斯神话的重新演绎，设定在21世纪的纽约，由乔尼·李·米勒饰演福尔摩斯，刘玉玲饰演他的伙伴乔安·沃森博士。在2016年的一集中（“你抓住我，谁抓住你？”），福尔摩斯与父亲莫兰德·福尔摩斯关系疏远，他雇佣了沃森帮助他找出组织中的间谍。沃森通过在一封邮件中发现维吉尼亚密码，很快解决了案件。但一些剧迷不满：维吉尼亚密码并不微妙，像莫兰德·福尔摩斯这样聪明的人怎么会没发现呢？

在这个项目中，你将使用隐写术来解决这个困境，但不像[第5章](ch05.xhtml#ch05)中的空密码那样。为了隐藏这条消息，你将使用一个名为python-docx的第三方模块，通过直接操作Microsoft Word文档来隐藏文本。

### **项目 #12：隐藏维吉尼亚密码**

在*Elementary*的这一集中，中国投资者聘请了莫兰德·福尔摩斯的咨询公司，与哥伦比亚政府谈判石油许可证和钻探权。一年过去了，最后一刻，一名竞争对手突然出手，成功达成交易，留下中国投资者空手而回。莫兰德怀疑公司内部有人背叛，并要求沃森独自调查。沃森通过在他的邮件中发现维吉尼亚密码，快速识别出了间谍。

**剧透警告**

*密码的解密内容从未被提及，间谍在随后的剧集中被谋杀。*

*维吉尼亚密码*，也被称为无法破解的密码，可能是有史以来最著名的密码。它由法国学者布莱兹·德·维吉尼亚（Blaise de Vigenère）于16世纪发明，是一种多表替代密码，在最常用的版本中，使用一个单一的关键词。这个关键词，比如*BAGGINS*，会反复印刷在明文上，如[图6-1](ch06.xhtml#ch06fig1)中所示的消息。

![image](../images/f0106-01.jpg)

*图6-1：带有维吉尼亚密码关键词*BAGGINS*的明文消息*

然后使用字母表的表格或*表格*来加密消息。[图6-2](ch06.xhtml#ch06fig2)是维吉尼亚密码表前五行的示例。注意每一行的字母表都向左移动一个字母。

![image](../images/f0106-02.jpg)

*图6-2：维吉尼亚密码表的一部分*

明文上方的关键词字母决定了用于加密的行。例如，要加密*speak*中的*s*，请注意其上方的关键词字母是*B*。向下找到B行，然后横向查找明文中*s*所在的列。使用交点处的*T*作为密文字母。

[图6-3](ch06.xhtml#ch06fig3)展示了使用维吉尼亚密码加密的完整消息示例。如果这种文本出现在文档中，肯定会引起注意并成为审查的对象！

![image](../images/f0107-01.jpg)

*图6-3：使用维吉尼亚密码加密的消息*

维吉尼亚密码在19世纪中叶之前一直没有被破解，当时计算机前身的发明者查尔斯·巴贝奇意识到，使用一个短关键词配合长消息会导致重复模式，这些模式可以揭示关键词的长度，最终揭示密码本身。破解这个密码对专业密码学是一次巨大的打击，在原版《福尔摩斯与华生》的维多利亚时代，密码学领域没有显著的进展。

这个密码的存在正是导致《Elementary》剧集出现“悬置怀疑”问题的原因。为什么需要外部顾问来找到如此明显可疑的电子邮件？让我们看看能否使用Python想出一个合理的解释。

**目标**

假设你是剧集中的公司内鬼，使用Python将一个总结招标细节的秘密信息隐藏在一份正式外观的文档中。从一个未加密的消息开始，最终得到一个加密版本。

### **平台**

你的程序应该与广泛使用的文字处理软件兼容，因为输出结果需要在不同的公司之间共享。这意味着需要使用Windows版的Microsoft Office套件，或者与macOS或Linux兼容的版本。将输出限制为标准Word文档使得硬件问题成为微软的责任！

因此，本项目是用Windows版Word 2016开发的，结果已经在Mac版Word v16.16.2上进行了检查。如果你没有Word的许可，可以使用免费的Microsoft Office Online应用，网址为*[https://products.office.com/en-us/office-online](https://products.office.com/en-us/office-online)*。

如果你当前使用的是Word的替代品，如LibreOffice Writer或OpenOffice Writer，你可以打开并查看本项目中使用和生成的Word（*.docx*）文件；然而，隐藏的信息很可能会被泄露，正如在“[检测隐藏信息](ch06.xhtml#lev143)”中所讨论的那样，详见[第119页](ch06.xhtml#page_119)。

### **策略**

你是一个拥有初学者水平Python知识的会计师，你的老板是一个非常聪明且多疑的人。你所从事的项目高度机密，具有诸如电子邮件过滤器等控制措施，以保持机密性。如果你设法悄悄发送了一条信息，随之而来的肯定会是一场彻底的调查。所以，你需要在一封电子邮件中隐藏一条明显可疑的信息，无论是直接发送还是作为附件，并且要避免初期的检测和后期的内部审计。

这里有一些限制条件：

+   你不能直接将消息发送给竞争公司，只能发送给中介。

+   你需要将消息混淆，以避开会搜索关键词的电子邮件过滤器。

+   你需要将加密消息隐藏起来，以免引起怀疑。

中介设置起来会很容易，免费的加密网站也很容易在互联网上找到——但最后一项更为棘手。

隐写术是答案，但正如你在上一章所看到的那样，在一个空白密码中隐藏即便是短消息也绝非易事。替代技术涉及垂直移动文本行或水平微调单词，改变字母的长度，或使用文件的元数据——但你只是一个对Python了解有限、时间更加紧张的会计。如果只有像过去那样简单的方法，比如隐形墨水就好了。

#### ***创建隐形墨水***

在这个电子墨水的时代，隐形墨水可能就足够疯狂而有效！隐形字体很容易阻止对在线文档的视觉审阅，而且在纸质打印件中根本不存在。由于内容已被加密，寻找诸如*投标*或石油产区的西班牙语名称等关键词的数字过滤器将一无所获。最重要的是，隐形墨水使用起来非常简单——只需将前景文本设置为背景色即可。

格式化文本并改变其颜色需要像Microsoft Word这样的文字处理软件。在Word中制作隐形电子墨水，你只需选择一个字符、一个单词或一行，并将字体颜色设置为白色。接收者需要选择整个文档并使用高亮工具（见[图6-4](ch06.xhtml#ch06fig4)）将选中的文本涂黑，从而隐藏标准的黑色字母并将隐藏的白色字母呈现出来。

![image](../images/f0108-01.jpg)

*图6-4：Word 2016中的文本高亮工具*

仅仅选择Word中的文档并不能显示白色文本（[图6-5](ch06.xhtml#ch06fig5)），因此，只有非常怀疑的人才能发现这些隐藏的消息。

![image](../images/f0109-01.jpg)

*图6-5：上：显示虚假消息的Word文档部分；中：按CTRL-A选择的文档；下：使用高亮工具并将高亮颜色设置为黑色后显示的真实消息*

当然，你可以仅通过文字处理软件完成所有这些操作，但有两种情况下采用Python方法更为合适：1）当你需要加密一条长消息，并且不想手动插入并隐藏所有行；2）当你需要发送超过几条消息时。正如你将看到的，简短的Python程序会极大简化这个过程！

##### **考虑字体类型、字距调整和字间距**

隐藏文本的位置是一个关键设计决策。一个选项是使用虚假消息中可见单词之间的空格，但这可能会引发与间距相关的问题，使得最终产品看起来可疑。

*比例字体*使用可变字符宽度来提高可读性。例如字体包括Arial和Times New Roman。*等宽字体*使用固定的字符宽度来支持文本对齐和单个字符的识别，尤其是像（或{这样的细字符。因此，等宽字体在编程界面中非常流行。例如字体包括Consolas和Courier New。

*字距调整*是通过调整单个字符字形之间的间距和重叠，以改善其视觉效果的排版过程。一个名为*字间距调整*的过程用于调整整个行或块文本的字符间距，目的相同。这些调整有助于可读性和可识别性，确保字母不会因为过于紧密而无法区分，或者因为过于分开而无法识别单词。请注意，我们是阅读单词，而不是字母。如果你对此有疑问，可以读一读这个：peopl raed wrds nt lttrs。显然，*上下文*有帮助。

字母对之间的字距调整首先进行，然后是字间距调整，在此过程中字母对的相对字距保持不变。如前所述，当你尝试在使用比例字体的单词之间隐藏字符时，这些可变宽度和自动修正可能会导致问题：

| 对伟大的思想来说，微不足道的事物也是重要的。 | *比例字体，没有隐藏字母* |
| --- | --- |
| 对伟大的思想来说，微不足道的事物也是重要的。 | *比例字体，单词之间隐藏了字母* |
| 对伟大的思想来说，微不足道的事物也是重要的。 | *隐藏的字母已显示（$3.2K）* |
|  |  |
| 对伟大的思想来说，微不足道的事物也是重要的。 | *等宽字体，没有隐藏字母* |
| 对伟大的思想来说，微不足道的事物也是重要的。 | *等宽字体，单词之间隐藏了字母* |
| 对伟大的思想来说，微不足道的事物也是重要的。 | *隐藏的字母已显示（$3.2K）* |

如果使用等宽字体，一致的间距提供了一个方便的隐藏位置。但由于专业通信更可能使用比例字体，因此隐形墨水技术应关注行间距，这些空间更容易控制。

在段落之间使用空行是最简单的编程和阅读方法，而且不需要长时间的虚假信息，因为你可以简明扼要地总结出竞标的要点。这很重要，因为你不希望在可见的虚假信息后附加空白页。因此，你隐藏信息的占位符应比虚假信息的占位符更小。

##### **避免问题**

当你在开发软件时，一个需要反复问的问题是“用户可能如何弄坏它？”在这里可能出错的一件事是加密过程会改变你隐藏信息中的字母，导致字距和行距调整，可能会将某个单词推到换行符之外，从而引起自动换行。这将导致伪造信息中段落之间出现不均匀和可疑的空格。避免这种情况的方法之一是，在输入每一行真实信息时提前按下 ENTER 键，这样行末会留出一些空间以适应加密导致的变化。当然，你仍然需要验证结果。假设代码有效的风险，就像假设詹姆斯·邦德已经死了一样！

#### ***使用 python-docx 操作 Word 文档***

一个名为 python-docx 的免费第三方模块可以让 Python 操作 Microsoft Word（.*docx*）文件。要下载和安装本书中提到的第三方模块，你需要使用首选安装程序（pip），这是一种包管理系统，使安装基于 Python 的软件变得简单。对于 Windows 和 macOS 上的 Python 3，版本 3.4 及以上自带 pip；对于 Python 2，pip 从版本 2.7.9 开始预装。Linux 用户可能需要单独安装 pip。如果你发现需要安装或升级 pip，可以查看 *[https://pip.pypa.io/en/stable/installing/](https://pip.pypa.io/en/stable/installing/)* 上的安装说明，或者在网上搜索适用于你操作系统的 pip 安装方法。

使用 pip 工具，你可以通过在命令行、PowerShell 或终端窗口中运行 pip install python-docx 来安装 python-docx，具体取决于你的操作系统。关于 python-docx 的在线说明可以在 *[https://python-docx.readthedocs.io/en/latest/](https://python-docx.readthedocs.io/en/latest/)* 上找到。

对于这个项目，你需要理解段落对象和行对象。python-docx 模块使用三个对象在以下层级结构中组织数据类型：

+   文档：包含一系列段落对象的完整文档。

+   段落：在 Word 中通过按下 ENTER 键分隔的一块文本；包含一个或多个行对象。

+   行：具有相同 *样式* 的一串文本。

段落被视为 *块级* 对象，python-docx 将其定义如下：“块级项目将在其左边缘和右边缘之间流动文本，每当文本超出右边界时，都会增加一行。对于段落对象，边界通常是页面边距，但如果页面以列布局，也可以是列边界，或者如果段落位于表格单元格中，则可以是单元格边界。表格也是块级对象。”

一个段落对象有多种属性，指定其在容器中的位置——通常是页面——以及它如何将内容分成不同的行。你可以通过段落的 ParagraphFormat 属性访问段落的格式属性，也可以通过*段落样式分组*来设置所有段落属性，或者直接将它们应用到段落中。

运行是一个*内联级别*的对象，它出现在段落或其他块级对象内。一个运行对象有一个只读字体属性，可以访问一个字体对象。一个字体对象提供了设置该运行字符格式的属性。你需要这个功能来将隐藏消息的文本颜色设置为白色。

*样式*指的是 Word 中段落和字符（运行对象）的一组属性，或两者的组合。样式包括常见的属性，如字体、颜色、缩进、行间距等。你可能已经注意到，这些属性在 Word 的“主页”功能区的“样式”窗格中进行了分组（见[图 6-6](ch06.xhtml#ch06fig6)）。任何样式的变化——甚至是一个字母的变化——都需要创建一个新的运行对象。目前，只有在打开的 *.docx* 文件中的样式可用。这个情况可能会在 future python-docx 版本中有所改变。

![image](../images/f0111-01.jpg)

*图 6-6：Microsoft Word 2016 中的样式窗格*

你可以在 *[http://python-docx.readthedocs.io/en/latest/user/styles-using.html](http://python-docx.readthedocs.io/en/latest/user/styles-using.html)* 找到关于如何使用样式的完整文档。

这是 python-docx 看到的段落和运行的示例：

*我是一段只有一个运行的单一段落，因为我的所有文本都是相同的样式。*

*我是一段包含两个运行的单一段落。**我是第二个运行，因为我的样式变成了粗体。***

*我是一段包含三个运行的单一段落。**我是第二个运行，因为我的样式变成了粗体。第三个运行是我的最后**一个字。*

如果其中任何部分看起来不清楚，不用担心。你不需要详细了解 python-docx。像任何一段代码一样，你主要需要知道*你想做什么*。网上搜索应该能提供很多有用的建议和完整的代码示例。

**注意**

*为了让这个过程顺利进行，不要在真实（隐藏）信息中改变样式，并确保每一行都以回车键（ENTER）手动结束。不幸的是，Word 没有自动换行时的软回车特殊字符。所以，你不能进入一个已有的带有自动换行的 Word 文档，使用查找和替换将它们都改为硬回车。这就是鼹鼠的生活。*

#### ***下载资源***

你需要的外部文件可以从 *[https://www.nostarch.com/impracticalpython/](https://www.nostarch.com/impracticalpython/)* 下载，并应保存在与代码相同的文件夹中：

***template.docx*** 一个空白的 Word 文档，采用 Holmes Corporation 官方样式、字体和页边距格式

***fakeMessage.docx*** 假消息，没有信头和日期，Word 文档格式

***realMessage.docx*** 真实消息的纯文本，没有信头和日期，Word 文档格式

***realMessage_Vig.docx*** 使用维吉尼亚密码加密的真实消息

***example_template_prep.docx*** 用于创建模板文档的假消息示例（程序运行时不需要此文件）

**注意**

*如果你使用的是 Word 2016，一个简单的方法是先写入假消息（包括信头），然后保存文件。接着删除所有文本，再次保存文件并使用不同的文件名。当你使用* python-docx *将此空白文件分配给一个变量时，所有现有的样式会被保留。当然，你也可以使用已经包含信头的模板文件，但为了更好地学习*python-docx*，我们将在这里使用 Python 来构建信头。*

花点时间查看这四个文档在 Word 中的样子。这些文件是 *elementary_ink.py* 程序的输入。假消息和真实消息——列出的第二和第三项——也在[图 6-7](ch06.xhtml#ch06fig7) 和 [图 6-8](ch06.xhtml#ch06fig8)中显示。

![image](../images/f0113-01.jpg)

*图 6-7：假消息中的“假”文本* fakeMessage.docx *文件*

![image](../images/f0113-02.jpg)

*图 6-8：真实消息的* realMessage.docx *文件*

请注意，真实消息中包含一些数字和特殊字符。这些字符不会被我们将使用的维吉尼亚表格加密，我特意保留它们来强调这一点。理想情况下，应该将它们拼写出来（例如，将“3”写成“三”或将“%”写成“百分比”），以便在后续添加维吉尼亚密码时最大限度地保密。

### **伪代码**

以下伪代码描述了如何加载两个消息和模板文档，交错并将真实消息隐藏在空白行中，使用白色字体，然后保存混合消息。

构建资源：

在 Word 中创建一个带有所需格式/样式的空文档（模板）

在 Word 中创建一个无害的假消息，该消息将可见并具有足够的空白行来容纳真实消息

在 Word 中创建将被隐藏的真实消息

导入 docx 以允许使用 Python 操作 Word 文档

使用 docx 模块将假消息和真实消息加载为列表

使用 docx 将空白文档分配给一个变量

使用 docx 向空白文档添加信头横幅

为真实消息中的行创建计数器变量

定义函数以使用 docx 格式化段落间距

对于假消息中的每一行：

如果某行为空且真实消息中仍有行：

使用 docx 和计数器从真实消息中填充空白行

使用 docx 设置真实消息的字体颜色为白色

向真实消息的计数器推进

否则：

使用 docx 写入假消息的行

运行段落间距功能

使用 docx 保存最终的 Word 文档

### **代码**

[列表 6-1](ch06.xhtml#ch06list1) 中的 *elementary_ink.py* 程序加载真实消息、虚假消息和空白模板文档。它通过使用白色字体将真实消息隐藏在虚假消息的空白行中，然后将合成的消息保存为一封看起来无害且专业的信件，可以附加到电子邮件中。你可以从 *[https://www.nostarch.com/impracticalpython/](https://www.nostarch.com/impracticalpython/)* 下载代码。

#### ***导入 python-docx，创建列表并添加信头***

[列表 6-1](ch06.xhtml#ch06list1) 导入 python-docx，将虚假和真实消息中的文本行转换为列表项，加载设置样式的模板文档，并添加信头。

*elementary_ink.py,* 第 1 部分

import docx

➊ 从 docx.shared 导入 RGBColor、Pt

➋ # 获取虚假消息的文本并将每一行转换为列表项

fake_text = docx.Document('fakeMessage.docx')

fake_list = []

for paragraph in fake_text.paragraphs:

fake_list.append(paragraph.text)

➌ # 获取真实消息的文本并将每一行转换为列表项

real_text = docx.Document('realMessage.docx')

real_list = []

for paragraph in real_text.paragraphs:

➍ if len(paragraph.text) != 0:  # 删除空行

real_list.append(paragraph.text)

➎ # 加载设置样式、字体、边距等的模板

doc = docx.Document('template.docx')

➏ # 添加信头

doc.add_heading('莫兰德·霍尔姆斯', 0)

subtitle = doc.add_heading('全球咨询与谈判', 1)

subtitle.alignment = 1

doc.add_heading('', 1)

➐ doc.add_paragraph('2015年12月17日')

doc.add_paragraph('')

*列表 6-1：导入* python-docx*，加载重要的* .docx *文件，并添加信头*

在导入 docx 模块后—而不是“python-docx”—使用 docx.shared 来访问 docx 模块中的颜色（RGBColor）和长度（Pt）对象 ➊。这些将允许你更改字体颜色并设置行间距。接下来的两个代码块将虚假 ➋ 和真实 ➌ 消息 Word 文档加载为列表。在每个 Word 文档中按下回车键的位置决定了这些列表中的项目。为了隐藏真实消息，删除任何空行，以便你的消息尽可能简短 ➍。现在，你可以使用列表索引将这两条消息合并，并追踪它们的来源。

接下来，加载包含预设样式、字体和边距的模板文档 ➎。docx 模块将写入此变量，最终将其保存为最终文档。

加载并准备好输入后，格式化最终文档的信头，使其与Holmes公司 ➏ 的信头相匹配。add_heading()函数添加一个带有文本和整数参数的标题样式段落。整数0指定最高级别的标题或标题样式，继承自模板文档。副标题使用1进行格式化，这是下一个可用的标题样式，并且居中对齐，再次使用整数1（0 = 左对齐，2 = 右对齐）。请注意，当添加日期时，不需要提供整数 ➐。如果不提供参数，默认会继承现有的样式层级，在模板中是左对齐的。此块中的其他语句只是添加空白行。

#### ***格式化并交替插入消息***

[清单 6-2](ch06.xhtml#ch06list2)执行了真正的工作，格式化行间距并交替插入消息。

*elementary_ink.py,* 第二部分

➊ def set_spacing(paragraph):

"""使用 docx 设置段落之间的行间距。"""

paragraph_format = paragraph.paragraph_format

paragraph_format.space_before = Pt(0)

paragraph_format.space_after = Pt(0)

➋ length_real = len(real_list)

count_real = 0  # 当前行在实际（隐藏）消息中的索引

# 交替插入真实和虚假消息行

for line in fake_list:

➌ if count_real < length_real and line == "":

➍ paragraph = doc.add_paragraph(real_list[count_real])

➎ paragraph_index = len(doc.paragraphs) - 1

# 将真实消息的颜色设置为白色

run = doc.paragraphs[paragraph_index].runs[0]

font = run.font

➏ font.color.rgb = RGBColor(255, 255, 255) # 将其设为红色进行测试

➐ count_real += 1

else:

➑ paragraph = doc.add_paragraph(line)

➒ set_spacing(paragraph)

➓ doc.save('ciphertext_message_letterhead.docx')

print("完成")

*清单 6-2：格式化段落并交替插入虚假和真实消息的行*

定义一个函数，使用python-docx的paragraph_format属性格式化段落之间的间距 ➊。隐藏行之前和之后的行间距设置为0点，以确保输出中段落之间没有可疑的大间隙，如[图6-9](ch06.xhtml#ch06fig9)左侧所示。

![image](../images/f0116-01.jpg)

*图 6-9：没有* python-docx *段落格式化的虚假消息行间距（左）与有格式化的虚假消息行间距（右）*

接下来，定义工作空间，通过获取存储实际消息的列表的长度 ➋。请记住，隐藏的真实消息需要比可见的虚假消息短，以便有足够的空白行来容纳它。接着初始化计数器，程序将使用它来跟踪当前正在处理的真实消息行（列表项）。

由于由假消息生成的列表最长，并且设定了真实消息的空间维度，因此通过两个条件遍历假消息：1）是否已经到达真实消息的末尾；2）假消息列表中的一行是否为空 ➌。如果仍然有真实消息行且假消息行为空，则使用count_real作为真实列表的索引，并使用python-docx将其添加到文档中 ➍。

通过计算doc.paragraphs的长度并减去1来获取你刚刚添加的行的索引 ➎。然后使用该索引将真实消息行设置为运行对象（它将在列表中是第一个运行项[0]，因为真实消息使用单一样式），并将其字体颜色设置为白色 ➏。由于程序现在已经在此块中添加了来自真实列表的一行，因此count_real计数器增加了1 ➐。

随后的else语句块处理从for循环中选取的假消息列表中非空行的情况。在这种情况下，假消息行会直接添加到段落➑中。通过调用行间距函数set_spacing() ➒来完成for循环。

一旦超过了真实消息的长度，for循环将继续添加假消息的剩余部分——在这种情况下，是库尔茨先生的签名信息——并在最后一行➓将文档保存为Word *.docx*文件。当然，在现实中，你可能会使用一个不那么可疑的文件名，而不是*密文_消息_信头.docx*！

请注意，由于你使用的是基于假消息的for循环，for循环结束后无法再附加任何更多的隐藏行——也就是说，在你遍历完假消息列表中的所有项后。如果你需要更多的空间，必须在假消息的底部输入硬回车，但要小心不要加得太多，以免强制分页并创建一个神秘的空白页！

运行程序，打开保存的Word文档，使用CTRL-A选择所有文本，然后将高亮颜色设置为深灰色（参见[图6-4](ch06.xhtml#ch06fig4)），以查看两个消息。秘密消息应被揭示出来（[图6-10](ch06.xhtml#ch06fig10)）。

![image](../images/f0117-01.jpg)

*图6-10：Word文档用深灰色高亮显示，展示假消息和未加密的真实消息*

#### ***添加维吉尼亚密码***

目前的代码使用了真实消息的明文版本，因此任何改变文档高亮颜色的人都能读取并理解其中的敏感信息。既然你知道库尔茨先生使用了维吉尼亚密码加密这个消息，那就回去修改代码，将明文替换为加密文本。为此，找到以下行：

real_text = docx.Document('realMessage.docx')

这行代码加载真实消息的明文，因此请将文件名更改为此处用粗体显示的文件名：

real_text = docx.Document('realMessage_Vig.docx')

重新运行程序，再次通过选择整个文档并将高亮颜色设置为深灰色来揭示隐藏的文本（见[图 6-11](ch06.xhtml#ch06fig11)）。

![image](../images/f0118-01.jpg)

*图 6-11：用深灰色突出显示的 Word 文档，显示虚假消息和加密的真实消息*

秘密消息应该对无法解读密码的人可见，但无法阅读。比较[图 6-11](ch06.xhtml#ch06fig11)中的加密消息和[图 6-10](ch06.xhtml#ch06fig10)中的未加密版本。请注意，数字和 % 符号在两个版本中都有出现。它们被保留下来，以展示与加密选择相关的潜在问题。你应该增强维吉尼亚密码，以包括这些字符——或者直接将它们拼写出来。这样，即使你的消息被发现，你也尽可能少地留下关于主题的线索。

如果你想用维吉尼亚密码编码自己的消息，可以在网上搜索“在线维吉尼亚编码器”。你会找到多个网站，比如 *[http://www.cs.du.edu/~snarayan/crypt/vigenere.html](http://www.cs.du.edu/~snarayan/crypt/vigenere.html)*，它们允许你输入或粘贴明文。如果你想自己写一个用维吉尼亚密码加密的 Python 程序，可以参考 Al Sweigart 的《*用 Python 破解密码*》（No Starch Press，2018）。

如果你用自己真实的消息进行尝试，无论是否加密，都请确保使用与虚假消息相同的字体。字体既是字型，比如 Helvetica Italic，也是大小，比如 12。记住在“[考虑字体类型、字距和字形](ch06.xhtml#lev134)”一节中，[第109页](ch06.xhtml#page_109)提到过，如果你尝试混合字体，特别是比例字体和等宽字体，隐藏的消息行可能会换行，从而导致真实消息段落之间的间距不均。

### **检测隐藏消息**

Joan Watson 或其他侦探能否迅速找到你的隐藏消息？事实上，可能不行。实际上，在我写下这些文字时，我正在观看一集《*Elementary*》，其中 Joan 正忙着通过阅读一箱电子邮件打印件来调查一家公司！维吉尼亚密码的使用可能仅仅是一个懒散的写作手法，尽管这是一部整体构思巧妙的剧集。但我们仍然可以推测出可能暴露你消息的原因。

由于最终的投标可能直到接近投标日期才发送，因此搜索可以仅限于投标最终确定后发送的通信，从而消除许多噪音。当然，侦探不可能确切知道他们在寻找什么——甚至是否*有*内鬼——这就留下了一个很大的搜索空间。而且总有可能信息是通过电话交谈或秘密会议传递的。

假设邮件的数量在可管理范围内，并且正在进行隐藏信息的假设，调查人员可能会通过多种方式检测到你的隐形墨水。例如，Word 拼写检查器不会标记白色的无意义加密词，前提是这些词尚未被显示出来。如果你检查并重设了某些隐藏词的字体颜色，即使这些词的颜色已经恢复为白色，它们也会被永久性地泄露。拼写检查器将用一个令人怀疑的红色波浪线标出它们（见[图 6-12](ch06.xhtml#ch06fig12)）。

![image](../images/f0119-01.jpg)

*图 6-12：Word 拼写和语法工具下划线显示的先前暴露的隐形加密词*

如果调查人员使用非 Word 软件打开文档，该产品的拼写检查器很可能会显示隐藏的单词（见[图 6-13](ch06.xhtml#ch06fig13)）。不过，由于 Microsoft Word 在市场上的主导地位，这一风险在某种程度上得到缓解。

![image](../images/f0120-01.jpg)

*图 6-13：LibreOffice Writer 中的拼写检查器将突出显示隐形单词。*

其次，使用 CTRL-A 全选 Word 中的所有文本并不会显示隐藏的文本，但它会表明某些空白行比其他空白行更长（见[图 6-14](ch06.xhtml#ch06fig14)），这会让细心的观察者意识到可能有什么不对劲。

![image](../images/f0120-02.jpg)

*图 6-14：选择整个 Word 文档可以显示空白行长度的差异。*

第三，使用某些电子邮件软件的预览功能打开 Word 文档时，当内容通过滑动或使用 CTRL-A 选择时，可能会显示隐藏的文本（见[图 6-15](ch06.xhtml#ch06fig15)）。

![image](../images/f0121-01.jpg)

*图 6-15：在 Yahoo! Mail 预览面板中选择整个文档可以显示隐藏的文本。*

但是，在 Yahoo! Mail 预览面板中选择隐藏文本会显示文本，而在[图 6-16](ch06.xhtml#ch06fig16)中的 Microsoft Outlook 预览面板中则不会显示。

![image](../images/f0121-02.jpg)

*图 6-16：在 Microsoft Outlook 预览面板中选择整个文档无法显示隐藏的文本。*

最后，将 Word 文档保存为纯文本（**.txt**）文件会去除所有格式并将隐藏的文本暴露出来（见[图 6-17](ch06.xhtml#ch06fig17)）。

![image](../images/f0122-01.jpg)

*图 6-17：将 Word 文档保存为纯文本（**.txt**）文件可以显示隐藏的文本。*

要通过隐写术隐藏一条秘密信息，你不仅需要隐藏信息的*内容*，还要隐藏信息*存在*这一事实。我们的电子隐形墨水并不总是能保证这一点，但从间谍的角度来看，刚才列出的弱点要么是他们犯了错误，这在理论上是可以控制的，要么是调查人员采取了专门且不太可能的行动，比如擦除文本、将文件保存为不同格式，或使用不太常见的文字处理软件。假设《Elementary》中间谍考虑到这些是可以接受的风险，电子隐形墨水为公司内部调查失败提供了一个合理的解释。

### **总结**

在本章中，你使用隐写术将加密信息隐藏在 Microsoft Word 文档中。你使用了一个名为 python-docx 的第三方模块，通过 Python 直接访问和操作该文档。类似的第三方模块也可以用于处理其他流行的文档类型，如 Excel 表格。

### **进一步阅读**

你可以在 *[https://python-docx.readthedocs.io/en/latest/](https://python-docx.readthedocs.io/en/latest/)* 和 *[https://pypi.python.org/pypi/python-docx](https://pypi.python.org/pypi/python-docx)* 上找到 python-docx 的在线文档。

*用 Python 自动化处理琐事*（No Starch Press，2015）由 Al Sweigart 编写，涵盖了允许 Python 操作 PDF、Word 文件、Excel 表格等模块。[第13章](ch13.xhtml#ch13)包含了关于 python-docx 的有用教程，附录中介绍了如何使用 pip 安装第三方模块。

你可以在 Al Sweigart 的 *用 Python 破解密码*（No Starch Press，2018）一书中找到适用于密码学初学者的 Python 程序。

*神秘信息*（The Penguin Group，2009）由 Gary Blackwood 编写，是一本关于隐写术和密码学的有趣且图文并茂的历史书。

### **实践项目：检查空行数量**

通过编写一个函数，比较伪消息中的空行数与真实消息中的行数，来改进隐藏消息的程序。如果没有足够的空间来隐藏真实消息，函数应提醒用户并告诉他们需要向伪消息中添加多少个空行。在 *elementary_ink.py* 代码的副本中插入并调用该函数，放在加载模板文档之前。你可以在附录中和在线网站 *[https://www.nostarch.com/impracticalpython/](https://www.nostarch.com/impracticalpython/)* 上的 *elementary_ink_practice.py* 中找到解决方案。测试时，从同一网站下载 *realMessageChallenge.docx* 并将其用作真实消息。

### **挑战项目：使用等宽字体**

重写*elementary_ink.py*代码以使用等宽字体，并将你的短消息隐藏在单词之间的空白处。有关等宽字体的描述，请参阅[《考虑字体类型、字距和行距》](ch06.xhtml#lev134)在[第109页](ch06.xhtml#page_109)中的内容。像往常一样，对于挑战项目，不提供解决方案。
